var A=(t,e,r)=>Object.defineProperty(t,e,{value:r,enumerable:!1,writable:!0,configurable:!0}),ve=(t,e)=>e&t.entityMask,we=t=>{let e={versioning:!1,versionBits:8},r=e.versionBits??8,n=e.versioning??!1,i=32-r,o=(1<<i)-1,a=i,s=(1<<r)-1<<a;return{aliveCount:0,dense:[],sparse:[],maxId:0,versioning:n,versionBits:r,entityMask:o,versionShift:a,versionMask:s}},Me=t=>{if(t.aliveCount<t.dense.length){let r=t.dense[t.aliveCount],n=r;return t.sparse[n]=t.aliveCount,t.aliveCount++,r}let e=++t.maxId;return t.dense.push(e),t.sparse[e]=t.aliveCount,t.aliveCount++,e},ee=(t,e)=>{let r=ve(t,e),n=t.sparse[r];return n!==void 0&&n<t.aliveCount&&t.dense[n]===e},h=Symbol.for("bitecs_internal"),Se=(t,e)=>A(t||{},h,{entityIndex:e||we(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new Map,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set,entitiesWithRelations:new Set,hierarchyData:new Map,hierarchyActiveRelations:new Set,hierarchyQueryCache:new Map});function Ne(...t){let e,r;return t.forEach(n=>{typeof n=="object"&&"dense"in n&&"sparse"in n&&"aliveCount"in n?e=n:typeof n=="object"&&(r=n)}),Se(r,e)}var R=()=>{let t=[],e=[],r=n=>t[e[n]]===n;return{add:n=>{r(n)||(e[n]=t.push(n)-1)},remove:n=>{if(!r(n))return;let i=e[n],o=t.pop();o!==n&&(t[i]=o,e[o]=i)},has:r,sparse:e,dense:t,reset:()=>{t.length=0,e.length=0},sort:n=>{t.sort(n);for(let i=0;i<t.length;i++)e[t[i]]=i}}},V=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:ArrayBuffer,te=(t=1e3)=>{let e=[],r=0,n=new Uint32Array(new V(t*4)),i=o=>o<e.length&&e[o]<r&&n[e[o]]===o;return{add:o=>{if(!i(o)){if(r>=n.length){let a=new Uint32Array(new V(n.length*2*4));a.set(n),n=a}n[r]=o,e[o]=r,r++}},remove:o=>{if(!i(o))return;r--;let a=e[o],s=n[r];n[a]=s,e[s]=a},has:i,sparse:e,get dense(){return new Uint32Array(n.buffer,0,r)},reset:()=>{r=0,e.length=0},sort:o=>{let a=Array.from(n.subarray(0,r));a.sort(o);for(let s=0;s<a.length;s++)n[s]=a[s];for(let s=0;s<r;s++)e[n[s]]=s}}},T=()=>{let t=new Set;return{subscribe:e=>(t.add(e),()=>{t.delete(e)}),notify:(e,...r)=>Array.from(t).reduce((n,i)=>{let o=i(e,...r);return o&&typeof o=="object"?{...n,...o}:n},{})}},Q=Symbol.for("bitecs-relation"),C=Symbol.for("bitecs-pairTarget"),J=Symbol.for("bitecs-isPairComponent"),_=Symbol.for("bitecs-relationData"),re=()=>{let t={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},e=r=>{if(r===void 0)throw Error("Relation target is undefined");let n=r==="*"?g:r;if(!t.pairsMap.has(n)){let i={};A(i,Q,e),A(i,C,n),A(i,J,!0),t.pairsMap.set(n,i)}return t.pairsMap.get(n)};return A(e,_,t),e},v=(t,e)=>{if(t===void 0)throw Error("Relation is undefined");return t(e)},E=(t,e,r)=>{let n=ye(t,e),i=[];for(let o of n)o[Q]===r&&o[C]!==g&&!Oe(o[C])&&i.push(o[C]);return i},Ce=Symbol.for("bitecs-wildcard");function Re(){let t=re();return Object.defineProperty(t,Ce,{value:!0,enumerable:!1,writable:!1,configurable:!1}),t}function Ee(){let t=Symbol.for("bitecs-global-wildcard");return globalThis[t]||(globalThis[t]=Re()),globalThis[t]}var g=Ee();function xe(){return re()}function Ae(){let t=Symbol.for("bitecs-global-isa");return globalThis[t]||(globalThis[t]=xe()),globalThis[t]}var j=Ae();function Oe(t){return t?Object.getOwnPropertySymbols(t).includes(_):!1}var ke=64,m=4294967295,ne=1024;function ie(t,e){let{depths:r}=t;if(e<r.length)return r;let n=Math.max(e+1,r.length*2,r.length+ne),i=new Uint32Array(n);return i.fill(m),i.set(r),t.depths=i,i}function oe(t,e,r,n){let{depthToEntities:i}=t;if(n!==void 0&&n!==m){let o=i.get(n);o&&(o.remove(e),o.dense.length===0&&i.delete(n))}r!==m&&(i.has(r)||i.set(r,te()),i.get(r).add(e))}function Ie(t,e){e>t.maxDepth&&(t.maxDepth=e)}function F(t,e,r,n){t.depths[e]=r,oe(t,e,r,n),Ie(t,r)}function ae(t,e){t[h].hierarchyQueryCache.delete(e)}function se(t,e){let r=t[h];return r.hierarchyActiveRelations.has(e)||(r.hierarchyActiveRelations.add(e),G(t,e),De(t,e)),r.hierarchyData.get(e)}function De(t,e){let r=L(t,[v(e,g)]);for(let i of r)W(t,e,i);let n=new Set;for(let i of r)for(let o of E(t,i,e))n.has(o)||(n.add(o),W(t,e,o))}function G(t,e){let r=t[h];if(!r.hierarchyData.has(e)){let n=Math.max(ne,r.entityIndex.dense.length*2),i=new Uint32Array(n);i.fill(m),r.hierarchyData.set(e,{depths:i,dirty:R(),depthToEntities:new Map,maxDepth:0})}}function le(t,e,r,n=new Set){if(n.has(r))return 0;n.add(r);let i=E(t,r,e);if(i.length===0)return 0;if(i.length===1)return U(t,e,i[0],n)+1;let o=1/0;for(let a of i){let s=U(t,e,a,n);if(s<o&&(o=s,o===0))break}return o===1/0?0:o+1}function U(t,e,r,n){let i=t[h];G(t,e);let o=i.hierarchyData.get(e),{depths:a}=o;if(a=ie(o,r),a[r]===m){let s=le(t,e,r,n);return F(o,r,s),s}return a[r]}function W(t,e,r){return U(t,e,r,new Set)}function fe(t,e,r,n,i=R()){if(i.has(r))return;i.add(r);let o=L(t,[e(r)]);for(let a of o)n.add(a),fe(t,e,a,n,i)}function Te(t,e,r,n,i=new Set){let o=t[h];if(!o.hierarchyActiveRelations.has(e))return;G(t,e);let a=o.hierarchyData.get(e);if(i.has(r)){a.dirty.add(r);return}i.add(r);let{depths:s,dirty:f}=a,l=n!==void 0?W(t,e,n)+1:0;if(l>ke)return;let d=s[r];F(a,r,l,d===m?void 0:d),d!==l&&(fe(t,e,r,f,R()),ae(t,e))}function je(t,e,r){let n=t[h];if(!n.hierarchyActiveRelations.has(e))return;let i=n.hierarchyData.get(e),{depths:o}=i;o=ie(i,r),ue(t,e,r,o,R()),ae(t,e)}function ue(t,e,r,n,i){if(i.has(r))return;i.add(r);let o=t[h].hierarchyData.get(e);if(r<n.length){let s=n[r];s!==m&&(o.depths[r]=m,oe(o,r,m,s))}let a=L(t,[e(r)]);for(let s of a)ue(t,e,s,n,i)}function de(t,e){let r=t[h].hierarchyData.get(e);if(!r)return;let{dirty:n,depths:i}=r;if(n.dense.length!==0){for(let o of n.dense)if(i[o]===m){let a=le(t,e,o);F(r,o,a)}n.reset()}}function qe(t,e,r,n={}){let i=t[h];se(t,e);let o=q(t,[e,...r]),a=i.hierarchyQueryCache.get(e);if(a&&a.hash===o)return a.result;de(t,e),he(t,r,n);let s=i.queriesHashMap.get(q(t,r)),f=i.hierarchyData.get(e),{depths:l}=f;s.sort((c,y)=>{let b=l[c],w=l[y];return b!==w?b-w:c-y});let d=(n.buffered,s.dense);return i.hierarchyQueryCache.set(e,{hash:o,result:d}),d}function Qe(t,e,r,n={}){let i=se(t,e);de(t,e);let o=i.depthToEntities.get(r);return o?(n.buffered,o.dense):n.buffered?new Uint32Array(0):[]}var k=Symbol.for("bitecs-opType"),H=Symbol.for("bitecs-opTerms"),X=Symbol.for("bitecs-hierarchyType"),Be=Symbol.for("bitecs-hierarchyRel"),$e=Symbol.for("bitecs-hierarchyDepth"),D=Symbol.for("bitecs-modifierType"),q=(t,e)=>{let r=t[h],n=o=>(r.componentMap.has(o)||I(t,o),r.componentMap.get(o).id),i=o=>k in o?`${o[k].toLowerCase()}(${o[H].map(i).sort().join(",")})`:n(o).toString();return e.map(i).sort().join("-")},Z=(t,e,r={})=>{let n=t[h],i=q(t,e),o=[],a=u=>{k in u?u[H].forEach(a):(n.componentMap.has(u)||I(t,u),o.push(u))};e.forEach(a);let s=[],f=[],l=[],d=(u,p)=>{p.forEach(S=>{n.componentMap.has(S)||I(t,S),u.push(S)})};e.forEach(u=>{if(k in u){let{[k]:p,[H]:S}=u;if(p==="Not")d(f,S);else if(p==="Or")d(l,S);else if(p==="And")d(s,S);else throw new Error(`Nested combinator ${p} not supported yet - use simple queries for best performance`)}else n.componentMap.has(u)||I(t,u),s.push(u)});let c=o.map(u=>n.componentMap.get(u)),y=[...new Set(c.map(u=>u.generationId))],b=(u,p)=>(u[p.generationId]=(u[p.generationId]||0)|p.bitflag,u),w=s.map(u=>n.componentMap.get(u)).reduce(b,{}),be=f.map(u=>n.componentMap.get(u)).reduce(b,{}),ge=l.map(u=>n.componentMap.get(u)).reduce(b,{}),me=c.reduce(b,{}),M=Object.assign(r.buffered?te():R(),{allComponents:o,orComponents:l,notComponents:f,masks:w,notMasks:be,orMasks:ge,hasMasks:me,generations:y,toRemove:R(),addObservable:T(),removeObservable:T(),queues:{}});n.queries.add(M),n.queriesHashMap.set(i,M),c.forEach(u=>{u.queries.add(M)}),f.length&&n.notQueries.add(M);let K=n.entityIndex;for(let u=0;u<K.aliveCount;u++){let p=K.dense[u];x(t,p,Y)||B(t,M,p)&&$(M,p)}return M};function he(t,e,r={}){let n=t[h],i=q(t,e),o=n.queriesHashMap.get(i);return o?r.buffered&&!("buffer"in o.dense)&&(o=Z(t,e,{buffered:!0})):o=Z(t,e,r),r.buffered,o.dense}function L(t,e,...r){let n=e.find(f=>f&&typeof f=="object"&&X in f),i=e.filter(f=>!(f&&typeof f=="object"&&X in f)),o=!1,a=!0,s=r.some(f=>f&&typeof f=="object"&&D in f);for(let f of r)if(s&&f&&typeof f=="object"&&D in f){let l=f;l[D]==="buffer"&&(o=!0),l[D]==="nested"&&(a=!1)}else if(!s){let l=f;l.buffered!==void 0&&(o=l.buffered),l.commit!==void 0&&(a=l.commit)}if(n){let{[Be]:f,[$e]:l}=n;return l!==void 0?Qe(t,f,l,{buffered:o}):qe(t,f,i,{buffered:o})}return a&&We(t),he(t,i,{buffered:o})}function B(t,e,r){let n=t[h],{masks:i,notMasks:o,orMasks:a,generations:s}=e,f=Object.keys(a).length===0;for(let l=0;l<s.length;l++){let d=s[l],c=i[d],y=o[d],b=a[d],w=n.entityMasks[d][r];if(y&&w&y||c&&(w&c)!==c)return!1;b&&w&b&&(f=!0)}return f}var $=(t,e)=>{if(t.toRemove.has(e)){t.toRemove.remove(e),t.addObservable.notify(e);return}t.has(e)||(t.add(e),t.addObservable.notify(e))},Ue=t=>{for(let e=0;e<t.toRemove.dense.length;e++){let r=t.toRemove.dense[e];t.remove(r)}t.toRemove.reset()},We=t=>{let e=t[h];e.dirtyQueries.size&&(e.dirtyQueries.forEach(Ue),e.dirtyQueries.clear())},ce=(t,e,r)=>{let n=t[h];!e.has(r)||e.toRemove.has(r)||(e.toRemove.add(r),n.dirtyQueries.add(e),e.removeObservable.notify(r))},I=(t,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");let r=t[h],n=new Set,i={id:r.componentCount++,generationId:r.entityMasks.length-1,bitflag:r.bitflag,ref:e,queries:n,setObservable:T(),getObservable:T()};return r.componentMap.set(e,i),r.bitflag*=2,r.bitflag>=2**31&&(r.bitflag=1,r.entityMasks.push([])),i},x=(t,e,r)=>{let n=t[h],i=n.componentMap.get(r);if(!i)return!1;let{generationId:o,bitflag:a}=i;return(n.entityMasks[o][e]&a)===a},He=(t,e,r)=>{let n=t[h].componentMap.get(r);if(n&&x(t,e,r))return n.getObservable.notify(e)},pe=(t,e,r,n,i=new Set)=>{if(!i.has(n)){i.add(n),N(e,r,j(n));for(let o of ye(e,n))if(o!==Y&&!x(e,r,o)){N(e,r,o);let a=t.componentMap.get(o);if(a!=null&&a.setObservable){let s=He(e,n,o);a.setObservable.notify(r,s)}}for(let o of E(e,n,j))pe(t,e,r,o,i)}},N=(t,e,r)=>{if(!z(t,e))throw new Error(`Cannot add component - entity ${e} does not exist in the world.`);let n=t[h],i="component"in r?r.component:r,o="data"in r?r.data:void 0;n.componentMap.has(i)||I(t,i);let a=n.componentMap.get(i);if(x(t,e,i))return o!==void 0&&a.setObservable.notify(e,o),!1;let{generationId:s,bitflag:f,queries:l}=a;if(n.entityMasks[s][e]|=f,x(t,e,Y)||l.forEach(d=>{B(t,d,e)?$(d,e):ce(t,d,e)}),n.entityComponents.get(e).add(i),o!==void 0&&a.setObservable.notify(e,o),i[J]){let d=i[Q],c=i[C];if(P(t,e,v(d,g),v(g,c)),typeof c=="number"&&(P(t,c,v(g,e),v(g,d)),n.entitiesWithRelations.add(c),n.entitiesWithRelations.add(e)),n.entitiesWithRelations.add(c),d[_].exclusiveRelation===!0&&c!==g){let y=E(t,e,d)[0];y!=null&&y!==c&&O(t,e,d(y))}if(d===j){let y=E(t,e,j);for(let b of y)pe(n,t,e,b)}Te(t,d,e,typeof c=="number"?c:void 0)}return!0};function P(t,e,...r){(Array.isArray(r[0])?r[0]:r).forEach(n=>{N(t,e,n)})}var O=(t,e,...r)=>{let n=t[h];if(!z(t,e))throw new Error(`Cannot remove component - entity ${e} does not exist in the world.`);r.forEach(i=>{if(!x(t,e,i))return;let o=n.componentMap.get(i),{generationId:a,bitflag:s,queries:f}=o;if(n.entityMasks[a][e]&=~s,f.forEach(l=>{l.toRemove.remove(e),B(t,l,e)?$(l,e):ce(t,l,e)}),n.entityComponents.get(e).delete(i),i[J]){let l=i[C],d=i[Q];je(t,d,e),O(t,e,v(g,l)),typeof l=="number"&&z(t,l)&&(O(t,l,v(g,e)),O(t,l,v(g,d))),E(t,e,d).length===0&&O(t,e,v(d,g))}})},Y={};function Pe(t,...e){let r=t[h],n=Me(r.entityIndex);return r.notQueries.forEach(i=>{B(t,i,n)&&$(i,n)}),r.entityComponents.set(n,new Set),e.length>0&&P(t,n,e),n}var ye=(t,e)=>{let r=t[h];if(e===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!ee(r.entityIndex,e))throw new Error(`getEntityComponents: entity ${e} does not exist in the world.`);return Array.from(r.entityComponents.get(e))},z=(t,e)=>ee(t[h].entityIndex,e);export{Ne as J,Pe as N};
//# sourceMappingURL=vendor-D1adT2yx.js.map
