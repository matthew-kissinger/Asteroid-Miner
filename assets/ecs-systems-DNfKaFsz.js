import{B as ht,M as dt,a as gt}from"./three-DBvJLP14.js";import{N as mt,J as wt}from"./vendor-D1adT2yx.js";const r={x:new Float32Array(1e4),y:new Float32Array(1e4),z:new Float32Array(1e4)},c={x:new Float32Array(1e4),y:new Float32Array(1e4),z:new Float32Array(1e4)},z={x:new Float32Array(1e4),y:new Float32Array(1e4),z:new Float32Array(1e4),w:new Float32Array(1e4)},O={x:new Float32Array(1e4),y:new Float32Array(1e4),z:new Float32Array(1e4)},k={meshIndex:new Uint32Array(1e4)},_={visible:new Uint8Array(1e4),castShadow:new Uint8Array(1e4),receiveShadow:new Uint8Array(1e4)},G={mass:new Float32Array(1e4),drag:new Float32Array(1e4)},P={radius:new Float32Array(1e4)},h={current:new Float32Array(1e4),max:new Float32Array(1e4),shield:new Float32Array(1e4),maxShield:new Float32Array(1e4),shieldRegenRate:new Float32Array(1e4),shieldRegenDelay:new Float32Array(1e4),timeSinceLastDamage:new Float32Array(1e4),damageResistance:new Float32Array(1e4)},xt={damage:new Float32Array(1e4)},D={forward:new Uint8Array(1e4),backward:new Uint8Array(1e4),left:new Uint8Array(1e4),right:new Uint8Array(1e4),up:new Uint8Array(1e4),down:new Uint8Array(1e4),boost:new Uint8Array(1e4)},J={thrustForce:new Float32Array(1e4),maxVelocity:new Float32Array(1e4)},M={subtype:new Uint8Array(1e4),detectionRange:new Float32Array(1e4),damage:new Float32Array(1e4),speed:new Float32Array(1e4),playerFound:new Uint8Array(1e4),spiralAmplitude:new Float32Array(1e4),spiralFrequency:new Float32Array(1e4),spiralPhase:new Float32Array(1e4),timeAlive:new Float32Array(1e4),separationInfluence:new Float32Array(1e4)},F={x:new Float32Array(1e4),y:new Float32Array(1e4),z:new Float32Array(1e4)},C={age:new Float32Array(1e4),maxAge:new Float32Array(1e4)},U=.5,pt=4,At=25,St=.01;function W(e,n){for(const t of e){if(!Mt(t)||!Ft(t))continue;let s=0,o=0,i=0;const a=D.boost[t]?pt:1;if(D.forward[t]&&(i-=U*a),D.backward[t]&&(i+=U*a),D.left[t]&&(s-=U),D.right[t]&&(s+=U),D.up[t]&&(o+=U),D.down[t]&&(o-=U),s===0&&o===0&&i===0)continue;const l=zt(s,o,i,z.x[t],z.y[t],z.z[t],z.w[t]);c.x[t]+=l.x*n,c.y[t]+=l.y*n,c.z[t]+=l.z*n;const y=J.maxVelocity[t]||At,f=Math.sqrt(c.x[t]**2+c.y[t]**2+c.z[t]**2);if(f>y){const u=y/f;c.x[t]*=u,c.y[t]*=u,c.z[t]*=u}}}function $(e,n){for(const t of e){if(!H(t))continue;let s=St;vt(t)&&(s=G.drag[t]);const o=1-s*n;c.x[t]*=o,c.y[t]*=o,c.z[t]*=o,Math.abs(c.x[t])<.001&&(c.x[t]=0),Math.abs(c.y[t])<.001&&(c.y[t]=0),Math.abs(c.z[t])<.001&&(c.z[t]=0)}}function K(e,n){for(const t of e)!X(t)||!H(t)||(r.x[t]+=c.x[t]*n,r.y[t]+=c.y[t]*n,r.z[t]+=c.z[t]*n)}function Q(e){for(let n=0;n<e.length;n++){const t=e[n];if(!(!q(t)||!X(t)))for(let s=n+1;s<e.length;s++){const o=e[s];if(!q(o)||!X(o))continue;const i=r.x[t]-r.x[o],a=r.y[t]-r.y[o],l=r.z[t]-r.z[o],y=i*i+a*a+l*l,f=P.radius[t]+P.radius[o],u=f*f;if(y<u&&y>0){const d=Math.sqrt(y),w=f-d,m=i/d,x=a/d,g=l/d,p=w*.5;if(r.x[t]+=m*p,r.y[t]+=x*p,r.z[t]+=g*p,r.x[o]-=m*p,r.y[o]-=x*p,r.z[o]-=g*p,H(t)&&H(o)){const A=c.x[t]-c.x[o],S=c.y[t]-c.y[o],R=c.z[t]-c.z[o],v=A*m+S*x+R*g;if(v<0){const T=-1.5*v;c.x[t]+=T*m*.5,c.y[t]+=T*x*.5,c.z[t]+=T*g*.5,c.x[o]-=T*m*.5,c.y[o]-=T*x*.5,c.z[o]-=T*g*.5}}}}}}function zt(e,n,t,s,o,i,a){const l=a*e+o*t-i*n,y=a*n+i*e-s*t,f=a*t+s*n-o*e,u=-s*e-o*n-i*t;return{x:l*a+u*-s+y*-i-f*-o,y:y*a+u*-o+f*-s-l*-i,z:f*a+u*-i+l*-o-y*-s}}function X(e){return e<r.x.length}function H(e){return e<c.x.length}function Mt(e){return e<D.forward.length}function Ft(e){return e<J.thrustForce.length}function vt(e){return e<G.mass.length}function q(e){return e<P.radius.length}function tt(e,n){for(const t of e){if(!Tt(t))continue;const s=k.meshIndex[t],o=n.get(s);o&&(bt(t)&&o.position.set(r.x[t],r.y[t],r.z[t]),Rt(t)&&o.quaternion.set(z.x[t],z.y[t],z.z[t],z.w[t]),It(t)&&o.scale.set(O.x[t],O.y[t],O.z[t]),Dt(t)&&(o.visible=_.visible[t]!==0,"castShadow"in o&&(o.castShadow=_.castShadow[t]!==0),"receiveShadow"in o&&(o.receiveShadow=_.receiveShadow[t]!==0)))}}function et(e,n){let t=0;for(;e.has(t);)t++;return e.set(t,n),t}function nt(){return new Map}function bt(e){return e<r.x.length}function Rt(e){return e<z.x.length}function It(e){return e<O.x.length}function Tt(e){return e<k.meshIndex.length}function Dt(e){return e<_.visible.length}function Z(e,n){const t=[];for(let s=0;s<e.length;s++){const o=e[s],i=r.x[o],a=r.y[o],l=r.z[o],y=P.radius[o];for(let f=0;f<n.length;f++){const u=n[f];if(u===o)continue;const d=i-r.x[u],w=a-r.y[u],m=l-r.z[u],x=d*d+w*w+m*m,g=y+P.radius[u],p=g*g;if(x<=p){let A=r.x[u],S=r.y[u],R=r.z[u];if(x>0){const v=Math.sqrt(x),T=d/v,ut=w/v,yt=m/v,E=P.radius[u];A+=T*E,S+=ut*E,R+=yt*E}t.push({projectileEid:o,targetEid:u,hitPosition:{x:A,y:S,z:R}})}}}return t}function N(e){for(let n=0;n<e.length;n++){const{projectileEid:t,targetEid:s}=e[n],o=xt.damage[t];if(o<=0)continue;const i=Lt(h.damageResistance[s]),a=o*(1-i);if(a<=0)continue;const l=h.shield[s];if(l>0){if(a<=l){h.shield[s]=l-a,h.timeSinceLastDamage[s]=0;continue}const y=a-l;h.shield[s]=0,h.current[s]=Math.max(0,h.current[s]-y),h.timeSinceLastDamage[s]=0;continue}h.current[s]=Math.max(0,h.current[s]-a),h.timeSinceLastDamage[s]=0}}function ot(e,n){for(let t=0;t<e.length;t++){const s=e[t];if(h.timeSinceLastDamage[s]+=n,h.timeSinceLastDamage[s]>h.shieldRegenDelay[s]&&h.shield[s]<h.maxShield[s]){const o=h.shieldRegenRate[s]*n;h.shield[s]=Math.min(h.maxShield[s],h.shield[s]+o)}}}function st(e,n){const t=[];for(let s=0;s<e.length;s++){const o=e[s];C.age[o]+=n;const i=C.maxAge[o];i>0&&C.age[o]>i&&t.push(o)}return t}function Lt(e){return e<=0?0:e>=1?1:e}const V=150,Ot=2.5,_t=75;function it(e,n){if(n===-1)return;const t=r.x[n],s=r.y[n],o=r.z[n];for(const i of e){if(M.playerFound[i])continue;const a=r.x[i]-t,l=r.y[i]-s,y=r.z[i]-o,f=a*a+l*l+y*y,u=M.detectionRange[i]**2;f<u&&(M.playerFound[i]=1)}}function at(e,n,t){if(n===-1)return;const s=r.x[n],o=r.y[n],i=r.z[n];for(const a of e){if(!M.playerFound[a])continue;M.timeAlive[a]+=t;const l=s-r.x[a],y=o-r.y[a],f=i-r.z[a],u=Math.sqrt(l*l+y*y+f*f);if(u===0)continue;const d=l/u,w=y/u,m=f/u,x=M.subtype[a],g=M.speed[a];x===0?Pt(a,d,w,m,u,g):x===1?Ut(a,d,w,m,g):x===2&&Ct(a,d,w,m,u,g),jt(a,g),Ht(a,d,w,m)}}function Pt(e,n,t,s,o,i,a){const l=M.spiralAmplitude[e],y=M.spiralFrequency[e],f=M.spiralPhase[e],u=M.timeAlive[e];let d=l;o<500&&(d=l*(o/500));const w=u*y+f,m=Math.sin(w)*d,x=0,g=1,p=0;let A=t*p-s*g,S=s*x-n*p,R=n*g-t*x;const v=Math.sqrt(A*A+S*S+R*R);v>.1?(A/=v,S/=v,R/=v):(A=1,S=0,R=0),c.x[e]=n*i,c.y[e]=t*i,c.z[e]=s*i,c.x[e]+=A*m,c.y[e]+=S*m,c.z[e]+=R*m}function Ut(e,n,t,s,o,i){const a=o*.7;c.x[e]=n*a,c.y[e]=t*a,c.z[e]=s*a}function Ct(e,n,t,s,o,i,a){const l=i*1.5,y=M.timeAlive[e],d=Math.sin(y*3)*80,w=0,m=1,x=0;let g=t*x-s*m,p=s*w-n*x,A=n*m-t*w;const S=Math.sqrt(g*g+p*p+A*A);S>.1?(g/=S,p/=S,A/=S):(g=1,p=0,A=0),c.x[e]=n*l+g*d,c.y[e]=t*l+p*d,c.z[e]=s*l+A*d}function jt(e,n,t){const s=F.x[e],o=F.y[e],i=F.z[e],a=s*s+o*o+i*i;if(a>.01){const l=Math.sqrt(a),f=M.separationInfluence[e]*(.5+.5*Math.min(1,l/100)),u=s/l*n,d=o/l*n,w=i/l*n;c.x[e]+=(u-c.x[e])*f,c.y[e]+=(d-c.y[e])*f,c.z[e]+=(w-c.z[e])*f}}function Ht(e,n,t,s){const o=Math.atan2(n,s),i=Math.atan2(t,Math.sqrt(n*n+s*s)),a=Math.cos(o*.5),l=Math.sin(o*.5),y=Math.cos(i*.5),f=Math.sin(i*.5);z.x[e]=f*a,z.y[e]=l*y,z.z[e]=-f*l,z.w[e]=y*a}function rt(e){for(const n of e)F.x[n]=0,F.y[n]=0,F.z[n]=0;for(let n=0;n<e.length;n++){const t=e[n],o=P.radius[t]*Ot;for(let i=n+1;i<e.length;i++){const a=e[i],l=r.x[t]-r.x[a],y=r.y[t]-r.y[a],f=r.z[t]-r.z[a],u=l*l+y*y+f*f,d=Math.sqrt(u);if(d<o&&d>0){const w=(o-d)/o,m=l/d,x=y/d,g=f/d,p=m*w*V,A=x*w*V,S=g*w*V;F.x[t]+=p,F.y[t]+=A,F.z[t]+=S,F.x[a]-=p,F.y[a]-=A,F.z[a]-=S}}}}function ct(e,n){if(typeof window>"u"||!window.game||!window.game.difficultyManager)return;const t=window.game.difficultyManager;if((window.game.isHordeActive||!1)&&window.game.hordeSurvivalTime!==void 0){const i=window.game.hordeSurvivalTime/1e3/60,a=1+i*.5,l=1+i*.3,y=1+i*.2;for(const f of e)M.damage[f]=Math.floor(15*l),M.speed[f]=700*y,h.max[f]>0&&(h.max[f]=Math.floor(20*a),h.current[f]>h.max[f]&&(h.current[f]=h.max[f]))}else t.params}function lt(e,n){if(n===-1)return;const t=r.x[n],s=r.y[n],o=r.z[n];for(const i of e){const a=r.x[i]-t,l=r.y[i]-s,y=r.z[i]-o;if(Math.sqrt(a*a+l*l+y*y)<_t){const u=M.damage[i];if(h.current[n]>0){if(typeof window<"u"&&window.mainMessageBus&&window.mainMessageBus.publish("input.vibrate",{intensity:.6,duration:150}),h.shield[n]>0)if(h.shield[n]>=u)h.shield[n]-=u;else{const d=u-h.shield[n];h.shield[n]=0,h.current[n]-=d}else h.current[n]-=u;h.current[n]<0&&(h.current[n]=0)}C.maxAge[i]>0&&(C.age[i]=C.maxAge[i])}}}const qt=Object.freeze(Object.defineProperty({__proto__:null,applyDragSystem:$,applyThrustSystem:W,collisionSystem:Q,createMeshRegistry:nt,damageApplicationSystem:N,difficultyScalingSystem:ct,enemyCollisionAttackSystem:lt,enemyDetectionSystem:it,enemyPursuitSystem:at,enemySeparationSystem:rt,getEnemies:Xt,getPlayerEntity:Zt,initECS:Et,integratePositionSystem:K,lifetimeSystem:st,projectileCollisionSystem:Z,registerMesh:et,removeTrackedEntity:ft,renderSyncSystem:tt,shieldRegenSystem:ot,updateECS:Vt},Symbol.toStringTag,{value:"Module"})),Yt=wt();function Bt(){return mt(Yt)}const I=[],b=[],j=[],Y=[];let L=-1,B=null;function Et(e){B=nt();const n=Bt();if(I.push(n),r.x[n]=0,r.y[n]=5,r.z[n]=0,c.x[n]=.5,c.y[n]=0,c.z[n]=0,z.x[n]=0,z.y[n]=0,z.z[n]=0,z.w[n]=1,O.x[n]=1,O.y[n]=1,O.z[n]=1,e){const t=new ht(1,1,1),s=new dt({color:65280}),o=new gt(t,s);e.add(o);const i=et(B,o);k.meshIndex[n]=i,_.visible[n]=1,_.castShadow[n]=0,_.receiveShadow[n]=0}console.log("[bitECS] Initialized - test entity created")}function Vt(e){if(!B){console.error("[bitECS] updateECS called before initECS");return}if(I.length===0)return;if(W(I,e),$(I,e),K(I,e),b.length>0&&(it(b,L),at(b,L,e),rt(b),ct(b),lt(b,L)),j.length>0){if(b.length>0){const t=Z(j,b);t.length>0&&N(t)}if(L!==-1){const t=Z(j,[L]);t.length>0&&(N(t),globalThis.mainMessageBus&&globalThis.mainMessageBus.publish("input.vibrate",{intensity:.6,duration:150}))}}Y.length>0&&ot(Y,e);const n=st(I,e);for(const t of n)ft(t);Q(I),tt(I,B)}function ft(e){const n=I.indexOf(e);n!==-1&&I.splice(n,1);const t=b.indexOf(e);t!==-1&&b.splice(t,1);const s=j.indexOf(e);s!==-1&&j.splice(s,1);const o=Y.indexOf(e);o!==-1&&Y.splice(o,1),e===L&&(L=-1)}function Xt(){return b}function Zt(){return L}export{r as P,Zt as a,Xt as g,qt as i};
//# sourceMappingURL=ecs-systems-DNfKaFsz.js.map
