var A=Object.defineProperty;var x=(g,e,t)=>e in g?A(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var s=(g,e,t)=>x(g,typeof e!="symbol"?e+"":e,t);import{M as G,b as O,_ as F}from"./game-core-OtPnLuF2.js";import{V as E,s as D,Q as _,r as z,M as S,o as w,a as M,G as j,m as T,N as R,n as I,Z as L,z as W,B as k,y as v,J as H,_ as U,K as V,O as $,i as N,h as B,$ as q,t as K}from"./three-DBvJLP14.js";class Q{constructor(e,t){s(this,"id");s(this,"world");s(this,"components");s(this,"tags");s(this,"_isEnemy");s(this,"_isPlayer");s(this,"_isProjectile");s(this,"_isPooled");s(this,"collisionRadius");this.id=e,this.world=t,this.components=new Map,this.tags=new Set,this._isEnemy=void 0,this._isPlayer=void 0,this._isProjectile=void 0,this._isPooled=void 0}addComponent(e){e.entity=this;const t=e.type||e.constructor.name;return this.components.set(t,e),e.onAttached&&e.onAttached(),this.world&&this.world.messageBus&&this.world.messageBus.publish("component.added",{entity:this,componentType:t,component:e}),this}removeComponent(e){const t=this.getComponent(e);if(t){t.onDetached&&t.onDetached(),t.entity=null;let i;typeof e=="string"?i=e:e.type?i=e.type:i=e.name,this.components.delete(i),this.world&&this.world.messageBus&&this.world.messageBus.publish("component.removed",{entity:this,componentType:i,component:t})}return this}getComponent(e){if(typeof e=="string")return this.components.get(e)||null;const t=e.type||e.name;return this.components.get(t)||null}hasComponent(e){if(typeof e=="string")return this.components.has(e);const t=e.type||e.name;return this.components.has(t)}_syncTagCache(){this._isEnemy=this.tags.has("enemy"),this._isPlayer=this.tags.has("player"),this._isProjectile=this.tags.has("projectile"),this._isPooled=this.tags.has("pooled")}addTag(e){return this.tags.has(e)||(this.tags.add(e),e==="enemy"?this._isEnemy=!0:e==="player"?this._isPlayer=!0:e==="projectile"?this._isProjectile=!0:e==="pooled"&&(this._isPooled=!0),this.world&&this.world.entityManager&&(this.world.entityManager.onTagAdded(this,e),(!this.world.entityManager.entitiesByTag.has(e)||!this.world.entityManager.entitiesByTag.get(e).includes(this))&&(this.world.entityManager.entitiesByTag.has(e)||this.world.entityManager.entitiesByTag.set(e,[]),this.world.entityManager.entitiesByTag.get(e).push(this)))),this}removeTag(e){return this.tags.has(e)&&(this.tags.delete(e),e==="enemy"?this._isEnemy=!1:e==="player"?this._isPlayer=!1:e==="projectile"?this._isProjectile=!1:e==="pooled"&&(this._isPooled=!1),this.world&&this.world.entityManager&&this.world.entityManager.onTagRemoved(this,e)),this}clearTags(){const e=[...this.tags];for(const t of e)this.removeTag(t);return this._isEnemy=!1,this._isPlayer=!1,this._isProjectile=!1,this._isPooled=!1,this.tags.clear(),this}hasTag(e){const t=this.tags.has(e);let i=!1;return e==="enemy"&&this._isEnemy!==t?(this._isEnemy=t,i=!0):e==="player"&&this._isPlayer!==t?(this._isPlayer=t,i=!0):e==="projectile"&&this._isProjectile!==t?(this._isProjectile=t,i=!0):e==="pooled"&&this._isPooled!==t&&(this._isPooled=t,i=!0),i&&this._syncTagCache(),t}}class J{constructor(e){s(this,"world");s(this,"entities");s(this,"entitiesByComponent");s(this,"entitiesByTag");s(this,"lastEntityId");s(this,"recycledEntities");s(this,"maxRecycledEntities");this.world=e,this.entities=new Map,this.entitiesByComponent=new Map,this.entitiesByTag=new Map,this.lastEntityId=0,this.recycledEntities=[],this.maxRecycledEntities=100}createEntity(e=""){let t;if(this.recycledEntities.length>0)t=this.recycledEntities.pop(),t.components.clear(),t.tags.clear(),t._isEnemy=void 0,t._isPlayer=void 0,t._isProjectile=void 0;else{const i=this._generateEntityId();t=new Q(i,this.world)}return this.entities.set(t.id.toString(),t),e&&t.addTag(e),this.world.messageBus.publish("entity.created",{entity:t}),t}destroyEntity(e){const t=typeof e=="string"?e:e.id,i=this.entities.get(t.toString());if(i){this.world.messageBus.publish("entity.destroyed",{entity:i}),i.tags.forEach(n=>{if(this.entitiesByTag.has(n)){const o=this.entitiesByTag.get(n),r=o.indexOf(i);r!==-1&&o.splice(r,1),o.length===0&&this.entitiesByTag.delete(n)}});for(const[n,o]of i.components.entries())i.removeComponent(o.constructor);this.entities.delete(t.toString()),this.recycledEntities.length<this.maxRecycledEntities&&this.recycledEntities.push(i)}}getEntity(e){return this.entities.get(e.toString())}getEntitiesByTag(e){return this.entitiesByTag.get(e)||[]}getEntitiesWithComponents(e){return!e||e.length===0?Array.from(this.entities.values()):Array.from(this.entities.values()).filter(t=>e.every(i=>t.hasComponent(i)))}getEntities(){return Array.from(this.entities.values())}onTagAdded(e,t){this.entitiesByTag.has(t)||this.entitiesByTag.set(t,[]),this.entitiesByTag.get(t).push(e)}onTagRemoved(e,t){if(this.entitiesByTag.has(t)){const i=this.entitiesByTag.get(t),n=i.indexOf(e);n!==-1&&i.splice(n,1),i.length===0&&this.entitiesByTag.delete(t)}}_generateEntityId(){return(++this.lastEntityId).toString()}}class X{constructor(e){s(this,"world");s(this,"systems");s(this,"systemsByType");s(this,"_tick");this.world=e,this.systems=[],this.systemsByType=new Map,window.__perf||(window.__perf={systems:{}}),this._tick=0}registerSystem(e){const t=e.type||e.constructor.name;return this.systemsByType.has(t)?(console.warn(`System of type ${t} already registered`),e):(this.systems.push(e),this.systemsByType.set(t,e),this.systems.sort((i,n)=>i.priority-n.priority),e)}getSystem(e){const t=e.type||e.name;return this.systemsByType.get(t)}update(e){this._tick=this._tick+1>>>0;for(const t of this.systems){if(!t.enabled)continue;const i=t.type||t.constructor.name;if((i==="EnemySystem"||i==="CollisionSystem"||i==="TargetingSystem")&&(this._tick&1)===1)continue;const o=performance.now();t.update(e);const r=performance.now();window.__perf&&(window.__perf.systems||(window.__perf.systems={}),window.__perf.systems[i]=Number(r-o))}}initialize(){for(const e of this.systems)typeof e.initialize=="function"&&e.initialize()}enableSystem(e){const t=this.getSystem(e);t&&t.enable()}disableSystem(e){const t=this.getSystem(e);t&&t.disable()}}class Y{constructor(e=200){s(this,"cellSize");s(this,"map");s(this,"entityToCells");this.cellSize=e,this.map=new Map,this.entityToCells=new Map}_key(e,t,i){return`${e}|${t}|${i}`}_cellIndex(e){return Math.floor(e/this.cellSize)|0}_computeKeysForAABB(e,t){const i=this._cellIndex(e.x),n=this._cellIndex(e.y),o=this._cellIndex(e.z),r=this._cellIndex(t.x),a=this._cellIndex(t.y),c=this._cellIndex(t.z),y=[];for(let u=i;u<=r;u++)for(let d=n;d<=a;d++)for(let m=o;m<=c;m++)y.push(this._key(u,d,m));return y}insert(e,t,i=1){const n={x:t.x-i,y:t.y-i,z:t.z-i},o={x:t.x+i,y:t.y+i,z:t.z+i},r=this._computeKeysForAABB(n,o);this.entityToCells.set(e,r);for(const a of r){let c=this.map.get(a);c||(c=new Set,this.map.set(a,c)),c.add(e)}}update(e,t,i=1){this.remove(e),this.insert(e,t,i)}remove(e){const t=this.entityToCells.get(e);if(t){for(const i of t){const n=this.map.get(i);n&&(n.delete(e),n.size===0&&this.map.delete(i))}this.entityToCells.delete(e)}}querySphere(e,t){const i={x:e.x-t,y:e.y-t,z:e.z-t},n={x:e.x+t,y:e.y+t,z:e.z+t},o=this._computeKeysForAABB(i,n),r=new Set;for(const a of o){const c=this.map.get(a);if(c)for(const y of c)r.add(y)}return Array.from(r)}}class Z{constructor(){s(this,"entityToView");s(this,"tagToEntities");this.entityToView=new Map,this.tagToEntities=new Map}setView(e,t){this.entityToView.set(e,t)}getView(e){return this.entityToView.get(e)}clearView(e){this.entityToView.delete(e)}addTag(e,t){let i=this.tagToEntities.get(t);i||(i=new Set,this.tagToEntities.set(t,i)),i.add(e)}removeTag(e,t){const i=this.tagToEntities.get(t);i&&(i.delete(e),i.size===0&&this.tagToEntities.delete(t))}getByTag(e){const t=this.tagToEntities.get(e);return t?Array.from(t):[]}}class ee{constructor(e=null){s(this,"messageBus");s(this,"entityManager");s(this,"systemManager");s(this,"spatial");s(this,"index");s(this,"deltaTime");s(this,"time");s(this,"lastUpdateTime");s(this,"scene");s(this,"optimizedProjectiles");s(this,"playerEntity");this.messageBus=e||new G,!e&&!globalThis.mainMessageBus&&(globalThis.mainMessageBus=this.messageBus),this.entityManager=new J(this),this.systemManager=new X(this),this.spatial=new Y(400),this.index=new Z,this.deltaTime=0,this.time=0,this.lastUpdateTime=0}initialize(){this.lastUpdateTime=performance.now(),this.systemManager.initialize(),this.messageBus.publish("world.initialized",{})}onEntityTransformUpdated(e){const t=e.getComponent&&e.getComponent("TransformComponent");t&&this.spatial.update(e.id,t.position,e.collisionRadius||1)}update(){const e=performance.now();this.deltaTime=Math.min((e-this.lastUpdateTime)/1e3,.1),this.lastUpdateTime=e,this.time+=this.deltaTime,this.messageBus.publish("world.preUpdate",{deltaTime:this.deltaTime,time:this.time}),this.systemManager.update(this.deltaTime),this.messageBus.publish("world.postUpdate",{deltaTime:this.deltaTime,time:this.time}),O.enabled&&this.time%5<this.deltaTime}createEntity(e=""){return this.entityManager.createEntity(e)}destroyEntity(e){this.entityManager.destroyEntity(e)}registerSystem(e){return this.systemManager.registerSystem(e)}getEntitiesWithComponents(e){return this.entityManager.getEntitiesWithComponents(e)}getEntitiesByTag(e){return this.entityManager.getEntitiesByTag(e)}getEntity(e){return this.entityManager.getEntity(e)}getSystem(e){return this.systemManager.getSystem(e)}}class te{constructor(){s(this,"world",null);s(this,"playerEntity",null);s(this,"worldInitialized",!1)}async initializeECSWorld(e,t){try{if(console.log("[COMBAT] Starting ECS world initialization..."),this.world=new ee(window.mainMessageBus),console.log("[COMBAT] Created world with messageBus: ",this.world.messageBus===window.mainMessageBus?"Using shared messageBus":"Created new messageBus"),window.game&&(window.game.ecsWorld=this.world,console.log("[COMBAT] Made ECS world globally available via window.game.ecsWorld")),this.world.scene=e,console.log("[COMBAT] Set scene reference in ECS world for enemy rendering:",e?"Scene available":"No scene available"),await this.createPlayerReferenceEntity(t),!this.world.optimizedProjectiles)try{const{OptimizedProjectileStore:i}=await F(async()=>{const{OptimizedProjectileStore:n}=await import("./OptimizedProjectileStore-BRZEo0cf.js");return{OptimizedProjectileStore:n}},[]);this.world.optimizedProjectiles=new i(4096),console.log("[COMBAT] OptimizedProjectileStore created")}catch(i){console.warn("[COMBAT] OptimizedProjectileStore unavailable:",i)}return console.log("[COMBAT] ECS world initialization complete"),this.world}catch(i){throw console.error("[COMBAT] Error initializing ECS world:",i),i}}async createPlayerReferenceEntity(e){if(!this.world)return console.error("[COMBAT] Cannot create player entity - world not available"),null;if(!e)return console.error("[COMBAT] Cannot create player entity - spaceship not available"),null;try{if(console.log("[COMBAT] Creating player reference entity..."),this.playerEntity){const o=this.world.getEntity(this.playerEntity.id);if(o){console.log(`[COMBAT] Player entity already exists with ID: ${this.playerEntity.id}`),o.hasTag("player")||(console.log("[COMBAT] Re-adding 'player' tag to existing entity"),o.addTag("player"));const r=o.getComponent("TransformComponent");return r&&e.mesh&&(r.position.copy(e.mesh.position),r.rotation.copy(e.mesh.rotation),r.quaternion.copy(e.mesh.quaternion),typeof r.setUpdated=="function"&&r.setUpdated()),window.game&&(window.game.combat=window.game.combat||{},window.game.combat.playerEntity=o),o}else console.log("[COMBAT] Previous player entity no longer exists, creating new one")}const t=this.world.createEntity("player_"+Date.now());t.addTag("player"),console.log(`[COMBAT] Added 'player' tag to entity ${t.id}`);const i=class{constructor(r){s(this,"position");s(this,"rotation");s(this,"quaternion");this.position=r||new E,this.rotation=new D,this.quaternion=new _}},n=class{constructor(r,a){s(this,"health");s(this,"shield");s(this,"maxHealth");s(this,"maxShield");this.health=r||100,this.shield=a||50,this.maxHealth=r||100,this.maxShield=a||50}};try{const o=e.mesh?e.mesh.position.clone():new E,r=new i(o);t.addComponent(r),console.log(`[COMBAT] Added TransformComponent to player entity with position: ${o.x.toFixed(1)}, ${o.y.toFixed(1)}, ${o.z.toFixed(1)}`)}catch(o){console.error("[COMBAT] Error adding TransformComponent to player entity:",o)}try{const o=new n(100,50);t.addComponent(o),console.log("[COMBAT] Added HealthComponent to player entity")}catch(o){console.error("[COMBAT] Error adding HealthComponent to player entity:",o)}return this.playerEntity=t,window.game&&(window.game.combat=window.game.combat||{},window.game.combat.playerEntity=t,console.log("[COMBAT] Made player entity globally accessible via window.game.combat.playerEntity")),this.world.playerEntity=t,console.log("[COMBAT] Made player entity available directly via world.playerEntity"),this.world&&this.world.messageBus&&(this.world.messageBus.publish("player.created",{entity:t}),console.log("[COMBAT] Published player.created event")),console.log("[COMBAT] Successfully created player reference entity with ID:",t.id),t}catch(t){return console.error("[COMBAT] Error creating player reference entity:",t),console.error("[COMBAT] Stack trace:",t.stack),null}}updatePlayerReference(e){if(!this.world||!e||!this.playerEntity){if(this.world&&e&&!this.playerEntity){console.log("No player entity found, creating one..."),this.createPlayerReferenceEntity(e);return}return}const t=this.world.getEntity(this.playerEntity.id);if(!t){console.warn("Player entity lost, recreating..."),this.createPlayerReferenceEntity(e);return}const i=t.getComponent("TransformComponent");i&&e.mesh&&(i.position.copy(e.mesh.position),i.rotation.copy(e.mesh.rotation),i.quaternion.copy(e.mesh.quaternion),typeof i.setUpdated=="function"&&i.setUpdated());const n=t.getComponent("HealthComponent");n&&e.health!==void 0&&(e.health>n.health&&(n.health=e.health),e.shield!==void 0&&e.shield>n.shield&&(n.shield=e.shield))}updateSpaceshipHealth(e){if(!this.playerEntity||!e)return;const t=this.playerEntity.getComponent("HealthComponent");t&&(t.health<e.hull&&(console.log(`Damage detected in health component: ${t.health} (was ${e.hull})`),e.hull=t.health),t.shield<e.shield&&(console.log(`Shield damage detected in health component: ${t.shield} (was ${e.shield})`),e.shield=t.shield),t.isDestroyed&&!e.isDestroyed&&(console.log("Health component indicates player is destroyed - updating spaceship state"),e.isDestroyed=!0,typeof e.handleDestruction=="function"&&e.handleDestruction()),t.health<=0&&!e.isDestroyed&&(console.log("Player health is zero - marking spaceship as destroyed"),e.isDestroyed=!0,typeof e.handleDestruction=="function"&&e.handleDestruction(),window.game&&(console.log("FORCING GAME OVER FROM COMBAT MODULE!"),window.game.gameOver("You were pwned by a space alien!"))))}initializeWorld(){try{console.log("[COMBAT] Calling world.initialize()..."),this.world.initialize(),console.log("[COMBAT] World initialization completed successfully")}catch(e){console.error("[COMBAT] Error during world.initialize():",e),console.error("[COMBAT] Stack trace:",e.stack),console.log("[COMBAT] Continuing despite initialization error")}}setWorldInitialized(){this.worldInitialized=!0}setSceneReference(e){e&&(e.ecsWorld=this.world,console.log("[COMBAT] Set ECS world reference in scene for cross-system access"))}getWorld(){return this.world}getPlayerEntity(){return this.playerEntity}isWorldInitialized(){return this.worldInitialized}}class ie{constructor(){s(this,"registeredSystems",{})}async registerAllSystems(e,t){return console.warn("[COMBAT] Legacy ECS systems removed; SystemRegistrar is a no-op."),this.registeredSystems={},this.registeredSystems}getSystem(e){return this.registeredSystems[e]}getAllSystems(){return this.registeredSystems}setSystemsEnabled(e){console.warn("[COMBAT] setSystemsEnabled called on legacy SystemRegistrar.")}async importAndRegisterSystem(e,t,i,n=null){return console.warn("[COMBAT] importAndRegisterSystem called on legacy SystemRegistrar."),null}}class se{constructor(){s(this,"subscriptions",[]);s(this,"world",null);s(this,"playerEntity",null)}setupEventHandlers(e,t){if(this.world=e,this.playerEntity=t,!e||!e.messageBus)return;const i=e.messageBus,n=i.subscribe("enemy.destroyed",r=>{this.handleEnemyDestroyed(r)});this.subscriptions.push({topic:"enemy.destroyed",token:n});const o=i.subscribe("entity.damage",r=>{this.handleEntityDamage(r)});this.subscriptions.push({topic:"entity.damage",token:o}),console.log(`[COMBAT] Event handlers setup for world ${e.id||"default"}`)}handleEnemyDestroyed(e){if(window.game&&window.game.ui&&window.game.ui.updateScore){const t=e.points||100;window.game.ui.updateScore(t)}}handleEntityDamage(e){const{entityId:t,damage:i,shieldDamage:n}=e;this.playerEntity&&t===this.playerEntity.id&&window.mainMessageBus&&window.mainMessageBus.publish("player.damaged",{damage:i,shieldDamage:n,source:e.source||"unknown"})}cleanup(){if(!(!this.world||!this.world.messageBus)){for(const e of this.subscriptions)this.world.messageBus.unsubscribe(e.topic,e.token);this.subscriptions=[]}}}class re{constructor(){s(this,"activeTracers",[])}createExplosionEffect(e,t=1e3,i=!0,n=null,o=null){try{let r=null;if(n&&n.getExplosion&&(r=n.getExplosion(e,t)),!r){const a=new z(30,16,16),c=new S({color:16737792,transparent:!0,opacity:.9,blending:w}),y=c;y.emissive=16724736,y.emissiveIntensity=2,r=new M(a,c),r.position.copy(e),o?o(r):window.game&&window.game.scene&&window.game.scene.add(r);const u=Date.now(),d=()=>{const h=(Date.now()-u)/t;if(h>=1||!r.parent){r.parent&&r.parent.remove(r),a.dispose(),c.dispose();return}const p=1+h*3;r.scale.setScalar(p),c.opacity=.9*(1-h),requestAnimationFrame(d)};d()}return window.game&&window.game.audio&&window.game.audio.playSound("boink"),window.mainMessageBus&&window.mainMessageBus.publish("input.vibrate",{intensity:.8,duration:200}),r}catch(r){return console.error("Error creating explosion effect:",r),null}}createInstantTracer(e,t,i=!1,n=.5,o=null){const r=e.distanceTo(t),a=new j,c=new T(1.5,1.5,r,12),y=new S({color:16777130,transparent:!0,opacity:1,blending:w}),u=new M(c,y),d=new T(3,3,r,8),m=new S({color:i?16755200:16746496,transparent:!0,opacity:.6,blending:w}),h=new M(d,m),p=new T(5,5,r,6),l=new S({color:i?65535:35071,transparent:!0,opacity:.3,blending:w}),f=new M(p,l);a.add(u),a.add(h),a.add(f);const C=new E().addVectors(e,t).multiplyScalar(.5);a.position.copy(C);const P=new E().subVectors(t,e).normalize(),b=new _;return b.setFromUnitVectors(new E(0,1,0),P),a.quaternion.copy(b),o&&o(a),a.userData={startTime:performance.now(),fadeTime:n*1e3,beamLength:r,startPos:e.clone(),endPos:t.clone(),direction:P.clone(),coreMesh:u,innerGlowMesh:h,outerGlowMesh:f,initialCoreOpacity:1,initialInnerOpacity:.6,initialOuterOpacity:.3,isDissolving:!1},this.activeTracers.push(a),a}updateTracers(e,t=null){if(!this.activeTracers||this.activeTracers.length===0)return;const i=performance.now(),n=[];for(let o=this.activeTracers.length-1;o>=0;o--){const r=this.activeTracers[o],a=r.userData;if(!a)continue;const c=i-a.startTime,y=Math.min(c/a.fadeTime,1);if(y>=1)t&&t(r),n.push(o);else{const u=a.beamLength*y,d=a.direction.clone().multiplyScalar(u),m=a.startPos.clone().add(d),h=a.beamLength*(1-y);if(h>.1){a.coreMesh.geometry.dispose(),a.innerGlowMesh.geometry.dispose(),a.outerGlowMesh.geometry.dispose(),a.coreMesh.geometry=new T(1.5,1.5,h,12),a.innerGlowMesh.geometry=new T(3,3,h,8),a.outerGlowMesh.geometry=new T(5,5,h,6);const p=new E().addVectors(m,a.endPos).multiplyScalar(.5);r.position.copy(p);const l=Math.pow(1-y,.3);a.coreMesh.material.opacity=a.initialCoreOpacity*l,a.innerGlowMesh.material.opacity=a.initialInnerOpacity*l,a.outerGlowMesh.material.opacity=a.initialOuterOpacity*l}}}n.sort((o,r)=>r-o);for(const o of n)this.activeTracers.splice(o,1)}dispose(){this.activeTracers=[]}}class ne{constructor(e){s(this,"scene");s(this,"projectileMaterial");s(this,"projectileGlowMaterial");s(this,"trailParticleMaterial");s(this,"muzzleFlashMaterial");s(this,"tracerLineMaterial");s(this,"pointLightMaterial");s(this,"explosionParticleMaterial");this.scene=e,this.projectileMaterial={},this.projectileGlowMaterial={},this.trailParticleMaterial={},this.muzzleFlashMaterial={},this.tracerLineMaterial={},this.pointLightMaterial={},this.explosionParticleMaterial={},this.initializeTemplateMaterials()}initializeTemplateMaterials(){console.log("Initializing template materials for combat effects"),this.projectileMaterial=new R({color:16711680,emissive:16711680,emissiveIntensity:10,metalness:.5,roughness:.5}),this.projectileGlowMaterial=new S({color:16711680,transparent:!0,opacity:.5,blending:w}),this.trailParticleMaterial=new S({color:16711680,transparent:!0,opacity:.9,blending:w}),this.muzzleFlashMaterial=new S({color:16711680,transparent:!0,opacity:.8,blending:w,side:I,depthWrite:!1,wireframe:!1}),this.tracerLineMaterial=new L({color:16711680,transparent:!0,opacity:.8,blending:w}),this.pointLightMaterial=new S({color:16711680,transparent:!0,opacity:.9,blending:w,depthWrite:!1}),this.explosionParticleMaterial=new W({color:16724736,size:15,transparent:!0,opacity:1,blending:w}),this.precompileShaders()}precompileShaders(){const e=new k(.1,.1,.1),t=new z(.1,8,8),i=new T(.1,.2,1,8,1),n=new Float32Array(30);for(let f=0;f<30;f++)n[f]=Math.random()-.5;const o=new v;o.setAttribute("position",new H(n,3));const r=new M(t,this.projectileMaterial),a=new M(t,this.projectileGlowMaterial),c=new M(t,this.trailParticleMaterial),y=new M(i,this.muzzleFlashMaterial),u=new U(new v().setFromPoints([new E(0,0,0),new E(0,0,1)]),this.tracerLineMaterial),d=new V(o,this.explosionParticleMaterial),m=new $;for(let f=0;f<5;f++){const C=new M(t,this.trailParticleMaterial.clone());C.position.z=-f*.2,m.add(C)}const h=new N;h.add(r),h.add(a),h.add(c),h.add(y),h.add(u),h.add(m),h.add(d);const p=this._getAddToSceneFunction(),l=this._getRemoveFromSceneFunction();p(r),p(a),p(c),p(y),p(u),p(m),p(d),window.renderer?(console.log("Forcing shader compilation with renderer.compile()"),window.renderer.compile(h,this.scene.camera||{isCamera:!0,matrixWorldInverse:new B}),window.renderer.compile(this.scene,this.scene.camera||{isCamera:!0,matrixWorldInverse:new B})):window.game&&window.game.renderer&&window.game.renderer.renderer?(console.log("Forcing shader compilation with game.renderer.renderer.compile()"),window.game.renderer.renderer.compile(h,this.scene.camera||window.game.camera||{isCamera:!0,matrixWorldInverse:new B}),window.game.renderer.renderer.compile(this.scene,this.scene.camera||window.game.camera||{isCamera:!0,matrixWorldInverse:new B})):console.warn("No renderer available for shader pre-compilation"),setTimeout(()=>{l(r),l(a),l(c),l(y),l(u),l(m),l(d),e.dispose(),t.dispose(),i.dispose(),o.dispose(),m.children.forEach(f=>{f.geometry&&f.geometry.dispose(),f.material&&f.material.dispose()}),console.log("Template materials initialized and dummy objects removed")},500)}getMaterial(e){switch(e){case"projectile":return this.projectileMaterial;case"projectileGlow":return this.projectileGlowMaterial;case"trailParticle":return this.trailParticleMaterial;case"muzzleFlash":return this.muzzleFlashMaterial;case"tracerLine":return this.tracerLineMaterial;case"pointLight":return this.pointLightMaterial;case"explosionParticle":return this.explosionParticleMaterial;default:return null}}_getAddToSceneFunction(){const e=window.game&&window.game.renderer?window.game.renderer:null;return e&&typeof e._withGuard=="function"?t=>e._withGuard(()=>e.add(t)):this.scene&&typeof this.scene.add=="function"?t=>this.scene.add(t):()=>{}}_getRemoveFromSceneFunction(){const e=window.game&&window.game.renderer?window.game.renderer:null;return e&&typeof e._withGuard=="function"?t=>e._withGuard(()=>this.scene.remove(t)):this.scene&&typeof this.scene.remove=="function"?t=>this.scene.remove(t):()=>{}}dispose(){this.projectileMaterial&&this.projectileMaterial.dispose(),this.projectileGlowMaterial&&this.projectileGlowMaterial.dispose(),this.trailParticleMaterial&&this.trailParticleMaterial.dispose(),this.muzzleFlashMaterial&&this.muzzleFlashMaterial.dispose(),this.tracerLineMaterial&&this.tracerLineMaterial.dispose(),this.pointLightMaterial&&this.pointLightMaterial.dispose(),this.explosionParticleMaterial&&this.explosionParticleMaterial.dispose(),console.log("Material resources disposed")}}class ae{constructor(){this.precreateGeometries()}precreateGeometries(){console.log("Pre-creating geometries for combat effects");const e=window.game||(window.game={});e.projectileGeometry=new T(.15,.15,10,8),e.projectileGlowGeometry=new z(.8,12,12),e.muzzleFlashGeometry=new T(.5,2,15,12,1,!0),e.muzzleFlashGeometry.rotateX(Math.PI/2),e.muzzleFlashGeometry.translate(0,0,15/2),e.trailParticleGeometries=[];const t=20;for(let n=0;n<t;n++){const r=.5*(1-n/t);e.trailParticleGeometries[n]=new z(r,8,8)}e.tracerGeometry=new v;const i=[0,0,0,0,0,1];e.tracerGeometry.setAttribute("position",new q(i,3)),console.log("Combat geometries pre-created successfully")}storeMaterialReferences(e){const t=window.game||(window.game={});t.projectileMaterial=e.projectileMaterial,t.projectileGlowMaterial=e.projectileGlowMaterial,t.trailParticleMaterial=e.trailParticleMaterial,t.muzzleFlashMaterial=e.muzzleFlashMaterial,t.tracerLineMaterial=e.tracerLineMaterial,t.explosionParticleMaterial=e.explosionParticleMaterial}dispose(){const e=window.game;e&&(e.projectileGeometry&&e.projectileGeometry.dispose(),e.projectileGlowGeometry&&e.projectileGlowGeometry.dispose(),e.muzzleFlashGeometry&&e.muzzleFlashGeometry.dispose(),e.trailParticleGeometries&&e.trailParticleGeometries.forEach(t=>t.dispose()),e.tracerGeometry&&e.tracerGeometry.dispose()),console.log("Geometry resources disposed")}}class oe{constructor(){}createMuzzleFlash(e,t,i){if(!i)return console.warn("No pool manager available for muzzle flash"),null;const n=i.getMuzzleFlash();n.position.copy(e);const o=e.clone().add(t.clone().normalize().multiplyScalar(10));n.lookAt(o),n.userData.initialPosition=e.clone(),n.userData.direction=t.clone();const r=n.userData.flashLight;return r&&(r.position.copy(e),r.intensity=200),n}addProjectileTrail(e,t,i){var u;if(!i){console.warn("PoolManager not available for projectile trail.");return}const a=i.getTrailContainer();if(!a){console.warn("Failed to get trail container from pool.");return}e.add(a);const c=[];a.userData.particles=c,a.userData.isTrailActive=!0;for(let d=0;d<4;d++){const m=d/3,h=(u=window.game)==null?void 0:u.trailParticleGeometries,p=h&&h.length>0?d%h.length:0,l=i.getTrailParticle(p);if(!l){console.warn(`Failed to get trail particle ${d} from pool.`);continue}const f=t.clone().multiplyScalar(-m*4-2);l.position.copy(f),l.userData.creationTime=performance.now(),l.userData.initialOpacity=l.material.opacity,l.userData.initialScale=l.scale.x,a.add(l),c.push(l)}e.userData.trail=a;const y=()=>{if(!e.parent||!a.userData.isTrailActive){a.userData.isTrailActive=!1;return}for(let d=c.length-1;d>=0;d--){const m=c[d],h=performance.now()-m.userData.creationTime,p=Math.min(h/150,1);if(p>=1)i.releaseTrailParticle(m),c.splice(d,1),m.parent&&m.parent.remove(m);else{m.material.opacity=m.userData.initialOpacity*(1-p);const l=m.userData.initialScale*(1-p);m.scale.set(l,l,l)}}if(c.length===0){a.userData.isTrailActive=!1;return}requestAnimationFrame(y)};y()}createAimingTracer(e,t,i=3e3,n){if(!n)return console.warn("No pool manager available for aiming tracer"),null;const o=n.getTracer(),r=e.clone().add(t.clone().multiplyScalar(i)),a=o.geometry.attributes.position.array;return a[0]=e.x,a[1]=e.y,a[2]=e.z,a[3]=r.x,a[4]=r.y,a[5]=r.z,o.geometry.attributes.position.needsUpdate=!0,o}}class le{constructor(e){s(this,"scene");s(this,"materialManager");s(this,"geometryManager");s(this,"explosionEffects");s(this,"projectileEffects");this.scene=e,this.materialManager=new ne(e),this.geometryManager=new ae,this.explosionEffects=new re,this.projectileEffects=new oe,this.geometryManager.storeMaterialReferences(this.materialManager)}createExplosionEffect(e,t=1e3,i=!0,n=null){return this.explosionEffects.createExplosionEffect(e,t,i,n,this._addToScene.bind(this))}createInstantTracer(e,t,i=!1,n=.5){return this.explosionEffects.createInstantTracer(e,t,i,n,this._addToScene.bind(this))}updateTracers(e){this.explosionEffects.updateTracers(e,this._removeFromScene.bind(this))}createMuzzleFlash(e,t,i){return this.projectileEffects.createMuzzleFlash(e,t,i)}addProjectileTrail(e,t,i){this.projectileEffects.addProjectileTrail(e,t,i)}createAimingTracer(e,t,i=3e3,n){return this.projectileEffects.createAimingTracer(e,t,i,n)}getMaterial(e){return this.materialManager.getMaterial(e)}_addToScene(e){const t=window.game&&window.game.renderer?window.game.renderer:null;t&&typeof t._withGuard=="function"?t._withGuard(()=>t.add(e)):this.scene&&typeof this.scene.add=="function"&&this.scene.add(e)}_removeFromScene(e){const t=window.game&&window.game.renderer?window.game.renderer:null;t&&typeof t._withGuard=="function"?t._withGuard(()=>this.scene.remove(e)):this.scene&&typeof this.scene.remove=="function"&&this.scene.remove(e)}dispose(){this.explosionEffects.dispose(),this.materialManager.dispose(),this.geometryManager.dispose(),console.log("Effects resources disposed")}}class ce{constructor(){s(this,"enemySystem",null)}configureEnemySystem(e){this.enemySystem=e,e&&typeof e.configure=="function"&&(e.configure({maxEnemies:50,spawnRate:.5,poolEnabled:!0}),console.log("[COMBAT] Enemy system configured with maxEnemies: 50"))}registerEnemy(e){this.enemySystem&&typeof this.enemySystem.registerEnemy=="function"&&this.enemySystem.registerEnemy(e)}unregisterEnemy(e){this.enemySystem&&typeof this.enemySystem.unregisterEnemy=="function"&&this.enemySystem.unregisterEnemy(e)}emergencyCleanup(){this.enemySystem&&typeof this.enemySystem.cleanupAll=="function"&&this.enemySystem.cleanupAll()}}class he{constructor(e,t,i){s(this,"effectsManager");s(this,"eventManager");s(this,"aiSpawnerManager");s(this,"raycaster");this.effectsManager=e,this.eventManager=t,this.aiSpawnerManager=i,this.raycaster=new K}fireParticleCannon(e,t,i,n,o,r,a){const c=performance.now();if(c-r<a)return{newLastFireTime:r,success:!1};if(!e||!t||!t.mesh)return{newLastFireTime:r,success:!1};const y=new E;t.mesh.getWorldPosition(y);const u=new E(0,0,-1);u.applyQuaternion(t.mesh.quaternion),this.raycaster.set(y,u),this.raycaster.far=2e3;const d=[];e.traverse(l=>{l instanceof M&&l!==t.mesh&&l.visible&&(l.name&&(l.name.includes("enemy")||l.name.includes("asteroid"))||l.userData&&l.userData.entityId)&&d.push(l)});const m=this.raycaster.intersectObjects(d);let h=y.clone().add(u.clone().multiplyScalar(2e3)),p=null;if(m.length>0){const l=m[0];h=l.point,l.object.userData&&l.object.userData.entityId&&(p=l.object.userData.entityId,i&&i.messageBus&&i.messageBus.publish("entity.damage",{entityId:p,damage:o,source:"player",hitPoint:l.point,hitNormal:l.face?l.face.normal:null})),this.effectsManager&&this.effectsManager.createExplosionEffect(l.point,500,!0)}return this.effectsManager&&(this.effectsManager.createInstantTracer(y,h,p!==null),this.effectsManager.createMuzzleFlash(y,u)),window.game&&window.game.audio&&window.game.audio.playWeaponSound(),window.mainMessageBus&&(window.mainMessageBus.publish("weapon.fire",{type:"projectile",direction:u.clone()}),window.mainMessageBus.publish("input.vibrate",{intensity:.3,duration:50})),{newLastFireTime:c,success:!0}}}class ge{constructor(e,t){s(this,"scene");s(this,"spaceship");s(this,"fireRate");s(this,"lastFireTime");s(this,"aimingSpread");s(this,"isFiring");s(this,"cooldown");s(this,"particleCannonDamage");s(this,"worldSetup");s(this,"systemRegistrar");s(this,"eventManager");s(this,"effectsManager");s(this,"aiSpawnerManager");s(this,"combatLogic");s(this,"world");s(this,"playerEntity");s(this,"enemySystem");s(this,"disposed",!1);this.scene=e,this.spaceship=t,this.fireRate=3,this.lastFireTime=0,this.aimingSpread=.05,this.isFiring=!1,this.cooldown=1e3/this.fireRate,this.particleCannonDamage=20,this.worldSetup=new te,this.systemRegistrar=new ie,this.eventManager=new se,this.effectsManager=new le(e),this.aiSpawnerManager=new ce,this.combatLogic=new he(this.effectsManager,this.eventManager,this.aiSpawnerManager),this.initializeECSWorld()}async initializeECSWorld(){try{this.world=await this.worldSetup.initializeECSWorld(this.scene,this.spaceship),await this.setupECSWorld()}catch(e){console.error("[COMBAT] Error initializing ECS world:",e)}}async setupECSWorld(){if(!this.worldSetup.isWorldInitialized())try{const e=await this.systemRegistrar.registerAllSystems(this.world,this.scene);Object.assign(this,e),this.eventManager.setupEventHandlers(this.world,this.worldSetup.getPlayerEntity()),this.worldSetup.setSceneReference(this.scene),this.worldSetup.initializeWorld(),this.playerEntity=await this.worldSetup.createPlayerReferenceEntity(this.spaceship),this.enemySystem&&this.aiSpawnerManager.configureEnemySystem(this.enemySystem),this.worldSetup.setWorldInitialized()}catch(e){console.error("[COMBAT] Error setting up ECS world:",e)}}update(e){if(!this.scene||!this.spaceship)return;const t=window.game&&window.game.introSequenceActive;if(this.updatePlayerReference(),this.updateSpaceshipHealth(),this.effectsManager.updateTracers(e),this.isFiring&&!this.spaceship.isDocked&&this.fireParticleCannon(),this.world&&!t)this.world.update(e);else if(this.world&&t){if(this.world.systems)for(const i of this.world.systems){const n=i.type||i.constructor.name;n!=="EnemySystem"&&n!=="EnemyAISystem"&&i.update(e)}}else this.world}updatePlayerReference(){this.worldSetup.updatePlayerReference(this.spaceship)}updateSpaceshipHealth(){this.worldSetup.updateSpaceshipHealth(this.spaceship)}setFiring(e){this.isFiring=e}createExplosionEffect(e,t=1e3,i=!0){return this.effectsManager.createExplosionEffect(e,t,i,null)}registerEnemy(e){this.aiSpawnerManager.registerEnemy(e)}unregisterEnemy(e){this.aiSpawnerManager.unregisterEnemy(e)}fireParticleCannon(){const e=this.combatLogic.fireParticleCannon(this.scene,this.spaceship,this.world,this.playerEntity,this.particleCannonDamage,this.lastFireTime,this.cooldown);return this.lastFireTime=e.newLastFireTime,e.success}setEnabled(e){this.systemRegistrar.setSystemsEnabled(e)}createAimingTracer(e,t,i=3e3){return this.effectsManager.createAimingTracer(e,t,i,null)}createMuzzleFlash(e,t){return this.effectsManager.createMuzzleFlash(e,t,null)}dispose(){this.effectsManager&&this.effectsManager.dispose(),this.eventManager&&this.eventManager.cleanup(),this.aiSpawnerManager&&this.aiSpawnerManager.emergencyCleanup(),this.disposed=!0}async importAndRegisterSystem(e,t){return this.systemRegistrar.importAndRegisterSystem(e,t,this.world,this.scene)}}export{ge as Combat};
//# sourceMappingURL=combat-oJGfwFeG.js.map
