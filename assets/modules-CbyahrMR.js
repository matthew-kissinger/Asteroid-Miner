var Vt=Object.defineProperty;var Wt=(p,e,t)=>e in p?Vt(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var he=(p,e,t)=>Wt(p,typeof e!="symbol"?e+"":e,t);import{T as qt,a as Qe,b as Mt,L as Kt,c as Ce,F as Tt,M as se,V as H,C as E,d as ae,S as z,e as Yt,P as xe,D as Ge,f as V,g as y,I as kt,Q as fe,h as Qt,O as Pe,i as Ie,j as Xt,B as _,k as Zt,l as At,N as Jt,m as es,n as ts,o as Xe,p as Pt,R as Ze,q as ss,r as is,s as te,t as je,u as Me,v as R,w as K,x as F,y as os,z as j,A as ns,E as C,G as It,H as Te,J as as,K as Z,U as O,W as Rt,X as rs,Y as Dt,Z as ls,_ as cs,$ as ds,a0 as hs,a1 as Bt,a2 as us,a3 as Je,a4 as dt,a5 as ht,a6 as ut,a7 as pt,a8 as Lt,a9 as ps,aa as ze,ab as ms,ac as et,ad as X,ae as tt,af as Ue,ag as He,ah as gs,ai as fs,aj as $,ak as Ft,al as ys,am as _e,an as ws,ao as bs,ap as xs,aq as me,ar as ge,as as le,at as vs,au as G,av as ee,aw as at,ax as ke,ay as Ve,az as We,aA as Ss,aB as Ae,aC as Cs,aD as $t,aE as st,aF as ne,aG as it,aH as Es,aI as Ms,aJ as Ts,aK as ks,aL as As,aM as Ps,aN as mt}from"./three-VvwEKp-s.js";import{MessageBus as Is}from"./core-BBQ_RQx4.js";const Rs="modulepreload",Ds=function(p){return"/Asteroid-Miner/"+p},gt={},zt=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),a=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));i=Promise.allSettled(t.map(r=>{if(r=Ds(r),r in gt)return;gt[r]=!0;const l=r.endsWith(".css"),c=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${r}"]${c}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":Rs,l||(d.as="script"),d.crossOrigin="",d.href=r,a&&d.setAttribute("nonce",a),document.head.appendChild(d),l)return new Promise((h,u)=>{d.addEventListener("load",h),d.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${r}`)))})}))}function o(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return i.then(n=>{for(const a of n||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})};function ft(p,e){if(e===qt)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),p;if(e===Qe||e===Mt){let t=p.getIndex();if(t===null){const n=[],a=p.getAttribute("position");if(a!==void 0){for(let r=0;r<a.count;r++)n.push(r);p.setIndex(n),t=p.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),p}const s=t.count-2,i=[];if(e===Qe)for(let n=1;n<=s;n++)i.push(t.getX(0)),i.push(t.getX(n)),i.push(t.getX(n+1));else for(let n=0;n<s;n++)n%2===0?(i.push(t.getX(n)),i.push(t.getX(n+1)),i.push(t.getX(n+2))):(i.push(t.getX(n+2)),i.push(t.getX(n+1)),i.push(t.getX(n)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=p.clone();return o.setIndex(i),o.clearGroups(),o}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),p}class Bs extends Kt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Us(t)}),this.register(function(t){return new Hs(t)}),this.register(function(t){return new Ks(t)}),this.register(function(t){return new Ys(t)}),this.register(function(t){return new Qs(t)}),this.register(function(t){return new Ns(t)}),this.register(function(t){return new Gs(t)}),this.register(function(t){return new _s(t)}),this.register(function(t){return new js(t)}),this.register(function(t){return new zs(t)}),this.register(function(t){return new Vs(t)}),this.register(function(t){return new Os(t)}),this.register(function(t){return new qs(t)}),this.register(function(t){return new Ws(t)}),this.register(function(t){return new Fs(t)}),this.register(function(t){return new Xs(t)}),this.register(function(t){return new Zs(t)})}load(e,t,s,i){const o=this;let n;if(this.resourcePath!=="")n=this.resourcePath;else if(this.path!==""){const l=Ce.extractUrlBase(e);n=Ce.resolveURL(l,this.path)}else n=Ce.extractUrlBase(e);this.manager.itemStart(e);const a=function(l){i?i(l):console.error(l),o.manager.itemError(e),o.manager.itemEnd(e)},r=new Tt(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(l){try{o.parse(l,n,function(c){t(c),o.manager.itemEnd(e)},a)}catch(c){a(c)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let o;const n={},a={},r=new TextDecoder;if(typeof e=="string")o=JSON.parse(e);else if(e instanceof ArrayBuffer)if(r.decode(new Uint8Array(e,0,4))===Ut){try{n[I.KHR_BINARY_GLTF]=new Js(e)}catch(d){i&&i(d);return}o=JSON.parse(n[I.KHR_BINARY_GLTF].content)}else o=JSON.parse(r.decode(e));else o=e;if(o.asset===void 0||o.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new ui(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const d=this.pluginCallbacks[c](l);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[d.name]=d,n[d.name]=!0}if(o.extensionsUsed)for(let c=0;c<o.extensionsUsed.length;++c){const d=o.extensionsUsed[c],h=o.extensionsRequired||[];switch(d){case I.KHR_MATERIALS_UNLIT:n[d]=new $s;break;case I.KHR_DRACO_MESH_COMPRESSION:n[d]=new ei(o,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:n[d]=new ti;break;case I.KHR_MESH_QUANTIZATION:n[d]=new si;break;default:h.indexOf(d)>=0&&a[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}l.setExtensions(n),l.setPlugins(a),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,o){s.parse(e,t,i,o)})}}function Ls(){let p={};return{get:function(e){return p[e]},add:function(e,t){p[e]=t},remove:function(e){delete p[e]},removeAll:function(){p={}}}}const I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Fs{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const o=t[s];o.extensions&&o.extensions[this.name]&&o.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,o.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const o=t.json,r=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let l;const c=new E(16777215);r.color!==void 0&&c.setRGB(r.color[0],r.color[1],r.color[2],ae);const d=r.range!==void 0?r.range:0;switch(r.type){case"directional":l=new Ge(c),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new xe(c),l.distance=d;break;case"spot":l=new Yt(c),l.distance=d,r.spot=r.spot||{},r.spot.innerConeAngle=r.spot.innerConeAngle!==void 0?r.spot.innerConeAngle:0,r.spot.outerConeAngle=r.spot.outerConeAngle!==void 0?r.spot.outerConeAngle:Math.PI/4,l.angle=r.spot.outerConeAngle,l.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return l.position.set(0,0,0),oe(l,r),r.intensity!==void 0&&(l.intensity=r.intensity),l.name=t.createUniqueName(r.name||"light_"+e),i=Promise.resolve(l),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,o=s.json.nodes[e],a=(o.extensions&&o.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(r){return s._getNodeRef(t.cache,a,r)})}}class $s{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return F}extendParams(e,t,s){const i=[];e.color=new E(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const n=o.baseColorFactor;e.color.setRGB(n[0],n[1],n[2],ae),e.opacity=n[3]}o.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",o.baseColorTexture,z))}return Promise.all(i)}}class zs{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name].emissiveStrength;return o!==void 0&&(t.emissiveIntensity=o),Promise.resolve()}}class Us{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];if(n.clearcoatFactor!==void 0&&(t.clearcoat=n.clearcoatFactor),n.clearcoatTexture!==void 0&&o.push(s.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),n.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),n.clearcoatRoughnessTexture!==void 0&&o.push(s.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),n.clearcoatNormalTexture!==void 0&&(o.push(s.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),n.clearcoatNormalTexture.scale!==void 0)){const a=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new H(a,a)}return Promise.all(o)}}class Hs{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.dispersion=o.dispersion!==void 0?o.dispersion:0,Promise.resolve()}}class Os{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];return n.iridescenceFactor!==void 0&&(t.iridescence=n.iridescenceFactor),n.iridescenceTexture!==void 0&&o.push(s.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),n.iridescenceIor!==void 0&&(t.iridescenceIOR=n.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),n.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),n.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),n.iridescenceThicknessTexture!==void 0&&o.push(s.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(o)}}class Ns{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new E(0,0,0),t.sheenRoughness=0,t.sheen=1;const n=i.extensions[this.name];if(n.sheenColorFactor!==void 0){const a=n.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],ae)}return n.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=n.sheenRoughnessFactor),n.sheenColorTexture!==void 0&&o.push(s.assignTexture(t,"sheenColorMap",n.sheenColorTexture,z)),n.sheenRoughnessTexture!==void 0&&o.push(s.assignTexture(t,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(o)}}class Gs{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];return n.transmissionFactor!==void 0&&(t.transmission=n.transmissionFactor),n.transmissionTexture!==void 0&&o.push(s.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(o)}}class _s{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];t.thickness=n.thicknessFactor!==void 0?n.thicknessFactor:0,n.thicknessTexture!==void 0&&o.push(s.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||1/0;const a=n.attenuationColor||[1,1,1];return t.attenuationColor=new E().setRGB(a[0],a[1],a[2],ae),Promise.all(o)}}class js{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=i.extensions[this.name];return t.ior=o.ior!==void 0?o.ior:1.5,Promise.resolve()}}class Vs{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];t.specularIntensity=n.specularFactor!==void 0?n.specularFactor:1,n.specularTexture!==void 0&&o.push(s.assignTexture(t,"specularIntensityMap",n.specularTexture));const a=n.specularColorFactor||[1,1,1];return t.specularColor=new E().setRGB(a[0],a[1],a[2],ae),n.specularColorTexture!==void 0&&o.push(s.assignTexture(t,"specularColorMap",n.specularColorTexture,z)),Promise.all(o)}}class Ws{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];return t.bumpScale=n.bumpFactor!==void 0?n.bumpFactor:1,n.bumpTexture!==void 0&&o.push(s.assignTexture(t,"bumpMap",n.bumpTexture)),Promise.all(o)}}class qs{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:se}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],n=i.extensions[this.name];return n.anisotropyStrength!==void 0&&(t.anisotropy=n.anisotropyStrength),n.anisotropyRotation!==void 0&&(t.anisotropyRotation=n.anisotropyRotation),n.anisotropyTexture!==void 0&&o.push(s.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(o)}}class Ks{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const o=i.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o.source,n)}}class Ys{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const n=o.extensions[t],a=i.images[n.source];let r=s.textureLoader;if(a.uri){const l=s.options.manager.getHandler(a.uri);l!==null&&(r=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,n.source,r);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Qs{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const n=o.extensions[t],a=i.images[n.source];let r=s.textureLoader;if(a.uri){const l=s.options.manager.getHandler(a.uri);l!==null&&(r=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,n.source,r);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Xs{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],o=this.parser.getDependency("buffer",i.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return o.then(function(a){const r=i.byteOffset||0,l=i.byteLength||0,c=i.count,d=i.byteStride,h=new Uint8Array(a,r,l);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(c,d,h,i.mode,i.filter).then(function(u){return u.buffer}):n.ready.then(function(){const u=new ArrayBuffer(c*d);return n.decodeGltfBuffer(new Uint8Array(u),c,d,h,i.mode,i.filter),u})})}else return null}}class Zs{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const l of i.primitives)if(l.mode!==Q.TRIANGLES&&l.mode!==Q.TRIANGLE_STRIP&&l.mode!==Q.TRIANGLE_FAN&&l.mode!==void 0)return null;const n=s.extensions[this.name].attributes,a=[],r={};for(const l in n)a.push(this.parser.getDependency("accessor",n[l]).then(c=>(r[l]=c,r[l])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(l=>{const c=l.pop(),d=c.isGroup?c.children:[c],h=l[0].count,u=[];for(const m of d){const f=new V,g=new y,b=new fe,w=new y(1,1,1),v=new kt(m.geometry,m.material,h);for(let x=0;x<h;x++)r.TRANSLATION&&g.fromBufferAttribute(r.TRANSLATION,x),r.ROTATION&&b.fromBufferAttribute(r.ROTATION,x),r.SCALE&&w.fromBufferAttribute(r.SCALE,x),v.setMatrixAt(x,f.compose(g,b,w));for(const x in r)if(x==="_COLOR_0"){const S=r[x];v.instanceColor=new Qt(S.array,S.itemSize,S.normalized)}else x!=="TRANSLATION"&&x!=="ROTATION"&&x!=="SCALE"&&m.geometry.setAttribute(x,r[x]);Pe.prototype.copy.call(v,m),this.parser.assignFinalMaterial(v),u.push(v)}return c.isGroup?(c.clear(),c.add(...u),c):u[0]}))}}const Ut="glTF",Se=12,yt={JSON:1313821514,BIN:5130562};class Js{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Se),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Ut)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-Se,o=new DataView(e,Se);let n=0;for(;n<i;){const a=o.getUint32(n,!0);n+=4;const r=o.getUint32(n,!0);if(n+=4,r===yt.JSON){const l=new Uint8Array(e,Se+n,a);this.content=s.decode(l)}else if(r===yt.BIN){const l=Se+n;this.body=e.slice(l,l+a)}n+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class ei{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,a={},r={},l={};for(const c in n){const d=ot[c]||c.toLowerCase();a[d]=n[c]}for(const c in e.attributes){const d=ot[c]||c.toLowerCase();if(n[c]!==void 0){const h=s.accessors[e.attributes[c]],u=be[h.componentType];l[d]=u.name,r[d]=h.normalized===!0}}return t.getDependency("bufferView",o).then(function(c){return new Promise(function(d,h){i.decodeDracoFile(c,function(u){for(const m in u.attributes){const f=u.attributes[m],g=r[m];g!==void 0&&(f.normalized=g)}d(u)},a,l,ae,h)})})}}class ti{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class si{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class Ht extends ps{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,o=e*i*3+i;for(let n=0;n!==i;n++)t[n]=s[o+n];return t}interpolate_(e,t,s,i){const o=this.resultBuffer,n=this.sampleValues,a=this.valueSize,r=a*2,l=a*3,c=i-t,d=(s-t)/c,h=d*d,u=h*d,m=e*l,f=m-l,g=-2*u+3*h,b=u-h,w=1-g,v=b-h+d;for(let x=0;x!==a;x++){const S=n[f+x+a],M=n[f+x+r]*c,A=n[m+x+a],P=n[m+x]*c;o[x]=w*S+v*M+g*A+b*P}return o}}const ii=new fe;class oi extends Ht{interpolate_(e,t,s,i){const o=super.interpolate_(e,t,s,i);return ii.fromArray(o).normalize().toArray(o),o}}const Q={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},be={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},wt={9728:Pt,9729:Xe,9984:ts,9985:es,9986:Jt,9987:At},bt={33071:is,33648:ss,10497:Ze},qe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ot={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ce={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ni={CUBICSPLINE:void 0,LINEAR:Bt,STEP:hs},Ke={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function ai(p){return p.DefaultMaterial===void 0&&(p.DefaultMaterial=new R({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Lt})),p.DefaultMaterial}function ue(p,e,t){for(const s in t.extensions)p[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function oe(p,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(p.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function ri(p,e,t){let s=!1,i=!1,o=!1;for(let l=0,c=e.length;l<c;l++){const d=e[l];if(d.POSITION!==void 0&&(s=!0),d.NORMAL!==void 0&&(i=!0),d.COLOR_0!==void 0&&(o=!0),s&&i&&o)break}if(!s&&!i&&!o)return Promise.resolve(p);const n=[],a=[],r=[];for(let l=0,c=e.length;l<c;l++){const d=e[l];if(s){const h=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):p.attributes.position;n.push(h)}if(i){const h=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):p.attributes.normal;a.push(h)}if(o){const h=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):p.attributes.color;r.push(h)}}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(r)]).then(function(l){const c=l[0],d=l[1],h=l[2];return s&&(p.morphAttributes.position=c),i&&(p.morphAttributes.normal=d),o&&(p.morphAttributes.color=h),p.morphTargetsRelative=!0,p})}function li(p,e){if(p.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)p.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(p.morphTargetInfluences.length===t.length){p.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)p.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ci(p){let e;const t=p.extensions&&p.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ye(t.attributes):e=p.indices+":"+Ye(p.attributes)+":"+p.mode,p.targets!==void 0)for(let s=0,i=p.targets.length;s<i;s++)e+=":"+Ye(p.targets[s]);return e}function Ye(p){let e="";const t=Object.keys(p).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+p[t[s]]+";";return e}function nt(p){switch(p){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function di(p){return p.search(/\.jpe?g($|\?)/i)>0||p.search(/^data\:image\/jpeg/)===0?"image/jpeg":p.search(/\.webp($|\?)/i)>0||p.search(/^data\:image\/webp/)===0?"image/webp":p.search(/\.ktx2($|\?)/i)>0||p.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const hi=new V;class ui{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Ls,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,o=!1,n=-1;if(typeof navigator<"u"){const a=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(a)===!0;const r=a.match(/Version\/(\d+)/);i=s&&r?parseInt(r[1],10):-1,o=a.indexOf("Firefox")>-1,n=o?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&i<17||o&&n<98?this.textureLoader=new Ie(this.options.manager):this.textureLoader=new Xt(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Tt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,o=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(n){return n._markDefs&&n._markDefs()}),Promise.all(this._invokeAll(function(n){return n.beforeRoot&&n.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(n){const a={scene:n[0][i.scene||0],scenes:n[0],animations:n[1],cameras:n[2],asset:i.asset,parser:s,userData:{}};return ue(o,a,i),oe(a,i),Promise.all(s._invokeAll(function(r){return r.afterRoot&&r.afterRoot(a)})).then(function(){for(const r of a.scenes)r.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,o=t.length;i<o;i++){const n=t[i].joints;for(let a=0,r=n.length;a<r;a++)e[n[a]].isBone=!0}for(let i=0,o=e.length;i<o;i++){const n=e[i];n.mesh!==void 0&&(this._addNodeRef(this.meshCache,n.mesh),n.skin!==void 0&&(s[n.mesh].isSkinnedMesh=!0)),n.camera!==void 0&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),o=(n,a)=>{const r=this.associations.get(n);r!=null&&this.associations.set(a,r);for(const[l,c]of n.children.entries())o(c,a.children[l])};return o(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const o=e(t[i]);o&&s.push(o)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(o){return o.loadNode&&o.loadNode(t)});break;case"mesh":i=this._invokeOne(function(o){return o.loadMesh&&o.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(o){return o.loadBufferView&&o.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(o){return o.loadMaterial&&o.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(o){return o.loadTexture&&o.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(o){return o.loadAnimation&&o.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(o){return o!=this&&o.getDependency&&o.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(o,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(o,n){s.load(Ce.resolveURL(t.uri,i.path),o,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,o=t.byteOffset||0;return s.slice(o,o+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const n=qe[i.type],a=be[i.componentType],r=i.normalized===!0,l=new a(i.count*n);return Promise.resolve(new _(l,n,r))}const o=[];return i.bufferView!==void 0?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),i.sparse!==void 0&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(n){const a=n[0],r=qe[i.type],l=be[i.componentType],c=l.BYTES_PER_ELEMENT,d=c*r,h=i.byteOffset||0,u=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,m=i.normalized===!0;let f,g;if(u&&u!==d){const b=Math.floor(h/u),w="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+b+":"+i.count;let v=t.cache.get(w);v||(f=new l(a,b*u,i.count*u/c),v=new Zt(f,u/c),t.cache.add(w,v)),g=new us(v,r,h%u/c,m)}else a===null?f=new l(i.count*r):f=new l(a,h,i.count*r),g=new _(f,r,m);if(i.sparse!==void 0){const b=qe.SCALAR,w=be[i.sparse.indices.componentType],v=i.sparse.indices.byteOffset||0,x=i.sparse.values.byteOffset||0,S=new w(n[1],v,i.sparse.count*b),M=new l(n[2],x,i.sparse.count*r);a!==null&&(g=new _(g.array.slice(),g.itemSize,g.normalized)),g.normalized=!1;for(let A=0,P=S.length;A<P;A++){const D=S[A];if(g.setX(D,M[A*r]),r>=2&&g.setY(D,M[A*r+1]),r>=3&&g.setZ(D,M[A*r+2]),r>=4&&g.setW(D,M[A*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}g.normalized=m}return g})}loadTexture(e){const t=this.json,s=this.options,o=t.textures[e].source,n=t.images[o];let a=this.textureLoader;if(n.uri){const r=s.manager.getHandler(n.uri);r!==null&&(a=r)}return this.loadTextureImage(e,o,a)}loadTextureImage(e,t,s){const i=this,o=this.json,n=o.textures[e],a=o.images[t],r=(a.uri||a.bufferView)+":"+n.sampler;if(this.textureCache[r])return this.textureCache[r];const l=this.loadImageSource(t,s).then(function(c){c.flipY=!1,c.name=n.name||a.name||"",c.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(c.name=a.uri);const h=(o.samplers||{})[n.sampler]||{};return c.magFilter=wt[h.magFilter]||Xe,c.minFilter=wt[h.minFilter]||At,c.wrapS=bt[h.wrapS]||Ze,c.wrapT=bt[h.wrapT]||Ze,c.generateMipmaps=!c.isCompressedTexture&&c.minFilter!==Pt&&c.minFilter!==Xe,i.associations.set(c,{textures:e}),c}).catch(function(){return null});return this.textureCache[r]=l,l}loadImageSource(e,t){const s=this,i=this.json,o=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const n=i.images[e],a=self.URL||self.webkitURL;let r=n.uri||"",l=!1;if(n.bufferView!==void 0)r=s.getDependency("bufferView",n.bufferView).then(function(d){l=!0;const h=new Blob([d],{type:n.mimeType});return r=a.createObjectURL(h),r});else if(n.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(r).then(function(d){return new Promise(function(h,u){let m=h;t.isImageBitmapLoader===!0&&(m=function(f){const g=new Je(f);g.needsUpdate=!0,h(g)}),t.load(Ce.resolveURL(d,o.path),m,void 0,u)})}).then(function(d){return l===!0&&a.revokeObjectURL(r),oe(d,n),d.userData.mimeType=n.mimeType||di(n.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",r),d});return this.sourceCache[e]=c,c}assignTexture(e,t,s,i){const o=this;return this.getDependency("texture",s.index).then(function(n){if(!n)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(n=n.clone(),n.channel=s.texCoord),o.extensions[I.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const r=o.associations.get(n);n=o.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(n,a),o.associations.set(n,r)}}return i!==void 0&&(n.colorSpace=i),e[t]=n,n})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,o=t.attributes.color!==void 0,n=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+s.uuid;let r=this.cache.get(a);r||(r=new te,je.prototype.copy.call(r,s),r.color.copy(s.color),r.map=s.map,r.sizeAttenuation=!1,this.cache.add(a,r)),s=r}else if(e.isLine){const a="LineBasicMaterial:"+s.uuid;let r=this.cache.get(a);r||(r=new Me,je.prototype.copy.call(r,s),r.color.copy(s.color),r.map=s.map,this.cache.add(a,r)),s=r}if(i||o||n){let a="ClonedMaterial:"+s.uuid+":";i&&(a+="derivative-tangents:"),o&&(a+="vertex-colors:"),n&&(a+="flat-shading:");let r=this.cache.get(a);r||(r=s.clone(),o&&(r.vertexColors=!0),n&&(r.flatShading=!0),i&&(r.normalScale&&(r.normalScale.y*=-1),r.clearcoatNormalScale&&(r.clearcoatNormalScale.y*=-1)),this.cache.add(a,r),this.associations.set(r,this.associations.get(s))),s=r}e.material=s}getMaterialType(){return R}loadMaterial(e){const t=this,s=this.json,i=this.extensions,o=s.materials[e];let n;const a={},r=o.extensions||{},l=[];if(r[I.KHR_MATERIALS_UNLIT]){const d=i[I.KHR_MATERIALS_UNLIT];n=d.getMaterialType(),l.push(d.extendParams(a,o,t))}else{const d=o.pbrMetallicRoughness||{};if(a.color=new E(1,1,1),a.opacity=1,Array.isArray(d.baseColorFactor)){const h=d.baseColorFactor;a.color.setRGB(h[0],h[1],h[2],ae),a.opacity=h[3]}d.baseColorTexture!==void 0&&l.push(t.assignTexture(a,"map",d.baseColorTexture,z)),a.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,a.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(a,"metalnessMap",d.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",d.metallicRoughnessTexture))),n=this._invokeOne(function(h){return h.getMaterialType&&h.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(h){return h.extendMaterialParams&&h.extendMaterialParams(e,a)})))}o.doubleSided===!0&&(a.side=K);const c=o.alphaMode||Ke.OPAQUE;if(c===Ke.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,c===Ke.MASK&&(a.alphaTest=o.alphaCutoff!==void 0?o.alphaCutoff:.5)),o.normalTexture!==void 0&&n!==F&&(l.push(t.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new H(1,1),o.normalTexture.scale!==void 0)){const d=o.normalTexture.scale;a.normalScale.set(d,d)}if(o.occlusionTexture!==void 0&&n!==F&&(l.push(t.assignTexture(a,"aoMap",o.occlusionTexture)),o.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=o.occlusionTexture.strength)),o.emissiveFactor!==void 0&&n!==F){const d=o.emissiveFactor;a.emissive=new E().setRGB(d[0],d[1],d[2],ae)}return o.emissiveTexture!==void 0&&n!==F&&l.push(t.assignTexture(a,"emissiveMap",o.emissiveTexture,z)),Promise.all(l).then(function(){const d=new n(a);return o.name&&(d.name=o.name),oe(d,o),t.associations.set(d,{materials:e}),o.extensions&&ue(i,d,o),d})}createUniqueName(e){const t=os.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function o(a){return s[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(r){return xt(r,a,t)})}const n=[];for(let a=0,r=e.length;a<r;a++){const l=e[a],c=ci(l),d=i[c];if(d)n.push(d.promise);else{let h;l.extensions&&l.extensions[I.KHR_DRACO_MESH_COMPRESSION]?h=o(l):h=xt(new j,l,t),i[c]={primitive:l,promise:h},n.push(h)}}return Promise.all(n)}loadMesh(e){const t=this,s=this.json,i=this.extensions,o=s.meshes[e],n=o.primitives,a=[];for(let r=0,l=n.length;r<l;r++){const c=n[r].material===void 0?ai(this.cache):this.getDependency("material",n[r].material);a.push(c)}return a.push(t.loadGeometries(n)),Promise.all(a).then(function(r){const l=r.slice(0,r.length-1),c=r[r.length-1],d=[];for(let u=0,m=c.length;u<m;u++){const f=c[u],g=n[u];let b;const w=l[u];if(g.mode===Q.TRIANGLES||g.mode===Q.TRIANGLE_STRIP||g.mode===Q.TRIANGLE_FAN||g.mode===void 0)b=o.isSkinnedMesh===!0?new ns(f,w):new C(f,w),b.isSkinnedMesh===!0&&b.normalizeSkinWeights(),g.mode===Q.TRIANGLE_STRIP?b.geometry=ft(b.geometry,Mt):g.mode===Q.TRIANGLE_FAN&&(b.geometry=ft(b.geometry,Qe));else if(g.mode===Q.LINES)b=new It(f,w);else if(g.mode===Q.LINE_STRIP)b=new Te(f,w);else if(g.mode===Q.LINE_LOOP)b=new as(f,w);else if(g.mode===Q.POINTS)b=new Z(f,w);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(b.geometry.morphAttributes).length>0&&li(b,o),b.name=t.createUniqueName(o.name||"mesh_"+e),oe(b,o),g.extensions&&ue(i,b,g),t.assignFinalMaterial(b),d.push(b)}for(let u=0,m=d.length;u<m;u++)t.associations.set(d[u],{meshes:e,primitives:u});if(d.length===1)return o.extensions&&ue(i,d[0],o),d[0];const h=new O;o.extensions&&ue(i,h,o),t.associations.set(h,{meshes:e});for(let u=0,m=d.length;u<m;u++)h.add(d[u]);return h})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new Rt(rs.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new Dt(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),oe(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,o=t.joints.length;i<o;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const o=i.pop(),n=i,a=[],r=[];for(let l=0,c=n.length;l<c;l++){const d=n[l];if(d){a.push(d);const h=new V;o!==null&&h.fromArray(o.array,l*16),r.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new ls(a,r)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,n=[],a=[],r=[],l=[],c=[];for(let d=0,h=i.channels.length;d<h;d++){const u=i.channels[d],m=i.samplers[u.sampler],f=u.target,g=f.node,b=i.parameters!==void 0?i.parameters[m.input]:m.input,w=i.parameters!==void 0?i.parameters[m.output]:m.output;f.node!==void 0&&(n.push(this.getDependency("node",g)),a.push(this.getDependency("accessor",b)),r.push(this.getDependency("accessor",w)),l.push(m),c.push(f))}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(r),Promise.all(l),Promise.all(c)]).then(function(d){const h=d[0],u=d[1],m=d[2],f=d[3],g=d[4],b=[];for(let w=0,v=h.length;w<v;w++){const x=h[w],S=u[w],M=m[w],A=f[w],P=g[w];if(x===void 0)continue;x.updateMatrix&&x.updateMatrix();const D=s._createAnimationTracks(x,S,M,A,P);if(D)for(let L=0;L<D.length;L++)b.push(D[L])}return new cs(o,void 0,b)})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(o){const n=s._getNodeRef(s.meshCache,i.mesh,o);return i.weights!==void 0&&n.traverse(function(a){if(a.isMesh)for(let r=0,l=i.weights.length;r<l;r++)a.morphTargetInfluences[r]=i.weights[r]}),n})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],o=s._loadNodeShallow(e),n=[],a=i.children||[];for(let l=0,c=a.length;l<c;l++)n.push(s.getDependency("node",a[l]));const r=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([o,Promise.all(n),r]).then(function(l){const c=l[0],d=l[1],h=l[2];h!==null&&c.traverse(function(u){u.isSkinnedMesh&&u.bind(h,hi)});for(let u=0,m=d.length;u<m;u++)c.add(d[u]);return c})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const o=t.nodes[e],n=o.name?i.createUniqueName(o.name):"",a=[],r=i._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return r&&a.push(r),o.camera!==void 0&&a.push(i.getDependency("camera",o.camera).then(function(l){return i._getNodeRef(i.cameraCache,o.camera,l)})),i._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){a.push(l)}),this.nodeCache[e]=Promise.all(a).then(function(l){let c;if(o.isBone===!0?c=new ds:l.length>1?c=new O:l.length===1?c=l[0]:c=new Pe,c!==l[0])for(let d=0,h=l.length;d<h;d++)c.add(l[d]);if(o.name&&(c.userData.name=o.name,c.name=n),oe(c,o),o.extensions&&ue(s,c,o),o.matrix!==void 0){const d=new V;d.fromArray(o.matrix),c.applyMatrix4(d)}else o.translation!==void 0&&c.position.fromArray(o.translation),o.rotation!==void 0&&c.quaternion.fromArray(o.rotation),o.scale!==void 0&&c.scale.fromArray(o.scale);return i.associations.has(c)||i.associations.set(c,{}),i.associations.get(c).nodes=e,c}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,o=new O;s.name&&(o.name=i.createUniqueName(s.name)),oe(o,s),s.extensions&&ue(t,o,s);const n=s.nodes||[],a=[];for(let r=0,l=n.length;r<l;r++)a.push(i.getDependency("node",n[r]));return Promise.all(a).then(function(r){for(let c=0,d=r.length;c<d;c++)o.add(r[c]);const l=c=>{const d=new Map;for(const[h,u]of i.associations)(h instanceof je||h instanceof Je)&&d.set(h,u);return c.traverse(h=>{const u=i.associations.get(h);u!=null&&d.set(h,u)}),d};return i.associations=l(o),o})}_createAnimationTracks(e,t,s,i,o){const n=[],a=e.name?e.name:e.uuid,r=[];ce[o.path]===ce.weights?e.traverse(function(h){h.morphTargetInfluences&&r.push(h.name?h.name:h.uuid)}):r.push(a);let l;switch(ce[o.path]){case ce.weights:l=ht;break;case ce.rotation:l=ut;break;case ce.translation:case ce.scale:l=dt;break;default:switch(s.itemSize){case 1:l=ht;break;case 2:case 3:default:l=dt;break}break}const c=i.interpolation!==void 0?ni[i.interpolation]:Bt,d=this._getArrayFromAccessor(s);for(let h=0,u=r.length;h<u;h++){const m=new l(r[h]+"."+ce[o.path],t.array,d,c);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),n.push(m)}return n}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=nt(t.constructor),i=new Float32Array(t.length);for(let o=0,n=t.length;o<n;o++)i[o]=t[o]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof ut?oi:Ht;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function pi(p,e,t){const s=e.attributes,i=new ze;if(s.POSITION!==void 0){const a=t.json.accessors[s.POSITION],r=a.min,l=a.max;if(r!==void 0&&l!==void 0){if(i.set(new y(r[0],r[1],r[2]),new y(l[0],l[1],l[2])),a.normalized){const c=nt(be[a.componentType]);i.min.multiplyScalar(c),i.max.multiplyScalar(c)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const o=e.targets;if(o!==void 0){const a=new y,r=new y;for(let l=0,c=o.length;l<c;l++){const d=o[l];if(d.POSITION!==void 0){const h=t.json.accessors[d.POSITION],u=h.min,m=h.max;if(u!==void 0&&m!==void 0){if(r.setX(Math.max(Math.abs(u[0]),Math.abs(m[0]))),r.setY(Math.max(Math.abs(u[1]),Math.abs(m[1]))),r.setZ(Math.max(Math.abs(u[2]),Math.abs(m[2]))),h.normalized){const f=nt(be[h.componentType]);r.multiplyScalar(f)}a.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(a)}p.boundingBox=i;const n=new ms;i.getCenter(n.center),n.radius=i.min.distanceTo(i.max)/2,p.boundingSphere=n}function xt(p,e,t){const s=e.attributes,i=[];function o(n,a){return t.getDependency("accessor",n).then(function(r){p.setAttribute(a,r)})}for(const n in s){const a=ot[n]||n.toLowerCase();a in p.attributes||i.push(o(s[n],a))}if(e.indices!==void 0&&!p.index){const n=t.getDependency("accessor",e.indices).then(function(a){p.setIndex(a)});i.push(n)}return pt.workingColorSpace!==ae&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${pt.workingColorSpace}" not supported.`),oe(p,e),pi(p,e,t),Promise.all(i).then(function(){return e.targets!==void 0?ri(p,e.targets,t):p})}const Oe={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class Re{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const mi=new Dt(-1,1,1,-1,0,1);class gi extends j{constructor(){super(),this.setAttribute("position",new et([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new et([0,2,0,0,2,0],2))}}const fi=new gi;class Ot{constructor(e){this._mesh=new C(fi,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,mi)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class pe extends Re{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof X?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=tt.clone(e.uniforms),this.material=new X({name:e.name!==void 0?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new Ot(this.material)}render(e,t,s){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=s.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class vt extends Re{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,s){const i=e.getContext(),o=e.state;o.buffers.color.setMask(!1),o.buffers.depth.setMask(!1),o.buffers.color.setLocked(!0),o.buffers.depth.setLocked(!0);let n,a;this.inverse?(n=0,a=1):(n=1,a=0),o.buffers.stencil.setTest(!0),o.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),o.buffers.stencil.setFunc(i.ALWAYS,n,4294967295),o.buffers.stencil.setClear(a),o.buffers.stencil.setLocked(!0),e.setRenderTarget(s),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),o.buffers.color.setLocked(!1),o.buffers.depth.setLocked(!1),o.buffers.color.setMask(!0),o.buffers.depth.setMask(!0),o.buffers.stencil.setLocked(!1),o.buffers.stencil.setFunc(i.EQUAL,1,4294967295),o.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),o.buffers.stencil.setLocked(!0)}}class yi extends Re{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class wi{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),t===void 0){const s=e.getSize(new H);this._width=s.width,this._height=s.height,t=new Ue(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:He}),t.texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new pe(Oe),this.copyPass.material.blending=gs,this.clock=new fs}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let s=!1;for(let i=0,o=this.passes.length;i<o;i++){const n=this.passes[i];if(n.enabled!==!1){if(n.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),n.render(this.renderer,this.writeBuffer,this.readBuffer,e,s),n.needsSwap){if(s){const a=this.renderer.getContext(),r=this.renderer.state.buffers.stencil;r.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),r.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}vt!==void 0&&(n instanceof vt?s=!0:n instanceof yi&&(s=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new H);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const s=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(s,i),this.renderTarget2.setSize(s,i);for(let o=0;o<this.passes.length;o++)this.passes[o].setSize(s,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class bi extends Re{constructor(e,t,s=null,i=null,o=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=s,this.clearColor=i,this.clearAlpha=o,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new E}render(e,t,s){const i=e.autoClear;e.autoClear=!1;let o,n;this.overrideMaterial!==null&&(n=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),this.clearAlpha!==null&&(o=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:s),this.clear===!0&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor!==null&&e.setClearColor(this._oldClearColor),this.clearAlpha!==null&&e.setClearAlpha(o),this.overrideMaterial!==null&&(this.scene.overrideMaterial=n),e.autoClear=i}}const xi={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new E(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			float v = luminance( texel.xyz );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class ve extends Re{constructor(e,t=1,s,i){super(),this.strength=t,this.radius=s,this.threshold=i,this.resolution=e!==void 0?new H(e.x,e.y):new H(256,256),this.clearColor=new E(0,0,0),this.needsSwap=!1,this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let o=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new Ue(o,n,{type:He}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let c=0;c<this.nMips;c++){const d=new Ue(o,n,{type:He});d.texture.name="UnrealBloomPass.h"+c,d.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(d);const h=new Ue(o,n,{type:He});h.texture.name="UnrealBloomPass.v"+c,h.texture.generateMipmaps=!1,this.renderTargetsVertical.push(h),o=Math.round(o/2),n=Math.round(n/2)}const a=xi;this.highPassUniforms=tt.clone(a.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new X({uniforms:this.highPassUniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader}),this.separableBlurMaterials=[];const r=[3,5,7,9,11];o=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let c=0;c<this.nMips;c++)this.separableBlurMaterials.push(this._getSeparableBlurMaterial(r[c])),this.separableBlurMaterials[c].uniforms.invSize.value=new H(1/o,1/n),o=Math.round(o/2),n=Math.round(n/2);this.compositeMaterial=this._getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;const l=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=l,this.bloomTintColors=[new y(1,1,1),new y(1,1,1),new y(1,1,1),new y(1,1,1),new y(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,this.copyUniforms=tt.clone(Oe.uniforms),this.blendMaterial=new X({uniforms:this.copyUniforms,vertexShader:Oe.vertexShader,fragmentShader:Oe.fragmentShader,blending:$,depthTest:!1,depthWrite:!1,transparent:!0}),this._oldClearColor=new E,this._oldClearAlpha=1,this._basic=new F,this._fsQuad=new Ot(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this._basic.dispose(),this._fsQuad.dispose()}setSize(e,t){let s=Math.round(e/2),i=Math.round(t/2);this.renderTargetBright.setSize(s,i);for(let o=0;o<this.nMips;o++)this.renderTargetsHorizontal[o].setSize(s,i),this.renderTargetsVertical[o].setSize(s,i),this.separableBlurMaterials[o].uniforms.invSize.value=new H(1/s,1/i),s=Math.round(s/2),i=Math.round(i/2)}render(e,t,s,i,o){e.getClearColor(this._oldClearColor),this._oldClearAlpha=e.getClearAlpha();const n=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),o&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this._fsQuad.material=this._basic,this._basic.map=s.texture,e.setRenderTarget(null),e.clear(),this._fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=s.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this._fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this._fsQuad.render(e);let a=this.renderTargetBright;for(let r=0;r<this.nMips;r++)this._fsQuad.material=this.separableBlurMaterials[r],this.separableBlurMaterials[r].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[r].uniforms.direction.value=ve.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[r]),e.clear(),this._fsQuad.render(e),this.separableBlurMaterials[r].uniforms.colorTexture.value=this.renderTargetsHorizontal[r].texture,this.separableBlurMaterials[r].uniforms.direction.value=ve.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[r]),e.clear(),this._fsQuad.render(e),a=this.renderTargetsVertical[r];this._fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this._fsQuad.render(e),this._fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,o&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(s),this._fsQuad.render(e)),e.setClearColor(this._oldClearColor,this._oldClearAlpha),e.autoClear=n}_getSeparableBlurMaterial(e){const t=[];for(let s=0;s<e;s++)t.push(.39894*Math.exp(-.5*s*s/(e*e))/e);return new X({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new H(.5,.5)},direction:{value:new H(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {
					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}_getCompositeMaterial(e){return new X({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}}ve.BlurDirectionX=new H(1,0);ve.BlurDirectionY=new H(0,1);const vi={name:"FXAAShader",uniforms:{tDiffuse:{value:null},resolution:{value:new H(1/1024,1/512)}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec2 resolution;
		varying vec2 vUv;

		#define EDGE_STEP_COUNT 6
		#define EDGE_GUESS 8.0
		#define EDGE_STEPS 1.0, 1.5, 2.0, 2.0, 2.0, 4.0
		const float edgeSteps[EDGE_STEP_COUNT] = float[EDGE_STEP_COUNT]( EDGE_STEPS );

		float _ContrastThreshold = 0.0312;
		float _RelativeThreshold = 0.063;
		float _SubpixelBlending = 1.0;

		vec4 Sample( sampler2D  tex2D, vec2 uv ) {

			return texture( tex2D, uv );

		}

		float SampleLuminance( sampler2D tex2D, vec2 uv ) {

			return dot( Sample( tex2D, uv ).rgb, vec3( 0.3, 0.59, 0.11 ) );

		}

		float SampleLuminance( sampler2D tex2D, vec2 texSize, vec2 uv, float uOffset, float vOffset ) {

			uv += texSize * vec2(uOffset, vOffset);
			return SampleLuminance(tex2D, uv);

		}

		struct LuminanceData {

			float m, n, e, s, w;
			float ne, nw, se, sw;
			float highest, lowest, contrast;

		};

		LuminanceData SampleLuminanceNeighborhood( sampler2D tex2D, vec2 texSize, vec2 uv ) {

			LuminanceData l;
			l.m = SampleLuminance( tex2D, uv );
			l.n = SampleLuminance( tex2D, texSize, uv,  0.0,  1.0 );
			l.e = SampleLuminance( tex2D, texSize, uv,  1.0,  0.0 );
			l.s = SampleLuminance( tex2D, texSize, uv,  0.0, -1.0 );
			l.w = SampleLuminance( tex2D, texSize, uv, -1.0,  0.0 );

			l.ne = SampleLuminance( tex2D, texSize, uv,  1.0,  1.0 );
			l.nw = SampleLuminance( tex2D, texSize, uv, -1.0,  1.0 );
			l.se = SampleLuminance( tex2D, texSize, uv,  1.0, -1.0 );
			l.sw = SampleLuminance( tex2D, texSize, uv, -1.0, -1.0 );

			l.highest = max( max( max( max( l.n, l.e ), l.s ), l.w ), l.m );
			l.lowest = min( min( min( min( l.n, l.e ), l.s ), l.w ), l.m );
			l.contrast = l.highest - l.lowest;
			return l;

		}

		bool ShouldSkipPixel( LuminanceData l ) {

			float threshold = max( _ContrastThreshold, _RelativeThreshold * l.highest );
			return l.contrast < threshold;

		}

		float DeterminePixelBlendFactor( LuminanceData l ) {

			float f = 2.0 * ( l.n + l.e + l.s + l.w );
			f += l.ne + l.nw + l.se + l.sw;
			f *= 1.0 / 12.0;
			f = abs( f - l.m );
			f = clamp( f / l.contrast, 0.0, 1.0 );

			float blendFactor = smoothstep( 0.0, 1.0, f );
			return blendFactor * blendFactor * _SubpixelBlending;

		}

		struct EdgeData {

			bool isHorizontal;
			float pixelStep;
			float oppositeLuminance, gradient;

		};

		EdgeData DetermineEdge( vec2 texSize, LuminanceData l ) {

			EdgeData e;
			float horizontal =
				abs( l.n + l.s - 2.0 * l.m ) * 2.0 +
				abs( l.ne + l.se - 2.0 * l.e ) +
				abs( l.nw + l.sw - 2.0 * l.w );
			float vertical =
				abs( l.e + l.w - 2.0 * l.m ) * 2.0 +
				abs( l.ne + l.nw - 2.0 * l.n ) +
				abs( l.se + l.sw - 2.0 * l.s );
			e.isHorizontal = horizontal >= vertical;

			float pLuminance = e.isHorizontal ? l.n : l.e;
			float nLuminance = e.isHorizontal ? l.s : l.w;
			float pGradient = abs( pLuminance - l.m );
			float nGradient = abs( nLuminance - l.m );

			e.pixelStep = e.isHorizontal ? texSize.y : texSize.x;

			if (pGradient < nGradient) {

				e.pixelStep = -e.pixelStep;
				e.oppositeLuminance = nLuminance;
				e.gradient = nGradient;

			} else {

				e.oppositeLuminance = pLuminance;
				e.gradient = pGradient;

			}

			return e;

		}

		float DetermineEdgeBlendFactor( sampler2D  tex2D, vec2 texSize, LuminanceData l, EdgeData e, vec2 uv ) {

			vec2 uvEdge = uv;
			vec2 edgeStep;
			if (e.isHorizontal) {

				uvEdge.y += e.pixelStep * 0.5;
				edgeStep = vec2( texSize.x, 0.0 );

			} else {

				uvEdge.x += e.pixelStep * 0.5;
				edgeStep = vec2( 0.0, texSize.y );

			}

			float edgeLuminance = ( l.m + e.oppositeLuminance ) * 0.5;
			float gradientThreshold = e.gradient * 0.25;

			vec2 puv = uvEdge + edgeStep * edgeSteps[0];
			float pLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;
			bool pAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;

			for ( int i = 1; i < EDGE_STEP_COUNT && !pAtEnd; i++ ) {

				puv += edgeStep * edgeSteps[i];
				pLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;
				pAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;

			}

			if ( !pAtEnd ) {

				puv += edgeStep * EDGE_GUESS;

			}

			vec2 nuv = uvEdge - edgeStep * edgeSteps[0];
			float nLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;
			bool nAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;

			for ( int i = 1; i < EDGE_STEP_COUNT && !nAtEnd; i++ ) {

				nuv -= edgeStep * edgeSteps[i];
				nLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;
				nAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;

			}

			if ( !nAtEnd ) {

				nuv -= edgeStep * EDGE_GUESS;

			}

			float pDistance, nDistance;
			if ( e.isHorizontal ) {

				pDistance = puv.x - uv.x;
				nDistance = uv.x - nuv.x;

			} else {

				pDistance = puv.y - uv.y;
				nDistance = uv.y - nuv.y;

			}

			float shortestDistance;
			bool deltaSign;
			if ( pDistance <= nDistance ) {

				shortestDistance = pDistance;
				deltaSign = pLuminanceDelta >= 0.0;

			} else {

				shortestDistance = nDistance;
				deltaSign = nLuminanceDelta >= 0.0;

			}

			if ( deltaSign == ( l.m - edgeLuminance >= 0.0 ) ) {

				return 0.0;

			}

			return 0.5 - shortestDistance / ( pDistance + nDistance );

		}

		vec4 ApplyFXAA( sampler2D  tex2D, vec2 texSize, vec2 uv ) {

			LuminanceData luminance = SampleLuminanceNeighborhood( tex2D, texSize, uv );
			if ( ShouldSkipPixel( luminance ) ) {

				return Sample( tex2D, uv );

			}

			float pixelBlend = DeterminePixelBlendFactor( luminance );
			EdgeData edge = DetermineEdge( texSize, luminance );
			float edgeBlend = DetermineEdgeBlendFactor( tex2D, texSize, luminance, edge, uv );
			float finalBlend = max( pixelBlend, edgeBlend );

			if (edge.isHorizontal) {

				uv.y += edge.pixelStep * finalBlend;

			} else {

				uv.x += edge.pixelStep * finalBlend;

			}

			return Sample( tex2D, uv );

		}

		void main() {

			gl_FragColor = ApplyFXAA( tDiffuse, resolution.xy, vUv );

		}`},Si={name:"ColorCorrectionShader",uniforms:{tDiffuse:{value:null},powRGB:{value:new y(2,2,2)},mulRGB:{value:new y(1,1,1)},addRGB:{value:new y(0,0,0)}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 powRGB;
		uniform vec3 mulRGB;
		uniform vec3 addRGB;

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );
			gl_FragColor.rgb = mulRGB * pow( ( gl_FragColor.rgb + addRGB ), powRGB );

		}`},Ci={name:"FilmShader",uniforms:{tDiffuse:{value:null},time:{value:0},intensity:{value:.5},grayscale:{value:!1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		#include <common>

		uniform float intensity;
		uniform bool grayscale;
		uniform float time;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 base = texture2D( tDiffuse, vUv );

			float noise = rand( fract( vUv + time ) );

			vec3 color = base.rgb + base.rgb * clamp( 0.1 + noise, 0.0, 1.0 );

			color = mix( base.rgb, color, intensity );

			if ( grayscale ) {

				color = vec3( luminance( color ) ); // assuming linear-srgb

			}

			gl_FragColor = vec4( color, base.a );

		}`},Ei={name:"VignetteShader",uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float offset;
		uniform float darkness;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			// Eskil's vignette

			vec4 texel = texture2D( tDiffuse, vUv );
			vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );
			gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );

		}`};class St{static isWebGL2Available(){try{const e=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&e.getContext("webgl2"))}catch{return!1}}static isColorSpaceAvailable(e){try{const t=document.createElement("canvas"),s=window.WebGL2RenderingContext&&t.getContext("webgl2");return s.drawingBufferColorSpace=e,s.drawingBufferColorSpace===e}catch{return!1}}static getWebGL2ErrorMessage(){return this._getErrorMessage(2)}static _getErrorMessage(e){const t={1:"WebGL",2:"WebGL 2"},s={1:window.WebGLRenderingContext,2:window.WebGL2RenderingContext};let i='Your $0 does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">$1</a>';const o=document.createElement("div");return o.id="webglmessage",o.style.fontFamily="monospace",o.style.fontSize="13px",o.style.fontWeight="normal",o.style.textAlign="center",o.style.background="#fff",o.style.color="#000",o.style.padding="1.5em",o.style.width="400px",o.style.margin="5em auto 0",s[e]?i=i.replace("$0","graphics card"):i=i.replace("$0","browser"),i=i.replace("$1",t[e]),o.innerHTML=i,o}static isWebGLAvailable(){console.warn("isWebGLAvailable() has been deprecated and will be removed in r178. Use isWebGL2Available() instead.");try{const e=document.createElement("canvas");return!!(window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl")))}catch{return!1}}static getWebGLErrorMessage(){return console.warn("getWebGLErrorMessage() has been deprecated and will be removed in r178. Use getWebGL2ErrorMessage() instead."),this._getErrorMessage(1)}}class yo{constructor(){if(console.log("Initializing enhanced renderer..."),St.isWebGL2Available())console.log("WebGL 2 is available.");else{const e=St.getWebGL2ErrorMessage();throw document.body.appendChild(e),console.error("WebGL 2 is required but not available."),new Error("WebGL 2 not available")}this.scene=new Ft,this.camera=new Rt(50,window.innerWidth/window.innerHeight,.1,4e5),this.renderer=new ys({antialias:!0,powerPreference:"high-performance",logarithmicDepthBuffer:!0,stencil:!0}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=_e,this.renderer.useLegacyLights=!1,this.renderer.toneMapping=ws,this.renderer.toneMappingExposure=1,this.instancedMeshes=new Map,this.setupRenderer(),this.setupPostProcessing(),this.setupLighting(),this.setupResizeHandler(),console.log("Enhanced renderer initialized successfully")}setupRenderer(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(0),document.body.appendChild(this.renderer.domElement),this.renderer.outputColorSpace=z,this.camera.position.z=10,this.camera.far=4e5,this.camera.updateProjectionMatrix(),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=_e,this.renderer.shadowMap.autoUpdate=!0}setupPostProcessing(){try{this.composer=new wi(this.renderer);const e=new bi(this.scene,this.camera);this.composer.addPass(e),this.setupGodRayEffects();try{this.bloomPass=new ve(new H(window.innerWidth,window.innerHeight),.2,.2,.95),this.composer.addPass(this.bloomPass)}catch(t){console.warn("Error setting up UnrealBloomPass:",t)}try{const t=new pe(vi);if(t.material&&t.material.uniforms&&t.material.uniforms.resolution){const s=this.renderer.getPixelRatio();t.material.uniforms.resolution.value.x=1/(window.innerWidth*s),t.material.uniforms.resolution.value.y=1/(window.innerHeight*s),this.composer.addPass(t)}else console.warn("FXAAShader uniforms not as expected, skipping pass")}catch(t){console.warn("Error setting up FXAAShader:",t)}try{this.colorCorrectionPass=new pe(Si),this.colorCorrectionPass.uniforms&&this.colorCorrectionPass.uniforms.powRGB&&this.colorCorrectionPass.uniforms.mulRGB?(this.colorCorrectionPass.uniforms.powRGB.value=new y(1.1,1.1,1.2),this.colorCorrectionPass.uniforms.mulRGB.value=new y(1.2,1.1,1),this.composer.addPass(this.colorCorrectionPass)):console.warn("ColorCorrectionShader uniforms not as expected, skipping pass")}catch(t){console.warn("Error setting up ColorCorrectionShader:",t)}try{this.filmPass=new pe(Ci),this.filmPass.uniforms&&this.filmPass.uniforms.nIntensity&&this.filmPass.uniforms.sIntensity&&this.filmPass.uniforms.grayscale?(this.filmPass.uniforms.nIntensity.value=.15,this.filmPass.uniforms.sIntensity.value=.05,this.filmPass.uniforms.grayscale.value=0,this.composer.addPass(this.filmPass)):console.warn("FilmShader uniforms not as expected, skipping pass")}catch(t){console.warn("Error setting up FilmShader:",t)}try{this.vignettePass=new pe(Ei),this.vignettePass.uniforms&&this.vignettePass.uniforms.offset&&this.vignettePass.uniforms.darkness?(this.vignettePass.uniforms.offset.value=.95,this.vignettePass.uniforms.darkness.value=1.6,this.composer.addPass(this.vignettePass)):console.warn("VignetteShader uniforms not as expected, skipping pass")}catch(t){console.warn("Error setting up VignetteShader:",t)}console.log("Post-processing setup complete")}catch(e){console.error("Error setting up post-processing:",e),console.log("Continuing with basic rendering without post-processing"),this.useBasicRendering=!0}}setupGodRayEffects(){try{this.volumetricLightEnabled=!0,this.useClaudeRays=!1,this.claudeRayPass=this.createClaudeRayShader(),this.claudeRayPass.enabled=this.volumetricLightEnabled&&this.useClaudeRays,this.composer.addPass(this.claudeRayPass),console.log("Claude Rays effect created (disabled by default)"),this.godRayPass=this.createVolumetricLightShader(),this.godRayPass.enabled=this.volumetricLightEnabled&&!this.useClaudeRays,this.composer.addPass(this.godRayPass),console.log("New volumetric light ray effect added to post-processing chain")}catch(e){console.warn("Error setting up volumetric light shaders:",e)}}setupLighting(){const e=new bs(4210768,1);this.scene.add(e),this.ambientLight=e;const t=new Ge(16777184,2);t.position.set(1,.5,1).normalize(),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=500,t.shadow.bias=-5e-4,this.scene.add(t);const s=new Ge(11193599,.3);s.position.set(-1,-.3,-1).normalize(),this.scene.add(s);const i=new xs(6316176,1052704,.4);this.scene.add(i);const o=new xe(16777215,1.2,1200,2);o.position.set(0,500,0),this.scene.add(o)}setupResizeHandler(){window.addEventListener("resize",()=>{this.handleResize()})}getScene(){return this.scene}getCamera(){return this.camera}handleResize(){if(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.composer){this.composer.setSize(window.innerWidth,window.innerHeight);try{const e=this.renderer.getPixelRatio(),t=this.composer.passes.find(s=>s.material&&s.material.uniforms&&s.material.uniforms.resolution&&s.material.uniforms.resolution.value);t&&(t.material.uniforms.resolution.value.x=1/(window.innerWidth*e),t.material.uniforms.resolution.value.y=1/(window.innerHeight*e))}catch(e){console.warn("Error updating FXAA resolution:",e)}}}add(e){this.scene.add(e)}adjustBloom(e,t,s){this.bloomPass&&(this.bloomPass.strength=e!==void 0?e:this.bloomPass.strength,this.bloomPass.radius=t!==void 0?t:this.bloomPass.radius,this.bloomPass.threshold=s!==void 0?s:this.bloomPass.threshold)}update(e){if(this.filmPass&&this.filmPass.uniforms&&this.filmPass.uniforms.time&&this.filmPass.uniforms.time.value!==void 0)try{this.filmPass.uniforms.time.value+=e}catch(t){console.warn("Error updating film pass time:",t)}this.volumetricLightEnabled&&(this.useClaudeRays?this.updateClaudeRayPosition():this.updateVolumetricLightPosition()),this.updateInstancedMeshes()}updateClaudeRayPosition(){try{if(!this.claudeRayPass||!this.claudeRayPass.uniforms||!this.claudeRayPass.uniforms.lightPosition||!this.camera||!this.scene)return;let e=this.findSunObject();if(e){const t=new y;e.getWorldPosition(t);const s=t.clone();s.project(this.camera);const i=(s.x+1)/2,o=(s.y+1)/2;this.claudeRayPass.uniforms.lightPosition.value.set(i,o)}else this.claudeRayPass.uniforms.lightPosition.value.set(.5,.5)}catch(e){console.warn("Error updating Claude Ray position:",e),this.claudeRayPass&&this.claudeRayPass.uniforms&&this.claudeRayPass.uniforms.lightPosition&&this.claudeRayPass.uniforms.lightPosition.value.set(.5,.5)}}updateVolumetricLightPosition(){try{if(!this.godRayPass||!this.godRayPass.uniforms||!this.godRayPass.uniforms.lightPosition||!this.camera||!this.scene)return;let e=this.findSunObject();if(e){const t=new y;e.getWorldPosition(t);const s=t.clone();s.project(this.camera);const i=(s.x+1)/2,o=(s.y+1)/2,n=this.camera.position.distanceTo(t);this.godRayPass.uniforms.lightPosition.value.set(i,o);const r=Math.min(1,n/13e4);this.godRayPass.uniforms.sunDistance.value=r;const l=new y(0,0,-1).applyQuaternion(this.camera.quaternion),c=new y().subVectors(t,this.camera.position).normalize(),d=l.dot(c);this.godRayPass.uniforms.sunVisibility.value=Math.max(0,d)}else this.godRayPass.uniforms.lightPosition.value.set(.5,.5),this.godRayPass.uniforms.sunDistance.value=1,this.godRayPass.uniforms.sunVisibility.value=0}catch(e){console.warn("Error updating volumetric light position:",e),this.godRayPass&&this.godRayPass.uniforms&&(this.godRayPass.uniforms.lightPosition&&this.godRayPass.uniforms.lightPosition.value.set(.5,.5),this.godRayPass.uniforms.sunDistance&&(this.godRayPass.uniforms.sunDistance.value=1),this.godRayPass.uniforms.sunVisibility&&(this.godRayPass.uniforms.sunVisibility.value=0))}}findSunObject(){let e=null;return e=this.scene.getObjectByName("sun"),e||this.scene.traverse(t=>{t.name==="sun"&&(e=t)}),e}render(){this.composer&&!this.useBasicRendering?this.composer.render():this.renderer.render(this.scene,this.camera)}createInstancedMesh(e,t,s,i){const o=new kt(t,s,i);return o.count=0,o.frustumCulled=!0,this.scene.add(o),this.instancedMeshes.set(e,{mesh:o,count:0,maxCount:i,dummy:new Pe}),o}updateInstance(e,t,s,i,o){const n=this.instancedMeshes.get(e);if(!n)return-1;const a=t!==void 0?t:n.count;if(a>=n.count){if(a>=n.maxCount)return-1;n.count=a+1}return n.dummy.position.copy(s),i&&n.dummy.quaternion.copy(i),o&&n.dummy.scale.copy(o),n.dummy.updateMatrix(),n.mesh.setMatrixAt(a,n.dummy.matrix),n.mesh.instanceMatrix.needsUpdate=!0,a}updateInstancedMeshes(){for(const[e,t]of this.instancedMeshes.entries())t.mesh.instanceMatrix.needsUpdate&&(t.mesh.instanceMatrix.needsUpdate=!1)}removeInstance(e,t){const s=this.instancedMeshes.get(e);if(!(!s||t>=s.count)){if(t<s.count-1){const i=new V;s.mesh.getMatrixAt(s.count-1,i),s.mesh.setMatrixAt(t,i)}s.count--,s.mesh.count=s.count,s.mesh.instanceMatrix.needsUpdate=!0}}dispose(){console.log("Disposing renderer resources..."),window.removeEventListener("resize",this.handleResize),this.composer&&this.composer.passes.forEach(e=>{e.dispose&&e.dispose(),e.material&&e.material.dispose()}),this.instancedMeshes.forEach(e=>{e.mesh&&(e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&(Array.isArray(e.mesh.material)?e.mesh.material.forEach(t=>t.dispose()):e.mesh.material.dispose()),this.scene.remove(e.mesh))}),this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>this.disposeMaterial(t)):this.disposeMaterial(e.material))}),this.renderer.dispose(),console.log("Renderer resources disposed")}disposeMaterial(e){for(const t in e){const s=e[t];s&&s.isTexture&&s.dispose()}e.dispose()}createVolumetricLightShader(){const e={uniforms:{tDiffuse:{value:null},lightPosition:{value:new H(.5,.5)},intensity:{value:.45},decay:{value:.94},density:{value:.6},weight:{value:.5},samples:{value:100},sunColor:{value:new E(16775920)},sunDistance:{value:.5},sunVisibility:{value:1},scattering:{value:.4},attenuationMultiplier:{value:3.5}},vertexShader:`
                varying vec2 vUv;
                
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                precision highp float;
                
                varying vec2 vUv;
                uniform sampler2D tDiffuse;
                uniform vec2 lightPosition;
                uniform float intensity;
                uniform float decay;
                uniform float density;
                uniform float weight;
                uniform int samples;
                uniform vec3 sunColor;
                uniform float sunDistance;
                uniform float sunVisibility;
                uniform float scattering;
                uniform float attenuationMultiplier;
                
                const int MAX_SAMPLES = 150;
                
                float illuminationDecay(float rayProgress, float dist) {
                    // rayProgress: 0.0 to a1.0 (how far along the ray)
                    // dist: normalized distance to sun (0 = close, 1 = far)
                    
                    // Base decay from exponential falloff
                    float baseFalloff = pow(decay, rayProgress * 100.0);
                    
                    // More decay the further the sun is 
                    float distanceAttenuation = 1.0 - (dist * dist * attenuationMultiplier);
                    distanceAttenuation = max(0.0, distanceAttenuation);
                    
                    // Apply visibility factor
                    float visibilityFactor = sunVisibility;
                    
                    return baseFalloff * distanceAttenuation * visibilityFactor;
                }
                
                void main() {
                    // Get the texture color (original scene)
                    vec4 sceneColor = texture2D(tDiffuse, vUv);
                    
                    // Calculate ray direction from pixel to light source
                    vec2 rayVector = (vUv - lightPosition);
                    float rayLength = length(rayVector);
                    vec2 rayDirection = normalize(rayVector);
                    
                    // Skip calculation if ray is too long (reduces artifacts far from sun)
                    if (rayLength > 1.0) {
                        gl_FragColor = sceneColor;
                        return;
                    }
                    
                    // Angle factor (rays stronger when looking near sun)
                    float angleFactor = 1.0 - rayLength;
                    angleFactor = pow(angleFactor, 0.8); // Adjust the power for ray spread
                    
                    // Calculate ray sampling parameters
                    vec2 sampleStep = -rayDirection * min(density, 1.0) / float(samples);
                    
                    // Use a tighter sampling box around the light source
                    // This creates more defined rays and reduces artifacts
                    float rayProgress = max(0.0, (1.0 - rayLength * 2.0)); // Start closer to light source
                    vec2 samplePosition = vUv - sampleStep * rayProgress * 10.0; // Start closer to current position
                    
                    // Clamp sample count for performance
                    int sampleCount = min(samples, MAX_SAMPLES);
                    
                    // Start with current scene color
                    vec4 finalColor = sceneColor;
                    
                    // Calculate scattering factor based on distance and angle
                    float scatterFactor = scattering * angleFactor * (1.0 - sunDistance * 0.5);
                    
                    // Sample the light path
                    for (int i = 0; i < MAX_SAMPLES; i++) {
                        if (i >= sampleCount) break;
                        
                        // Move along the ray
                        samplePosition += sampleStep;
                        
                        // Sample at the current position
                        vec4 sampledColor = texture2D(tDiffuse, samplePosition);
                        
                        // Calculate illumination decay factor
                        float decayFactor = illuminationDecay(float(i) / float(sampleCount), sunDistance);
                        
                        // Create the ray sample with attenuation
                        vec4 raySample = sampledColor * decayFactor * weight;
                        
                        // Apply sun color to the ray (tinted by scene color)
                        raySample.rgb *= mix(sunColor, sampledColor.rgb, 0.3);
                        
                        // Apply scattering effect - brightens areas around sun
                        if (i < sampleCount / 3) {
                            raySample.rgb += sunColor * scatterFactor * decayFactor * 0.2 * (1.0 - float(i) / float(sampleCount / 3));
                        }
                        
                        // Add to accumulated color
                        finalColor += raySample;
                    }
                    
                    // Apply master intensity factor
                    finalColor *= mix(1.0, intensity, sunVisibility);
                    
                    // Preserve original scene color with a blend factor
                    finalColor = mix(sceneColor, finalColor, min(0.95, intensity * sunVisibility));
                    
                    gl_FragColor = finalColor;
                }
            `},t=new pe(e);return t.renderToScreen=!1,t}createClaudeRayShader(){const e={uniforms:{tDiffuse:{value:null},lightPosition:{value:new H(.5,.5)},exposure:{value:.4},decay:{value:.93},density:{value:.8},weight:{value:.25},lightColor:{value:new E(16775920)}},vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                precision highp float;
                
                varying vec2 vUv;
                uniform sampler2D tDiffuse;
                uniform vec2 lightPosition;
                uniform float exposure;
                uniform float decay;
                uniform float density;
                uniform float weight;
                uniform vec3 lightColor;
                
                const int NUM_SAMPLES = 24; // Reduced from 30 for better balance of quality and performance
                
                void main() {
                    // Get the texture color
                    vec4 color = texture2D(tDiffuse, vUv);
                    
                    // Ray direction
                    vec2 texCoord = vUv;
                    vec2 deltaTextCoord = (texCoord - lightPosition) * density / float(NUM_SAMPLES);
                    
                    // Start illumination decay at 1.0
                    float illuminationDecay = 1.0;
                    
                    // Sample the light path with a fixed number of steps
                    for(int i = 0; i < NUM_SAMPLES; i++) {
                        // Move along the ray
                        texCoord -= deltaTextCoord;
                        
                        // Sample at the current position
                        vec4 sampleColor = texture2D(tDiffuse, texCoord);
                        
                        // Apply decay and weight
                        sampleColor *= illuminationDecay * weight;
                        
                        // Apply light color
                        sampleColor.rgb *= lightColor;
                        
                        // Add to the final color
                        color += sampleColor;
                        
                        // Reduce illumination for the next sample
                        illuminationDecay *= decay;
                    }
                    
                    // Apply exposure
                    color *= exposure;
                    
                    // Output the final color
                    gl_FragColor = color;
                }
            `},t=new pe(e);return t.renderToScreen=!1,t}setRayType(e){this.useClaudeRays=e,this.claudeRayPass&&(this.claudeRayPass.enabled=this.volumetricLightEnabled&&this.useClaudeRays),this.godRayPass&&(this.godRayPass.enabled=this.volumetricLightEnabled&&!this.useClaudeRays),this.adjustLightingForRayType(),console.log(`Using ${this.useClaudeRays?"Claude Rays":"Volumetric God Rays"} effect`)}adjustLightingForRayType(){this.ambientLight&&(this.useClaudeRays?this.ambientLight.intensity=1:this.ambientLight.intensity=1.8)}setVolumetricLightEnabled(e){this.volumetricLightEnabled=e,this.useClaudeRays&&this.claudeRayPass?this.claudeRayPass.enabled=e:this.godRayPass&&(this.godRayPass.enabled=e),console.log(`Volumetric lighting ${e?"enabled":"disabled"}`)}updateVolumetricLightParams(e={}){if(!this.godRayPass||!this.godRayPass.uniforms)return;const t=this.godRayPass.uniforms;e.intensity!==void 0&&(t.intensity.value=e.intensity),e.decay!==void 0&&(t.decay.value=e.decay),e.density!==void 0&&(t.density.value=e.density),e.weight!==void 0&&(t.weight.value=e.weight),e.samples!==void 0&&(t.samples.value=e.samples),e.sunColor!==void 0&&(t.sunColor.value=new E(e.sunColor)),e.scattering!==void 0&&(t.scattering.value=e.scattering),e.attenuationMultiplier!==void 0&&(t.attenuationMultiplier.value=e.attenuationMultiplier)}updateClaudeRayParams(e={}){if(!this.claudeRayPass||!this.claudeRayPass.uniforms)return;const t=this.claudeRayPass.uniforms;e.exposure!==void 0&&(t.exposure.value=e.exposure),e.decay!==void 0&&(t.decay.value=e.decay),e.density!==void 0&&(t.density.value=e.density),e.weight!==void 0&&(t.weight.value=e.weight),e.lightColor!==void 0&&(t.lightColor.value=new E(e.lightColor))}setVolumetricLightIntensity(e){if(this.useClaudeRays){if(!this.claudeRayPass||!this.claudeRayPass.uniforms)return;e=Math.max(0,Math.min(1,e));const t=.2+e*.4,s=.15+e*.25,i=.7+e*.3;this.updateClaudeRayParams({exposure:t,weight:s,density:i})}else{if(!this.godRayPass||!this.godRayPass.uniforms)return;e=Math.max(0,Math.min(1,e)),this.updateVolumetricLightParams({intensity:.3+e*.4,weight:.35+e*.3,density:.45+e*.25,scattering:.25+e*.25})}console.log(`Volumetric light intensity set to ${e.toFixed(2)}`)}}class wo{constructor(e){this.scene=e,this.mesh=null,this.thrusters=[],this.leftCannon=null,this.rightCannon=null,this.leftEmitter=null,this.rightEmitter=null,this.miningLaser=null,this.velocity=new y(0,0,0),this.rotation=new me(0,0,0),this.thrust={forward:!1,backward:!1,left:!1,right:!1,boost:!1},this.particleSystems=[],this.trailParticles=null,this.shipScale=2,this.hull=100,this.maxHull=100,this.shield=50,this.maxShield=50,this.isDestroyed=!1,this.fuel=100,this.maxFuel=100,this.fuelConsumptionRate=.01,this.isDocked=!0,this.credits=1e3,this.cargo={iron:0,gold:0,platinum:0},this.fuelTankLevel=1,this.fuelUpgradeCost=1e3,this.engineLevel=1,this.engineUpgradeCost=800,this.maxVelocity=25,this.miningLevel=1,this.miningUpgradeCost=1200,this.miningEfficiency=1,this.hullLevel=1,this.hullUpgradeCost=1500,this.collisionResistance=1,this.scannerLevel=1,this.scannerUpgradeCost=600,this.scanRange=1e3,this.deployableLaserCount=0,this.undockLocation=new y(0,1e4,0),console.log("Creating spaceship..."),this.createSpaceship(),this.createTrailEffect(),this.mesh&&(this.mesh.visible=!1),console.log("Spaceship created successfully (docked state)")}update(e){this.updateParticles&&!this.isDocked&&this.updateParticles()}createSpaceship(){this.mesh=new O,this.mesh.scale.set(this.shipScale,this.shipScale,this.shipScale),this.mesh.position.set(0,2e3,0);const e=new O,t=new ge(.4,.5,1.8,12),s=new le({color:16777215,specular:16766720,shininess:100,emissive:2236962,emissiveIntensity:.1}),i=new C(t,s);i.rotation.x=Math.PI/2,e.add(i);const o=new vs(.4,.8,12),n=new C(o,s);n.position.set(0,0,-1.2),n.rotation.x=-Math.PI/2,e.add(n),this.mesh.add(e);const a=new G(.35,16,16,0,Math.PI*2,0,Math.PI/2),r=new le({color:8965375,specular:16777215,shininess:100,transparent:!0,opacity:.7,emissive:26367,emissiveIntensity:.1}),l=new C(a,r);l.position.set(0,.25,-.2),l.rotation.x=-Math.PI/2,this.mesh.add(l);const c=new ge(.08,.06,2,8),d=new le({color:16766720,specular:16777215,shininess:80,emissive:16766720,emissiveIntensity:.2});this.leftCannon=new C(c,d),this.leftCannon.position.set(.2,0,-1.5),this.leftCannon.rotation.x=Math.PI/2,this.mesh.add(this.leftCannon),this.rightCannon=new C(c,d),this.rightCannon.position.set(-.2,0,-1.5),this.rightCannon.rotation.x=Math.PI/2,this.mesh.add(this.rightCannon);const h=new G(.08,16,16),u=new le({color:16737792,emissive:16724736,emissiveIntensity:1});this.leftEmitter=new C(h,u),this.leftEmitter.position.set(.2,0,-2.5),this.mesh.add(this.leftEmitter),this.rightEmitter=new C(h,u),this.rightEmitter.position.set(-.2,0,-2.5),this.mesh.add(this.rightEmitter),this.miningLaser=this.leftEmitter;const m=P=>{const D=new O,L=new le({color:16777215,specular:16766720,shininess:80,emissive:16777215,emissiveIntensity:.1}),re=new ee(.1,.2,.6),ie=new C(re,L);ie.position.set(P?.55:-.55,0,.2),D.add(ie);const de=new ee(.8,.1,.5),U=new C(de,L);U.position.set(P?1:-1,0,.2),U.rotation.z=P?Math.PI/8:-Math.PI/8,D.add(U);const Le=new ee(.3,.08,.3),N=new le({color:16766720,specular:16777215,shininess:100,emissive:16766720,emissiveIntensity:.3}),k=new C(Le,N);return k.position.set(P?1.4:-1.4,0,.2),k.rotation.z=P?Math.PI/6:-Math.PI/6,D.add(k),D},f=m(!0);this.mesh.add(f);const g=m(!1);this.mesh.add(g);const b=(P,D,L,re,ie,de,U=0,Le=0,N=0)=>{const k=new ee(P,D,L),T=new le({color:16766720,specular:16777215,shininess:100,emissive:16766720,emissiveIntensity:.3}),W=new C(k,T);return W.position.set(re,ie,de),W.rotation.set(U,Le,N),this.mesh.add(W),W};b(.8,.05,.1,0,-.25,-.3),b(.8,.05,.1,0,-.25,.3),b(.05,.05,1,.3,-.25,0),b(.05,.05,1,-.3,-.25,0);const w=new ge(.2,.15,.5,8),v=new le({color:16766720,emissive:16733440,emissiveIntensity:.5}),x=new C(w,v);x.position.z=1.2,x.rotation.x=Math.PI,this.mesh.add(x),this.thrusters.push({mesh:x,type:"main"});const S=new C(w.clone(),v.clone());S.position.z=-1,S.rotation.x=0,S.scale.set(.6,.6,.6),this.mesh.add(S),this.thrusters.push({mesh:S,type:"reverse"});const M=new C(w.clone(),v.clone());M.position.set(.5,0,.5),M.rotation.z=Math.PI/2,M.scale.set(.5,.5,.5),this.mesh.add(M),this.thrusters.push({mesh:M,type:"left"});const A=new C(w.clone(),v.clone());A.position.set(-.5,0,.5),A.rotation.z=-Math.PI/2,A.scale.set(.5,.5,.5),this.mesh.add(A),this.thrusters.push({mesh:A,type:"right"}),this.scene.add(this.mesh),this.createThrusterParticles()}activateMiningLaser(){this.leftEmitter&&this.rightEmitter&&(this.leftEmitter.material.emissiveIntensity=1.5,this.leftEmitter.scale.set(1.2,1.2,1.2),this.rightEmitter.material.emissiveIntensity=1.5,this.rightEmitter.scale.set(1.2,1.2,1.2))}deactivateMiningLaser(){this.leftEmitter&&this.rightEmitter&&(this.leftEmitter.material.emissiveIntensity=1,this.leftEmitter.scale.set(1,1,1),this.rightEmitter.material.emissiveIntensity=1,this.rightEmitter.scale.set(1,1,1))}createThrusterParticles(){const t=(s,i,o,n,a=16733440)=>{const r=new Float32Array(450);for(let h=0;h<150;h++){const u=h*3;r[u]=(Math.random()-.5)*o.x*.7,r[u+1]=(Math.random()-.5)*o.y*.7,r[u+2]=Math.random()*o.z*.7}const l=new j;l.setAttribute("position",new _(r,3));const c=new te({color:a,size:.04,transparent:!0,opacity:.6,blending:$}),d=new Z(l,c);return d.visible=!1,d.position.copy(s),i&&d.rotation.copy(i),this.mesh.add(d),{system:d,geometry:l,positions:r,type:n,baseSize:o}};this.particleSystems.push(t(new y(0,0,1.1),new me(Math.PI,0,0),new y(.15,.15,2),"main",16729088)),this.particleSystems.push(t(new y(.5,0,.5),new me(0,0,Math.PI/2),new y(.08,.08,.8),"left",16724736)),this.particleSystems.push(t(new y(-.5,0,.5),new me(0,0,-Math.PI/2),new y(.08,.08,.8),"right",16724736)),this.particleSystems.push(t(new y(0,0,-1.1),new me(0,0,0),new y(.15,.15,1.4),"reverse",4508927))}createTrailEffect(){const t=new j,s=new Float32Array(1800*3),i=new Float32Array(1800*3),o=new Float32Array(1800*3),n=new Float32Array(1800);for(let r=0;r<1800;r++){const l=r*3;s[l]=Math.floor((Math.random()-.5)*10)/10*.4,s[l+1]=Math.floor((Math.random()-.5)*10)/10*.4,s[l+2]=1.8+Math.random()*.4,i[l]=(Math.random()-.5)*.008,i[l+1]=(Math.random()-.5)*.008,i[l+2]=.12+Math.random()*.05;const c=Math.floor(Math.random()*3);c===0?(o[l]=0,o[l+1]=.7+Math.random()*.3,o[l+2]=.8+Math.random()*.2):c===1?(o[l]=.7+Math.random()*.3,o[l+1]=0,o[l+2]=.8+Math.random()*.2):(o[l]=0,o[l+1]=.9+Math.random()*.1,o[l+2]=.4+Math.random()*.2),n[r]=Math.random()<.7?.8+Math.random()*.4:1.5+Math.random()*.5}t.setAttribute("position",new _(s,3)),t.setAttribute("customColor",new _(o,3)),t.setAttribute("size",new _(n,1));const a=new X({uniforms:{color:{value:new E(65535)},pointTexture:{value:new Ie().load("https://threejs.org/examples/textures/sprites/spark1.png")}},vertexShader:`
                attribute float size;
                attribute vec3 customColor;
                varying vec3 vColor;
                void main() {
                    vColor = customColor;
                    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                    
                    // Add slight "digital jitter" to the position for glitch effect
                    if (mod(mvPosition.y * 10.0, 4.0) < 0.1) {
                        mvPosition.x += sin(mvPosition.z) * 0.05;
                    }
                    
                    gl_PointSize = size * (180.0 / -mvPosition.z); // Adjusted size calculation
                    gl_Position = projectionMatrix * mvPosition;
                }
            `,fragmentShader:`
                uniform vec3 color;
                uniform sampler2D pointTexture;
                varying vec3 vColor;
                void main() {
                    // Create more angular particles by manipulating texture coordinates
                    vec2 uv = gl_PointCoord;
                    
                    // Digital distortion effect - occasional "glitch" lines
                    if (mod(gl_FragCoord.y, 16.0) < 0.5) {
                        uv.x = mod(uv.x + sin(uv.y * 10.0) * 0.1, 1.0);
                    }
                    
                    // Apply texture with the modified coordinates
                    vec4 texColor = texture2D(pointTexture, uv);
                    
                    // Sharper edges for angular look
                    texColor.a = step(0.2, texColor.r);
                    
                    // Combine with color
                    gl_FragColor = vec4(color * vColor, 0.75) * texColor;
                    
                    // Hard cutoff for sharper particle edges
                    if (gl_FragColor.a < 0.2) discard;
                }
            `,blending:$,depthTest:!1,transparent:!0});a.uniforms.pointTexture.value.colorSpace=z,this.trailParticles=new Z(t,a),this.trailParticles.visible=!1,this.mesh.add(this.trailParticles),this.trailParticles.userData={positions:s,velocities:i,colors:o}}updateParticles(){if(this.particleSystems&&(this.particleSystems.forEach(e=>{if(e.system.visible){const t=e.positions,s=e.baseSize;for(let i=0;i<t.length;i+=3)t[i]+=(Math.random()-.5)*.02,t[i+1]+=(Math.random()-.5)*.02,t[i+2]+=.15,t[i]+=(Math.random()-.5)*.01,t[i+1]+=(Math.random()-.5)*.01,t[i+2]>s.z&&(t[i]=(Math.random()-.5)*s.x,t[i+1]=(Math.random()-.5)*s.y,t[i+2]=0);e.geometry.attributes.position.needsUpdate=!0}}),this.trailParticles&&this.trailParticles.visible)){const e=this.trailParticles.userData.positions,t=this.trailParticles.userData.velocities,s=this.trailParticles.userData.colors,i=this.velocity.length()/8;for(let o=0;o<e.length;o+=3){Math.random()<.01&&(e[o]+=(Math.random()-.5)*.2,e[o+1]+=(Math.random()-.5)*.2);const n=Math.random()<.05?0:1;if(e[o]+=t[o]*i*n,e[o+1]+=t[o+1]*i*n,e[o+2]+=t[o+2]*i*n,Math.random()<.005){const r=s[o];s[o]=s[o+2],s[o+2]=r}if(s[o]*=.99,s[o+1]*=.99,s[o+2]*=.99,Math.sqrt(e[o]*e[o]+e[o+1]*e[o+1]+e[o+2]*e[o+2])>45||s[o]+s[o+1]+s[o+2]<.3){e[o]=Math.floor((Math.random()-.5)*10)/10*.4,e[o+1]=Math.floor((Math.random()-.5)*10)/10*.4,e[o+2]=1.8+Math.random()*.4,t[o]=(Math.random()-.5)*.008,t[o+1]=(Math.random()-.5)*.008,t[o+2]=.12+Math.random()*.05;const r=Math.floor(Math.random()*3);r===0?(s[o]=0,s[o+1]=.7+Math.random()*.3,s[o+2]=.8+Math.random()*.2):r===1?(s[o]=.7+Math.random()*.3,s[o+1]=0,s[o+2]=.8+Math.random()*.2):(s[o]=0,s[o+1]=.9+Math.random()*.1,s[o+2]=.4+Math.random()*.2)}}this.trailParticles.geometry.attributes.position.needsUpdate=!0,this.trailParticles.geometry.attributes.customColor.needsUpdate=!0}}dock(){console.log("Docking spaceship"),console.log("Spaceship values before docking:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,isDocked:this.isDocked}),this.isDocked=!0,this.velocity.set(0,0,0),this.mesh.visible=!1,console.log("Spaceship values after docking:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,isDocked:this.isDocked})}undock(){console.log("Undocking spaceship"),console.log("Spaceship values before undocking:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,isDocked:this.isDocked});const e=this.shield;if(this.isDocked=!1,this.mesh.visible=!0,this.shield!==e&&(console.log(`SHIELD RESET DETECTED during undock! Value changed from ${e} to ${this.shield}`),console.log("Restoring shield value to:",e),this.shield=e),console.log("Spaceship values after undocking:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,isDocked:this.isDocked}),this.syncValuesToHealthComponent(),this.undockLocation)this.mesh.position.copy(this.undockLocation),this.mesh.rotation.set(Math.PI/2,0,0);else{const t=this.scene.getObjectByName("stargate").position.clone();t.z+=550,this.mesh.position.copy(t),this.mesh.rotation.set(0,Math.PI,0)}return this.velocity.set(0,0,0),this.mesh.position.clone()}refuel(){return console.log("Refueling spaceship"),this.fuel=this.maxFuel,100}repairShield(){const e=this.shield;if(console.log("===== SHIELD REPAIR INITIATED ====="),console.log(`Repairing shield: ${e} → ${this.maxShield}`),this.shield=this.maxShield,console.log(`Shield value is now: ${this.shield} (Expected: ${this.maxShield})`),console.log("Full spaceship state after shield repair:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,fuel:this.fuel,maxFuel:this.maxFuel}),console.log("===== SHIELD REPAIR COMPLETED ====="),window.game&&window.game.world)try{const t=window.game.world.getEntitiesByTag("player");if(t&&t.length>0){const s=t[0].getComponent("HealthComponent");if(s){const i=s.shield;s.shield=this.shield,console.log(`Direct shield update on HealthComponent: ${i} → ${s.shield}`)}}}catch(t){console.error("Error during direct HealthComponent update:",t)}return this.syncValuesToHealthComponent(),150}repairHull(){const e=this.hull;if(console.log("===== HULL REPAIR INITIATED ====="),console.log(`Repairing hull: ${e} → ${this.maxHull}`),this.hull=this.maxHull,console.log(`Hull value is now: ${this.hull} (Expected: ${this.maxHull})`),console.log("Full spaceship state after hull repair:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull,fuel:this.fuel,maxFuel:this.maxFuel}),console.log("===== HULL REPAIR COMPLETED ====="),window.game&&window.game.world)try{const t=window.game.world.getEntitiesByTag("player");if(t&&t.length>0){const s=t[0].getComponent("HealthComponent");if(s){const i=s.health;s.health=this.hull,console.log(`Direct hull update on HealthComponent: ${i} → ${s.health}`)}}}catch(t){console.error("Error during direct HealthComponent update:",t)}return this.syncValuesToHealthComponent(),200}consumeFuel(){if(this.thrust.forward||this.thrust.backward||this.thrust.left||this.thrust.right){let e=this.fuelConsumptionRate;this.thrust.boost&&(e*=3),this.fuel=Math.max(0,this.fuel-e)}return this.fuel>0}upgradeFuelTank(){return console.log("Upgrading fuel tank"),this.maxFuel*=2,this.fuel=this.maxFuel,this.fuelTankLevel++,this.fuelUpgradeCost*=4,this.maxFuel}upgradeEngine(){return console.log("Upgrading engines"),this.maxVelocity*=1.25,this.thrusters.forEach(e=>{e.mesh&&e.mesh.material&&(e.mesh.material.emissiveIntensity+=.2,this.engineLevel%2===0?e.mesh.material.emissive.setHex(16746496):e.mesh.material.emissive.setHex(16755200))}),this.engineLevel++,this.engineUpgradeCost=Math.floor(this.engineUpgradeCost*2.5),this.maxVelocity}upgradeMiningLaser(){if(console.log("Upgrading mining laser"),this.miningEfficiency*=1.3,this.leftEmitter&&this.leftEmitter.material){this.leftEmitter.scale.set(1.1,1.1,1.1);const e=[16711680,16733440,16750848,16763904,16772608];this.miningLevel<e.length&&(this.leftEmitter.material.color.setHex(e[this.miningLevel]),this.leftEmitter.material.emissive.setHex(e[this.miningLevel])),this.leftEmitter.material.emissiveIntensity+=.2}if(this.rightEmitter&&this.rightEmitter.material){this.rightEmitter.scale.set(1.1,1.1,1.1);const e=[16711680,16733440,16750848,16763904,16772608];this.miningLevel<e.length&&(this.rightEmitter.material.color.setHex(e[this.miningLevel]),this.rightEmitter.material.emissive.setHex(e[this.miningLevel])),this.rightEmitter.material.emissiveIntensity+=.2}return this.leftCannon&&this.leftCannon.material&&(this.leftCannon.scale.x*=1.1,this.leftCannon.scale.y*=1.1),this.rightCannon&&this.rightCannon.material&&(this.rightCannon.scale.x*=1.1,this.rightCannon.scale.y*=1.1),this.miningLevel++,this.miningUpgradeCost=Math.floor(this.miningUpgradeCost*3),this.miningEfficiency}upgradeHull(){console.log("Upgrading hull"),this.collisionResistance*=1.25;const e=this.mesh.children.find(t=>t instanceof O);return e&&e.children&&e.children.forEach(t=>{t instanceof C&&t.material&&(this.hullLevel%2===0?t.material.color.setHex(3195088):t.material.color.setHex(3199168),t.material.shininess+=10)}),this.hullLevel++,this.hullUpgradeCost=Math.floor(this.hullUpgradeCost*2),this.collisionResistance}upgradeScanner(){return console.log("Upgrading scanner"),this.scanRange*=1.2,this.scannerLevel++,this.scannerUpgradeCost=Math.floor(this.scannerUpgradeCost*1.8),this.scanRange}updateTrailVisibility(e){this.trailParticles&&(this.trailParticles.visible=e)}subscribeToDestructionEvents(e){e&&(e.subscribe("entity.destroyed",t=>{const s=t.data.entity;if(s&&s.hasTag&&s.hasTag("player")){console.log("Player entity destroyed - updating spaceship state"),this.isDestroyed=!0;const i=s.getComponent("HealthComponent");i?(this.hull=i.health,this.shield=i.shield):(this.hull=0,this.shield=0),this.handleDestruction()}}),console.log("Spaceship subscribed to destruction events"))}handleDestruction(){this.mesh&&(this.particleSystems.forEach(e=>{e&&e.system&&(e.system.visible=!1)}),this.trailParticles&&(this.trailParticles.visible=!1))}syncValuesToHealthComponent(){console.log("Beginning shield and hull sync to HealthComponent"),console.log("Current spaceship values:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull});const e={shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull};console.log(`Preparing to sync values to player HealthComponent: Shield=${this.shield}, Hull=${this.hull}`);try{window.game&&window.game.messageBus?(window.game.messageBus.publish("player.syncHealth",e),console.log("Published player.syncHealth event to game.messageBus with values:",e)):window.mainMessageBus?(window.mainMessageBus.publish("player.syncHealth",e),console.log("Published player.syncHealth event to mainMessageBus with values:",e)):console.warn("No message bus available to sync health values")}catch(t){console.error("Error publishing sync event:",t)}try{if(window.game&&window.game.world){const t=window.game.world.getEntitiesByTag("player");if(console.log(`Found ${t?t.length:0} player entities for direct sync`),t&&t.length>0){const i=t[0].getComponent("HealthComponent");if(i){console.log("DIRECT SYNC - HealthComponent before sync:",{shield:i.shield,maxShield:i.maxShield,health:i.health,maxHealth:i.maxHealth}),console.log("DIRECT SYNC - Spaceship values to sync:",{shield:this.shield,maxShield:this.maxShield,hull:this.hull,maxHull:this.maxHull});const o=i.shield;i.shield=this.shield,i.maxShield=this.maxShield;const n=i.health;i.health=this.hull,i.maxHealth=this.maxHull,console.log(`Directly synced values to HealthComponent: Shield ${o} → ${i.shield}, Hull ${n} → ${i.health}`),console.log("DIRECT SYNC - HealthComponent after sync:",{shield:i.shield,maxShield:i.maxShield,health:i.health,maxHealth:i.maxHealth})}else console.warn("Player entity found but has no HealthComponent")}else console.warn("No player entities found for direct sync")}}catch(t){console.error("Error directly syncing values to HealthComponent:",t)}}}const q=class q{constructor(e){this.scene=e,this.spaceship=null,this.camera=null,this.rotationState={x:0,y:0},this.collided=!1,this.raycaster=new at,this.direction=new y(0,0,-1),this.collisionDistance=q.COLLISION_DISTANCE}setSpaceship(e){this.spaceship=e}setCamera(e){this.camera=e}update(e){if(!this.spaceship||this.spaceship.isDestroyed||this.spaceship.isDocked||window.game&&window.game.introSequenceActive)return;this.normalizedDeltaTime=e*60;const t=this.spaceship.consumeFuel();let s=new y(0,0,0),i=!1;const o=new y(0,0,-1);o.applyQuaternion(this.spaceship.mesh.quaternion);const n=o.dot(this.spaceship.velocity),a=this.spaceship.particleSystems.find(g=>g.type==="main"),r=this.spaceship.thrusters.find(g=>g.type==="main"),l=this.spaceship.particleSystems.find(g=>g.type==="reverse"),c=this.spaceship.thrusters.find(g=>g.type==="reverse"),d=this.spaceship.particleSystems.find(g=>g.type==="left"),h=this.spaceship.thrusters.find(g=>g.type==="left"),u=this.spaceship.particleSystems.find(g=>g.type==="right"),m=this.spaceship.thrusters.find(g=>g.type==="right");if(t){if(this.spaceship.thrust.forward){i=!0;const g=new y(0,0,-.5);this.spaceship.thrust.boost&&g.multiplyScalar(q.BOOST_MULTIPLIER),s.add(g),a&&(a.system.visible=!0,r&&(r.mesh.material.emissiveIntensity=this.spaceship.thrust.boost?1.5:1,this.spaceship.thrust.boost?r.mesh.material.emissive.setHex(16746496):r.mesh.material.emissive.setHex(16733440)))}else if(n>5&&a){const g=this.getMaxVelocity(),b=Math.min(n/g,.8);a.system.visible=!0,r&&(r.mesh.material.emissiveIntensity=b*.8,r.mesh.material.emissive.setHex(16724736))}else a&&(a.system.visible=!1,r&&(r.mesh.material.emissiveIntensity=.5,r.mesh.material.emissive.setHex(16733440)));if(this.spaceship.thrust.backward)i=!0,s.add(new y(0,0,q.THRUST_FORCE)),l&&(l.system.visible=!0,c&&(c.mesh.material.emissiveIntensity=1,c.mesh.material.emissive.setHex(3394815)));else if(n<-5){if(l&&(l.system.visible=!0,c)){const g=this.getMaxVelocity(),b=Math.min(Math.abs(n)/g,.8);c.mesh.material.emissiveIntensity=b*.8}}else l&&(l.system.visible=!1,c&&(c.mesh.material.emissiveIntensity=.5,c.mesh.material.emissive.setHex(3394815)));if(this.spaceship.thrust.left?(i=!0,s.add(new y(q.THRUST_FORCE,0,0)),u&&(u.system.visible=!0,m&&(m.mesh.material.emissiveIntensity=.8))):u&&(u.system.visible=!1,m&&(m.mesh.material.emissiveIntensity=.5)),this.spaceship.thrust.right?(i=!0,s.add(new y(-.5,0,0)),d&&(d.system.visible=!0,h&&(h.mesh.material.emissiveIntensity=.8))):d&&(d.system.visible=!1,h&&(h.mesh.material.emissiveIntensity=.5)),i){s.applyQuaternion(this.spaceship.mesh.quaternion),s.multiplyScalar(this.normalizedDeltaTime),this.spaceship.velocity.add(s);const g=this.getMaxVelocity();this.spaceship.velocity.length()>g&&this.spaceship.velocity.normalize().multiplyScalar(g)}}if(!i&&this.spaceship.velocity.length()>0){const g=q.FRICTION*this.normalizedDeltaTime;this.spaceship.velocity.length()>g?this.spaceship.velocity.multiplyScalar(1-g):this.spaceship.velocity.set(0,0,0)}const f=this.spaceship.velocity.clone().multiplyScalar(this.normalizedDeltaTime);if(this.spaceship.mesh.position.add(f),this.updateShipRotation(),this.updateCamera(),this.spaceship.updateParticles){const g=this.spaceship.thrust.forward;this.spaceship.updateTrailVisibility(g),this.spaceship.updateParticles()}this.checkCollisions()}getMaxVelocity(){return this.spaceship&&this.spaceship.maxVelocity?this.spaceship.maxVelocity:q.MAX_VELOCITY}updateShipRotation(){if(!this.spaceship)return;const e=Math.PI*.45;this.rotationState.y=Math.max(Math.min(this.rotationState.y,e),-e);const t=new me(this.rotationState.y,this.rotationState.x,0,"YXZ"),s=new fe().setFromEuler(t);this.spaceship.mesh.quaternion.slerp(s,q.ROTATION_SPEED*this.normalizedDeltaTime)}updateCamera(){if(!this.spaceship||!this.camera)return;if(window.game&&window.game.introSequenceActive){console.log("Skipping camera update - intro sequence active");return}const t=new y(0,5,25).clone();t.applyQuaternion(this.spaceship.mesh.quaternion),this.camera.position.copy(this.spaceship.mesh.position).add(t);const s=new y(0,0,-60);s.applyQuaternion(this.spaceship.mesh.quaternion),s.add(this.spaceship.mesh.position),this.camera.lookAt(s),this.camera.far=4e5,this.camera.updateProjectionMatrix()}updateRotation(e,t){this.rotationState.x-=e,this.rotationState.y-=t}checkCollisions(){if(!this.scene||!this.spaceship)return;const e=15,t=this.spaceship.mesh.position.clone();this.scene.traverse(n=>{var a;n.type==="Mesh"&&((a=n.geometry.type)!=null&&a.includes("SphereGeometry"))&&n.userData.isPlayerProjectile&&n.userData.sourceId});const s=[],i=this.scene.children.find(n=>n.name==="asteroidBelt");let o=[];i&&i.userData&&i.userData.asteroids?(o=i.userData.asteroids,s.push(...o.map(n=>n.mesh))):this.scene.traverse(n=>{var a,r,l;if(n.type==="Mesh"&&((a=n.geometry.type)!=null&&a.includes("IcosahedronGeometry")||(r=n.geometry.type)!=null&&r.includes("TetrahedronGeometry")||(l=n.geometry.type)!=null&&l.includes("OctahedronGeometry"))){const c=Math.sqrt(n.position.x*n.position.x+n.position.z*n.position.z);c>16e3&&c<32e3&&s.push(n)}});for(const n of s){if(!n||!n.visible)continue;const a=t.distanceTo(n.position);let r=0;if(n.geometry&&n.geometry.parameters&&n.geometry.parameters.radius?r=n.geometry.parameters.radius:r=60,a<e+r){window.DEBUG_MODE&&console.log("Asteroid collision detected!","Ship position:",t,"Asteroid position:",n.position,"Distance:",a,"Detection threshold:",e+r),this.handleCollision(n,"asteroid");return}}this.scene.traverse(n=>{var a;if(n.type==="Mesh"&&n.geometry.type.includes("SphereGeometry")&&n.scale.x>=1&&!((a=n.userData.id)!=null&&a.startsWith("asteroid-"))&&!n.userData.isPlayerProjectile&&n!==this.spaceship.mesh){const r=t.distanceTo(n.position),l=n.geometry.parameters.radius*n.scale.x;if(n.material.emissive&&n.material.emissive.r>.5&&n.material.emissive.g>.5){if(r<l+e){this.handleCollision(n,"sun");return}}else if(r<l+e){this.handleCollision(n,"planet");return}}})}handleCollision(e,t){if(this.collided||!this.scene)return;if(this.collided=!0,window.DEBUG_MODE&&(console.log("=== COLLISION DETECTED ==="),console.log(`Collision type: ${t}`),console.log(`Ship velocity at impact: ${this.spaceship.velocity.length().toFixed(2)} units/frame`),console.log(`Ship position: x=${this.spaceship.mesh.position.x.toFixed(0)}, y=${this.spaceship.mesh.position.y.toFixed(0)}, z=${this.spaceship.mesh.position.z.toFixed(0)}`),console.log(`${t} position: x=${e.position.x.toFixed(0)}, y=${e.position.y.toFixed(0)}, z=${e.position.z.toFixed(0)}`),console.log(`Hull resistance: ${this.spaceship.collisionResistance}`)),this.attemptCollisionRecovery(t)){if(window.DEBUG_MODE&&console.log("Hull absorbed collision damage!"),this.createRecoveryEffect(),e&&e.position){const c=new y().subVectors(this.spaceship.mesh.position,e.position).normalize();this.spaceship.velocity.copy(c.multiplyScalar(5))}window.game&&window.game.audio&&window.game.audio.playSound("boink"),setTimeout(()=>{this.collided=!1,window.DEBUG_MODE&&console.log("Collision state reset - ship ready for new collisions")},1e3);return}this.spaceship.velocity.set(0,0,0);let s,i,o,n;t==="sun"?(s=16776960,i=60,o="Your ship was incinerated by the sun!",n="SUN_DEATH"):t==="planet"?(s=3394815,i=40,o="Your ship crashed into a planet!",n="COLLISION_PLANET"):(s=16737792,i=20,o="Your ship was destroyed by an asteroid!",n="COLLISION_ASTEROID");const a=new G(i,32,32),r=new F({color:s,transparent:!0,opacity:.8}),l=new C(a,r);l.position.copy(this.spaceship.mesh.position),this.scene.add(l),this.animateExplosion(l),this.spaceship&&(this.spaceship.isDestroyed=!0),console.log("Physics: Initiating game over sequence for collision with",t),window.mainMessageBus?(console.log("Physics: Using window.mainMessageBus"),window.mainMessageBus.publish("game.over",{reason:o,source:"physics",collisionType:t,type:n})):window.game&&window.game.messageBus?(console.log("Physics: Using window.game.messageBus"),window.game.messageBus.publish("game.over",{reason:o,source:"physics",collisionType:t,type:n})):zt(()=>import("./core-BBQ_RQx4.js"),[]).then(c=>{const d=c.MessageBus;console.log("Physics: Using MessageBus.triggerGameOver"),d.triggerGameOver(o,"physics")}).catch(c=>{console.error("Physics: Error importing MessageBus:",c)})}attemptCollisionRecovery(e){if(!this.spaceship||!this.spaceship.collisionResistance)return!1;const t=this.spaceship.collisionResistance;let s=0;switch(e){case"asteroid":s=.5+(t-1)*.08,window.DEBUG_MODE&&console.log(`Asteroid collision recovery chance: ${(s*100).toFixed(1)}%`);break;case"planet":s=.1+(t-1)*.2,window.DEBUG_MODE&&console.log(`Planet collision recovery chance: ${(s*100).toFixed(1)}%`);break;case"sun":s=(t-1)*.05,window.DEBUG_MODE&&console.log(`Sun collision recovery chance: ${(s*100).toFixed(1)}%`);break;default:s=.2+(t-1)*.3,window.DEBUG_MODE&&console.log(`Generic collision recovery chance: ${(s*100).toFixed(1)}%`)}const i=Math.random(),o=i<s;return window.DEBUG_MODE&&console.log(`Recovery roll: ${i.toFixed(3)}, needed ${s.toFixed(3)} or lower to survive`),o}createRecoveryEffect(){if(!this.spaceship||!this.scene)return;const e=new G(60,32,32),t=new F({color:3198928,transparent:!0,opacity:.6,side:K}),s=new C(e,t);s.position.copy(this.spaceship.mesh.position),this.scene.add(s);let i=1;const o=.05,n=.02,a=()=>{if(i>2||s.material.opacity<=0){this.scene.remove(s);return}i+=o,s.scale.set(i,i,i),s.material.opacity-=n,this.spaceship&&this.spaceship.mesh&&s.position.copy(this.spaceship.mesh.position),requestAnimationFrame(a)};a()}animateExplosion(e){let t=1;const s=.5,i=.02,o=()=>{if(t>20||e.material.opacity<=0){this.scene.remove(e);return}t+=s,e.scale.set(t,t,t),e.material.opacity-=i,requestAnimationFrame(o)};o()}};he(q,"THRUST_FORCE",.5),he(q,"BOOST_MULTIPLIER",4),he(q,"MAX_VELOCITY",25),he(q,"ROTATION_SPEED",.3),he(q,"COLLISION_DISTANCE",15),he(q,"FRICTION",.01);let Ct=q;class Mi{constructor(e){this.scene=e,this.skybox=null,this.time=0,this.textureLoader=new Ie,this.milkyWayTexture=this.textureLoader.load("./assets/2k_stars_milky_way.jpg"),this.milkyWayTexture.colorSpace=z,this.skyboxTextures={},this.solarSystemParams={starDensity:1,nebulaDensity:.5,color:16777215,texturePath:"./assets/2k_stars_milky_way.jpg",brightness:1},this.createProceduralSkybox(this.solarSystemParams)}updateForSystem(e){e&&(console.log("Updating skybox with parameters:",e),(e.isSolarSystem||e.color===16777215&&e.starDensity===1&&e.nebulaDensity===.5)&&(console.log("Detected Solar System skybox parameters, using stored solar system configuration"),e=this.solarSystemParams),this.skybox&&(console.log("Removing existing skybox"),this.scene.remove(this.skybox)),e.resetTime&&(this.time=0),this.createProceduralSkybox(e))}getTexture(e){if(!e)return this.milkyWayTexture;if(e==="./assets/2k_stars_milky_way.jpg")return this.milkyWayTexture;let t=e;return e.startsWith("/images/")&&window.location.port==="8000"&&(t=`http://${window.location.hostname}:8001${e}`,console.log(`Adjusted texture path to API server: ${t}`)),this.skyboxTextures[e]||(console.log(`Loading new skybox texture: ${t}`),this.skyboxTextures[e]=this.textureLoader.load(t),this.skyboxTextures[e].colorSpace=z),this.skyboxTextures[e]}createProceduralSkybox(e={}){let t=(e==null?void 0:e.starDensity)||1,s=(e==null?void 0:e.nebulaDensity)||.5,i=(e==null?void 0:e.color)||0,o=(e==null?void 0:e.brightness)!==void 0?e.brightness:1;const n=32e4,a=(e==null?void 0:e.texturePath)||"./assets/2k_stars_milky_way.jpg";console.log(`Creating enhanced skybox with star density: ${t}, nebula density: ${s}, color: 0x${i.toString(16)}, texture: ${a}, brightness: ${o}`);const r=this.getTexture(a),l=new X({uniforms:{time:{value:this.time||0},milkyWayTexture:{value:r},starDensity:{value:t},nebulaDensity:{value:s},skyColor:{value:new E(i)},brightness:{value:o}},vertexShader:`
                varying vec2 vUv;
                varying vec3 vPosition;
                
                void main() {
                    vUv = uv;
                    vPosition = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform sampler2D milkyWayTexture;
                uniform float time;
                uniform float starDensity;
                uniform float nebulaDensity;
                uniform vec3 skyColor;
                uniform float brightness;
                
                varying vec2 vUv;
                varying vec3 vPosition;
                
                void main() {
                    // Sample the Milky Way texture with adjusted brightness
                    vec4 milkyWay = texture2D(milkyWayTexture, vUv);
                    milkyWay.rgb *= 1.5 * brightness; // Apply brightness factor
                    
                    // Use only the Milky Way texture without procedural stars
                    vec3 finalColor = milkyWay.rgb * nebulaDensity * 1.2 * brightness;
                    
                    // Reduced ambient light
                    finalColor += vec3(0.05);
                    
                    // Subtle color tint
                    finalColor = mix(finalColor, skyColor * 1.2 * brightness, 0.1);
                    
                    // Apply gamma correction for more natural brightness
                    finalColor = pow(finalColor, vec3(0.9));
                    
                    gl_FragColor = vec4(finalColor, 1.0);
                }
            `,side:ke}),c=new ee(n,n,n);this.skybox=new C(c,l),this.skybox.rotation.x=Math.PI/4,this.skybox.rotation.y=Math.PI/6,this.scene.add(this.skybox),this.skyMaterial=l,console.log("Enhanced skybox created with texture")}update(e=.016,t){this.skyMaterial&&(this.time+=e*.1,this.skyMaterial.uniforms.time.value=this.time),this.skybox&&t&&this.skybox.position.copy(t.position)}}class Ti{constructor(e){this.scene=e,this.sun=null,this.sunFlickerIntensity=1,this.sunFlickerDirection=.02,this.time=0,this.sunType="G",this.lensFlares=[],this.createSun()}createSun(){this.sun=new O,this.sun.name="sun",this.scene.add(this.sun);const e=new G(1e3,64,64),t=new X({uniforms:{time:{value:0},sunColor:{value:new E(16742144)},surfaceDetail:{value:1.2},surfaceDistortion:{value:.3},sunActivity:{value:.8}},vertexShader:`
                varying vec3 vNormal;
                varying vec2 vUv;
                varying vec3 vPosition;
                
                void main() {
                    vUv = uv;
                    vNormal = normalize(normalMatrix * normal);
                    vPosition = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform float time;
                uniform vec3 sunColor;
                uniform float surfaceDetail;
                uniform float surfaceDistortion;
                uniform float sunActivity;
                
                varying vec3 vNormal;
                varying vec2 vUv;
                varying vec3 vPosition;
                
                // Noise functions for surface detail
                float hash(float n) { return fract(sin(n) * 43758.5453123); }
                float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }
                
                float noise(vec3 x) {
                    vec3 p = floor(x);
                    vec3 f = fract(x);
                    f = f * f * (3.0 - 2.0 * f);
                    
                    float n = p.x + p.y * 157.0 + 113.0 * p.z;
                    return mix(
                        mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),
                            mix(hash(n + 157.0), hash(n + 158.0), f.x), f.y),
                        mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),
                            mix(hash(n + 270.0), hash(n + 271.0), f.x), f.y),
                        f.z);
                }
                
                // Fractional Brownian Motion for layered detail
                float fbm(vec3 x) {
                    float v = 0.0;
                    float a = 0.5;
                    vec3 shift = vec3(100);
                    
                    for (int i = 0; i < 7; ++i) { // Increased iterations for more detail
                        v += a * noise(x);
                        x = x * 2.0 + shift;
                        a *= 0.5;
                    }
                    
                    return v;
                }
                
                void main() {
                    // Calculate dynamic granulation based on noise
                    vec3 surfacePos = vPosition * surfaceDetail * 0.01;
                    float granulation = fbm(surfacePos + time * 0.15); // Increased speed
                    
                    // Calculate solar prominences and flares with more dynamic movement
                    float flareBase = fbm(surfacePos * 2.5 + time * 0.3); // Increased detail and speed
                    float flares = pow(flareBase, 1.8) * sunActivity;
                    flares = smoothstep(0.65, 0.9, flares); // Lower threshold for more flares
                    
                    // Create dynamic hotspots that move across the surface
                    float hotspots = fbm(surfacePos * 3.0 + time * 0.2) * fbm(surfacePos * 1.5 - time * 0.1);
                    hotspots = pow(hotspots, 3.0) * 1.5;
                    
                    // Calculate normal distortion for surface waves with more turbulence
                    vec3 distortedNormal = vNormal;
                    distortedNormal.x += noise(surfacePos * 6.0 + time * 0.15) * surfaceDistortion;
                    distortedNormal.y += noise(surfacePos * 6.0 + time * 0.2) * surfaceDistortion;
                    distortedNormal.z += noise(surfacePos * 6.0 + time * 0.17) * surfaceDistortion;
                    distortedNormal = normalize(distortedNormal);
                    
                    // Edge brightness (limb darkening inverse - brighter at the edges)
                    float edgeBrightness = 1.0 - dot(distortedNormal, vec3(0.0, 0.0, 1.0));
                    edgeBrightness = pow(edgeBrightness, 2.5) * 0.4; // Reduced power and multiplier
                    
                    // Create fire-like color variations
                    vec3 baseColor = sunColor;
                    vec3 hotColor = vec3(1.0, 0.8, 0.4); // Yellow-white hot spots
                    vec3 flareColor = vec3(1.0, 0.6, 0.3); // Orange-red flares
                    
                    // Combine effects for a more dynamic fireball look
                    vec3 finalColor = baseColor * (1.0 + granulation * 0.4);
                    finalColor = mix(finalColor, hotColor, hotspots);
                    finalColor += flareColor * flares;
                    finalColor += vec3(1.0, 0.9, 0.7) * edgeBrightness;
                    
                    // Output with HDR values
                    gl_FragColor = vec4(finalColor, 1.0);
                }
            `,side:Lt}),s=new C(e,t);this.sun.add(s);const i=new G(2e3,64,64),o=new X({uniforms:{time:{value:0},coronaColor:{value:new E(16750912)},viewVector:{value:new y(0,0,1)},turbulence:{value:.6}},vertexShader:`
                uniform vec3 viewVector;
                varying vec3 vNormal;
                varying vec3 vPosition;
                varying float vIntensity;
                
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    vPosition = position;
                    
                    // Calculate view-dependent intensity with less view dependency
                    vec3 viewDir = normalize(viewVector);
                    // Use a lower exponent and add a base intensity to ensure visibility from all angles
                    vIntensity = pow(1.15 - dot(vNormal, viewDir), 1.5) * 0.8 + 0.2;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform float time;
                uniform vec3 coronaColor;
                uniform float turbulence;
                
                varying vec3 vNormal;
                varying vec3 vPosition;
                varying float vIntensity;
                
                // Noise functions
                float hash(vec3 p) {
                    p = fract(p * vec3(443.897, 441.423, 437.195));
                    p += dot(p, p.yzx + 19.19);
                    return fract((p.x + p.y) * p.z);
                }
                
                float noise(vec3 p) {
                    vec3 i = floor(p);
                    vec3 f = fract(p);
                    f = f*f*(3.0-2.0*f);
                    
                    return mix(
                        mix(mix(hash(i), hash(i + vec3(1,0,0)), f.x),
                            mix(hash(i + vec3(0,1,0)), hash(i + vec3(1,1,0)), f.x), f.y),
                        mix(mix(hash(i + vec3(0,0,1)), hash(i + vec3(1,0,1)), f.x),
                            mix(hash(i + vec3(0,1,1)), hash(i + vec3(1,1,1)), f.x), f.y), f.z);
                }
                
                float fbm(vec3 p) {
                    float f = 0.0;
                    float weight = 0.5;
                    for (int i = 0; i < 5; i++) {
                        f += weight * noise(p);
                        weight *= 0.5;
                        p *= 2.0;
                    }
                    return f;
                }
                
                void main() {
                    // Add turbulence to the corona intensity based on position
                    float turbulenceFactor = fbm(vPosition * 0.005 + time * 0.15) * turbulence;
                    float finalIntensity = vIntensity * (1.0 + turbulenceFactor);
                    
                    // Create dynamic wisps in the corona for a fire-like effect
                    float wisps = fbm(vPosition * 0.01 - time * 0.05) * fbm(vPosition * 0.02 + time * 0.1);
                    wisps = pow(wisps, 2.0) * 0.5;
                    
                    // HDR color with variation
                    vec3 finalColor = coronaColor * (finalIntensity + wisps);
                    
                    // Add color variation based on intensity
                    if (finalIntensity > 0.7) {
                        finalColor = mix(finalColor, vec3(1.0, 0.9, 0.7), (finalIntensity - 0.7) * 3.0);
                    }
                    
                    // Add transparency at the edges for volumetric feel
                    float alpha = smoothstep(0.0, 0.15, finalIntensity + wisps * 0.5);
                    
                    gl_FragColor = vec4(finalColor, alpha * 0.9); // Slightly more transparent
                }
            `,transparent:!0,blending:$,depthWrite:!1,side:ke}),n=new C(i,o);this.sun.add(n);const a=new G(3e3,32,32),r=new X({uniforms:{time:{value:0},coronaColor:{value:new E(16746496)},viewVector:{value:new y(0,0,1)}},vertexShader:`
                uniform vec3 viewVector;
                varying float vIntensity;
                varying vec3 vPosition;
                
                void main() {
                    vec3 vNormal = normalize(normalMatrix * normal);
                    vec3 vNormel = normalize(viewVector);
                    // Less extreme view dependency to ensure more consistent appearance
                    vIntensity = pow(1.05 - dot(vNormal, vNormel), 2.0) * 0.7 + 0.3;
                    vPosition = position;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform float time;
                uniform vec3 coronaColor;
                varying float vIntensity;
                varying vec3 vPosition;
                
                // Simple noise for variation
                float hash(vec3 p) {
                    p = fract(p * vec3(443.897, 441.423, 437.195));
                    p += dot(p, p.yzx + 19.19);
                    return fract((p.x + p.y) * p.z);
                }
                
                float noise(vec3 p) {
                    vec3 i = floor(p);
                    vec3 f = fract(p);
                    f = f*f*(3.0-2.0*f);
                    
                    return mix(
                        mix(mix(hash(i), hash(i + vec3(1,0,0)), f.x),
                            mix(hash(i + vec3(0,1,0)), hash(i + vec3(1,1,0)), f.x), f.y),
                        mix(mix(hash(i + vec3(0,0,1)), hash(i + vec3(1,0,1)), f.x),
                            mix(hash(i + vec3(0,1,1)), hash(i + vec3(1,1,1)), f.x), f.y), f.z);
                }
                
                void main() {
                    // Apply time-based pulsing with noise variation
                    float noiseVal = noise(vPosition * 0.002 + time * 0.1);
                    float pulseIntensity = vIntensity * (1.0 + 0.2 * sin(time + noiseVal * 5.0));
                    
                    // Add subtle fire-like variations
                    pulseIntensity += noiseVal * 0.2;
                    
                    vec3 glow = coronaColor * pulseIntensity;
                    gl_FragColor = vec4(glow, pulseIntensity * 0.4); // Reduced from 0.6
                }
            `,transparent:!0,blending:$,depthWrite:!1,side:ke}),l=new C(a,r);this.sun.add(l);const c=new xe(16775920,2e5,1e5,2);this.sun.add(c),this.createFireballFlares(),this.sunMaterial=t,this.coronaMaterial=o,this.outerCoronaMaterial=r,this.sunLight=c,this.baseLightIntensity=2e5;const d=new Ge(16775920,1.5);d.position.set(0,0,0),d.castShadow=!0,d.shadow.mapSize.width=4096,d.shadow.mapSize.height=4096,d.shadow.camera.near=1e3,d.shadow.camera.far=1e5,d.shadow.camera.left=-5e4,d.shadow.camera.right=5e4,d.shadow.camera.top=5e4,d.shadow.camera.bottom=-5e4,d.shadow.bias=-5e-5,d.shadow.normalBias=.02,d.shadow.radius=2,this.scene&&this.scene.renderer&&(this.scene.renderer.shadowMap.type=_e),this.sun.add(d),this.sunDirectionalLight=d}createFireballFlares(){const e=["https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare0.png","https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare2.png","https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare3.png"],t=new Ie;this.lensFlares.forEach(a=>{a.parent&&a.parent.remove(a)}),this.lensFlares=[];const s=t.load(e[0]);s.colorSpace=z;const i=new Ve(new We({map:s,color:16755285,transparent:!0,blending:$,depthTest:!1}));i.scale.set(700,700,1),this.sun.add(i),this.lensFlares.push(i);const o=8,n=300;for(let a=0;a<o;a++){const r=1+a%2,l=t.load(e[r]);l.colorSpace=z;const c=new Ve(new We({map:l,color:a%3===0?16764023:a%3===1?16746581:16737826,transparent:!0,blending:$,depthTest:!1})),d=a/o*Math.PI*2,h=Math.cos(d)*n,u=Math.sin(d)*n;c.position.set(h,u,0);const m=200+Math.random()*200;if(c.scale.set(m,m,1),this.sun.add(c),this.lensFlares.push(c),a%2===0){const f=t.load(e[a%3]);f.colorSpace=z;const g=new Ve(new We({map:f,color:16755234,transparent:!0,blending:$,depthTest:!1})),b=n*2,w=d+(Math.random()*.2-.1),v=Math.cos(w)*b,x=Math.sin(w)*b;g.position.set(v,x,0);const S=100+Math.random()*150;g.scale.set(S,S,1),this.sun.add(g),this.lensFlares.push(g)}}}updateSunType(e,t=1){this.sunType=e||"G";let s,i,o;switch(this.sunType){case"O":s=10335487,i=3e4,o=.8;break;case"B":s=11190271,i=2e4,o=.75;break;case"A":s=13293567,i=1e4,o=.7;break;case"F":s=16316415,i=7e3,o=.65;break;case"G":s=16774378,i=5500,o=.6;break;case"K":s=16765601,i=4e3,o=.5;break;case"M":s=16764015,i=3e3,o=.4;break;default:s=16774378,i=5500,o=.6}if(this.sunMaterial&&(this.sunMaterial.uniforms.sunColor.value.setHex(s),this.sunMaterial.uniforms.sunActivity.value=o),this.coronaMaterial){const n=new E(s);n.r=Math.min(1,n.r*1.2),n.g=Math.min(1,n.g*1.1),n.b=Math.min(1,n.b*1),this.coronaMaterial.uniforms.coronaColor.value=n}if(this.outerCoronaMaterial){const n=new E(s);n.r=Math.min(1,n.r*1.3),n.g=Math.min(1,n.g*1.2),n.b=Math.min(1,n.b*1.1),this.outerCoronaMaterial.uniforms.coronaColor.value=n}this.sunLight&&(this.sunLight.color.setHex(s),this.sunLight.intensity=(2e5+i/1e4*2e5)*t),this.lensFlares.forEach((n,a)=>{if(n&&n.material){const r=new E(s);a%3===0?r.r=Math.min(1,r.r*1.2):a%3===1&&(r.g=Math.min(1,r.g*1.1)),n.material.color=r}}),console.log(`Updated sun to type ${this.sunType}, color: ${s.toString(16)}, intensity multiplier: ${t}`)}getRadius(){return 3e3}getPosition(){return new y(0,0,0)}update(e=.016){if(this.sun){if(this.time+=e*.4,this.sunMaterial&&this.sunMaterial.uniforms.time&&(this.sunMaterial.uniforms.time.value=this.time),this.coronaMaterial&&this.coronaMaterial.uniforms.time&&(this.coronaMaterial.uniforms.time.value=this.time),this.outerCoronaMaterial&&this.outerCoronaMaterial.uniforms.time&&(this.outerCoronaMaterial.uniforms.time.value=this.time),this.sunFlickerIntensity+=this.sunFlickerDirection,this.sunFlickerIntensity>1.2?(this.sunFlickerIntensity=1.2,this.sunFlickerDirection=-Math.random()*.03):this.sunFlickerIntensity<.9&&(this.sunFlickerIntensity=.9,this.sunFlickerDirection=Math.random()*.03),this.sunLight){const t=this.sunLight._intensityMultiplier||1,s=this.baseLightIntensity+(this.sunType==="G"?3e4:this.sunType==="O"||this.sunType==="B"?1e5:this.sunType==="M"?1e4:5e4);let i=1;if(this.scene&&this.scene.camera){const o=new y().subVectors(this.scene.camera.position,this.sun.position).normalize(),n=new y(0,0,-1).applyQuaternion(this.scene.camera.quaternion),a=o.dot(n);a>.8&&(i=.5+(1-a)*.5)}this.sunLight.intensity=s*this.sunFlickerIntensity*t*i}if(this.sunDirectionalLight&&this.scene&&this.scene.camera){const t=this.scene.camera.position.clone(),i=t.clone().sub(this.sun.position).normalize().clone().multiplyScalar(-15e3).add(this.sun.position);this.sunDirectionalLight.position.copy(i),this.sunDirectionalLight.target.position.copy(this.sun.position),this.sunDirectionalLight.target.parent||this.scene.add(this.sunDirectionalLight.target);const o=t.distanceTo(this.sun.position),n=Math.max(5e4,o*2);this.sunDirectionalLight.shadow.camera.left=-n,this.sunDirectionalLight.shadow.camera.right=n,this.sunDirectionalLight.shadow.camera.top=n,this.sunDirectionalLight.shadow.camera.bottom=-n,this.sunDirectionalLight.shadow.camera.updateProjectionMatrix(),this.sunDirectionalLight.intensity=1.5*this.sunFlickerIntensity}if(this.scene&&this.scene.camera){const t=new y().subVectors(this.scene.camera.position,this.sun.position).normalize();this.coronaMaterial&&this.coronaMaterial.uniforms.viewVector&&(this.coronaMaterial.uniforms.viewVector.value=t),this.outerCoronaMaterial&&this.outerCoronaMaterial.uniforms.viewVector&&(this.outerCoronaMaterial.uniforms.viewVector.value=t);const s=this.time;this.lensFlares.forEach((i,o)=>{if(!i)return;const n=.5+o%3*.3,a=.9+Math.sin(s*n+o)*.1;if(o===0){const l=700*a;i.scale.set(l,l,1)}else{const l=200+o%3*100,c=l*a;if(i.scale.set(c,c,1),i.userData.originalPos){const d=.1+o%5*.05,h=.3+o%4*.1;i.position.x=i.userData.originalPos.x+Math.sin(s*h)*d*l,i.position.y=i.userData.originalPos.y+Math.cos(s*h)*d*l}else i.userData.originalPos=i.position.clone()}const r=t.dot(new y(0,0,-1).applyQuaternion(this.scene.camera.quaternion));if(r>.5){const l=Math.min(1,(r-.5)/.3+.3);i.material.opacity=l,i.visible=!0}else{const l=Math.max(.1,(r+.5)/1)*.5;i.material.opacity=l,i.visible=!0}})}}}toggleShadowHelper(e){this.shadowHelper&&this.shadowHelper.parent&&(this.shadowHelper.parent.remove(this.shadowHelper),this.shadowHelper=null),e&&this.sunDirectionalLight&&this.scene&&(this.shadowHelper=new Ss(this.sunDirectionalLight.shadow.camera),this.scene.add(this.shadowHelper),console.log("Shadow camera helper enabled - showing sun shadow frustum"))}}const Y=new Ie,B={mercury:Y.load("./assets/2k_mercury.jpg"),venus:{surface:Y.load("./assets/2k_venus_surface.jpg"),atmosphere:Y.load("./assets/2k_venus_atmosphere.jpg")},earth:Y.load("./assets/2k_earth_daymap.jpg"),mars:Y.load("./assets/2k_mars.jpg"),jupiter:Y.load("./assets/2k_jupiter.jpg"),saturn:{surface:Y.load("./assets/2k_saturn.jpg"),rings:Y.load("./assets/2k_saturn_ring_alpha.png")},uranus:Y.load("./assets/2k_uranus.jpg"),neptune:Y.load("./assets/2k_neptune.jpg")};B.mercury.colorSpace=z;B.venus.surface.colorSpace=z;B.venus.atmosphere.colorSpace=z;B.earth.colorSpace=z;B.mars.colorSpace=z;B.jupiter.colorSpace=z;B.saturn.surface.colorSpace=z;B.saturn.rings.colorSpace=z;B.uranus.colorSpace=z;B.neptune.colorSpace=z;const Ne=[];for(let p=1;p<=22;p++){const e=Y.load(`./assets/p${p}.jpeg`);e.colorSpace=z,Ne.push(e)}class ki{constructor(e,t){this.scene=e,this.starSystemGenerator=t,this.planets=[],this.planetRegions={},this.currentSystemId="Solar System",this.systemPlanets={},this.createHomeSolarSystem()}createHomeSolarSystem(){const e=[{name:"Mercury",size:220,distance:4800,speed:.0016,color:11184810,rings:!1},{name:"Venus",size:400,distance:8e3,speed:.0013,color:15125660,rings:!1},{name:"Earth",size:420,distance:12e3,speed:.001,color:4286945,rings:!1},{name:"Mars",size:320,distance:16800,speed:8e-4,color:13000005,rings:!1},{name:"Jupiter",size:1e3,distance:3e4,speed:4e-4,color:14070398,rings:!0},{name:"Saturn",size:880,distance:4e4,speed:3e-4,color:15787465,rings:!0},{name:"Uranus",size:720,distance:56e3,speed:2e-4,color:13298929,rings:!0},{name:"Neptune",size:700,distance:72e3,speed:16e-5,color:6267867,rings:!1}];this.systemPlanets["Solar System"]=e,this.createPlanetsForSystem("Solar System")}createPlanetsForSystem(e){if(this.clearPlanets(),this.currentSystemId=e,this.systemPlanets[e]){this.createPlanetsFromData(this.systemPlanets[e]);return}const t=this.generatePlanetsForSystem(e);this.systemPlanets[e]=t,this.createPlanetsFromData(t)}generatePlanetsForSystem(e){if(console.log(`Generating new planets for system: ${e}`),this.starSystemGenerator&&this.starSystemGenerator.customPlanetData&&this.starSystemGenerator.customPlanetData[e]){const c=this.starSystemGenerator.customPlanetData[e];return console.log(`Using ${c.length} custom planets for system: ${e}`),c.forEach(d=>{d.textureUrl?console.log(`Custom planet ${d.name} has texture URL: ${d.textureUrl}`):console.log(`Custom planet ${d.name} does not have a texture URL`)}),this.starSystemGenerator.customPlanetData[e]}const t=["New","Alpha","Beta","Gamma","Delta","Nova","Proxima","Ultima","Astro","Cosmo","Stella","Terra","Astra","Prime","Orb"],s=["sphere","world","orb","terra","oid","globus","ium","ian","aria","anth","urus","alos","onos","era","ax","is","os"],i=e.includes("System-")?e.split("-")[1][0]:"M",o=2+Math.floor(Math.random()*7),n=[];let a=1,r=1,l=[];switch(i){case"O":a=1.8,r=1.6,l=[6711039,10066431,13421823,11184895,8947933];break;case"B":a=1.5,r=1.3,l=[10070783,11189247,13421823,14540287,12298956];break;case"A":a=1.3,r=1.1,l=[13421823,14540287,15658751,16777215,14535901];break;case"F":a=1.1,r=1,l=[10070783,11193514,13426124,16764074,15658700];break;case"G":a=1,r=1,l=[11184810,4286945,13000005,14070398,15787465];break;case"K":a=.8,r=.9,l=[15125660,13413e3,14531481,12294519,13404262];break;case"M":a=.6,r=.7,l=[13395524,14514005,15632486,16750967,12277043];break;default:l=[11184810,4286945,13000005,14070398,15787465]}for(let c=0;c<o;c++){const d=t[Math.floor(Math.random()*t.length)],h=s[Math.floor(Math.random()*s.length)],u=`${d}${h}`,m=Math.random();let f;m<.5?f=(240+Math.random()*200)*a:m<.8?f=(440+Math.random()*280)*a:f=(720+Math.random()*360)*a;const g=4800+c*8e3,b=g*.2,w=(g+(Math.random()*b-b/2))*r,v=.002/(w/1e3),x=l[Math.floor(Math.random()*l.length)],S=f>600?Math.random()<.4:!1,M=Math.random()*Math.PI*.5,A=Math.random()*Math.PI*.2;n.push({name:u,size:Math.floor(f),distance:Math.floor(w),speed:v,color:x,rings:S,axialTilt:M,orbitalTilt:A})}return n}createPlanetsFromData(e){this.clearPlanets(),e.forEach(t=>{const s=new G(t.size,32,32);let i;if(t.textureUrl){console.log(`Creating planet ${t.name} with custom texture: ${t.textureUrl}`);let l=t.textureUrl;t.textureUrl.startsWith("/images/")&&window.location.port==="8000"&&(l=`http://${window.location.hostname}:8001${t.textureUrl}`,console.log(`Adjusted planet texture path to API server: ${l}`));const c=Y.load(l);c.colorSpace=z,i=new R({map:c,roughness:.7,metalness:.2,flatShading:!1,emissive:new E(t.color||16777215),emissiveIntensity:.2,emissiveMap:c})}else switch(t.name){case"Mercury":i=new R({map:B.mercury,roughness:.7,metalness:.2,flatShading:!1,emissive:new E(5592405),emissiveIntensity:.2,emissiveMap:B.mercury});break;case"Venus":i=new R({map:B.venus.surface,roughness:.6,metalness:.1,flatShading:!1,emissive:new E(15125660),emissiveIntensity:.25,emissiveMap:B.venus.surface});break;case"Earth":i=new R({map:B.earth,roughness:.5,metalness:.1,flatShading:!1,emissive:new E(4286945),emissiveIntensity:.2,emissiveMap:B.earth});break;case"Mars":i=new R({map:B.mars,roughness:.7,metalness:.1,flatShading:!1,emissive:new E(13000005),emissiveIntensity:.25,emissiveMap:B.mars});break;case"Jupiter":i=new R({map:B.jupiter,roughness:.5,metalness:0,flatShading:!1,emissive:new E(14070398),emissiveIntensity:.2,emissiveMap:B.jupiter});break;case"Saturn":i=new R({map:B.saturn.surface,roughness:.6,metalness:.1,flatShading:!1,emissive:new E(15787465),emissiveIntensity:.2,emissiveMap:B.saturn.surface});break;case"Uranus":i=new R({map:B.uranus,roughness:.5,metalness:0,flatShading:!1,emissive:new E(8960972),emissiveIntensity:.25,emissiveMap:B.uranus});break;case"Neptune":i=new R({map:B.neptune,roughness:.5,metalness:0,flatShading:!1,emissive:new E(6267867),emissiveIntensity:.25,emissiveMap:B.neptune});break;default:const l=Math.floor(Math.random()*Ne.length);i=new R({map:Ne[l],roughness:.6,metalness:.2,color:new E(t.color),flatShading:!1,emissive:new E(t.color),emissiveIntensity:.3,emissiveMap:Ne[l]});break}const o=new C(s,i),n=Math.random()*Math.PI*2;let a=t.orbitalTilt||0,r=t.axialTilt||0;if(o.position.x=Math.cos(n)*t.distance,o.position.y=Math.sin(a)*t.distance,o.position.z=Math.sin(n)*Math.cos(a)*t.distance,o.rotation.x=r,o.castShadow=!0,o.receiveShadow=!0,this.scene.add(o),t.rings){let l,c,d;t.name==="Saturn"?(l=new Ae(t.size*1.4,t.size*2,32),c=new R({map:B.saturn.rings,side:K,transparent:!0,opacity:.8,roughness:.8,metalness:.1,emissive:new E(15787465),emissiveIntensity:.2,emissiveMap:B.saturn.rings})):(l=new Ae(t.size*1.3,t.size*1.8,32),c=new R({color:t.color,side:K,transparent:!0,opacity:.4,roughness:.7,metalness:.2,emissive:new E(t.color),emissiveIntensity:.3})),d=new C(l,c),d.rotation.x=Math.PI/2,d.castShadow=!0,d.receiveShadow=!0,o.add(d)}this.planets.push({mesh:o,distance:t.distance,speed:t.speed,angle:n,orbitalTilt:a}),this.planetRegions[t.name]={name:t.name,position:o.position.clone(),radius:t.size*2}})}clearPlanets(){this.planets.forEach(e=>{this.scene.remove(e.mesh)}),this.planets=[],this.planetRegions={}}updateForSystem(e){return console.log(`Updating planets for system: ${e}`),this.createPlanetsForSystem(e),!0}getPlanetRegions(){return this.planetRegions}getPlanets(){return this.planets}update(e){this.planets.forEach(t=>{t.angle+=t.speed*e,t.mesh.position.x=Math.cos(t.angle)*t.distance,t.mesh.position.z=Math.sin(t.angle)*Math.cos(t.orbitalTilt)*t.distance,t.mesh.position.y=Math.sin(t.angle)*Math.sin(t.orbitalTilt)*t.distance,t.mesh.rotation.y+=e*.1,t.mesh&&Object.values(this.planetRegions).forEach(s=>{s&&s.position&&s.position.distanceTo(t.mesh.position)<5e3&&s.position.copy(t.mesh.position)})})}}class Ai{constructor(e){this.scene=e,this.asteroids=[],this.innerRadius=2e4,this.outerRadius=28e3,this.width=1800,this.resourceMultipliers={iron:1,gold:1,platinum:1},this.createAsteroidBelt()}createAsteroidBelt(){for(let t=0;t<1e3;t++){const s=Math.random()*120+120;let i;const o=Math.floor(Math.random()*3);o===0?i=new Cs(s,0):o===1?i=new $t(s,0):i=new st(s,0);const n=i.attributes.position;for(let v=0;v<n.count;v++){const x=new y;x.fromBufferAttribute(n,v),x.x+=(Math.random()-.5)*.4*s,x.y+=(Math.random()-.5)*.4*s,x.z+=(Math.random()-.5)*.4*s,n.setXYZ(v,x.x,x.y,x.z)}i.computeVertexNormals();const a=new E,r=Math.random();let l=null;r<.7?(a.setHSL(.02,.3,.35+Math.random()*.2),l="iron"):r<.93?(a.setHSL(.12,.7,.5+Math.random()*.2),l="gold"):(a.setHSL(.1,.3,.7+Math.random()*.15),l="platinum");const c=new R({color:a,roughness:.6+Math.random()*.2,metalness:.4+Math.random()*.4,flatShading:!0,emissive:a.clone().multiplyScalar(.3),emissiveIntensity:.2}),d=new C(i,c),h=Math.random()*Math.PI*2,u=this.innerRadius+Math.random()*(this.outerRadius-this.innerRadius),m=(Math.random()-.5)*this.width;d.position.set(Math.cos(h)*u,m,Math.sin(h)*u),d.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);const f=1e-4+Math.random()*1e-4,g=u,b=Math.random()*Math.PI*.15;this.scene.add(d);const w=50+Math.random()*50;this.asteroids.push({mesh:d,size:s,orbitSpeed:f,orbitRadius:g,orbitAngle:h,orbitTilt:b,initialHeight:m,rotationSpeed:{x:(Math.random()-.5)*.005,y:(Math.random()-.5)*.005,z:(Math.random()-.5)*.005},resourceType:l,baseResourceAmount:w,resourceAmount:w,maxResourceAmount:w,minable:!0})}}getRegionInfo(){return{center:new y(0,0,0),innerRadius:this.innerRadius,outerRadius:this.outerRadius}}getAsteroids(){return this.asteroids}setResourceMultipliers(e){e&&(this.resourceMultipliers=e,this.updateAsteroidResources(),console.log("Updated asteroid belt with resource multipliers:",e))}updateAsteroidResources(){this.asteroids.forEach(e=>{if(e.resourceType)switch(e.resourceType){case"iron":e.resourceAmount=e.baseResourceAmount*this.resourceMultipliers.iron;break;case"gold":e.resourceAmount=e.baseResourceAmount*this.resourceMultipliers.gold;break;case"platinum":e.resourceAmount=e.baseResourceAmount*this.resourceMultipliers.platinum;break}})}updateForSystem(e){e&&(e.asteroidDensity&&this.updateDensity(e.asteroidDensity),e.resourceMultipliers&&this.setResourceMultipliers(e.resourceMultipliers))}updateDensity(e=1){e<.5&&(e=.5),e>3&&(e=3),this.asteroids.forEach((t,s)=>{const i=s%10<e*5;t.mesh.visible=i})}findClosestAsteroid(e,t=1600){let s=null,i=t;return this.asteroids.forEach(o=>{if(!o.minable||!o.mesh.visible)return;const n=e.distanceTo(o.mesh.position);n<i&&(i=n,s=o)}),s}removeAsteroid(e){this.scene.remove(e.mesh);const t=this.asteroids.findIndex(s=>s===e);t!==-1&&this.asteroids.splice(t,1)}update(){this.asteroids.forEach(e=>{e.mesh.rotation.x+=e.rotationSpeed.x,e.mesh.rotation.y+=e.rotationSpeed.y,e.mesh.rotation.z+=e.rotationSpeed.z,e.orbitAngle+=e.orbitSpeed;const t=Math.cos(e.orbitAngle)*e.orbitRadius,s=Math.sin(e.orbitAngle)*e.orbitRadius;if(e.orbitTilt){const i=s*Math.sin(e.orbitTilt),o=s*Math.cos(e.orbitTilt);e.mesh.position.x=t,e.mesh.position.z=o,e.mesh.position.y=i+e.initialHeight}else e.mesh.position.x=t,e.mesh.position.z=s,e.mesh.position.y=e.initialHeight})}}class Pi{constructor(e){this.scene=e,this.stargate=null,this.navLights=[],this.portalParticles=[],this.createStargate()}createStargate(){const e=new O;e.name="stargate";const t=new ne(1e3,200,32,100),s=new R({color:1118481,roughness:.9,metalness:.1,emissive:0}),i=new C(t,s);e.add(i);const o=(c,d,h={x:0,y:0,z:0},u={x:0,y:0,z:0})=>{const m=new ne(c,d,16,100),f=new R({color:65535,emissive:65535,emissiveIntensity:1.5,roughness:.2,metalness:.8}),g=new C(m,f);return g.position.set(h.x,h.y,h.z),g.rotation.set(u.x,u.y,u.z),g},n=o(1060,10),a=o(940,10),r=o(850,5);e.add(n),e.add(a),e.add(r),this.createPortalEffect(e);const l=this.createNeonDetails();e.add(l),e.position.set(0,1e4,0),e.rotation.x=Math.PI/2,this.scene.add(e),this.stargate=e,this.createCounterRotatingRing(e)}createCounterRotatingRing(e){const t=new O,s=new ne(820,3,16,100),i=new R({color:65535,emissive:65535,emissiveIntensity:2,roughness:.1,metalness:.9,transparent:!0,opacity:.7});for(let o=0;o<3;o++){const n=new C(s,i.clone());n.rotation.x=Math.PI*o/3,n.rotation.y=Math.PI*o/3,t.add(n)}e.add(t),this.counterRotatingRing=t}createPortalEffect(e){const t=new X({uniforms:{time:{value:0},resolution:{value:new H(1024,1024)},baseColor:{value:new E(65535)}},vertexShader:`
            varying vec2 vUv;
            
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,fragmentShader:`
            uniform float time;
            uniform vec2 resolution;
            uniform vec3 baseColor;
            varying vec2 vUv;
            
            // Simple noise function
            float noise(vec2 p) {
              return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);
            }
            
            // Smoothed noise
            float smoothNoise(vec2 p) {
              vec2 ip = floor(p);
              vec2 fp = fract(p);
              
              vec2 u = fp * fp * (3.0 - 2.0 * fp);
              
              float a = noise(ip);
              float b = noise(ip + vec2(1.0, 0.0));
              float c = noise(ip + vec2(0.0, 1.0));
              float d = noise(ip + vec2(1.0, 1.0));
              
              return mix(mix(a, b, u.x), mix(c, d, u.x), u.y);
            }
            
            // Fractal Brownian Motion
            float fbm(vec2 p) {
              float value = 0.0;
              float amplitude = 0.5;
              float frequency = 3.0;
              
              for (int i = 0; i < 6; i++) {
                value += amplitude * smoothNoise(p * frequency);
                amplitude *= 0.5;
                frequency *= 2.0;
              }
              
              return value;
            }
            
            void main() {
              // Convert uv to be centered at (0.5, 0.5) with range -1 to 1
              vec2 centeredUV = (vUv - 0.5) * 2.0;
              float dist = length(centeredUV);
              
              // Create angle for rotation
              float angle = atan(centeredUV.y, centeredUV.x);
              
              // Enhanced swirling effect parameters - more aggressive
              float swirl = sin(angle * 6.0 + time * 2.0) * 0.5 + 0.5;
              float pulse = sin(time * 0.8) * 0.5 + 0.5;
              
              // Create more distorted coordinates for noise - enhances warp feel
              vec2 distortedUV = vec2(
                centeredUV.x + sin(time * 0.7 + centeredUV.y * 5.0) * 0.2,
                centeredUV.y + cos(time * 0.6 + centeredUV.x * 5.0) * 0.2
              );
              
              // Create noise patterns - more contrast
              float noiseValue = fbm(distortedUV * 3.0 + time * 0.3);
              float ripple = sin(dist * 20.0 - time * 3.0) * 0.5 + 0.5;
              
              // Combine effects with more intensity
              float alpha = smoothstep(0.9, 0.0, dist);
              float intensity = mix(noiseValue, ripple, 0.7) * swirl * pulse;
              
              // Enhanced portal colors - bright cyan to deep blue
              vec3 darkColor = vec3(0.0, 0.1, 0.3);
              vec3 brightColor = vec3(0.0, 1.0, 1.0) * 2.0;
              vec3 accentColor = vec3(0.3, 0.8, 1.0);
              
              // More complex color mixing
              vec3 finalColor = mix(darkColor, brightColor, intensity);
              finalColor = mix(finalColor, accentColor, ripple * swirl);
              
              // Enhanced edge glow for portal effect
              float edgeGlow = smoothstep(0.8, 0.4, dist) * smoothstep(0.0, 0.6, dist);
              finalColor = mix(finalColor, brightColor, edgeGlow * pulse);
              
              // Add portal event horizon effect
              float eventHorizon = smoothstep(0.8, 0.78, dist) * 2.0;
              finalColor += vec3(0.0, 1.0, 1.0) * eventHorizon;
              
              gl_FragColor = vec4(finalColor, alpha);
            }
          `,transparent:!0,side:K}),s=new it(800,128),i=new C(s,t);e.add(i);const o=new xe(65535,400,2e3,2);o.position.set(0,0,0),e.add(o);const n=()=>{const a=new ne(650,10,8,100),r=new R({color:65535,emissive:65535,emissiveIntensity:2,transparent:!0,opacity:.3,side:K}),l=new C(a,r);return l.rotation.x=Math.random()*Math.PI,l.rotation.y=Math.random()*Math.PI,l.userData={rotationSpeed:{x:(Math.random()-.5)*.02,y:(Math.random()-.5)*.02,z:(Math.random()-.5)*.02},pulseSpeed:.5+Math.random()*.3},this.portalParticles.push(l),l};for(let a=0;a<8;a++)e.add(n());this.portalShaderMaterial=t,this.portalLight=o}createNeonDetails(){const e=new O,t=s=>{const i=new O,o=new ge(10,10,300,8),n=new R({color:65535,emissive:65535,emissiveIntensity:1,transparent:!0,opacity:.8}),a=new C(o,n);a.rotation.x=Math.PI/2;const r=new xe(65535,100,400,2);return r.position.set(0,0,0),i.add(a),i.add(r),i.position.x=Math.cos(s)*1e3,i.position.y=Math.sin(s)*1e3,i.rotation.z=s-Math.PI/2,r.userData={originalIntensity:r.intensity,phase:Math.random()*Math.PI*2},this.navLights.push({light:r,lightMesh:a}),i};for(let s=0;s<8;s++){const i=s/8*Math.PI*2;e.add(t(i))}return e}getPosition(){return new y(0,1e4,0)}getRegionInfo(){return{center:new y(0,1e4,0),radius:2e3}}update(){if(this.navLights&&this.navLights.forEach(({light:e,lightMesh:t})=>{const s=Date.now()*.001,i=.7+.3*Math.sin(s*2+e.userData.phase);e.intensity=e.userData.originalIntensity*i,t.material&&(t.material.emissiveIntensity=i,t.material.opacity=.5+i*.5)}),this.portalShaderMaterial&&(this.portalShaderMaterial.uniforms.time.value=Date.now()*.001,this.portalLight)){const e=Date.now()*.001;this.portalLight.intensity=400+Math.sin(e*2)*150}this.portalParticles&&this.portalParticles.forEach(e=>{const t=Date.now()*.001;if(e.userData.rotationSpeed&&(e.rotation.x+=e.userData.rotationSpeed.x,e.rotation.y+=e.userData.rotationSpeed.y,e.rotation.z+=e.userData.rotationSpeed.z),e.userData.pulseSpeed){const s=.9+.2*Math.sin(t*e.userData.pulseSpeed);e.scale.set(s,s,s)}}),this.counterRotatingRing&&(this.counterRotatingRing.rotation.x+=.006,this.counterRotatingRing.rotation.y+=.009,this.counterRotatingRing.rotation.z-=.003),this.stargate&&(this.stargate.rotation.x+=.003,this.stargate.rotation.y+=.0045,this.stargate.rotation.z+=.006)}}class Ii{constructor(e){this.scene=e,this.systems={},this.currentSystem=null,this.warpGates={},this.starClasses=["O","B","A","F","G","K","M"],this.systemClassifications=["Resource-Rich","Ancient","Unstable","Barren","Hazardous","Peaceful"],this.skyboxTextures=["./assets/s1.jpg","./assets/s2.jpg","./assets/s3.jpg","./assets/s4.jpg","./assets/s5.jpg","./assets/s6.jpg","./assets/s7.jpg","./assets/s8.jpg","./assets/s9.jpg"],this.resourceDistribution={O:{iron:.3,gold:.4,platinum:.3},B:{iron:.2,gold:.3,platinum:.5},A:{iron:.2,gold:.5,platinum:.3},F:{iron:.3,gold:.4,platinum:.3},G:{iron:.4,gold:.3,platinum:.3},K:{iron:.5,gold:.3,platinum:.2},M:{iron:.6,gold:.2,platinum:.2}},this.classificationMultipliers={"Resource-Rich":{iron:2,gold:2,platinum:2},Ancient:{iron:1,gold:1.5,platinum:2.5},Unstable:{iron:1,gold:1,platinum:3},Barren:{iron:.5,gold:.5,platinum:.5},Hazardous:{iron:1.5,gold:1.5,platinum:1.5},Peaceful:{iron:1,gold:1,platinum:1},"Home System":{iron:1,gold:1,platinum:1}},this.initializeSystems()}initializeSystems(){console.log("Initializing star systems..."),this.createSolarSystem(),this.generateRandomSystems(5),this.createSystemConnections(),this.setCurrentSystem("Solar System"),console.log("Star systems initialized")}createSolarSystem(){const e={id:"Solar System",name:"Solar System",starClass:"G",classification:"Home System",starColor:16776960,planetCount:8,asteroidDensity:1,specialFeatures:["Earth"],description:"Our home system, with Earth as the starting location.",connections:[],position:new y(0,0,0),skyboxParams:{starDensity:1,nebulaDensity:.5,color:16777215,texturePath:"./assets/2k_stars_milky_way.jpg",brightness:1},resourceMultipliers:{iron:1,gold:1,platinum:1}};this.systems["Solar System"]=e}generateRandomSystems(e){for(let t=0;t<e;t++){const s=`System-${t+1}`,i=this.getRandomStarClass(),o=this.getRandomClassification(),n=this.getStarColorFromClass(i),a=this.calculateResourceMultipliers(i,o),r=this.getRandomSkyboxTexture(),l={id:s,name:this.generateSystemName(i),starClass:i,classification:o,starColor:n,planetCount:this.getRandomInt(2,10),asteroidDensity:this.getRandomFloat(.5,2.5),specialFeatures:this.generateSpecialFeatures(o),description:this.generateDescription(i,o),connections:[],position:this.generateMapPosition(),skyboxParams:{starDensity:this.getRandomFloat(.7,1.5),nebulaDensity:this.getRandomFloat(.3,1.2),color:this.getSkyboxColorFromClass(i),texturePath:r,brightness:.8},resourceMultipliers:a};this.systems[s]=l}}getRandomSkyboxTexture(){return this.skyboxTextures[this.getRandomInt(0,this.skyboxTextures.length-1)]}createSystemConnections(){const e=Object.keys(this.systems);this.systems["Solar System"];const t=this.getRandomSystemsExcept("Solar System",2);for(const i of t)this.createConnection("Solar System",i);for(const i of e)if(this.systems[i].connections.length===0){const n=this.getRandomSystemExcept(i);this.createConnection(i,n)}const s=Math.floor(e.length/2);for(let i=0;i<s;i++){const o=e[this.getRandomInt(0,e.length-1)],n=this.getRandomSystemExcept(o);this.systems[o].connections.includes(n)||this.createConnection(o,n)}}createConnection(e,t){this.systems[e].connections.push(t),this.systems[t].connections.push(e),this.warpGates[e]||(this.warpGates[e]=[]),this.warpGates[t]||(this.warpGates[t]=[]),this.warpGates[e].push(t),this.warpGates[t].push(e),console.log(`Created connection between ${e} and ${t}`)}getCurrentSystemConnections(){return this.currentSystem?this.systems[this.currentSystem].connections:[]}getCurrentSystemResources(){return this.currentSystem?this.systems[this.currentSystem].resourceMultipliers:{iron:1,gold:1,platinum:1}}setCurrentSystem(e){return this.systems[e]?(this.currentSystem=e,console.log(`Traveled to system: ${e}`),!0):!1}travelToSystem(e){if(!this.systems[e])return console.error(`System ${e} does not exist`),!1;if(!this.getCurrentSystemConnections().includes(e))return console.error(`No connection from ${this.currentSystem} to ${e}`),!1;if(window.game&&window.game.spaceship&&window.game.spaceship.isDocked&&console.log("Player is docked during interstellar travel"),this.systems[this.currentSystem]){const s=this.systems[this.currentSystem].skyboxParams;console.log(`${this.currentSystem} skybox params before travel: 
                         color=${s.color.toString(16)}, 
                         starDensity=${s.starDensity}, 
                         nebulaDensity=${s.nebulaDensity}, 
                         texture=${s.texturePath}`)}if(this.systems[e]){const s=this.systems[e].skyboxParams;console.log(`Traveling to ${e} with skybox params: 
                         color=${s.color.toString(16)}, 
                         starDensity=${s.starDensity}, 
                         nebulaDensity=${s.nebulaDensity}, 
                         texture=${s.texturePath}`)}return this.setCurrentSystem(e),!0}getAllSystems(){return this.systems}getCurrentSystemData(){return this.currentSystem?this.systems[this.currentSystem]:null}getRandomStarClass(){const e=[1,2,5,10,15,20,50],t=e.reduce((i,o)=>i+o,0);let s=Math.random()*t;for(let i=0;i<e.length;i++){if(s<e[i])return this.starClasses[i];s-=e[i]}return this.starClasses[this.getRandomInt(0,this.starClasses.length-1)]}getRandomClassification(){return this.systemClassifications[this.getRandomInt(0,this.systemClassifications.length-1)]}getStarColorFromClass(e){return{O:10203391,B:11190271,A:13293567,F:16316415,G:16774378,K:16765601,M:16764015}[e]||16777215}getSkyboxColorFromClass(e){return{O:255,B:4474111,A:8947967,F:14540287,G:16777181,K:16768426,M:16746598}[e]||16777215}generateSystemName(e){const t=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Proxima","Nova","Sirius","Vega","Rigel","Antares","Arcturus"],s=["Prime","Major","Minor","A","B","I","II","III","IV","V"],i=t[this.getRandomInt(0,t.length-1)],o=this.getRandomInt(0,10)>7?` ${s[this.getRandomInt(0,s.length-1)]}`:"",n=this.getRandomInt(1,999);return`${i} ${e}${n}${o}`}generateSpecialFeatures(e){const t=[];switch(e){case"Resource-Rich":t.push("Dense Asteroid Fields","Rich Mineral Veins");break;case"Ancient":t.push("Abandoned Structures","Ancient Artifacts");break;case"Unstable":t.push("Solar Flares","Radiation Bursts");break;case"Barren":t.push("Minimal Resources","Few Planets");break;case"Hazardous":t.push("Asteroid Storms","Energy Anomalies");break;case"Peaceful":t.push("Stable Environment","Optimal Mining Conditions");break}return t}generateDescription(e,t){const s={O:"A rare, hot blue star system with intense radiation.",B:"A blue-white star system with high energy output.",A:"A white star system with moderate radiation levels.",F:"A yellow-white star system with mild conditions.",G:"A yellow star system similar to our Solar System.",K:"An orange star system with reduced energy output.",M:"A common red dwarf system with low energy output."},i={"Resource-Rich":"The system is known for its abundant resources and dense asteroid fields.",Ancient:"This ancient system contains remnants of long-lost civilizations.",Unstable:"Be cautious as unpredictable stellar activity occurs in this system.",Barren:"Resources are scarce in this mostly empty star system.",Hazardous:"Environmental hazards make mining operations difficult but rewarding.",Peaceful:"This system offers stable and optimal conditions for mining operations.","Home System":"Our home system, containing Earth and the origin of humanity."};return`${s[e]} ${i[t]}`}calculateResourceMultipliers(e,t){const s=this.resourceDistribution[e],i=this.classificationMultipliers[t];return{iron:s.iron*i.iron,gold:s.gold*i.gold,platinum:s.platinum*i.platinum}}generateMapPosition(){const e=150+Math.random()*100,t=Math.random()*Math.PI*2,s=Math.cos(t)*e,i=Math.sin(t)*e;return new y(s,i,0)}getRandomSystemsExcept(e,t){const s=Object.keys(this.systems).filter(o=>o!==e),i=[];for(let o=0;o<Math.min(t,s.length);o++){const n=this.getRandomInt(0,s.length-1);i.push(s[n]),s.splice(n,1)}return i}getRandomSystemExcept(e){const t=Object.keys(this.systems).filter(i=>i!==e),s=this.getRandomInt(0,t.length-1);return t[s]}getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}getRandomFloat(e,t){return Math.random()*(t-e)+e}addCustomSystem(e){var i,o,n,a;if(!e||!e.id||!e.name)return console.error("Invalid system data",e),!1;this.systems[e.id]&&console.warn(`System with ID ${e.id} already exists, overwriting`),console.log(`Adding custom system: ${e.name} (${e.id})`);const t={id:e.id,name:e.name,starClass:e.starClass||this.getRandomStarClass(),classification:e.classification||"Custom",starColor:e.starColor||this.getStarColorFromClass(e.starClass||"G"),planetCount:e.planetData?e.planetData.length:0,asteroidDensity:e.asteroidDensity||1,specialFeatures:e.specialFeatures||["User Created"],description:e.description||"A custom star system created by the user",connections:[],position:e.position||this.generateMapPosition(),skyboxParams:{starDensity:((i=e.skyboxParams)==null?void 0:i.starDensity)||1,nebulaDensity:((o=e.skyboxParams)==null?void 0:o.nebulaDensity)||.8,color:((n=e.skyboxParams)==null?void 0:n.color)||this.getSkyboxColorFromClass(e.starClass||"G"),texturePath:e.skyboxUrl||this.getRandomSkyboxTexture(),brightness:((a=e.skyboxParams)==null?void 0:a.brightness)||.8,isCustomTexture:!!e.skyboxUrl},resourceMultipliers:e.resourceMultipliers||{iron:1,gold:1,platinum:1},isCustomSystem:!0};e.planetData&&Array.isArray(e.planetData)&&this.storePlanetData(e.id,e.planetData),this.systems[e.id]=t,this.createConnection("Solar System",e.id);const s=this.getRandomSystemExcept(e.id,"Solar System");return s&&this.createConnection(e.id,s),console.log(`Custom system ${e.name} added successfully with connections to Solar System and ${s||"no other system"}`),!0}storePlanetData(e,t){if(!Array.isArray(t)){console.error("Planet data must be an array");return}const s=[];for(let i=0;i<t.length;i++){const o=t[i];s.push({name:o.name||`Planet-${i+1}`,size:o.size||300+Math.random()*500,distance:o.distance||4800+i*8e3+Math.random()*2e3,speed:o.speed||.001+Math.random()*.001,color:o.color||this.getRandomColor(),rings:o.rings!==void 0?o.rings:Math.random()>.7,textureUrl:o.textureUrl||null,axialTilt:o.axialTilt||Math.random()*Math.PI*.5,orbitalTilt:o.orbitalTilt||Math.random()*Math.PI*.2})}this.customPlanetData||(this.customPlanetData={}),this.customPlanetData[e]=s,console.log(`Stored ${s.length} planets for system ${e}`)}getRandomColor(){return Math.floor(Math.random()*16777215)}returnFromTravel(){var t,s,i;if(console.log("StarSystemGenerator: Handling return from interstellar travel"),!window.game||!window.game.spaceship)return console.error("StarSystemGenerator: Cannot return from travel - game or spaceship not found"),!1;window.game.spaceship.isDocked||(console.log("StarSystemGenerator: Setting ship to docked state after travel"),window.game.spaceship.dock());const e=(t=window.game.controls)==null?void 0:t.dockingSystem;return e&&(console.log("StarSystemGenerator: Repositioning ship near stargate"),e.positionNearStargate(),typeof e.showStargateUI=="function")?(console.log("StarSystemGenerator: Showing stargate UI via docking system"),e.showStargateUI(),!0):(i=(s=window.game.ui)==null?void 0:s.stargateInterface)!=null&&i.showStargateUI?(console.log("StarSystemGenerator: Showing stargate UI via game.ui.stargateInterface"),window.game.ui.stargateInterface.showStargateUI(),!0):(console.warn("StarSystemGenerator: Could not fully complete return from travel"),!1)}}class Ri{constructor(e,t){this.scene=e,this.camera=t,this.isTransitioning=!1,this.transitionDuration=3e3,this.onTransitionComplete=null,this.setupTransitionElements()}setupTransitionElements(){this.warpTunnel=new Z(new j,new te({color:3198928,size:2,blending:$,transparent:!0,sizeAttenuation:!0})),this.createWarpParticles(),this.createOverlay()}createWarpParticles(){const t=new Float32Array(6e3);for(let s=0;s<2e3;s++){const i=s*3,o=50+Math.random()*50,n=Math.random()*Math.PI*2,a=-500-Math.random()*3e3;t[i]=o*Math.cos(n),t[i+1]=o*Math.sin(n),t[i+2]=a}this.warpTunnel.geometry.setAttribute("position",new _(t,3)),this.originalPositions=new Float32Array(t)}createOverlay(){this.overlay=document.createElement("div"),this.overlay.id="warp-overlay",this.overlay.style.position="fixed",this.overlay.style.top="0",this.overlay.style.left="0",this.overlay.style.width="100%",this.overlay.style.height="100%",this.overlay.style.backgroundColor="#30cfd0",this.overlay.style.opacity="0",this.overlay.style.transition="opacity 0.5s",this.overlay.style.pointerEvents="none",this.overlay.style.zIndex="9999",document.body.appendChild(this.overlay)}startTransition(e){this.isTransitioning||(console.log("Starting system transition..."),this.isTransitioning=!0,this.onTransitionComplete=e,this.scene.add(this.warpTunnel),this.initialCameraPosition=this.camera.position.clone(),this.initialCameraRotation=this.camera.rotation.clone(),this.startTime=Date.now(),this.showOverlay(),this.animate())}animate(){if(!this.isTransitioning)return;const t=Date.now()-this.startTime,s=Math.min(t/this.transitionDuration,1);if(this.updateWarpEffect(s),s>=1){this.completeTransition();return}requestAnimationFrame(this.animate.bind(this))}updateWarpEffect(e){const t=this.warpTunnel.geometry.attributes.position.array,s=3+e*20;for(let i=0;i<t.length;i+=3)t[i+2]+=s,t[i+2]>100&&(t[i]=this.originalPositions[i],t[i+1]=this.originalPositions[i+1],t[i+2]=this.originalPositions[i+2]-500);this.warpTunnel.geometry.attributes.position.needsUpdate=!0,this.camera&&(this.camera.rotation.z+=5e-4*Math.sin(e*Math.PI))}showOverlay(){this.overlay&&(this.overlay.style.opacity="0.2",setTimeout(()=>{this.overlay.style.opacity="1",setTimeout(()=>{this.overlay.style.opacity="0"},500)},this.transitionDuration-1e3))}completeTransition(){console.log("System transition complete"),this.isTransitioning=!1,this.scene.remove(this.warpTunnel),this.camera&&this.initialCameraPosition&&this.initialCameraRotation&&(this.camera.position.copy(this.initialCameraPosition),this.camera.rotation.copy(this.initialCameraRotation)),this.onTransitionComplete&&typeof this.onTransitionComplete=="function"&&setTimeout(()=>{console.log("Executing transition completion callback"),this.onTransitionComplete()},100)}}class Di{constructor(){this.apiBaseUrl=this.getApiBaseUrl(),this.token=null,this.tokenExpiry=null,this.clientId="game_client",this.isRefreshing=!1,this.refreshCallbacks=[],console.log(`API Client initialized with base URL: ${this.apiBaseUrl}`)}getApiBaseUrl(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:8001":"https://aminer-skybox-generator-833fe937a945.herokuapp.com"}hasValidToken(){if(!this.token||!this.tokenExpiry)return!1;const e=new Date(this.tokenExpiry).getTime(),t=new Date().getTime(),s=5*60*1e3;return e-t>s}clearToken(){this.token=null,this.tokenExpiry=null}async getToken(){if(this.isRefreshing)return new Promise(e=>{this.refreshCallbacks.push(t=>e(t))});this.isRefreshing=!0;try{const e=await fetch(`${this.apiBaseUrl}/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.clientId})});if(!e.ok){const o=(await e.json()).detail||"Failed to get token";throw console.error(`Token error (${e.status}): ${o}`),this.refreshCallbacks.forEach(n=>n(!1)),this.refreshCallbacks=[],this.isRefreshing=!1,new Error(o)}const t=await e.json();this.token=t.access_token;const s=new Date;return s.setHours(s.getHours()+1),this.tokenExpiry=s.toISOString(),this.refreshCallbacks.forEach(i=>i(!0)),this.refreshCallbacks=[],this.isRefreshing=!1,!0}catch(e){return console.error("Error getting token:",e),this.refreshCallbacks.forEach(t=>t(!1)),this.refreshCallbacks=[],this.isRefreshing=!1,!1}}async handleApiResponse(e){if(e.status===401){if(this.clearToken(),!await this.getToken())throw new Error("Authentication failed. Please reload the application.");return!1}if(e.status===429)throw new Error("Rate limit exceeded. Please try again later.");if(!e.ok){const t=await e.json();throw new Error(t.message||t.detail||`Error: ${e.status} ${e.statusText}`)}return!0}async generateSkybox(e,t){if(!this.hasValidToken()&&!await this.getToken())throw new Error("Failed to authenticate with the API");const s=await fetch(`${this.apiBaseUrl}/generate-skybox`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({system_name:e,skybox_description:t})});return await this.handleApiResponse(s)?await s.json():this.generateSkybox(e,t)}async generatePlanet(e,t){if(!this.hasValidToken()&&!await this.getToken())throw new Error("Failed to authenticate with the API");const s=await fetch(`${this.apiBaseUrl}/generate-planet`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({planet_name:e,planet_description:t})});return await this.handleApiResponse(s)?await s.json():this.generatePlanet(e,t)}getFullImageUrl(e){if(e.startsWith("http"))return e;const t=e.startsWith("/")?e.substring(1):e;return`${this.apiBaseUrl}/${t}`}}class Bi{constructor(e,t){this.starSystemGenerator=e,this.environment=t,this.apiClient=new Di,this.isVisible=!1,this.isGenerating=!1,this.generatedSkyboxUrl=null,this.generatedPlanetUrls=[],this.systemData=null,this.isMobile=this.detectMobile(),this.createUI(),this.setupEventHandlers(),this.setupSliderListeners(1)}detectMobile(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||window.innerWidth<900}createUI(){this.container=document.createElement("div"),this.container.id="custom-system-creator",this.container.className="modal-container",this.container.style.display="none",this.container.innerHTML=`
            <div class="modal-content" style="${this.isMobile?"width: 94%; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 100px; overscroll-behavior: contain;":""}">
                <div class="modal-header">
                    <h2>Create New Star System</h2>
                    <button id="close-system-creator" class="close-btn" style="${this.isMobile?"font-size: 28px; padding: 12px; min-height: 48px; min-width: 48px;":""}">&times;</button>
                </div>
                <div class="modal-body" style="${this.isMobile?"padding-bottom: 150px;":""}">
                    <div id="system-creator-form">
                        <div class="form-group">
                            <label for="system-name">System Name:</label>
                            <input type="text" id="system-name" placeholder="Enter a name for your star system" style="${this.isMobile?"font-size: 16px; padding: 14px; height: 48px;":""}">
                        </div>
                        
                        <div class="form-group">
                            <label for="skybox-description">Skybox Description:</label>
                            <textarea id="skybox-description" rows="${this.isMobile?"3":"4"}" placeholder="Describe the skybox/space environment (e.g., 'A vibrant nebula with blue and purple clouds, dotted with bright stars')" style="${this.isMobile?"font-size: 16px; padding: 14px;":""}"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="star-class">Star Class:</label>
                            <select id="star-class" class="form-control" style="${this.isMobile?"font-size: 16px; padding: 14px; height: 48px;":""}">
                                <option value="O">O - Blue Giant (Hot, Blue)</option>
                                <option value="B">B - Blue-White</option>
                                <option value="A">A - White</option>
                                <option value="F">F - Yellow-White</option>
                                <option value="G" selected>G - Yellow (Sun-like)</option>
                                <option value="K">K - Orange</option>
                                <option value="M">M - Red Dwarf</option>
                            </select>
                            <p class="help-text">Different star classes affect the lighting and appearance of your system.</p>
                        </div>
                        
                        <div id="planet-descriptions">
                            <div class="form-group planet-input">
                                <h3>Planet 1</h3>
                                <label for="planet-name-1">Planet Name:</label>
                                <input type="text" id="planet-name-1" placeholder="Enter a name for this planet" style="${this.isMobile?"font-size: 16px; padding: 14px; height: 48px;":""}">
                                
                                <label for="planet-description-1">Planet Description:</label>
                                <textarea id="planet-description-1" rows="${this.isMobile?"2":"3"}" placeholder="Describe the planet (e.g., 'A rocky planet with large oceans and ice caps')" style="${this.isMobile?"font-size: 16px; padding: 14px;":""}"></textarea>
                                
                                <div class="planet-properties">
                                    <div class="property-row">
                                        <label for="planet-size-1">Size:</label>
                                        <input type="range" id="planet-size-1" min="300" max="1000" value="450" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                                        <span class="slider-value" id="planet-size-value-1">450</span>
                                    </div>
                                    
                                    <div class="property-row">
                                        <label for="planet-distance-1">Distance from Star:</label>
                                        <input type="range" id="planet-distance-1" min="4000" max="60000" value="8000" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                                        <span class="slider-value" id="planet-distance-value-1">8000</span>
                                    </div>
                                    
                                    <div class="property-row">
                                        <label for="planet-speed-1">Orbit Speed:</label>
                                        <input type="range" id="planet-speed-1" min="1" max="10" value="5" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                                        <span class="slider-value" id="planet-speed-value-1">0.0015</span>
                                    </div>
                                    
                                    <div class="property-row" style="${this.isMobile?"margin-top: 15px;":""}">
                                        <label for="planet-rings-1">Has Rings:</label>
                                        <input type="checkbox" id="planet-rings-1" style="${this.isMobile?"transform: scale(1.7); margin: 0 15px; min-height: 24px; min-width: 24px;":""}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="add-planet-btn" class="secondary-btn" style="${this.isMobile?"min-height: 50px; padding: 14px; font-size: 16px; width: 100%; margin: 15px 0;":""}">+ Add Another Planet</button>
                        
                        <div class="form-actions">
                            <button id="generate-system-btn" class="primary-btn" style="${this.isMobile?"min-height: 54px; padding: 16px; font-size: 18px; margin-top: 20px; width: 100%;":""}">Generate System</button>
                        </div>
                    </div>
                    
                    <div id="generation-progress" style="display: none;">
                        <h3>Generating your star system...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <p id="generation-status">Initializing...</p>
                    </div>
                    
                    <div id="system-preview" style="display: none;">
                        <h3>Preview</h3>
                        <div class="preview-container" style="${this.isMobile?"flex-direction: column;":""}">
                            <div class="skybox-preview" style="${this.isMobile?"width: 100%; margin-bottom: 20px;":""}">
                                <h4>Skybox</h4>
                                <img id="skybox-preview-img" src="" alt="Skybox Preview">
                            </div>
                            <div class="planets-preview" id="planets-preview" style="${this.isMobile?"width: 100%;":""}">
                                <!-- Planet previews will be added here dynamically -->
                            </div>
                        </div>
                        <div class="form-actions" style="${this.isMobile?"padding-bottom: 30px;":""}">
                            <button id="travel-to-system-btn" class="primary-btn" style="${this.isMobile?"min-height: 54px; padding: 16px; font-size: 18px; width: 100%; margin-top: 20px;":""}">Travel to System</button>
                            <button id="regenerate-system-btn" class="secondary-btn" style="${this.isMobile?"min-height: 48px; padding: 14px; font-size: 16px; width: 100%; margin-top: 15px;":""}">Regenerate</button>
                        </div>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(this.container),this.systemNameInput=document.getElementById("system-name"),this.skyboxDescription=document.getElementById("skybox-description"),this.planetDescriptions=document.getElementById("planet-descriptions"),this.addPlanetBtn=document.getElementById("add-planet-btn"),this.generateSystemBtn=document.getElementById("generate-system-btn"),this.generationProgress=document.getElementById("generation-progress"),this.generationStatus=document.getElementById("generation-status"),this.systemForm=document.getElementById("system-creator-form"),this.systemPreview=document.getElementById("system-preview"),this.skyboxPreviewImg=document.getElementById("skybox-preview-img"),this.planetsPreview=document.getElementById("planets-preview"),this.travelToSystemBtn=document.getElementById("travel-to-system-btn"),this.regenerateSystemBtn=document.getElementById("regenerate-system-btn"),this.isMobile&&this.addMobileStyles()}addMobileStyles(){if(!document.getElementById("custom-system-creator-mobile-styles")){const e=document.createElement("style");e.id="custom-system-creator-mobile-styles",e.innerHTML=`
                @media (max-width: 900px) {
                    /* Mobile-specific styles for CustomSystemCreator */
                    #custom-system-creator .modal-content {
                        border-radius: 10px;
                        padding-bottom: 120px;
                    }
                    
                    #custom-system-creator .form-group {
                        margin-bottom: 24px;
                    }
                    
                    #custom-system-creator label {
                        font-size: 16px;
                        margin-bottom: 10px;
                        display: block;
                    }
                    
                    #custom-system-creator .property-row {
                        flex-direction: column;
                        align-items: flex-start;
                        margin-bottom: 20px;
                    }
                    
                    #custom-system-creator .property-row label {
                        margin-bottom: 10px;
                        width: 100%;
                    }
                    
                    #custom-system-creator .slider {
                        width: 100%;
                        margin: 10px 0;
                    }
                    
                    #custom-system-creator .slider-value {
                        margin-top: 5px;
                        align-self: flex-end;
                    }
                    
                    #custom-system-creator .planet-input {
                        padding: 20px;
                        margin-bottom: 30px;
                    }
                    
                    #custom-system-creator input[type="text"],
                    #custom-system-creator textarea,
                    #custom-system-creator select {
                        font-size: 16px !important;
                        padding: 14px !important;
                    }
                    
                    #custom-system-creator .planet-preview {
                        flex: 0 0 100%;
                        margin-bottom: 15px;
                    }
                    
                    #custom-system-creator .form-actions {
                        text-align: center;
                    }
                    
                    /* Better slider for touch */
                    #custom-system-creator input[type="range"] {
                        -webkit-appearance: none;
                        height: 30px;
                        background: #0d1e2f;
                        border-radius: 15px;
                        padding: 0;
                        outline: none;
                    }
                    
                    #custom-system-creator input[type="range"]::-webkit-slider-thumb {
                        -webkit-appearance: none;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        background: #4a9dff;
                        cursor: pointer;
                    }
                    
                    #custom-system-creator input[type="range"]::-moz-range-thumb {
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        background: #4a9dff;
                        cursor: pointer;
                        border: none;
                    }
                    
                    /* Touch ripple effect for buttons */
                    .ripple {
                        position: relative;
                        overflow: hidden;
                        transform: translate3d(0, 0, 0);
                    }
                    
                    .ripple:after {
                        content: "";
                        display: block;
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        top: 0;
                        left: 0;
                        pointer-events: none;
                        background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
                        background-repeat: no-repeat;
                        background-position: 50%;
                        transform: scale(10, 10);
                        opacity: 0;
                        transition: transform .5s, opacity 1s;
                    }
                    
                    .ripple:active:after {
                        transform: scale(0, 0);
                        opacity: .3;
                        transition: 0s;
                    }
                    
                    /* Character counter for text areas */
                    .char-counter {
                        font-size: 12px;
                        color: #aaa;
                        text-align: right;
                        margin-top: 5px;
                    }
                    
                    .char-counter.warning {
                        color: #ff9900;
                    }
                    
                    .char-counter.error {
                        color: #ff3030;
                    }
                }
            `,document.head.appendChild(e)}this.addRippleEffect(),this.addCharacterCounters()}addRippleEffect(){if(!this.isMobile)return;this.container.querySelectorAll("button").forEach(t=>{t.classList.contains("ripple")||t.classList.add("ripple")})}addCharacterCounters(){if(!this.isMobile)return;this.addCharacterCounter(this.skyboxDescription,250);const e=document.getElementById("planet-description-1");e&&this.addCharacterCounter(e,150)}addCharacterCounter(e,t){if(!e)return;const s=document.createElement("div");s.className="char-counter";const i=()=>{const o=t-e.value.length;s.textContent=`${o} characters remaining`,s.className="char-counter",o<30&&s.classList.add("warning"),o<10&&s.classList.add("error"),o<0&&(e.value=e.value.substring(0,t),s.textContent="0 characters remaining")};e.addEventListener("input",i),e.addEventListener("keydown",o=>{e.value.length>=t&&o.key!=="Backspace"&&o.key!=="Delete"&&o.key!=="ArrowLeft"&&o.key!=="ArrowRight"&&!o.ctrlKey&&!o.metaKey&&o.preventDefault()}),i(),e.parentNode.insertBefore(s,e.nextSibling),e.setAttribute("maxlength",t.toString())}setupEventHandlers(){const e=document.getElementById("close-system-creator");if(e.addEventListener("click",()=>{this.hide(),this.playUISound()}),this.isMobile){e.addEventListener("touchend",s=>{s.preventDefault(),this.hide(),this.playUISound()}),this.container.addEventListener("touchmove",s=>{s.stopPropagation()},{passive:!0});const t=this.container.querySelector(".modal-content");t&&(t.addEventListener("touchstart",()=>{},{passive:!0}),t.addEventListener("touchmove",()=>{},{passive:!0}))}this.addPlanetBtn.addEventListener("click",()=>{this.addPlanetInput(),this.playUISound()}),this.isMobile&&this.addPlanetBtn.addEventListener("touchend",t=>{t.preventDefault(),this.addPlanetInput(),this.playUISound()}),this.generateSystemBtn.addEventListener("click",()=>{this.generateSystem(),this.playUISound()}),this.isMobile&&this.generateSystemBtn.addEventListener("touchend",t=>{t.preventDefault(),this.generateSystem(),this.playUISound()}),this.travelToSystemBtn.addEventListener("click",()=>{this.travelToSystem(),this.playUISound()}),this.isMobile&&this.travelToSystemBtn.addEventListener("touchend",t=>{t.preventDefault(),this.travelToSystem(),this.playUISound()}),this.regenerateSystemBtn.addEventListener("click",()=>{this.systemPreview.style.display="none",this.systemForm.style.display="block",this.playUISound()}),this.isMobile&&this.regenerateSystemBtn.addEventListener("touchend",t=>{t.preventDefault(),this.systemPreview.style.display="none",this.systemForm.style.display="block",this.playUISound()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.isVisible&&this.hide()}),this.container.addEventListener("click",t=>{t.target===this.container&&this.hide()}),this.isMobile&&this.container.addEventListener("touchstart",t=>{t.target===this.container&&(t.preventDefault(),this.hide())},{passive:!1})}addPlanetInput(){const t=this.planetDescriptions.getElementsByClassName("planet-input").length+1,s=document.createElement("div");s.className="form-group planet-input",s.innerHTML=`
            <h3>Planet ${t}</h3>
            <label for="planet-name-${t}">Planet Name:</label>
            <input type="text" id="planet-name-${t}" placeholder="Enter a name for this planet" style="${this.isMobile?"font-size: 16px; padding: 14px; height: 48px;":""}">
            
            <label for="planet-description-${t}">Planet Description:</label>
            <textarea id="planet-description-${t}" rows="${this.isMobile?"2":"3"}" placeholder="Describe the planet (e.g., 'A rocky planet with large oceans and ice caps')" style="${this.isMobile?"font-size: 16px; padding: 14px;":""}" maxlength="150"></textarea>
            
            <div class="planet-properties">
                <div class="property-row">
                    <label for="planet-size-${t}">Size:</label>
                    <input type="range" id="planet-size-${t}" min="300" max="1000" value="450" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                    <span class="slider-value" id="planet-size-value-${t}">450</span>
                </div>
                
                <div class="property-row">
                    <label for="planet-distance-${t}">Distance from Star:</label>
                    <input type="range" id="planet-distance-${t}" min="4000" max="60000" value="${4e3+t*6e3}" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                    <span class="slider-value" id="planet-distance-value-${t}">${4e3+t*6e3}</span>
                </div>
                
                <div class="property-row">
                    <label for="planet-speed-${t}">Orbit Speed:</label>
                    <input type="range" id="planet-speed-${t}" min="1" max="10" value="5" class="slider" style="${this.isMobile?"height: 30px; margin: 10px 0;":""}">
                    <span class="slider-value" id="planet-speed-value-${t}">0.0015</span>
                </div>
                
                <div class="property-row" style="${this.isMobile?"margin-top: 15px;":""}">
                    <label for="planet-rings-${t}">Has Rings:</label>
                    <input type="checkbox" id="planet-rings-${t}" style="${this.isMobile?"transform: scale(1.7); margin: 0 15px; min-height: 24px; min-width: 24px;":""}">
                </div>
            </div>
            
            <button class="remove-planet-btn danger-btn ${this.isMobile?"ripple":""}" style="${this.isMobile?"min-height: 50px; padding: 14px; font-size: 16px; right: 15px; top: 15px;":""}">Remove</button>
        `,this.planetDescriptions.appendChild(s),this.setupSliderListeners(t);const i=s.querySelector(".remove-planet-btn");if(i.addEventListener("click",()=>{s.remove(),this.updatePlanetNumbers(),this.playUISound()}),this.isMobile){i.addEventListener("touchend",a=>{a.preventDefault(),s.remove(),this.updatePlanetNumbers(),this.playUISound()}),s.querySelectorAll('input[type="range"]').forEach(a=>{a.addEventListener("touchstart",()=>{a.classList.add("slider-active")}),a.addEventListener("touchend",()=>{a.classList.remove("slider-active")})});const n=s.querySelector('textarea[id^="planet-description-"]');n&&this.addCharacterCounter(n,150)}this.isMobile&&(this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{try{const o=this.container.querySelector(".modal-content"),n=this.planetDescriptions.lastElementChild;if(o&&n){const r=n.offsetTop-o.clientHeight/4;o.scrollTo({top:r,behavior:"smooth"})}}catch(o){console.warn("Error during scroll:",o)}},100))}setupSliderListeners(e){const t=document.getElementById(`planet-size-${e}`),s=document.getElementById(`planet-size-value-${e}`);t.addEventListener("input",()=>{s.textContent=t.value});const i=document.getElementById(`planet-distance-${e}`),o=document.getElementById(`planet-distance-value-${e}`);i.addEventListener("input",()=>{o.textContent=i.value});const n=document.getElementById(`planet-speed-${e}`),a=document.getElementById(`planet-speed-value-${e}`);n.addEventListener("input",()=>{const r=.001+(n.value-1)*.00011111111111111112;a.textContent=r.toFixed(4)}),this.isMobile&&[t,i,n].forEach(l=>{l.addEventListener("touchstart",()=>{l.classList.add("slider-active")}),l.addEventListener("touchend",()=>{l.classList.remove("slider-active")})})}updatePlanetNumbers(){const e=this.planetDescriptions.getElementsByClassName("planet-input");for(let t=0;t<e.length;t++){const i=e[t].querySelector("h3");i.textContent=`Planet ${t+1}`}}async generateSystem(){const e=this.systemNameInput.value.trim(),t=this.skyboxDescription.value.trim(),s=document.getElementById("star-class").value;if(!e||!t){this.showMobileAlert("Please enter a system name and skybox description.");return}this.systemForm.style.display="none",this.generationProgress.style.display="block",this.isGenerating=!0;try{this.apiClient.hasValidToken()||(this.updateGenerationStatus("Authenticating..."),await this.apiClient.getToken()),this.updateGenerationStatus("Generating skybox...");const i=await this.apiClient.generateSkybox(e,t);if(!i.success)throw new Error(i.message||"Failed to generate skybox");if(!i.image_paths||i.image_paths.length===0)throw new Error("No skybox images were generated");this.generatedSkyboxUrl=i.image_paths[0];const o=[],n=this.planetDescriptions.getElementsByClassName("planet-input");for(let a=0;a<n.length;a++){const r=n[a],l=a+1,c=r.querySelector('input[id^="planet-name-"]'),d=r.querySelector('textarea[id^="planet-description-"]'),h=r.querySelector('input[id^="planet-size-"]'),u=r.querySelector('input[id^="planet-distance-"]'),m=r.querySelector('input[id^="planet-speed-"]'),f=r.querySelector('input[id^="planet-rings-"]'),g=c.value.trim(),b=d.value.trim();if(g&&b){const v=.001+(parseFloat(m.value)-1)*(.001/9);o.push({name:g,description:b,size:parseInt(h.value),distance:parseInt(u.value),speed:v,rings:f.checked})}}this.generatedPlanetUrls=[];for(let a=0;a<o.length;a++){const r=o[a];this.updateGenerationStatus(`Generating planet ${a+1} of ${o.length}: ${r.name}...`);const l=await this.apiClient.generatePlanet(r.name,r.description);l.success&&l.image_paths&&l.image_paths.length>0&&this.generatedPlanetUrls.push({name:r.name,url:l.image_paths[0]})}this.systemData={id:`Custom-${Date.now()}`,name:e,starClass:s,classification:"Custom",description:`Custom star system with ${o.length} planets`,skyboxUrl:this.generatedSkyboxUrl,lightIntensityMultiplier:.8,planetData:o.map((a,r)=>{var l;return{name:a.name,textureUrl:((l=this.generatedPlanetUrls[r])==null?void 0:l.url)||null,size:a.size,distance:a.distance,speed:a.speed,color:this.getStarColorForClass(s),rings:a.rings}})},this.showSystemPreview()}catch(i){console.error("Error generating system:",i),this.showMobileAlert(`Failed to generate system: ${i.message}`),this.generationProgress.style.display="none",this.systemForm.style.display="block"}this.isGenerating=!1}showSystemPreview(){this.generatedSkyboxUrl&&(this.skyboxPreviewImg.src=this.apiClient.getFullImageUrl(this.generatedSkyboxUrl)),this.planetsPreview.innerHTML="",this.generatedPlanetUrls.forEach(e=>{const t=document.createElement("div");t.className="planet-preview",t.innerHTML=`
                <h4>${e.name}</h4>
                <img src="${this.apiClient.getFullImageUrl(e.url)}" alt="${e.name}">
            `,this.planetsPreview.appendChild(t)}),this.generationProgress.style.display="none",this.systemPreview.style.display="block",this.isMobile&&setTimeout(()=>{this.systemPreview.scrollIntoView({behavior:"smooth",block:"start"})},50)}travelToSystem(){if(!this.systemData){this.showMobileAlert("No system data available. Please generate a system first.");return}try{if(!this.starSystemGenerator.addCustomSystem(this.systemData))throw new Error("Failed to add custom system");this.hide(),this.environment&&this.environment.travelToSystem?this.environment.travelToSystem(this.systemData.id):console.error("Environment or travelToSystem method not available")}catch(e){console.error("Error traveling to custom system:",e),this.showMobileAlert(`Failed to travel to custom system: ${e.message}`)}}updateGenerationStatus(e){this.generationStatus&&(this.generationStatus.textContent=e,console.log("Generation status:",e))}getStarColorForClass(e){return{O:10203391,B:11190271,A:13293567,F:16316415,G:16774378,K:16765601,M:16764015}[e]||16774378}showMobileAlert(e){if(this.isMobile){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="10000";const s=document.createElement("div");s.style.backgroundColor="#0a1a2a",s.style.color="#c5d8f1",s.style.padding="20px",s.style.borderRadius="10px",s.style.maxWidth="80%",s.style.textAlign="center",s.style.border="2px solid #2c5a8c";const i=document.createElement("p");i.textContent=e,i.style.marginBottom="20px",i.style.fontSize="16px";const o=document.createElement("button");o.textContent="OK",o.style.padding="12px 30px",o.style.fontSize="16px",o.style.backgroundColor="#2c5a8c",o.style.color="white",o.style.border="none",o.style.borderRadius="5px",o.style.minHeight="48px",o.style.minWidth="120px",s.appendChild(i),s.appendChild(o),t.appendChild(s),document.body.appendChild(t),this.playUISound(),o.addEventListener("click",()=>{document.body.removeChild(t)}),o.addEventListener("touchend",n=>{n.preventDefault(),document.body.removeChild(t),this.playUISound()})}else alert(e)}playUISound(){window.game&&window.game.audio&&window.game.audio.playSound("boink")}show(){if(this.container){if(this.cleanupBeforeHiding(),this.container.style.display="flex",this.isVisible=!0,this.systemForm.style.display="block",this.generationProgress.style.display="none",this.systemPreview.style.display="none",this.playUISound(),this.isMobile){const e=this.container.querySelector(".modal-content");e&&(e.scrollTop=0,e.style.overflowY="auto",e.style.webkitOverflowScrolling="touch",e.style.overscrollBehavior="contain"),document.body.classList.add("modal-open"),this.scrollTimeout=setTimeout(()=>{this.systemNameInput&&this.systemNameInput.focus()},300)}else setTimeout(()=>{this.systemNameInput&&this.systemNameInput.focus()},300);if(!document.getElementById("modal-open-style")&&this.isMobile){const e=document.createElement("style");e.id="modal-open-style",e.textContent=`
                    .modal-open {
                        overflow: hidden;
                        position: fixed;
                        width: 100%;
                        height: 100%;
                    }
                `,document.head.appendChild(e)}if(!document.getElementById("custom-system-creator-styles")){const e=document.createElement("style");e.id="custom-system-creator-styles",e.textContent=`
                    .property-row {
                        display: flex;
                        align-items: center;
                        margin-bottom: 10px;
                    }
                    
                    .property-row label {
                        flex: 0 0 150px;
                        margin-right: 10px;
                    }
                    
                    .property-row .slider {
                        flex: 1;
                        height: 10px;
                        background: #2a2a2a;
                        outline: none;
                        border-radius: 5px;
                    }
                    
                    .property-row .slider-value {
                        flex: 0 0 60px;
                        margin-left: 10px;
                        text-align: right;
                    }
                    
                    .planet-properties {
                        background: rgba(0, 0, 0, 0.2);
                        padding: 15px;
                        border-radius: 5px;
                        margin-top: 10px;
                        margin-bottom: 15px;
                    }
                    
                    .help-text {
                        font-size: 12px;
                        color: #aaa;
                        margin-top: 5px;
                    }
                    
                    select.form-control {
                        width: 100%;
                        padding: 8px;
                        border-radius: 4px;
                        background: #25303e;
                        color: white;
                        border: 1px solid #3a5472;
                    }
                    
                    /* Active slider styles */
                    .slider-active {
                        background: #3a5472 !important;
                    }
                    
                    /* Add smooth transitions */
                    #custom-system-creator button {
                        transition: all 0.2s ease;
                    }
                    
                    #custom-system-creator button:active {
                        transform: scale(0.95);
                    }
                `,document.head.appendChild(e)}}}hide(){this.container&&!this.isGenerating&&(this.cleanupBeforeHiding(),this.container.style.display="none",this.isVisible=!1,this.playUISound(),setTimeout(()=>{if(window.game&&window.game.ui&&window.game.ui.stargateInterface)console.log("CustomSystemCreator: Returning to stargate UI"),window.game.ui.stargateInterface.showStargateUI();else{const e=document.getElementById("stargate-ui");e?(e.style.display="block",console.log("CustomSystemCreator: Showed stargate UI via direct DOM access")):console.warn("CustomSystemCreator: Could not find stargate UI to return to")}},100))}toggle(){this.isVisible?this.hide():this.show()}cleanupBeforeHiding(){this.isGenerating&&(this.isGenerating=!1,this.generationProgress.style.display="none",this.systemForm.style.display="block"),this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null),document.body.style.pointerEvents="auto",this.isMobile&&(document.body.style.touchAction="auto",this.container.style.display="none",this.container.offsetHeight)}destroy(){this.cleanupBeforeHiding(),document.body.classList.remove("modal-open"),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}class Li{constructor(e,t){this.scene=e,this.spaceship=t,this.startPortalGroup=null,this.exitPortalGroup=null,this.startPortalBox=null,this.exitPortalBox=null,this.startPortalParticleSystem=null,this.exitPortalParticleSystem=null,this.shouldCreateStartPortal=new URLSearchParams(window.location.search).has("portal"),this.refUrl=new URLSearchParams(window.location.search).get("ref")||"",this.init()}init(){this.shouldCreateStartPortal&&this.createStartPortal(),this.createExitPortal()}createStartPortal(){this.startPortalGroup=new O,this.startPortalGroup.name="startPortal";const e=new ne(150,15,32,100),t=new R({color:16711680,emissive:16711680,emissiveIntensity:.5,roughness:.3,metalness:.7}),s=new C(e,t);this.startPortalGroup.add(s);const i=new it(135,32),o=new F({color:16711680,transparent:!0,opacity:.3,side:K}),n=new C(i,o);n.position.z=.1,this.startPortalGroup.add(n);const a=500,r=new j,l=new Float32Array(a*3);for(let d=0;d<a;d++){const h=d/a*Math.PI*2,u=135+(Math.random()*30-15);l[d*3]=Math.cos(h)*u,l[d*3+1]=Math.sin(h)*u,l[d*3+2]=(Math.random()-.5)*15}r.setAttribute("position",new _(l,3));const c=new te({color:16733525,size:3.5,blending:$,transparent:!0});this.startPortalParticleSystem=new Z(r,c),this.startPortalGroup.add(this.startPortalParticleSystem),this.startPortalGroup.position.set(0,15e3,0),this.startPortalGroup.rotation.x=Math.PI/2,this.scene.add(this.startPortalGroup),this.startPortalBox=new ze().setFromObject(this.startPortalGroup),console.log("Start portal created at position:",this.startPortalGroup.position)}createExitPortal(){this.exitPortalGroup=new O,this.exitPortalGroup.name="exitPortal";const e=new ne(150,15,32,100),t=new R({color:65280,emissive:65280,emissiveIntensity:.5,roughness:.3,metalness:.7}),s=new C(e,t);this.exitPortalGroup.add(s);const i=new it(135,32),o=new F({color:65280,transparent:!0,opacity:.3,side:K}),n=new C(i,o);n.position.z=.1,this.exitPortalGroup.add(n);const a=500,r=new j,l=new Float32Array(a*3);for(let b=0;b<a;b++){const w=b/a*Math.PI*2,v=135+(Math.random()*30-15);l[b*3]=Math.cos(w)*v,l[b*3+1]=Math.sin(w)*v,l[b*3+2]=(Math.random()-.5)*15}r.setAttribute("position",new _(l,3));const c=new te({color:5635925,size:3.5,blending:$,transparent:!0});this.exitPortalParticleSystem=new Z(r,c),this.exitPortalGroup.add(this.exitPortalParticleSystem);const d=document.createElement("canvas");d.width=1024,d.height=256;const h=d.getContext("2d");h.fillStyle="black",h.fillRect(0,0,d.width,d.height),h.font="72px Arial",h.fillStyle="#00ff00",h.textAlign="center",h.textBaseline="middle",h.fillText("VIBEVERSE PORTAL",d.width/2,d.height/2);const u=new Es(d),m=new Ms(200,50),f=new F({map:u,transparent:!0,side:K}),g=new C(m,f);g.position.set(0,200,0),this.exitPortalGroup.add(g),this.exitPortalGroup.position.set(0,16e3,0),this.exitPortalGroup.rotation.x=Math.PI/2,this.scene.add(this.exitPortalGroup),this.exitPortalBox=new ze().setFromObject(this.exitPortalGroup),console.log("Exit portal created at position:",this.exitPortalGroup.position)}animateStartPortal(e){!this.startPortalGroup||!this.startPortalParticleSystem||(this.startPortalParticleSystem.rotation.z+=e*.5,Math.random()<.05&&this.startPortalBox.setFromObject(this.startPortalGroup))}animateExitPortal(e){!this.exitPortalGroup||!this.exitPortalParticleSystem||(this.exitPortalParticleSystem.rotation.z+=e*.5,Math.random()<.05&&this.exitPortalBox.setFromObject(this.exitPortalGroup))}checkPortalInteractions(e){if(!this.spaceship||!this.spaceship.mesh)return;const t=new ze().setFromObject(this.spaceship.mesh);this.startPortalGroup&&this.startPortalBox&&this.spaceship.mesh.position.distanceTo(this.startPortalGroup.position)<400&&t.intersectsBox(this.startPortalBox)&&this.handleStartPortalEntry(),this.exitPortalGroup&&this.exitPortalBox&&this.spaceship.mesh.position.distanceTo(this.exitPortalGroup.position)<400&&t.intersectsBox(this.exitPortalBox)&&this.handleExitPortalEntry()}handleStartPortalEntry(){if(this._isRedirecting)return;this._isRedirecting=!0,console.log("Player entered start portal");let e=this.refUrl;if(e&&!e.startsWith("http")&&(e="https://"+e),!e){console.error("No target URL specified for portal"),this._isRedirecting=!1;return}const t=new URLSearchParams(window.location.search);t.delete("ref"),t.delete("portal");let s;try{s=new URL(e);for(const[i,o]of t.entries())s.searchParams.append(i,o)}catch{console.error("Invalid target URL:",e),this._isRedirecting=!1;return}console.log("Redirecting to:",s.toString()),setTimeout(()=>{window.location.href=s.toString()},100)}handleExitPortalEntry(){if(this._isRedirecting)return;this._isRedirecting=!0,console.log("Player entered exit portal");let e="https://portal.pieter.com";const t=new URLSearchParams(window.location.search),s=new URL(e);s.searchParams.append("portal","true"),s.searchParams.append("username",this.getUsername()),s.searchParams.append("color","white"),s.searchParams.append("speed",this.getPlayerSpeed());for(const[i,o]of t.entries())["portal","username","color","speed"].includes(i)||s.searchParams.append(i,o);console.log("Redirecting to:",s.toString()),setTimeout(()=>{window.location.href=s.toString()},100)}getUsername(){return window.game&&window.game.selfUsername?window.game.selfUsername:`Miner${Math.floor(Math.random()*1e4)}`}getPlayerSpeed(){return window.game&&window.game.currentSpeed?window.game.currentSpeed.toString():this.spaceship&&this.spaceship.velocity?this.spaceship.velocity.length().toString():"10"}update(e){this.animateStartPortal(e),this.animateExitPortal(e),this.checkPortalInteractions(e)}dispose(){this.startPortalGroup&&this.scene.remove(this.startPortalGroup),this.exitPortalGroup&&this.scene.remove(this.exitPortalGroup),this.startPortalGroup=null,this.exitPortalGroup=null,this.startPortalBox=null,this.exitPortalBox=null,this.startPortalParticleSystem=null,this.exitPortalParticleSystem=null}}class Fi{constructor(e){this.scene=e,this.anomalies=[],this.minRadius=32e3,this.maxRadius=45e3,this.width=3e3,this.anomalyScale=4,this.orbScale=4,this.orbValues={common:100,uncommon:500,rare:1500,epic:5e3,legendary:15e3},this.spawnTimer=0,this.checkInterval=60,this.spawnChance=.5,this.despawnChance=.3,this.anomalyTypes=["vortex","crystalCluster","nebulaNexus","quantumFlux","darkMatter"],this.maxAnomalies=5,this.updateAnomalyCountDisplay()}checkAnomalySpawning(e){if(this.spawnTimer+=e,this.spawnTimer>=this.checkInterval){if(this.spawnTimer-=this.checkInterval,this.anomalies.length<this.maxAnomalies&&Math.random()<this.spawnChance){const s=this.anomalyTypes.filter(i=>!this.anomalies.some(o=>o.type===i));if(s.length>0){const i=s[Math.floor(Math.random()*s.length)];this.spawnAnomaly(i),this.updateAnomalyCountDisplay()}}const t=[];this.anomalies.forEach(s=>{Math.random()<this.despawnChance&&t.push(s)}),t.length>0&&(t.forEach(s=>{this.despawnAnomaly(s)}),this.updateAnomalyCountDisplay())}}spawnAnomaly(e){switch(console.log(`Spawning ${e} anomaly`),e){case"vortex":this.createVortexAnomaly();break;case"crystalCluster":this.createCrystalClusterAnomaly();break;case"nebulaNexus":this.createNebulaNexusAnomaly();break;case"quantumFlux":this.createQuantumFluxAnomaly();break;case"darkMatter":this.createDarkMatterAnomaly();break}}despawnAnomaly(e){switch(console.log(`Despawning ${e.type} anomaly`),this.scene.remove(e.mesh),e.type){case"vortex":e.rings&&e.rings.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose())});break;case"crystalCluster":e.crystals&&e.crystals.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose())});break;case"nebulaNexus":e.rings&&e.rings.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose())}),e.core&&e.core.mesh&&(e.core.mesh.geometry&&e.core.mesh.geometry.dispose(),e.core.mesh.material&&(Array.isArray(e.core.mesh.material)?e.core.mesh.material.forEach(s=>s.dispose()):e.core.mesh.material.dispose())),e.arcs&&e.arcs.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose())});break;case"quantumFlux":e.frames&&e.frames.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose()),s.innerBox&&(s.innerBox.geometry&&s.innerBox.geometry.dispose(),s.innerBox.material&&(Array.isArray(s.innerBox.material)?s.innerBox.material.forEach(i=>i.dispose()):s.innerBox.material.dispose()))}),e.particles&&e.particles.mesh&&(e.particles.mesh.geometry&&e.particles.mesh.geometry.dispose(),e.particles.mesh.material&&(Array.isArray(e.particles.mesh.material)?e.particles.mesh.material.forEach(s=>s.dispose()):e.particles.mesh.material.dispose()));break;case"darkMatter":e.core&&e.core.mesh&&(e.core.mesh.geometry&&e.core.mesh.geometry.dispose(),e.core.mesh.material&&(Array.isArray(e.core.mesh.material)?e.core.mesh.material.forEach(s=>s.dispose()):e.core.mesh.material.dispose())),e.rings&&e.rings.forEach(s=>{s.mesh&&s.mesh.geometry&&s.mesh.geometry.dispose(),s.mesh&&s.mesh.material&&(Array.isArray(s.mesh.material)?s.mesh.material.forEach(i=>i.dispose()):s.mesh.material.dispose())}),e.particles&&e.particles.mesh&&(e.particles.mesh.geometry&&e.particles.mesh.geometry.dispose(),e.particles.mesh.material&&(Array.isArray(e.particles.mesh.material)?e.particles.mesh.material.forEach(s=>s.dispose()):e.particles.mesh.material.dispose()));break}e.orb&&e.orb.mesh&&(e.orb.mesh.geometry&&e.orb.mesh.geometry.dispose(),e.orb.mesh.material&&(Array.isArray(e.orb.mesh.material)?e.orb.mesh.material.forEach(s=>s.dispose()):e.orb.mesh.material.dispose()));const t=this.anomalies.indexOf(e);t!==-1&&this.anomalies.splice(t,1)}updateAnomalyCountDisplay(){const e=document.getElementById("anomaly-count");e&&(e.textContent=this.anomalies.length.toString())}getActiveAnomalyCount(){return this.anomalies.length}update(e){this.checkAnomalySpawning(e);let t=null;window.game&&window.game.spaceship&&window.game.spaceship.mesh&&(t=window.game.spaceship.mesh.position);for(let s=0;s<this.anomalies.length;s++){const i=this.anomalies[s];if(i.orbCollected){i.mesh&&i.rotationSpeed&&(i.mesh.rotation.x+=i.rotationSpeed.x*e,i.mesh.rotation.y+=i.rotationSpeed.y*e,i.mesh.rotation.z+=i.rotationSpeed.z*e);continue}let o=!1;switch(t&&(o=t.distanceTo(i.position)<i.orb.size*3*this.orbScale),i.mesh&&i.rotationSpeed&&(i.mesh.rotation.x+=i.rotationSpeed.x*e,i.mesh.rotation.y+=i.rotationSpeed.y*e,i.mesh.rotation.z+=i.rotationSpeed.z*e),i.type){case"vortex":this.updateVortexAnomaly(i,e);break;case"crystalCluster":this.updateCrystalClusterAnomaly(i,e);break;case"nebulaNexus":this.updateNebulaNexusAnomaly(i,e);break;case"quantumFlux":this.updateQuantumFluxAnomaly(i,e);break;case"darkMatter":this.updateDarkMatterAnomaly(i,e);break}this.updateOrbEffects(i,o)}}createVortexAnomaly(){const e=this.getRandomAnomalyPosition(),t=new O;t.position.copy(e),t.scale.set(this.anomalyScale,this.anomalyScale,this.anomalyScale);const s=6,i=[];for(let a=0;a<s;a++){const r=400-a*50,l=new ne(r,15,16,100),c=.5+a*.05,d=new E().setHSL(c,.9,.6),h=new R({color:d,emissive:d.clone().multiplyScalar(.5),emissiveIntensity:1,metalness:.8,roughness:.2,transparent:!0,opacity:.95}),u=new C(l,h);u.rotation.x=Math.PI/2+a*.2,u.rotation.y=a*.3,t.add(u),i.push({mesh:u,rotationSpeed:{x:.005+a*.002,y:.003+a*.001,z:.001+a*5e-4}})}const o=this.getRandomOrbRarity(),n=this.createEnergyOrb(o);t.add(n.mesh),this.scene.add(t),this.anomalies.push({type:"vortex",mesh:t,position:e.clone(),rings:i,orb:n,collisionRadius:350,orbCollected:!1,rotationSpeed:new y(.001,.002,.0015)})}createCrystalClusterAnomaly(){const e=this.getRandomAnomalyPosition(),t=new O;t.position.copy(e),t.scale.set(this.anomalyScale,this.anomalyScale,this.anomalyScale);const s=[],i=20;for(let a=0;a<i;a++){const r=50+Math.random()*100;let l;const c=Math.floor(Math.random()*3);if(c===0)l=new st(r,0);else if(c===1)l=new Ts(r,0);else{l=new $t(r,0);const x=l.attributes.position;for(let S=0;S<x.count;S++){const M=new y;M.fromBufferAttribute(x,S),M.y*=2.5,x.setXYZ(S,M.x,M.y,M.z)}l.computeVertexNormals()}const d=.45+Math.random()*.1,h=.9+Math.random()*.1,u=.6+Math.random()*.2,m=new E().setHSL(d,h,u),f=new R({color:m,metalness:.9,roughness:.1,transparent:!0,opacity:.9,emissive:m.clone(),emissiveIntensity:.5}),g=new C(l,f),b=200+Math.random()*100,w=Math.random()*Math.PI*2,v=Math.random()*Math.PI;g.position.set(b*Math.sin(v)*Math.cos(w),b*Math.sin(v)*Math.sin(w),b*Math.cos(v)),g.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),t.add(g),s.push({mesh:g,initialPosition:g.position.clone(),floatPhase:Math.random()*Math.PI*2,floatSpeed:.3+Math.random()*.3,floatAmplitude:5+Math.random()*10,rotationSpeed:{x:(Math.random()-.5)*.01,y:(Math.random()-.5)*.01,z:(Math.random()-.5)*.01}})}const o=this.getRandomOrbRarity(),n=this.createEnergyOrb(o);t.add(n.mesh),this.scene.add(t),this.anomalies.push({type:"crystalCluster",mesh:t,position:e.clone(),crystals:s,orb:n,collisionRadius:300,orbCollected:!1,rotationSpeed:new y(5e-4,.001,5e-4)})}createNebulaNexusAnomaly(){const e=this.getRandomAnomalyPosition(),t=new O;t.position.copy(e),t.scale.set(this.anomalyScale,this.anomalyScale,this.anomalyScale);const s=3,i=[];for(let m=0;m<s;m++){const f=200+m*60,g=new ne(f,8,16,50),b=.6+m*.1,w=new E().setHSL(b,1,.6),v=new R({color:w,emissive:w.clone().multiplyScalar(.5),emissiveIntensity:1,metalness:.9,roughness:.1,transparent:!1,opacity:1}),x=new C(g,v);x.rotation.x=Math.PI/2+m*Math.PI/3,x.rotation.y=m*Math.PI/4,t.add(x);const S=10+m*5,M=[];for(let A=0;A<S;A++){const P=A/S*Math.PI*2,D=15+Math.random()*10,L=new st(D,0),re=(b+.5)%1,ie=new E().setHSL(re,1,.7),de=new R({color:ie,emissive:ie.clone(),emissiveIntensity:.8,metalness:.9,roughness:.1,transparent:!1,opacity:1}),U=new C(L,de);U.position.x=f*Math.cos(P),U.position.y=0,U.position.z=f*Math.sin(P),U.rotation.x=Math.random()*Math.PI,U.rotation.y=Math.random()*Math.PI,U.rotation.z=Math.random()*Math.PI,x.add(U),M.push({mesh:U,initialPosition:U.position.clone(),pulsePhase:Math.random()*Math.PI*2,pulseSpeed:.5+Math.random()*.5})}i.push({mesh:x,crystals:M,rotationSpeed:.1-m*.03,rotationAxis:new y(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize()})}const o=80,n=new G(o,32,32),a=new E().setHSL(.15,1,.6),r=new R({color:a,emissive:a,emissiveIntensity:1,metalness:1,roughness:.3,transparent:!0,opacity:.9}),l=new C(n,r);t.add(l);const c=8,d=[];for(let m=0;m<c;m++){const f=new ks(new y(0,0,0),new y((Math.random()-.5)*200,(Math.random()-.5)*200,(Math.random()-.5)*200),new y((Math.random()-.5)*300,(Math.random()-.5)*300,(Math.random()-.5)*300),new y((Math.random()-.5)*400,(Math.random()-.5)*400,(Math.random()-.5)*400)),g=f.getPoints(20),b=new j().setFromPoints(g),w=new E().setHSL(.15,1,.6),v=new Me({color:w,linewidth:3,transparent:!0,opacity:.8}),x=new Te(b,v);t.add(x),d.push({mesh:x,curve:f,updatePhase:Math.random()*Math.PI*2,updateSpeed:.2+Math.random()*.3})}const h=this.getRandomOrbRarity(),u=this.createEnergyOrb(h);t.add(u.mesh),this.scene.add(t),this.anomalies.push({type:"nebulaNexus",mesh:t,position:e.clone(),rings:i,core:{mesh:l,pulsePhase:0,pulseSpeed:.5},arcs:d,orb:u,collisionRadius:250,orbCollected:!1,rotationSpeed:new y(3e-4,4e-4,2e-4)})}createQuantumFluxAnomaly(){const e=this.getRandomAnomalyPosition(),t=new O;t.position.copy(e),t.scale.set(this.anomalyScale,this.anomalyScale,this.anomalyScale);const s=[],i=5;for(let u=0;u<i;u++){const m=250-u*40,f=new ee(m,m,m),g=new ee(m*.98,m*.98,m*.98),b=new As(f),w=.3+u*.1,v=new E().setHSL(w,1,.6),x=new Me({color:v,linewidth:2,transparent:!1,opacity:1}),S=new F({color:v,transparent:!0,opacity:.1,side:K}),M=new It(b,x),A=new C(g,S);t.add(M),t.add(A),s.push({mesh:M,innerBox:A,rotationAxis:new y(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),rotationSpeed:.01+u*.005,pulsePhase:Math.random()*Math.PI*2})}const o=200,n=new j,a=new Float32Array(o*3),r=new Float32Array(o);for(let u=0;u<o;u++){const m=u*3,f=100*Math.random(),g=Math.random()*Math.PI*2,b=Math.random()*Math.PI;a[m]=f*Math.sin(b)*Math.cos(g),a[m+1]=f*Math.sin(b)*Math.sin(g),a[m+2]=f*Math.cos(b),r[u]=2+Math.random()*3}n.setAttribute("position",new _(a,3)),n.setAttribute("size",new _(r,1));const l=new te({color:16711935,size:6,blending:$,transparent:!0,opacity:.9}),c=new Z(n,l);t.add(c);const d=this.getRandomOrbRarity(),h=this.createEnergyOrb(d);t.add(h.mesh),this.scene.add(t),this.anomalies.push({type:"quantumFlux",mesh:t,position:e.clone(),frames:s,particles:{mesh:c,positions:a,initialPositions:a.slice(),velocities:Array(o).fill().map(()=>new y((Math.random()-.5)*.5,(Math.random()-.5)*.5,(Math.random()-.5)*.5))},orb:h,collisionRadius:230,orbCollected:!1,rotationSpeed:new y(1e-4,2e-4,1e-4)})}createDarkMatterAnomaly(){const e=this.getRandomAnomalyPosition(),t=new O;t.position.copy(e),t.scale.set(this.anomalyScale,this.anomalyScale,this.anomalyScale);const s=100,i=new G(s,32,32),o=new R({color:3342387,emissive:8913032,emissiveIntensity:1.5,metalness:1,roughness:0,transparent:!0,opacity:.95}),n=new C(i,o),a=new G(s*1.2,32,32),r=new F({color:10027263,transparent:!0,opacity:.3,side:ke}),l=new C(a,r);n.add(l),t.add(n);const c=[],d=4;for(let x=0;x<d;x++){const S=150+x*60,M=4+x*2,A=new ne(S,M,16,100),P=new E().setHSL(.75,.9,.1+x*.15),D=new R({color:P,emissive:P.clone().multiplyScalar(.7),emissiveIntensity:.5+x*.2,metalness:.8,roughness:.2,transparent:!0,opacity:.85}),L=new C(A,D);L.rotation.x=Math.random()*Math.PI,L.rotation.y=Math.random()*Math.PI,L.rotation.z=Math.random()*Math.PI,t.add(L),c.push({mesh:L,rotationAxis:new y(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),rotationSpeed:.002+x*.001,warpPhase:Math.random()*Math.PI*2,warpSpeed:.5+Math.random()*.5})}const h=300,u=new j,m=new Float32Array(h*3),f=new Float32Array(h);for(let x=0;x<h;x++){const S=x*3,M=120+Math.random()*250,A=Math.random()*Math.PI*2,P=Math.random()*Math.PI;m[S]=M*Math.sin(P)*Math.cos(A),m[S+1]=M*Math.sin(P)*Math.sin(A),m[S+2]=M*Math.cos(P),f[x]=1+Math.random()*3}u.setAttribute("position",new _(m,3)),u.setAttribute("size",new _(f,1));const g=new te({color:8913151,size:5,blending:$,transparent:!0,opacity:.8}),b=new Z(u,g);t.add(b);const w=this.getRandomOrbRarity(),v=this.createEnergyOrb(w);t.add(v.mesh),this.scene.add(t),this.anomalies.push({type:"darkMatter",mesh:t,position:e.clone(),core:{mesh:n,pulsePhase:0},rings:c,particles:{mesh:b,positions:m,initialPositions:m.slice(),phases:Array(h).fill().map(()=>Math.random()*Math.PI*2)},orb:v,collisionRadius:200,orbCollected:!1,rotationSpeed:new y(2e-4,3e-4,1e-4)})}createEnergyOrb(e){let t,s,i,o;switch(e){case"legendary":t=new E(16711680),s=30*this.orbScale,i=.9,o=2;break;case"epic":t=new E(16737792),s=25*this.orbScale,i=.8,o=1.8;break;case"rare":t=new E(10027263),s=22*this.orbScale,i=.7,o=1.5;break;case"uncommon":t=new E(26367),s=20*this.orbScale,i=.6,o=1.2;break;default:t=new E(65382),s=18*this.orbScale,i=.5,o=1;break}const n=new G(s,32,32),a=new R({color:t,emissive:t,emissiveIntensity:i,metalness:.8,roughness:.2,transparent:!0,opacity:.9}),r=new C(n,a),l=s*1.5,c=new G(l,32,32),d=new F({color:t,transparent:!0,opacity:.3,side:ke,blending:$}),h=new C(c,d);return r.add(h),{mesh:r,rarity:e,value:this.orbValues[e],size:s,color:t,pulsePhase:0,pulseSpeed:o,glow:h}}createParticleTexture(){const e=document.createElement("canvas");e.width=64,e.height=64;const t=e.getContext("2d"),s=t.createRadialGradient(32,32,0,32,32,32);s.addColorStop(0,"rgba(255,255,255,1)"),s.addColorStop(.3,"rgba(255,255,255,0.8)"),s.addColorStop(.7,"rgba(200,200,200,0.3)"),s.addColorStop(1,"rgba(100,100,100,0)"),t.fillStyle=s,t.fillRect(0,0,64,64);const i=new Je(e);return i.needsUpdate=!0,i}getRandomAnomalyPosition(){const e=Math.random()*Math.PI*2,t=this.minRadius+Math.random()*(this.maxRadius-this.minRadius),s=(Math.random()-.5)*this.width;return new y(Math.cos(e)*t,s,Math.sin(e)*t)}getRandomOrbRarity(){const e=Math.random();return e<.005?"legendary":e<.025?"epic":e<.1?"rare":e<.3?"uncommon":"common"}getRegionInfo(){return{center:new y(0,0,0),innerRadius:this.minRadius,outerRadius:this.maxRadius}}findClosestAnomaly(e,t=8e3){let s=null,i=t;return this.anomalies.forEach(o=>{const n=e.distanceTo(o.position);n<i&&(i=n,s=o)}),s}collectOrb(e){if(!e||e.orbCollected)return null;const t={rarity:e.orb.rarity,value:this.orbValues[e.orb.rarity]||100};return e.orbCollected=!0,e.orb&&e.orb.mesh&&(e.orb.mesh.visible=!1,e.orb.glow&&(e.orb.glow.visible=!1)),t}checkCollision(e,t){return!e||!t||!t.position?!1:e.distanceTo(t.position)<t.orb.size*2*this.orbScale}updateOrbEffects(e,t){if(!(!e||!e.orb||e.orbCollected))if(t){const s=1.5+Math.sin(performance.now()*.005)*.5;e.orb.mesh.scale.set(s,s,s),e.orb.mesh.material&&(e.orb.mesh.material.emissiveIntensity=2)}else{const s=1+Math.sin(performance.now()*.002)*.2;e.orb.mesh.scale.set(s,s,s),e.orb.mesh.material&&(e.orb.mesh.material.emissiveIntensity=.8)}}updateVortexAnomaly(e,t){e.rings.forEach(s=>{s.mesh.rotation.x+=s.rotationSpeed.x*t,s.mesh.rotation.y+=s.rotationSpeed.y*t,s.mesh.rotation.z+=s.rotationSpeed.z*t})}updateCrystalClusterAnomaly(e,t){e.crystals.forEach(s=>{s.floatPhase+=t*s.floatSpeed;const i=Math.sin(s.floatPhase)*s.floatAmplitude;s.mesh.position.y=s.initialPosition.y+i,s.mesh.rotation.x+=s.rotationSpeed.x,s.mesh.rotation.y+=s.rotationSpeed.y,s.mesh.rotation.z+=s.rotationSpeed.z})}updateNebulaNexusAnomaly(e,t){e.core.pulsePhase+=t*e.core.pulseSpeed;const s=1+.2*Math.sin(e.core.pulsePhase);e.core.mesh.scale.set(s,s,s),e.rings.forEach(i=>{const o=new V().makeRotationAxis(i.rotationAxis,i.rotationSpeed*t);i.mesh.applyMatrix4(o),i.crystals.forEach(n=>{n.pulsePhase+=t*n.pulseSpeed;const a=1+.3*Math.sin(n.pulsePhase);n.mesh.scale.set(a,a,a)})}),e.arcs.forEach(i=>{i.updatePhase+=t*i.updateSpeed;const o=i.curve.v1,n=i.curve.v2;o.x=Math.sin(i.updatePhase)*200,o.y=Math.cos(i.updatePhase*.7)*200,o.z=Math.sin(i.updatePhase*1.3)*200,n.x=Math.sin(i.updatePhase*.8+1)*300,n.y=Math.cos(i.updatePhase*1.2+2)*300,n.z=Math.sin(i.updatePhase*.9+3)*300;const a=i.curve.getPoints(20);i.mesh.geometry.setFromPoints(a),i.mesh.geometry.attributes.position.needsUpdate=!0})}updateQuantumFluxAnomaly(e,t){e.frames.forEach(o=>{const n=new V().makeRotationAxis(o.rotationAxis,o.rotationSpeed*t);o.mesh.applyMatrix4(n),o.innerBox&&o.innerBox.applyMatrix4(n),o.pulsePhase+=t;const a=1+.05*Math.sin(o.pulsePhase);o.mesh.scale.set(a,a,a),o.innerBox&&o.innerBox.scale.set(a,a,a)});const s=e.particles.positions,i=e.particles.velocities;for(let o=0;o<s.length/3;o++){const n=o*3;s[n]+=i[o].x,s[n+1]+=i[o].y,s[n+2]+=i[o].z;const a=120,r=new y(s[n],s[n+1],s[n+2]);r.length()>a&&(r.normalize().multiplyScalar(a),s[n]=r.x,s[n+1]=r.y,s[n+2]=r.z,i[o].reflect(r.normalize()))}e.particles.mesh.geometry.attributes.position.needsUpdate=!0}updateDarkMatterAnomaly(e,t){e.core.pulsePhase+=t*.5;const s=1+.1*Math.sin(e.core.pulsePhase);e.core.mesh.scale.set(s,s,s),e.rings.forEach(a=>{const r=new V().makeRotationAxis(a.rotationAxis,a.rotationSpeed*t);a.mesh.applyMatrix4(r),a.warpPhase+=t*a.warpSpeed;const l=1+.1*Math.sin(a.warpPhase),c=1+.1*Math.sin(a.warpPhase+Math.PI/3),d=1+.1*Math.sin(a.warpPhase+Math.PI*2/3);a.mesh.scale.set(l,c,d)});const i=e.particles.positions,o=e.particles.initialPositions,n=e.particles.phases;for(let a=0;a<i.length/3;a++){const r=a*3;n[a]+=t;const c=.5+300/(Math.sqrt(o[r]*o[r]+o[r+1]*o[r+1]+o[r+2]*o[r+2])+10);n[a]+=t*c;const d=1+.2*Math.sin(n[a]*.5),h=new y(o[r],o[r+1],o[r+2]),u=n[a]*.2,m=n[a]*.1;h.applyAxisAngle(new y(0,1,0),u),h.applyAxisAngle(new y(0,0,1),m),h.multiplyScalar(d),i[r]=h.x,i[r+1]=h.y,i[r+2]=h.z}e.particles.mesh.geometry.attributes.position.needsUpdate=!0}updateForSystem(e){console.log("Updating space anomalies for new star system"),this.clearAllAnomalies(),this.spawnTimer=this.checkInterval,this.updateAnomalyCountDisplay()}clearAllAnomalies(){[...this.anomalies].forEach(t=>{this.despawnAnomaly(t)}),this.anomalies=[],this.updateAnomalyCountDisplay()}}class bo{constructor(e){this.scene=e,this.planetRegions={},this.currentSystemId="Solar System",this.componentsLoaded=!1,console.log("Initializing essential environment components..."),this.skybox=new Mi(e),this.sun=new Ti(e),this.starSystemGenerator=new Ii(e),this.planets=new ki(e,this.starSystemGenerator),this.stargate=new Pi(e),this.asteroids=[],this.setupInitialRegions(),console.log("Essential environment components initialized"),setTimeout(()=>{this.loadRemainingComponents()},500)}loadRemainingComponents(){console.log("Loading remaining environment components..."),this.asteroidBelt=new Ai(this.scene),this.asteroids=this.asteroidBelt.getAsteroids(),this.spaceAnomalies=new Fi(this.scene),this.systemTransition=new Ri(this.scene,this.scene.camera),this.customSystemCreator=new Bi(this.starSystemGenerator,this),console.log("Custom system creator initialized:",this.customSystemCreator),this.setupRegions(),this.setupSystemTransitionHandlers(),this.componentsLoaded=!0,console.log("All environment components initialized")}setupInitialRegions(){if(console.log("Setting up essential environment regions"),this.planetRegions={},this.planets&&typeof this.planets.getPlanetRegions=="function")try{this.planetRegions=this.planets.getPlanetRegions()}catch(t){console.warn("Error getting planet regions:",t)}else console.warn("planets.getPlanetRegions is not available, using empty object instead");this.planetRegions.Sun={center:this.sun.getPosition(),radius:this.sun.getRadius()};const e=this.stargate.getRegionInfo();this.planetRegions.Stargate={center:e.center,radius:e.radius}}setSpaceship(e){this.spaceship=e,this.vibeVersePortals=new Li(this.scene,e),console.log("VibeVerse portals initialized")}setupSystemTransitionHandlers(){if(this.starSystemGenerator&&this.asteroidBelt){const e=this.starSystemGenerator.getCurrentSystemResources();this.asteroidBelt.setResourceMultipliers(e)}}travelToSystem(e){return!this.starSystemGenerator||!this.systemTransition?!1:this.starSystemGenerator.travelToSystem(e)?(console.log(`Starting transition to system: ${e}`),this.systemTransition.startTransition(()=>{console.log(`Transition complete, updating environment for: ${e}`),this.updateEnvironmentForSystem(e),this.showSystemWelcomeNotification(e),window.game&&window.game.spaceship&&window.game.spaceship.isDocked&&(console.log("Player is docked after arriving in new system, showing interface"),window.game.controls&&window.game.controls.dockingSystem&&setTimeout(()=>{window.game.controls.dockingSystem.dockWithStargate()},500))}),!0):(console.error(`Cannot travel to system ${e}`),!1)}updateEnvironmentForSystem(e){const t=this.starSystemGenerator.getAllSystems()[e];if(!t){console.error(`No system data found for ${e}`);return}if(console.log(`Updating environment for system: ${e}`,t),this.currentSystemId=e,this.skybox&&this.skybox.updateForSystem)if(e==="Solar System"){const s={starDensity:1,nebulaDensity:.5,color:16777215,isSolarSystem:!0,resetTime:!0};console.log("Updating skybox for Solar System with enforced white color"),this.skybox.updateForSystem(s)}else console.log(`Updating skybox for ${e} with params:`,t.skyboxParams),this.skybox.updateForSystem(t.skyboxParams);else console.warn("Skybox or updateForSystem method not available");if(this.sun){const s=t.lightIntensityMultiplier||1;this.sun.updateSunType&&t.starClass?(console.log(`Updating sun type for ${e} to ${t.starClass} with intensity multiplier: ${s}`),this.sun.updateSunType(t.starClass,s)):this.sun.updateColor?(console.log(`Updating sun color for ${e} to:`,t.starColor.toString(16)),this.sun.updateColor(t.starColor),this.sun.sunLight&&(this.sun.sunLight._intensityMultiplier=s)):console.warn("Sun update methods not available")}else console.warn("Sun not available");if(this.planets&&this.planets.updateForSystem)if(console.log(`Updating planets for ${e}`),this.planets.updateForSystem(e),typeof this.planets.getPlanetRegions=="function")try{this.planetRegions=this.planets.getPlanetRegions()}catch(s){console.warn(`Error getting planet regions for system ${e}:`,s)}else console.warn(`planets.getPlanetRegions is not available for system ${e}`);else console.warn("Planets or updateForSystem method not available");this.asteroidBelt&&this.asteroidBelt.setResourceMultipliers?(console.log(`Updating asteroid resources for ${e}:`,t.resourceMultipliers),this.asteroidBelt.setResourceMultipliers(t.resourceMultipliers),this.asteroidBelt.updateDensity&&(console.log(`Updating asteroid density for ${e}:`,t.asteroidDensity),this.asteroidBelt.updateDensity(t.asteroidDensity))):console.warn("AsteroidBelt or update methods not available"),this.spaceAnomalies&&this.spaceAnomalies.updateForSystem?(console.log(`Updating space anomalies for ${e}`),this.spaceAnomalies.updateForSystem(t)):console.warn("SpaceAnomalies or updateForSystem method not available"),console.log(`Environment updated for ${e}`)}showSystemWelcomeNotification(e){const t=this.starSystemGenerator.getAllSystems()[e];if(!t)return;const s=document.createElement("div");s.style.position="fixed",s.style.top="25%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.8)",s.style.color="#fff",s.style.padding="20px 40px",s.style.borderRadius="10px",s.style.border=`2px solid #${t.starColor.toString(16).padStart(6,"0")}`,s.style.boxShadow=`0 0 30px #${t.starColor.toString(16).padStart(6,"0")}`,s.style.fontFamily="Courier New, monospace",s.style.fontSize="18px",s.style.zIndex="9999",s.style.textAlign="center",e==="Solar System"?s.innerHTML=`
                <h2 style="color: #30cfd0; margin-top: 0;">Welcome to the Solar System</h2>
                <p>Your home system, with Earth as your starting location.</p>
                <p style="font-size: 14px; margin-bottom: 0; color: #aaa;">Safe travels, commander.</p>
            `:s.innerHTML=`
                <h2 style="color: #${t.starColor.toString(16).padStart(6,"0")}; margin-top: 0;">Welcome to ${t.name}</h2>
                <p>${t.description}</p>
                <p style="font-size: 14px; margin-bottom: 0; color: #aaa;">Classification: ${t.classification} - Star Class: ${t.starClass}</p>
            `,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transition="opacity 1s",setTimeout(()=>{s.remove()},1e3)},5e3)}setupRegions(){if(console.log("Setting up environment regions"),this.planetRegions={},this.planets&&typeof this.planets.getPlanetRegions=="function")try{this.planetRegions=this.planets.getPlanetRegions()}catch(i){console.warn("Error getting planet regions in setupRegions:",i)}else console.warn("planets.getPlanetRegions is not available in setupRegions, using empty object");this.planetRegions.Sun={center:this.sun.getPosition(),radius:this.sun.getRadius()};const e=this.asteroidBelt.getRegionInfo();this.planetRegions["Asteroid Belt"]={center:e.center,minRadius:e.innerRadius,maxRadius:e.outerRadius};const t=this.stargate.getRegionInfo();this.planetRegions.Stargate={center:t.center,radius:t.radius};const s=this.spaceAnomalies.getRegionInfo();this.planetRegions["Space Anomalies"]={center:s.center,minRadius:s.innerRadius,maxRadius:s.outerRadius}}getPlayerLocation(e){if(!e)return"Unknown Location";const t=this.planetRegions.Stargate;if(t&&e.distanceTo(t.center)<=t.radius)return"Stargate";if(this.componentsLoaded&&this.spaceAnomalies){const i=this.spaceAnomalies.findClosestAnomaly(e,2e3);if(i&&e.distanceTo(i.position)<800){let n="";switch(i.type){case"vortex":n="Vortex";break;case"crystalCluster":n="Crystal Cluster";break;case"nebulaNexus":n="Nebula Nexus";break;case"quantumFlux":n="Quantum Flux";break;case"darkMatter":n="Dark Matter";break}const a=i.orbCollected?"Depleted":"Active";return`${n} Anomaly (${a})`}}for(const[i,o]of Object.entries(this.planetRegions))if(i==="Asteroid Belt"&&this.componentsLoaded&&this.asteroidBelt){const n=e.distanceTo(o.center);if(o.minRadius&&o.maxRadius&&n>=o.minRadius&&n<=o.maxRadius){const a=this.asteroids.filter(r=>e.distanceTo(r.mesh.position)<500);return a.length>0?`Asteroid Field (${a.length} nearby)`:"Asteroid Belt"}}else if(i==="Space Anomalies"&&this.componentsLoaded){const n=e.distanceTo(o.center);if(o.minRadius&&o.maxRadius&&n>=o.minRadius&&n<=o.maxRadius)return"Space Anomaly Field"}else if(i!=="Sun"&&i!=="Stargate"&&o.center&&o.radius&&e.distanceTo(o.center)<=o.radius)return`Near ${i}`;const s=this.planetRegions.Sun;return s&&e.distanceTo(s.center)<=s.radius?"Near Sun":"Deep Space"}findClosestAsteroid(e,t){return this.componentsLoaded&&this.asteroidBelt&&this.asteroidBelt.findClosestAsteroid?this.asteroidBelt.findClosestAsteroid(e,t):null}findClosestAnomaly(e,t){return this.componentsLoaded&&this.spaceAnomalies&&this.spaceAnomalies.findClosestAnomaly?this.spaceAnomalies.findClosestAnomaly(e,t):null}checkAnomalyCollision(e){if(!this.componentsLoaded||!this.spaceAnomalies)return null;const t=this.spaceAnomalies.findClosestAnomaly(e,8e3);return t&&this.spaceAnomalies.checkCollision(e,t)?t:null}collectAnomalyOrb(e){if(this.componentsLoaded&&this.spaceAnomalies&&this.spaceAnomalies.collectOrb)return this.spaceAnomalies.collectOrb(e)}update(e=.016,t){this.skybox&&typeof this.skybox.update=="function"&&this.skybox.update(e),this.sun&&typeof this.sun.update=="function"&&this.sun.update(e),this.planets&&typeof this.planets.update=="function"&&this.planets.update(e),this.systemTransition&&typeof this.systemTransition.update=="function"&&this.systemTransition.update(e),this.componentsLoaded&&(this.asteroidBelt&&typeof this.asteroidBelt.update=="function"&&this.asteroidBelt.update(e),this.stargate&&typeof this.stargate.update=="function"&&this.stargate.update(e),this.spaceAnomalies&&typeof this.spaceAnomalies.update=="function"&&this.spaceAnomalies.update(e,t),this.vibeVersePortals&&typeof this.vibeVersePortals.update=="function"&&this.vibeVersePortals.update(e))}dispose(){this.skybox&&this.skybox.dispose(),this.sun&&this.sun.dispose(),this.planets&&this.planets.dispose(),this.asteroidBelt&&this.asteroidBelt.dispose(),this.stargate&&this.stargate.dispose(),this.spaceAnomalies&&this.spaceAnomalies.clearAllAnomalies(),this.vibeVersePortals&&this.vibeVersePortals.dispose()}}class $i{constructor(e,t){this.spaceship=e,this.physics=t,this.isPointerLocked=!1,this.mouseSensitivity=.001,this.setupKeyboardControls(),this.setupPointerLock()}setupKeyboardControls(){document.addEventListener("keydown",e=>{if(!(this.spaceship.isDocked||window.game&&window.game.introSequenceActive))switch(e.key.toLowerCase()){case"w":this.spaceship.thrust.forward=!0;break;case"s":this.spaceship.thrust.backward=!0;break;case"a":this.spaceship.thrust.right=!0;break;case"d":this.spaceship.thrust.left=!0;break;case"shift":this.spaceship.thrust.boost=!0;break}}),document.addEventListener("keyup",e=>{if(window.game&&window.game.introSequenceActive){this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.boost=!1;return}switch(e.key.toLowerCase()){case"w":this.spaceship.thrust.forward=!1;break;case"s":this.spaceship.thrust.backward=!1;break;case"a":this.spaceship.thrust.right=!1;break;case"d":this.spaceship.thrust.left=!1;break;case"shift":this.spaceship.thrust.boost=!1;break}})}setupPointerLock(){const e=document.querySelector("canvas");e.addEventListener("pointerdown",s=>{s.preventDefault(),!this.isPointerLocked&&!this.spaceship.isDocked&&e.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{document.pointerLockElement===e?(this.isPointerLocked=!0,document.addEventListener("pointermove",this.handlePointerMove.bind(this))):(this.isPointerLocked=!1,document.removeEventListener("pointermove",this.handlePointerMove.bind(this)))});const t=document.createElement("div");t.id="pointer-lock-instructions",t.innerHTML=`
            Click on the game to enable mouse rotation
        `,t.style.position="absolute",t.style.top="60px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.padding="10px 20px",t.style.borderRadius="20px",t.style.border="1px solid #30cfd0",t.style.boxShadow="0 0 10px #30cfd0",t.style.color="#fff",t.style.fontFamily="Courier New, monospace",t.style.zIndex="999",t.style.textAlign="center",document.body.appendChild(t),document.addEventListener("pointerlockchange",()=>{t.style.display=document.pointerLockElement?"none":"block"})}handlePointerMove(e){if(window.game&&window.game.introSequenceActive||!this.isPointerLocked)return;const t=e.movementX||0,s=e.movementY||0;this.physics.updateRotation(t*this.mouseSensitivity,s*this.mouseSensitivity)}isLocked(){return this.isPointerLocked}exitPointerLock(){document.exitPointerLock&&document.exitPointerLock()}}class zi{constructor(e,t){this.spaceship=e,this.scene=t,this.isMining=!1,this.targetAsteroid=null,this.miningProgress=0,this.lastDestroyedAsteroid=null,this.miningSpeedByType={iron:.133,gold:.044,platinum:.022},this.miningSpeed=.133,this.miningDistance=6e3,this.miningCooldown=0,this.resources={iron:0,gold:0,platinum:0},this.setupMiningLaser()}getMiningEfficiency(){return this.spaceship&&this.spaceship.miningEfficiency?this.spaceship.miningEfficiency:1}setupMiningLaser(){const t=new j,s=new te({color:16733440,size:1.5,blending:$,transparent:!0,opacity:.8}),i=new Float32Array(100*3);for(let o=0;o<100;o++)i[o*3]=0,i[o*3+1]=0,i[o*3+2]=0;t.setAttribute("position",new _(i,3)),this.miningParticles=new Z(t,s),this.miningParticles.visible=!1,this.scene.add(this.miningParticles)}setTargetAsteroid(e){try{if(console.log("MiningSystem: setTargetAsteroid called",e),!e||!e.mesh||!e.mesh.position)return console.error("MiningSystem: Invalid asteroid provided to setTargetAsteroid"),!1;if(this.targetAsteroid=e,e&&e.resourceType){const t=e.resourceType.toLowerCase(),s=this.miningSpeedByType[t]||this.miningSpeedByType.iron,i=this.getMiningEfficiency();this.miningSpeed=s*i,console.log(`Mining ${t} asteroid with speed: ${this.miningSpeed} (efficiency: ${i}x)`);const o=document.getElementById("target-info");if(o){o.style.display="block",o.style.color="#30cfd0";const n=document.getElementById("target-name");n&&(n.textContent=`${t.toUpperCase()} Asteroid`);const a=Math.round(this.spaceship.mesh.position.distanceTo(e.mesh.position)),r=document.getElementById("target-distance");r&&(r.textContent=`Distance: ${a} units`)}}else this.miningSpeed=this.miningSpeedByType.iron*this.getMiningEfficiency();return!0}catch(t){return console.error("MiningSystem: Error in setTargetAsteroid:",t),!1}}startMining(){try{if(console.log("MiningSystem: startMining called"),!this.targetAsteroid){console.error("MiningSystem: Cannot start mining - no target asteroid set");return}if(!this.targetAsteroid.mesh||!this.targetAsteroid.mesh.position){console.error("MiningSystem: Target asteroid is missing mesh or position",this.targetAsteroid);return}if(!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position){console.error("MiningSystem: Spaceship is missing mesh or position");return}const e=this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);if(console.log(`MiningSystem: Distance to asteroid: ${e}, max range: ${this.miningDistance}`),e>this.miningDistance){const i=document.getElementById("target-info");i&&(i.textContent="TARGET OUT OF RANGE",i.style.color="#ff4400",i.style.display="block",setTimeout(()=>{i.style.display="none"},2e3)),console.log("MiningSystem: Target out of range");return}this.isMining=!0,this.miningProgress=0,console.log("MiningSystem: Mining state activated");let t=document.getElementById("laser-beam");if(t||(console.log("MiningSystem: Creating laser beam element"),t=document.createElement("div"),t.id="laser-beam",t.style.position="absolute",t.style.height="2px",t.style.backgroundColor="#ff3030",t.style.transformOrigin="0 0",t.style.zIndex="100",t.style.pointerEvents="none",document.body.appendChild(t)),t)if(t.style.display="block",this.targetAsteroid.resourceType){const i=this.targetAsteroid.resourceType.toLowerCase();let o="#ff3030",n="#ff0000";i==="gold"?(o="#ffcc00",n="#ffaa00"):i==="platinum"&&(o="#66ffff",n="#00ffff");const a=this.getMiningEfficiency();if(a>1){const r=Math.min(1+(a-1)*.5,3);t.style.boxShadow=`0 0 ${10*r}px ${n}, 0 0 ${20*r}px ${n}`}else t.style.boxShadow=`0 0 10px ${n}, 0 0 20px ${n}`;t.style.backgroundColor=o}else t.style.backgroundColor="#ff3030",t.style.boxShadow="0 0 10px #ff0000, 0 0 20px #ff0000";if(this.miningParticles&&(this.miningParticles.visible=!0,this.targetAsteroid.resourceType&&this.miningParticles.material)){const i=this.targetAsteroid.resourceType.toLowerCase();i==="iron"?this.miningParticles.material.color.set(16733440):i==="gold"?this.miningParticles.material.color.set(16763904):i==="platinum"&&this.miningParticles.material.color.set(6750207);const o=this.getMiningEfficiency();o>1&&(this.miningParticles.material.size=1.5*Math.sqrt(o))}let s=document.getElementById("mining-progress-container");if(s){s.style.display="block";const i=document.getElementById("mining-progress-bar");i&&(i.style.width="0%")}else{console.log("MiningSystem: Creating mining progress container"),s=document.createElement("div"),s.id="mining-progress-container",s.style.position="absolute",s.style.bottom="20px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.width="200px",s.style.height="10px",s.style.backgroundColor="rgba(0, 0, 0, 0.5)",s.style.border="1px solid #30cfd0",s.style.zIndex="1000",document.body.appendChild(s);const i=document.createElement("div");i.id="mining-progress-bar",i.style.width="0%",i.style.height="100%",i.style.backgroundColor="#30cfd0",s.appendChild(i)}this.spaceship&&typeof this.spaceship.activateMiningLaser=="function"&&this.spaceship.activateMiningLaser(),this.updateMiningStatusWithTime(),window.game&&window.game.audio?window.game.audio.playSound("mining-laser"):window.game&&window.game.audio&&window.game.audio.playSound("laser"),console.log("MiningSystem: Mining successfully started")}catch(e){console.error("MiningSystem: Error in startMining:",e),this.isMining=!1}}updateMiningStatusWithTime(){const e=document.getElementById("mining-status");if(!e||!this.targetAsteroid||!this.targetAsteroid.resourceType)return;const t=this.targetAsteroid.resourceType.toLowerCase(),s=Math.round(1/this.miningSpeed),i=this.getMiningEfficiency();let o="";i>1&&(o=` [${Math.round(i*100)}% efficiency]`),e.textContent=`MINING ${t.toUpperCase()} (${s}s)${o}`,e.style.color="#ff4400"}stopMining(){if(!this.isMining)return;this.isMining=!1,this.miningProgress=0;const e=document.getElementById("laser-beam");e&&(e.style.display="none"),this.miningParticles&&(this.miningParticles.visible=!1);const t=document.getElementById("mining-progress-container");t&&(t.style.display="none"),this.spaceship.deactivateMiningLaser();const s=document.getElementById("mining-status");s&&(s.textContent="INACTIVE",s.style.color="#30cfd0"),window.game&&window.game.audio&&window.game.audio.stopSound("mining-laser")}update(e=1/60){this.miningCooldown>0&&this.miningCooldown--,this.isMining&&this.updateMining(e),this.miningParticles&&this.miningParticles.visible&&this.updateMiningParticles(),this.targetAsteroid&&!this.isMining&&this.updateTargetInfo()}updateMining(e=1/60){if(!this.targetAsteroid||!this.isMining){this.stopMining();return}if(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)>this.miningDistance){this.stopMining();return}this.miningProgress+=this.miningSpeed*e,this.updateLaserBeam(),this.miningParticles&&this.miningParticles.visible&&this.miningParticles.position.copy(this.targetAsteroid.mesh.position),this.miningProgress>=1&&(this.addAsteroidResources(),this.createAsteroidBreakEffect(this.targetAsteroid.mesh.position),this.lastDestroyedAsteroid=this.targetAsteroid,this.scene.remove(this.targetAsteroid.mesh),this.stopMining(),this.targetAsteroid=null);const s=document.getElementById("mining-progress-bar");s&&(s.style.width=`${this.miningProgress*100}%`)}updateLaserBeam(){const e=document.getElementById("laser-beam");if(!e||!this.targetAsteroid||!this.isMining)return;const t=this.spaceship.mesh.position.clone(),s=this.targetAsteroid.mesh.position.clone(),i=new y(0,0,-60);i.applyQuaternion(this.spaceship.mesh.quaternion),t.add(i);const o=new y,n=this.scene.camera;if(!n)return;o.copy(t),o.project(n);const a=(o.x*.5+.5)*window.innerWidth,r=(-(o.y*.5)+.5)*window.innerHeight;o.copy(s),o.project(n);const l=(o.x*.5+.5)*window.innerWidth,c=(-(o.y*.5)+.5)*window.innerHeight,d=l-a,h=c-r,u=Math.sqrt(d*d+h*h),m=Math.atan2(h,d);e.style.width=`${u}px`,e.style.left=`${a}px`,e.style.top=`${r}px`,e.style.transform=`rotate(${m}rad)`;const f=.8+Math.sin(Date.now()*.01)*.2;e.style.opacity=f.toString();const g=this.getMiningEfficiency(),b=Math.max(2,Math.ceil(2*Math.sqrt(g)));if(e.style.height=`${b}px`,!e.hasChildNodes())for(let w=0;w<2;w++){const v=document.createElement("div");v.style.position="absolute",v.style.left="0",v.style.top=`${w===0?-1:1}px`,v.style.width="100%",v.style.height="1px",v.style.backgroundColor="#ff6060",v.style.opacity="0.7",e.appendChild(v)}}updateMiningParticles(){const e=this.miningParticles.geometry.attributes.position.array,s=.3*this.getMiningEfficiency();for(let i=0;i<e.length;i+=3){const o=new y(e[i],e[i+1],e[i+2]);o.normalize().multiplyScalar(s),e[i]+=o.x,e[i+1]+=o.y,e[i+2]+=o.z,Math.sqrt(e[i]*e[i]+e[i+1]*e[i+1]+e[i+2]*e[i+2])>36&&(e[i]=(Math.random()-.5)*24,e[i+1]=(Math.random()-.5)*24,e[i+2]=(Math.random()-.5)*24)}this.miningParticles.geometry.attributes.position.needsUpdate=!0}addAsteroidResources(){if(!this.targetAsteroid)return;const e=this.targetAsteroid.resourceType||"iron",t=this.getMiningEfficiency(),s=(t-1)*.5;let i=0;switch(e.toLowerCase()){case"iron":i=Math.floor(Math.random()*5)+10;break;case"gold":i=Math.floor(Math.random()*3)+5;break;case"platinum":i=Math.floor(Math.random()*2)+2;break;default:i=10}switch(t>1&&Math.random()<s&&(i=Math.ceil(i*1.2)),e.toLowerCase()){case"iron":this.resources.iron+=i;break;case"gold":this.resources.gold+=i;break;case"platinum":this.resources.platinum+=i;break;default:this.resources.iron+=i}return console.log(`MiningSystem: Added ${i} ${e} from asteroid`),this.showResourceGainNotification(i,e),!0}showResourceGainNotification(e,t){let s="#a0a0a0";t==="gold"?s="#ffcc00":t==="platinum"&&(s="#66ffff");const i=document.createElement("div");i.textContent=`+${e} ${t.toUpperCase()}`,i.style.position="absolute",i.style.top="40%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.color=s,i.style.fontSize="24px",i.style.fontWeight="bold",i.style.textShadow="0 0 8px black",i.style.zIndex="1000",i.style.opacity="1",i.style.transition="all 1.5s ease-out",document.body.appendChild(i),setTimeout(()=>{i.style.opacity="0",i.style.top="30%",setTimeout(()=>{document.body.contains(i)&&document.body.removeChild(i)},1500)},100)}createAsteroidBreakEffect(e){const s=new j,i=new te({color:11184810,size:12,blending:$,transparent:!0,opacity:.8}),o=new Float32Array(50*3),n=[];for(let c=0;c<50;c++)o[c*3]=e.x,o[c*3+1]=e.y,o[c*3+2]=e.z,n.push({x:(Math.random()-.5)*8,y:(Math.random()-.5)*8,z:(Math.random()-.5)*8});s.setAttribute("position",new _(o,3));const a=new Z(s,i);this.scene.add(a);let r=0;const l=()=>{r++;const c=a.geometry.attributes.position.array;for(let d=0;d<50;d++)c[d*3]+=n[d].x,c[d*3+1]+=n[d].y,c[d*3+2]+=n[d].z;a.geometry.attributes.position.needsUpdate=!0,a.material.opacity=Math.max(0,.8-r*.02),r<40?requestAnimationFrame(l):this.scene.remove(a)};l()}getLastDestroyedAsteroid(){const e=this.lastDestroyedAsteroid;return this.lastDestroyedAsteroid=null,e}updateTargetInfo(){if(!(!this.targetAsteroid||!this.targetAsteroid.mesh))try{const e=this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position),t=document.getElementById("target-distance");t&&(t.textContent=`Distance: ${Math.round(e)} units`);const s=e<=this.miningDistance,i=document.getElementById("target-info");i&&(s?i.style.color="#30cfd0":i.style.color="#ff4400")}catch(e){console.error("MiningSystem: Error updating target info:",e)}}}class Ui{constructor(e,t,s){this.spaceship=e,this.scene=t,this.environment=s,this.lockOnEnabled=!1,this.nearbyAsteroids=[],this.currentLockOnIndex=-1,this.targetAsteroid=null,this.scanRadius=this.getScanRadius(),this.createTargetReticle(),this.createOffScreenIndicators()}createTargetReticle(){const e=new Ae(150,180,32),t=new F({color:16724016,side:K,transparent:!0,opacity:.7});this.targetReticle=new C(e,t),this.targetReticle.visible=!1,this.scene.add(this.targetReticle);const s=new Ae(75,90,32),i=new F({color:16736352,side:K,transparent:!0,opacity:.5}),o=new C(s,i);this.targetReticle.add(o)}getScanRadius(){return this.spaceship&&this.spaceship.scanRange?this.spaceship.scanRange*5:5e3}toggleLockOn(){if(this.lockOnEnabled=!this.lockOnEnabled,this.lockOnEnabled){this.scanRadius=this.getScanRadius(),this.scanForAsteroids();const e=document.getElementById("target-info");e&&(e.textContent="Lock-On Targeting: ACTIVE",e.style.display="block",e.style.color="#30cfd0"),this.nearbyAsteroids.length>0&&this.findNearestTarget()}else{this.nearbyAsteroids=[],this.currentLockOnIndex=-1,this.targetAsteroid=null,this.targetReticle.visible=!1,this.hideOffScreenIndicators();const e=document.getElementById("target-info");e&&(e.style.display="none")}return this.lockOnEnabled}scanForAsteroids(){this.nearbyAsteroids=[];const e=this.spaceship.mesh.position;if(this.environment.asteroids.forEach(s=>{if(!s.minable||!s.mesh.visible)return;const i=e.distanceTo(s.mesh.position);i<=this.scanRadius&&this.nearbyAsteroids.push({asteroid:s,distance:i})}),this.nearbyAsteroids.sort((s,i)=>s.distance-i.distance),this.nearbyAsteroids=this.nearbyAsteroids.map(s=>s.asteroid),this.nearbyAsteroids.length>0){this.currentLockOnIndex=0,this.updateLockedOnTarget();const s=document.getElementById("target-name");return s&&(s.textContent=`Target 1/${this.nearbyAsteroids.length} (${Math.round(this.nearbyAsteroids[0].mesh.position.distanceTo(e))} units)`),!0}else{const s=document.getElementById("target-name");return s&&(s.textContent="No targets in range"),this.targetReticle.visible=!1,this.targetAsteroid=null,!1}}cycleLockOnTarget(){return!this.lockOnEnabled||this.nearbyAsteroids.length===0?null:(this.currentLockOnIndex=(this.currentLockOnIndex+1)%this.nearbyAsteroids.length,this.updateLockedOnTarget())}updateLockedOnTarget(){if(this.targetAsteroid=this.nearbyAsteroids[this.currentLockOnIndex],this.targetAsteroid){const e=document.getElementById("target-name");e&&(e.textContent=`Asteroid (${this.targetAsteroid.resourceType}) - ${this.currentLockOnIndex+1}/${this.nearbyAsteroids.length}`);const t=document.getElementById("target-resources");t&&(t.textContent=`Health: ${this.targetAsteroid.mesh.userData.health}`),this.targetReticle.position.copy(this.targetAsteroid.mesh.position),this.targetReticle.visible=!0;const s=new y().copy(this.scene.camera.position);this.targetReticle.lookAt(s),this.targetReticle.scale.set(1,1,1),this.targetReticle.material.opacity=.8,this.targetReticle.children.length>0&&(this.targetReticle.children[0].material.opacity=.8)}return this.targetAsteroid}getCurrentTarget(){try{return console.log("TargetingSystem: getCurrentTarget called"),this.targetAsteroid?!this.targetAsteroid.mesh||!this.targetAsteroid.mesh.position?(console.error("TargetingSystem: Current target is invalid, clearing target"),this.targetAsteroid=null,null):(console.log("TargetingSystem: Returning current target:",this.targetAsteroid),this.targetAsteroid):(console.log("TargetingSystem: No current target"),null)}catch(e){return console.error("TargetingSystem: Error in getCurrentTarget:",e),null}}isLockOnEnabled(){return this.lockOnEnabled===!0}findNearestTarget(){try{if(console.log("TargetingSystem: findNearestTarget called"),!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position)return console.error("TargetingSystem: Cannot find nearest target - spaceship missing or invalid"),null;let e=[];const t=window.gameInstance||window.game;if(t&&t.environment&&Array.isArray(t.environment.asteroids))console.log(`TargetingSystem: Found ${t.environment.asteroids.length} asteroids in environment`),e=t.environment.asteroids;else return console.error("TargetingSystem: Could not access asteroids from game environment"),null;if(e.length===0)return console.log("TargetingSystem: No asteroids found in environment"),null;let s=null,i=1/0;for(const o of e){if(!o||!o.mesh||!o.mesh.position||!o.mesh.visible){console.log("TargetingSystem: Skipping invalid or invisible asteroid",o);continue}const n=this.spaceship.mesh.position.distanceTo(o.mesh.position);n<i&&(i=n,s=o)}return s?(console.log("TargetingSystem: Found nearest target:",s),this.setTarget(s),s):(console.log("TargetingSystem: No valid asteroid found after checking all asteroids"),null)}catch(e){return console.error("TargetingSystem: Error in findNearestTarget:",e),null}}update(){if(this.scanRadius=this.getScanRadius(),this.lockOnEnabled&&this.targetAsteroid){this.targetReticle.position.copy(this.targetAsteroid.mesh.position);const e=new y().copy(this.scene.camera.position);this.targetReticle.lookAt(e),this.targetReticle.rotation.z+=.01,this.targetReticle.children.length>0&&(this.targetReticle.children[0].rotation.z-=.02);const t=Math.sin(Date.now()*.005),s=.6+.4*t,i=1+.1*t;this.targetReticle.material.opacity=s,this.targetReticle.scale.set(i,i,i);const o=document.getElementById("target-distance");if(o){const a=Math.round(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position));o.textContent=`Distance: ${a} units`}const n=this.isTargetOnScreen();if(this.targetReticle.visible=!0,n)this.hideOffScreenIndicators();else{const a=this.getScreenPosition(this.targetAsteroid.mesh.position),r=this.getTargetDirection();this.showOffScreenIndicator(a,r)}(!this.targetAsteroid.mesh.parent||this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)>this.scanRadius)&&this.scanForAsteroids()}this.lockOnEnabled&&Date.now()%50===0&&this.scanForAsteroids()}setTarget(e){try{if(console.log("TargetingSystem: setTarget called",e),!e){console.error("TargetingSystem: Cannot set null target");return}if(!e.mesh||!e.mesh.position){console.error("TargetingSystem: Target is missing mesh or position properties",e);return}if(this.targetAsteroid=e,this.targetDisplay&&(this.targetDisplay.style.display="block"),this.targetInfoElement){const t=this.calculateDistanceToTarget();let s=e.resourceType||"Unknown";s=s.charAt(0).toUpperCase()+s.slice(1),this.targetInfoElement.textContent=`${s} Asteroid - ${t.toFixed(0)}m`,this.targetInfoElement.style.color="#30cfd0",this.targetInfoElement.style.display="block"}return console.log("TargetingSystem: Target successfully set",this.targetAsteroid),this.lockOnEnabled=!0,!0}catch(t){return console.error("TargetingSystem: Error in setTarget:",t),!1}}calculateDistanceToTarget(){try{return!this.targetAsteroid||!this.targetAsteroid.mesh||!this.targetAsteroid.mesh.position?(console.error("TargetingSystem: Cannot calculate distance - invalid target asteroid"),1/0):!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position?(console.error("TargetingSystem: Cannot calculate distance - invalid spaceship"),1/0):this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)}catch(e){return console.error("TargetingSystem: Error calculating distance to target:",e),1/0}}createOffScreenIndicators(){this.offScreenContainer=document.createElement("div"),this.offScreenContainer.id="off-screen-indicators",this.offScreenContainer.style.position="absolute",this.offScreenContainer.style.top="0",this.offScreenContainer.style.left="0",this.offScreenContainer.style.width="100%",this.offScreenContainer.style.height="100%",this.offScreenContainer.style.pointerEvents="none",this.offScreenContainer.style.display="none",document.body.appendChild(this.offScreenContainer),this.offScreenIndicator=document.createElement("div"),this.offScreenIndicator.style.position="absolute",this.offScreenIndicator.style.width="30px",this.offScreenIndicator.style.height="30px",this.offScreenIndicator.innerHTML=`
            <svg width="30" height="30" viewBox="0 0 30 30">
                <polygon points="15,0 30,30 15,22 0,30" fill="#ff3030" />
            </svg>
        `,this.offScreenIndicator.style.transformOrigin="center center",this.offScreenIndicator.style.display="none",this.offScreenContainer.appendChild(this.offScreenIndicator)}hideOffScreenIndicators(){this.offScreenContainer&&(this.offScreenContainer.style.display="none"),this.offScreenIndicator&&(this.offScreenIndicator.style.display="none")}showOffScreenIndicator(e,t){if(!this.offScreenContainer||!this.offScreenIndicator)return;this.offScreenContainer.style.display="block",this.offScreenIndicator.style.display="block";const s=Math.atan2(t.y,t.x)*(180/Math.PI),i=50,o=window.innerWidth/2,n=window.innerHeight/2,a=new H(t.x,t.y).normalize();let r,l;const c=Math.abs(a.y/a.x),d=n/o;c>d?(l=a.y>0?n-i:-n+i,r=l/a.y*a.x):(r=a.x>0?o-i:-o+i,l=r/a.x*a.y),this.offScreenIndicator.style.left=o+r+"px",this.offScreenIndicator.style.top=n+l+"px",this.offScreenIndicator.style.transform=`rotate(${s}deg)`}isTargetOnScreen(){if(!this.targetAsteroid||!this.targetAsteroid.mesh)return!1;const e=this.getScreenPosition(this.targetAsteroid.mesh.position),t=.1;return e.x>=-1+t&&e.x<=1-t&&e.y>=-1+t&&e.y<=1-t}getScreenPosition(e){const t=new y().copy(e);return t.project(this.scene.camera),new H(t.x,t.y)}getTargetDirection(){const e=this.getScreenPosition(this.targetAsteroid.mesh.position);return new H(e.x,e.y)}}class Hi{constructor(e,t,s){this.spaceship=e,this.stargate=t,this.ui=s,this.nearStargate=!1,this.isDocked=this.spaceship.isDocked,this.spaceship&&this.spaceship.undockLocation&&this.stargate&&this.spaceship.undockLocation.set(0,1e4,0),console.log("Initializing docking system, ship is "+(this.isDocked?"docked":"undocked")),this.setupDockingControls(),this.isDocked&&this.spaceship.world&&this.spaceship.world.messageBus&&(this.spaceship.world.messageBus.publish("player.docked",{playerPosition:this.spaceship.mesh?this.spaceship.mesh.position.clone():null,stargate:this.stargate}),console.log("Published initial player.docked event"))}setupDockingControls(){document.addEventListener("keydown",e=>{e.key.toLowerCase()==="q"&&(this.nearStargate&&!this.spaceship.isDocked?(console.log("Q key pressed: Docking with stargate"),this.dockWithStargate()):this.spaceship.isDocked?console.log("Q key pressed while docked: No action (use Undock button)"):this.nearStargate||console.log("Q key pressed but not near stargate"))}),this.setupStargateUIControls()}setupStargateUIControls(){const e=document.getElementById("refuel-btn");e&&e.addEventListener("click",()=>{this.spaceship.credits>=100&&(this.spaceship.credits-=this.spaceship.refuel(),this.updateStargateUI())});const t=document.getElementById("repair-shield-btn");t&&t.addEventListener("click",()=>{this.spaceship.credits>=150&&(this.spaceship.credits-=this.spaceship.repairShield(),this.updateStargateUI())});const s=document.getElementById("repair-hull-btn");s&&s.addEventListener("click",()=>{this.spaceship.credits>=200&&(this.spaceship.credits-=this.spaceship.repairHull(),this.updateStargateUI())});const i=document.getElementById("undock-btn");if(i){const o=n=>{n.preventDefault(),n.stopPropagation(),console.log(`Undock button ${n.type} event triggered`),this.isMobileDevice()?(document.body.classList.remove("undocking","modal-open"),setTimeout(()=>{this.undockFromStargate()},50)):this.undockFromStargate()};i.addEventListener("click",o),i.addEventListener("touchend",o),i.addEventListener("touchstart",n=>{console.log("Touch started on undock button"),n.stopPropagation()},{passive:!1})}this.setupSellingButtons(),this.setupUpgradeButtons()}setupSellingButtons(){const e=document.getElementById("sell-iron");e&&e.addEventListener("click",()=>{this.resources.iron>0&&(this.spaceship.credits+=this.resources.iron*10,this.resources.iron=0,this.updateStargateUI())});const t=document.getElementById("sell-gold");t&&t.addEventListener("click",()=>{this.resources.gold>0&&(this.spaceship.credits+=this.resources.gold*50,this.resources.gold=0,this.updateStargateUI())});const s=document.getElementById("sell-platinum");s&&s.addEventListener("click",()=>{this.resources.platinum>0&&(this.spaceship.credits+=this.resources.platinum*200,this.resources.platinum=0,this.updateStargateUI())})}setupUpgradeButtons(){this.setupUpgradeButton("upgrade-fuel-tank",()=>this.spaceship.fuelUpgradeCost,()=>this.spaceship.upgradeFuelTank()),this.setupUpgradeButton("upgrade-engine",()=>this.spaceship.engineUpgradeCost,()=>this.spaceship.upgradeEngine()),this.setupUpgradeButton("upgrade-mining",()=>this.spaceship.miningUpgradeCost,()=>this.spaceship.upgradeMiningLaser()),this.setupUpgradeButton("upgrade-hull",()=>this.spaceship.hullUpgradeCost,()=>this.spaceship.upgradeHull()),this.setupUpgradeButton("upgrade-scanner",()=>this.spaceship.scannerUpgradeCost,()=>this.spaceship.upgradeScanner())}setupUpgradeButton(e,t,s){const i=document.getElementById(e);i&&i.addEventListener("click",()=>{const o=t();this.spaceship.credits>=o&&(this.spaceship.credits-=o,s(),e==="upgrade-mining"&&this.updateMiningSystem&&this.updateMiningSystem(),this.updateStargateUI())})}updateMiningSystem(){if(this.ui&&this.ui.controls&&this.ui.controls.miningSystem){const e=this.ui.controls.miningSystem;Object.keys(e.miningSpeedByType).forEach(t=>{const s=e.miningSpeedByType[t];e.miningSpeedByType[t]=s*this.spaceship.miningEfficiency}),console.log("Mining system updated with new efficiency:",this.spaceship.miningEfficiency)}}dockWithStargate(){console.log("Docking with stargate"),this.spaceship.isDocked?console.log("Ship is already docked, just showing UI"):(this.spaceship.dock(),this.isDocked=!0,this.spaceship.world&&this.spaceship.world.messageBus&&(this.spaceship.world.messageBus.publish("player.docked",{playerPosition:this.spaceship.mesh.position.clone(),stargate:this.stargate}),console.log("Published player.docked event"))),this.isMobileDevice()&&(console.log("Mobile device detected - preparing for stargate UI"),document.body.classList.remove("undocking","modal-open"),document.body.style.position="static",document.body.style.touchAction="auto",document.body.style.pointerEvents="auto",document.body.style.overflow="auto"),this.ui&&this.ui.stargateInterface&&(console.log("Showing stargate UI..."),this.ui.stargateInterface.showStargateUI(),this.isMobileDevice()&&setTimeout(()=>{const e=document.getElementById("stargate-ui");e&&e.style.display!=="block"&&(console.log("Forcing stargate UI display"),e.style.display="block")},100)),this.ui&&this.ui.hideUI(),document.pointerLockElement&&(document.exitPointerLock(),console.log("Exited pointer lock for UI interaction")),this.updateStargateUI()}async performStep(e,t){return new Promise(s=>{requestAnimationFrame(()=>{try{e(),console.log(`Completed step: ${t}`)}catch(i){console.error(`Error during step ${t}:`,i)}s()})})}async yieldToBrowser(){return new Promise(e=>requestAnimationFrame(e))}hideStargateUI(){this.ui&&this.ui.stargateInterface&&(document.body.classList.add("undocking"),this.ui.stargateInterface.hideStargateUI(),console.log("Hiding stargate interface"))}showGameUI(){this.ui&&(document.body.classList.remove("undocking"),this.ui.showUI(),console.log("Showing game UI"))}resetMobileStyles(){this.isMobileDevice()&&document.body.classList.remove("undocking","modal-open"),requestAnimationFrame(()=>{document.body.style.cssText="",document.body.style.overflow="auto",document.body.style.position="static",document.body.style.height="auto",document.body.style.width="auto",document.body.style.touchAction="auto",document.body.style.pointerEvents="auto",document.body.style.webkitOverflowScrolling="touch",document.body.classList.remove("modal-open","undocking"),document.querySelectorAll(".modal-content, #stargate-ui, #star-map").forEach(e=>{e&&e.style&&(e.style.cssText="overflow: auto; -webkit-overflow-scrolling: touch;",e.scrollTop=0)})})}async undockFromStargate(){var t;if(!this.spaceship.isDocked){console.log("Not docked, can't undock");return}this.isMobileDevice()&&(document.body.classList.remove("undocking"),this.resetMobileStyles());const e=document.createElement("div");e.className="undocking-indicator",e.textContent="Undocking...",document.body.appendChild(e);try{console.log("Starting undock sequence..."),this.preUndockShieldValue=this.spaceship.shield,console.log(`Storing pre-undock shield value: ${this.preUndockShieldValue}`),await this.performStep(()=>this.closeAllModals(),"Closing modals"),await this.yieldToBrowser(),this.isMobileDevice()&&(await this.performStep(()=>this.resetMobileStyles(),"Resetting mobile styles"),await this.yieldToBrowser()),await this.performStep(()=>this.hideStargateUI(),"Hiding stargate UI"),await this.yieldToBrowser(),await this.performStep(()=>this.showGameUI(),"Showing game UI"),await this.yieldToBrowser(),console.log("Performing core undock...");const s=this.spaceship.undock();console.log("Syncing health values..."),this.spaceship.shield===0&&this.preUndockShieldValue>0&&(console.log(`Fixing shield reset: Restoring to ${this.preUndockShieldValue}`),this.spaceship.shield=this.preUndockShieldValue),this.spaceship.syncValuesToHealthComponent();const i={shield:this.spaceship.shield,maxShield:this.spaceship.maxShield,hull:this.spaceship.hull,maxHull:this.spaceship.maxHull},o=((t=window.game)==null?void 0:t.messageBus)||window.mainMessageBus;o&&(o.publish("player.undocked",i),console.log("Published player.undocked event with health values:",i)),this.dockingAvailable=!1,this.autoPointerLockOnUndock&&!this.isMobileDevice()&&await this.performStep(()=>this.requestPointerLock(),"Requesting pointer lock"),console.log("Undock sequence complete")}catch(s){console.error("Error during undocking:",s)}finally{document.body.contains(e)&&document.body.removeChild(e),this.isMobileDevice()?(document.body.classList.remove("undocking","modal-open"),this.resetMobileStyles(),document.body.style.pointerEvents="",document.body.style.touchAction="",document.body.style.overflowY="",document.body.style.position=""):document.body.classList.remove("undocking")}}isMobileDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||window.innerWidth<900}closeAllModals(){try{const e=document.getElementById("custom-system-creator");if(e&&window.getComputedStyle(e).display!=="none"){console.log("Closing custom system creator before undocking");const i=e.querySelector("#close-system-creator");i?i.click():e.style.display="none",window.game&&window.game.ui&&(window.game.ui.starMap&&typeof window.game.ui.starMap.hide=="function"&&window.game.ui.starMap.hide(),window.game.ui.customSystemCreator&&typeof window.game.ui.customSystemCreator.hide=="function"&&window.game.ui.customSystemCreator.hide(),document.body.classList.remove("modal-open"))}const t=document.getElementById("star-map");if(t&&window.getComputedStyle(t).display!=="none"){console.log("Closing star map before undocking");const i=t.querySelector("#close-star-map");i?i.click():t.style.display="none"}document.querySelectorAll(".modal-container").forEach(i=>{window.getComputedStyle(i).display!=="none"&&(console.log("Closing modal before undocking:",i.id||"unnamed modal"),i.style.display="none")})}catch(e){console.warn("Error while closing modals:",e)}}requestPointerLock(){const e=document.querySelector("canvas");e&&!document.pointerLockElement&&setTimeout(()=>{e.requestPointerLock(),console.log("Requested pointer lock for ship control")},200)}updateStargateUI(){this.ui&&this.ui.stargateInterface&&this.ui.stargateInterface.updateStargateUI(this.spaceship,this.resources)}checkStargateProximity(){if(this.spaceship.isDocked||!this.stargate||!this.spaceship||!this.spaceship.mesh)return;const e=this.stargate.getPosition();if(!e)return;this.spaceship.mesh.position.distanceTo(e)<2e3?(this.nearStargate=!0,this.ui&&this.ui.stargateInterface&&this.ui.stargateInterface.showDockingPrompt(),this.ui&&this.ui.controls&&this.ui.controls.isMobile&&this.ui.controls.touchControls&&this.ui.controls.touchControls.showDockButton()):(this.nearStargate=!1,this.ui&&this.ui.stargateInterface&&this.ui.stargateInterface.hideDockingPrompt(),this.ui&&this.ui.controls&&this.ui.controls.isMobile&&this.ui.controls.touchControls&&this.ui.controls.touchControls.hideDockButton())}update(){this.checkStargateProximity()}setResources(e){this.resources=e}}class Oi{constructor(e,t){this.spaceship=e,this.physics=t,this.leftJoystick=null,this.rightJoystick=null,this.dockButton=null,this.mineButton=null,this.fireButton=null,this.targetButton=null,this.isInitialized=!1,this.miningSystem=null,this.targetingSystem=null,this.dockingSystem=null,this.weaponSystem=null,this.threshold=.1,this.createCrosshair(),this.loadNippleJS().then(()=>{this.setupTouchControls()}).catch(s=>{console.error("Failed to load nipple.js:",s)})}setControlSystems(e){if(console.log("TouchControls: Setting control systems"),!e){console.error("TouchControls: Controls object is null or undefined");return}this.miningSystem=e.miningSystem,this.targetingSystem=e.targetingSystem,this.dockingSystem=e.dockingSystem,this.weaponSystem=e.weaponSystem,this.weaponSystem&&!this.weaponSystem.setFiring&&this.weaponSystem.isFiring!==void 0&&console.log("TouchControls: weaponSystem is likely a Combat instance, adapting interface");const t={hasMiningSystem:!!this.miningSystem,miningSystemType:this.miningSystem?this.miningSystem.constructor.name:"Not set",hasTargetingSystem:!!this.targetingSystem,targetingSystemType:this.targetingSystem?this.targetingSystem.constructor.name:"Not set",hasDockingSystem:!!this.dockingSystem,dockingSystemType:this.dockingSystem?this.dockingSystem.constructor.name:"Not set",hasWeaponSystem:!!this.weaponSystem,weaponSystemType:this.weaponSystem?this.weaponSystem.constructor.name:"Not set"};return console.log("TouchControls: Systems connected",t),this.miningSystem||console.error("TouchControls: Mining system is not connected - mining won't work!"),this.targetingSystem||console.error("TouchControls: Targeting system is not connected - targeting won't work!"),!this.spaceship&&e.spaceship&&(this.spaceship=e.spaceship,console.log("TouchControls: Spaceship reference set from controls")),this}createCrosshair(){const e=document.createElement("div");e.id="mobile-crosshair",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="10px",e.style.height="10px",e.style.pointerEvents="none",e.style.zIndex="999",e.innerHTML=`
            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background-color: rgba(120, 220, 232, 0.8);"></div>
            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background-color: rgba(120, 220, 232, 0.8);"></div>
            <div style="position: absolute; top: 50%; left: 50%; width: 3px; height: 3px; background-color: rgba(120, 220, 232, 0.8); border-radius: 50%; transform: translate(-50%, -50%);"></div>
        `,document.body.appendChild(e)}loadNippleJS(){return new Promise((e,t)=>{if(window.nipplejs){e();return}const s=document.createElement("script");s.src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js",s.async=!0,s.onload=()=>e(),s.onerror=()=>t(new Error("Failed to load nipple.js")),document.head.appendChild(s)})}setupTouchControls(){this.createJoystickZones(),this.createActionButtons(),setTimeout(()=>{this.initializeJoysticks(),this.isInitialized=!0},100)}createJoystickZones(){const e=document.createElement("div");e.id="leftJoystickZone",e.style.position="absolute",e.style.bottom="50px",e.style.left="50px",e.style.width="100px",e.style.height="100px",e.style.zIndex="1000",e.addEventListener("touchstart",s=>s.preventDefault(),{passive:!1}),e.addEventListener("touchmove",s=>s.preventDefault(),{passive:!1}),e.addEventListener("touchend",s=>s.preventDefault(),{passive:!1}),document.body.appendChild(e);const t=document.createElement("div");t.id="rightJoystickZone",t.style.position="absolute",t.style.bottom="50px",t.style.right="50px",t.style.width="100px",t.style.height="100px",t.style.zIndex="1000",t.addEventListener("touchstart",s=>s.preventDefault(),{passive:!1}),t.addEventListener("touchmove",s=>s.preventDefault(),{passive:!1}),t.addEventListener("touchend",s=>s.preventDefault(),{passive:!1}),document.body.appendChild(t)}createActionButtons(){const e=document.createElement("div");e.id="mobile-action-buttons-left",e.style.position="absolute",e.style.bottom="170px",e.style.left="20px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="15px",e.style.zIndex="1000",document.body.appendChild(e);const t=document.createElement("div");t.id="mobile-action-buttons-right",t.style.position="absolute",t.style.bottom="170px",t.style.right="20px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px",t.style.zIndex="1000",document.body.appendChild(t),this.fireButton=this.createActionButton(e,"FIRE","rgba(255, 80, 80, 0.8)"),this.addButtonEvents(this.fireButton,this.handleFiringStart.bind(this),this.handleFiringEnd.bind(this)),this.mineButton=this.createActionButton(e,"MINE","rgba(120, 220, 232, 0.8)"),this.addButtonEvents(this.mineButton,this.handleMiningStart.bind(this),this.handleMiningEnd.bind(this)),this.targetButton=this.createActionButton(t,"TARGET","rgba(255, 215, 0, 0.8)"),this.addButtonEvents(this.targetButton,this.handleTargeting.bind(this)),this.dockButton=this.createActionButton(null,"DOCK","rgba(51, 153, 255, 0.8)"),this.dockButton.style.position="absolute",this.dockButton.style.top="50%",this.dockButton.style.left="50%",this.dockButton.style.transform="translate(-50%, -50%)",this.dockButton.style.width="100px",this.dockButton.style.height="100px",this.dockButton.style.fontSize="20px",this.dockButton.style.boxShadow="0 0 25px rgba(51, 153, 255, 0.8)",this.dockButton.style.zIndex="10000",this.dockButton.style.display="none",this.addButtonEvents(this.dockButton,this.handleDocking.bind(this)),document.body.appendChild(this.dockButton),this.deployLaserButton=this.createActionButton(t,"DEPLOY","rgba(255, 100, 100, 0.8)"),this.addButtonEvents(this.deployLaserButton,this.handleDeployLaser.bind(this))}createActionButton(e,t,s){const i=document.createElement("div");return i.className="mobile-action-button",i.textContent=t,i.style.width="60px",i.style.height="60px",i.style.borderRadius="50%",i.style.backgroundColor="rgba(10, 20, 30, 0.7)",i.style.border=`2px solid ${s}`,i.style.color=s,i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i.style.fontFamily='"Rajdhani", sans-serif',i.style.fontSize="16px",i.style.fontWeight="bold",i.style.boxShadow=`0 0 10px ${s}`,i.style.userSelect="none",i.style.touchAction="manipulation",i.style.cursor="pointer",i.style.transform="translateZ(0)",i.style.webkitTapHighlightColor="transparent",i.style.backfaceVisibility="hidden",e&&e.appendChild(i),i}initializeJoysticks(){if(!window.nipplejs){console.error("nipplejs is not loaded");return}this.leftJoystick=window.nipplejs.create({zone:document.getElementById("leftJoystickZone"),mode:"static",position:{left:"50%",top:"50%"},color:"rgba(120, 220, 232, 0.8)",size:100,threshold:this.threshold,dynamicPage:!0,fadeTime:100,lockX:!1,lockY:!1}),this.rightJoystick=window.nipplejs.create({zone:document.getElementById("rightJoystickZone"),mode:"static",position:{left:"50%",top:"50%"},color:"rgba(120, 220, 232, 0.8)",size:100,threshold:this.threshold,dynamicPage:!0,fadeTime:100,lockX:!1,lockY:!1}),this.setupJoystickEvents()}setupJoystickEvents(){this.leftJoystick.on("move",(e,t)=>{this.handleThrustJoystick(t)}).on("end",()=>{this.resetThrust()}),this.rightJoystick.on("move",(e,t)=>{this.handleRotationJoystick(t)}).on("end",()=>{})}handleThrustJoystick(e){if(this.spaceship.isDocked)return;this.resetThrust();const t=e.force>2?2:e.force,s=e.angle.radian;s>1&&s<2?this.spaceship.thrust.forward=!0:s>4&&s<5.5&&(this.spaceship.thrust.backward=!0),s>2.5&&s<4?this.spaceship.thrust.right=!0:(s>=0&&s<1||s>5.5)&&(this.spaceship.thrust.left=!0),this.spaceship.thrust.boost=t>1.5}handleRotationJoystick(e){if(this.spaceship.isDocked)return;const t=e.vector.x*e.force*.015,s=-e.vector.y*e.force*.015;this.physics.updateRotation(t,s)}resetThrust(){this.spaceship&&(this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.boost=!1)}handleMiningStart(){try{if(console.log("TouchControls: handleMiningStart called"),!this.targetingSystem){console.error("TouchControls: Targeting system not available");return}if(!this.miningSystem){console.error("TouchControls: Mining system not available");return}let e=this.targetingSystem.getCurrentTarget();if(console.log("TouchControls: Initial target:",e),!e&&(console.log("TouchControls: No target selected, enabling targeting and finding nearest target"),this.targetingSystem.isLockOnEnabled()||this.targetingSystem.toggleLockOn(),e=this.targetingSystem.findNearestTarget(),console.log("TouchControls: Found nearest target:",e),!e)){console.log("TouchControls: No targets in range after scan");return}if(!e||!e.mesh||!e.mesh.position){console.error("TouchControls: Target asteroid is missing required properties",e);const t=window.gameInstance||window.game;if(t&&t.environment&&t.environment.asteroids&&t.environment.asteroids.length>0){console.log("TouchControls: Attempting to get asteroid directly from environment");let s=1/0,i=null;for(const o of t.environment.asteroids)if(o&&o.mesh&&o.mesh.position&&this.spaceship&&this.spaceship.mesh){const n=o.mesh.position.distanceTo(this.spaceship.mesh.position);n<s&&(s=n,i=o)}if(i)console.log("TouchControls: Found closest asteroid from environment:",i),e=i;else{console.error("TouchControls: Could not find any valid asteroids in environment");return}}else{console.error("TouchControls: Could not access environment to find asteroids");return}}if(console.log("TouchControls: Target asteroid found:",e),!e||!e.mesh||!e.mesh.position){console.error("TouchControls: Target asteroid is still invalid after fallback attempts");return}this.miningSystem.setTargetAsteroid(e),console.log("TouchControls: Target set for mining:",{resourceType:e.resourceType||"unknown",position:e.mesh?e.mesh.position.toArray():"no mesh",distance:e.mesh&&this.spaceship&&this.spaceship.mesh?e.mesh.position.distanceTo(this.spaceship.mesh.position):"unknown"}),console.log("TouchControls: Starting mining operation"),this.miningSystem.startMining(),console.log("TouchControls: Mining started:",this.miningSystem.isMining)}catch(e){console.error("TouchControls: Error in handleMiningStart:",e)}}handleMiningEnd(){try{if(console.log("TouchControls: handleMiningEnd called"),!this.miningSystem){console.error("TouchControls: Mining system not available for stopping");return}this.miningSystem.stopMining(),console.log("TouchControls: Mining stopped")}catch(e){console.error("TouchControls: Error stopping mining:",e)}}handleFiringStart(){try{if(this.weaponSystem){typeof this.weaponSystem.setFiring=="function"?this.weaponSystem.setFiring(!0):this.weaponSystem.isWeaponActive=!0;const t=window.gameInstance||window.game;t&&t.audio&&t.audio.playSound("laser");return}const e=window.gameInstance||window.game;if(!e){console.error("No game reference found");return}if(e.combat){e.combat.setFiring(!0),e.audio&&e.audio.playSound("laser");return}if(e.weaponSystem){typeof e.weaponSystem.setFiring=="function"?e.weaponSystem.setFiring(!0):e.weaponSystem.isWeaponActive=!0,e.audio&&e.audio.playSound("laser");return}if(e.controls&&e.controls.weaponSystem){typeof e.controls.weaponSystem.setFiring=="function"?e.controls.weaponSystem.setFiring(!0):e.controls.weaponSystem.isWeaponActive=!0,e.audio&&e.audio.playSound("laser");return}console.error("No weapon system or combat system found")}catch(e){console.error("Error in handleFiringStart:",e)}}handleFiringEnd(){try{if(this.weaponSystem){typeof this.weaponSystem.setFiring=="function"?this.weaponSystem.setFiring(!1):this.weaponSystem.isWeaponActive=!1;const t=window.gameInstance||window.game;t&&t.audio&&t.audio.stopSound("laser");return}const e=window.gameInstance||window.game;if(!e){console.error("No game reference found");return}if(e.combat){e.combat.setFiring(!1),e.audio&&e.audio.stopSound("laser");return}if(e.weaponSystem){typeof e.weaponSystem.setFiring=="function"?e.weaponSystem.setFiring(!1):e.weaponSystem.isWeaponActive=!1,e.audio&&e.audio.stopSound("laser");return}if(e.controls&&e.controls.weaponSystem){typeof e.controls.weaponSystem.setFiring=="function"?e.controls.weaponSystem.setFiring(!1):e.controls.weaponSystem.isWeaponActive=!1,e.audio&&e.audio.stopSound("laser");return}console.error("No weapon system or combat system found")}catch(e){console.error("Error in handleFiringEnd:",e)}}handleDocking(){if(!this.dockingSystem){console.error("Docking system not available");return}console.log("TouchControls: Dock button pressed, attempting to dock with stargate"),this.dockingSystem.dockWithStargate(),this.hideDockButton()}handleTargeting(){if(!this.targetingSystem){console.error("Targeting system not available");return}this.targetingSystem.toggleLockOn()}showDockButton(){if(this.dockButton){if(this.dockButton.style.display="flex",this.dockButton.style.zIndex="10000",this.dockButton.style.position="absolute",this.dockButton.style.top="50%",this.dockButton.style.left="50%",console.log("Showing dock button - near stargate"),!this.dockButton.style.animation&&(this.dockButton.style.animation="pulse 1.5s infinite",!document.getElementById("mobile-pulse-animation"))){const e=document.createElement("style");e.id="mobile-pulse-animation",e.textContent=`
                        @keyframes pulse {
                            0% { transform: translate(-50%, -50%) scale(1); }
                            50% { transform: translate(-50%, -50%) scale(1.1); }
                            100% { transform: translate(-50%, -50%) scale(1); }
                        }
                    `,document.head.appendChild(e)}console.log("Dock button shown with styles:",{display:this.dockButton.style.display,zIndex:this.dockButton.style.zIndex,position:this.dockButton.style.position,width:this.dockButton.style.width,height:this.dockButton.style.height})}}hideDockButton(){this.dockButton&&(this.dockButton.style.display="none")}hide(){const e=document.getElementById("leftJoystickZone"),t=document.getElementById("rightJoystickZone");e&&(e.style.display="none"),t&&(t.style.display="none");const s=document.getElementById("mobile-action-buttons-left"),i=document.getElementById("mobile-action-buttons-right");s&&(s.style.display="none"),i&&(i.style.display="none"),this.hideDockButton()}show(){if(this.spaceship&&this.spaceship.isDocked||window.game&&window.game.introSequenceActive){console.log("TouchControls: Not showing controls during docked state or intro sequence");return}const e=document.getElementById("leftJoystickZone"),t=document.getElementById("rightJoystickZone");e&&(e.style.display="block"),t&&(t.style.display="block");const s=document.getElementById("mobile-action-buttons-left"),i=document.getElementById("mobile-action-buttons-right");s&&(s.style.display="flex"),i&&(i.style.display="flex")}update(){if(this.dockingSystem&&this.spaceship)this.dockingSystem.nearStargate&&!this.spaceship.isDocked?this.showDockButton():this.hideDockButton();else{const e=window.gameInstance||window.game;e&&e.controls&&e.controls.dockingSystem&&(e.controls.dockingSystem.nearStargate&&!this.spaceship.isDocked?this.showDockButton():this.hideDockButton())}}addButtonEvents(e,t,s=null){if(!e){console.error("TouchControls: Cannot add events to null button");return}s?(e.addEventListener("touchstart",i=>{i.preventDefault(),e.style.transform="scale(0.95) translateZ(0)",t()},{passive:!1}),e.addEventListener("touchend",i=>{i.preventDefault(),e.style.transform="scale(1) translateZ(0)",s()},{passive:!1}),e.addEventListener("pointerdown",i=>{i.preventDefault(),i.pointerType!=="touch"&&(e.style.transform="scale(0.95) translateZ(0)",t())}),e.addEventListener("pointerup",i=>{i.preventDefault(),i.pointerType!=="touch"&&(e.style.transform="scale(1) translateZ(0)",s())}),e.addEventListener("mousedown",i=>{e.style.transform="scale(0.95) translateZ(0)",t()}),e.addEventListener("mouseup",i=>{e.style.transform="scale(1) translateZ(0)",s()})):(e.addEventListener("touchstart",i=>{i.preventDefault(),e.style.transform="scale(0.95) translateZ(0)",e===this.dockButton&&console.log("Dock button touchstart event fired")},{passive:!1}),e.addEventListener("touchend",i=>{i.preventDefault(),e.style.transform="scale(1) translateZ(0)",e===this.dockButton&&console.log("Dock button touchend event fired, calling handler"),t()},{passive:!1}),e.addEventListener("pointerdown",i=>{i.preventDefault(),i.pointerType!=="touch"&&(e.style.transform="scale(0.95) translateZ(0)",e===this.dockButton&&console.log("Dock button pointerdown event fired"))}),e.addEventListener("pointerup",i=>{i.preventDefault(),i.pointerType!=="touch"&&(e.style.transform="scale(1) translateZ(0)",e===this.dockButton&&console.log("Dock button pointerup event fired, calling handler"),t())}),e.addEventListener("mousedown",i=>{e.style.transform="scale(0.95) translateZ(0)"}),e.addEventListener("mouseup",i=>{e.style.transform="scale(1) translateZ(0)",t()}))}handleDeployLaser(){console.log("TouchControls: Deploying laser turret"),window.mainMessageBus&&window.mainMessageBus.publish("input.deployLaser",{})}}class ye{static isMobile(){if(this._isMobileCache!==void 0)return this._isMobileCache;const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Android|iP(ad|hone|od)/i.test(navigator.userAgent),t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||window.DocumentTouch&&document instanceof DocumentTouch,s=window.innerWidth<900,i=(()=>{const r=document.querySelector("meta[name=viewport]");return r?r.content.includes("width=device-width"):!1})(),o="orientation"in window||"onorientationchange"in window,n="DeviceMotionEvent"in window||"DeviceOrientationEvent"in window,a=(()=>{const r=navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,l=/android/i.test(navigator.userAgent)&&!/mobile/i.test(navigator.userAgent);return r||l})();return this._isMobileCache=e||t&&(s||o||n||i||a),console.log(`MobileDetector: Device detected as ${this._isMobileCache?"mobile":"desktop"}`),console.log(`- UA: ${e}, touch: ${t}, screen: ${s}`),console.log(`- features: ${o}, motion: ${n}, tablet: ${a}`),this._isMobileCache}static resetCache(){this._isMobileCache=void 0}static hasTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0||window.DocumentTouch&&document instanceof DocumentTouch}static getOrientation(){return window.innerHeight>window.innerWidth?"portrait":"landscape"}static addOrientationChangeHandler(e){let t=this.getOrientation();const s=()=>{const i=this.getOrientation();i!==t&&(t=i,this.resetCache(),e(i))};window.addEventListener("resize",s),"onorientationchange"in window&&window.addEventListener("orientationchange",s)}}class xo{constructor(e,t,s,i){console.log("Initializing controls systems..."),this.spaceship=e,this.physics=t,this.environment=s,this.ui=i,this.isMobile=ye.isMobile(),this._wasDocked=e?e.isDocked:!1,this.weaponSystem=null,this.scene=t.scene,this.isMobile?(console.log("Initializing touch controls for mobile"),this.touchControls=new Oi(e,t),this.inputHandler={isLocked:()=>!1,exitPointerLock:()=>{}}):(console.log("Initializing keyboard/mouse controls"),this.inputHandler=new $i(e,t)),this.miningSystem=new zi(e,this.scene),this.targetingSystem=new Ui(e,this.scene,s),this.dockingSystem=new Hi(e,s.stargate,i),this.resources=this.miningSystem.resources,this.dockingSystem.setResources(this.resources),this.resources.orbs||(this.resources.orbs={common:0,uncommon:0,rare:0,epic:0,legendary:0}),this.isMobile&&this.touchControls&&this.touchControls.setControlSystems(this),this.connectUpgradeEffects(),this.setupEventHandlers(),this.lastAnomalyCheck=0,this.currentAnomaly=null,this.showingAnomalyNotification=!1,console.log("Control systems initialized")}connectUpgradeEffects(){this.dockingSystem.updateMiningSystem=()=>{if(this.miningSystem&&this.spaceship){const e=this.spaceship.miningEfficiency;Object.keys(this.miningSystem.miningSpeedByType).forEach(t=>{this.miningSystem._originalMiningSpeedByType||(this.miningSystem._originalMiningSpeedByType={...this.miningSystem.miningSpeedByType});const s=this.miningSystem._originalMiningSpeedByType[t];this.miningSystem.miningSpeedByType[t]=s*e}),console.log("Mining speeds updated with efficiency:",e),this.miningSystem.targetAsteroid&&this.miningSystem.setTargetAsteroid(this.miningSystem.targetAsteroid)}}}setupEventHandlers(){if(this.isMobile){console.log("Mobile device detected, touch handlers are set in TouchControls class");return}document.addEventListener("keydown",e=>{switch(e.key.toLowerCase()){case"e":this.targetingSystem.toggleLockOn();break;case"tab":if(this.targetingSystem.isLockOnEnabled()){const t=this.targetingSystem.cycleLockOnTarget();t&&this.miningSystem.setTargetAsteroid(t)}e.preventDefault();break;case"r":if(this.targetingSystem.isLockOnEnabled()){const t=this.targetingSystem.getCurrentTarget();t&&(this.miningSystem.setTargetAsteroid(t),this.miningSystem.isMining?this.miningSystem.stopMining():this.miningSystem.startMining())}break;case"t":console.log("Deploying laser turret"),window.mainMessageBus&&window.mainMessageBus.publish("input.deployLaser",{});break;case"g":console.log("Attempting to pick up an item"),window.mainMessageBus&&window.mainMessageBus.publish("input.pickupInteract",{});break}}),document.addEventListener("mousedown",e=>{e.button===0&&this.inputHandler.isLocked()&&window.game&&window.game.combat&&window.game.combat.setFiring(!0)}),document.addEventListener("mouseup",e=>{e.button===0&&window.game&&window.game.combat&&window.game.combat.setFiring(!1)})}setupStargateUIControls(){this.dockingSystem&&this.dockingSystem.setupStargateUIControls()}dockWithStargate(){this.dockingSystem?(this.dockingSystem.dockWithStargate(),this.isMobile&&this.touchControls&&this.touchControls.hide()):console.error("Docking system not initialized")}collectEnergyOrb(){if(!this.environment||!this.spaceship)return;const e=this.environment.checkAnomalyCollision(this.spaceship.mesh.position);if(!e)return;const t=this.environment.collectAnomalyOrb(e);if(!t)return;this.resources.orbs||(this.resources.orbs={common:0,uncommon:0,rare:0,epic:0,legendary:0}),this.resources.orbs[t.rarity]++;let s;switch(t.rarity){case"legendary":s="#ff0000";break;case"epic":s="#ff6600";break;case"rare":s="#9900ff";break;case"uncommon":s="#0066ff";break;default:s="#00ff66";break}const i=t.rarity.charAt(0).toUpperCase()+t.rarity.slice(1);if(this.showAnomalyMessage(`Collected ${i} Energy Orb (${t.value} CR)`,s),this.triggerOrbCollectionEffect(e),window.game&&window.game.audio)switch(t.rarity){case"legendary":window.game.audio.playSoundEffect("powerup_legendary",.8);break;case"epic":window.game.audio.playSoundEffect("powerup_epic",.7);break;case"rare":window.game.audio.playSoundEffect("powerup_rare",.6);break;case"uncommon":window.game.audio.playSoundEffect("powerup_uncommon",.5);break;default:window.game.audio.playSoundEffect("powerup_common",.4);break}}triggerOrbCollectionEffect(e){if(!(!this.scene||!e)&&window.game&&window.game.combat){const t=e.position.clone();window.game.combat.createExplosionEffect(t,2e3,!0),window.mainMessageBus&&window.mainMessageBus.publish("vfx.explosion",{position:t,color:e.orb.color,size:e.orb.size*2,duration:2e3})}}showAnomalyMessage(e,t){if(this.showingAnomalyNotification)return;this.showingAnomalyNotification=!0;const s=document.createElement("div");s.style.position="fixed",s.style.top="30%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.8)",s.style.color=t||"#ffffff",s.style.padding="15px 30px",s.style.borderRadius="10px",s.style.border=`2px solid ${t||"#ffffff"}`,s.style.boxShadow=`0 0 15px ${t||"#ffffff"}`,s.style.fontFamily="Courier New, monospace",s.style.fontSize="18px",s.style.zIndex="1000",s.style.textAlign="center",s.style.pointerEvents="none",s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transition="opacity 0.8s",setTimeout(()=>{s.remove(),this.showingAnomalyNotification=!1},800)},3e3)}update(e=1/60){if(!(window.game&&window.game.introSequenceActive)){if(this.spaceship){const t=this._wasDocked,s=this.spaceship.isDocked;this.isMobile&&this.touchControls&&t!==s&&(s?this.touchControls.hide():this.touchControls.show(),this._wasDocked=s)}if(this.spaceship&&this.spaceship.isDocked){this.dockingSystem&&this.dockingSystem.update();return}if(this.targetingSystem&&this.targetingSystem.update(),this.miningSystem){this.miningSystem.update(e);const t=this.miningSystem.getLastDestroyedAsteroid();t&&this.environment&&this.environment.asteroidBelt&&this.environment.asteroidBelt.removeAsteroid(t)}this.dockingSystem&&this.dockingSystem.update(),this.isMobile&&this.touchControls&&this.touchControls.update(),this.deploymentSystem&&this.deploymentSystem.update(),this.checkForAnomalyOrbs()}}checkForAnomalyOrbs(){if(!this.environment||!this.spaceship)return;const e=performance.now();if(e-this.lastAnomalyCheck<500)return;this.lastAnomalyCheck=e;const t=this.environment.checkAnomalyCollision(this.spaceship.mesh.position);t&&!t.orbCollected?(this.collectEnergyOrb(),this.currentAnomaly=null):t&&t!==this.currentAnomaly&&t.orbCollected?(this.currentAnomaly=t,this.showAnomalyMessage("Energy orb already collected","#ff3333")):t||(this.currentAnomaly=null)}get isMining(){return this.miningSystem?this.miningSystem.isMining:!1}get miningProgress(){return this.miningSystem?this.miningSystem.miningProgress:0}}class Ni{constructor(e){this.spaceship=e,this.setupHUD(),this.animationFrames=[],this.glitchInterval=null,this.scanline=null,this.hudOpacity=0,this.animateHudIn()}setupHUD(){const e=document.createElement("div");e.id="hud-container",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.fontFamily='"Rajdhani", "Electrolize", sans-serif',e.style.fontWeight="400",e.style.color="rgba(120, 220, 232, 0.9)",e.style.textShadow="0 0 10px rgba(120, 220, 232, 0.5)",e.style.opacity="0",e.style.transition="opacity 0.5s ease",document.body.appendChild(e);const t=document.createElement("link");t.href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600&family=Electrolize&display=swap",t.rel="stylesheet",document.head.appendChild(t),this.createScanlineEffect(e),this.createFlightPanel(e),this.createStatusPanel(e),this.createTargetingSystem(e),this.createLocationPanel(e),this.createResourcePanel(e),this.createNotificationsArea(e)}createScanlineEffect(e){const t=document.createElement("div");t.id="scanline-effect",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="linear-gradient(transparent 50%, rgba(120, 220, 232, 0.03) 50%)",t.style.backgroundSize="100% 4px",t.style.zIndex="1000",t.style.pointerEvents="none",t.style.opacity="0.5",e.appendChild(t);const s=document.createElement("div");s.id="active-scanline",s.style.position="absolute",s.style.left="0",s.style.width="100%",s.style.height="3px",s.style.background="linear-gradient(90deg, transparent 0%, rgba(120, 220, 232, 0.1) 50%, transparent 100%)",s.style.boxShadow="0 0 10px rgba(120, 220, 232, 0.3)",s.style.zIndex="1001",s.style.top="0",s.style.opacity="0.7",s.style.pointerEvents="none",e.appendChild(s),this.scanline=s}createFlightPanel(e){const t=document.createElement("div");t.id="flight-panel",t.className="hud-panel",t.style.position="absolute",t.style.bottom="20px",t.style.left="20px",t.style.width="260px",t.style.padding="15px",t.style.backgroundColor="rgba(6, 22, 31, 0.7)",t.style.backdropFilter="blur(5px)",t.style.borderRadius="10px",t.style.border="1px solid rgba(120, 220, 232, 0.3)",t.style.boxShadow="0 0 15px rgba(120, 220, 232, 0.2), inset 0 0 10px rgba(120, 220, 232, 0.1)",t.style.overflow="hidden",e.appendChild(t);const s=document.createElement("div");s.className="panel-header",s.innerHTML="<span>FLIGHT SYSTEMS</span>",s.style.fontWeight="600",s.style.fontSize="14px",s.style.textTransform="uppercase",s.style.letterSpacing="2px",s.style.marginBottom="15px",s.style.paddingBottom="8px",s.style.borderBottom="1px solid rgba(120, 220, 232, 0.3)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",t.appendChild(s);const i=document.createElement("div");i.className="status-indicator",i.style.width="8px",i.style.height="8px",i.style.borderRadius="50%",i.style.backgroundColor="rgba(120, 220, 232, 0.8)",i.style.boxShadow="0 0 5px rgba(120, 220, 232, 0.8)",i.style.animation="pulse 2s infinite",s.appendChild(i);const o=document.createElement("div");o.className="panel-row",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.margin="10px 0",t.appendChild(o);const n=document.createElement("span");n.className="row-label",n.textContent="FUEL",n.style.width="40%",o.appendChild(n);const a=document.createElement("span");a.id="fuel-value",a.className="row-value",a.textContent="100 / 100",a.style.position="absolute",a.style.right="15px",a.style.top="-18px",a.style.fontSize="12px",a.style.color="rgba(120, 220, 232, 0.9)";const r=document.createElement("div");r.style.width="60%",r.style.height="10px",r.style.backgroundColor="rgba(10, 30, 40, 0.5)",r.style.borderRadius="5px",r.style.overflow="hidden",r.style.position="relative",r.appendChild(a),o.appendChild(r);const l=document.createElement("div");l.id="fuel-bar",l.style.width="100%",l.style.height="100%",l.style.backgroundColor="rgba(120, 220, 232, 0.8)",l.style.boxShadow="inset 0 0 5px rgba(255, 255, 255, 0.5)",l.style.transition="width 0.3s ease",r.appendChild(l),this.createPanelRow(t,"CREDITS","credits","1000 CR");const c=document.createElement("button");c.id="show-controls",c.textContent="SYSTEM CONTROLS",c.style.width="100%",c.style.marginTop="15px",c.style.padding="8px",c.style.backgroundColor="rgba(120, 220, 232, 0.15)",c.style.border="1px solid rgba(120, 220, 232, 0.5)",c.style.borderRadius="5px",c.style.color="rgba(120, 220, 232, 0.9)",c.style.fontSize="12px",c.style.fontFamily='"Rajdhani", sans-serif',c.style.cursor="pointer",c.style.transition="all 0.2s ease",c.style.textTransform="uppercase",c.style.letterSpacing="1px",c.style.fontWeight="600",c.style.outline="none",c.style.pointerEvents="auto",c.addEventListener("mouseover",()=>{c.style.backgroundColor="rgba(120, 220, 232, 0.3)",c.style.boxShadow="0 0 10px rgba(120, 220, 232, 0.5)"}),c.addEventListener("mouseout",()=>{c.style.backgroundColor="rgba(120, 220, 232, 0.15)",c.style.boxShadow="none"}),t.appendChild(c),this.addHolographicElements(t)}createStatusPanel(e){const t=document.createElement("div");t.id="status-panel",t.className="hud-panel",t.style.position="absolute",t.style.bottom="20px",t.style.right="20px",t.style.width="260px",t.style.padding="15px",t.style.backgroundColor="rgba(6, 22, 31, 0.7)",t.style.backdropFilter="blur(5px)",t.style.borderRadius="10px",t.style.border="1px solid rgba(120, 220, 232, 0.3)",t.style.boxShadow="0 0 15px rgba(120, 220, 232, 0.2), inset 0 0 10px rgba(120, 220, 232, 0.1)",e.appendChild(t);const s=document.createElement("div");s.className="panel-header",s.innerHTML="<span>SHIP STATUS</span>",s.style.fontWeight="600",s.style.fontSize="14px",s.style.textTransform="uppercase",s.style.letterSpacing="2px",s.style.marginBottom="15px",s.style.paddingBottom="8px",s.style.borderBottom="1px solid rgba(120, 220, 232, 0.3)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",t.appendChild(s);const i=document.createElement("div");i.className="status-indicator",i.style.width="8px",i.style.height="8px",i.style.borderRadius="50%",i.style.backgroundColor="rgba(120, 220, 232, 0.8)",i.style.boxShadow="0 0 5px rgba(120, 220, 232, 0.8)",i.style.animation="pulse 2s infinite",s.appendChild(i);const o=document.createElement("div");o.className="panel-row",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.margin="10px 0",t.appendChild(o);const n=document.createElement("span");n.className="row-label",n.textContent="SHIELD",n.style.width="50%",o.appendChild(n);const a=document.createElement("div");a.style.width="50%",a.style.height="10px",a.style.backgroundColor="rgba(10, 30, 40, 0.5)",a.style.borderRadius="5px",a.style.overflow="hidden",o.appendChild(a);const r=document.createElement("div");r.id="shield-bar",r.style.width="100%",r.style.height="100%",r.style.backgroundColor="rgba(51, 153, 255, 0.8)",r.style.boxShadow="inset 0 0 5px rgba(255, 255, 255, 0.5)",r.style.transition="width 0.3s ease",a.appendChild(r);const l=document.createElement("div");l.className="panel-row",l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.margin="10px 0",t.appendChild(l);const c=document.createElement("span");c.className="row-label",c.textContent="HULL INTEGRITY",c.style.width="50%",l.appendChild(c);const d=document.createElement("div");d.style.width="50%",d.style.height="10px",d.style.backgroundColor="rgba(10, 30, 40, 0.5)",d.style.borderRadius="5px",d.style.overflow="hidden",l.appendChild(d);const h=document.createElement("div");h.id="hull-bar",h.style.width="100%",h.style.height="100%",h.style.backgroundColor="rgba(120, 220, 232, 0.8)",h.style.boxShadow="inset 0 0 5px rgba(255, 255, 255, 0.5)",h.style.transition="width 0.3s ease",d.appendChild(h),this.addHolographicElements(t);const u=document.createElement("button");u.id="sound-toggle",u.textContent="SOUND: ON",u.style.background="none",u.style.border="1px solid rgba(120, 220, 232, 0.5)",u.style.color="rgba(120, 220, 232, 0.9)",u.style.padding="5px 10px",u.style.borderRadius="5px",u.style.cursor="pointer",u.style.fontFamily='"Rajdhani", sans-serif',u.style.fontSize="12px",u.style.marginLeft="10px",u.style.marginTop="10px",u.style.outline="none",u.style.pointerEvents="auto",u.addEventListener("click",()=>{if(window.game&&window.game.audio){const m=window.game.audio.toggleMute();u.textContent=m?"SOUND: OFF":"SOUND: ON"}}),t.appendChild(u)}createTargetingSystem(e){const t=document.createElement("div");t.id="targeting-system",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.width="100px",t.style.height="100px",t.style.zIndex="100",e.appendChild(t);const s=document.createElement("div");s.id="crosshair",s.style.position="absolute",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.width="50px",s.style.height="50px",s.innerHTML=`
            <svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="25" cy="25" r="20" stroke="rgba(120, 220, 232, 0.5)" stroke-width="1" stroke-dasharray="8 4"/>
                <circle cx="25" cy="25" r="3" stroke="rgba(120, 220, 232, 0.8)" stroke-width="1"/>
                <circle cx="25" cy="25" r="1" fill="rgba(120, 220, 232, 0.8)"/>
                <line x1="25" y1="10" x2="25" y2="18" stroke="rgba(120, 220, 232, 0.8)" stroke-width="1"/>
                <line x1="25" y1="32" x2="25" y2="40" stroke="rgba(120, 220, 232, 0.8)" stroke-width="1"/>
                <line x1="10" y1="25" x2="18" y2="25" stroke="rgba(120, 220, 232, 0.8)" stroke-width="1"/>
                <line x1="32" y1="25" x2="40" y2="25" stroke="rgba(120, 220, 232, 0.8)" stroke-width="1"/>
                <!-- Add a pulsing animation to the outer circle -->
                <circle cx="25" cy="25" r="24" stroke="rgba(120, 220, 232, 0.3)" stroke-width="1">
                    <animate attributeName="r" values="24;28;24" dur="3s" repeatCount="indefinite"/>
                    <animate attributeName="opacity" values="0.3;0.1;0.3" dur="3s" repeatCount="indefinite"/>
                </circle>
            </svg>
        `,t.appendChild(s);const i=document.createElement("div");i.id="target-info",i.style.position="absolute",i.style.top="60px",i.style.left="50%",i.style.transform="translateX(-50%)",i.style.width="200px",i.style.backgroundColor="rgba(6, 22, 31, 0.5)",i.style.backdropFilter="blur(5px)",i.style.borderRadius="5px",i.style.padding="8px",i.style.fontSize="12px",i.style.color="rgba(120, 220, 232, 0.9)",i.style.border="1px solid rgba(120, 220, 232, 0.3)",i.style.boxShadow="0 0 10px rgba(120, 220, 232, 0.2)",i.style.textAlign="center",i.style.display="none",t.appendChild(i),i.innerHTML=`
            <div id="target-name" style="font-weight:600; margin-bottom:5px; font-size:14px;">NO TARGET</div>
            <div id="target-distance" style="margin-bottom:3px;">DISTANCE: ---</div>
            <div id="target-type" style="margin-bottom:3px;">TYPE: ---</div>
            <div id="target-resources" style="margin-bottom:3px;">RESOURCES: ---</div>
        `;const o=document.createElement("div");o.id="laser-beam",o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.width="0px",o.style.height="2px",o.style.backgroundColor="rgba(255, 50, 50, 0.8)",o.style.boxShadow="0 0 10px rgba(255, 50, 50, 0.8)",o.style.transformOrigin="left",o.style.transform="rotate(var(--angle, 0deg))",o.style.zIndex="90",o.style.display="none",e.appendChild(o)}createLocationPanel(e){const t=document.createElement("div");t.id="location-panel",t.className="hud-panel",t.style.position="absolute",t.style.top="20px",t.style.left="20px",t.style.padding="10px 20px",t.style.backgroundColor="rgba(6, 22, 31, 0.7)",t.style.backdropFilter="blur(5px)",t.style.borderRadius="8px",t.style.border="1px solid rgba(120, 220, 232, 0.3)",t.style.boxShadow="0 0 15px rgba(120, 220, 232, 0.2)",t.style.fontSize="14px",e.appendChild(t),t.innerHTML=`
            <div style="display:flex; align-items:center; gap:10px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" 
                          fill="rgba(120, 220, 232, 0.8)"/>
                </svg>
                <span id="current-system" style="font-weight:600; letter-spacing:1px;">SOLAR SYSTEM</span>
            </div>
            <div id="location-coordinates" style="margin-top:5px; font-size:12px; opacity:0.8;">X: 0 Y: 0 Z: 0</div>
            <div id="fps-display" style="margin-top:5px; font-size:12px; opacity:0.8;">FPS: 0</div>
            <div style="margin-top:5px; display:flex; align-items:center; gap:10px; font-size:12px; opacity:0.8;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" 
                          fill="rgba(120, 220, 232, 0.8)"/>
                    <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" 
                          fill="rgba(120, 220, 232, 0.5)"/>
                </svg>
                <span>ANOMALIES: <span id="anomaly-count" style="font-weight:600;">0</span></span>
            </div>
        `,this.addCornerElements(t)}createResourcePanel(e){const t=document.createElement("div");t.id="resource-panel",t.className="hud-panel",t.style.position="absolute",t.style.top="20px",t.style.right="20px",t.style.width="180px",t.style.padding="10px 15px",t.style.backgroundColor="rgba(6, 22, 31, 0.7)",t.style.backdropFilter="blur(5px)",t.style.borderRadius="8px",t.style.border="1px solid rgba(120, 220, 232, 0.3)",t.style.boxShadow="0 0 15px rgba(120, 220, 232, 0.2)",t.style.fontSize="14px",e.appendChild(t);const s=document.createElement("div");s.className="panel-header",s.innerHTML="<span>CARGO BAY</span>",s.style.fontWeight="600",s.style.fontSize="12px",s.style.textTransform="uppercase",s.style.letterSpacing="1px",s.style.marginBottom="8px",s.style.paddingBottom="5px",s.style.borderBottom="1px solid rgba(120, 220, 232, 0.3)",s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",t.appendChild(s);const i=(c,d,h)=>{const u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="space-between",u.style.margin="5px 0";const m=document.createElement("div");m.style.width="12px",m.style.height="14px",m.style.clipPath="polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)",m.style.backgroundColor=h,m.style.marginRight="8px";const f=document.createElement("div");f.style.display="flex",f.style.alignItems="center",f.style.width="50%",f.style.fontSize="12px",f.appendChild(m),f.appendChild(document.createTextNode(c));const g=document.createElement("div");g.id=d,g.style.width="50%",g.style.textAlign="right",g.style.fontWeight="600",g.style.fontSize="12px",g.textContent="0",u.appendChild(f),u.appendChild(g),t.appendChild(u)};i("IRON","iron-amount","rgba(180, 180, 180, 0.8)"),i("GOLD","gold-amount","rgba(255, 215, 0, 0.8)"),i("PLATINUM","platinum-amount","rgba(229, 228, 226, 0.8)");const o=document.createElement("div");o.style.marginTop="8px",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.borderTop="1px solid rgba(120, 220, 232, 0.3)",o.style.paddingTop="8px",t.appendChild(o);const n=document.createElement("div");n.textContent="CAPACITY",n.style.fontSize="12px",o.appendChild(n);const a=document.createElement("div");a.id="cargo-capacity",a.textContent="0 / 1000",a.style.fontSize="12px",a.style.fontWeight="600",o.appendChild(a);const r=document.createElement("div");r.style.width="100%",r.style.height="5px",r.style.backgroundColor="rgba(10, 30, 40, 0.5)",r.style.borderRadius="3px",r.style.overflow="hidden",r.style.marginTop="5px",t.appendChild(r);const l=document.createElement("div");l.id="capacity-bar",l.style.width="0%",l.style.height="100%",l.style.backgroundColor="rgba(120, 220, 232, 0.8)",l.style.transition="width 0.3s ease",r.appendChild(l),this.addCornerElements(t)}createNotificationsArea(e){const t=document.createElement("div");t.id="notifications-area",t.style.position="absolute",t.style.top="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="10px",e.appendChild(t);const s=document.createElement("div");s.id="horde-mode-indicator",s.className="hud-panel",s.style.display="none",s.style.padding="8px 12px",s.style.backgroundColor="rgba(51, 10, 10, 0.8)",s.style.backdropFilter="blur(5px)",s.style.borderRadius="8px",s.style.border="1px solid #ff3030",s.style.boxShadow="0 0 15px rgba(255, 48, 48, 0.5)",s.style.animation="pulse-horde 2s infinite",s.style.marginBottom="10px",s.style.fontSize="18px",s.style.fontWeight="600",s.style.letterSpacing="1px";const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.gap="10px";const o=document.createElement("span");o.style.color="#ff3030",o.style.textShadow="0 0 5px rgba(255,48,48,0.5)",o.textContent="HORDE MODE";const n=document.createElement("span");n.id="horde-survival-time",n.style.color="#ff9999",n.style.fontWeight="bold",n.textContent="00:00",i.appendChild(o),i.appendChild(n),s.appendChild(i),this.addCornerElements(s),t.appendChild(s);const a=document.createElement("style");a.textContent=`
            @keyframes pulse-horde {
                0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }
                50% { box-shadow: 0 0 10px rgba(255, 30, 30, 0.8); }
                100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }
            }
        `,document.head.appendChild(a)}createPanelRow(e,t,s,i,o=!1){const n=document.createElement("div");n.className="panel-row",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.margin="8px 0",e.appendChild(n);const a=document.createElement("span");a.className="row-label",a.textContent=t,n.appendChild(a);const r=document.createElement("span");r.id=s,r.className="row-value",r.textContent=i,o&&i==="ON"?r.style.color="#5fff8f":o&&i==="OFF"&&(r.style.color="#ff7f7f"),n.appendChild(r)}createStatusRow(e,t,s,i){const o=document.createElement("div");o.className="status-row",o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.margin="8px 0",e.appendChild(o);const n=document.createElement("span");n.className="row-label",n.textContent=t,n.style.fontSize="12px",o.appendChild(n);const a=document.createElement("span");a.id=s,a.className="row-value",a.textContent=i,a.style.fontSize="12px",a.style.fontWeight="600",i==="NOMINAL"?a.style.color="rgba(120, 220, 232, 0.9)":i==="WARNING"?a.style.color="#ffcc00":i==="CRITICAL"&&(a.style.color="#ff3030"),o.appendChild(a)}addHolographicElements(e){this.addCornerElements(e)}addCornerElements(e){const t=document.createElement("div");t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="10px",t.style.height="10px",t.style.borderTop="2px solid rgba(120, 220, 232, 0.8)",t.style.borderLeft="2px solid rgba(120, 220, 232, 0.8)",e.appendChild(t);const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.right="0",s.style.width="10px",s.style.height="10px",s.style.borderTop="2px solid rgba(120, 220, 232, 0.8)",s.style.borderRight="2px solid rgba(120, 220, 232, 0.8)",e.appendChild(s);const i=document.createElement("div");i.style.position="absolute",i.style.bottom="0",i.style.left="0",i.style.width="10px",i.style.height="10px",i.style.borderBottom="2px solid rgba(120, 220, 232, 0.8)",i.style.borderLeft="2px solid rgba(120, 220, 232, 0.8)",e.appendChild(i);const o=document.createElement("div");o.style.position="absolute",o.style.bottom="0",o.style.right="0",o.style.width="10px",o.style.height="10px",o.style.borderBottom="2px solid rgba(120, 220, 232, 0.8)",o.style.borderRight="2px solid rgba(120, 220, 232, 0.8)",e.appendChild(o)}animateHudIn(){const e=document.createElement("style");e.textContent=`
            @keyframes pulse {
                0% { opacity: 0.7; }
                50% { opacity: 1; }
                100% { opacity: 0.7; }
            }
            
            @keyframes radar-ping {
                0% { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }
                100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
            }
            
            @keyframes text-flicker {
                0% { opacity: 1; }
                3% { opacity: 0.4; }
                6% { opacity: 1; }
                9% { opacity: 0.4; }
                12% { opacity: 1; }
                35% { opacity: 1; }
                38% { opacity: 0.4; }
                41% { opacity: 1; }
                100% { opacity: 1; }
            }
            
            @keyframes blink {
                0% { opacity: 1; }
                49% { opacity: 1; }
                50% { opacity: 0; }
                100% { opacity: 0; }
            }
        `,document.head.appendChild(e),this.addStartupGlitchEffect(),setTimeout(()=>{this.scanline&&this.animateScanline()},1500)}addStartupGlitchEffect(){const e=document.getElementById("hud-container");e&&(setTimeout(()=>{e.style.opacity="0.3",this.addGlitch(e)},300),setTimeout(()=>{e.style.opacity="0.7",this.addGlitch(e)},800),setTimeout(()=>{e.style.opacity="1",this.addGlitch(e)},1200),this.glitchInterval=setInterval(()=>{Math.random()>.7&&this.addGlitch(e)},5e3))}addGlitch(e){const t=`
            @keyframes glitch-${Date.now()} {
                0% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }
                1% { transform: translate(2px, 2px) skew(1deg); filter: hue-rotate(90deg); }
                2% { transform: translate(-2px, -3px) skew(-1deg); filter: hue-rotate(180deg); }
                3% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }
                12% { clip-path: inset(0 0 0 0); }
                13% { clip-path: inset(10% 0 0 0); }
                14% { clip-path: inset(0 0 0 0); }
                15% { clip-path: inset(0 0 10% 0); }
                16% { clip-path: inset(0 0 0 0); }
                100% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }
            }
        `,s=document.createElement("style");s.textContent=t,document.head.appendChild(s);const i=`glitch-${Date.now()}`;e.style.animation=`${i} 1s forwards`,setTimeout(()=>{e.style.animation="",s.remove()},1e3)}animateScanline(){let e=0;const t=window.innerHeight,s=()=>{this.scanline&&(e=(e+2)%t,this.scanline.style.top=`${e}px`,Math.random()>.97&&(this.scanline.style.opacity="0",setTimeout(()=>{this.scanline&&(this.scanline.style.opacity="0.7")},50)),this.animationFrames.push(requestAnimationFrame(s)))};s()}update(){if(!this.spaceship)return;this.updateShieldDisplay(),this.updateHullDisplay();const e=document.getElementById("fuel-bar"),t=document.getElementById("fuel-value");if(e){const i=this.spaceship.maxFuel>0?this.spaceship.fuel/this.spaceship.maxFuel*100:0;e.style.width=`${i}%`,i<20?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":i<40?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(120, 220, 232, 0.8)",t&&(t.textContent=`${Math.round(this.spaceship.fuel)} / ${Math.round(this.spaceship.maxFuel)}`)}const s=document.getElementById("credits-value");s&&(s.textContent=`${this.spaceship.credits} CR`),this.updateHordeModeDisplay()}updateHordeModeDisplay(){const e=document.getElementById("horde-mode-indicator"),t=document.getElementById("horde-survival-time");if(!(!e||!t))if(window.game&&window.game.isHordeActive){if(e.style.display==="none"&&(e.style.display="flex"),window.game.getFormattedHordeSurvivalTime)t.textContent=window.game.getFormattedHordeSurvivalTime();else{const s=Math.floor(window.game.hordeSurvivalTime/1e3),i=Math.floor(s/60),o=s%60;t.textContent=`${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}if(window.game.hordeSurvivalTime>3*60*1e3){const s=document.createElement("style");s.textContent=`
                    @keyframes pulse-horde {
                        0% { box-shadow: 0 0 8px rgba(255, 30, 30, 0.7); }
                        50% { box-shadow: 0 0 15px rgba(255, 30, 30, 1); }
                        100% { box-shadow: 0 0 8px rgba(255, 30, 30, 0.7); }
                    }
                `,document.head.appendChild(s),e.style.animation="pulse-horde 1s infinite"}}else e.style.display="none"}updateShieldDisplay(){const e=document.getElementById("shield-bar");if(!e)return;let t=100,s=!1;try{if(window.game&&window.game.world){const i=window.game.world.getEntitiesByTag("player");if(i&&i.length>0){const n=i[0].getComponent("HealthComponent");n&&(t=n.getShieldPercentage(),this.spaceship&&(n.shield>this.spaceship.shield?(this.spaceship.shield=n.shield,this.spaceship.maxShield=n.maxShield):this.spaceship.shield>n.shield&&(n.shield=this.spaceship.shield,console.log(`Updated HealthComponent shield from spaceship: ${n.shield}`),t=n.getShieldPercentage())),s=!0)}}}catch(i){console.error("Error accessing player shield component:",i)}!s&&this.spaceship&&this.spaceship.shield!==void 0&&(t=this.spaceship.shield/this.spaceship.maxShield*100),e.style.width=`${t}%`,t<25?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":t<50?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(51, 153, 255, 0.8)"}updateHullDisplay(){const e=document.getElementById("hull-bar");if(!e)return;let t=100,s=!1;try{if(window.game&&window.game.world){const i=window.game.world.getEntitiesByTag("player");if(i&&i.length>0){const n=i[0].getComponent("HealthComponent");n&&(t=n.getHealthPercentage(),this.spaceship&&(n.health>this.spaceship.hull?(this.spaceship.hull=n.health,this.spaceship.maxHull=n.maxHealth):this.spaceship.hull>n.health&&(n.health=this.spaceship.hull,console.log(`Updated HealthComponent health from spaceship: ${n.health}`),t=n.getHealthPercentage())),s=!0)}}}catch(i){console.error("Error accessing player health component:",i)}!s&&this.spaceship&&this.spaceship.hull!==void 0&&(t=this.spaceship.hull/this.spaceship.maxHull*100),e.style.width=`${t}%`,t<30?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":t<60?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(120, 220, 232, 0.8)"}updateLocation(e,t="Unknown System"){const s=document.getElementById("current-system");if(s){s.textContent=t.toUpperCase();const i=document.getElementById("location-panel");i&&this.addGlitch(i)}}updateCoordinates(e,t,s){const i=document.getElementById("location-coordinates");i&&(i.textContent=`X: ${Math.round(e)} Y: ${Math.round(t)} Z: ${Math.round(s)}`)}updateFPS(e,t){const s=document.getElementById("fps-display");s&&(t?(s.textContent=`FPS: ${Math.round(e)}/${t}`,e<t*.9?s.style.color="rgba(255, 120, 120, 0.9)":s.style.color="rgba(120, 220, 232, 0.8)"):(s.textContent=`FPS: ${Math.round(e)}`,s.style.color="rgba(120, 220, 232, 0.8)"),window.game&&window.game.ui&&window.game.ui.settings&&window.game.ui.settings.settings.frameRateCap==="auto"&&(window.game.ui.settings.monitorRefreshRate,t>0?s.textContent=`FPS: ${Math.round(e)}/${t} (Auto)`:s.textContent=`FPS: ${Math.round(e)} (Auto: Unlimited)`))}hide(){const e=document.getElementById("hud-container");e&&(e.style.opacity="0"),this.animationFrames.forEach(t=>cancelAnimationFrame(t)),this.animationFrames=[],this.glitchInterval&&clearInterval(this.glitchInterval)}show(){const e=document.getElementById("hud-container");e&&(e.style.opacity="1"),this.scanline&&this.animateScanline(),this.glitchInterval||(this.glitchInterval=setInterval(()=>{Math.random()>.7&&this.addGlitch(e)},5e3))}destroy(){this.animationFrames.forEach(s=>{cancelAnimationFrame(s)}),this.animationFrames=[],this.glitchInterval&&(clearInterval(this.glitchInterval),this.glitchInterval=null);const e=document.getElementById("show-controls");e&&(e.removeEventListener("click",e.clickHandler),e.removeEventListener("mouseover",e.mouseoverHandler),e.removeEventListener("mouseout",e.mouseoutHandler));const t=document.getElementById("hud-container");t&&t.parentNode&&t.parentNode.removeChild(t),this.spaceship=null,this.scanline=null}}class Gi{constructor(e){this.spaceship=e,this.controls=null,this.setupMobileHUD()}setupMobileHUD(){const e=document.createElement("style");e.textContent=`
            @keyframes pulse-horde-mobile {
                0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }
                50% { box-shadow: 0 0 10px rgba(255, 30, 30, 0.8); }
                100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }
            }
        `,document.head.appendChild(e);const t=document.createElement("div");t.id="mobile-hud-container",t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.width="min(140px, 25vw)",t.style.backgroundColor="rgba(6, 22, 31, 0.8)",t.style.backdropFilter="blur(5px)",t.style.webkitBackdropFilter="blur(5px)",t.style.borderRadius="8px",t.style.border="1px solid rgba(120, 220, 232, 0.3)",t.style.padding="10px",t.style.color="rgba(120, 220, 232, 0.9)",t.style.fontFamily='"Rajdhani", "Electrolize", sans-serif',t.style.fontSize="14px",t.style.boxShadow="0 0 10px rgba(120, 220, 232, 0.2)",t.style.zIndex="1000",t.style.transform="translateZ(0)",t.style.backfaceVisibility="hidden",document.body.appendChild(t),this.createStatusBar(t,"S","shield-bar-mobile","rgba(51, 153, 255, 0.8)"),this.createStatusBar(t,"H","hull-bar-mobile","rgba(120, 220, 232, 0.8)"),this.createStatusBar(t,"F","fuel-bar-mobile","rgba(120, 220, 232, 0.8)"),this.createAnomalyDisplay(t);const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between",s.style.alignItems="center",s.style.marginTop="10px";const i=document.createElement("div");i.textContent="C",i.style.marginRight="10px",i.style.fontSize="14px";const o=document.createElement("div");o.id="cargo-value-mobile",o.textContent="0 / 1000",o.style.textAlign="right",o.style.flexGrow="1",o.style.fontSize="14px",s.appendChild(i),s.appendChild(o),t.appendChild(s);const n=document.createElement("div");n.id="mobile-horde-indicator",n.style.display="none",n.style.marginTop="10px",n.style.padding="5px",n.style.backgroundColor="rgba(255, 30, 30, 0.2)",n.style.borderRadius="4px",n.style.border="1px solid #ff3030",n.style.animation="pulse-horde-mobile 2s infinite",n.style.fontSize="12px";const a=document.createElement("div");a.id="mobile-horde-timer",a.textContent="00:00",a.style.textAlign="center",a.style.fontWeight="bold",a.style.color="#ff3030",n.appendChild(a),t.appendChild(n),this.addCornerElements(t)}createStatusBar(e,t,s,i){const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="8px";const n=document.createElement("div");n.textContent=t,n.style.marginRight="8px",n.style.width="16px",n.style.textAlign="center",n.style.fontSize="14px";const a=document.createElement("div");if(a.style.flexGrow="1",a.style.height="8px",a.style.backgroundColor="rgba(10, 30, 40, 0.5)",a.style.borderRadius="4px",a.style.overflow="hidden",a.style.position="relative",s==="fuel-bar-mobile"){const l=document.createElement("div");l.id="fuel-value-mobile",l.style.position="absolute",l.style.right="0",l.style.top="-14px",l.style.fontSize="10px",l.style.color="rgba(120, 220, 232, 0.9)",l.textContent="100 / 100",a.appendChild(l)}const r=document.createElement("div");r.id=s,r.style.width="100%",r.style.height="100%",r.style.backgroundColor=i,r.style.transition="width 0.2s ease",a.appendChild(r),o.appendChild(n),o.appendChild(a),e.appendChild(o)}createAnomalyDisplay(e){const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.marginBottom="8px";const s=document.createElement("div");s.textContent="A",s.style.marginRight="8px",s.style.width="16px",s.style.textAlign="center",s.style.fontSize="14px";const i=document.createElement("div");i.id="anomaly-count-mobile",i.textContent="0",i.style.textAlign="right",i.style.flexGrow="1",i.style.fontSize="14px",i.style.fontWeight="bold",i.style.color="rgba(120, 220, 232, 0.9)",t.appendChild(s),t.appendChild(i),e.appendChild(t)}addCornerElements(e){const t=document.createElement("div");t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="6px",t.style.height="6px",t.style.borderTop="1px solid rgba(120, 220, 232, 0.8)",t.style.borderLeft="1px solid rgba(120, 220, 232, 0.8)",e.appendChild(t);const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.right="0",s.style.width="6px",s.style.height="6px",s.style.borderTop="1px solid rgba(120, 220, 232, 0.8)",s.style.borderRight="1px solid rgba(120, 220, 232, 0.8)",e.appendChild(s);const i=document.createElement("div");i.style.position="absolute",i.style.bottom="0",i.style.left="0",i.style.width="6px",i.style.height="6px",i.style.borderBottom="1px solid rgba(120, 220, 232, 0.8)",i.style.borderLeft="1px solid rgba(120, 220, 232, 0.8)",e.appendChild(i);const o=document.createElement("div");o.style.position="absolute",o.style.bottom="0",o.style.right="0",o.style.width="6px",o.style.height="6px",o.style.borderBottom="1px solid rgba(120, 220, 232, 0.8)",o.style.borderRight="1px solid rgba(120, 220, 232, 0.8)",e.appendChild(o)}update(){this.updateShieldDisplay(),this.updateHullDisplay(),this.updateFuelDisplay(),this.updateCargoDisplay(),this.updateAnomalyCount(),this.updateHordeModeDisplay()}updateShieldDisplay(){const e=document.getElementById("shield-bar-mobile");if(!e)return;let t=100;this.spaceship&&typeof this.spaceship.shield<"u"&&(t=this.spaceship.shield/this.spaceship.maxShield*100),e.style.width=`${t}%`,t<25?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":t<50?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(51, 153, 255, 0.8)"}updateHullDisplay(){const e=document.getElementById("hull-bar-mobile");if(!e)return;let t=100;this.spaceship&&typeof this.spaceship.hull<"u"&&(t=this.spaceship.hull/this.spaceship.maxHull*100),e.style.width=`${t}%`,t<30?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":t<60?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(120, 220, 232, 0.8)"}updateFuelDisplay(){const e=document.getElementById("fuel-bar-mobile"),t=document.getElementById("fuel-value-mobile");if(!e||!this.spaceship)return;const s=this.spaceship.maxFuel>0?this.spaceship.fuel/this.spaceship.maxFuel*100:0;e.style.width=`${s}%`,s<20?e.style.backgroundColor="rgba(255, 80, 80, 0.8)":s<40?e.style.backgroundColor="rgba(255, 204, 0, 0.8)":e.style.backgroundColor="rgba(120, 220, 232, 0.8)",t&&(t.textContent=`${Math.round(this.spaceship.fuel)} / ${Math.round(this.spaceship.maxFuel)}`)}updateCargoDisplay(){const e=document.getElementById("cargo-value-mobile");if(!e)return;let t=null,s=1e3;if(this.controls&&this.controls.resources?(t=this.controls.resources,this.spaceship&&typeof this.spaceship.maxCargoCapacity<"u"&&(s=this.spaceship.maxCargoCapacity)):this.spaceship&&this.spaceship.cargoComponent&&this.spaceship.cargoComponent.resources?(t=this.spaceship.cargoComponent.resources,s=this.spaceship.cargoComponent.maxCapacity):this.spaceship&&this.spaceship.resources&&(t=this.spaceship.resources),!t)return;let i=0;for(const o in t)if(t.hasOwnProperty(o)){const n=parseFloat(t[o])||0;i+=n}i=Math.round(i),e.textContent=`${i} / ${s}`,i>=s*.9?e.style.color="rgba(255, 80, 80, 0.9)":i>=s*.7?e.style.color="rgba(255, 204, 0, 0.9)":e.style.color="rgba(120, 220, 232, 0.9)"}updateAnomalyCount(){const e=document.getElementById("anomaly-count-mobile");if(!e)return;let t=0;window.game&&window.game.environment&&window.game.environment.anomalyCount&&(t=window.game.environment.anomalyCount),e.textContent=t.toString(),t>0?(e.style.color="rgba(255, 204, 0, 0.9)",e.style.textShadow="0 0 5px rgba(255, 204, 0, 0.5)"):(e.style.color="rgba(120, 220, 232, 0.9)",e.style.textShadow="none")}updateHordeModeDisplay(){const e=document.getElementById("mobile-horde-indicator"),t=document.getElementById("mobile-horde-timer");if(!(!e||!t))if(window.game&&window.game.isHordeActive){if(e.style.display==="none"&&(e.style.display="block",e.innerHTML='<div style="text-align:center; color:#ff3030; font-weight:bold; margin-bottom:2px;">HORDE MODE</div>',e.appendChild(t)),window.game.getFormattedHordeSurvivalTime)t.textContent=window.game.getFormattedHordeSurvivalTime();else{const s=Math.floor(window.game.hordeSurvivalTime/1e3),i=Math.floor(s/60),o=s%60;t.textContent=`${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}if(window.game.hordeSurvivalTime>3*60*1e3){const s=document.createElement("style");s.textContent=`
                    @keyframes pulse-horde-mobile {
                        0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.7); }
                        50% { box-shadow: 0 0 10px rgba(255, 30, 30, 1); }
                        100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.7); }
                    }
                `,document.head.appendChild(s),e.style.animation="pulse-horde-mobile 0.8s infinite",e.style.backgroundColor="rgba(255, 30, 30, 0.3)"}}else e.style.display="none"}hide(){const e=document.getElementById("mobile-hud-container");e&&(e.style.display="none")}show(){if(window.game&&window.game.introSequenceActive){console.log("MobileHUD: Not showing HUD during intro sequence");return}const e=document.getElementById("mobile-hud-container");e&&(e.style.display="block")}setControls(e){console.log("MobileHUD: Setting controls reference"),this.controls=e}updateLocation(e,t="Unknown System"){this.updateAnomalyCount()}}class _i{constructor(){this.controls=null,this.setupMiningDisplay()}setControls(e){this.controls=e}setupMiningDisplay(){const e=document.createElement("div");e.id="target-info",e.style.position="absolute",e.style.bottom="120px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.padding="10px 20px",e.style.borderRadius="20px",e.style.border="1px solid #30cfd0",e.style.boxShadow="0 0 10px #30cfd0",e.style.display="none",e.style.textAlign="center",document.body.appendChild(e);const t=document.createElement("div");t.id="target-name",t.textContent="Asteroid",e.appendChild(t);const s=document.createElement("div");s.id="target-distance",s.textContent="Distance: 0 units",e.appendChild(s);const i=document.createElement("div");i.id="mining-time",i.textContent="Mining time: calculating...",i.style.color="#ffcc00",e.appendChild(i)}update(){if(this.controls&&this.controls.resources){const e=document.getElementById("iron-amount"),t=document.getElementById("gold-amount"),s=document.getElementById("platinum-amount"),i=document.getElementById("cargo-capacity"),o=document.getElementById("capacity-bar");if(e&&(e.textContent=this.controls.resources.iron||0),t&&(t.textContent=this.controls.resources.gold||0),s&&(s.textContent=this.controls.resources.platinum||0),i&&o&&this.controls.spaceship){const n=(this.controls.resources.iron||0)+(this.controls.resources.gold||0)+(this.controls.resources.platinum||0),a=this.controls.spaceship.maxCargoCapacity||1e3,r=n/a*100;i.textContent=`${n} / ${a}`,o.style.width=`${r}%`,r>90?o.style.backgroundColor="rgba(255, 80, 80, 0.8)":r>75?o.style.backgroundColor="rgba(255, 204, 0, 0.8)":o.style.backgroundColor="rgba(120, 220, 232, 0.8)"}this.updateMiningTimeEstimate()}}updateMiningTimeEstimate(){const e=document.getElementById("mining-time");if(!e||!this.controls||!this.controls.miningSystem)return;const t=this.controls.miningSystem;if(t.targetAsteroid&&t.targetAsteroid.resourceType){const s=t.targetAsteroid.resourceType.toLowerCase(),i=t.getMiningEfficiency(),o=Math.round(1/(t.miningSpeedByType[s]*i));e.textContent=`Mining time: ${o} seconds`,e.style.display="block",s==="platinum"?e.style.color="#66ffff":s==="gold"?e.style.color="#ffcc00":e.style.color="#a0a0a0"}else e.style.display="none"}hide(){const e=document.getElementById("target-info");e&&(e.style.display="none")}show(){}}class ji{constructor(){this.setupTargetingUI()}setupTargetingUI(){const e=document.createElement("div");e.id="lock-on-display",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.width="150px",e.style.height="150px",e.style.transform="translate(-50%, -50%)",e.style.border="2px dashed #ff0000",e.style.borderRadius="50%",e.style.boxSizing="border-box",e.style.display="none",e.style.zIndex="997",e.style.pointerEvents="none",document.body.appendChild(e);const t=document.createElement("div");t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.top="0",t.style.left="0",t.innerHTML=`
            <div style="position: absolute; width: 2px; height: 30px; background-color: #ff0000; top: 0; left: 50%; transform: translateX(-50%);"></div>
            <div style="position: absolute; width: 2px; height: 30px; background-color: #ff0000; bottom: 0; left: 50%; transform: translateX(-50%);"></div>
            <div style="position: absolute; width: 30px; height: 2px; background-color: #ff0000; left: 0; top: 50%; transform: translateY(-50%);"></div>
            <div style="position: absolute; width: 30px; height: 2px; background-color: #ff0000; right: 0; top: 50%; transform: translateY(-50%);"></div>
        `,e.appendChild(t);const s=document.createElement("div");s.id="target-indicator",s.style.position="absolute",s.style.bottom="120px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.width="200px",s.style.textAlign="center",s.style.backgroundColor="rgba(255, 50, 50, 0.4)",s.style.border="1px solid #ff3030",s.style.borderRadius="10px",s.style.padding="8px",s.style.color="#ffffff",s.style.fontFamily="monospace",s.style.zIndex="100",s.style.display="none",s.style.boxShadow="0 0 10px #ff3030",s.innerHTML=`
            <div style="font-weight: bold; margin-bottom: 5px;">◎ TARGET LOCKED ◎</div>
            <div id="target-type">Asteroid</div>
            <div id="target-distance">Distance: 0 units</div>
            <div id="target-resource" style="color: #ffcc00;">Resource: Unknown</div>
        `,document.body.appendChild(s)}showLockOn(){const e=document.getElementById("lock-on-display");e&&(e.style.display="block")}hideLockOn(){const e=document.getElementById("lock-on-display");e&&(e.style.display="none")}updateTargetInfo(e,t,s){const i=document.getElementById("target-indicator"),o=document.getElementById("target-type"),n=document.getElementById("target-distance"),a=document.getElementById("target-resource");if(i&&o&&n){if(i.style.display="block",o.textContent=`${e}`,n.textContent=`Distance: ${Math.round(t)} units`,a&&s){let r="#cccccc";s.toLowerCase()==="iron"?r="#cccccc":s.toLowerCase()==="gold"?r="#ffcc00":s.toLowerCase()==="platinum"&&(r="#66ffff"),a.textContent=`Resource: ${s}`,a.style.color=r}this.addPulseEffect(i)}}addPulseEffect(e){if(e.style.animation="none",e.offsetWidth,e.style.animation="targetPulse 2s infinite",!document.getElementById("targeting-keyframes")){const t=document.createElement("style");t.id="targeting-keyframes",t.textContent=`
                @keyframes targetPulse {
                    0% { box-shadow: 0 0 10px #ff3030; }
                    50% { box-shadow: 0 0 20px #ff3030; }
                    100% { box-shadow: 0 0 10px #ff3030; }
                }
            `,document.head.appendChild(t)}}hideTargetInfo(){const e=document.getElementById("target-indicator");e&&(e.style.display="none")}}class Vi{constructor(){this.starMap=null,this.blackjackGame=null,this.settings=null,this.isMobile=ye.isMobile(),this.setupStargateUI(),this.setupEventHandlers()}setStarMap(e){this.starMap=e}setBlackjackGame(e){this.blackjackGame=e}setSettings(e){this.settings=e,this.settings&&this.settings.setStargateInterface(this),this.setupSettingsButton()}setupStargateUI(){const e=document.createElement("style");e.textContent=`
            @keyframes pulse-warning {
                0% { box-shadow: 0 0 15px rgba(255, 48, 48, 0.5); }
                50% { box-shadow: 0 0 25px rgba(255, 48, 48, 0.8); }
                100% { box-shadow: 0 0 15px rgba(255, 48, 48, 0.5); }
            }
            
            /* Stargate Terminal Styles */
            #stargate-ui {
                --primary-bg: rgba(20, 30, 50, 0.9);
                --primary-border: #33aaff;
                --section-bg: rgba(10, 20, 35, 0.8);
                --accent-blue: #33aaff;
                --accent-green: #00cc33;
                --accent-orange: #ff9900;
                --accent-red: #ff3030;
                --accent-purple: #9933cc;
                --accent-cyan: #30cfd0;
                
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                max-width: 1000px;
                max-height: 90vh;
                background-color: var(--primary-bg);
                color: #fff;
                border-radius: 15px;
                border: 2px solid var(--primary-border);
                box-shadow: 0 0 30px var(--primary-border);
                font-family: 'Courier New', monospace;
                z-index: 1000;
                display: none;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 0;
            }
            
            #stargate-header {
                background-color: rgba(30, 40, 60, 0.9);
                padding: 15px 20px;
                border-bottom: 1px solid var(--primary-border);
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            #stargate-content {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .stargate-section {
                background-color: var(--section-bg);
                border-radius: 10px;
                padding: 15px;
                border: 1px solid rgba(51, 170, 255, 0.3);
            }
            
            .stargate-section h3 {
                color: var(--accent-blue);
                margin-top: 0;
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(51, 170, 255, 0.3);
                font-size: 1.2em;
            }
            
            /* Ship Status Section */
            #ship-status-section {
                grid-column: 1;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .resources-container {
                display: flex;
                gap: 5px;
                margin-bottom: 10px;
            }
            
            .resource-display {
                flex: 1;
                padding: 8px;
                background-color: rgba(15, 40, 55, 0.8);
                border-radius: 5px;
                text-align: center;
            }
            
            .status-bar-container {
                width: 100%;
                height: 15px;
                background-color: #222;
                border-radius: 10px;
                overflow: hidden;
                margin-bottom: 5px;
            }
            
            .status-bar {
                height: 100%;
                border-radius: 10px;
            }
            
            .status-label {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
                font-size: 0.9em;
            }
            
            /* Market Section */
            #market-section {
                grid-column: 2;
                grid-row: 1 ;
            }
            
            .sell-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 5px;
                margin-bottom: 15px;
            }
            
            .sell-btn {
                padding: 10px;
                background-color: rgba(15, 40, 55, 0.8);
                color: #fff;
                border-radius: 5px;
                cursor: pointer;
                text-align: center;
                transition: all 0.2s;
                border: none;
                font-family: 'Courier New', monospace;
            }
            
            .orb-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            /* Upgrades Section */
            #upgrades-section {
                grid-column: 3;
                grid-row: 1;
            }
            
            .upgrade-item {
                margin-bottom: 15px;
                border: 1px solid rgba(85, 85, 85, 0.5);
                border-radius: 8px;
                padding: 12px;
                background-color: rgba(0, 0, 0, 0.3);
            }
            
            .upgrade-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .upgrade-progress {
                position: relative;
                height: 8px;
                background-color: #333;
                border-radius: 4px;
                margin-bottom: 12px;
            }
            
            .upgrade-progress-bar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 20%;
                border-radius: 4px;
            }
            
            .upgrade-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .upgrade-description {
                flex: 2;
                padding-right: 10px;
                font-size: 0.85em;
                opacity: 0.8;
            }
            
            /* Features Section */
            #features-section {
                grid-column: 1 / span 2;
                grid-row: 2;
            }
            
            .feature-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .feature-btn {
                padding: 15px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                font-size: 16px;
                color: #fff;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 80px;
            }
            
            .feature-btn small {
                font-size: 0.8em;
                opacity: 0.8;
                margin-top: 5px;
            }
            
            /* Challenge Section */
            #challenge-section {
                border-color: rgba(255, 48, 48, 0.5);
            }
            
            #challenge-section h3 {
                color: var(--accent-red);
                border-color: rgba(255, 48, 48, 0.3);
            }
            
            /* Footer */
            #stargate-footer {
                padding: 20px;
                border-top: 1px solid rgba(51, 170, 255, 0.3);
                text-align: center;
            }
            
            /* Common Button Styles */
            .action-btn {
                width: 100%;
                padding: 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                color: #000;
                margin-top: 5px;
            }
            
            /* Custom colors for buttons */
            .btn-fuel { background-color: var(--accent-green); }
            .btn-shield { background-color: var(--accent-blue); }
            .btn-hull { background-color: var(--accent-orange); }
            .btn-starmap { background-color: var(--accent-cyan); }
            .btn-blackjack { background-color: var(--accent-purple); }
            .btn-settings { background-color: var(--accent-blue); }
            .btn-horde { 
                background: linear-gradient(135deg, #990000 0%, var(--accent-red) 100%);
                color: #fff;
                border: 2px solid var(--accent-red);
                box-shadow: 0 0 15px rgba(255, 48, 48, 0.5);
                animation: pulse-warning 2s infinite;
            }
            .btn-undock {
                background-color: var(--accent-blue);
                font-size: 1.2em;
                padding: 15px;
            }
            
            .iron-border { border: 1px solid #cc6633; box-shadow: 0 0 10px rgba(204, 102, 51, 0.3); }
            .gold-border { border: 1px solid #ffcc33; box-shadow: 0 0 10px rgba(255, 204, 51, 0.3); }
            .platinum-border { border: 1px solid #33ccff; box-shadow: 0 0 10px rgba(51, 204, 255, 0.3); }
            .common-border { border: 1px solid #00ff66; box-shadow: 0 0 10px rgba(0, 255, 102, 0.3); }
            .uncommon-border { border: 1px solid #0066ff; box-shadow: 0 0 10px rgba(0, 102, 255, 0.3); }
            .rare-border { border: 1px solid #9900ff; box-shadow: 0 0 10px rgba(153, 0, 255, 0.3); }
            .epic-border { border: 1px solid #ff6600; box-shadow: 0 0 10px rgba(255, 102, 0, 0.3); }
            .legendary-border { border: 1px solid #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }
            
            /* Mobile Responsiveness */
            @media (max-width: 900px) {
                #stargate-ui {
                    width: 95%;
                    max-width: 95vw;
                    max-height: 85vh;
                    border-radius: 10px;
                }
                
                #stargate-content {
                    grid-template-columns: 1fr;
                    gap: 15px;
                    padding: 15px;
                }
                
                #ship-status-section,
                #market-section,
                #upgrades-section,
                #features-section {
                    grid-column: 1;
                }
                
                .feature-buttons {
                    grid-template-columns: 1fr;
                }
                
                .sell-buttons {
                    grid-template-columns: 1fr 1fr;
                }
                
                .action-btn {
                    padding: 12px;
                    min-height: 44px;
                }
                
                .upgrade-footer {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .upgrade-description {
                    margin-bottom: 10px;
                }
            }
            
            #horde-confirm-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            }
            
            #horde-confirm-content {
                background-color: rgba(30, 30, 35, 0.95);
                border: 2px solid #ff3030;
                border-radius: 10px;
                padding: 30px;
                max-width: 500px;
                width: 80%;
                color: #fff;
                box-shadow: 0 0 30px rgba(255, 48, 48, 0.7);
                text-align: center;
            }
            
            .horde-confirm-title {
                color: #ff3030;
                font-size: 24px;
                margin-bottom: 20px;
                font-weight: bold;
                text-shadow: 0 0 10px rgba(255, 48, 48, 0.5);
            }
            
            .horde-confirm-text {
                margin-bottom: 25px;
                line-height: 1.5;
            }
            
            .horde-confirm-buttons {
                display: flex;
                justify-content: space-between;
            }
            
            .horde-confirm-btn {
                padding: 12px 25px;
                border-radius: 5px;
                border: none;
                font-family: 'Courier New', monospace;
                font-weight: bold;
                cursor: pointer;
                width: 45%;
            }
            
            .horde-confirm-yes {
                background-color: #ff3030;
                color: #fff;
            }
            
            .horde-confirm-no {
                background-color: #333;
                color: #fff;
            }
        `,document.head.appendChild(e);const t=document.createElement("div");t.id="docking-prompt",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="#33aaff",t.style.padding="20px",t.style.borderRadius="10px",t.style.border="2px solid #33aaff",t.style.boxShadow="0 0 20px #33aaff",t.style.fontFamily="Courier New, monospace",t.style.fontSize="18px",t.style.textAlign="center",t.style.zIndex="1000",t.style.display="none",this.isMobile?(t.style.display="none",t.dataset.alwaysHide="true"):t.textContent="Press Q to dock with Stargate",document.body.appendChild(t);const s=document.createElement("div");s.id="stargate-ui",this.isMobile&&(s.style.width="95%",s.style.maxWidth="95vw",s.style.webkitOverflowScrolling="touch",s.style.touchAction="pan-y",s.style.overscrollBehavior="contain"),s.innerHTML=`
            <!-- Header -->
            <div id="stargate-header">
                <h2 style="text-align: center; color: #33aaff; margin: 0;">STARGATE TERMINAL</h2>
            </div>
            
            <!-- Main Content Grid -->
            <div id="stargate-content">
                <!-- Ship Status Section -->
                <div id="ship-status-section" class="stargate-section">
                    <h3>SHIP STATUS</h3>
                    
                    <!-- Resources section -->
                    <div>
                        <h4 style="color: #33aaff; margin-top: 0; margin-bottom: 10px;">RESOURCES</h4>
                        <div class="resources-container">
                            <div class="resource-display iron-border">
                                <div style="font-weight: bold; font-size: 14px;">IRON</div>
                                <div id="ms-iron" style="font-size: 18px; margin-top: 5px;">0</div>
                                <div style="font-size: 10px; opacity: 0.7;">UNITS</div>
                            </div>
                            <div class="resource-display gold-border">
                                <div style="font-weight: bold; font-size: 14px;">GOLD</div>
                                <div id="ms-gold" style="font-size: 18px; margin-top: 5px;">0</div>
                                <div style="font-size: 10px; opacity: 0.7;">UNITS</div>
                            </div>
                            <div class="resource-display platinum-border">
                                <div style="font-weight: bold; font-size: 14px;">PLATINUM</div>
                                <div id="ms-platinum" style="font-size: 18px; margin-top: 5px;">0</div>
                                <div style="font-size: 10px; opacity: 0.7;">UNITS</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <h4 style="color: #33aaff; margin-top: 0; margin-bottom: 10px;">CREDITS</h4>
                            <div id="ms-credits" style="font-size: 18px; font-weight: bold; color: #ffcc33; text-shadow: 0 0 5px rgba(255, 204, 51, 0.5);">0 CR</div>
                        </div>
                    </div>
                    
                    <!-- Fuel section -->
                    <div>
                        <div class="status-label">
                            <h4 style="color: #00cc33; margin: 0;">FUEL</h4>
                            <span><span id="fuel-level">100</span>%</span>
                        </div>
                        <div class="status-bar-container" id="fuel-gauge-container">
                            <div class="status-bar" id="fuel-gauge" style="background-color: #00cc33; width: 100%;"></div>
                        </div>
                        <button id="refuel-btn" class="action-btn btn-fuel">REFUEL (100 CR)</button>
                    </div>
                    
                    <!-- Shield section -->
                    <div>
                        <div class="status-label">
                            <h4 style="color: #3399ff; margin: 0;">SHIELD</h4>
                            <span><span id="shield-level">100</span>%</span>
                        </div>
                        <div class="status-bar-container" id="shield-gauge-container">
                            <div class="status-bar" id="shield-gauge" style="background-color: #3399ff; width: 100%;"></div>
                        </div>
                        <button id="repair-shield-btn" class="action-btn btn-shield">REPAIR SHIELD (150 CR)</button>
                    </div>
                    
                    <!-- Hull section -->
                    <div>
                        <div class="status-label">
                            <h4 style="color: #ff9900; margin: 0;">HULL INTEGRITY</h4>
                            <span><span id="hull-level">100</span>%</span>
                        </div>
                        <div class="status-bar-container" id="hull-gauge-container">
                            <div class="status-bar" id="hull-gauge" style="background-color: #ff9900; width: 100%;"></div>
                        </div>
                        <button id="repair-hull-btn" class="action-btn btn-hull">REPAIR HULL (200 CR)</button>
                    </div>
                </div>
                
                <!-- Market Section (Now spans 2 rows) -->
                <div id="market-section" class="stargate-section">
                    <h3>MARKET</h3>
                    
                    <!-- Resources Market -->
                    <h4 style="color: #33aaff; margin-top: 0; margin-bottom: 10px;">MATERIALS</h4>
                    <div class="sell-buttons">
                        <button id="sell-iron" class="sell-btn iron-border">
                            <div style="font-weight: bold;">SELL IRON</div>
                            <div style="font-size: 12px; margin-top: 3px;">(10 CR each)</div>
                        </button>
                        <button id="sell-gold" class="sell-btn gold-border">
                            <div style="font-weight: bold;">SELL GOLD</div>
                            <div style="font-size: 12px; margin-top: 3px;">(50 CR each)</div>
                        </button>
                        <button id="sell-platinum" class="sell-btn platinum-border">
                            <div style="font-weight: bold;">SELL PLATINUM</div>
                            <div style="font-size: 12px; margin-top: 3px;">(200 CR each)</div>
                        </button>
                    </div>
                    
                    <!-- Energy Orbs Market -->
                    <h4 style="color: #33aaff; margin-top: 20px; margin-bottom: 10px;">ENERGY ORBS</h4>
                    <div style="font-size: 14px; color: #aaa; margin-bottom: 10px;">
                        Valuable artifacts collected from space anomalies. Increasing rarity yields higher value.
                    </div>
                    
                    <div class="orb-buttons">
                        <button id="sell-orb-common" class="sell-btn common-border">
                            <div style="font-weight: bold;">COMMON ORB</div>
                            <div id="orb-common-count" style="font-size: 12px;">0 in inventory</div>
                            <div style="font-size: 12px; margin-top: 3px;">(100 CR each)</div>
                        </button>
                        <button id="sell-orb-uncommon" class="sell-btn uncommon-border">
                            <div style="font-weight: bold;">UNCOMMON ORB</div>
                            <div id="orb-uncommon-count" style="font-size: 12px;">0 in inventory</div>
                            <div style="font-size: 12px; margin-top: 3px;">(500 CR each)</div>
                        </button>
                        <button id="sell-orb-rare" class="sell-btn rare-border">
                            <div style="font-weight: bold;">RARE ORB</div>
                            <div id="orb-rare-count" style="font-size: 12px;">0 in inventory</div>
                            <div style="font-size: 12px; margin-top: 3px;">(1,500 CR each)</div>
                        </button>
                        <button id="sell-orb-epic" class="sell-btn epic-border">
                            <div style="font-weight: bold;">EPIC ORB</div>
                            <div id="orb-epic-count" style="font-size: 12px;">0 in inventory</div>
                            <div style="font-size: 12px; margin-top: 3px;">(5,000 CR each)</div>
                        </button>
                        <button id="sell-orb-legendary" class="sell-btn legendary-border">
                            <div style="font-weight: bold;">LEGENDARY ORB</div>
                            <div id="orb-legendary-count" style="font-size: 12px;">0 in inventory</div>
                            <div style="font-size: 12px; margin-top: 3px;">(15,000 CR each)</div>
                        </button>
                    </div>
                    
                    <!-- Deployable Weapons Section -->
                    <h4 style="color: #33aaff; margin-top: 20px; margin-bottom: 10px;">DEPLOYABLE WEAPONS</h4>
                    <div class="upgrade-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #FF3333;">Laser Turrets:</strong> <span id="current-laser-count">0</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 2; padding-right: 10px;">
                                <p style="margin: 0; font-size: 12px;">Deployable laser turrets automatically target and fire at enemies within 1000m range.</p>
                            </div>
                            <button id="purchase-laser" style="flex: 1; padding: 10px; background-color: #FF3333; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                PURCHASE (1000 CR)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Upgrades Section (Now in first row) -->
                <div id="upgrades-section" class="stargate-section">
                    <h3>SHIP UPGRADES</h3>
                    
                    <!-- Fuel Tank Upgrade -->
                    <div class="upgrade-item">
                        <div class="upgrade-header">
                            <div>
                                <strong style="color: #00cc33;">Fuel Tank Level:</strong> <span id="current-fuel-level">1</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Capacity:</strong> <span id="current-fuel-capacity">100</span> units
                                <br>
                                <small style="opacity: 0.8;">Next: <span id="next-fuel-capacity">200</span> units</small>
                            </div>
                        </div>
                        <div class="upgrade-progress">
                            <div id="fuel-upgrade-progress" class="upgrade-progress-bar" style="background-color: #00cc33; width: 20%;"></div>
                        </div>
                        <div class="upgrade-footer">
                            <div class="upgrade-description">
                                <p style="margin: 0; font-size: 12px;">Increases maximum fuel capacity, allowing for longer journeys.</p>
                            </div>
                            <button id="upgrade-fuel-tank" style="flex: 1; padding: 10px; background-color: #00cc33; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                UPGRADE (<span id="fuel-upgrade-cost">1000</span> CR)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Engine Upgrade -->
                    <div class="upgrade-item">
                        <div class="upgrade-header">
                            <div>
                                <strong style="color: #ff9900;">Engine Level:</strong> <span id="current-engine-level">1</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Max Speed:</strong> <span id="current-max-velocity">25</span> units/s
                                <br>
                                <small style="opacity: 0.8;">Next: <span id="next-max-velocity">31.25</span> units/s</small>
                            </div>
                        </div>
                        <div class="upgrade-progress">
                            <div id="engine-upgrade-progress" class="upgrade-progress-bar" style="background-color: #ff9900; width: 20%;"></div>
                        </div>
                        <div class="upgrade-footer">
                            <div class="upgrade-description">
                                <p style="margin: 0; font-size: 12px;">Enhances thruster power, increasing maximum velocity and maneuverability.</p>
                            </div>
                            <button id="upgrade-engine" style="flex: 1; padding: 10px; background-color: #ff9900; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                UPGRADE (<span id="engine-upgrade-cost">800</span> CR)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mining Laser Upgrade -->
                    <div class="upgrade-item">
                        <div class="upgrade-header">
                            <div>
                                <strong style="color: #ff3030;">Mining Laser Level:</strong> <span id="current-mining-level">1</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Efficiency:</strong> <span id="current-mining-efficiency">100</span>%
                                <br>
                                <small style="opacity: 0.8;">Next: <span id="next-mining-efficiency">130</span>%</small>
                            </div>
                        </div>
                        <div class="upgrade-progress">
                            <div id="mining-upgrade-progress" class="upgrade-progress-bar" style="background-color: #ff3030; width: 20%;"></div>
                        </div>
                        <div class="upgrade-footer">
                            <div class="upgrade-description">
                                <p style="margin: 0; font-size: 12px;">Increases mining speed and extraction efficiency, allowing faster resource collection.</p>
                            </div>
                            <button id="upgrade-mining" style="flex: 1; padding: 10px; background-color: #ff3030; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                UPGRADE (<span id="mining-upgrade-cost">1200</span> CR)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hull Upgrade -->
                    <div class="upgrade-item">
                        <div class="upgrade-header">
                            <div>
                                <strong style="color: #30cfd0;">Hull Level:</strong> <span id="current-hull-level">1</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Resistance:</strong> <span id="current-hull-resistance">100</span>%
                                <br>
                                <small style="opacity: 0.8;">Next: <span id="next-hull-resistance">125</span>%</small>
                            </div>
                        </div>
                        <div class="upgrade-progress">
                            <div id="hull-upgrade-progress" class="upgrade-progress-bar" style="background-color: #30cfd0; width: 20%;"></div>
                        </div>
                        <div class="upgrade-footer">
                            <div class="upgrade-description">
                                <p style="margin: 0; font-size: 12px;">Reinforces ship structure, improving collision resistance and reducing damage.</p>
                            </div>
                            <button id="upgrade-hull" style="flex: 1; padding: 10px; background-color: #30cfd0; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                UPGRADE (<span id="hull-upgrade-cost">1500</span> CR)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scanner Upgrade -->
                    <div class="upgrade-item">
                        <div class="upgrade-header">
                            <div>
                                <strong style="color: #9933cc;">Scanner Level:</strong> <span id="current-scanner-level">1</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Range:</strong> <span id="current-scanner-range">1000</span> units
                                <br>
                                <small style="opacity: 0.8;">Next: <span id="next-scanner-range">1200</span> units</small>
                            </div>
                        </div>
                        <div class="upgrade-progress">
                            <div id="scanner-upgrade-progress" class="upgrade-progress-bar" style="background-color: #9933cc; width: 20%;"></div>
                        </div>
                        <div class="upgrade-footer">
                            <div class="upgrade-description">
                                <p style="margin: 0; font-size: 12px;">Extends scanner range for detecting asteroids and other objects at greater distances.</p>
                            </div>
                            <button id="upgrade-scanner" style="flex: 1; padding: 10px; background-color: #9933cc; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;">
                                UPGRADE (<span id="scanner-upgrade-cost">600</span> CR)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Features Section -->
                <div id="features-section" class="stargate-section">
                    <h3>SERVICES</h3>
                    
                    <div class="feature-buttons">
                        <button id="open-star-map" class="feature-btn" style="background-color: #30cfd0;">
                            STAR MAP
                            <small>Access star systems navigation</small>
                        </button>
                        <button id="create-custom-system" class="feature-btn" style="background: linear-gradient(135deg, #2c5a8c 0%, #4a76a8 100%); border: 1px solid #4a9dff; box-shadow: 0 0 10px rgba(74, 157, 255, 0.3);">
                            CREATE NEW SYSTEM
                            <small>Generate custom AI star systems</small>
                        </button>
                        <button id="open-blackjack" class="feature-btn" style="background-color: #9933cc;">
                            STELLAR BLACKJACK
                            <small>Wager resources in card games</small>
                        </button>
                        <button id="open-settings" class="feature-btn" style="background-color: #33aaff;">
                            SETTINGS
                            <small>Adjust graphics and audio options</small>
                        </button>
                    </div>
                </div>
                
                <!-- Challenge Section -->
                <div id="challenge-section" class="stargate-section">
                    <h3>EXTREME CHALLENGE</h3>
                    <button id="unleash-horde" class="action-btn btn-horde">
                        UNLEASH THE HORDE
                    </button>
                    <p style="font-size: 12px; color: #ff9999; margin: 10px 0 0 0;">WARNING: Activate extreme survival mode with infinitely scaling difficulty</p>
                </div>
            </div>
            
            <!-- Footer -->
            <div id="stargate-footer">
                <button id="undock-btn" class="action-btn btn-undock" data-no-touch-overlay="true">UNDOCK</button>
            </div>
        `,document.body.appendChild(s)}setupSettingsButton(){if(!this.settings)return;const e=document.getElementById("open-settings");e&&e.addEventListener("click",()=>{console.log("Opening settings"),this.hideStargateUI(),this.settings.show()})}showDockingPrompt(){const e=document.getElementById("docking-prompt");e&&e.dataset.alwaysHide!=="true"&&(e.style.display="block")}hideDockingPrompt(){const e=document.getElementById("docking-prompt");e&&(e.style.display="none")}showStargateUI(){const e=document.getElementById("stargate-ui");e&&(console.log("Showing stargate UI on "+(this.isMobile?"mobile":"desktop")),e.style.display="block",e.style.backgroundColor="rgba(20, 30, 50, 0.9)",this.isMobile&&(e.style.width="92%",e.style.maxWidth="92vw",e.style.maxHeight="85vh",e.style.webkitOverflowScrolling="touch",e.style.touchAction="pan-y",e.style.overscrollBehavior="auto",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.zIndex="1000",document.body.classList.remove("undocking","modal-open")));const t=document.getElementById("docking-prompt");if(t&&(t.style.display="none"),this.setupStarMapButton(),this.setupBlackjackButton(),this.setupSettingsButton(),this.isMobile&&this.setupTouchEvents(),window.game&&window.game.controls){const s=window.game.spaceship,i=window.game.controls.resources;s&&i&&(console.log("Syncing stargate UI with game resources:",i),this.updateStargateUI(s,i))}}setupStarMapButton(){const e=document.getElementById("open-star-map");e&&this.starMap?e.addEventListener("click",()=>{console.log("Opening star map"),this.hideStargateUI(),this.starMap.show()}):e&&(e.disabled=!0,e.style.backgroundColor="#555",e.style.cursor="not-allowed",e.title="Star map not available")}setupBlackjackButton(){const e=document.getElementById("open-blackjack");e&&this.blackjackGame?e.addEventListener("click",()=>{console.log("Opening blackjack game"),this.hideStargateUI(),this.blackjackGame.show()}):e&&(e.disabled=!0,e.style.backgroundColor="#555",e.style.cursor="not-allowed",e.title="Blackjack game not available")}hideStargateUI(){const e=document.getElementById("stargate-ui");e&&(e.style.display="none")}hide(){this.hideStargateUI()}updateStargateUI(e,t){document.getElementById("ms-iron").textContent=t.iron,document.getElementById("ms-gold").textContent=t.gold,document.getElementById("ms-platinum").textContent=t.platinum,document.getElementById("ms-credits").textContent=`${e.credits} CR`,document.getElementById("fuel-gauge").style.width=`${e.fuel/e.maxFuel*100}%`,document.getElementById("fuel-level").textContent=Math.round(e.fuel/e.maxFuel*100),document.getElementById("shield-gauge").style.width=`${e.shield/e.maxShield*100}%`,document.getElementById("shield-level").textContent=Math.round(e.shield/e.maxShield*100),document.getElementById("hull-gauge").style.width=`${e.hull/e.maxHull*100}%`,document.getElementById("hull-level").textContent=Math.round(e.hull/e.maxHull*100);const s=document.getElementById("refuel-btn");e.credits<100||e.fuel>=e.maxFuel*.999?(s.disabled=!0,s.style.backgroundColor="#555",s.style.cursor="not-allowed"):(s.disabled=!1,s.style.backgroundColor="#00cc33",s.style.cursor="pointer");const i=document.getElementById("repair-shield-btn");e.credits<150||e.shield>=e.maxShield*.999?(i.disabled=!0,i.style.backgroundColor="#555",i.style.cursor="not-allowed"):(i.disabled=!1,i.style.backgroundColor="#3399ff",i.style.cursor="pointer");const o=document.getElementById("repair-hull-btn");e.credits<200||e.hull>=e.maxHull*.999?(o.disabled=!0,o.style.backgroundColor="#555",o.style.cursor="not-allowed"):(o.disabled=!1,o.style.backgroundColor="#ff9900",o.style.cursor="pointer"),document.getElementById("current-fuel-level").textContent=e.fuelTankLevel,document.getElementById("current-fuel-capacity").textContent=e.maxFuel,document.getElementById("next-fuel-capacity").textContent=e.maxFuel*2,document.getElementById("fuel-upgrade-cost").textContent=e.fuelUpgradeCost,document.getElementById("fuel-upgrade-progress").style.width=`${Math.min(e.fuelTankLevel*20,100)}%`,document.getElementById("current-engine-level").textContent=e.engineLevel,document.getElementById("current-max-velocity").textContent=e.maxVelocity.toFixed(2),document.getElementById("next-max-velocity").textContent=(e.maxVelocity*1.25).toFixed(2),document.getElementById("engine-upgrade-cost").textContent=e.engineUpgradeCost,document.getElementById("engine-upgrade-progress").style.width=`${Math.min(e.engineLevel*20,100)}%`,document.getElementById("current-mining-level").textContent=e.miningLevel,document.getElementById("current-mining-efficiency").textContent=Math.round(e.miningEfficiency*100),document.getElementById("next-mining-efficiency").textContent=Math.round(e.miningEfficiency*130),document.getElementById("mining-upgrade-cost").textContent=e.miningUpgradeCost,document.getElementById("mining-upgrade-progress").style.width=`${Math.min(e.miningLevel*20,100)}%`,document.getElementById("current-hull-level").textContent=e.hullLevel,document.getElementById("current-hull-resistance").textContent=Math.round(e.collisionResistance*100),document.getElementById("next-hull-resistance").textContent=Math.round(e.collisionResistance*125),document.getElementById("hull-upgrade-cost").textContent=e.hullUpgradeCost,document.getElementById("hull-upgrade-progress").style.width=`${Math.min(e.hullLevel*20,100)}%`,document.getElementById("current-scanner-level").textContent=e.scannerLevel,document.getElementById("current-scanner-range").textContent=Math.round(e.scanRange),document.getElementById("next-scanner-range").textContent=Math.round(e.scanRange*1.2),document.getElementById("scanner-upgrade-cost").textContent=e.scannerUpgradeCost,document.getElementById("scanner-upgrade-progress").style.width=`${Math.min(e.scannerLevel*20,100)}%`,this.updateUpgradeButtonStatus("upgrade-fuel-tank",e.credits,e.fuelUpgradeCost,"#00cc33"),this.updateUpgradeButtonStatus("upgrade-engine",e.credits,e.engineUpgradeCost,"#ff9900"),this.updateUpgradeButtonStatus("upgrade-mining",e.credits,e.miningUpgradeCost,"#ff3030"),this.updateUpgradeButtonStatus("upgrade-hull",e.credits,e.hullUpgradeCost,"#30cfd0"),this.updateUpgradeButtonStatus("upgrade-scanner",e.credits,e.scannerUpgradeCost,"#9933cc"),document.getElementById("sell-iron").disabled=t.iron===0,document.getElementById("sell-gold").disabled=t.gold===0,document.getElementById("sell-platinum").disabled=t.platinum===0,this.updateSellButtonStatus("sell-iron",t.iron,"#cc6633"),this.updateSellButtonStatus("sell-gold",t.gold,"#ffcc33"),this.updateSellButtonStatus("sell-platinum",t.platinum,"#33ccff"),document.querySelectorAll(".sell-btn").forEach(l=>{l.disabled&&(l.style.backgroundColor="rgba(40, 40, 40, 0.8)",l.style.color="#777",l.style.cursor="not-allowed",l.style.boxShadow="none")});const n=document.getElementById("current-laser-count");n&&(n.textContent=e.deployableLaserCount||0);const a=document.getElementById("purchase-laser");a&&(e.credits<1e3?(a.disabled=!0,a.style.backgroundColor="#555",a.style.cursor="not-allowed"):(a.disabled=!1,a.style.backgroundColor="#FF3333",a.style.cursor="pointer")),t.orbs||(t.orbs={common:0,uncommon:0,rare:0,epic:0,legendary:0}),document.getElementById("orb-common-count").textContent=t.orbs.common>0?`${t.orbs.common} in inventory`:"0 in inventory",document.getElementById("orb-uncommon-count").textContent=t.orbs.uncommon>0?`${t.orbs.uncommon} in inventory`:"0 in inventory",document.getElementById("orb-rare-count").textContent=t.orbs.rare>0?`${t.orbs.rare} in inventory`:"0 in inventory",document.getElementById("orb-epic-count").textContent=t.orbs.epic>0?`${t.orbs.epic} in inventory`:"0 in inventory",document.getElementById("orb-legendary-count").textContent=t.orbs.legendary>0?`${t.orbs.legendary} in inventory`:"0 in inventory";const r=(l,c,d)=>{const h=document.getElementById(l);h&&(c===0?(h.disabled=!0,h.style.backgroundColor="rgba(40, 40, 40, 0.8)",h.style.color="#777",h.style.cursor="not-allowed",h.style.boxShadow="none"):(h.disabled=!1,h.style.backgroundColor="rgba(15, 40, 55, 0.8)",h.style.color="#fff",h.style.cursor="pointer",h.style.boxShadow=`0 0 10px ${d}`))};r("sell-orb-common",t.orbs.common,"rgba(0, 255, 102, 0.3)"),r("sell-orb-uncommon",t.orbs.uncommon,"rgba(0, 102, 255, 0.3)"),r("sell-orb-rare",t.orbs.rare,"rgba(153, 0, 255, 0.3)"),r("sell-orb-epic",t.orbs.epic,"rgba(255, 102, 0, 0.3)"),r("sell-orb-legendary",t.orbs.legendary,"rgba(255, 0, 0, 0.3)")}updateUpgradeButtonStatus(e,t,s,i){const o=document.getElementById(e);o&&(t<s?(o.disabled=!0,o.style.backgroundColor="#555",o.style.color="#777",o.style.cursor="not-allowed"):(o.disabled=!1,o.style.backgroundColor=i,o.style.color=i==="#ff9900"||i==="#30cfd0"?"#000":"#fff",o.style.cursor="pointer"))}updateSellButtonStatus(e,t,s){const i=document.getElementById(e);i&&(t===0?(i.disabled=!0,i.style.backgroundColor="rgba(40, 40, 40, 0.8)",i.style.borderColor="#555",i.style.color="#777",i.style.boxShadow="none",i.style.cursor="not-allowed"):(i.disabled=!1,i.style.backgroundColor="rgba(15, 40, 55, 0.8)",i.style.borderColor=s,i.style.color="#fff",i.style.boxShadow=`0 0 10px rgba(${parseInt(s.slice(1,3),16)}, ${parseInt(s.slice(3,5),16)}, ${parseInt(s.slice(5,7),16)}, 0.3)`,i.style.cursor="pointer"))}setupTouchEvents(){if(!this.isMobile)return;const e=document.getElementById("stargate-ui");if(!e)return;console.log("Setting up touch events for stargate UI");const t=document.getElementById("undock-btn");t&&(t.style.touchAction="manipulation",t.style.webkitTapHighlightColor="transparent",t.style.position="relative",t.style.zIndex="9999",t.addEventListener("touchstart",o=>{console.log("Touch start on undock button"),t.style.backgroundColor="#1b88db",t.style.transform="scale(0.98)",o.stopPropagation()},{passive:!1}),t.addEventListener("touchend",o=>{console.log("Touch end on undock button"),t.style.backgroundColor="#33aaff",t.style.transform="scale(1)",o.stopPropagation()},{passive:!1})),e.addEventListener("touchmove",o=>{o.stopPropagation()},{passive:!0}),e.addEventListener("touchstart",o=>{e.scrollTop<=0&&o.touches[0].screenY<o.touches[0].clientY&&o.preventDefault()},{passive:!1});const s=e.querySelectorAll(".tablinks");s.length>0&&s.forEach(o=>{o.addEventListener("touchend",n=>{n.preventDefault(),o.click()})}),e.querySelectorAll("button").forEach(o=>{o!==t&&(o.style.touchAction="manipulation",o.style.webkitTapHighlightColor="transparent",o.addEventListener("touchstart",()=>{o.style.transform="scale(0.98)"},{passive:!0}),o.addEventListener("touchend",()=>{o.style.transform="scale(1)"},{passive:!0}))})}setupEventHandlers(){const e=document.getElementById("create-custom-system");e&&e.addEventListener("click",()=>{window.game&&window.game.environment&&window.game.environment.customSystemCreator?(this.hide(),window.game.environment.customSystemCreator.show()):console.error("Custom system creator not available")});const t=document.getElementById("unleash-horde");t&&t.addEventListener("click",()=>{window.game&&window.game.ecsWorld&&window.game.ecsWorld.enemySystem&&window.game.ecsWorld.enemySystem.initialSpawnComplete?(console.log("HORDE MODE: Button clicked, showing confirmation"),this.showHordeConfirmation()):(console.log("HORDE MODE: Button clicked but spectral drones haven't appeared yet"),this.showNotification("Horde mode is only available after spectral drones appear in the sector.",16724016))});const s=document.getElementById("purchase-laser");s&&s.addEventListener("click",this.purchaseLaserTurret.bind(this)),document.getElementById("sell-orb-common").addEventListener("click",()=>{this.sellEnergyOrb("common")&&this.updateStargateUI(window.game.spaceship,window.game.controls.resources)}),document.getElementById("sell-orb-uncommon").addEventListener("click",()=>{this.sellEnergyOrb("uncommon")&&this.updateStargateUI(window.game.spaceship,window.game.controls.resources)}),document.getElementById("sell-orb-rare").addEventListener("click",()=>{this.sellEnergyOrb("rare")&&this.updateStargateUI(window.game.spaceship,window.game.controls.resources)}),document.getElementById("sell-orb-epic").addEventListener("click",()=>{this.sellEnergyOrb("epic")&&this.updateStargateUI(window.game.spaceship,window.game.controls.resources)}),document.getElementById("sell-orb-legendary").addEventListener("click",()=>{this.sellEnergyOrb("legendary")&&this.updateStargateUI(window.game.spaceship,window.game.controls.resources)})}showHordeConfirmation(){const e=document.createElement("div");e.id="horde-confirm-modal";const t=document.createElement("div");t.id="horde-confirm-content";const s=document.createElement("div");s.className="horde-confirm-title",s.textContent="UNLEASH THE HORDE?",t.appendChild(s);const i=document.createElement("div");i.className="horde-confirm-text",i.innerHTML=`
            <p>You are about to activate EXTREME SURVIVAL MODE.</p>
            <p>Enemies will continuously spawn with increasing:</p>
            <ul style="text-align: left; padding-left: 30px; margin: 15px 0;">
                <li>Numbers (starting at 50, scaling upward)</li>
                <li>Speed (progressively faster movement)</li>
                <li>Health (gradually becoming tougher)</li>
                <li>Damage (increasingly lethal hits)</li>
            </ul>
            <p>Difficulty will scale <strong>infinitely</strong> until you are overwhelmed.</p>
            <p style="color: #ff9999;">This is a test of survival. How long can you last?</p>
        `,t.appendChild(i);const o=document.createElement("div");o.className="horde-confirm-buttons";const n=document.createElement("button");n.className="horde-confirm-btn horde-confirm-yes",n.textContent="UNLEASH THEM",n.addEventListener("click",()=>{document.body.removeChild(e),this.hideStargateUI(),window.game&&typeof window.game.activateHordeMode=="function"?(window.game.activateHordeMode(),console.log("HORDE MODE: Activated via stargateInterface")):console.error("HORDE MODE: Failed to activate - game.activateHordeMode not available")});const a=document.createElement("button");a.className="horde-confirm-btn horde-confirm-no",a.textContent="CANCEL",a.addEventListener("click",()=>{document.body.removeChild(e)}),o.appendChild(a),o.appendChild(n),t.appendChild(o),e.appendChild(t),document.body.appendChild(e)}purchaseLaserTurret(){if(console.log("Attempting to purchase laser turret"),!window.game||!window.game.spaceship){console.error("Cannot purchase laser turret: game or spaceship not found");return}const e=window.game.spaceship;if(e.credits<1e3){console.log("Not enough credits to purchase laser turret"),window.mainMessageBus&&window.mainMessageBus.publish("ui.notification",{message:"Not enough credits to purchase laser turret",type:"error",duration:2});return}e.credits-=1e3,typeof e.deployableLaserCount>"u"&&(e.deployableLaserCount=0),e.deployableLaserCount++,window.game.audio&&window.game.audio.playSound&&window.game.audio.playSound("purchase"),this.updateStargateUI(e,window.game.controls.resources),window.mainMessageBus&&window.mainMessageBus.publish("ui.notification",{message:"Laser turret purchased",type:"success",duration:2}),console.log("Laser turret purchased successfully")}sellEnergyOrb(e){if(!window.game||!window.game.spaceship||!window.game.controls||!window.game.controls.resources)return console.error("Required game objects not available"),!1;const t=window.game.spaceship,s=window.game.controls.resources;if(!s.orbs)return s.orbs={common:0,uncommon:0,rare:0,epic:0,legendary:0},!1;if(!s.orbs[e]||s.orbs[e]<=0)return console.log(`No ${e} orbs available to sell`),!1;let i=0;switch(e){case"common":i=100;break;case"uncommon":i=500;break;case"rare":i=1500;break;case"epic":i=5e3;break;case"legendary":i=15e3;break;default:return console.error(`Unknown orb rarity: ${e}`),!1}s.orbs[e]--,t.credits+=i;const o=e.charAt(0).toUpperCase()+e.slice(1);return this.showNotification(`Sold ${o} Energy Orb for ${i} credits`,3386111),window.game.audio&&window.game.audio.playSoundEffect("sell",.5),!0}showNotification(e,t=3386111){const s=document.createElement("div");s.style.position="fixed",s.style.top="35%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.backgroundColor="rgba(0, 0, 0, 0.8)",s.style.color="#fff",s.style.padding="15px 30px",s.style.borderRadius="10px",s.style.border=`2px solid #${t.toString(16).padStart(6,"0")}`,s.style.boxShadow=`0 0 15px #${t.toString(16).padStart(6,"0")}`,s.style.fontFamily="Courier New, monospace",s.style.fontSize="16px",s.style.zIndex="1001",s.style.textAlign="center",s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transition="opacity 0.8s",setTimeout(()=>{s.remove()},800)},2e3)}}function Nt(p){if(console.log(`Original path: ${p}`),window.location.hostname!=="localhost"&&window.location.hostname!=="127.0.0.1"){const e=window.location.pathname.split("/").slice(0,-1).join("/"),t=p.startsWith("/")?p.substring(1):p,s=`${e}/${t}`;return console.log(`Adjusted path for hosted environment: ${s}`),s}return console.log(`Using original path for local environment: ${p}`),p}class Wi{constructor(){this.isVisible=!1,this.setupGameOverScreen()}getPath(e){return Nt(e)}setupGameOverScreen(){const e=document.createElement("div");e.id="game-over-container",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.color="#fff",e.style.fontFamily="Courier New, monospace",e.style.zIndex="1000",e.style.display="none",document.body.appendChild(e);const t=document.createElement("h1");t.textContent="GAME OVER",t.style.fontSize="50px",t.style.color="#ff0000",t.style.textShadow="0 0 10px #ff0000",t.style.marginBottom="20px",e.appendChild(t);const s=document.createElement("p");s.id="game-over-message",s.textContent="Your ship was destroyed by asteroid collision",s.style.fontSize="18px",s.style.marginBottom="40px",e.appendChild(s),this.setupRestartButton(e);const i=document.createElement("div");i.id="resources-summary",i.style.marginTop="30px",i.style.fontSize="16px",i.style.textAlign="center",e.appendChild(i)}setupRestartButton(e){const t=document.createElement("button");t.id="restart-game-button",t.textContent="RESTART MISSION",t.style.backgroundColor="rgba(120, 220, 232, 0.2)",t.style.color="#fff",t.style.border="1px solid rgba(120, 220, 232, 0.5)",t.style.borderRadius="5px",t.style.padding="15px 30px",t.style.fontSize="20px",t.style.fontFamily='"Rajdhani", sans-serif',t.style.cursor="pointer",t.style.marginTop="30px",t.style.transition="all 0.2s ease",t.addEventListener("mouseover",()=>{t.style.backgroundColor="rgba(120, 220, 232, 0.4)",t.style.boxShadow="0 0 15px rgba(120, 220, 232, 0.5)"}),t.addEventListener("mouseout",()=>{t.style.backgroundColor="rgba(120, 220, 232, 0.2)",t.style.boxShadow="none"}),t.addEventListener("click",()=>{this.audio&&this.audio.playSound("uiClick");const s=document.createElement("div");s.textContent="Restarting mission...",s.style.color="rgba(120, 220, 232, 0.9)",s.style.marginTop="10px",e.appendChild(s),t.disabled=!0,t.style.opacity="0.5",t.style.cursor="default",window.game&&(window.game.difficultyManager&&(window.game.difficultyManager.gameTime=0,window.game.difficultyManager.currentLevel=1,console.log("Reset difficulty level to 1")),window.game.gameTime=0),setTimeout(()=>{location.reload()},500)}),e.appendChild(t)}show(e,t){console.log("GameOverScreen: Showing game over screen");const s=document.getElementById("game-over-container");s.style.display="flex";const i=document.getElementById("game-over-message");if(i){let u="Your journey has ended.";if(typeof t=="object"&&t.data&&t.data.type)switch(t.data.type){case"FUEL_DEPLETED":u="Your ship drifted into the void after running out of fuel.";break;case"COLLISION_ASTEROID":u="Your ship was destroyed by an asteroid collision.";break;case"COLLISION_PLANET":u="Your ship crashed into a planet!";break;case"COMBAT_DEATH":u="Your ship was destroyed in combat.";break;case"SUN_DEATH":u="Your ship was incinerated by the sun's heat!";break;default:t.data.reason&&(u=t.data.reason)}else t&&(t.includes("fuel")?u="Your ship drifted into the void after running out of fuel.":t.includes("asteroid")?u="Your ship was destroyed by an asteroid collision.":t.includes("combat")?u="Your ship was destroyed in combat.":t.includes("sun")?u="Your ship was incinerated by the sun's heat!":t.includes("planet")?u="Your ship crashed into a planet!":u=t);i.textContent=u}let o=!1,n="00:00",a=0;e&&e.hordeMode&&(o=e.hordeMode.active,n=e.hordeMode.survivalTime||"00:00",a=e.hordeMode.rawSurvivalTime||0);let r=e;e&&e.resources&&(console.log("GameOverScreen: Using nested resources data structure"),r=e.resources);const l=r&&r.iron?r.iron:0,c=r&&r.gold?r.gold:0,d=r&&r.platinum?r.platinum:0,h=document.getElementById("resources-summary");if(h)if(o){const u=Math.floor(a/1e3/60);let m="You fought valiantly against overwhelming odds.";u>=10?m="LEGENDARY! Few have survived the horde this long!":u>=5?m="IMPRESSIVE! You showed exceptional combat skills!":u>=3&&(m="Well done! You held back the horde longer than most!"),h.innerHTML=`
                    <div style="margin-bottom:20px; padding:15px; background-color:rgba(255,48,48,0.2); border:1px solid #ff3030; border-radius:5px;">
                        <h3 style="color:#ff3030; margin-top:0; text-shadow:0 0 5px rgba(255,48,48,0.5);">HORDE MODE</h3>
                        <p style="font-size:18px; font-weight:bold;">SURVIVED: <span style="color:#ff9999; text-shadow:0 0 5px rgba(255,48,48,0.3);">${n}</span></p>
                        <p>${m}</p>
                    </div>
                    <p>Resources collected:</p>
                    <p>IRON: ${l} | GOLD: ${c} | PLATINUM: ${d}</p>
                `}else h.innerHTML=`
                    <p>Resources collected:</p>
                    <p>IRON: ${l} | GOLD: ${c} | PLATINUM: ${d}</p>
                `;try{console.log("GameOverScreen: Attempting simple audio playback");const u=new Audio(this.getPath("sounds/effects/boink.wav"));u.volume=.8,setTimeout(()=>{u.play().catch(m=>{console.warn("GameOverScreen: Simple sound failed:",m)})},100)}catch(u){console.error("GameOverScreen: Error with simple sound approach:",u)}document.exitPointerLock&&document.exitPointerLock()}}class qi{constructor(){this.setupControlsMenu()}setupControlsMenu(){const e=document.createElement("div");e.id="controls-menu",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.padding="15px",e.style.borderRadius="10px",e.style.border="1px solid #30cfd0",e.style.boxShadow="0 0 10px #30cfd0",e.style.zIndex="1000",e.style.display="none",document.body.appendChild(e);const t=document.createElement("div");t.className="help-title",t.innerHTML='CONTROLS <span id="close-controls" style="float: right; cursor: pointer; font-weight: bold;">X</span>',e.appendChild(t);const s=(i,o)=>{const n=document.createElement("div");n.className="control-row",n.style.display="flex",n.style.justifyContent="space-between",n.style.marginBottom="5px";const a=document.createElement("span");i!=="Mouse"&&(a.className="key",a.style.backgroundColor="rgba(48, 207, 208, 0.2)",a.style.border="1px solid #30cfd0",a.style.borderRadius="4px",a.style.padding="0 5px",a.style.minWidth="20px",a.style.textAlign="center"),a.textContent=i,n.appendChild(a);const r=document.createElement("span");return r.textContent=o,n.appendChild(r),n};e.appendChild(s("W","Forward Thrust")),e.appendChild(s("S","Backward Thrust")),e.appendChild(s("A","Left Thrust")),e.appendChild(s("D","Right Thrust")),e.appendChild(s("SHIFT","Boost")),e.appendChild(s("Mouse","Ship Rotation")),e.appendChild(s("Click","Fire Particle Cannon")),e.appendChild(s("E","Target Lock-On")),e.appendChild(s("TAB","Cycle Targets")),e.appendChild(s("R","Toggle Mining")),e.appendChild(s("T","Deploy Laser Turret")),e.appendChild(s("Q","Dock with Stargate")),document.getElementById("close-controls").addEventListener("click",()=>{this.hide()}),document.addEventListener("click",i=>{const o=document.getElementById("controls-menu"),n=document.getElementById("show-controls");o.style.display==="block"&&!o.contains(i.target)&&i.target!==n&&this.hide()})}show(){const e=document.getElementById("controls-menu");e&&(e.style.display="block")}hide(){const e=document.getElementById("controls-menu");e&&(e.style.display="none")}setupButtonHandler(){const e=document.getElementById("show-controls");e&&e.addEventListener("click",t=>{this.show(),t.stopPropagation()})}}class Ki{constructor(e,t,s){this.starSystemGenerator=e,this.dockingSystem=t,this.stargateInterface=s,this.isVisible=!1,this.selectedSystem=null,this.isTraveling=!1,this.isMobile=ye.isMobile(),console.log("StarMap constructor - isMobile:",this.isMobile),this.setupStarMapUI(),this.setupEventHandlers()}setupStarMapUI(){const e=document.createElement("div");e.id="star-map",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",this.isMobile?(e.style.width="95%",e.style.height="85vh",e.style.maxHeight="700px"):(e.style.width="900px",e.style.height="700px"),e.style.backgroundColor="rgba(10, 15, 30, 0.95)",e.style.color="#fff",e.style.padding=this.isMobile?"15px":"30px",e.style.borderRadius="10px",e.style.border="2px solid #30cfd0",e.style.boxShadow="0 0 30px #30cfd0",e.style.fontFamily="Courier New, monospace",e.style.zIndex="1500",e.style.display="none",e.style.overflow="hidden";const t=document.createElement("h2");t.textContent="STAR MAP",t.style.textAlign="center",t.style.color="#30cfd0",t.style.margin="0 0 20px 0",t.style.fontSize=this.isMobile?"24px":"28px",e.appendChild(t);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection=this.isMobile?"column":"row",s.style.height=this.isMobile?"calc(100% - 120px)":"calc(100% - 100px)",s.style.gap=this.isMobile?"15px":"0";const i=document.createElement("div");i.id="star-map-visual",i.style.flex="1",i.style.background="rgba(0, 0, 0, 0.7)",i.style.borderRadius="10px",i.style.border="1px solid #30cfd0",i.style.position="relative",i.style.overflow="hidden",i.style.height=this.isMobile?"40%":"100%",i.style.minHeight=this.isMobile?"250px":"auto";const o=document.createElement("canvas");o.id="star-map-canvas",o.width=500,o.height=500,o.style.width="100%",o.style.height="100%",i.appendChild(o);const n=document.createElement("div");n.id="system-info-panel",n.style.width=this.isMobile?"100%":"350px",n.style.marginLeft=this.isMobile?"0":"20px",n.style.overflowY="auto",n.style.height=this.isMobile?"60%":"100%",n.style.webkitOverflowScrolling="touch";const a=document.createElement("div");a.id="current-system-info",a.innerHTML=`
            <h3 style="color: #30cfd0; margin-top: 0; font-size: ${this.isMobile?"16px":"18px"};">CURRENT SYSTEM</h3>
            <div class="system-card" style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 5px; border: 1px solid #30cfd0; margin-bottom: 20px;">
                <div id="current-system-name" style="font-size: ${this.isMobile?"16px":"18px"}; font-weight: bold; color: #fff; margin-bottom: 5px;">Solar System</div>
                <div id="current-system-class" style="font-size: ${this.isMobile?"12px":"14px"}; color: #aaa; margin-bottom: 10px;">Class G - Home System</div>
                <div id="current-system-resources" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Iron:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div id="current-iron-indicator" style="height: 100%; width: 50%; background: #aaa;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Gold:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div id="current-gold-indicator" style="height: 100%; width: 50%; background: #FFD700;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Platinum:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div id="current-platinum-indicator" style="height: 100%; width: 50%; background: #E5E4E2;"></div>
                        </div>
                    </div>
                </div>
                <div id="current-system-description" style="font-size: ${this.isMobile?"11px":"12px"}; color: #ccc; margin-bottom: 10px;">
                    Our home system, with Earth as the starting location.
                </div>
                <div id="current-system-features" style="font-size: ${this.isMobile?"11px":"12px"}; color: #30cfd0;">
                    Special Features: Earth
                </div>
            </div>
        `,n.appendChild(a);const r=document.createElement("div");r.id="selected-system-info",r.innerHTML=`
            <h3 style="color: #30cfd0; font-size: ${this.isMobile?"16px":"18px"};">SELECTED SYSTEM</h3>
            <div id="selected-system-card" class="system-card" style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 5px; border: 1px solid #555; margin-bottom: 20px;">
                <div class="empty-selection" style="color: #777; text-align: center; padding: 20px;">
                    No system selected.<br>
                    ${this.isMobile?"Tap":"Click"} on a star system in the map to select it.
                </div>
            </div>
            <button id="travel-button" disabled style="width: 100%; padding: ${this.isMobile?"15px":"12px"}; background-color: #30cfd0; color: #000; border: none; border-radius: 5px; cursor: not-allowed; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile?"18px":"16px"}; opacity: 0.5;">
                TRAVEL TO SYSTEM
            </button>
        `,n.appendChild(r),s.appendChild(i),s.appendChild(n),e.appendChild(s);const l=document.createElement("button");l.id="close-star-map",l.textContent="RETURN TO STARGATE",l.style.width="100%",l.style.padding=this.isMobile?"15px":"12px",l.style.marginTop="20px",l.style.backgroundColor="#555",l.style.color="#fff",l.style.border="none",l.style.borderRadius="5px",l.style.cursor="pointer",l.style.fontFamily="Courier New, monospace",l.style.fontWeight="bold",l.style.fontSize=this.isMobile?"18px":"16px",this.isMobile&&(l.style.backgroundColor="#30cfd0",l.style.color="#000",l.style.boxShadow="0 0 15px rgba(48, 207, 208, 0.7)"),e.appendChild(l),document.body.appendChild(e)}setupEventHandlers(){const e=document.getElementById("close-star-map");e&&(e.addEventListener("click",()=>{window.game&&window.game.audio&&window.game.audio.playSound("boink"),this.hide()}),this.isMobile&&e.addEventListener("touchend",i=>{i.preventDefault(),window.game&&window.game.audio?(console.log("Mobile: Playing sound on star map close button"),window.game.audio.playSound("boink"),setTimeout(()=>this.hide(),50)):this.hide()}));const t=document.getElementById("star-map-canvas");t&&(t.addEventListener("click",i=>{this.handleMapInteraction(i)}),this.isMobile&&t.addEventListener("touchend",i=>{i.preventDefault(),this.handleMapInteraction(i.changedTouches[0])}));const s=document.getElementById("travel-button");if(s){const i=()=>{if(this.selectedSystem&&this.selectedSystem!==this.starSystemGenerator.currentSystem){console.log(`Initiating travel to system: ${this.selectedSystem}`),this.isTraveling=!0,this.hide();const o=window.game.environment;if(o&&o.travelToSystem){const n=o.travelToSystem(this.selectedSystem);console.log(`Travel to ${this.selectedSystem} initiated: ${n}`),setTimeout(()=>{this.isTraveling=!1},5e3)}else this.starSystemGenerator.travelToSystem(this.selectedSystem)&&(this.updateCurrentSystemInfo(),this.updateCanvas(),this.selectSystem(null),this.showTravelNotification(this.starSystemGenerator.getCurrentSystemData().name),this.isTraveling=!1)}};s.addEventListener("click",i),this.isMobile&&s.addEventListener("touchend",o=>{o.preventDefault(),i()})}}handleMapInteraction(e){const t=document.getElementById("star-map-canvas"),s=t.getBoundingClientRect(),i=(e.clientX-s.left)*(t.width/s.width),o=(e.clientY-s.top)*(t.height/s.height),n=this.findSystemAtPosition(i,o);n&&(this.selectSystem(n),this.updateCanvas())}findSystemAtPosition(e,t){const s=this.starSystemGenerator.getAllSystems(),i=this.starSystemGenerator.currentSystem,o=250,n=250;for(const[a,r]of Object.entries(s)){const l=o+r.position.x,c=n+r.position.y,d=e-l,h=t-c,u=Math.sqrt(d*d+h*h),m=a===i?this.isMobile?20:15:this.isMobile?15:10;if(u<=m)return a}return null}selectSystem(e){if(console.log(`Selecting system: ${e}`),this.selectedSystem=e,!e){const n=document.getElementById("selected-system-card");n&&(n.innerHTML=`
                    <div class="empty-selection" style="color: #777; text-align: center; padding: 20px;">
                        No system selected.<br>${this.isMobile?"Tap":"Click"} on a star system in the map to select it.
                    </div>
                `);const a=document.getElementById("travel-button");a&&(a.disabled=!0,a.style.cursor="not-allowed",a.style.opacity="0.5");return}const t=this.starSystemGenerator.getAllSystems()[e],s=this.starSystemGenerator.currentSystem,i=document.getElementById("selected-system-card");if(i&&t&&(i.innerHTML=`
                <div id="selected-system-name" style="font-size: ${this.isMobile?"16px":"18px"}; font-weight: bold; color: #fff; margin-bottom: 5px;">${t.name}</div>
                <div id="selected-system-class" style="font-size: ${this.isMobile?"12px":"14px"}; color: #aaa; margin-bottom: 10px;">Class ${t.starClass} - ${t.classification}</div>
                <div id="selected-system-resources" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Iron:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${t.resourceMultipliers.iron*50}%; background: #aaa;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Gold:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${t.resourceMultipliers.gold*50}%; background: #FFD700;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Platinum:</span>
                        <div class="resource-indicator" style="width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${t.resourceMultipliers.platinum*50}%; background: #E5E4E2;"></div>
                        </div>
                    </div>
                </div>
                <div style="font-size: ${this.isMobile?"11px":"12px"}; color: #ccc; margin-bottom: 10px;">
                    ${t.description}
                </div>
                <div style="font-size: ${this.isMobile?"11px":"12px"}; color: #30cfd0;">
                    Special Features: ${t.specialFeatures.join(", ")}
                </div>
            `,this.isMobile)){const n=document.getElementById("system-info-panel");n&&(n.scrollTop=i.offsetTop-n.offsetTop)}const o=document.getElementById("travel-button");if(o){const n=this.starSystemGenerator.getCurrentSystemConnections().includes(e),a=e===s;o.disabled=a||!n,o.style.cursor=a||!n?"not-allowed":"pointer",o.style.opacity=a||!n?"0.5":"1",o.textContent=a?"CURRENT LOCATION":n?"TRAVEL TO SYSTEM":"NO DIRECT ROUTE"}}updateCanvas(){const e=document.getElementById("star-map-canvas");if(!e)return;const t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);const s=e.width/2,i=e.height/2,o=this.starSystemGenerator.getAllSystems(),n=this.starSystemGenerator.currentSystem,a=this.starSystemGenerator.warpGates;t.lineWidth=1,t.strokeStyle="rgba(48, 207, 208, 0.4)";for(const[r,l]of Object.entries(a)){const c=o[r];if(!c)continue;const d=s+c.position.x,h=i+c.position.y;for(const u of l){const m=o[u];if(!m)continue;const f=s+m.position.x,g=i+m.position.y;t.beginPath(),t.moveTo(d,h),t.lineTo(f,g),t.stroke()}}if(n&&o[n]){const r=o[n],l=s+r.position.x,c=i+r.position.y;t.lineWidth=this.isMobile?3:2,t.strokeStyle="rgba(48, 207, 208, 0.8)";for(const d of r.connections){const h=o[d];if(!h)continue;const u=s+h.position.x,m=i+h.position.y;t.beginPath(),t.moveTo(l,c),t.lineTo(u,m),t.stroke()}}for(const[r,l]of Object.entries(o)){const c=s+l.position.x,d=i+l.position.y,h=r===n,u=r===this.selectedSystem,m=n&&o[n]&&o[n].connections.includes(r);t.beginPath();let f;this.isMobile?f=h?18:u?15:10:f=h?15:u?12:8,t.fillStyle=l.starColor?`#${l.starColor.toString(16).padStart(6,"0")}`:"#ffffff",h||u?(t.shadowBlur=this.isMobile?20:15,t.shadowColor=h?"#30cfd0":"#ffffff"):t.shadowBlur=0,t.arc(c,d,f,0,Math.PI*2),t.fill(),t.shadowBlur=0,m&&!h&&(t.strokeStyle="#30cfd0",t.lineWidth=this.isMobile?3:2,t.beginPath(),t.arc(c,d,f+3,0,Math.PI*2),t.stroke()),t.fillStyle=h?"#30cfd0":u?"#ffffff":"#aaaaaa",t.font=h?this.isMobile?"bold 14px Courier New":"bold 12px Courier New":this.isMobile?"12px Courier New":"10px Courier New",t.textAlign="center",t.fillText(l.name,c,d+f+(this.isMobile?18:15))}}showTravelNotification(e){const t=document.createElement("div");t.style.position="fixed",t.style.top=this.isMobile?"30%":"20%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="#30cfd0",t.style.padding=this.isMobile?"15px 30px":"20px 40px",t.style.borderRadius="10px",t.style.border="2px solid #30cfd0",t.style.boxShadow="0 0 30px #30cfd0",t.style.fontFamily="Courier New, monospace",t.style.fontSize=this.isMobile?"18px":"20px",t.style.fontWeight="bold",t.style.zIndex="9999",t.style.textAlign="center",t.textContent=`ARRIVED AT ${e}`,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 1s",setTimeout(()=>{t.remove()},1e3)},3e3)}updateCurrentSystemInfo(){const e=this.starSystemGenerator.getCurrentSystemData();e&&(document.getElementById("current-system-name").textContent=e.name,document.getElementById("current-system-class").textContent=`Class ${e.starClass} - ${e.classification}`,document.getElementById("current-iron-indicator").style.width=`${e.resourceMultipliers.iron*50}%`,document.getElementById("current-gold-indicator").style.width=`${e.resourceMultipliers.gold*50}%`,document.getElementById("current-platinum-indicator").style.width=`${e.resourceMultipliers.platinum*50}%`,document.getElementById("current-system-description").textContent=e.description,document.getElementById("current-system-features").textContent=`Special Features: ${e.specialFeatures.join(", ")}`)}show(){this.updateCurrentSystemInfo(),this.updateCanvas(),this.selectSystem(null),this.isMobile&&window.game&&window.game.audio&&setTimeout(()=>{console.log("Mobile: Attempting to play initial sound in StarMap"),window.game.audio.playSound("boink")},100);const e=document.getElementById("star-map");e&&(e.style.display="block",this.isVisible=!0)}hide(){const e=document.getElementById("star-map");if(e)if(e.style.display="none",this.isVisible=!1,this.stargateInterface)this.stargateInterface.showStargateUI();else if(window.game&&window.game.ui&&window.game.ui.stargateInterface)window.game.ui.stargateInterface.showStargateUI();else{const t=document.getElementById("stargate-ui");t&&(t.style.display="block")}}toggle(){this.isVisible?this.hide():this.show()}}class Yi{constructor(e,t,s){this.scene=e,this.spaceship=t,this.audio=s,this.isMobile=ye.isMobile(),console.log("BlackjackGame constructor - spaceship:",this.spaceship),console.log("BlackjackGame constructor - cargo:",this.spaceship?this.spaceship.cargo:null),console.log("BlackjackGame constructor - isMobile:",this.isMobile),this.gameActive=!1,this.currentBet={resource:null,amount:0},this.playerHand=[],this.dealerHand=[],this.deck=[],this.gameResult=null,this.cardSymbols={spades:"♠",hearts:"♥",clubs:"♣",diamonds:"♦"},this.dealerPhrases={win:["Yarr! The cosmos favors ye today!","By the stars! Ye've bested me!","Void take me! Ye've got luck in yer tanks!","Stellar victory, spacer!","Blast me thrusters! Ye win this round!"],lose:["The black hole claims another victim!","Better luck in the next galaxy, rookie!","Space is cold, and so is defeat!","Yarr! The dealer always wins, spacer!","Back to the asteroid mines with ye!"],blackjack:["SUPERNOVA! A cosmic blackjack!","By the void! A perfect 21!","The stars aligned for ye today!","Quantum perfection! A blackjack!"],push:["A cosmic stalemate, eh?","The universe remains in balance.","Neither winner nor loser in the void.","We split the cosmic dust this time."]},this.gameUI=null}init(){this.gameUI||this.createGameUI()}createGameUI(){this.gameUI=document.createElement("div"),this.gameUI.id="blackjack-game",this.gameUI.style.position="absolute",this.gameUI.style.top="50%",this.gameUI.style.left="50%",this.gameUI.style.transform="translate(-50%, -50%)",this.isMobile?(this.gameUI.style.width="95%",this.gameUI.style.maxWidth="600px",this.gameUI.style.height="auto",this.gameUI.style.maxHeight="85vh"):(this.gameUI.style.width="900px",this.gameUI.style.height="650px"),this.gameUI.style.backgroundColor="rgba(6, 22, 31, 0.85)",this.gameUI.style.backdropFilter="blur(10px)",this.gameUI.style.border="2px solid #33aaff",this.gameUI.style.borderRadius="15px",this.gameUI.style.boxShadow="0 0 30px rgba(51, 170, 255, 0.5)",this.gameUI.style.padding=this.isMobile?"15px":"25px",this.gameUI.style.zIndex="1000",this.gameUI.style.display="none",this.gameUI.style.fontFamily="Courier New, monospace",this.gameUI.style.color="#fff",this.gameUI.style.userSelect="none",this.gameUI.style.overflowY=this.isMobile?"auto":"hidden",this.isMobile&&(this.gameUI.style.webkitOverflowScrolling="touch",this.gameUI.style.touchAction="pan-y",this.gameUI.style.overscrollBehavior="contain");const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundImage="linear-gradient(transparent 50%, rgba(0, 0, 0, 0.1) 50%)",e.style.backgroundSize="100% 4px",e.style.pointerEvents="none",e.style.zIndex="1001",e.style.opacity="0.15",this.gameUI.appendChild(e);const t=document.createElement("div");t.style.textAlign="center",t.style.marginBottom="20px",t.style.position="relative";const s=document.createElement("h2");s.textContent="STELLAR BLACKJACK",s.style.color="#30cfd0",s.style.textShadow="0 0 10px rgba(48, 207, 208, 0.7)",s.style.margin="0 0 5px 0",s.style.fontSize=this.isMobile?"24px":"32px",t.appendChild(s);const i=document.createElement("div");i.textContent="WAGER RESOURCES • WIN BIG • BEAT THE DEALER",i.style.color="rgba(255, 255, 255, 0.6)",i.style.fontSize=this.isMobile?"12px":"14px",i.style.letterSpacing="2px",t.appendChild(i);const o=document.createElement("button");o.textContent="×",o.style.position="absolute",o.style.top="0",o.style.right="0",o.style.backgroundColor="transparent",o.style.border="none",o.style.color="#33aaff",o.style.fontSize="32px",o.style.cursor="pointer",o.style.outline="none",o.style.padding="0 10px",o.style.lineHeight="1",o.onclick=()=>this.hide(),this.isMobile&&(o.style.fontSize="42px",o.style.padding="5px 15px",o.style.backgroundColor="rgba(0, 0, 0, 0.3)",o.style.borderRadius="50%",o.style.width="50px",o.style.height="50px",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.boxShadow="0 0 10px rgba(51, 170, 255, 0.5)",o.style.right="5px",o.style.top="5px"),t.appendChild(o),this.gameUI.appendChild(t);const n=document.createElement("div");n.style.display="flex",n.style.flexDirection="column",n.style.height=this.isMobile?"auto":"calc(100% - 80px)";const a=document.createElement("div");a.style.flex="1",a.style.border="1px solid rgba(51, 170, 255, 0.3)",a.style.borderRadius="8px",a.style.padding="15px",a.style.marginBottom="15px",a.style.position="relative",a.style.background="linear-gradient(to bottom, rgba(9, 30, 42, 0.6), rgba(9, 30, 42, 0.4))";const r=document.createElement("div");r.className="dealer-header",r.style.display="flex",r.style.justifyContent="space-between",r.style.marginBottom="10px";const l=document.createElement("div");l.textContent="DEALER",l.style.color="#33aaff",l.style.fontWeight="bold",r.appendChild(l);const c=document.createElement("div");c.id="dealer-score",c.textContent="0",c.style.color="#fff",c.style.fontWeight="bold",c.style.backgroundColor="rgba(51, 170, 255, 0.2)",c.style.padding="0 10px",c.style.borderRadius="4px",r.appendChild(c),a.appendChild(r);const d=document.createElement("div");d.id="dealer-cards",d.style.display="flex",d.style.gap="15px",d.style.flexWrap="wrap",d.style.height=this.isMobile?"auto":"130px",d.style.minHeight=this.isMobile?"120px":"130px",a.appendChild(d);const h=document.createElement("div");h.id="dealer-speech",h.style.position=this.isMobile?"relative":"absolute",h.style.bottom=this.isMobile?"auto":"15px",h.style.right=this.isMobile?"auto":"15px",h.style.marginTop=this.isMobile?"10px":"0",h.style.backgroundColor="rgba(15, 40, 55, 0.9)",h.style.border="1px solid #33aaff",h.style.borderRadius="8px",h.style.padding="10px 15px",h.style.maxWidth=this.isMobile?"100%":"300px",h.style.fontStyle="italic",h.style.color="#fff",h.style.boxShadow="0 0 10px rgba(51, 170, 255, 0.3)",h.style.display="none",a.appendChild(h),n.appendChild(a);const u=document.createElement("div");u.style.height="60px",u.style.display="flex",u.style.justifyContent="center",u.style.alignItems="center",u.style.marginBottom="15px";const m=document.createElement("div");m.id="game-status",m.style.padding="8px 20px",m.style.borderRadius="20px",m.style.backgroundColor="rgba(51, 170, 255, 0.2)",m.style.border="1px solid rgba(51, 170, 255, 0.4)",m.style.color="#fff",m.style.textAlign="center",m.style.fontWeight="bold",m.style.letterSpacing="1px",m.style.fontSize=this.isMobile?"12px":"14px",m.style.width=this.isMobile?"100%":"auto",m.textContent="PLACE YOUR BET TO BEGIN",u.appendChild(m),n.appendChild(u);const f=document.createElement("div");f.style.flex="1",f.style.border="1px solid rgba(51, 170, 255, 0.3)",f.style.borderRadius="8px",f.style.padding="15px",f.style.marginBottom="15px",f.style.background="linear-gradient(to bottom, rgba(9, 30, 42, 0.4), rgba(9, 30, 42, 0.6))";const g=document.createElement("div");g.className="player-header",g.style.display="flex",g.style.justifyContent="space-between",g.style.marginBottom="10px";const b=document.createElement("div");b.textContent="YOUR HAND",b.style.color="#30cfd0",b.style.fontWeight="bold",g.appendChild(b);const w=document.createElement("div");w.id="player-score",w.textContent="0",w.style.color="#fff",w.style.fontWeight="bold",w.style.backgroundColor="rgba(48, 207, 208, 0.2)",w.style.padding="0 10px",w.style.borderRadius="4px",g.appendChild(w),f.appendChild(g);const v=document.createElement("div");v.id="player-cards",v.style.display="flex",v.style.gap="15px",v.style.flexWrap="wrap",v.style.height=this.isMobile?"auto":"130px",v.style.minHeight=this.isMobile?"120px":"130px",f.appendChild(v),n.appendChild(f);const x=document.createElement("div");x.style.display="flex",x.style.justifyContent="space-between",x.style.alignItems="center",x.style.height="auto",x.style.flexDirection=this.isMobile?"column":"row",x.style.gap=this.isMobile?"15px":"0";const S=document.createElement("div");S.id="betting-controls",S.style.display="flex",S.style.flexDirection="column",S.style.width=this.isMobile?"100%":"250px";const M=document.createElement("div");M.textContent="PLACE YOUR BET",M.style.marginBottom="10px",M.style.color="rgba(255, 255, 255, 0.8)",M.style.fontWeight="bold",S.appendChild(M);const A=document.createElement("div");A.style.display="flex",A.style.gap="10px";const P=(N,k)=>{const T=document.createElement("button");T.className="resource-btn",T.dataset.resource=N,T.style.flex="1",T.style.padding=this.isMobile?"10px 5px":"8px 5px",T.style.backgroundColor="rgba(15, 40, 55, 0.8)",T.style.border=`1px solid ${k}`,T.style.borderRadius="5px",T.style.color="#fff",T.style.boxShadow=`0 0 10px rgba(${k.split("(")[1].split(")")[0]}, 0.3)`,T.style.cursor="pointer",T.style.display="flex",T.style.flexDirection="column",T.style.alignItems="center",T.style.transition="background-color 0.2s, box-shadow 0.2s";const W=document.createElement("span");W.textContent=N.toUpperCase(),W.style.fontWeight="bold",W.style.fontSize="12px",T.appendChild(W);const J=document.createElement("span");J.className=`${N}-amount`,J.textContent="0 UNITS",J.style.fontSize="10px",J.style.marginTop="3px",J.style.opacity="0.7",T.appendChild(J);const Fe=()=>{T.style.backgroundColor="rgba(25, 60, 80, 0.8)",T.style.boxShadow=`0 0 15px ${k}`},lt=()=>{T.style.backgroundColor="rgba(15, 40, 55, 0.8)",T.style.boxShadow=`0 0 10px rgba(${k.split("(")[1].split(")")[0]}, 0.3)`};T.addEventListener("mouseover",Fe),T.addEventListener("mouseout",lt),T.addEventListener("touchstart",Fe,{passive:!0}),T.addEventListener("touchend",lt,{passive:!0});const ct=()=>{this.gameActive||(this.selectBetResource(N),this.audio.playSound("boink"),document.querySelectorAll(".resource-btn").forEach($e=>{$e.style.borderWidth="1px",$e.style.transform="scale(1)"}),T.style.borderWidth="2px",T.style.transform="scale(1.05)")};return T.addEventListener("click",ct),T.addEventListener("touchend",$e=>{$e.preventDefault(),ct()}),T};A.appendChild(P("iron","rgba(150, 150, 150, 1)")),A.appendChild(P("gold","rgba(255, 215, 0, 1)")),A.appendChild(P("platinum","rgba(229, 228, 226, 1)")),S.appendChild(A);const D=document.createElement("div");D.style.display="flex",D.style.marginTop="10px",D.style.gap="10px";const L=document.createElement("div");L.id="bet-amount",L.textContent="0",L.style.flex="1",L.style.backgroundColor="rgba(15, 40, 55, 0.8)",L.style.border="1px solid rgba(51, 170, 255, 0.5)",L.style.borderRadius="5px",L.style.padding="8px 10px",L.style.textAlign="center",L.style.fontWeight="bold",D.appendChild(L);const re=(N,k)=>{const T=document.createElement("button");T.textContent=N,T.style.width=this.isMobile?"50px":"40px",T.style.height=this.isMobile?"40px":"auto",T.style.backgroundColor="rgba(15, 40, 55, 0.8)",T.style.border="1px solid rgba(51, 170, 255, 0.5)",T.style.borderRadius="5px",T.style.color="#fff",T.style.cursor="pointer",T.style.fontSize=this.isMobile?"20px":"16px";const W=()=>{T.style.backgroundColor="rgba(25, 60, 80, 0.8)",T.style.boxShadow="0 0 10px rgba(51, 170, 255, 0.3)"},J=()=>{T.style.backgroundColor="rgba(15, 40, 55, 0.8)",T.style.boxShadow="none"};return T.addEventListener("mouseover",W),T.addEventListener("mouseout",J),T.addEventListener("touchstart",W,{passive:!0}),T.addEventListener("touchend",J,{passive:!0}),T.addEventListener("click",k),T.addEventListener("touchend",Fe=>{Fe.preventDefault(),k()}),T},ie=re("-",()=>{!this.gameActive&&this.currentBet.resource&&(this.decreaseBet(),this.audio.playSound("boink"))});D.appendChild(ie);const de=re("+",()=>{!this.gameActive&&this.currentBet.resource&&(this.increaseBet(),this.audio.playSound("boink"))});D.appendChild(de),S.appendChild(D),x.appendChild(S);const U=document.createElement("div");U.style.display="flex",U.style.gap="15px",U.style.flexWrap=this.isMobile?"wrap":"nowrap",U.style.justifyContent=this.isMobile?"center":"flex-end",U.style.width=this.isMobile?"100%":"auto",[{id:"deal-btn",text:"DEAL",color:"#30cfd0",handler:()=>this.startGame()},{id:"hit-btn",text:"HIT",color:"#ff9e3d",handler:()=>this.hit()},{id:"stand-btn",text:"STAND",color:"#e55c8a",handler:()=>this.stand()},{id:"double-btn",text:"DOUBLE",color:"#a281ff",handler:()=>this.doubleDown()}].forEach(N=>{const k=document.createElement("button");k.id=N.id,k.textContent=N.text,k.style.padding=this.isMobile?"15px 20px":"12px 18px",k.style.backgroundColor="rgba(15, 40, 55, 0.8)",k.style.border=`2px solid ${N.color}`,k.style.borderRadius="5px",k.style.color="#fff",k.style.fontWeight="bold",k.style.cursor="pointer",k.style.boxShadow=`0 0 10px ${N.color}`,k.style.transition="all 0.2s",k.style.minWidth=this.isMobile?"80px":"auto",k.style.flex=this.isMobile?"1":"none",k.disabled=!0,k.style.opacity="0.5";const T=()=>{k.disabled||(k.style.backgroundColor="rgba(25, 60, 80, 0.8)",k.style.boxShadow=`0 0 15px ${N.color}`)},W=()=>{k.disabled||(k.style.backgroundColor="rgba(15, 40, 55, 0.8)",k.style.boxShadow=`0 0 10px ${N.color}`)};k.addEventListener("mouseover",T),k.addEventListener("mouseout",W),k.addEventListener("touchstart",T,{passive:!0}),k.addEventListener("touchend",W,{passive:!0}),k.addEventListener("click",()=>{k.disabled||(N.handler(),this.audio.playSound("boink"))}),k.addEventListener("touchend",J=>{k.disabled||(J.preventDefault(),N.handler(),this.audio.playSound("boink"))}),U.appendChild(k)}),x.appendChild(U),n.appendChild(x),this.gameUI.appendChild(n),document.body.appendChild(this.gameUI),this.updateControls()}show(){if(window.game&&window.game.introSequenceActive){console.log("BlackjackGame: Not showing game UI during intro sequence");return}if(this.gameUI){if(this.gameUI.style.display="block",this.reset(),this.audio&&this.isMobile&&setTimeout(()=>{console.log("Mobile: Attempting to play initial sound in BlackjackGame"),this.audio.playSound("boink")},100),window.game&&window.game.controls&&window.game.controls.resources){console.log("Syncing blackjack with game resources");const e=window.game.controls.resources;this.spaceship.cargo||(this.spaceship.cargo={}),this.spaceship.cargo.iron=e.iron||0,this.spaceship.cargo.gold=e.gold||0,this.spaceship.cargo.platinum=e.platinum||0,console.log("Synced resources:",this.spaceship.cargo)}else console.log("Game resources not available, using stored values");this.updateResourceDisplay(),this.audio.playSound("boink")}else this.init(),this.show()}hide(){if(this.gameUI){this.gameUI.style.display="none",this.audio.playSound("boink");const e=document.getElementById("stargate-ui");e&&(e.style.display="block")}}reset(){this.gameActive=!1,this.playerHand=[],this.dealerHand=[],this.currentBet={resource:null,amount:0},this.gameResult=null,document.getElementById("player-cards").innerHTML="",document.getElementById("dealer-cards").innerHTML="",document.getElementById("player-score").textContent="0",document.getElementById("dealer-score").textContent="0",document.getElementById("game-status").textContent="PLACE YOUR BET TO BEGIN",document.getElementById("dealer-speech").style.display="none",document.getElementById("bet-amount").textContent="0",document.querySelectorAll(".resource-btn").forEach(e=>{e.style.borderWidth="1px",e.style.transform="scale(1)"}),this.updateControls()}createDeck(){const e=["hearts","diamonds","clubs","spades"],t=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];this.deck=[];for(let s of e)for(let i of t)this.deck.push({suit:s,value:i});for(let s=this.deck.length-1;s>0;s--){const i=Math.floor(Math.random()*(s+1));[this.deck[s],this.deck[i]]=[this.deck[i],this.deck[s]]}}getCardValue(e){return e.value==="A"?11:["J","Q","K"].includes(e.value)?10:parseInt(e.value)}calculateScore(e){let t=0,s=0;for(let i of e)i.value==="A"?(s++,t+=11):["J","Q","K"].includes(i.value)?t+=10:t+=parseInt(i.value);for(;t>21&&s>0;)t-=10,s--;return t}drawCard(){return this.deck.length===0&&this.createDeck(),this.deck.pop()}createCardElement(e,t=!1){const s=document.createElement("div");if(s.className="card",this.isMobile?(s.style.width="70px",s.style.height="105px",s.style.fontSize="80%"):(s.style.width="100px",s.style.height="150px"),s.style.backgroundColor=t?"rgba(9, 30, 42, 0.8)":"rgba(15, 35, 50, 0.9)",s.style.border=t?"2px solid rgba(51, 170, 255, 0.3)":"2px solid rgba(51, 170, 255, 0.7)",s.style.borderRadius="10px",s.style.boxShadow=t?"0 0 5px rgba(51, 170, 255, 0.3)":"0 0 10px rgba(51, 170, 255, 0.5)",s.style.position="relative",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.overflow="hidden",s.style.transition="transform 0.3s ease",t){const i=document.createElement("div");i.style.width="80%",i.style.height="80%",i.style.border="2px solid rgba(51, 170, 255, 0.4)",i.style.borderRadius="5px",i.style.backgroundImage="radial-gradient(circle, rgba(51, 170, 255, 0.2) 10%, transparent 10%)",i.style.backgroundSize="10px 10px",s.appendChild(i);const o=document.createElement("div");o.style.position="absolute",o.style.fontWeight="bold",o.style.fontSize=this.isMobile?"12px":"14px",o.style.color="rgba(51, 170, 255, 0.7)",o.textContent="BJ",s.appendChild(o)}else{const i=document.createElement("div");i.style.position="absolute",i.style.top="8px",i.style.left="8px",i.style.fontSize=this.isMobile?"14px":"20px",i.style.fontWeight="bold",i.textContent=e.value,i.style.color=["hearts","diamonds"].includes(e.suit)?"#e55c8a":"#30cfd0",s.appendChild(i);const o=document.createElement("div");o.style.position="absolute",o.style.top="8px",o.style.right="8px",o.style.fontSize=this.isMobile?"12px":"16px",o.textContent=this.cardSymbols[e.suit],o.style.color=["hearts","diamonds"].includes(e.suit)?"#e55c8a":"#30cfd0",s.appendChild(o);const n=document.createElement("div");n.style.fontSize=this.isMobile?"28px":"40px",n.style.lineHeight="1",n.style.opacity="0.9",n.textContent=this.cardSymbols[e.suit],n.style.color=["hearts","diamonds"].includes(e.suit)?"#e55c8a":"#30cfd0",s.appendChild(n);const a=document.createElement("div");a.style.position="absolute",a.style.bottom="8px",a.style.right="8px",a.style.fontSize=this.isMobile?"14px":"20px",a.style.fontWeight="bold",a.style.transform="rotate(180deg)",a.textContent=e.value,a.style.color=["hearts","diamonds"].includes(e.suit)?"#e55c8a":"#30cfd0",s.appendChild(a);const r=document.createElement("div");r.style.position="absolute",r.style.bottom="8px",r.style.left="8px",r.style.fontSize=this.isMobile?"12px":"16px",r.style.transform="rotate(180deg)",r.textContent=this.cardSymbols[e.suit],r.style.color=["hearts","diamonds"].includes(e.suit)?"#e55c8a":"#30cfd0",s.appendChild(r);const l=document.createElement("div");l.style.position="absolute",l.style.inset="0",l.style.opacity="0.05",l.style.backgroundImage="radial-gradient(circle, #fff 1px, transparent 1px)",l.style.backgroundSize="10px 10px",l.style.pointerEvents="none",s.appendChild(l);const c=document.createElement("div");c.style.position="absolute",c.style.inset="0",c.style.background="linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%)",c.style.pointerEvents="none",s.appendChild(c)}return s}selectBetResource(e){this.currentBet.resource=e,this.currentBet.amount=1,document.getElementById("bet-amount").textContent=this.currentBet.amount,this.updateControls()}increaseBet(){const e=this.getMaxBet();this.currentBet.amount<e&&(this.currentBet.amount++,document.getElementById("bet-amount").textContent=this.currentBet.amount)}decreaseBet(){this.currentBet.amount>1&&(this.currentBet.amount--,document.getElementById("bet-amount").textContent=this.currentBet.amount)}getMaxBet(){return!this.currentBet.resource||!this.spaceship.cargo?0:this.spaceship.cargo[this.currentBet.resource]||0}updateControls(){const e=document.getElementById("deal-btn"),t=document.getElementById("hit-btn"),s=document.getElementById("stand-btn"),i=document.getElementById("double-btn");if([e,t,s,i].forEach(o=>{o.disabled=!0,o.style.opacity="0.5",o.style.cursor="default"}),this.gameActive){t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer",s.disabled=!1,s.style.opacity="1",s.style.cursor="pointer";const o=this.playerHand.length===2&&this.currentBet.amount*2<=this.getMaxBet();i.disabled=!o,i.style.opacity=o?"1":"0.5",i.style.cursor=o?"pointer":"default"}else{const o=this.currentBet.resource&&this.currentBet.amount>0;e.disabled=!o,e.style.opacity=o?"1":"0.5",e.style.cursor=o?"pointer":"default"}}updateResourceDisplay(){if(console.log("Updating resource display, spaceship:",this.spaceship),console.log("Cargo:",this.spaceship?this.spaceship.cargo:null),this.spaceship&&this.spaceship.cargo){this.spaceship.cargo.iron===void 0&&(this.spaceship.cargo.iron=0),this.spaceship.cargo.gold===void 0&&(this.spaceship.cargo.gold=0),this.spaceship.cargo.platinum===void 0&&(this.spaceship.cargo.platinum=0);const e=document.querySelector(".iron-amount");e&&(e.textContent=`${this.spaceship.cargo.iron} UNITS`);const t=document.querySelector(".gold-amount");t&&(t.textContent=`${this.spaceship.cargo.gold} UNITS`);const s=document.querySelector(".platinum-amount");s&&(s.textContent=`${this.spaceship.cargo.platinum} UNITS`)}else console.error("Cannot update resource display: spaceship or cargo is undefined")}startGame(){if(console.log("Starting game with bet:",this.currentBet),console.log("Spaceship:",this.spaceship),console.log("Cargo:",this.spaceship?this.spaceship.cargo:null),!this.currentBet.resource||this.currentBet.amount<=0){console.log("No bet resource or amount selected");return}if(!this.spaceship){console.error("No spaceship object available"),document.getElementById("game-status").textContent="ERROR: GAME DATA MISSING";return}if(this.spaceship.cargo||(console.warn("Creating cargo object for spaceship"),this.spaceship.cargo={iron:0,gold:0,platinum:0}),this.spaceship.cargo[this.currentBet.resource]===void 0&&(this.spaceship.cargo[this.currentBet.resource]=0),this.spaceship.cargo[this.currentBet.resource]<this.currentBet.amount){document.getElementById("game-status").textContent="NOT ENOUGH RESOURCES";return}this.spaceship.cargo[this.currentBet.resource]-=this.currentBet.amount,this.updateResourceDisplay(),window.game&&window.game.controls&&window.game.controls.resources&&(window.game.controls.resources[this.currentBet.resource]=this.spaceship.cargo[this.currentBet.resource],console.log("Updated game resources after bet:",window.game.controls.resources)),this.createDeck(),this.playerHand=[],this.dealerHand=[],document.getElementById("player-cards").innerHTML="",document.getElementById("dealer-cards").innerHTML="",this.gameActive=!0,this.dealCardToPlayer(),this.dealCardToPlayer(),this.dealCardToDealer(),this.dealCardToDealer(!0),this.checkForNaturalBlackjack(),document.getElementById("game-status").textContent="YOUR MOVE",this.updateControls(),this.playCardSound("deal")}dealCardToPlayer(){const e=this.drawCard();this.playerHand.push(e);const t=this.createCardElement(e);document.getElementById("player-cards").appendChild(t),setTimeout(()=>{t.style.transform="translateY(-5px)"},50);const s=this.calculateScore(this.playerHand);document.getElementById("player-score").textContent=s,s>21&&this.playerBust()}dealCardToDealer(e=!1){const t=this.drawCard();this.dealerHand.push(t);const s=this.createCardElement(t,e);if(s.id=e?"face-down-card":"",document.getElementById("dealer-cards").appendChild(s),setTimeout(()=>{s.style.transform="translateY(-5px)"},50),!e){const i=this.calculateVisibleDealerScore();document.getElementById("dealer-score").textContent=i}}calculateVisibleDealerScore(){return this.dealerHand.length<=1?this.dealerHand.length?this.getCardValue(this.dealerHand[0]):0:this.calculateScore(this.dealerHand.slice(0,-1))}checkForNaturalBlackjack(){const e=this.calculateScore(this.playerHand),t=this.calculateScore(this.dealerHand);(e===21||t===21)&&(this.revealDealerCard(),e===21&&t===21?this.push():e===21?this.blackjackWin():this.playerLose())}hit(){this.gameActive&&(this.dealCardToPlayer(),this.playCardSound("hit"),this.updateControls())}stand(){this.gameActive&&(this.playCardSound("stand"),this.dealerPlay())}doubleDown(){if(this.gameActive&&this.playerHand.length===2){if(this.spaceship.cargo[this.currentBet.resource]<this.currentBet.amount){document.getElementById("game-status").textContent="NOT ENOUGH RESOURCES FOR DOUBLE DOWN";return}this.spaceship.cargo[this.currentBet.resource]-=this.currentBet.amount,this.currentBet.amount*=2,this.updateResourceDisplay(),window.game&&window.game.controls&&window.game.controls.resources&&(window.game.controls.resources[this.currentBet.resource]=this.spaceship.cargo[this.currentBet.resource],console.log("Updated game resources after double down:",window.game.controls.resources)),this.dealCardToPlayer(),this.calculateScore(this.playerHand)<=21&&this.dealerPlay(),this.playCardSound("double")}}dealerPlay(){this.revealDealerCard();let e=this.calculateScore(this.dealerHand);const t=()=>{e<17?(this.dealCardToDealer(),e=this.calculateScore(this.dealerHand),this.playCardSound("hit"),setTimeout(()=>{t()},800)):this.determineOutcome()};setTimeout(t,800)}revealDealerCard(){const e=document.getElementById("face-down-card");if(e){e.remove();const t=this.dealerHand[this.dealerHand.length-1],s=this.createCardElement(t);document.getElementById("dealer-cards").appendChild(s),setTimeout(()=>{s.style.transform="translateY(-5px)"},50);const i=this.calculateScore(this.dealerHand);document.getElementById("dealer-score").textContent=i,this.playCardSound("flip")}}determineOutcome(){const e=this.calculateScore(this.playerHand),t=this.calculateScore(this.dealerHand);t>21?this.playerWin():e>t?this.playerWin():t>e?this.playerLose():this.push()}playerBust(){this.gameActive=!1,this.gameResult="bust",document.getElementById("game-status").textContent="BUST! YOU LOSE",this.showDealerSpeech("lose"),this.playCardSound("bust"),this.updateControls()}playerWin(){this.gameActive=!1,this.gameResult="win",document.getElementById("game-status").textContent="YOU WIN!",this.showDealerSpeech("win");const e=this.currentBet.amount*2;this.spaceship.cargo[this.currentBet.resource]+=e,this.updateResourceDisplay(),window.game&&window.game.controls&&window.game.controls.resources&&(window.game.controls.resources[this.currentBet.resource]=this.spaceship.cargo[this.currentBet.resource],console.log("Updated game resources after win:",window.game.controls.resources)),this.playCardSound("win"),this.updateControls()}blackjackWin(){this.gameActive=!1,this.gameResult="blackjack",document.getElementById("game-status").textContent="BLACKJACK! TRIPLE PAYOUT!",this.showDealerSpeech("blackjack");const e=this.currentBet.amount*3;this.spaceship.cargo[this.currentBet.resource]+=e,this.updateResourceDisplay(),window.game&&window.game.controls&&window.game.controls.resources&&(window.game.controls.resources[this.currentBet.resource]=this.spaceship.cargo[this.currentBet.resource],console.log("Updated game resources after blackjack:",window.game.controls.resources)),this.playCardSound("blackjack"),this.updateControls()}playerLose(){this.gameActive=!1,this.gameResult="lose",document.getElementById("game-status").textContent="DEALER WINS",this.showDealerSpeech("lose"),this.playCardSound("lose"),this.updateControls()}push(){this.gameActive=!1,this.gameResult="push",document.getElementById("game-status").textContent="PUSH - BETS RETURNED",this.showDealerSpeech("push"),this.spaceship.cargo[this.currentBet.resource]+=this.currentBet.amount,this.updateResourceDisplay(),window.game&&window.game.controls&&window.game.controls.resources&&(window.game.controls.resources[this.currentBet.resource]=this.spaceship.cargo[this.currentBet.resource],console.log("Updated game resources after push:",window.game.controls.resources)),this.playCardSound("push"),this.updateControls()}showDealerSpeech(e){const t=document.getElementById("dealer-speech"),s=this.dealerPhrases[e];if(s&&s.length>0){const i=s[Math.floor(Math.random()*s.length)];t.textContent=i,t.style.display="block",setTimeout(()=>{t.style.display="none"},4e3)}}playCardSound(e){if(this.audio)switch(e){case"deal":this.audio.playSound("boink");break;case"hit":this.audio.playSound("boink");break;case"stand":this.audio.playSound("boink");break;case"double":this.audio.playSound("boink"),setTimeout(()=>this.audio.playSound("boink"),150);break;case"flip":this.audio.playSound("boink");break;case"win":this.audio.playSound("phaserUp");break;case"blackjack":this.audio.playSound("phaserUp"),setTimeout(()=>this.audio.playSound("phaserUp"),300);break;case"lose":this.audio.playSound("phaserDown");break;case"bust":this.audio.playSound("phaserDown");break;case"push":this.audio.playSound("boink");break}}}class Qi{constructor(e){this.game=e,this.stargateInterface=null,this.isVisible=!1,this.isMobile=ye.isMobile(),console.log("Settings constructor - isMobile:",this.isMobile),this.detectMonitorRefreshRate(),this.settings={graphicalQuality:"medium",postProcessing:!0,asteroidDetail:"medium",lightingQuality:"medium",particleEffects:"medium",resolutionScale:"medium",frameRateCap:"auto",showFPS:!1,spatialAudio:!0,autoQuality:!0,godRaysEnabled:!1,godRaysType:"standard"},this.loadSettings(),this.setupSettingsUI(),this.applyAllSettings(),setTimeout(()=>this.applyUISettings(),100)}setStargateInterface(e){this.stargateInterface=e}loadSettings(){try{const e=localStorage.getItem("asteroidMinerSettings");if(e){const t=JSON.parse(e);this.settings={...this.settings,...t},console.log("Settings loaded from localStorage:",this.settings)}}catch(e){console.error("Error loading settings:",e)}}saveSettings(){try{localStorage.setItem("asteroidMinerSettings",JSON.stringify(this.settings)),console.log("Settings saved to localStorage")}catch(e){console.error("Error saving settings:",e)}}setupSettingsUI(){const e=document.createElement("div");e.id="settings-container",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",this.isMobile?(e.style.width="95%",e.style.maxWidth="600px",e.style.height="90vh"):(e.style.width="700px",e.style.maxHeight="90vh"),e.style.overflowY="auto",e.style.backgroundColor="rgba(20, 30, 50, 0.9)",e.style.color="#fff",e.style.padding=this.isMobile?"20px":"30px",e.style.borderRadius="15px",e.style.border="2px solid #33aaff",e.style.boxShadow="0 0 30px #33aaff",e.style.fontFamily="Courier New, monospace",e.style.zIndex="1000",e.style.display="none",this.isMobile&&(e.style.webkitOverflowScrolling="touch",e.style.touchAction="pan-y",e.style.overscrollBehavior="contain"),e.innerHTML=`
            <h2 style="text-align: center; color: #33aaff; margin-top: 0; font-size: ${this.isMobile?"24px":"28px"};">GAME SETTINGS</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile?"18px":"20px"};">GRAPHICS SETTINGS</h3>
                
                <!-- Graphical Quality Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Graphical Quality</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Affects overall visual fidelity and performance</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="graphical-quality" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <!-- Post-processing Effects Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Post-processing Effects</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Bloom, anti-aliasing, and visual effects</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%; display: flex; justify-content: flex-end;":""}">
                        <label class="toggle" style="display: inline-block; position: relative; width: ${this.isMobile?"70px":"60px"}; height: ${this.isMobile?"34px":"30px"};">
                            <input type="checkbox" id="post-processing" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile?"17px":"15px"}; transition: .4s;"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Volumetric Light Rays (God Rays) Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Volumetric Light Rays</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Enable sunlight rays effect</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%; display: flex; justify-content: flex-end;":""}">
                        <label class="toggle" style="display: inline-block; position: relative; width: ${this.isMobile?"70px":"60px"}; height: ${this.isMobile?"34px":"30px"};">
                            <input type="checkbox" id="god-rays-enabled" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile?"17px":"15px"}; transition: .4s;"></span>
                        </label>
                    </div>
                </div>
                
                <!-- God Ray Type Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Light Ray Type</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Choose light ray effect style</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="god-rays-type" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="standard">Standard God Rays</option>
                            <option value="claude">Claude Rays</option>
                        </select>
                    </div>
                </div>
                
                <!-- Asteroid Detail Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Asteroid Detail</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Affects asteroid count and model complexity</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="asteroid-detail" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lighting Quality Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Lighting Quality</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Affects light sources and shadows</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="lighting-quality" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <!-- Particle Effects Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Particle Effects</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Affects thruster, explosion, and other particle effects</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="particle-effects" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                
                <!-- Resolution Scale Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Resolution Scale</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Adjusts rendering resolution</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="resolution-scale" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="low">Low (75%)</option>
                            <option value="medium">Medium (100%)</option>
                            <option value="high">High (125%)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile?"18px":"20px"};">PERFORMANCE SETTINGS</h3>
                
                <!-- Frame Rate Cap Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Frame Rate Cap</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Limits maximum frame rate</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%":""}">
                        <select id="frame-rate-cap" style="background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile?"10px":"8px"}; border-radius: 5px; width: ${this.isMobile?"100%":"auto"}; font-size: ${this.isMobile?"16px":"inherit"};">
                            <option value="30">30 FPS</option>
                            <option value="60">60 FPS</option>
                            <option value="auto">Monitor Refresh Rate (${this.monitorRefreshRate}Hz)</option>
                            <option value="0">Unlimited</option>
                        </select>
                    </div>
                </div>
                
                <!-- Show FPS Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Show FPS Counter</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Display current frame rate</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%; display: flex; justify-content: flex-end;":""}">
                        <label class="toggle" style="display: inline-block; position: relative; width: ${this.isMobile?"70px":"60px"}; height: ${this.isMobile?"34px":"30px"};">
                            <input type="checkbox" id="show-fps" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile?"17px":"15px"}; transition: .4s;"></span>
                        </label>
                    </div>
                </div>
                
                <!-- Auto Quality Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Auto-Adjust Quality</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">Automatically adjusts settings based on performance</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%; display: flex; justify-content: flex-end;":""}">
                        <label class="toggle" style="display: inline-block; position: relative; width: ${this.isMobile?"70px":"60px"}; height: ${this.isMobile?"34px":"30px"};">
                            <input type="checkbox" id="auto-quality" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile?"17px":"15px"}; transition: .4s;"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile?"18px":"20px"};">AUDIO SETTINGS</h3>
                
                <!-- Spatial Audio Setting -->
                <div class="settings-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile?"column":"row"}; align-items: ${this.isMobile?"flex-start":"center"};">
                    <div style="margin-bottom: ${this.isMobile?"8px":"0"}; ${this.isMobile?"width: 100%":""}">
                        <label style="font-weight: bold; font-size: ${this.isMobile?"15px":"inherit"};">Spatial Audio</label>
                        <p style="margin: 5px 0 0 0; font-size: ${this.isMobile?"11px":"12px"}; color: #aaa;">3D positional sound effects</p>
                    </div>
                    <div style="${this.isMobile?"width: 100%; display: flex; justify-content: flex-end;":""}">
                        <label class="toggle" style="display: inline-block; position: relative; width: ${this.isMobile?"70px":"60px"}; height: ${this.isMobile?"34px":"30px"};">
                            <input type="checkbox" id="spatial-audio" style="opacity: 0; width: 0; height: 0;">
                            <span class="slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile?"17px":"15px"}; transition: .4s;"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile?"18px":"20px"};">PRESETS</h3>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-direction: ${this.isMobile?"column":"row"}; gap: ${this.isMobile?"10px":"0"};">
                    <button id="preset-performance" style="flex: 1; margin-right: ${this.isMobile?"0":"10px"}; padding: ${this.isMobile?"15px":"10px"}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile?"16px":"inherit"};">
                        PERFORMANCE
                    </button>
                    <button id="preset-balanced" style="flex: 1; margin-right: ${this.isMobile?"0":"10px"}; padding: ${this.isMobile?"15px":"10px"}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile?"16px":"inherit"};">
                        BALANCED
                    </button>
                    <button id="preset-quality" style="flex: 1; padding: ${this.isMobile?"15px":"10px"}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile?"16px":"inherit"};">
                        QUALITY
                    </button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; flex-direction: ${this.isMobile?"column":"row"}; gap: ${this.isMobile?"15px":"0"};">
                <button id="apply-settings" style="flex: 1; margin-right: ${this.isMobile?"0":"10px"}; padding: ${this.isMobile?"20px":"15px"}; background-color: #33aaff; color: black; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile?"18px":"16px"};">
                    APPLY
                </button>
                <button id="settings-back" style="flex: 1; padding: ${this.isMobile?"20px":"15px"}; background-color: #555; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile?"18px":"16px"};">
                    BACK
                </button>
            </div>
        `;const t=document.createElement("style");t.textContent=`
            .slider:before {
                position: absolute;
                content: "";
                height: ${this.isMobile?"26px":"22px"};
                width: ${this.isMobile?"26px":"22px"};
                left: 4px;
                bottom: 4px;
                background-color: white;
                border-radius: 50%;
                transition: .4s;
            }
            
            input:checked + .slider {
                background-color: #33aaff;
            }
            
            input:checked + .slider:before {
                transform: translateX(${this.isMobile?"36px":"30px"});
            }
        `,document.head.appendChild(t),document.body.appendChild(e),this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("settings-back");e&&(e.addEventListener("click",()=>{this.hide()}),this.isMobile&&e.addEventListener("touchend",s=>{s.preventDefault(),this.hide()}));const t=document.getElementById("apply-settings");if(t){const s=()=>{this.updateSettings(),this.saveSettings(),this.applyAllSettings(),this.showSettingsApplied()};t.addEventListener("click",s),this.isMobile&&t.addEventListener("touchend",i=>{i.preventDefault(),s()})}this.setupPresetButton("preset-performance","performance"),this.setupPresetButton("preset-balanced","balanced"),this.setupPresetButton("preset-quality","quality")}setupPresetButton(e,t){const s=document.getElementById(e);if(!s)return;const i=()=>{this.applyPreset(t)};s.addEventListener("click",i),this.isMobile&&s.addEventListener("touchend",o=>{o.preventDefault(),i()}),this.isMobile?(s.addEventListener("touchstart",()=>{s.style.backgroundColor="#3a4b6a",s.style.boxShadow="0 0 10px #33aaff"},{passive:!0}),s.addEventListener("touchend",()=>{s.style.backgroundColor="#2a3a5a",s.style.boxShadow="none"},{passive:!0})):(s.addEventListener("mouseover",()=>{s.style.backgroundColor="#3a4b6a",s.style.boxShadow="0 0 10px #33aaff"}),s.addEventListener("mouseout",()=>{s.style.backgroundColor="#2a3a5a",s.style.boxShadow="none"}))}updateSettings(){this.settings.graphicalQuality=document.getElementById("graphical-quality").value,this.settings.postProcessing=document.getElementById("post-processing").checked,this.settings.asteroidDetail=document.getElementById("asteroid-detail").value,this.settings.lightingQuality=document.getElementById("lighting-quality").value,this.settings.particleEffects=document.getElementById("particle-effects").value,this.settings.resolutionScale=document.getElementById("resolution-scale").value,this.settings.frameRateCap=document.getElementById("frame-rate-cap").value,this.settings.showFPS=document.getElementById("show-fps").checked,this.settings.spatialAudio=document.getElementById("spatial-audio").checked,this.settings.autoQuality=document.getElementById("auto-quality").checked,this.settings.godRaysEnabled=document.getElementById("god-rays-enabled").checked,this.settings.godRaysType=document.getElementById("god-rays-type").value}updateUI(){document.getElementById("graphical-quality").value=this.settings.graphicalQuality,document.getElementById("post-processing").checked=this.settings.postProcessing,document.getElementById("asteroid-detail").value=this.settings.asteroidDetail,document.getElementById("lighting-quality").value=this.settings.lightingQuality,document.getElementById("particle-effects").value=this.settings.particleEffects,document.getElementById("resolution-scale").value=this.settings.resolutionScale,document.getElementById("frame-rate-cap").value=this.settings.frameRateCap,document.getElementById("show-fps").checked=this.settings.showFPS,document.getElementById("spatial-audio").checked=this.settings.spatialAudio,document.getElementById("auto-quality").checked=this.settings.autoQuality,document.getElementById("god-rays-enabled").checked=this.settings.godRaysEnabled,document.getElementById("god-rays-type").value=this.settings.godRaysType}applyPreset(e){switch(console.log(`Applying ${e} preset`),e){case"performance":this.settings.graphicalQuality="low",this.settings.postProcessing=!1,this.settings.asteroidDetail="low",this.settings.lightingQuality="low",this.settings.particleEffects="low",this.settings.resolutionScale="low",this.settings.frameRateCap=60,this.settings.spatialAudio=!1,this.settings.godRaysEnabled=!1;break;case"balanced":this.settings.graphicalQuality="medium",this.settings.postProcessing=!0,this.settings.asteroidDetail="medium",this.settings.lightingQuality="medium",this.settings.particleEffects="medium",this.settings.resolutionScale="medium",this.settings.frameRateCap="auto",this.settings.spatialAudio=!0,this.settings.godRaysEnabled=!0,this.settings.godRaysType="standard";break;case"quality":this.settings.graphicalQuality="high",this.settings.postProcessing=!0,this.settings.asteroidDetail="high",this.settings.lightingQuality="high",this.settings.particleEffects="high",this.settings.resolutionScale="high",this.settings.frameRateCap=0,this.settings.spatialAudio=!0,this.settings.godRaysEnabled=!0,this.settings.godRaysType="claude";break;default:console.error(`Unknown preset: ${e}`);return}this.updateUI(),this.showSettingsApplied()}applyAllSettings(){this.game&&(this.applyRendererSettings(),this.applyPhysicsSettings(),this.applyEnvironmentSettings(),this.applyAudioSettings(),this.applyUISettings(),console.log("All settings applied successfully"))}applyRendererSettings(){if(!this.game.renderer)return;const e=this.game.renderer;switch(this.settings.graphicalQuality){case"low":e.renderer&&(e.renderer.antialias=!1),e.renderer&&e.renderer.shadowMap&&(e.renderer.shadowMap.enabled=!1);break;case"medium":e.renderer&&(e.renderer.antialias=!0),e.renderer&&e.renderer.shadowMap&&(e.renderer.shadowMap.enabled=!0,e.renderer.shadowMap.type=Ps);break;case"high":e.renderer&&(e.renderer.antialias=!0),e.renderer&&e.renderer.shadowMap&&(e.renderer.shadowMap.enabled=!0,e.renderer.shadowMap.type=_e);break}if(e.composer&&(e.useBasicRendering=!this.settings.postProcessing),e.setRayType){const t=this.settings.godRaysType==="claude";e.setRayType(t)}if(e.setVolumetricLightEnabled&&(e.setVolumetricLightEnabled(this.settings.godRaysEnabled),e.adjustLightingForRayType&&e.adjustLightingForRayType()),e.setVolumetricLightIntensity){let t;switch(this.settings.graphicalQuality){case"low":t=.4;break;case"medium":t=.65;break;case"high":t=.85;break;default:t=.65}e.setVolumetricLightIntensity(t)}if(e.bloomPass)switch(this.settings.graphicalQuality){case"low":e.adjustBloom(.4,.3,.9);break;case"medium":e.adjustBloom(.6,.4,.85);break;case"high":e.adjustBloom(.8,.5,.8);break}if(e.renderer){let t=window.devicePixelRatio||1;switch(this.settings.resolutionScale){case"low":t*=.75;break;case"medium":break;case"high":t*=1.25;break}e.renderer.setPixelRatio(t),e.handleResize()}}applyPhysicsSettings(){if(this.game.physics){const e=this.game.physics;switch(this.settings.asteroidDetail){case"low":e.collisionDistance=10;break;case"medium":e.collisionDistance=15;break;case"high":e.collisionDistance=20;break}}}applyEnvironmentSettings(){if(!this.game.environment)return;const e=this.game.environment;if(e.asteroidBelt&&e.asteroidBelt.updateDensity)switch(this.settings.asteroidDetail){case"low":e.asteroidBelt.updateDensity(.5);break;case"medium":e.asteroidBelt.updateDensity(1);break;case"high":e.asteroidBelt.updateDensity(1.5);break}}applyAudioSettings(){if(!this.game.audio)return;const e=this.game.audio;e.spatialAudio!==void 0&&(e.spatialAudio=this.settings.spatialAudio)}applyUISettings(){const e=document.getElementById("fps-display");if(e?this.settings.showFPS?(e.style.display="block",this.game&&this.game.currentFPS&&(e.textContent=`FPS: ${Math.round(this.game.currentFPS)}`)):e.style.display="none":console.warn("FPS display element not found in HUD. It should have ID 'fps-display'"),this.game){const t=this.game.frameRateCap;this.settings.frameRateCap==="auto"?this.monitorRefreshRate>65?(this.game.frameRateCap=0,console.log(`Using unlimited frame rate (refresh rate ${this.monitorRefreshRate}Hz > 65Hz)`)):(this.game.frameRateCap=this.monitorRefreshRate,console.log(`Setting frame rate cap to monitor refresh rate: ${this.monitorRefreshRate}Hz`)):this.game.frameRateCap=parseInt(this.settings.frameRateCap)||0,(t===0&&this.game.frameRateCap>0||t>0&&this.game.frameRateCap===0)&&(this.game.lastFrameTime=0),console.log(`Frame rate cap changed from ${t} to ${this.game.frameRateCap}`)}}showSettingsApplied(){const e=document.createElement("div");e.style.position="fixed",e.style.top=this.isMobile?"25%":"20%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.color="#33aaff",e.style.padding=this.isMobile?"20px 40px":"15px 30px",e.style.borderRadius="10px",e.style.fontFamily="Courier New, monospace",e.style.fontSize=this.isMobile?"18px":"16px",e.style.zIndex="9999",e.style.textAlign="center",e.textContent="Settings applied and saved",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 0.5s",setTimeout(()=>{e.remove()},500)},1500)}show(){const e=document.getElementById("settings-container");e&&(this.updateUI(),e.style.display="block",this.isVisible=!0)}hide(){const e=document.getElementById("settings-container");e&&(e.style.display="none",this.isVisible=!1,this.stargateInterface&&this.stargateInterface.showStargateUI())}toggle(){this.isVisible?this.hide():this.show()}detectSystemCapabilities(){const e={};e.highDPI=window.devicePixelRatio>1;const s=document.createElement("canvas").getContext("webgl2");if(e.webgl2=!!s,s){const i=s.getExtension("WEBGL_debug_renderer_info");i&&(e.gpu=s.getParameter(i.UNMASKED_RENDERER_WEBGL))}return e.modernBrowser="IntersectionObserver"in window&&"requestAnimationFrame"in window&&"localStorage"in window,e.webgl2&&e.highDPI&&e.modernBrowser?"high":e.webgl2&&e.modernBrowser?"medium":"low"}detectMonitorRefreshRate(){this.monitorRefreshRate=60;try{let e=0,t=performance.now(),s=0;const i=[],o=n=>{if(s){const a=n-s;a>0&&i.push(1e3/a)}if(s=n,e++,n-t<500&&e<60)requestAnimationFrame(o);else{if(i.length>0){i.sort((l,c)=>l-c);const a=i[Math.floor(i.length/2)],r=i.filter(l=>l>=a*.8&&l<=a*1.2);if(r.length>0){const l=r.reduce((d,h)=>d+h,0),c=Math.round(l/r.length);this.monitorRefreshRate=c,console.log(`Detected monitor refresh rate: ${this.monitorRefreshRate}Hz`)}}if(window.screen&&"refresh"in window.screen)try{this.monitorRefreshRate=window.screen.refresh,console.log(`Using screen.refresh value: ${this.monitorRefreshRate}Hz`)}catch(a){console.warn("Error accessing screen.refresh:",a)}}};requestAnimationFrame(o)}catch(e){console.warn("Error detecting refresh rate:",e)}}}class Xi{constructor(e,t){this.game=e,this.ui=t,this.isVisible=!1,this.setupStartScreen()}setupStartScreen(){const e=document.createElement("div");e.id="start-screen",e.className="start-screen",e.style.display="none",e.innerHTML=`
            <div class="start-screen-inner">
                <h1 class="game-title">Solar System Asteroid Miner</h1>
                <div class="button-container">
                    <button id="play-button" class="start-button">Play</button>
                    <button id="how-to-play-button" class="start-button">How to Play</button>
                </div>
                <div class="version">v0.5.8</div>
            </div>
            
            <div id="how-to-play-modal" class="modal">
                <div class="modal-content">
                    <h2>How to Play</h2>
                    
                    <div class="gameplay-section">
                        <h3>Game Overview</h3>
                        <p>Welcome to Solar System Asteroid Miner! Your mission is to mine asteroids, collect resources, and upgrade your ship.</p>
                        
                        <h4>Core Objectives:</h4>
                        <ul>
                            <li><strong>Mining:</strong> Target asteroids (E key), then use your mining laser (R key) to extract resources.</li>
                            <li><strong>Trading:</strong> Dock at stargates (Q key) to sell resources and purchase ship upgrades.</li>
                            <li><strong>Combat:</strong> Defend yourself against enemy ships using your weapons.</li>
                            <li><strong>Exploration:</strong> Travel between star systems through stargates to discover new resources.</li>
                            <li><strong>Anomalies:</strong> Find and collect energy orbs from space anomalies for credits.</li>
                            <li><strong>Defense:</strong> Deploy autonomous laser turrets (T key) to protect mining operations.</li>
                        </ul>
                        
                        <h4>Horde Mode:</h4>
                        <p>Work toward activating the ultimate challenge - Horde Mode:</p>
                        <ul>
                            <li><strong>Endless Survival:</strong> Face waves of increasingly difficult enemies that never stop coming.</li>
                            <li><strong>Escalating Difficulty:</strong> Enemy health, damage, speed, and spawn rates increase over time.</li>
                            <li><strong>Preparation:</strong> Upgrade your ship's weapons, shields, and hull before activating.</li>
                            <li><strong>Strategy:</strong> Deploy multiple laser turrets (T key) around your position to create defensive perimeters.</li>
                            <li><strong>High Score:</strong> How long can you survive as difficulty scales to infinity?</li>
                        </ul>
                    </div>
                    
                    <div class="control-section">
                        <h3>Movement</h3>
                        <div class="control-row"><span class="key">W</span> <span>Forward</span></div>
                        <div class="control-row"><span class="key">S</span> <span>Backward</span></div>
                        <div class="control-row"><span class="key">A</span> <span>Left</span></div>
                        <div class="control-row"><span class="key">D</span> <span>Right</span></div>
                        <div class="control-row"><span class="key">SHIFT</span> <span>Boost</span></div>
                        <div class="control-row"><span class="key">Mouse</span> <span>Ship Rotation</span></div>
                    </div>
                    
                    <div class="control-section">
                        <h3>Combat & Mining</h3>
                        <div class="control-row"><span class="key">LMB</span> <span>Fire Weapons</span></div>
                        <div class="control-row"><span class="key">E</span> <span>Toggle Target Lock-On</span></div>
                        <div class="control-row"><span class="key">R</span> <span>Toggle Mining Laser</span></div>
                        <div class="control-row"><span class="key">TAB</span> <span>Cycle Targets</span></div>
                    </div>
                    
                    <div class="control-section">
                        <h3>Special</h3>
                        <div class="control-row"><span class="key">T</span> <span>Deploy Laser Turret</span></div>
                        <div class="control-row"><span class="key">Q</span> <span>Dock/Undock at Stargate</span></div>
                        <div class="control-row"><span class="key">ESC</span> <span>Pause Game</span></div>
                    </div>
                    
                    <button id="close-how-to-play" class="modal-close-button">Close</button>
                </div>
            </div>
        `,document.body.appendChild(e),this.setupEventListeners()}setupEventListeners(){const e=document.getElementById("play-button");e&&e.addEventListener("click",()=>{this.hide(),localStorage.getItem("introPlayed")==="true"?this.game.startDocked?this.game.startDocked():console.error("Game.startDocked not found"):this.game.startIntroSequence?this.game.startIntroSequence():console.error("Game.startIntroSequence not found")});const t=document.getElementById("how-to-play-button"),s=document.getElementById("how-to-play-modal"),i=document.getElementById("close-how-to-play");t&&s&&t.addEventListener("click",()=>{s.style.display="flex"}),i&&s&&(i.addEventListener("click",()=>{s.style.display="none"}),s.addEventListener("click",o=>{o.target===s&&(s.style.display="none")}))}show(){const e=document.getElementById("start-screen");if(e&&(e.style.display="flex",this.isVisible=!0,window.initialTimestamp)){const t=performance.now()-window.initialTimestamp;console.log(`Time to start screen visible: ${t.toFixed(2)}ms`),console.timeEnd("init")}}hide(){const e=document.getElementById("start-screen");e&&(e.style.display="none",this.isVisible=!1);const t=document.getElementById("how-to-play-modal");t&&(t.style.display="none")}}const Et={float32:[],int32:[],uint32:[],uint16:[],uint8:[]};class Ee{constructor(e){this.data=new Array(e),this.length=0,this.capacity=e}push(e){return this.length<this.capacity?(this.data[this.length++]=e,!0):!1}pop(){if(this.length===0)return;const e=this.data[--this.length];return this.data[this.length]=void 0,e}get(e){if(!(e<0||e>=this.length))return this.data[e]}set(e,t){e<0||e>=this.capacity||(e>=this.length&&(this.length=e+1),this.data[e]=t)}removeAt(e){if(e<0||e>=this.length)return!1;for(let t=e;t<this.length-1;t++)this.data[t]=this.data[t+1];return this.data[--this.length]=void 0,!0}clear(){for(let e=0;e<this.length;e++)this.data[e]=void 0;this.length=0}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t],t,this)}map(e){const t=new Array(this.length);for(let s=0;s<this.length;s++)t[s]=e(this.data[s],s,this);return t}filter(e){const t=[];for(let s=0;s<this.length;s++)e(this.data[s],s,this)&&t.push(this.data[s]);return t}}const Gt={vectorPoolSize:0,objectPoolSizes:{},typedArrayPoolSizes:{},update(){if(window.vectorPool&&(this.vectorPoolSize=window.vectorPool.pool.length),window.objectPool)for(const p in window.objectPool.pools)this.objectPoolSizes[p]=window.objectPool.pools[p].objects.length;for(const p in Et)this.typedArrayPoolSizes[p]=Et[p].length},getReport(){this.update();let p=`Memory Pool Stats:
`;p+=`Vector Pool: ${this.vectorPoolSize} vectors
`,p+=`Object Pools:
`;for(const e in this.objectPoolSizes)p+=`  ${e}: ${this.objectPoolSizes[e]} objects
`;p+=`Typed Array Pools:
`;for(const e in this.typedArrayPoolSizes)p+=`  ${e}: ${this.typedArrayPoolSizes[e]} arrays
`;return p},logReport(){console.log(this.getReport())}};window.MemoryStats=Gt;class vo{constructor(e,t){this.spaceship=e,this.environment=t,this.controls=null,this.audio=null,this.isMobile=ye.isMobile(),console.log(`Initializing UI components for ${this.isMobile?"mobile":"desktop"} device...`),this.isMobile&&this.loadMobileCSS(),this.isMobile?this.hud=new Gi(e):this.hud=new Ni(e),this.miningDisplay=new _i,this.targetingUI=new ji,this.stargateInterface=new Vi,this.gameOverScreen=new Wi,this.controlsMenu=new qi,this.starMap=new Ki(this.environment.starSystemGenerator,null,this.stargateInterface),this.blackjackGame=null,this.settings=null,this.stargateInterface.setStarMap(this.starMap),this.startScreen=null,window.DEBUG_MODE&&this.initializePerformanceMonitor(),console.log("UI components initialized")}loadMobileCSS(){const e=document.createElement("link");e.rel="stylesheet",e.href="css/mobile.css",e.type="text/css",document.head.appendChild(e),console.log("Mobile CSS loaded")}setAudio(e){console.log("Setting audio reference in UI"),this.audio=e,this.audio&&(this.spaceship&&!this.spaceship.cargo&&(this.spaceship.cargo={iron:0,gold:0,platinum:0},console.warn("UI: Created empty cargo object for spaceship")),this.blackjackGame=new Yi(null,this.spaceship,this.audio),console.log("UI: Created BlackjackGame with spaceship:",this.spaceship),this.stargateInterface.setBlackjackGame(this.blackjackGame))}setControls(e){console.log("Setting controls reference in UI"),this.controls=e,this.miningDisplay.setControls&&this.miningDisplay.setControls(this.controls),this.isMobile&&this.hud&&this.hud.setControls&&this.hud.setControls(this.controls),this.starMap&&this.controls.dockingSystem&&(this.starMap.dockingSystem=this.controls.dockingSystem),this.setupEventHandlers()}initializeSettings(e){if(!e){console.error("Cannot initialize settings without game instance");return}this.settings=new Qi(e),this.stargateInterface.setSettings(this.settings),this.startScreen=new Xi(e,this),console.log("Settings and StartScreen initialized with game instance")}setupEventHandlers(){console.log("Setting up UI event handlers"),this.controlsMenu&&this.controlsMenu.setupButtonHandler&&this.controlsMenu.setupButtonHandler(),this.controls&&this.controls.setupStargateUIControls&&this.controls.setupStargateUIControls(),window.mainMessageBus.subscribe("ui.notification",this.handleNotification.bind(this)),window.addEventListener("resize",()=>{const e=this.isMobile;this.isMobile=ye.isMobile(),e!==this.isMobile&&(console.log(`Device type changed from ${e?"mobile":"desktop"} to ${this.isMobile?"mobile":"desktop"}`),location.reload())})}handleNotification(e){if(e&&e.data){const t=e.data.message||"System notification",s=e.data.duration||3e3;this.showNotification(t,s)}}handleGameOver(e){}update(){this.hud&&this.hud.update&&this.hud.update(),this.miningDisplay&&this.miningDisplay.update&&this.miningDisplay.update(),this.isMobile&&this.controls&&this.controls.touchControls&&this.controls.touchControls.update()}updateLocation(e){let t="Unknown System";if(this.environment&&this.environment.starSystemGenerator){const s=this.environment.starSystemGenerator.getCurrentSystemData();t=s?s.name:"Unknown System"}this.hud&&this.hud.updateLocation&&this.hud.updateLocation(null,t)}updateCoordinates(e,t,s){this.hud&&this.hud.updateCoordinates&&this.hud.updateCoordinates(e,t,s)}updateFPS(e,t){if(this.hud&&this.hud.updateFPS&&(this.hud.updateFPS(e,t),this.settings&&this.settings.settings)){const s=document.getElementById("fps-display");s&&(s.style.display=this.settings.settings.showFPS?"block":"none")}}showNotification(e,t=3e3){const s=document.getElementById("notifications-area");if(!s)return;const i=document.createElement("div");i.className="notification",i.textContent=e,i.style.backgroundColor="rgba(6, 22, 31, 0.7)",i.style.backdropFilter="blur(5px)",i.style.color="rgba(120, 220, 232, 0.9)",i.style.padding="8px 15px",i.style.borderRadius="5px",i.style.marginBottom="10px",i.style.border="1px solid rgba(120, 220, 232, 0.3)",i.style.boxShadow="0 0 10px rgba(120, 220, 232, 0.2)",i.style.textAlign="center",i.style.opacity="0",i.style.transition="opacity 0.3s",s.appendChild(i),setTimeout(()=>{i.style.opacity="1"},10),setTimeout(()=>{i.style.opacity="0",setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},t)}showGameOver(e,t){if(console.log("Showing game over screen"),console.log("Resources data:",e),this.gameOverScreen&&this.gameOverScreen.show)document.getElementById("game-over-container")||(console.warn("Game over container not found in DOM, recreating"),this.gameOverScreen.setupGameOverScreen()),this.audio&&(this.gameOverScreen.audio=this.audio),this.gameOverScreen.show(e,t);else{console.error("Game over screen not properly initialized");const s=document.createElement("div");s.id="fallback-overlay",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.backgroundColor="rgba(0, 0, 0, 0.8)",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.zIndex="9999";const i=typeof t=="string"?t:t&&t.data&&t.data.reason?t.data.reason:"Your ship was destroyed!",o=document.createElement("div");o.innerHTML=`
                <h1 style="color: #ff3030; font-size: 48px; margin-bottom: 20px;">GAME OVER</h1>
                <p style="color: #fff; font-size: 24px; margin-bottom: 30px;">${i}</p>
                <button id="restart-btn" style="padding: 15px 30px; background-color: #ff3030; color: #fff; border: none; 
                    font-size: 24px; cursor: pointer; border-radius: 5px;">RESTART GAME</button>
            `,s.appendChild(o),document.body.appendChild(s),document.getElementById("restart-btn").addEventListener("click",()=>{location.reload()})}this.hideUI()}hideUI(){if(console.log("Hiding UI elements"),window.game&&window.game.introSequenceActive){console.log("Intro sequence active - forcing ALL UI elements to be hidden"),[document.getElementById("hud-container"),document.getElementById("mobile-hud-container"),document.getElementById("pointer-lock-instructions"),document.getElementById("notifications-area")].forEach(s=>{s&&(s.style.display="none")}),document.querySelectorAll(".ui-panel, .panel, .hud-panel, .status-panel").forEach(s=>{s.style.display="none"});return}this.hud&&this.hud.hide&&this.hud.hide(),this.miningDisplay&&this.miningDisplay.hide&&this.miningDisplay.hide(),this.targetingUI&&this.targetingUI.hideLockOn&&this.targetingUI.hideLockOn(),this.targetingUI&&this.targetingUI.hideTargetInfo&&this.targetingUI.hideTargetInfo(),this.stargateInterface&&this.stargateInterface.hideDockingPrompt&&this.stargateInterface.hideDockingPrompt(),this.isMobile&&this.controls&&this.controls.touchControls&&this.controls.touchControls.hide()}showUI(){if(console.log("Showing UI elements"),window.game&&window.game.introSequenceActive){console.warn("showUI called while intro is still active - not showing UI elements");return}if(this.startScreen&&this.startScreen.isVisible){console.warn("showUI called while start screen is visible - not showing UI elements");return}if(this.hud&&this.hud.show&&(console.log("Calling hud.show()"),this.hud.show()),this.miningDisplay&&this.miningDisplay.show&&this.miningDisplay.show(),this.isMobile&&this.controls&&this.controls.touchControls&&this.controls.touchControls.show(),window.game&&window.game.introSequenceActive)return;console.log("Forcing all UI elements to be displayed");const e=document.getElementById("hud-container");e?(console.log("Setting hudContainer to display:block"),e.style.display="block",e.style.visibility="visible"):console.warn("HUD container not found - could not make visible");const t=document.getElementById("mobile-hud-container");t&&(t.style.display="block",t.style.visibility="visible");const s=document.getElementById("pointer-lock-instructions");s&&!document.pointerLockElement&&(s.style.display="block",s.style.visibility="visible");const i=document.getElementById("notifications-area");i&&(i.style.display="block",i.style.visibility="visible"),document.querySelectorAll(".ui-panel, .panel, .hud-panel, .status-panel").forEach(n=>{n.style.display="block",n.style.visibility="visible"})}initializePerformanceMonitor(){const e=document.createElement("div");e.id="performance-stats",e.style.position="fixed",e.style.bottom="10px",e.style.right="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="#0ff",e.style.padding="10px",e.style.fontFamily="monospace",e.style.fontSize="12px",e.style.borderRadius="4px",e.style.zIndex="1000",e.style.maxWidth="300px",e.style.maxHeight="200px",e.style.overflow="auto";const t=document.createElement("div");t.id="memory-stats",e.appendChild(t);const s=document.createElement("div");s.id="fps-counter",e.appendChild(s),document.body.appendChild(e),this.statsInterval=setInterval(()=>{t.innerHTML=Gt.getReport().replace(/\n/g,"<br>"),window.game&&window.game.currentFPS&&(s.innerHTML=`FPS: ${Math.round(window.game.currentFPS)}`)},1e3)}onDisabled(){this.statsInterval&&(clearInterval(this.statsInterval),this.statsInterval=null)}}class So{constructor(){this.audioContext=null;try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("Web Audio API context created successfully")}catch(e){console.error("Failed to create Web Audio API context:",e)}this.sounds={},this.soundSources={},this.backgroundMusic=[],this.currentMusicIndex=0,this.currentMusic=null,this.isMuted=!1,this.thrustSound=null,this.music=[],this.musicVolume=.21,this.sfxVolume=.5,this.activeNodes=new Set,this.activeSounds={laser:null,thrust:null,"mining-laser":null},this.userHasInteracted=!1,console.log("Initializing audio manager with Web Audio API..."),this.initializeToneCompatibility(),this.setupUserInteractionListener(),this.setupGarbageCollection()}setupGarbageCollection(){this.gcInterval=setInterval(()=>this.cleanupInactiveNodes(),3e4),console.log("Audio garbage collection scheduled")}cleanupInactiveNodes(){let e=0;this.activeNodes.forEach(t=>{(t._inactive||t.disposed===!0)&&(this.activeNodes.delete(t),e++)}),e>0&&console.log(`Audio manager: cleaned up ${e} inactive audio objects`)}trackNode(e){return e&&this.activeNodes.add(e),e}initializeToneCompatibility(){this.masterEQ={connect:function(e){return e}},console.log("Audio compatibility layer initialized for intro sequence")}async initialize(){try{return console.log("Loading audio files..."),this.audioContext&&this.audioContext.state==="suspended"&&this.resumeAudioContext(),await this.checkSoundDirectories(),await this.preDecodeEssentialSounds(),this.loadBackgroundMusic().catch(e=>{console.error("Error loading background music:",e)}),console.log("Essential audio initialization complete"),this.userHasInteracted?this.playBackgroundMusic():console.log("Music playback waiting for user interaction."),!0}catch(e){return console.error("Error initializing audio:",e),!1}}async preDecodeEssentialSounds(){try{console.log("Pre-decoding essential UI sounds...");const t=[{name:"boink",path:"sounds/effects/boink.wav"},{name:"phaserUp",path:"sounds/effects/phaserUp.wav"},{name:"phaserDown",path:"sounds/effects/phaserDown.wav"}].map(s=>this.loadAndDecodeSound(s.name,this.getPath(s.path)));await Promise.all(t),console.log("Essential UI sounds pre-decoded successfully"),setTimeout(()=>{this.loadGameplaySounds()},1e3)}catch(e){console.error("Error pre-decoding essential sounds:",e),this.createDummySounds()}}async loadGameplaySounds(){try{console.log("Loading gameplay sounds in background...");const e=[{name:"thrust",path:"sounds/effects/thrust.wav"},{name:"laser",path:"sounds/effects/laser.wav"},{name:"mining-laser",path:"sounds/effects/mining-laser.wav"},{name:"explosion",path:"sounds/effects/explosion.wav"}];for(const t of e)try{await this.loadAndDecodeSound(t.name,this.getPath(t.path))}catch(s){console.warn(`Could not load gameplay sound ${t.name}:`,s)}this.sounds.laser&&!this.sounds.projectile&&(console.log("Setting up projectile sound using laser sound buffer"),this.sounds.projectile=this.sounds.laser),console.log("All gameplay sounds loaded successfully")}catch(e){console.error("Error loading gameplay sounds:",e)}}async preDecodeAllSoundEffects(){try{console.log("Using optimized sound loading path instead of preDecodeAllSoundEffects"),await this.preDecodeEssentialSounds(),await this.loadGameplaySounds()}catch(e){console.error("Error pre-decoding sound effects:",e),this.createDummySounds()}}async loadAndDecodeSound(e,t){try{console.log(`Loading and decoding sound: ${e} from ${t}`);const s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch sound ${e}: ${s.status} ${s.statusText}`);const i=await s.arrayBuffer(),o=await this.audioContext.decodeAudioData(i);return this.sounds[e]=o,console.log(`Sound ${e} loaded and decoded successfully`),o}catch(s){throw console.error(`Error loading and decoding sound ${e}:`,s),this.sounds[e]=null,s}}resumeAudioContext(){this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.error("Failed to resume AudioContext:",e)})}async checkSoundDirectories(){return(await this.checkFileExists(this.getPath("sounds"))).exists||console.warn("Sounds directory not found, but will attempt to load files directly anyway."),(await this.checkFileExists(this.getPath("sounds/soundtrack"))).exists||console.warn("Soundtrack directory not found, but will attempt to load files directly anyway."),(await this.checkFileExists(this.getPath("sounds/effects"))).exists||console.warn("Sound effects directory not found. Some sounds may not play correctly."),!0}showDirectoryMissingNotification(e){console.warn(`Directory not found: ${e}`);const t=document.createElement("div");t.style.position="fixed",t.style.top="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="#ff4400",t.style.padding="10px 15px",t.style.borderRadius="5px",t.style.zIndex="9999",t.style.fontSize="14px",t.style.maxWidth="80%",t.style.textAlign="center",t.innerHTML=`
            <div style="margin-bottom: 5px;">
                <strong>Note:</strong> ${e} directory not found.
            </div>
            <div style="font-size: 12px; color: #aaa;">
                Game will continue with limited audio. This is normal when running on GitHub Pages.
            </div>
        `;const s=document.createElement("div");s.style.position="absolute",s.style.top="5px",s.style.right="10px",s.style.cursor="pointer",s.style.color="#aaa",s.textContent="✕",s.addEventListener("click",()=>t.remove()),t.appendChild(s),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&(t.style.opacity="0",t.style.transition="opacity 0.5s ease",setTimeout(()=>{document.body.contains(t)&&t.remove()},500))},5e3)}setupUserInteractionListener(){const e=()=>{this.userHasInteracted||(this.userHasInteracted=!0,console.log("User interaction detected, enabling audio playback"),this.resumeAudioContext(),this.playBackgroundMusic(),document.removeEventListener("click",e),document.removeEventListener("keydown",e),document.removeEventListener("touchstart",e))};if(document.addEventListener("click",e),document.addEventListener("keydown",e),document.addEventListener("touchstart",e),"ontouchstart"in window||navigator.maxTouchPoints>0){console.log("Mobile device detected - adding additional audio handlers");const t=()=>{this.userHasInteracted=!0,this.resumeAudioContext(),this.music.length>0&&!this.muted&&this.music[0].paused&&(console.log("Mobile: Forcing background music playback"),this.playBackgroundMusic())};document.addEventListener("touchend",t,{passive:!0});const s=()=>{let i=0;const o=setInterval(()=>{i++;const n=document.querySelectorAll("button");n.length>0&&(console.log(`Mobile: Found ${n.length} buttons to attach audio handlers`),n.forEach(a=>{a.hasAudioHandler||(a.addEventListener("touchend",t,{passive:!0}),a.hasAudioHandler=!0)})),i>=10&&clearInterval(o)},500)};s(),document.readyState==="complete"?s():window.addEventListener("load",s)}}async loadBackgroundMusic(){try{console.log("Loading soundtrack files...");const e=[this.getPath("sounds/soundtrack/The Sound of Lightyears.wav"),this.getPath("sounds/soundtrack/Aurora Drifts.wav"),this.getPath("sounds/soundtrack/Tidal Lock.wav"),this.getPath("sounds/soundtrack/Solar Drift.wav"),this.getPath("sounds/soundtrack/Orbital Resonance.wav"),this.getPath("sounds/soundtrack/Starlight Trails.wav"),this.getPath("sounds/soundtrack/Orbit Bloom.wav")];console.log(`Loading ${e.length} soundtrack files...`),await this.loadMusicFiles(e)}catch(e){console.error("Error loading background music:",e),console.warn("Falling back to a dummy silent track");const t=new Audio;t.loop=!0,this.music.push(t)}}async checkFileExists(e){console.log(`Checking if file/directory exists: ${e}`);try{const t=await fetch(e,{method:"HEAD",cache:"no-cache"});return console.log(`Fetch response for ${e}: status=${t.status}, ok=${t.ok}`),{path:e,exists:t.ok}}catch(t){return console.error(`Error checking if file exists (${e}):`,t),{path:e,exists:!1}}}getPath(e){return Nt(e)}shuffleArray(e){let t=e.length,s;for(;t>0;)s=Math.floor(Math.random()*t),t--,[e[t],e[s]]=[e[s],e[t]];return e}async loadMusicFiles(e){console.log(`Found ${e.length} music files:`,e);const t=[...e];this.shuffleArray(t),console.log("Randomized playlist order:",t.map(i=>i.split("/").pop()));let s=!1;for(const i of t)if((await this.checkFileExists(i)).exists){s=!0;break}if(!s){console.warn("None of the music files could be found. Using fallback audio."),this.createDummySounds();return}for(const i of t)try{console.log(`Attempting to load audio file: ${i}`);const o=new Audio(i);o.loop=!1,o.volume=this.musicVolume,o.addEventListener("ended",()=>this.playNextTrack()),o.addEventListener("error",n=>{console.error(`Error loading music file ${i}:`,n)}),o.addEventListener("canplaythrough",()=>{console.log(`Successfully loaded music file: ${i}`)}),this.music.push(o),console.log(`Added music track to playlist: ${i}`)}catch(o){console.error(`Failed to load music file ${i}:`,o)}if(console.log(`Loaded ${this.music.length} music tracks in randomized order`),this.music.length===0){console.warn("No music files could be loaded, creating a dummy track");const i=new Audio;i.loop=!0,this.music.push(i)}}createDummySounds(){console.warn("Creating dummy silent AudioBuffers as fallback");const e=["laser","thrust","explosion","boink","phaserUp","phaserDown","mining-laser","projectile"];for(const t of e)if(this.audioContext)try{const s=this.audioContext.createBuffer(2,this.audioContext.sampleRate*.1,this.audioContext.sampleRate);this.sounds[t]=s}catch(s){console.error(`Failed to create dummy buffer for ${t}:`,s),this.sounds[t]=null}else this.sounds[t]=null}playNextTrack(){if(this.music.length===0)return;const e=this.music.shift();this.music.push(e),this.playBackgroundMusic()}playBackgroundMusic(){if(this.music.length===0||this.muted)return;if(!this.userHasInteracted){console.log("Deferring music playback until user interaction");return}const e=this.music[0];console.log(`Starting to play track: ${e.src.split("/").pop()}`),e.currentTime=0;const t=e.play();t!==void 0&&t.then(()=>{console.log("Started playing background music")}).catch(s=>{s.name==="NotAllowedError"?console.log("Autoplay prevented by browser. Music will play after user interaction."):console.error("Error playing background music:",s)})}playSound(e){if(console.log(`Attempting to play sound: ${e}`),this.muted){console.log(`Sound ${e} not played: audio is muted`);return}if(!this.userHasInteracted){console.log(`Sound ${e} not played: waiting for user interaction`);return}if(this.audioContext&&this.audioContext.state==="suspended"&&this.resumeAudioContext(),(e==="weapon"||e==="fire"||e==="shoot")&&(console.log(`Mapping ${e} sound to projectile sound`),e="projectile",!this.sounds.projectile&&this.sounds.laser&&(console.log("Using laser sound for projectile"),this.sounds.projectile=this.sounds.laser)),!this.sounds[e]){console.warn(`Sound "${e}" not found in loaded sounds`);return}try{if(e==="laser"||e==="thrust"||e==="mining-laser"){if(!this.activeSounds[e]){const t=this.audioContext.createBufferSource();t.buffer=this.sounds[e],t.loop=!0;const s=this.audioContext.createGain();s.gain.value=this.sfxVolume*(e==="thrust"?1.5:1),t.connect(s),s.connect(this.audioContext.destination),t.start(0),this.activeSounds[e]={source:t,gain:s},this.trackNode(t),this.trackNode(s)}}else{const t=this.audioContext.createBufferSource();t.buffer=this.sounds[e];const s=this.audioContext.createGain(),i=e==="projectile"?.7:.5;s.gain.value=this.sfxVolume*i,t.connect(s),s.connect(this.audioContext.destination),t.start(0),t.onended=()=>{t._inactive=!0,s._inactive=!0},this.trackNode(t),this.trackNode(s),console.log(`Started playback of one-shot sound: ${e}`)}}catch(t){console.error(`Error playing sound ${e}:`,t)}}stopSound(e){if(this.activeSounds[e])try{if((e==="laser"||e==="thrust"||e==="mining-laser")&&this.activeSounds[e]){const t=this.activeSounds[e];if(t.source){try{t.source.stop()}catch{}t.source._inactive=!0}t.gain&&(t.gain._inactive=!0),this.activeSounds[e]=null}}catch(t){console.error(`Error stopping sound ${e}:`,t)}}setThrustVolume(e){if(!this.activeSounds.thrust||!this.activeSounds.thrust.gain)return;const t=Math.min(1,Math.max(.1,e))*this.sfxVolume*1.5;try{this.activeSounds.thrust.gain.gain.value=t}catch(s){console.error("Error setting thrust volume:",s)}}toggleMute(){this.muted=!this.muted;for(const e of this.music)e.volume=this.muted?0:this.musicVolume;return this.muted&&(this.stopSound("laser"),this.stopSound("thrust"),this.stopSound("mining-laser")),console.log(`Audio ${this.muted?"muted":"unmuted"}`),this.muted}cleanup(){console.log("Cleaning up AudioManager resources..."),this.stopSound("laser"),this.stopSound("thrust"),this.stopSound("mining-laser");for(const e of this.music)e.pause();this.gcInterval&&(clearInterval(this.gcInterval),this.gcInterval=null),this.audioContext&&this.audioContext.close().then(()=>{console.log("AudioContext closed successfully")}).catch(e=>{console.error("Error closing AudioContext:",e)}),document.removeEventListener("click",this.handleInteraction),document.removeEventListener("keydown",this.handleInteraction),document.removeEventListener("touchstart",this.handleInteraction),console.log("AudioManager cleanup complete")}playWeaponSound(){if(console.log("Playing weapon firing sound"),!(this.muted||!this.userHasInteracted)){if(this.audioContext&&this.audioContext.state==="suspended"&&this.resumeAudioContext(),!this.sounds.projectile&&this.sounds.laser&&(console.log("Using laser sound for projectile in playWeaponSound"),this.sounds.projectile=this.sounds.laser),!this.sounds.projectile){console.warn("Projectile sound not found");return}try{const e=this.audioContext.createBufferSource();e.buffer=this.sounds.projectile;const t=this.audioContext.createGain();t.gain.value=this.sfxVolume*.8,e.connect(t),t.connect(this.audioContext.destination),e.start(0),e.onended=()=>{e._inactive=!0,t._inactive=!0},this.trackNode(e),this.trackNode(t),console.log("Weapon sound started playing")}catch(e){console.error("Error playing weapon sound:",e)}}}}class Zi{constructor(e,t){this.id=e,this.world=t,this.components=new Map,this.tags=new Set,this._isEnemy=void 0,this._isPlayer=void 0,this._isProjectile=void 0,this._isPooled=void 0}addComponent(e){return e.entity=this,this.components.set(e.constructor.name,e),e.onAttached&&e.onAttached(),this.world&&this.world.messageBus&&this.world.messageBus.publish("component.added",{entity:this,componentType:e.constructor.name,component:e}),this}removeComponent(e){const t=this.getComponent(e);if(t){t.onDetached&&t.onDetached(),t.entity=null;const s=e.name;this.components.delete(s),this.world&&this.world.messageBus&&this.world.messageBus.publish("component.removed",{entity:this,componentType:s,component:t})}return this}getComponent(e){return typeof e=="string"?this.components.get(e):this.components.get(e.name)}hasComponent(e){return typeof e=="string"?this.components.has(e):this.components.has(e.name)}_syncTagCache(){this._isEnemy=this.tags.has("enemy"),this._isPlayer=this.tags.has("player"),this._isProjectile=this.tags.has("projectile"),this._isPooled=this.tags.has("pooled")}addTag(e){return this.tags.has(e)||(this.tags.add(e),e==="enemy"?this._isEnemy=!0:e==="player"?this._isPlayer=!0:e==="projectile"?this._isProjectile=!0:e==="pooled"&&(this._isPooled=!0),this.world&&this.world.entityManager&&(this.world.entityManager.onTagAdded(this,e),(!this.world.entityManager.entitiesByTag.has(e)||!this.world.entityManager.entitiesByTag.get(e).includes(this))&&(console.error(`Failed to register entity ${this.id} with tag '${e}' in entity manager!`),this.world.entityManager.entitiesByTag.has(e)||this.world.entityManager.entitiesByTag.set(e,[]),this.world.entityManager.entitiesByTag.get(e).push(this),console.log(`Manually fixed tag registration for entity ${this.id} with tag '${e}'`)))),this}removeTag(e){return this.tags.has(e)&&(this.tags.delete(e),e==="enemy"?this._isEnemy=!1:e==="player"?this._isPlayer=!1:e==="projectile"?this._isProjectile=!1:e==="pooled"&&(this._isPooled=!1),this.world&&this.world.entityManager&&this.world.entityManager.onTagRemoved(this,e)),this}clearTags(){const e=[...this.tags];for(const t of e)this.removeTag(t);return this._isEnemy=!1,this._isPlayer=!1,this._isProjectile=!1,this._isPooled=!1,this.tags.clear(),this}hasTag(e){const t=this.tags.has(e);let s=!1;return e==="enemy"&&this._isEnemy!==t?(console.warn(`Tag cache inconsistency for entity ${this.id}: _isEnemy=${this._isEnemy}, actual=Set{${Array.from(this.tags)}}`),this._isEnemy=t,s=!0):e==="player"&&this._isPlayer!==t?(console.warn(`Tag cache inconsistency for entity ${this.id}: _isPlayer=${this._isPlayer}, actual=Set{${Array.from(this.tags)}}`),this._isPlayer=t,s=!0):e==="projectile"&&this._isProjectile!==t?(console.warn(`Tag cache inconsistency for entity ${this.id}: _isProjectile=${this._isProjectile}, actual=Set{${Array.from(this.tags)}}`),this._isProjectile=t,s=!0):e==="pooled"&&this._isPooled!==t&&(console.warn(`Tag cache inconsistency for entity ${this.id}: _isPooled=${this._isPooled}, actual=Set{${Array.from(this.tags)}}`),this._isPooled=t,s=!0),s&&this._syncTagCache(),t}}class Ji{constructor(e){this.world=e,this.entities=new Map,this.entitiesByComponent=new Map,this.entitiesByTag=new Map,this.lastEntityId=0,this.recycledEntities=[],this.maxRecycledEntities=100}createEntity(e=""){let t;if(this.recycledEntities.length>0)t=this.recycledEntities.pop(),t.components.clear(),t.tags.clear(),t._isEnemy=void 0,t._isPlayer=void 0,t._isProjectile=void 0;else{const s=this._generateEntityId();t=new Zi(s,this.world)}return this.entities.set(t.id.toString(),t),e&&t.addTag(e),this.world.messageBus.publish("entity.created",{entity:t}),t}destroyEntity(e){const t=typeof e=="string"?e:e.id,s=this.entities.get(t.toString());if(s){this.world.messageBus.publish("entity.destroyed",{entity:s}),s.tags.forEach(i=>{if(this.entitiesByTag.has(i)){const o=this.entitiesByTag.get(i),n=o.indexOf(s);n!==-1&&o.splice(n,1),o.length===0&&this.entitiesByTag.delete(i)}});for(const[i,o]of s.components.entries())s.removeComponent(o.constructor);this.entities.delete(t.toString()),this.recycledEntities.length<this.maxRecycledEntities&&this.recycledEntities.push(s)}}getEntity(e){return this.entities.get(e.toString())}getEntitiesByTag(e){return this.entitiesByTag.get(e)||[]}getEntitiesWithComponents(e){return!e||e.length===0?Array.from(this.entities.values()):Array.from(this.entities.values()).filter(t=>e.every(s=>t.hasComponent(s)))}getEntities(){return Array.from(this.entities.values())}onTagAdded(e,t){this.entitiesByTag.has(t)||this.entitiesByTag.set(t,[]),this.entitiesByTag.get(t).push(e)}onTagRemoved(e,t){if(this.entitiesByTag.has(t)){const s=this.entitiesByTag.get(t),i=s.indexOf(e);i!==-1&&s.splice(i,1),s.length===0&&this.entitiesByTag.delete(t)}}_generateEntityId(){return(++this.lastEntityId).toString()}}class eo{constructor(e){this.world=e,this.systems=[],this.systemsByType=new Map}registerSystem(e){return this.systemsByType.has(e.constructor.name)?(console.warn(`System of type ${e.constructor.name} already registered`),e):(this.systems.push(e),this.systemsByType.set(e.constructor.name,e),this.systems.sort((t,s)=>t.priority-s.priority),e)}getSystem(e){return this.systemsByType.get(e.name)}update(e){for(const t of this.systems)t.enabled&&t.update(e)}initialize(){for(const e of this.systems)typeof e.initialize=="function"&&e.initialize()}enableSystem(e){const t=this.getSystem(e);t&&t.enable()}disableSystem(e){const t=this.getSystem(e);t&&t.disable()}}class to{constructor(e=null){this.messageBus=e||new Is,!e&&!window.mainMessageBus&&(window.mainMessageBus=this.messageBus,console.log("World: Set this.messageBus as window.mainMessageBus")),this.entityManager=new Ji(this),this.systemManager=new eo(this),this.deltaTime=0,this.time=0,this.lastUpdateTime=0}initialize(){this.lastUpdateTime=performance.now(),this.systemManager.initialize(),this.messageBus.publish("world.initialized",{})}update(){const e=performance.now();if(this.deltaTime=Math.min((e-this.lastUpdateTime)/1e3,.1),this.lastUpdateTime=e,this.time+=this.deltaTime,this.messageBus.publish("world.preUpdate",{deltaTime:this.deltaTime,time:this.time}),this.systemManager.update(this.deltaTime),this.messageBus.publish("world.postUpdate",{deltaTime:this.deltaTime,time:this.time}),window.DEBUG_MODE&&this.time%5<this.deltaTime){const t=Array.from(this.entityManager.entities.values());console.log(`World update - ${t.length} entities active`);const s=this.getEntitiesWithComponents(["MeshComponent"]);console.log(`Entities with mesh: ${s.length}`)}}createEntity(e=""){return this.entityManager.createEntity(e)}destroyEntity(e){this.entityManager.destroyEntity(e)}registerSystem(e){return this.systemManager.registerSystem(e)}getEntitiesWithComponents(e){return this.entityManager.getEntitiesWithComponents(e)}getEntitiesByTag(e){return this.entityManager.getEntitiesByTag(e)}getEntity(e){return this.entityManager.getEntity(e)}getSystem(e){return this.systemManager.getSystem(e)}}class De{constructor(e){this.world=e,this.enabled=!0,this.requiredComponents=[],this.priority=0}checkEntity(e){return this.requiredComponents.every(t=>e.hasComponent(t))}getEntities(){return this.world.getEntitiesWithComponents(this.requiredComponents)}update(e){if(!this.enabled)return;this.getEntities().forEach(s=>{this.processEntity(s,e)})}processEntity(e,t){}initialize(){}enable(){this.enabled=!0}disable(){this.enabled=!1}}class Be{constructor(){this.entity=null,this.enabled=!0}onAttached(){}onDetached(){}onEnabled(){}onDisabled(){}enable(){return this.enabled||(this.enabled=!0,this.onEnabled()),this}disable(){return this.enabled&&(this.enabled=!1,this.onDisabled()),this}}class _t extends Be{constructor(e=100,t=0){super(),this.maxHealth=e,this.health=e,this.maxShield=t,this.shield=t,this.shieldRegenRate=5,this.shieldRegenDelay=3,this.timeSinceLastDamage=this.shieldRegenDelay,this.damageResistance=0,this.isDestroyed=!1,this.isInvulnerable=!1,console.log(`Created health component with ${e} max health and ${t} max shield`)}onAttached(){this.entity&&this.entity.hasTag&&this.entity.hasTag("player")&&(console.log("HealthComponent attached to player entity - subscribing to sync events"),this.entity.world&&this.entity.world.messageBus?(this.entity.world.messageBus.subscribe("player.syncHealth",this.handleSyncHealth.bind(this)),this.entity.world.messageBus.subscribe("player.undocked",this.handleSyncHealth.bind(this)),console.log("Subscribed to player.syncHealth and player.undocked events")):window.mainMessageBus&&(window.mainMessageBus.subscribe("player.syncHealth",this.handleSyncHealth.bind(this)),window.mainMessageBus.subscribe("player.undocked",this.handleSyncHealth.bind(this)),console.log("Subscribed to player.syncHealth and player.undocked events via mainMessageBus")))}handleSyncHealth(e){if(!this.entity||!this.entity.hasTag||!this.entity.hasTag("player"))return;console.log("HealthComponent received syncHealth event:",e);const t=e.data||e;if(console.log("Extracted sync data:",t),t.shield!==void 0){const s=this.shield;console.log(`SHIELD SYNC: HealthComponent shield was ${s}, spaceship shield is ${t.shield}`),this.shield=t.shield,console.log(`Updated shield: ${s} → ${this.shield}`)}else console.warn("Shield value not provided in sync data");if(t.maxShield!==void 0){const s=this.maxShield;this.maxShield=t.maxShield,console.log(`Updated maxShield: ${s} → ${this.maxShield}`)}else console.warn("MaxShield value not provided in sync data");if(t.hull!==void 0){const s=this.health;this.health=t.hull,console.log(`Updated health: ${s} → ${this.health}`)}else console.warn("Hull value not provided in sync data");if(t.maxHull!==void 0){const s=this.maxHealth;this.maxHealth=t.maxHull,console.log(`Updated maxHealth: ${s} → ${this.maxHealth}`)}else console.warn("MaxHull value not provided in sync data");console.log(`HealthComponent synced: Health ${this.health}/${this.maxHealth}, Shield ${this.shield}/${this.maxShield}`)}applyDamage(e,t="projectile",s=null){if(console.log(`HealthComponent: Applying ${e} damage of type ${t} to entity ${this.entity?this.entity.id:"unknown"}`),console.log(`Current health: ${this.health}/${this.maxHealth}, Shield: ${this.shield}/${this.maxShield}`),this.isDestroyed||this.isInvulnerable)return console.log("Entity is destroyed or invulnerable, damage not applied"),{damageApplied:0,shieldDamage:0,healthDamage:0,destroyed:!1};const i=e*(1-this.damageResistance);let o=0,n=0;return this.timeSinceLastDamage=0,this.shield>0?i<=this.shield?(this.shield-=i,o=i):(o=this.shield,n=i-this.shield,this.shield=0,this.health-=n):(this.health-=i,n=i),this.health<0&&(this.health=0),this.health<=0&&!this.isDestroyed&&(this.isDestroyed=!0,this.entity&&this.entity.world&&(this.entity.world.messageBus.publish("entity.destroyed",{entity:this.entity,source:s,damageType:t}),this.entity.hasTag&&this.entity.hasTag("player")&&(console.log("PLAYER HEALTH COMPONENT DESTROYED - TRIGGERING GAME OVER"),console.log("HealthComponent: Initiating game over sequence"),this.entity&&this.entity.world&&this.entity.world.messageBus?(console.log("HealthComponent: Publishing game.over via world.messageBus"),this.entity.world.messageBus.publish("game.over",{reason:"You were pwned by a space alien!",source:"health"})):zt(()=>import("./core-BBQ_RQx4.js"),[]).then(a=>{const r=a.MessageBus;console.log("HealthComponent: Using MessageBus.triggerGameOver"),r.triggerGameOver("You were pwned by a space alien!","health")}).catch(a=>{console.error("Error importing MessageBus:",a)})))),this.entity&&this.entity.world&&this.entity.world.messageBus.publish("entity.damaged",{entity:this.entity,source:s,damageType:t,amount:i,shieldDamage:o,healthDamage:n}),console.log(`After damage: Health: ${this.health}/${this.maxHealth}, Shield: ${this.shield}/${this.maxShield}`),console.log(`Entity destroyed: ${this.isDestroyed}`),{damageApplied:i,shieldDamage:o,healthDamage:n,destroyed:this.isDestroyed}}heal(e){if(this.isDestroyed)return 0;const t=this.health;this.health=Math.min(this.health+e,this.maxHealth);const s=this.health-t;return s>0&&this.entity&&this.entity.world&&this.entity.world.messageBus.publish("entity.healed",{entity:this.entity,amount:s}),s}rechargeShield(e){if(this.isDestroyed)return 0;const t=this.shield;this.shield=Math.min(this.shield+e,this.maxShield);const s=this.shield-t;return s>0&&this.entity&&this.entity.world&&this.entity.world.messageBus.publish("entity.shieldRecharged",{entity:this.entity,amount:s}),s}update(e){if(!this.isDestroyed){if(this.timeSinceLastDamage+=e,this.timeSinceLastDamage>=this.shieldRegenDelay&&this.shield<this.maxShield){const t=this.shieldRegenRate*e;this.rechargeShield(t)}if(this.entity&&this.entity.hasTag("player")&&this.health<this.maxHealth){const s=this.maxHealth*.05*e;this.heal(s)}}}getHealthPercentage(){return this.health/this.maxHealth*100}getShieldPercentage(){return this.maxShield>0?this.shield/this.maxShield*100:0}upgradeHealth(e=1.25){const t=this.maxHealth;return this.maxHealth*=e,this.health=this.maxHealth,console.log(`Upgraded health from ${t.toFixed(1)} to ${this.maxHealth.toFixed(1)}`),this.entity&&this.entity.world&&this.entity.world.messageBus.publish("health.upgraded",{entity:this.entity,oldMax:t,newMax:this.maxHealth}),{maxHealth:this.maxHealth,healthBoost:this.maxHealth-t}}upgradeShield(e=1.5){console.log("===== SHIELD UPGRADE INITIATED ====="),console.log(`Current shield values - Max: ${this.maxShield}, Current: ${this.shield}`);const t=this.maxShield,s=this.shield;return this.maxShield=Math.ceil(this.maxShield*e),this.shield=this.maxShield,console.log(`Upgraded shield from ${t.toFixed(1)} to ${this.maxShield.toFixed(1)}`),console.log(`Current shield value changed from ${s.toFixed(1)} to ${this.shield.toFixed(1)}`),console.log("===== SHIELD UPGRADE COMPLETED ====="),this.entity&&this.entity.world&&this.entity.world.messageBus.publish("shield.upgraded",{entity:this.entity,oldMax:t,newMax:this.maxShield}),{maxShield:this.maxShield,shieldBoost:this.maxShield-t}}}class rt extends Be{constructor(e=new y,t=new me,s=new y(1,1,1)){super(),this.position=e.clone(),this.rotation=t.clone(),this.scale=s.clone(),this.quaternion=new fe().setFromEuler(this.rotation),this.matrix=new V,this.needsUpdate=!0}setPosition(e,t,s){return this.position.set(e,t,s),this.needsUpdate=!0,this}setRotation(e,t,s){return this.rotation.set(e,t,s),this.quaternion.setFromEuler(this.rotation),this.needsUpdate=!0,this}setQuaternion(e){return this.quaternion.copy(e),this.rotation.setFromQuaternion(this.quaternion),this.needsUpdate=!0,this}setScale(e,t,s){return this.scale.set(e,t,s),this.needsUpdate=!0,this}lookAt(e){const t=new V;return t.lookAt(this.position,e,new y(0,1,0)),this.quaternion.setFromRotationMatrix(t),this.rotation.setFromQuaternion(this.quaternion),this.needsUpdate=!0,this}updateMatrix(){return this.needsUpdate&&(this.matrix.compose(this.position,this.quaternion,this.scale),this.needsUpdate=!1),this.matrix}getWorldPosition(){return this.position.clone()}getForwardVector(){const e=new y(0,0,-1);return e.applyQuaternion(this.quaternion),e}getRightVector(){const e=new y(1,0,0);return e.applyQuaternion(this.quaternion),e}getUpVector(){const e=new y(0,1,0);return e.applyQuaternion(this.quaternion),e}}class so extends Be{constructor(e=1){super(),this.velocity=new y,this.angularVelocity=new y,this.mass=e,this.drag=.01,this.angularDrag=.01,this.useGravity=!1,this.isKinematic=!1,this.freezeRotation=!1,this.forces=new y,this.torque=new y,this.collisionRadius=1,this.isTrigger=!1}resetForces(){this.forces.set(0,0,0),this.torque.set(0,0,0)}applyForce(e,t=null){if(!this.isKinematic&&(this.forces.add(e),t)){const s=this.entity.getComponent("TransformComponent");if(s){const o=t.clone().sub(s.position).cross(e);this.applyTorque(o)}}}applyImpulse(e){if(this.isKinematic)return;const t=e.clone().divideScalar(this.mass);this.velocity.add(t)}applyTorque(e){this.isKinematic||this.freezeRotation||this.torque.add(e)}setVelocity(e){this.velocity.copy(e)}setAngularVelocity(e){this.freezeRotation||this.angularVelocity.copy(e)}}class io extends De{constructor(e){super(e),this.requiredComponents=["TransformComponent","RigidbodyComponent"],this.priority=50,this.projectiles=new Set,this.damageDealt=0,this.damageReceived=0,this.cachedProjectiles=new Ee(100),this.cachedEnemies=new Ee(50),this.cachedPlayers=new Ee(5),this.hitPosition=new y,this.effectPosition=new y,this.setupEventListeners()}setupEventListeners(){this.world.messageBus.subscribe("weapon.fired",this.handleProjectileCreated.bind(this)),this.world.messageBus.subscribe("turret.fire",this.handleProjectileCreated.bind(this)),this.world.messageBus.subscribe("missile.fired",this.handleProjectileCreated.bind(this)),this.world.messageBus.subscribe("entity.damaged",this.handleEntityDamaged.bind(this))}update(e){const t=this.world.entityManager.getEntities();this.checkProjectileCollisions(t),this.cleanupInvalidProjectiles()}cleanupInvalidProjectiles(){const e=new Set,t=this.world.entityManager.getEntitiesByTag("projectile"),s=this.world.entityManager.getEntitiesByTag("enemyProjectile");[...t,...s].forEach(i=>{i&&i.id&&e.add(i.id)});for(const i of this.projectiles)e.has(i)||(console.log(`Removing invalid projectile ${i} from tracking`),this.projectiles.delete(i))}checkProjectileCollisions(e){const t=this.world.entityManager.getEntitiesByTag("projectile"),s=this.world.entityManager.getEntitiesByTag("enemyProjectile");this.cachedProjectiles.clear(),this.cachedEnemies.clear(),this.cachedPlayers.clear();for(let i=0;i<e.length;i++){const o=e[i];o.hasTag("enemy")||o.hasComponent("EnemyAIComponent")?this.cachedEnemies.push(o):o.hasTag("player")&&this.cachedPlayers.push(o)}for(let i=0;i<t.length;i++)this.cachedProjectiles.push(t[i]);for(let i=0;i<s.length;i++)this.cachedProjectiles.push(s[i]);this.cachedProjectiles.length>0&&console.log(`CombatSystem: Checking ${this.cachedProjectiles.length} projectiles for collisions`);for(let i=0;i<this.cachedProjectiles.length;i++){const o=this.cachedProjectiles.get(i);try{this.projectiles.has(o.id)||this.projectiles.add(o.id);const n=o.getComponent("TransformComponent"),a=o.getComponent("RigidbodyComponent");if(!n||!a){console.log(`Projectile ${o.id} missing transform or rigidbody component`);continue}const r=o._isPlayerProjectile||o.hasTag("projectile")||o.hasTag("playerProjectile"),l=o._isEnemyProjectile||o.hasTag("enemyProjectile");if(a.velocity.lengthSq()<.1)continue;const c=r?this.cachedEnemies:l?this.cachedPlayers:e,d=new at,h=n.position.clone(),u=a.velocity.clone().normalize(),m=u.clone().multiplyScalar(-10),f=h.clone().add(m);d.set(f,u),d.near=0,d.far=50,console.log(`Raycaster for projectile ${o.id} - Origin: (${f.x.toFixed(1)}, ${f.y.toFixed(1)}, ${f.z.toFixed(1)}), Direction: (${u.x.toFixed(2)}, ${u.y.toFixed(2)}, ${u.z.toFixed(2)})`);let g=!1;for(let b=0;b<c.length;b++){const w=c.get?c.get(b):c[b];if(w.destroyed||w.id===o.id)continue;const v=w.getComponent("MeshComponent");if(!v||!v.mesh){console.log(`Target ${w.id} has no mesh component or mesh`);continue}if(console.log(`Testing collision with target ${w.id}, mesh visible: ${v.mesh.visible}, mesh children: ${v.mesh.children?v.mesh.children.length:0}`),!v.mesh.visible){console.log(`Mesh for ${w.id} is not visible, skipping`);continue}const x=d.intersectObject(v.mesh,!0);if(x.length>0){const S=x[0];console.log(`MESH HIT! Projectile ${o.id} hit ${w.id} at distance ${S.distance.toFixed(2)}`),console.log(`Hit point: (${S.point.x.toFixed(1)}, ${S.point.y.toFixed(1)}, ${S.point.z.toFixed(1)})`),S.object&&console.log(`Hit specific mesh: ${S.object.name||"unnamed"}`),this.hitPosition.copy(S.point),this.handleProjectileCollision(o,w);try{this.world.destroyEntity(o.id),this.projectiles.delete(o.id),g=!0}catch(M){console.error("Failed to destroy projectile after hit:",M)}break}else{const S=w.getComponent("TransformComponent");if(S){const M=h.distanceTo(S.position);console.log(`No intersection with ${w.id} at distance ${M.toFixed(1)}`)}}}if(g)continue}catch(n){console.error(`Error processing projectile ${o.id}:`,n)}}}handleProjectileCollision(e,t){var n,a;let s=10;const i=(n=e.userData)==null?void 0:n.source;e.userData&&e.userData.damage?s=e.userData.damage:e.sourceComponent&&(s=e.sourceComponent.damage);const o=t.getComponent("HealthComponent");if(o){const r=((a=e.userData)==null?void 0:a.attackType)||"projectile",l=o.applyDamage(s,r,i);this.createHitEffect(e,t,l),t.hasTag("player")?this.damageReceived+=l.damageApplied:t.hasTag("enemy")&&(this.damageDealt+=l.damageApplied);const c=e.getComponent("TransformComponent");c?this.hitPosition.copy(c.position):this.hitPosition.set(0,0,0),this.world.messageBus.publish("combat.hit",{projectile:e,target:t,damage:l.damageApplied,shieldDamage:l.shieldDamage,healthDamage:l.healthDamage,destroyed:l.destroyed,position:this.hitPosition})}}createHitEffect(e,t,s){const i=e.getComponent("TransformComponent");if(!i)return;let o=16733440,n=1;s.shieldDamage>0&&(o=3381759,n=1.5),s.healthDamage>20&&(o=16711680,n=2),this.effectPosition.copy(i.position);let a;const r=window.objectPool&&window.objectPool.pools&&window.objectPool.pools.hitEffect;r?a=window.objectPool.get("hitEffect",o,n):a=this.createNewHitEffect(o,n),a&&a.mesh&&(a.mesh.position.copy(this.effectPosition),a.mesh.parent||this.world.scene.add(a.mesh),this.animateHitEffect(a,a.mesh,r))}createNewHitEffect(e,t){let s;window.game&&window.game.hitEffectGeometry?s=window.game.hitEffectGeometry:this.hitEffectGeometry?s=this.hitEffectGeometry:(this.hitEffectGeometry=new G(1,8,8),s=this.hitEffectGeometry);const i=new F({color:e,transparent:!0,opacity:.8}),o=new C(s,i);return o.scale.set(t,t,t),{mesh:o,material:i}}animateHitEffect(e,t,s=!0){let i=1,o=.8;const n=()=>{i+=.1,o-=.05,t&&t.scale&&(t.scale.set(i,i,i),e.material&&(e.material.opacity=o),o>0?requestAnimationFrame(n):(t.parent&&t.parent.remove(t),s&&window.objectPool&&window.objectPool.pools.hitEffect?window.objectPool.release("hitEffect",e):s||e.material&&e.material.dispose()))};n()}handleProjectileCreated(e){e.entity&&e.entity.id&&this.projectiles.add(e.entity.id)}handleEntityDamaged(e){e.target&&(e.target.hasTag("player")?this.damageReceived+=e.damage||0:e.target.hasTag("enemy")&&(this.damageDealt+=e.damage||0))}onDisabled(){this.world.messageBus.unsubscribe("weapon.fired",this.handleProjectileCreated),this.world.messageBus.unsubscribe("turret.fire",this.handleProjectileCreated),this.world.messageBus.unsubscribe("missile.fired",this.handleProjectileCreated),this.world.messageBus.unsubscribe("entity.damaged",this.handleEntityDamaged)}}class oo extends Be{constructor(e={}){super(),this.faction=e.faction||"spectrals",this.type=e.type||"drone",this.detectionRange=e.detectionRange||2500,this.damage=e.damage||25,this.speed=e.speed||1e3,this.playerFound=!1,this.spiralAmplitude=e.spiralAmplitude||150,this.spiralFrequency=e.spiralFrequency||2,this.spiralPhase=Math.random()*Math.PI*2,this.timeAlive=0,this.lastDirection=new y(0,0,1),this.isDroneLike=e.isDroneLike||!1,this.separationInfluence=e.separationInfluence||.3,this.separationForce=new y,console.log(`Created ${this.faction} ${this.type} enemy AI with detection range ${this.detectionRange}`)}setSeparationForce(e){this.separationForce.copy(e)}update(e){if(!this.entity||!this.entity.world)return;this.timeAlive+=e;let t=null;try{this.entity.world.playerEntity&&(t=this.entity.world.playerEntity)}catch{}if(!t&&window.game&&window.game.combat&&window.game.combat.playerEntity&&(t=window.game.combat.playerEntity),!t)try{const r=this.entity.world.getEntitiesByTag("player");r&&r.length>0&&(t=r[0])}catch{}if(!t&&this.entity.world.entityManager&&this.entity.world.entityManager.entitiesByTag)try{const r=this.entity.world.entityManager.entitiesByTag.get("player");r&&(r.size>0||r.length>0)&&(t=Array.from(r)[0])}catch{}if(!t&&this.entity.world.entityManager&&this.entity.world.entityManager.entities)try{const r=Array.from(this.entity.world.entityManager.entities.values());for(const l of r)if(l.hasTag&&l.hasTag("player")||l.name==="player"||l.id&&l.id.includes("player")){t=l;break}}catch{}if(!t&&window.game&&window.game.spaceship&&window.game.spaceship.mesh&&(console.log("No player entity found, but found spaceship - will use position directly"),t={getComponent:r=>r==="TransformComponent"?{position:window.game.spaceship.mesh.position,rotation:window.game.spaceship.mesh.rotation,quaternion:window.game.spaceship.mesh.quaternion}:null}),!t){Math.random()<.01&&console.error("No player entity found by any method! Enemy cannot move.");return}const s=this.entity.getComponent("TransformComponent");if(!s)return;const i=this.entity.getComponent("HealthComponent");if(i&&i.isDestroyed)return;let o=t.getComponent?t.getComponent("TransformComponent"):null;if(!o)if(t.position)o=t;else{console.warn("Player found but missing transform component!");return}this.playerFound||(console.log(`ENEMY FOUND PLAYER TARGET! Player position: ${o.position.x.toFixed(1)}, ${o.position.y.toFixed(1)}, ${o.position.z.toFixed(1)}`),this.playerFound=!0);const n=s.position.distanceTo(o.position),a=new y().subVectors(o.position,s.position).normalize();if(this.lastDirection.copy(a),this.faction==="spectrals"&&this.type==="drone"?this.isDroneLike?this.applyDroneLikeMovement(s,o,a,n,e):this.applySpectralDroneMovement(s,o,a,n,e):(s.position.add(a.multiplyScalar(this.speed*e)),s.lookAt(o.position)),n<75){console.log("ENEMY KAMIKAZE ATTACK!");const r=t.getComponent("HealthComponent");if(r){if(r.applyDamage(this.damage,"collision",this.entity),console.log(`Enemy collided with player! Applied ${this.damage} damage to player entity health component`),window.game&&window.game.spaceship){const l=window.game.spaceship;if(l.shield>0)if(l.shield>=this.damage)l.shield-=this.damage;else{const c=this.damage-l.shield;l.shield=0,l.hull-=c}else l.hull-=this.damage;console.log(`Applied ${this.damage} damage directly to spaceship: Hull=${l.hull}, Shield=${l.shield}`),l.hull<=0&&!l.isDestroyed&&(l.hull=0,l.isDestroyed=!0,window.game&&window.game.gameOver&&window.game.gameOver("Your ship was destroyed by a kamikaze attack!"))}if(this.entity.world&&this.entity.world.messageBus&&(this.entity.world.messageBus.publish("vfx.explosion",{position:s.position.clone(),scale:1.5,duration:2}),this.entity.world.messageBus.publish("vfx.damageFlash",{intensity:.3})),window.game&&window.game.audio&&window.game.audio.playSound("boink"),this.entity&&this.entity.world){const l=this.entity.id,c=this.entity.world;c.messageBus.publish("entity.aboutToBeDestroyed",{entity:this.entity,reason:"kamikaze"}),c.destroyEntity(l),console.log(`Enemy entity ${l} self-destructed after kamikaze attack`)}}}}applyDroneLikeMovement(e,t,s,i,o){const n=new y(0,1,0),a=new y().crossVectors(s,n).normalize();a.lengthSq()<.1&&a.set(1,0,0);const r=new y().crossVectors(a,s).normalize();let l=this.speed,c=new y;if(i>1e3){l=this.speed*1.2;const b=Math.sin(this.timeAlive*1.5)*30;c.copy(s).multiplyScalar(l).add(a.clone().multiplyScalar(b))}else if(i>400){const w=this.speed*.4,x=this.entity.id.split("").reduce((P,D)=>P+D.charCodeAt(0),0)%2===0?1:-1,S=a.clone().multiplyScalar(x*w),M=s.clone().multiplyScalar(this.speed*.6);c.copy(M).add(S);const A=Math.sin(this.timeAlive*2)*15;c.add(r.clone().multiplyScalar(A))}else{const b=this.timeAlive*3,w=Math.sin(b)*Math.cos(b*1.3)*80,v=Math.cos(b*.7)*Math.sin(b*1.1)*60,x=.5+.5*(.5+.5*Math.sin(b*.5));c.copy(s).multiplyScalar(this.speed*x).add(a.clone().multiplyScalar(w)).add(r.clone().multiplyScalar(v))}if(this.separationForce&&this.separationForce.lengthSq()>0){const b=this.separationForce.clone().normalize(),w=this.separationForce.length(),v=this.separationInfluence*(.5+.5*Math.min(1,w/100));c.lerp(b.multiplyScalar(this.speed),v)}e.position.add(c.multiplyScalar(o));const d=new y().copy(e.position).add(c.clone().normalize().multiplyScalar(100));e.lookAt(d);const h=new y;h.copy(c).projectOnVector(a);const m=h.length()*(h.dot(a)>0?-1:1)/this.speed*.4,f=e.getForwardVector(),g=new fe().setFromAxisAngle(f,m);e.quaternion.multiply(g),e.rotation.setFromQuaternion(e.quaternion)}applySpectralDroneMovement(e,t,s,i,o){const n=new y(0,1,0),a=new y().crossVectors(s,n).normalize();a.lengthSq()<.1&&a.set(1,0,0);const r=new y().crossVectors(a,s).normalize(),l=this.timeAlive*this.spiralFrequency;let c=this.spiralAmplitude;i<500&&(c=this.spiralAmplitude*(i/500));const d=Math.sin(l)*c,h=Math.cos(l)*c,u=new y().copy(s).multiplyScalar(this.speed).add(a.multiplyScalar(d)).add(r.multiplyScalar(h));if(this.separationForce&&this.separationForce.lengthSq()>0){const M=this.separationForce.clone().normalize(),A=this.separationForce.length(),P=this.separationInfluence*(.5+.5*Math.min(1,A/100));u.lerp(M.multiplyScalar(this.speed),P)}e.position.add(u.multiplyScalar(o));const f=l+this.spiralFrequency*.2,g=Math.sin(f)*c,b=Math.cos(f)*c,w=new y().copy(e.position).add(s.multiplyScalar(100)).add(a.multiplyScalar(g)).add(r.multiplyScalar(b));e.lookAt(w);const v=Math.atan2(d,this.speed)*.5,x=e.getForwardVector(),S=new fe().setFromAxisAngle(x,v);e.quaternion.multiply(S),e.rotation.setFromQuaternion(e.quaternion)}}class jt extends Be{constructor(e,t){if(super(),e&&e.isMesh||e&&e.isGroup)this.mesh=e;else if(e&&t)this.mesh=new C(e,t),e&&typeof e.computeBoundingSphere=="function"&&!e.boundingSphere&&e.computeBoundingSphere();else{console.warn("MeshComponent created with invalid geometry, using invisible default cube");const s=new ee(10,10,10);s.computeBoundingSphere();const i=new F({color:16711680,transparent:!0,opacity:0,visible:!1});this.mesh=new C(s,i),this.mesh.visible=!1}this.visible=!0,this.castShadow=!1,this.receiveShadow=!1}onAttached(){const e=this.entity.getComponent("TransformComponent");e&&(this.mesh.position.copy(e.position),this.mesh.quaternion.copy(e.quaternion),this.mesh.scale.copy(e.scale))}onDetached(){this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.geometry&&this.mesh.geometry.dispose(),this.mesh.material&&(Array.isArray(this.mesh.material)?this.mesh.material.forEach(e=>{e.map&&e.map.dispose(),e.lightMap&&e.lightMap.dispose(),e.bumpMap&&e.bumpMap.dispose(),e.normalMap&&e.normalMap.dispose(),e.specularMap&&e.specularMap.dispose(),e.envMap&&e.envMap.dispose(),e.dispose()}):(this.mesh.material.map&&this.mesh.material.map.dispose(),this.mesh.material.lightMap&&this.mesh.material.lightMap.dispose(),this.mesh.material.bumpMap&&this.mesh.material.bumpMap.dispose(),this.mesh.material.normalMap&&this.mesh.material.normalMap.dispose(),this.mesh.material.specularMap&&this.mesh.material.specularMap.dispose(),this.mesh.material.envMap&&this.mesh.material.envMap.dispose(),this.mesh.material.dispose()))}setVisible(e){this.visible=e,this.mesh.visible=e}setCastShadow(e){this.castShadow=e,this.mesh.castShadow=e}setReceiveShadow(e){this.receiveShadow=e,this.mesh.receiveShadow=e}setMaterial(e){this.mesh.material=e}setGeometry(e){this.mesh.geometry=e}addToScene(e){e.add(this.mesh)}updateFromTransform(){const e=this.entity.getComponent("TransformComponent");e&&(this.mesh.position.copy(e.position),this.mesh.quaternion.copy(e.quaternion),this.mesh.scale.copy(e.scale))}}class no{constructor(e,t=20){this.world=e,this.maxPoolSize=t,this.enemyPool=[],this.preallocateEnemyPool()}preallocateEnemyPool(){for(let e=0;e<10;e++){const t=this.createEnemyEntity();this.enemyPool.push(t)}console.log(`Pre-allocated enemy pool with ${this.enemyPool.length} spectral drones`)}createEnemyEntity(){const e=this.world.createEntity("enemy_spectral");return e.addTag("pooled"),e.addComponent(new rt),e.addComponent(new jt),e}getEnemyFromPool(){if(this.enemyPool.length>0){const t=this.enemyPool.pop();this.enemies&&this.enemies.has(t.id)&&(console.warn(`CRITICAL ERROR: Entity ${t.id} is in both the pool and active enemies!`),this.enemies.delete(t.id),console.log(`Fixed inconsistency: Removed entity ${t.id} from active enemies`));for(let i=0;i<this.enemyPool.length;i++)this.enemyPool[i].id===t.id&&(console.warn(`CRITICAL ERROR: Duplicate of entity ${t.id} found in enemy pool!`),this.enemyPool.splice(i,1),console.log(`Fixed inconsistency: Removed duplicate entity ${t.id} from enemy pool`),i--);console.log(`Getting entity ${t.id} from pool. Current tags: [${t.tags?[...t.tags]:"undefined"}]`),t.clearTags&&typeof t.clearTags=="function"?(t.clearTags(),console.log(`Cleared all tags from entity ${t.id}`)):(console.warn(`Entity ${t.id} missing clearTags method`),t.hasTag&&t.removeTag&&(t.hasTag("pooled")&&t.removeTag("pooled"),t.hasTag("enemy")&&t.removeTag("enemy"),t.hasTag("spectrals")&&t.removeTag("spectrals"))),t._syncTagCache&&typeof t._syncTagCache=="function"?(t._syncTagCache(),console.log(`Reset tag cache for entity ${t.id}`)):(t._isEnemy!==void 0&&(t._isEnemy=!1),t._isPooled!==void 0&&(t._isPooled=!1));const s=t.getComponent("EnemyAIComponent");return s&&(s.playerFound=!1,s.timeAlive=0,s.spiralPhase=Math.random()*Math.PI*2,s.enabled=!0),console.log(`Entity ${t.id} prepared for reuse. Current tags: [${t.tags?[...t.tags]:"undefined"}]`),t}const e=this.createEnemyEntity();return console.log(`Created new entity ${e.id} because pool was empty`),e}returnEnemyToPool(e,t){if(!e){console.warn("Attempt to return null/undefined entity to pool");return}const s=e.id;if(console.log(`Returning entity ${s} to pool. Has tags: [${e.tags?[...e.tags]:"undefined"}]`),t&&t.has(s)&&(t.delete(s),console.log(`Removed entity ${s} from enemies tracking`)),e.clearTags&&typeof e.clearTags=="function"?(e.clearTags(),console.log(`Cleared all tags from entity ${s}`)):(console.warn(`No clearTags method on entity ${s}, using manual tag removal`),e.hasTag&&e.removeTag&&(e.hasTag("enemy")&&e.removeTag("enemy"),e.hasTag("spectrals")&&e.removeTag("spectrals"),e.hasTag("drone")&&e.removeTag("drone"),e.hasTag("frozen")&&e.removeTag("frozen"))),this.enemyPool.length<this.maxPoolSize){const i=e.getComponent("TrailComponent");if(i)try{typeof i.onDetached=="function"&&i.onDetached(),window.game&&window.game.trailSystem&&window.game.trailSystem.unregisterTrail&&window.game.trailSystem.unregisterTrail(s),i.trailMesh&&i.trailMesh.parent&&i.trailMesh.parent.remove(i.trailMesh),i.trailMesh&&(i.trailMesh.geometry&&i.trailMesh.geometry.dispose(),i.trailMesh.material&&i.trailMesh.material.dispose()),e.removeComponent("TrailComponent"),console.log(`Removed and cleaned up TrailComponent from entity ${s}`)}catch(c){console.error(`Error cleaning up trail for entity ${s}:`,c)}const o=e.getComponent("TransformComponent");o&&(o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1));const n=e.getComponent("HealthComponent");n&&(n.health=0,n.isDestroyed=!0);const a=e.getComponent("EnemyAIComponent");a&&(a.enabled=!1,a.playerFound=!1,a.timeAlive=0,a.spiralPhase=Math.random()*Math.PI*2);const r=e.getComponent("MeshComponent");if(r&&r.mesh)try{r.mesh.parent&&r.mesh.parent.remove(r.mesh),r.mesh.visible=!1}catch(c){console.error(`Error cleaning up mesh for entity ${s}:`,c)}const l=e.getComponent("RigidbodyComponent");l&&(l.isFrozen=!0,l.velocity&&l.velocity.set(0,0,0)),e.addTag("pooled"),console.log(`Entity ${s} marked as pooled`),console.log(`Final entity ${s} state - Tags: [${e.tags?[...e.tags]:"none"}]`),this.enemyPool.push(e),console.log(`Entity ${s} returned to pool. Pool size now ${this.enemyPool.length}`)}else console.log(`Pool is full (${this.maxPoolSize}), destroying entity ${s} instead of pooling`),this.world&&this.world.destroyEntity?(this.world.destroyEntity(s),console.log(`Entity ${s} fully destroyed`)):console.error(`Failed to destroy entity ${s} - world or destroyEntity method not available`)}runPoolDiagnostics(e){console.log("=== RUNNING ENEMY POOL DIAGNOSTICS ==="),console.log(`Active enemies: ${e.size}, Pool size: ${this.enemyPool.length}`);let t=0;const s=new Set,i=[];for(let l=0;l<this.enemyPool.length;l++){const c=this.enemyPool[l];if(!c||!c.id){console.warn(`Invalid entity at index ${l} in enemy pool - removing`),i.push(l),t++;continue}s.has(c.id)?(console.warn(`Duplicate entity ${c.id} found in enemy pool at index ${l} - removing`),i.push(l),t++):s.add(c.id)}for(let l=i.length-1;l>=0;l--)this.enemyPool.splice(i[l],1);const o=[];for(let l=0;l<this.enemyPool.length;l++){const c=this.enemyPool[l];e.has(c.id)&&(console.error(`CRITICAL ERROR: Entity ${c.id} is both active and in the pool!`),o.push(l),t++)}for(let l=o.length-1;l>=0;l--){const c=o[l],d=this.enemyPool[c].id;this.enemyPool.splice(c,1),console.log(`Fixed critical inconsistency: Removed entity ${d} from pool since it's active`)}let n=0,a=0,r=0;if(this.world&&this.world.entityManager&&this.world.entityManager.entitiesByTag){const l=this.world.entityManager.entitiesByTag.get("enemy")||[];n=l.length,a=(this.world.entityManager.entitiesByTag.get("pooled")||[]).length;for(const d of l)d.hasTag("pooled")&&(console.warn(`INCONSISTENT ENTITY ${d.id}: Has both 'enemy' and 'pooled' tags`),r++,this.enemyPool.some(u=>u.id===d.id)?(d.removeTag("enemy"),console.log(`Fixed entity ${d.id} by removing 'enemy' tag since it's in the pool`)):(d.removeTag("pooled"),console.log(`Fixed entity ${d.id} by removing 'pooled' tag since it's not in the pool`)),t++);for(const d of e){const h=this.world.getEntity(d);h&&h.hasTag("pooled")&&(console.warn(`INCONSISTENT TRACKING: Entity ${d} is in active enemies but has 'pooled' tag`),this.enemyPool.some(m=>m.id===d)?(e.delete(d),console.log(`Fixed by removing entity ${d} from active enemies set since it's in the pool`)):(h.removeTag("pooled"),console.log(`Fixed entity ${d} by removing 'pooled' tag since it's not in the pool`)),r++,t++)}for(let d=0;d<this.enemyPool.length;d++){const h=this.enemyPool[d];if(!h)continue;let u=!1;h.hasTag("pooled")||(console.warn(`INCONSISTENT POOL: Entity ${h.id} in enemy pool but missing 'pooled' tag`),h.addTag("pooled"),console.log(`Fixed by adding 'pooled' tag to entity ${h.id}`),u=!0,t++),h.hasTag("enemy")&&(console.warn(`INCONSISTENT POOL: Entity ${h.id} in enemy pool but has 'enemy' tag`),h.removeTag("enemy"),console.log(`Fixed by removing 'enemy' tag from entity ${h.id}`),u=!0,t++),u&&r++}}console.log(`Diagnostic results: ${n} entities with 'enemy' tag, ${a} entities with 'pooled' tag`),console.log(`Fixed ${t} inconsistencies across ${r} entities`),console.log("=== DIAGNOSTICS COMPLETE ===")}}class ao{constructor(e){this.world=e,this.spawnPoints=[],this.spawnTimer=0,this.spawnInterval=3,this.lastSpawnTime=Date.now(),this.modelCache={},this.baseEnemyConfig={health:20,damage:15,speed:700,spiralAmplitude:150,spiralFrequency:2},this.enemyConfig={...this.baseEnemyConfig},this.loadModels(),this.generateSpawnPoints()}loadModels(){new Bs().load("assets/enemy.glb",t=>{console.log("Enemy model loaded successfully"),this.modelCache.enemyDrone=t.scene,this.modelCache.enemyDrone.traverse(s=>{s.isMesh&&s.material&&(s.material.emissive=new E(35071),s.material.emissiveIntensity=2)})},t=>{console.log("Loading enemy model: "+t.loaded/t.total*100+"% loaded")},t=>{console.error("Error loading enemy model",t)})}generateSpawnPoints(){this.spawnPoints=[];const e=this.world.entityManager.getEntitiesByTag("player");if(e.length===0){for(let l=0;l<10;l++){const c=l/10*Math.PI*2,d=Math.cos(c)*3e3,h=(Math.random()-.5)*1e3,u=Math.sin(c)*3e3;this.spawnPoints.push(new y(d,h,u))}console.log(`Generated ${this.spawnPoints.length} default spawn points around origin`);return}const s=e[0].getComponent("TransformComponent");if(!s){console.warn("Player entity has no transform component, using default spawn points");return}const i=s.position.clone(),o=2500,n=12;for(let a=0;a<n;a++){const r=Math.acos(2*Math.random()-1),l=Math.random()*Math.PI*2,c=i.x+o*Math.sin(r)*Math.cos(l),d=i.y+o*Math.sin(r)*Math.sin(l),h=i.z+o*Math.cos(r);this.spawnPoints.push(new y(c,d,h))}console.log(`Generated ${this.spawnPoints.length} spawn points around player at position ${i.x.toFixed(0)}, ${i.y.toFixed(0)}, ${i.z.toFixed(0)}`)}getRandomSpawnPoint(){if(this.spawnPoints.length===0&&this.generateSpawnPoints(),this.spawnPoints.length>0){const e=Math.floor(Math.random()*this.spawnPoints.length);return this.spawnPoints[e].clone()}else{console.warn("No spawn points available, using fallback position");const e=Math.random()*Math.PI*2,t=2e3;return new y(Math.cos(e)*t,(Math.random()-.5)*500,Math.sin(e)*t)}}update(e,t,s,i){this.spawnTimer+=e;let o=this.spawnInterval;if(this.updateDifficultyParameters(),this.spawnTimer>=o&&t.size<s){const n=this.getRandomSpawnPoint();if(!n)return console.error("Failed to get spawn point! Generating new spawn points."),this.generateSpawnPoints(),!1;if(i(n))return this.spawnTimer=0,this.lastSpawnTime=Date.now(),!0}return!1}updateDifficultyParameters(){if(window.game&&window.game.difficultyManager&&window.game.difficultyManager.params){const e=window.game.difficultyManager.params;e.enemyHealth!==void 0&&(this.enemyConfig.health=e.enemyHealth),e.enemyDamage!==void 0&&(this.enemyConfig.damage=e.enemyDamage),e.enemySpeed!==void 0&&(this.enemyConfig.speed=e.enemySpeed),e.spawnInterval!==void 0&&(this.spawnInterval=e.spawnInterval),Math.random()<.005&&console.log(`Current enemy parameters: Health=${this.enemyConfig.health}, Damage=${this.enemyConfig.damage}, Speed=${this.enemyConfig.speed}, SpawnInterval=${this.spawnInterval}`)}}spawnSpectralDrone(e,t,s,i){if(console.log("Setting up spectral drone config..."),s.size>=i)return console.warn(`SPAWN BLOCKED: Already at maximum enemies (${s.size}/${i})`),null;this.updateDifficultyParameters();const o=t.getEnemyFromPool();if(!o)return console.error("Failed to get entity from pool or create new one"),null;if(s.has(o.id))return console.error(`Entity ${o.id} is already in the active enemies list!`),null;o.tags&&o.tags.size>0&&(console.warn(`Entity ${o.id} from pool still has tags: [${[...o.tags]}]. Clearing all tags.`),o.clearTags&&typeof o.clearTags=="function"?o.clearTags():(o.tags.clear(),o._isEnemy=!1,o._isPooled=!1,o._isPlayer=!1,o._isProjectile=!1)),o.addTag("enemy"),o.addTag("spectrals");const n=this.enemyConfig.spiralAmplitude*(.8+Math.random()*.4),a=this.enemyConfig.spiralFrequency*(.9+Math.random()*.2),r=this.enemyConfig.speed*(.7+Math.random()*.6),d=80*(.8+Math.random()*.8),h={x:(Math.random()-.5)*.2,y:(Math.random()-.5)*.2,z:(Math.random()-.5)*.2},u=Math.floor(Math.random()*4);o.visualVariant=u;const m=o.getComponent("TransformComponent");if(m)m.position.copy(e),m.scale.set(d,d,d),m.rotation.x+=h.x,m.rotation.y+=h.y,m.rotation.z+=h.z,m.needsUpdate=!0;else{const x=new rt(e);x.scale.set(d,d,d),x.rotation.x+=h.x,x.rotation.y+=h.y,x.rotation.z+=h.z,o.addComponent(x)}let f=o.getComponent("HealthComponent");f?(f.maxHealth=this.enemyConfig.health,f.health=this.enemyConfig.health,f.isDestroyed=!1):(f=new _t(this.enemyConfig.health,0),o.addComponent(f));let g=o.getComponent("EnemyAIComponent");if(g)g.faction="spectrals",g.type="drone",g.damage=this.enemyConfig.damage,g.speed=r,g.spiralAmplitude=n,g.spiralFrequency=a,g.isDroneLike=!0,g.enabled=!0;else{const x={faction:"spectrals",type:"drone",health:this.enemyConfig.health,damage:this.enemyConfig.damage,speed:r,spiralAmplitude:n,spiralFrequency:a,isDroneLike:!0};g=new oo(x),o.addComponent(g)}this.currentEntity=o;const b=this.createSpectralDroneMesh();this.currentEntity=null;let w=o.getComponent("MeshComponent");w||(w=new jt,o.addComponent(w)),w.mesh&&(w.mesh.parent&&w.mesh.parent.remove(w.mesh),w.mesh.geometry&&w.mesh.geometry.dispose(),w.mesh.material&&(Array.isArray(w.mesh.material)?w.mesh.material.forEach(x=>x.dispose()):w.mesh.material.dispose())),b.isGLTF?w.mesh=b.model:w.mesh=new C(b.geometry,b.material),w.onAddedToScene=function(x){this.mesh&&!this.mesh.parent&&x&&(console.log("Adding enemy drone mesh to scene"),x.add(this.mesh))},this.world&&this.world.scene&&w.mesh&&(w.mesh.visible=!0,this.world.scene.add(w.mesh),w.mesh.position.copy(m.position),w.mesh.quaternion.copy(m.quaternion),w.mesh.scale.copy(m.scale),console.log("Added enemy drone mesh to scene immediately"));let v=o.getComponent("RigidbodyComponent");return v?(v.isFrozen=!1,v.velocity.set(0,0,0),v.collisionRadius=50):(v=new so(1),v.useGravity=!1,v.drag=.1,v.shape="sphere",v.collisionRadius=50,o.addComponent(v)),o.getComponent("TrailComponent"),s.delete(o.id),s.add(o.id),this.lastSpawnTime=Date.now(),o.hasTag("enemy")||(console.warn(`CRITICAL ERROR: Entity ${o.id} missing 'enemy' tag after setup!`),o.addTag("enemy")),window.game&&window.game.combat&&window.game.combat.registerEnemy&&window.game.combat.registerEnemy(o.id),console.log(`Spawned enemy drone at position: x=${e.x.toFixed(0)}, y=${e.y.toFixed(0)}, z=${e.z.toFixed(0)}`),console.log(`Properties: Speed=${g.speed}, Amplitude=${g.spiralAmplitude}, Frequency=${g.spiralFrequency}`),console.log(`Current enemy count after spawn: ${s.size}/${i}`),o}addSpectralTrail(e,t){const s=new TrailComponent({maxPoints:50,pointDistance:5,width:15,color:52479,fadeTime:1.5,transparent:!0,alphaTest:.01,blending:$,pulse:!0,pulseSpeed:2.5,tapering:!0,glow:!0,thrusterMode:!0});t&&t.position&&(s.lastPosition=t.position.clone(),s.points&&(s.points=[t.position.clone()]),typeof s.initializeTrail=="function"&&s.initializeTrail(t.position)),e.addComponent(s);let i=!1;if(window.game&&window.game.trailSystem&&(window.game.trailSystem.registerTrail(e.id,s),i=!0),!i&&this.world&&this.world.systemManager){const o=this.world.systemManager.getSystem("TrailSystem");o&&(o.registerTrail(e.id,s),i=!0)}return i||console.log("No trail system found - initializing trail component directly"),console.log(`Added thruster trail component to entity ${e.id} at position (${t.position.x.toFixed(0)}, ${t.position.y.toFixed(0)}, ${t.position.z.toFixed(0)})`),s}createSpectralDroneMesh(){if(console.log("Creating spectral drone from GLB model..."),!this.modelCache.enemyDrone){console.warn("Enemy model not loaded yet - using temporary placeholder");const l=new ee(1,1,1),c=new F({color:65535,wireframe:!0});return{geometry:l,material:c,isPlaceholder:!0}}const e=this.modelCache.enemyDrone.clone();let t=0;this.currentEntity&&this.currentEntity.visualVariant!==void 0&&(t=this.currentEntity.visualVariant);const s=[{main:52479,emissive:new E(35071)},{main:8939263,emissive:new E(6697983)},{main:65484,emissive:new E(48025)},{main:16724838,emissive:new E(13373764)},{main:16755200,emissive:new E(13404160)},{main:6750003,emissive:new E(4508689)},{main:16751103,emissive:new E(13395660)},{main:16777011,emissive:new E(13421585)},{main:3368703,emissive:new E(1131724)},{main:16724787,emissive:new E(13373713)}],i=Math.floor(Math.random()*s.length),o=s[i];let n=1,a=1,r=!1;switch(t){case 0:n=1+Math.random()*.5;break;case 1:n=.5+Math.sin(Date.now()*.01)*.3,o.emissive.multiplyScalar(.7),a=.85;break;case 2:n=2+Math.sin(Date.now()*.003)*.5,o.emissive.multiplyScalar(1.2),r=!0;break;case 3:n=1.5;const l=Date.now()*.001,c=.8+Math.sin(l)*.2;o.emissive.r*=c,o.emissive.g*=1+(1-c),o.emissive.b*=1+Math.cos(l)*.2;break}if(e.traverse(l=>{l.isMesh&&l.material&&(l.material=l.material.clone(),l.material.color=new E(o.main),l.material.emissive=o.emissive,l.material.emissiveIntensity=n,a<1&&(l.material.transparent=!0,l.material.opacity=a),r&&(l.material.shininess!==void 0&&(l.material.shininess=100),l.material.envMap!==void 0&&(l.material.envMapIntensity=.8)))}),t===2)try{const l=new Ae(1.2,1.5,16),c=new F({color:o.main,transparent:!0,opacity:.6,side:K,blending:$}),d=new C(l,c);d.rotation.x=Math.PI/2,e.add(d),d.userData.update=function(h){d.rotation.z+=h*.5;const u=1+.2*Math.sin(Date.now()*.002);d.scale.set(u,u,u)}}catch(l){console.error("Failed to create elite halo effect:",l)}else if(t===3)try{const l=new G(1.1,16,12),c=new F({color:11197951,transparent:!0,opacity:.3,side:K,blending:$,wireframe:!1}),d=new C(l,c);e.add(d),d.userData.update=function(h){const u=1+.05*Math.sin(Date.now()*.003);d.scale.set(u,u,u),d.material.opacity=.2+.1*Math.sin(Date.now()*.002)}}catch(l){console.error("Failed to create shield effect:",l)}return console.log(`Enemy drone model created with color #${o.main.toString(16)} and variant ${t}`),{model:e,isGLTF:!0}}}class ro{constructor(e){this.world=e}validateEnemyReferences(e){const t=e.size,s=new Set;for(const o of e){const n=this.world.getEntity(o);if(n&&n.hasTag&&n.hasTag("enemy")&&!n.hasTag("pooled"))s.add(o);else if(!n)console.warn(`Removing invalid enemy reference: ${o} - Entity does not exist`);else if(!n.hasTag)console.warn(`Removing invalid enemy reference: ${o} - Entity missing hasTag method`);else if(n.hasTag("enemy"))n.hasTag("pooled")&&(console.warn(`Removing invalid enemy reference: ${o} - Entity is pooled but still has 'enemy' tag`),n.hasTag("enemy")&&(console.log(`Fixing inconsistent tag state: entity ${o} is pooled but still has 'enemy' tag`),n.removeTag("enemy")));else{if(n.tags&&n.tags.has&&n.tags.has("enemy")&&(console.warn(`Entity ${o} has inconsistent tag state: hasTag('enemy')=false but tag exists in Set`),n._syncTagCache&&typeof n._syncTagCache=="function"&&(n._syncTagCache(),console.log(`Fixed tag cache for entity ${o}`),n.hasTag("enemy")))){console.log(`Entity ${o} now properly recognizes 'enemy' tag, keeping in tracking`),s.add(o);continue}console.warn(`Removing invalid enemy reference: ${o} - Entity missing 'enemy' tag. Tags: [${Array.from(n.tags)}]`)}}e.clear();for(const o of s)e.add(o);let i=0;try{if(this.world&&this.world.entityManager){let o=[];if(this.world.entityManager.entitiesByTag&&this.world.entityManager.entitiesByTag.get){o=this.world.entityManager.entitiesByTag.get("enemy")||[],i=o.length;for(const n of o)n&&(n._syncTagCache&&typeof n._syncTagCache=="function"&&n._syncTagCache(),n.hasTag("pooled")?(e.has(n.id)&&(console.log(`Removing pooled enemy from tracking: ${n.id}`),e.delete(n.id)),n.hasTag("enemy")&&(console.log(`Fixing inconsistent tag state: pooled entity ${n.id} still has 'enemy' tag`),n.removeTag("enemy"))):e.has(n.id)||(console.log(`Found untracked enemy: ${n.id}, adding to tracking. Tags: [${[...n.tags]}]`),e.add(n.id)));this.validateEntityManagerTagMaps(e)}}}catch(o){console.error("Error during entity scan:",o)}t!==e.size&&console.log(`Enemy tracking corrected: ${t} -> ${e.size} enemies tracked. Scanned ${i} entities.`)}validateEntityManagerTagMaps(e){if(!(!this.world||!this.world.entityManager||!this.world.entityManager.entitiesByTag))try{const t=this.world.entityManager.entitiesByTag;if(t.has("enemy")){const s=t.get("enemy"),i=[];for(let o=0;o<s.length;o++){const n=s[o];if(!n){i.push(o);continue}(!n.tags||!n.tags.has("enemy"))&&(console.warn(`Entity ${n.id} is in 'enemy' tag map but doesn't have the tag in its Set`),n.addTag?(n.addTag("enemy"),console.log(`Added missing 'enemy' tag to entity ${n.id}`)):i.push(o)),n.hasTag&&n.hasTag("pooled")&&n.hasTag("enemy")&&(console.warn(`Entity ${n.id} has both 'pooled' and 'enemy' tags - removing 'enemy' tag`),n.removeTag("enemy"),i.push(o))}for(let o=i.length-1;o>=0;o--){const n=i[o];s.splice(n,1)}i.length>0&&console.log(`Fixed ${i.length} inconsistencies in EntityManager 'enemy' tag map`)}}catch(t){console.error("Error validating EntityManager tag maps:",t)}}freezeAllEnemies(e){const t=Array.from(e).filter(s=>{const i=this.world.getEntity(s);return i&&!i.hasTag("pooled")});console.log(`Freezing all ${t.length} active enemies...`);for(const s of t){const i=this.world.getEntity(s);if(!i){console.warn(`Enemy ${s} not found when freezing - may have been destroyed`);continue}const o=i.getComponent("RigidbodyComponent");o&&(o.velocity.set(0,0,0),o.angularVelocity&&o.angularVelocity.set(0,0,0),o.isFrozen=!0);const n=i.getComponent("EnemyAIComponent");n&&(n.originalEnabledState===void 0&&(n.originalEnabledState=n.enabled),n.enabled=!1),i.addTag("frozen")}console.log("All enemies frozen successfully")}unfreezeAllEnemies(e){const t=Array.from(e).filter(s=>{const i=this.world.getEntity(s);return i&&!i.hasTag("pooled")});console.log(`Unfreezing all ${t.length} active enemies...`);for(const s of t){const i=this.world.getEntity(s);if(!i){console.warn(`Enemy ${s} not found when unfreezing - may have been destroyed`);continue}const o=i.getComponent("RigidbodyComponent");o&&(o.isFrozen=!1);const n=i.getComponent("EnemyAIComponent");n&&(n.enabled=n.originalEnabledState!==void 0?n.originalEnabledState:!0),i.hasTag&&i.hasTag("frozen")&&i.removeTag("frozen")}console.log("All enemies unfrozen successfully")}enforceEnemyLimit(e,t,s){const i=[...e],o=e.size-t;if(!(o<=0)){console.log(`Enforcing enemy limit by removing ${o} excess enemies`);for(let n=0;n<o&&n<i.length;n++){const a=i[n],r=this.world.getEntity(a);if(r){console.log(`Force destroying excess enemy ${a}`),e.delete(a);const l=r.getComponent("HealthComponent");if(l&&(l.health=0,l.isDestroyed=!0),this.world&&this.world.messageBus){const c=r.getComponent("TransformComponent");c&&this.world.messageBus.publish("vfx.explosion",{position:c.position.clone(),scale:1,duration:1})}s(r)}else e.delete(a)}this.validateEnemyReferences(e)}}clearAllEnemies(e){console.log(`Clearing all enemies. Current count: ${e.size}`),e.clear(),console.log(`After clearing, enemy count: ${e.size}`)}processEntityUpdate(e,t){const s=e.getComponent("EnemyAIComponent");if(!s)return;const i=e.getComponent("TransformComponent");if(!i)return;const o=e.getComponent("MeshComponent");if(o&&o.mesh&&(o.mesh.visible=!0,!o.mesh.parent&&this.world.scene&&(console.log("Adding enemy mesh to scene"),this.world.scene.add(o.mesh),o.onAddedToScene&&o.onAddedToScene(this.world.scene)),o.mesh.position.copy(i.position),o.mesh.quaternion.copy(i.quaternion),o.mesh.scale.copy(i.scale),(e.visualVariant===2||e.visualVariant===3)&&(o.mesh.traverse(a=>{a.userData&&typeof a.userData.update=="function"&&a.userData.update(t)}),e.visualVariant===2&&e.eliteParticleTime===void 0?e.eliteParticleTime=0:e.visualVariant===2&&(e.eliteParticleTime+=t,e.eliteParticleTime>1.5&&(e.eliteParticleTime=0,this.world&&this.world.messageBus&&this.world.messageBus.publish("vfx.pulse",{position:i.position.clone(),color:11206655,scale:.7,duration:.8})))),e.visualVariant===1&&o.mesh.material))if(Array.isArray(o.mesh.material))for(const a of o.mesh.material)a.emissiveIntensity=.5+Math.sin(Date.now()*.01)*.3;else o.mesh.material.emissiveIntensity!==void 0&&(o.mesh.material.emissiveIntensity=.5+Math.sin(Date.now()*.01)*.3);s.update(t);const n=e.getComponent("HealthComponent");n&&n.update(t)}}class lo extends De{constructor(e){super(e),this.requiredComponents=["EnemyAIComponent","TransformComponent"],this.priority=40,this.enemies=new Set,this.maxEnemies=10,this.spawnTimer=0,this.spawnInterval=3,this.lastSpawnTime=Date.now(),this.initialSpawnDelay=60,this.initialSpawnTimer=0,this.initialSpawnComplete=!1,this.poolManager=new no(e),this.spawner=new ao(e),this.lifecycle=new ro(e),this.playerIsDocked=!1,this.enemiesDestroyed=0,this.lastSpawnCheckTime=Date.now(),this.spawnCheckInterval=1e4,this.SEPARATION_FORCE_MAGNITUDE=150,this.separationThresholdMultiplier=2.5,this.spatialGrid={cellSize:200,cells:new Map},this.setupEventListeners(),this.lifecycle.clearAllEnemies(this.enemies),this.lifecycle.validateEnemyReferences(this.enemies),this.startSpawnMonitoring(),console.log("Enemy system initialized with faster spawn rate and object pooling")}setupEventListeners(){this.world.messageBus.subscribe("entity.destroyed",this.handleEntityDestroyed.bind(this)),this.world.messageBus.subscribe("player.docked",this.handlePlayerDocked.bind(this)),this.world.messageBus.subscribe("player.undocked",this.handlePlayerUndocked.bind(this)),console.log("Enemy system: Event listeners set up for player docking/undocking")}handlePlayerDocked(e){console.log("Enemy system detected player docked - freezing enemies"),this.playerIsDocked=!0,this.lifecycle.freezeAllEnemies(this.enemies),console.log(`Froze ${this.enemies.size} enemies due to player docking`)}handlePlayerUndocked(e){console.log("Enemy system detected player undocked - resuming enemy activities"),this.playerIsDocked=!1,this.lifecycle.unfreezeAllEnemies(this.enemies),console.log(`Unfroze ${this.enemies.size} enemies due to player undocking`)}update(e){if(window.game&&window.game.spaceship&&window.game.spaceship.isDocked!==void 0&&this.playerIsDocked!==window.game.spaceship.isDocked&&(console.log(`Enemy system syncing docked state from global: ${window.game.spaceship.isDocked}`),this.playerIsDocked=window.game.spaceship.isDocked,this.playerIsDocked?this.lifecycle.freezeAllEnemies(this.enemies):this.lifecycle.unfreezeAllEnemies(this.enemies)),!this.playerIsDocked){if(super.update(e),this._lastDiagnosticTime||(this._lastDiagnosticTime=0),this._lastDiagnosticTime+=e,this._lastDiagnosticTime>=3&&(this.poolManager.runPoolDiagnostics(this.enemies),this._lastDiagnosticTime=0),this.lifecycle.validateEnemyReferences(this.enemies),this.updateDifficultyScaling(),this.enemies.size>this.maxEnemies&&(console.warn(`ENFORCING ENEMY LIMIT: Current count ${this.enemies.size} exceeds limit of ${this.maxEnemies}`),this.lifecycle.enforceEnemyLimit(this.enemies,this.maxEnemies,t=>this.poolManager.returnEnemyToPool(t,this.enemies))),!this.initialSpawnComplete){if(this.initialSpawnTimer+=e,Math.floor(this.initialSpawnTimer)%10===0&&Math.floor(this.initialSpawnTimer)>0){const t=Math.ceil(this.initialSpawnDelay-this.initialSpawnTimer);console.log(`Initial spawn delay: ${t} seconds remaining`)}if(this.initialSpawnTimer>=this.initialSpawnDelay)this.initialSpawnComplete=!0,console.log("Initial spawn delay complete. Spectral drones beginning to spawn."),window.mainMessageBus&&window.mainMessageBus.publish("ui.notification",{message:"WARNING: Spectral drones have been spotted in the sector!",duration:5e3}),window.game&&window.game.ui&&window.game.ui.showNotification&&window.game.ui.showNotification("WARNING: Spectral drones have been spotted in the sector!",5e3);else return}(this.spawnTimer>this.spawnInterval*.9||this.enemies.size===0)&&console.log(`Spawn status: ${this.enemies.size}/${this.maxEnemies} enemies, timer: ${this.spawnTimer.toFixed(1)}/${this.spawnInterval} seconds`),this.spawner.update(e,this.enemies,this.maxEnemies,t=>this.spawnSpectralDrone(t)),this.enemies.size===0&&this.spawnTimer>this.spawnInterval*2&&(console.warn("FAILSAFE: No enemies detected for extended period. Resetting spawn system."),this.enemies.clear(),this.spawner.generateSpawnPoints(),this.spawnTimer=this.spawnInterval)}}updateDifficultyScaling(){if(window.game&&window.game.isHordeActive){this.applyHordeModeScaling();return}if(window.game&&window.game.difficultyManager&&window.game.difficultyManager.params){const e=window.game.difficultyManager.params;e.maxEnemies!==void 0&&this.maxEnemies!==e.maxEnemies&&(console.log(`Updating max enemies from ${this.maxEnemies} to ${e.maxEnemies}`),this.maxEnemies=e.maxEnemies),e.spawnInterval!==void 0&&this.spawnInterval!==e.spawnInterval&&(console.log(`Updating spawn interval from ${this.spawnInterval} to ${e.spawnInterval}`),this.spawnInterval=e.spawnInterval)}}applyHordeModeScaling(){if(!window.game||window.game.hordeSurvivalTime===void 0)return;const e=window.game.hordeSurvivalTime/1e3;Math.floor(e)%10===0&&Math.floor(e)!==this.lastLoggedHordeTime&&(this.lastLoggedHordeTime=Math.floor(e),console.log(`HORDE MODE: Scaling at ${e.toFixed(1)}s survival time`));const t=e/60,s=50;let i;t<5?i=s+t*10:i=(s+50)*Math.pow(1.2,t-5),this.maxEnemies=Math.min(Math.floor(i),300);const o=.2,n=1;if(this.spawnInterval=Math.max(n*Math.pow(.95,t*2),o),this.spawner){const c=1+t*.5,d=1+t*.3,h=1+t*.2;this.spawner.enemyConfig.health=Math.floor(20*c),this.spawner.enemyConfig.damage=Math.floor(15*d),this.spawner.enemyConfig.speed=700*h,Math.floor(e)%30===0&&Math.floor(e)!==this.lastFullLoggedHordeTime&&(this.lastFullLoggedHordeTime=Math.floor(e),console.log(`HORDE MODE SCALING at ${Math.floor(e)}s:`),console.log(`  Max Enemies: ${this.maxEnemies}`),console.log(`  Spawn Interval: ${this.spawnInterval.toFixed(2)}s`),console.log(`  Enemy Health: ${this.spawner.enemyConfig.health}`),console.log(`  Enemy Damage: ${this.spawner.enemyConfig.damage}`),console.log(`  Enemy Speed: ${this.spawner.enemyConfig.speed.toFixed(1)}`))}}processEntity(e,t){this.lifecycle.processEntityUpdate(e,t),this.applySeparationBehavior(e,t)}applySeparationBehavior(e,t){const s=e.getComponent("TransformComponent"),i=e.getComponent("RigidbodyComponent"),o=e.getComponent("EnemyAIComponent");if(!s||!i||!o||i.isFrozen)return;const n=this.calculateSeparationForce(e,s,i);n.lengthSq()>.01?(o.setSeparationForce(n),i.applyForce(n)):o.setSeparationForce(new y)}calculateSeparationForce(e,t,s){const i=new y,o=s.collisionRadius*this.separationThresholdMultiplier,n=this.findNearbyEnemies(e,t.position,o);for(const a of n){if(a===e.id)continue;const r=this.world.getEntity(a);if(!r)continue;const l=r.getComponent("TransformComponent");if(!l)continue;const c=t.position.clone().sub(l.position),d=c.length();if(d>=o||d===0)continue;let h=(o-d)/o;c.normalize(),i.add(c.multiplyScalar(h*this.SEPARATION_FORCE_MAGNITUDE))}return i}findNearbyEnemies(e,t,s){const i=new Set;for(const o of this.enemies){if(o===e.id)continue;const n=this.world.getEntity(o);if(!n||n.hasTag("pooled"))continue;const a=n.getComponent("TransformComponent");if(!a)continue;t.distanceTo(a.position)<s&&i.add(o)}return i}handleEntityDestroyed(e){const t=e.entity;if(!t){console.warn("Entity destroyed event received but no entity in message!");return}const s=t.id,i=this.enemies.has(s);if(t.hasTag&&t.hasTag("enemy")||i){console.log(`Enemy destroyed: ${s}`),i&&(this.enemies.delete(s),console.log(`Removed entity ${s} from enemies tracking`));const o=t.getComponent("TrailComponent");if(o)try{typeof o.onDetached=="function"&&o.onDetached(),window.game&&window.game.trailSystem&&window.game.trailSystem.unregisterTrail&&window.game.trailSystem.unregisterTrail(s),o.trailMesh&&o.trailMesh.parent&&o.trailMesh.parent.remove(o.trailMesh),o.trailMesh&&(o.trailMesh.geometry&&o.trailMesh.geometry.dispose(),o.trailMesh.material&&o.trailMesh.material.dispose()),t.removeComponent("TrailComponent"),console.log(`Cleaned up trail component for destroyed enemy ${s}`)}catch(r){console.error(`Error cleaning up trail for entity ${s}:`,r)}const n=t.getComponent("MeshComponent");if(n&&n.mesh)try{n.mesh.parent&&n.mesh.parent.remove(n.mesh)}catch(r){console.error(`Error cleaning up mesh for entity ${s}:`,r)}this.enemiesDestroyed++,console.log(`Enemy ${s} destroyed. Enemies remaining: ${this.enemies.size}/${this.maxEnemies}`),t.hasTag&&t.hasTag("enemy")&&(console.log(`Explicitly removing 'enemy' tag from destroyed entity ${s}`),t.removeTag("enemy"));let a=!1;for(let r=0;r<this.poolManager.enemyPool.length;r++)if(this.poolManager.enemyPool[r]&&this.poolManager.enemyPool[r].id===s){console.warn(`CRITICAL ERROR: Destroyed entity ${s} is already in the pool!`),this.poolManager.enemyPool.splice(r,1),console.log(`Removed entity ${s} from pool to prevent double-pooling`),a=!0;break}a||(this.poolManager.returnEnemyToPool(t,this.enemies),console.log(`Returned enemy ${s} to pool`)),this.enemiesDestroyed%5===0&&(console.log("Regenerating spawn points after multiple enemy destructions"),this.spawner.generateSpawnPoints()),this.enemies.size===0&&(console.log("All enemies destroyed - accelerating next spawn"),this.spawnTimer=Math.max(this.spawnTimer,this.spawnInterval*.8)),this.lifecycle.validateEnemyReferences(this.enemies)}}onDisabled(){this.spawnMonitorInterval&&(clearInterval(this.spawnMonitorInterval),this.spawnMonitorInterval=null,console.log("Spawn monitoring stopped")),this.enemies.clear(),console.log("Enemy system disabled")}startSpawnMonitoring(){this.spawnMonitorInterval=setInterval(()=>{this.checkSpawnSystemHealth()},1e4),console.log("Spawn system monitoring started")}checkSpawnSystemHealth(){const t=(Date.now()-this.lastSpawnTime)/1e3;console.log(`Spawn system health check: ${this.enemies.size}/${this.maxEnemies} enemies, ${t.toFixed(1)}s since last spawn`),t>this.spawnInterval*3&&this.enemies.size<this.maxEnemies&&(console.warn("Spawn system appears stuck! Performing recovery..."),this.enemies.clear(),this.spawner.generateSpawnPoints(),this.spawnTimer=this.spawnInterval,this.lifecycle.validateEnemyReferences(this.enemies),console.log("Spawn system recovery completed"))}spawnSpectralDrone(e){return this.spawner.spawnSpectralDrone(e,this.poolManager,this.enemies,this.maxEnemies)}freezeAllEnemies(){this.lifecycle.freezeAllEnemies(this.enemies)}unfreezeAllEnemies(){this.lifecycle.unfreezeAllEnemies(this.enemies)}}class co extends De{constructor(e,t,s,i){super(e),this.requiredComponents=["TransformComponent","MeshComponent"],this.priority=100,this.scene=t,this.camera=s,this.renderer=null,this.meshEntities=new Map,this.frustum=new mt,this.projScreenMatrix=new V,this.world.messageBus.subscribe("entity.created",this.onEntityCreated.bind(this)),this.world.messageBus.subscribe("entity.destroyed",this.onEntityDestroyed.bind(this)),this.world.messageBus.subscribe("component.added",this.onComponentAdded.bind(this)),console.log("RenderSystem initialized - handling mesh updates only, no rendering")}onComponentAdded(e){const t=e.data.entity,s=e.data.componentType;s!=="MeshComponent"&&s!=="TransformComponent"||this.meshEntities.has(t.id)||(console.log(`RenderSystem: Component ${s} added to entity ${t.id}`),t.getComponent("TransformComponent")&&t.getComponent("MeshComponent")&&(console.log(`Entity ${t.id} now has all required components, adding to scene`),this.addEntityToScene(t)))}initialize(){if(!this.scene||!this.camera){console.error("RenderSystem missing required Three.js scene or camera references");return}this.world.getEntitiesWithComponents(["TransformComponent","MeshComponent"]).forEach(t=>{this.addEntityToScene(t)})}onEntityCreated(e){const t=e.data.entity;console.log(`RenderSystem received entity.created event for entity ${t.id}`),console.log(`Entity ${t.id} components:`,Array.from(t.components.keys()).join(", "));const s=t.getComponent("TransformComponent"),i=t.getComponent("MeshComponent");if(s&&i)console.log(`Entity ${t.id} has required components, adding to scene`),this.addEntityToScene(t);else{console.log(`Entity ${t.id} missing required components (has transform: ${!!s}, has mesh: ${!!i}), will check later`);const o=n=>{var l;if(((l=n.data.entity)==null?void 0:l.id)!==t.id)return;console.log(`Entity ${t.id} got component ${n.data.componentType}`);const a=t.getComponent("TransformComponent"),r=t.getComponent("MeshComponent");a&&r&&(console.log(`Entity ${t.id} now has required components, adding to scene`),this.addEntityToScene(t),this.world.messageBus.unsubscribe("component.added",o))};this.world.messageBus.subscribe("component.added",o)}}onEntityDestroyed(e){const t=e.data.entity;this.meshEntities.has(t.id)&&this.removeEntityFromScene(t)}addEntityToScene(e){const t=e.getComponent("MeshComponent");if(console.log(`Entity ${e.id} components for scene addition:`,Array.from(e.components.keys()).join(", ")),!t||!t.mesh){console.warn(`Entity ${e.id} has no valid mesh to add to scene`),t&&!t.mesh&&console.warn(`Entity ${e.id} has MeshComponent but mesh property is ${t.mesh}`);return}if(t.mesh.geometry?!t.mesh.geometry.boundingSphere&&typeof t.mesh.geometry.computeBoundingSphere=="function"&&t.mesh.geometry.computeBoundingSphere():t.mesh.isGroup&&console.log(`Entity ${e.id} uses a THREE.Group - skipping bounding sphere computation`),!this.scene){console.error(`Cannot add entity ${e.id} mesh to scene - scene reference is missing`);return}this.scene.add(t.mesh),t.mesh.visible=!0;const s=e.getComponent("TransformComponent");s&&(t.mesh.position.copy(s.position),t.mesh.quaternion.copy(s.quaternion),t.mesh.scale.copy(s.scale)),console.log(`Added entity ${e.id} mesh to scene - position: ${t.mesh.position.x.toFixed(0)},${t.mesh.position.y.toFixed(0)},${t.mesh.position.z.toFixed(0)}`),this.meshEntities.set(e.id,e)}removeEntityFromScene(e){const t=e.getComponent("MeshComponent");t.mesh&&t.mesh.parent&&this.scene.remove(t.mesh),this.meshEntities.delete(e.id)}updateFrustum(){if(this.camera)try{if(!this.camera.projectionMatrix||!this.camera.matrixWorldInverse){console.warn("Camera matrices not initialized");return}this.projScreenMatrix=new V,this.projScreenMatrix.multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse),this.frustum=new mt,this.frustum.setFromProjectionMatrix(this.projScreenMatrix)}catch(e){console.error("Error updating frustum:",e),window.DEBUG_MODE=!0}}isVisible(e,t){return window.DEBUG_MODE=!0,!0}update(e){this.updateFrustum(),window.DEBUG_MODE&&this.world.time%5<e&&this.scanForMissingEntities();for(const t of this.meshEntities.values()){const s=t.getComponent("TransformComponent"),i=t.getComponent("MeshComponent");if(!(!s||!i||!i.mesh)){if(!i.mesh.parent&&this.scene&&(console.log(`RenderSystem: Adding missing mesh for entity ${t.id} to scene`),this.scene.add(i.mesh)),i.mesh.position.copy(s.position),i.mesh.quaternion.copy(s.quaternion),i.mesh.scale.copy(s.scale),s.needsUpdate=!1,window.DEBUG_MODE){i.mesh.visible=!0;continue}if(i.visible){let o=500;i.mesh.isGroup?o=500:i.mesh.geometry&&(i.mesh.geometry.boundingSphere?o=i.mesh.geometry.boundingSphere.radius:typeof i.mesh.geometry.computeBoundingSphere=="function"&&(i.mesh.geometry.computeBoundingSphere(),i.mesh.geometry.boundingSphere&&(o=i.mesh.geometry.boundingSphere.radius)));const n=this.isVisible(s.position,o);i.mesh.visible=n}else i.mesh.visible=!1}}window.DEBUG_MODE&&this.world.time%5<e&&console.log(`RenderSystem: ${this.meshEntities.size} entities being managed`)}scanForMissingEntities(){const e=this.world.getEntitiesWithComponents(["TransformComponent","MeshComponent"]);let t=0;e.forEach(s=>{this.meshEntities.has(s.id)||(console.log(`RenderSystem: Found untracked entity ${s.id} with mesh, adding to scene`),this.addEntityToScene(s),t++)}),t>0&&console.log(`RenderSystem: Added ${t} missing entities to tracking`)}onDestroyed(){this.projScreenMatrix=null,this.frustum=null;for(const e of this.meshEntities.values())this.removeEntityFromScene(e);this.meshEntities.clear(),this.scene=null,this.camera=null,this.renderer=null,this.world&&this.world.messageBus&&(this.world.messageBus.unsubscribe("entity.created",this.onEntityCreated.bind(this)),this.world.messageBus.unsubscribe("entity.destroyed",this.onEntityDestroyed.bind(this)),this.world.messageBus.unsubscribe("component.added",this.onComponentAdded.bind(this)))}}class ho extends De{constructor(e){super(e),this.requiredComponents=["TransformComponent","RigidbodyComponent"],this.priority=20,this.cells=new Map,this.cellSize=2e3,this.processedCollisions=new Set,this.entityCells=new Map,this.potentialColliders=new Ee(200),this.cellsToCheck=new Ee(27),this.tempVec1=new y,this.tempVec2=new y,this.collisionNormal=new y,this.relativeVelocity=new y}update(e){this.cells.clear(),this.processedCollisions.clear(),this.entityCells.clear();const t=this.getEntities();for(let s=0;s<t.length;s++)this._insertIntoGrid(t[s]);for(let s=0;s<t.length;s++)this._checkCollisionsOptimized(t[s],e)}_insertIntoGrid(e){const t=e.getComponent("TransformComponent"),s=e.getComponent("RigidbodyComponent");if(!t||!s)return;const i=Math.floor(t.position.x/this.cellSize),o=Math.floor(t.position.y/this.cellSize),n=Math.floor(t.position.z/this.cellSize),a=`${i},${o},${n}`;this.cells.has(a)||this.cells.set(a,[]),this.cells.get(a).push(e),this.entityCells.has(e.id)||this.entityCells.set(e.id,new Set),this.entityCells.get(e.id).add(a);const r=s.collisionRadius,l=e.hasTag("playerProjectile")||e.hasTag("particleProjectile"),d=Math.ceil(r*(l?5:1)/this.cellSize);if(l||d>0){const h=s.velocity||{length:()=>0},u=h.length?Math.min(3,Math.ceil(h.length()/1e3)):1;for(let m=-d;m<=d;m++)for(let f=-d;f<=d;f++)for(let g=-d;g<=d;g++){if(m===0&&f===0&&g===0||l&&u>1&&m*Math.sign(h.x||0)+f*Math.sign(h.y||0)+g*Math.sign(h.z||0)<0)continue;const b=`${i+m},${o+f},${n+g}`;this.cells.has(b)||this.cells.set(b,[]),this.cells.get(b).push(e),this.entityCells.get(e.id).add(b)}}}_checkCollisionsOptimized(e,t){const s=e.getComponent("TransformComponent"),i=e.getComponent("RigidbodyComponent");if(!s||!i||!this.entityCells.has(e.id))return;const o=this.entityCells.get(e.id);this.potentialColliders.clear(),o.forEach(n=>{const a=this.cells.get(n);if(a)for(let r=0;r<a.length;r++){const l=a[r];if(l===e)continue;const c=e.id<l.id?`${e.id}:${l.id}`:`${l.id}:${e.id}`;this.processedCollisions.has(c)||(this.potentialColliders.push(l),this.processedCollisions.add(c))}});for(let n=0;n<this.potentialColliders.length;n++){const a=this.potentialColliders.get(n),r=a.getComponent("TransformComponent"),l=a.getComponent("RigidbodyComponent");!r||!l||this._checkSphereCollision(s.position,i.collisionRadius,r.position,l.collisionRadius)&&(i.isTrigger||l.isTrigger?this._handleTrigger(e,a):this._resolveCollision(e,a,s,i,r,l))}}_checkSphereCollision(e,t,s,i){const o=e.x-s.x,n=e.y-s.y,a=e.z-s.z,r=o*o+n*n+a*a,l=t+i;return r<=l*l}_handleTrigger(e,t){let s=null,i=null;const o=e._isPlayerProjectile||e.hasTag("playerProjectile")||e.hasTag("particleProjectile"),n=t._isEnemy||t.hasTag("enemy")||t.hasComponent("EnemyComponent")||t.hasComponent("EnemyAIComponent");if(o&&n)s=e,i=t;else{const a=t._isPlayerProjectile||t.hasTag("playerProjectile")||t.hasTag("particleProjectile"),r=e._isEnemy||e.hasTag("enemy")||e.hasComponent("EnemyComponent")||e.hasComponent("EnemyAIComponent");a&&r&&(s=t,i=e)}if(s&&i){if(console.log(`DIRECT HIT: Player projectile ${s.id} hit enemy ${i.id}`),i.hasTag("pooled")){console.warn(`Skipping hit on pooled enemy ${i.id}`);return}const a=s.getComponent("TransformComponent"),r=i.getComponent("TransformComponent");if(a&&r){const d=a.position.distanceTo(r.position);console.log(`Hit details: Distance=${d.toFixed(1)}, ProjectilePos=${a.position.x.toFixed(0)},${a.position.y.toFixed(0)},${a.position.z.toFixed(0)}, EnemyPos=${r.position.x.toFixed(0)},${r.position.y.toFixed(0)},${r.position.z.toFixed(0)}`)}const l=i.getComponent("HealthComponent");l&&(console.log(`CRITICAL HIT: Applying 1000 damage to enemy ${i.id}`),l.applyDamage(1e3,"particle",s),l.isDestroyed?console.log("ENEMY DESTROYED CONFIRMED! Health reached zero and isDestroyed=true"):(console.error("ERROR: Enemy not destroyed after particle hit! Sending entity.destroyed event..."),l.isDestroyed=!0,l.health=0,this.world.messageBus.publish("entity.destroyed",{entity:i,source:s,damageType:"particle"})));let c=null;try{c=s.getComponent("TransformComponent").position.clone()}catch{try{c=i.getComponent("TransformComponent").position.clone()}catch{c=new y(0,0,0)}}this.world.messageBus.publish("collision.trigger",{entityA:s,entityB:i,projectileHit:!0}),this.world.messageBus.publish("projectile.hit",{projectile:s,target:i,position:c}),this.world.destroyEntity(s.id)}else this.world.messageBus.publish("collision.trigger",{entityA:e,entityB:t})}_resolveCollision(e,t,s,i,o,n){this.collisionNormal.copy(s.position).sub(o.position).normalize(),this.relativeVelocity.copy(i.velocity).sub(n.velocity);const a=this.relativeVelocity.dot(this.collisionNormal);if(a>0)return;const r=i.isKinematic?0:1/i.mass,l=n.isKinematic?0:1/n.mass,c=-1.3*a/(r+l);this.tempVec1.copy(this.collisionNormal).multiplyScalar(c*r),this.tempVec2.copy(this.collisionNormal).multiplyScalar(c*l),i.velocity.sub(this.tempVec1),n.velocity.add(this.tempVec2);const d=.2,h=.01,u=s.position.distanceToSquared(o.position),f=i.collisionRadius+n.collisionRadius-Math.sqrt(u);if(f>h){const g=Math.max(f-h,0)/(r+l)*d;this.tempVec1.copy(this.collisionNormal).multiplyScalar(g*r),this.tempVec2.copy(this.collisionNormal).multiplyScalar(g*l),s.position.sub(this.tempVec1),o.position.add(this.tempVec2)}}}class uo extends De{constructor(e){super(e),this.priority=70,this.activeEffects=new Map,this.effectCounter=0,this.setupEventListeners(),console.log("VisualEffectsSystem initialized")}setupEventListeners(){this.world.messageBus.subscribe("vfx.explosion",this.handleExplosionRequest.bind(this)),this.world.messageBus.subscribe("vfx.damageFlash",this.handleDamageFlashRequest.bind(this))}update(e){for(const[t,s]of this.activeEffects.entries())s.update(e)||this.removeEffect(t)}handleExplosionRequest(e){if(!e||!e.data||!e.data.position){console.error("Invalid explosion effect request",e);return}const t=e.data.position,s=e.data.scale||1,i=e.data.duration||2;this.createExplosionEffect(t,s,i),window.game&&window.game.audio&&window.game.audio.playSound("boink")}handleDamageFlashRequest(e){const t=e&&e.data&&e.data.intensity?e.data.intensity:.3;this.createDamageFlashEffect(t)}createExplosionEffect(e,t=1,s=2){if(!this.world.scene)return console.error("No scene available for explosion effect"),-1;const i=new O;i.position.copy(e),i.scale.set(t,t,t);const o=Math.floor(20*t),n=[],a=window.objectPool&&window.objectPool.pools&&window.objectPool.pools.explosionParticle;for(let c=0;c<o;c++){let d;const h=Math.random()*2+1;if(a){if(d=window.objectPool.get("explosionParticle"),d){const u=Math.random()*10,m=Math.random()*Math.PI*2,f=Math.random()*Math.PI,g=new y(u*Math.sin(f)*Math.cos(m),u*Math.sin(f)*Math.sin(m),u*Math.cos(f));d.reset(g,h,16733440),d.velocity.copy(g).normalize().multiplyScalar(Math.random()*2+1),i.add(d.mesh),n.push(d)}}else{const u=window.game&&window.game.explosionGeometry?window.game.explosionGeometry:new G(h,8,8),m=window.game&&window.game.explosionMaterial?window.game.explosionMaterial.clone():new F({color:16733440,transparent:!0,opacity:.8}),f=new C(u,m),g=Math.random()*10,b=Math.random()*Math.PI*2,w=Math.random()*Math.PI;f.position.set(g*Math.sin(w)*Math.cos(b),g*Math.sin(w)*Math.sin(b),g*Math.cos(w)),f.userData.velocity=f.position.clone().normalize().multiplyScalar(Math.random()*2+1),i.add(f),n.push({mesh:f,material:m,velocity:f.userData.velocity})}}this.world.scene.add(i);const r=this.effectCounter++,l={id:r,type:"explosion",container:i,particles:n,duration:s,elapsed:0,usePooling:a,update:c=>{if(l.elapsed+=c,l.elapsed>=l.duration)return l.usePooling&&l.particles.forEach(h=>{window.objectPool.release("explosionParticle",h)}),this.world.scene.remove(i),!1;const d=l.elapsed/l.duration;return l.particles.forEach(h=>{l.usePooling,h.mesh.position.add(h.velocity.clone().multiplyScalar(c)),h.material.opacity=.8*(1-d),h.mesh.scale.multiplyScalar(.99)}),!0}};return this.activeEffects.set(r,l),r}createDamageFlashEffect(e=.3){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor=`rgba(255, 0, 0, ${e})`,t.style.pointerEvents="none",t.style.zIndex="1000",t.style.opacity="1",t.style.transition="opacity 0.2s ease-out",document.body.appendChild(t);const s=this.effectCounter++,i={id:s,type:"damageFlash",element:t,duration:.3,elapsed:0,update:o=>{if(i.elapsed+=o,i.elapsed>=i.duration)return document.body.contains(t)&&document.body.removeChild(t),!1;const n=i.elapsed/i.duration;return t.style.opacity=(1-n).toString(),!0}};return this.activeEffects.set(s,i),s}removeEffect(e){const t=this.activeEffects.get(e);t&&(t.type==="explosion"?t.container&&this.world.scene&&this.world.scene.remove(t.container):t.type==="damageFlash"&&t.element&&document.body.contains(t.element)&&document.body.removeChild(t.element),this.activeEffects.delete(e))}onDisabled(){for(const e of this.activeEffects.keys())this.removeEffect(e);this.activeEffects.clear()}}class we{constructor(e,t,s=20,i=10){this.createFn=e,this.resetFn=t,this.expandSize=i,this.pool=[],this.active=new Set,this.expand(s),console.log(`ObjectPool created with ${s} objects`)}get(){let e;return this.pool.length===0&&(console.log(`Pool empty, expanding by ${this.expandSize} objects`),this.expand(this.expandSize)),e=this.pool.pop(),this.active.add(e),e}release(e){this.active.has(e)&&(this.resetFn(e),this.active.delete(e),this.pool.push(e))}expand(e){for(let t=0;t<e;t++){const s=this.createFn();this.pool.push(s)}}availableCount(){return this.pool.length}activeCount(){return this.active.size}releaseAll(){const e=Array.from(this.active);for(const t of e)this.release(t)}dispose(e){if(e){for(const t of this.active)e(t);for(const t of this.pool)e(t)}this.active.clear(),this.pool=[]}}class po{constructor(e,t){this.scene=e,this.sharedAssets=t,this.projectileGeometry=this.sharedAssets.projectileGeometry,this.projectileGlowGeometry=this.sharedAssets.projectileGlowGeometry,this.muzzleFlashGeometry=this.sharedAssets.muzzleFlashGeometry,this.trailParticleGeometries=this.sharedAssets.trailParticleGeometries,this.tracerGeometry=this.sharedAssets.tracerGeometry,this.projectileMaterial=this.sharedAssets.projectileMaterial,this.projectileGlowMaterial=this.sharedAssets.projectileGlowMaterial,this.trailParticleMaterial=this.sharedAssets.trailParticleMaterial,this.muzzleFlashMaterial=this.sharedAssets.muzzleFlashMaterial,this.tracerLineMaterial=this.sharedAssets.tracerLineMaterial,this.explosionParticleMaterial=this.sharedAssets.explosionParticleMaterial,this.populateWindowGameWithSharedAssets(),this.initializePools(),console.log("ProjectilePoolManager initialized using pre-warmed shared assets and pools")}populateWindowGameWithSharedAssets(){window.game||(window.game={}),window.game.projectileGeometry=this.projectileGeometry,window.game.projectileGlowGeometry=this.projectileGlowGeometry,window.game.muzzleFlashGeometry=this.muzzleFlashGeometry,window.game.trailParticleGeometries=this.trailParticleGeometries,window.game.tracerGeometry=this.tracerGeometry,window.game.projectileMaterial=this.projectileMaterial,window.game.projectileGlowMaterial=this.projectileGlowMaterial,window.game.trailParticleMaterial=this.trailParticleMaterial,window.game.muzzleFlashMaterial=this.muzzleFlashMaterial,window.game.tracerLineMaterial=this.tracerLineMaterial,window.game.explosionParticleMaterial=this.explosionParticleMaterial}initializePools(){this.projectilePool=new we(()=>{const e=new C(this.projectileGeometry,this.projectileMaterial.clone()),t=new C(this.projectileGlowGeometry,this.projectileGlowMaterial.clone());return e.add(t),e.userData={isProjectile:!0,active:!1,pooled:!0,glowMesh:t},e},e=>{e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1),e.visible=!1,e.userData.active=!1,e.userData.creationTime=0,e.userData.entityId=null,e.userData.trail=null,e.userData.trailParticles=null},30,10),this.explosionPool=new we(()=>{const t=new j,s=new Float32Array(200*3);for(let n=0;n<200;n++){const a=n*3;s[a]=(Math.random()-.5)*100,s[a+1]=(Math.random()-.5)*100,s[a+2]=(Math.random()-.5)*100}t.setAttribute("position",new _(s,3));const i=this.explosionParticleMaterial.clone(),o=new Z(t,i);return o.userData={isExplosion:!0,active:!1,pooled:!0,startTime:0,duration:1e3,particleCount:200},o},e=>{e.position.set(0,0,0),e.visible=!1,e.material.opacity=1,e.userData.active=!1,e.userData.startTime=0;const t=e.geometry.attributes.position.array,s=e.userData.particleCount;for(let i=0;i<s;i++){const o=i*3;t[o]=(Math.random()-.5)*100,t[o+1]=(Math.random()-.5)*100,t[o+2]=(Math.random()-.5)*100}e.geometry.attributes.position.needsUpdate=!0},10,5),this.muzzleFlashPool=new we(()=>{const e=new C(this.muzzleFlashGeometry,this.muzzleFlashMaterial.clone());e.userData={isMuzzleFlash:!0,active:!1,pooled:!0,startTime:0,flashLight:null};const t=new xe(65535,200,10,2);return t.visible=!1,this.scene.add(t),e.userData.flashLight=t,e},e=>{e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1),e.visible=!1,e.material.opacity=.7;const t=e.userData.flashLight;t&&(t.position.set(0,0,0),t.intensity=200,t.visible=!1),e.userData.active=!1,e.userData.startTime=0},20,5),this.trailContainerPool=new we(()=>{const e=new Pe;return e.userData={isTrail:!0,active:!1,pooled:!0,particles:[]},e},e=>{e.position.set(0,0,0),e.rotation.set(0,0,0),e.visible=!1,e.userData.active=!1,e.userData.parentProjectile=null},30,10),this.trailParticlePool=new we(()=>{const e=new C(this.trailParticleGeometries[0],this.trailParticleMaterial.clone());return e.userData={isTrailParticle:!0,active:!1,pooled:!0,sizeIndex:0,initialOffset:new y},e},e=>{e.position.set(0,0,0),e.visible=!1,e.material.opacity=.9,e.userData.active=!1,e.userData.sizeIndex=0,e.userData.initialOffset.set(0,0,0),e.userData.initialOpacity=.9},600,100),this.tracerPool=new we(()=>{const e=new Te(this.tracerGeometry.clone(),this.tracerLineMaterial.clone());return e.userData={isTracer:!0,active:!1,pooled:!0,startTime:0},e},e=>{e.position.set(0,0,0),e.visible=!1,e.material.opacity=.6,e.userData.active=!1,e.userData.startTime=0},20,5)}getProjectile(){const e=this.projectilePool.get();return e.visible=!0,e.userData.active=!0,e.userData.creationTime=performance.now(),e.parent||this.scene.add(e),e}getMuzzleFlash(){const e=this.muzzleFlashPool.get();e.visible=!0,e.userData.active=!0,e.userData.startTime=performance.now();const t=e.userData.flashLight;return t&&(t.visible=!0,t.intensity=200),e.parent||this.scene.add(e),e}getTrailContainer(){const e=this.trailContainerPool.get();return e.visible=!0,e.userData.active=!0,e}getTrailParticle(e=0){const t=this.trailParticlePool.get();return t.visible=!0,t.userData.active=!0,t.userData.sizeIndex=e,e>=0&&e<this.trailParticleGeometries.length&&(t.geometry=this.trailParticleGeometries[e]),t}getTracer(){const e=this.tracerPool.get();return e.visible=!0,e.userData.active=!0,e.userData.startTime=performance.now(),e.parent||this.scene.add(e),e}getExplosion(e,t=1e3){const s=this.explosionPool.get();return s.position.copy(e),s.visible=!0,s.userData.active=!0,s.userData.startTime=Date.now(),s.userData.duration=t,s.parent||this.scene.add(s),s}releaseProjectile(e){!e||!e.userData||!e.userData.isProjectile||(e.userData.trail&&(this.releaseTrail(e.userData.trail),e.remove(e.userData.trail),e.userData.trail=null,e.userData.trailParticles=null),e.parent&&e.parent.remove(e),this.projectilePool.release(e))}releaseMuzzleFlash(e){if(!e||!e.userData||!e.userData.isMuzzleFlash)return;const t=e.userData.flashLight;t&&(t.visible=!1),e.parent&&e.parent.remove(e),this.muzzleFlashPool.release(e)}releaseTrail(e){if(!(!e||!e.userData||!e.userData.isTrail)){if(e.userData.particles)for(const t of e.userData.particles)t&&(e.remove(t),this.releaseTrailParticle(t));e.userData.particles=[],this.trailContainerPool.release(e)}}releaseTrailParticle(e){!e||!e.userData||!e.userData.isTrailParticle||this.trailParticlePool.release(e)}releaseTracer(e){!e||!e.userData||!e.userData.isTracer||(e.parent&&e.parent.remove(e),this.tracerPool.release(e))}releaseExplosion(e){!e||!e.userData||!e.userData.isExplosion||(e.parent&&e.parent.remove(e),this.explosionPool.release(e))}update(e){this.updateMuzzleFlashes(e),this.updateTracers(e),this.updateExplosions(e)}updateMuzzleFlashes(e){for(const t of this.muzzleFlashPool.active){const o=(performance.now()-t.userData.startTime)/70;if(o>=1)this.releaseMuzzleFlash(t);else{const n=Math.min(o*2.5,1),a=300;if(t.userData.initialPosition&&t.userData.direction){const l=t.userData.initialPosition.clone().add(t.userData.direction.clone().multiplyScalar(a*n));t.position.copy(l),t.userData.flashLight&&t.userData.flashLight.position.copy(l)}t.material.opacity=.7*(1-o),t.userData.flashLight&&(t.userData.flashLight.intensity=200*(1-o*3));const r=1+o*1.5;t.scale.set(1,1,r)}}}updateTracers(e){for(const t of this.tracerPool.active){performance.now()-t.userData.startTime;const i=Math.max(0,t.material.opacity-1.5*.016);i<=0?this.releaseTracer(t):t.material.opacity=i}}updateExplosions(e){for(const t of this.explosionPool.active){const s=Date.now()-t.userData.startTime,i=t.userData.duration,o=s/i;if(o>=1)this.releaseExplosion(t);else{const n=t.geometry.attributes.position.array,a=t.userData.particleCount;for(let r=0;r<a;r++){const l=r*3,c=n[l]*(1+o*5),d=n[l+1]*(1+o*5),h=n[l+2]*(1+o*5);t.geometry.attributes.position.array[l]=c,t.geometry.attributes.position.array[l+1]=d,t.geometry.attributes.position.array[l+2]=h}t.geometry.attributes.position.needsUpdate=!0,t.material.opacity=1-o}}}dispose(){this.projectileGeometry.dispose(),this.projectileGlowGeometry.dispose(),this.muzzleFlashGeometry.dispose(),this.tracerGeometry.dispose(),this.trailParticleGeometries.forEach(e=>e.dispose()),this.projectileMaterial.dispose(),this.projectileGlowMaterial.dispose(),this.trailParticleMaterial.dispose(),this.muzzleFlashMaterial.dispose(),this.tracerLineMaterial.dispose(),this.projectilePool.dispose(e=>{e.parent&&e.parent.remove(e),e.userData.glowMesh&&e.userData.glowMesh.material&&e.userData.glowMesh.material.dispose(),e.material&&e.material.dispose()}),this.muzzleFlashPool.dispose(e=>{e.parent&&e.parent.remove(e),e.userData.flashLight&&e.userData.flashLight.parent&&e.userData.flashLight.parent.remove(e.userData.flashLight),e.material&&e.material.dispose()}),this.trailContainerPool.dispose(e=>{e.parent&&e.parent.remove(e)}),this.trailParticlePool.dispose(e=>{e.parent&&e.parent.remove(e),e.material&&e.material.dispose()}),this.tracerPool.dispose(e=>{e.parent&&e.parent.remove(e),e.material&&e.material.dispose()}),console.log("ProjectilePoolManager disposed all pools and shared assets")}}class Co{constructor(e,t){console.log("Initializing combat system"),this.scene=e,this.spaceship=t,this.projectiles=[],this.projectileLifetime=2e3,this.fireRate=3,this.projectileSpeed=3e4,this.lastFireTime=0,this.aimingSpread=.05,this.isFiring=!1,this.cooldown=1e3/this.fireRate,this.projectileDamage=20,this.initializeTemplateMaterials(),this.precreateGeometries(),this.poolManager=new po(e,{projectileMaterial:this.projectileMaterial,projectileGlowMaterial:this.projectileGlowMaterial,trailParticleMaterial:this.trailParticleMaterial,muzzleFlashMaterial:this.muzzleFlashMaterial,tracerLineMaterial:this.tracerLineMaterial,explosionParticleMaterial:this.explosionParticleMaterial,projectileGeometry:window.game.projectileGeometry,projectileGlowGeometry:window.game.projectileGlowGeometry,muzzleFlashGeometry:window.game.muzzleFlashGeometry,trailParticleGeometries:window.game.trailParticleGeometries,tracerGeometry:window.game.tracerGeometry}),console.log("Initialized ProjectilePoolManager for object pooling with pre-warmed assets"),this.initializeECSWorld(),console.log("Combat systems initialized")}initializeTemplateMaterials(){console.log("Initializing template materials for combat effects"),this.projectileMaterial=new R({color:16711680,emissive:16711680,emissiveIntensity:10,metalness:.5,roughness:.5}),this.projectileGlowMaterial=new F({color:16711680,transparent:!0,opacity:.5,blending:$}),this.trailParticleMaterial=new F({color:16711680,transparent:!0,opacity:.9,blending:$}),this.muzzleFlashMaterial=new F({color:16711680,transparent:!0,opacity:.8,blending:$,side:K,depthWrite:!1,wireframe:!1}),this.tracerLineMaterial=new Me({color:16711680,transparent:!0,opacity:.8,blending:$}),this.pointLightMaterial=new F({color:16711680,emissive:16711680,emissiveIntensity:1}),this.explosionParticleMaterial=new te({color:16724736,size:15,transparent:!0,opacity:1,blending:$});const e=new ee(.1,.1,.1),t=new G(.1,8,8),s=new ge(.1,.2,1,8,1),i=new Float32Array(30);for(let m=0;m<30;m++)i[m]=Math.random()-.5;const o=new j;o.setAttribute("position",new _(i,3));const n=new C(t,this.projectileMaterial),a=new C(t,this.projectileGlowMaterial),r=new C(t,this.trailParticleMaterial),l=new C(s,this.muzzleFlashMaterial),c=new Te(new j().setFromPoints([new y(0,0,0),new y(0,0,1)]),this.tracerLineMaterial),d=new Z(o,this.explosionParticleMaterial),h=new Pe;for(let m=0;m<5;m++){const f=new C(t,this.trailParticleMaterial.clone());f.position.z=-m*.2,h.add(f)}const u=new Ft;u.add(n),u.add(a),u.add(r),u.add(l),u.add(c),u.add(h),u.add(d),this.scene.add(n),this.scene.add(a),this.scene.add(r),this.scene.add(l),this.scene.add(c),this.scene.add(h),this.scene.add(d),window.renderer?(console.log("Forcing shader compilation with renderer.compile()"),window.renderer.compile(u,this.scene.camera||{isCamera:!0,matrixWorldInverse:new V}),window.renderer.compile(this.scene,this.scene.camera||{isCamera:!0,matrixWorldInverse:new V})):window.game&&window.game.renderer&&window.game.renderer.renderer?(console.log("Forcing shader compilation with game.renderer.renderer.compile()"),window.game.renderer.renderer.compile(u,this.scene.camera||window.game.camera||{isCamera:!0,matrixWorldInverse:new V}),window.game.renderer.renderer.compile(this.scene,this.scene.camera||window.game.camera||{isCamera:!0,matrixWorldInverse:new V})):console.warn("No renderer available for shader pre-compilation"),setTimeout(()=>{this.scene.remove(n),this.scene.remove(a),this.scene.remove(r),this.scene.remove(l),this.scene.remove(c),this.scene.remove(h),this.scene.remove(d),e.dispose(),t.dispose(),s.dispose(),o.dispose(),h.children.forEach(m=>{m.geometry&&m.geometry.dispose(),m.material&&m.material.dispose()}),console.log("Template materials initialized and dummy objects removed")},500)}precreateGeometries(){console.log("Pre-creating geometries for combat effects"),window.game||(window.game={}),window.game.projectileGeometry=new ge(.15,.15,10,8),window.game.projectileGlowGeometry=new G(.8,12,12),window.game.muzzleFlashGeometry=new ge(.5,2,15,12,1,!0),window.game.muzzleFlashGeometry.rotateX(Math.PI/2),window.game.muzzleFlashGeometry.translate(0,0,15/2),window.game.trailParticleGeometries=[];const e=20;for(let s=0;s<e;s++){const o=.5*(1-s/e);window.game.trailParticleGeometries[s]=new G(o,8,8)}window.game.tracerGeometry=new j;const t=[0,0,0,0,0,1];window.game.tracerGeometry.setAttribute("position",new et(t,3)),window.game.projectileMaterial=this.projectileMaterial,window.game.projectileGlowMaterial=this.projectileGlowMaterial,window.game.trailParticleMaterial=this.trailParticleMaterial,window.game.muzzleFlashMaterial=this.muzzleFlashMaterial,window.game.tracerLineMaterial=this.tracerLineMaterial,window.game.explosionParticleMaterial=this.explosionParticleMaterial,console.log("Combat geometries pre-created successfully")}async initializeECSWorld(){try{console.log("[COMBAT] Starting ECS world initialization..."),this.world=new to(window.mainMessageBus),console.log("[COMBAT] Created world with messageBus: ",this.world.messageBus===window.mainMessageBus?"Using shared messageBus":"Created new messageBus"),window.game&&(window.game.ecsWorld=this.world,console.log("[COMBAT] Made ECS world globally available via window.game.ecsWorld")),await this.createPlayerReferenceEntity(),await this.setupECSWorld(),console.log("[COMBAT] ECS world initialization complete")}catch(e){console.error("[COMBAT] Error initializing ECS world:",e)}}async setupECSWorld(){if(this.worldInitialized){console.log("[COMBAT] World already initialized, skipping setup");return}this.world.scene=this.scene,console.log("[COMBAT] Set scene reference in ECS world for enemy rendering:",this.scene?"Scene available":"No scene available"),console.log("[COMBAT] Registering combat systems with ECS world...");try{this.combatSystem=new io(this.world),this.world.registerSystem(this.combatSystem),this.enemySystem=new lo(this.world),this.world.registerSystem(this.enemySystem),window.game&&(window.game.ecsWorld=window.game.ecsWorld||{},window.game.ecsWorld.enemySystem=this.enemySystem,console.log("[COMBAT] Made enemy system globally available via window.game.ecsWorld.enemySystem")),this.trailSystem=await this.importAndRegisterSystem("../systems/rendering/trailSystem.js","TrailSystem"),this.world.registerSystem(this.trailSystem),this.deployableLaserSystem=await this.importAndRegisterSystem("../systems/weapons/deployableLaserSystem.js","DeployableLaserSystem"),this.world.registerSystem(this.deployableLaserSystem),this.deploymentSystem=await this.importAndRegisterSystem("../systems/deployables/deploymentSystem.js","DeploymentSystem"),this.world.registerSystem(this.deploymentSystem),window.game&&(window.game.trailSystem=this.trailSystem,console.log("[COMBAT] Registered trail system with window.game for global access"));const e=this.scene.camera;e||console.error("[COMBAT] No camera found on scene, enemies may not be visible"),console.log(`[COMBAT] Camera reference for RenderSystem: ${e?"Available":"Missing"}`),this.renderSystem=new co(this.world,this.scene,e),this.world.registerSystem(this.renderSystem),console.log("[COMBAT] Registering CollisionSystem with the world..."),this.collisionSystem=new ho(this.world),this.world.registerSystem(this.collisionSystem),console.log("[COMBAT] CollisionSystem registered"),console.log("[COMBAT] Registering VisualEffectsSystem with the world..."),this.visualEffectsSystem=new uo(this.world),this.world.registerSystem(this.visualEffectsSystem),console.log("[COMBAT] VisualEffectsSystem registered"),this.scene&&(this.scene.ecsWorld=this.world,console.log("[COMBAT] Set ECS world reference in scene for cross-system access"));try{console.log("[COMBAT] Calling world.initialize()..."),this.world.initialize(),console.log("[COMBAT] World initialization completed successfully")}catch(t){console.error("[COMBAT] Error during world.initialize():",t),console.error("[COMBAT] Stack trace:",t.stack),console.log("[COMBAT] Continuing despite initialization error")}await this.createPlayerReferenceEntity(),this.enemySystem&&(this.enemySystem.lifecycle.validateEnemyReferences(this.enemySystem.enemies),this.enemySystem.enemies.size>this.enemySystem.maxEnemies&&(console.warn(`[COMBAT] Found ${this.enemySystem.enemies.size} enemies exceeding limit of ${this.enemySystem.maxEnemies} during setup`),this.enemySystem.enforceEnemyLimit()),this.enemySystem.spawner.generateSpawnPoints(),console.log(`[COMBAT] Configured enemy system: Max enemies ${this.enemySystem.maxEnemies}`)),this.worldInitialized=!0,console.log("[COMBAT] ECS combat systems registered and initialization process completed")}catch(e){console.error("[COMBAT] Error during world setup:",e),console.error("[COMBAT] Stack trace:",e.stack)}}async createPlayerReferenceEntity(){if(!this.world)return console.error("[COMBAT] Cannot create player entity - world not available"),null;if(!this.spaceship)return console.error("[COMBAT] Cannot create player entity - spaceship not available"),null;try{if(console.log("[COMBAT] Creating player reference entity..."),this.playerEntity){const t=this.world.getEntity(this.playerEntity.id);if(t){console.log(`[COMBAT] Player entity already exists with ID: ${this.playerEntity.id}`),t.hasTag("player")||(console.log("[COMBAT] Re-adding 'player' tag to existing entity"),t.addTag("player"));const s=t.getComponent("TransformComponent");return s&&this.spaceship.mesh&&(s.position.copy(this.spaceship.mesh.position),s.rotation.copy(this.spaceship.mesh.rotation),s.quaternion.copy(this.spaceship.mesh.quaternion),typeof s.setUpdated=="function"&&s.setUpdated()),window.game&&(window.game.combat=window.game.combat||{},window.game.combat.playerEntity=t),t}else console.log("[COMBAT] Previous player entity no longer exists, creating new one")}const e=this.world.createEntity("player_"+Date.now());e.addTag("player"),console.log(`[COMBAT] Added 'player' tag to entity ${e.id}`);try{const t=this.spaceship.mesh?this.spaceship.mesh.position.clone():new y,s=new rt(t);e.addComponent(s),console.log(`[COMBAT] Added TransformComponent to player entity with position: ${t.x.toFixed(1)}, ${t.y.toFixed(1)}, ${t.z.toFixed(1)}`)}catch(t){console.error("[COMBAT] Error adding TransformComponent to player entity:",t)}try{const t=new _t(100,50);e.addComponent(t),console.log("[COMBAT] Added HealthComponent to player entity")}catch(t){console.error("[COMBAT] Error adding HealthComponent to player entity:",t)}return this.playerEntity=e,window.game&&(window.game.combat=window.game.combat||{},window.game.combat.playerEntity=e,console.log("[COMBAT] Made player entity globally accessible via window.game.combat.playerEntity")),this.world.playerEntity=e,console.log("[COMBAT] Made player entity available directly via world.playerEntity"),this.world&&this.world.messageBus&&(this.world.messageBus.publish("player.created",{entity:e}),console.log("[COMBAT] Published player.created event")),console.log("[COMBAT] Successfully created player reference entity with ID:",e.id),e}catch(e){return console.error("[COMBAT] Error creating player reference entity:",e),console.error("[COMBAT] Stack trace:",e.stack),null}}update(e){if(!this.scene||!this.spaceship)return;const t=window.game&&window.game.introSequenceActive;if(this.updatePlayerReference(),this.updateSpaceshipHealth(),this.updateProjectiles(e),this.poolManager&&this.poolManager.update(e),this.isFiring&&!this.spaceship.isDocked&&this.fireParticleCannon(),this.world&&!t)this.world.update(e);else if(this.world&&t&&this.world.systems)for(const s of this.world.systems)s.constructor.name!=="EnemySystem"&&s.constructor.name!=="EnemyAISystem"&&s.update(e)}updatePlayerReference(){if(!this.world||!this.spaceship||!this.playerEntity){if(this.world&&this.spaceship&&!this.playerEntity){console.log("No player entity found, creating one..."),this.createPlayerReferenceEntity();return}return}const e=this.world.getEntity(this.playerEntity.id);if(!e){console.warn("Player entity lost, recreating..."),this.createPlayerReferenceEntity();return}const t=e.getComponent("TransformComponent");t&&this.spaceship.mesh&&(t.position.copy(this.spaceship.mesh.position),t.rotation.copy(this.spaceship.mesh.rotation),t.quaternion.copy(this.spaceship.mesh.quaternion),typeof t.setUpdated=="function"&&t.setUpdated());const s=e.getComponent("HealthComponent");s&&this.spaceship.health!==void 0&&(this.spaceship.health>s.health&&(s.health=this.spaceship.health),this.spaceship.shield!==void 0&&this.spaceship.shield>s.shield&&(s.shield=this.spaceship.shield))}updateSpaceshipHealth(){if(!this.playerEntity||!this.spaceship)return;const e=this.playerEntity.getComponent("HealthComponent");e&&(e.health<this.spaceship.hull&&(console.log(`Damage detected in health component: ${e.health} (was ${this.spaceship.hull})`),this.spaceship.hull=e.health),e.shield<this.spaceship.shield&&(console.log(`Shield damage detected in health component: ${e.shield} (was ${this.spaceship.shield})`),this.spaceship.shield=e.shield),e.isDestroyed&&!this.spaceship.isDestroyed&&(console.log("Health component indicates player is destroyed - updating spaceship state"),this.spaceship.isDestroyed=!0,typeof this.spaceship.handleDestruction=="function"&&this.spaceship.handleDestruction()),e.health<=0&&!this.spaceship.isDestroyed&&(console.log("Player health is zero - marking spaceship as destroyed"),this.spaceship.isDestroyed=!0,typeof this.spaceship.handleDestruction=="function"&&this.spaceship.handleDestruction(),window.game&&(console.log("FORCING GAME OVER FROM COMBAT MODULE!"),window.game.gameOver("You were pwned by a space alien!"))))}updateProjectiles(e){for(let t=this.projectiles.length-1;t>=0;t--){const s=this.projectiles[t];if(s.position.add(s.velocity.clone().multiplyScalar(e)),s.userData&&s.userData.entityId&&this.world){const i=this.world.getEntity(s.userData.entityId);if(i)if(typeof i.update=="function")i.update(e);else{const o=i.getComponent("TransformComponent");o&&(o.position.copy(s.position),o.needsUpdate=!0);const n=i.getComponent("RigidbodyComponent");n&&n.velocity.copy(s.velocity)}}if(performance.now()-s.userData.creationTime>this.projectileLifetime){if(s.userData&&s.userData.entityId&&this.world)try{this.world.destroyEntity(s.userData.entityId),console.log(`Removed expired projectile entity ${s.userData.entityId}`)}catch(i){console.error("Error removing projectile entity:",i)}this.poolManager.releaseProjectile(s),this.projectiles.splice(t,1)}}}setFiring(e){this.isFiring=e,console.log(`Particle cannon firing state changed: ${e}`)}createExplosionEffect(e,t=1e3,s=!0){try{const i=this.poolManager.getExplosion(e,t);return window.game&&window.game.audio&&window.game.audio.playSound("boink"),console.log("Created explosion effect at:",e.x.toFixed(0),e.y.toFixed(0),e.z.toFixed(0)),i}catch(i){return console.error("Error creating explosion effect:",i),null}}registerEnemy(e){this._registeredEnemyIds||(this._registeredEnemyIds=new Set),this._registeredEnemyIds.add(e),console.log(`Combat module: Registered enemy ${e} for tracking (total: ${this._registeredEnemyIds.size})`)}unregisterEnemy(e){this._registeredEnemyIds&&this._registeredEnemyIds.has(e)&&(this._registeredEnemyIds.delete(e),console.log(`Combat module: Unregistered enemy ${e} (remaining: ${this._registeredEnemyIds.size})`))}fireParticleCannon(){if(!this.spaceship||!this.spaceship.mesh)return!1;const e=performance.now();if(e-this.lastFireTime<this.cooldown)return!1;console.log("*** COMBAT MODULE: Firing particle cannon ***"),this.lastFireTime=e;const t=this.spaceship.mesh.position.clone(),s=this.scene.camera;if(!s)return console.error("Camera not available for aiming"),!1;const i=new at,o=new H(0,0);i.setFromCamera(o,s);const n=i.ray.direction.clone().normalize();console.log(`Projectile direction (using camera ray): ${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)}`);const a=new y().crossVectors(n,new y(0,1,0)).normalize(),r=new y().copy(a).multiplyScalar(-1.5),l=new y().copy(a).multiplyScalar(1.5),c=new y().copy(n).multiplyScalar(15),d=new y().copy(n).multiplyScalar(4);new y().copy(t).add(r).add(d),new y().copy(t).add(l).add(d);const h=new y().copy(t).add(r).add(c);this.createProjectile(h,n);const u=new y().copy(t).add(l).add(c);if(this.createProjectile(u,n),window.game&&window.game.audio&&(console.log("Playing ASMR projectile sound for particle cannon"),window.game.audio.playSound("projectile")),console.log("DIRECT ENEMY CHECK: Searching for enemies to destroy"),this.world&&this.world.entityManager){let m=[];try{if(this.world.entityManager.entitiesByTag&&this.world.entityManager.entitiesByTag.get("enemy"))m=this.world.entityManager.entitiesByTag.get("enemy"),console.log(`Found ${m.length} enemies via tag map`);else{console.log("No enemy tag map, checking all entities");const f=Array.from(this.world.entityManager.entities.values());for(const g of f)(g.hasTag&&g.hasTag("enemy")||g.hasComponent&&g.hasComponent("EnemyAIComponent"))&&m.push(g);console.log(`Found ${m.length} enemies by checking all entities`)}}catch(f){console.error("Error finding enemies:",f)}for(const f of m)if(f)try{let g=null;const b=f.getComponent("TransformComponent");if(b)g=b.position;else{console.log("Enemy missing transform component");continue}const w=f.getComponent("MeshComponent");if(!w||!w.mesh){console.log(`Enemy ${f.id} has no mesh component or mesh`);continue}console.log(`Testing ray intersection with enemy ${f.id}:`),console.log(`- Position: (${g.x.toFixed(1)}, ${g.y.toFixed(1)}, ${g.z.toFixed(1)})`),console.log(`- Mesh visible: ${w.mesh.visible}`),console.log(`- Mesh children: ${w.mesh.children?w.mesh.children.length:0}`);const v=t.distanceTo(g);if(console.log(`- Distance to enemy: ${v.toFixed(1)}`),!w.mesh.visible){console.log(`Mesh for enemy ${f.id} is not visible, skipping`);continue}const x=i.intersectObject(w.mesh,!0);if(x.length>0){const S=x[0];console.log(`*** MESH HIT on enemy ${f.id}! ***`),console.log(`- Hit distance: ${S.distance.toFixed(2)}`),console.log(`- Hit point: (${S.point.x.toFixed(1)}, ${S.point.y.toFixed(1)}, ${S.point.z.toFixed(1)})`),S.object&&console.log(`- Hit specific object: ${S.object.name||"unnamed"}`),S.face&&console.log(`- Hit face normal: (${S.face.normal.x.toFixed(2)}, ${S.face.normal.y.toFixed(2)}, ${S.face.normal.z.toFixed(2)})`);const M=f.getComponent("HealthComponent");if(M){console.log("Applying damage to enemy");const A=M.applyDamage(this.projectileDamage,"particle",this.playerEntity);if(M.health<=0){if(console.log("Enemy health depleted, destroying entity"),M.isDestroyed=!0,b&&(this.createExplosionEffect(b.position.clone()),window.game&&window.game.audio&&window.game.audio.playSound("boink")),this.unregisterEnemy(f.id),window.game&&window.game.ecsWorld&&window.game.ecsWorld.enemySystem){console.log(`Notifying EnemySystem directly about enemy ${f.id} destruction`);try{const P=window.game.ecsWorld.enemySystem;typeof P.handleEntityDestroyed=="function"&&P.handleEntityDestroyed({entity:f,reason:"projectile"})}catch(P){console.error("Error syncing with EnemySystem:",P)}}try{if(window.game&&window.game.ecsWorld&&window.game.ecsWorld.enemySystem){const P=window.game.ecsWorld.enemySystem;typeof P.returnEnemyToPool=="function"&&(console.log(`Using EnemySystem.returnEnemyToPool for enemy ${f.id}`),P.returnEnemyToPool(f)),typeof P.validateEnemyReferences=="function"&&P.validateEnemyReferences()}else this.world.destroyEntity(f.id),console.log("Enemy destroyed via world.destroyEntity")}catch(P){console.error("Failed to destroy enemy:",P)}this.world&&this.world.messageBus&&this.world.messageBus.publish("enemy.destroyed",{entityId:f.id,source:"playerProjectile",position:g.clone()})}else console.log(`Enemy hit but survived with ${M.health}/${M.maxHealth} health remaining`)}}else if(console.log(`Ray missed enemy ${f.id} - no mesh intersection`),window.debugMode){const S=new Te(new j().setFromPoints([i.ray.origin.clone(),i.ray.origin.clone().add(i.ray.direction.clone().multiplyScalar(1e3))]),new Me({color:16711680}));this.scene.add(S),setTimeout(()=>this.scene.remove(S),1e3)}}catch(g){console.error("Error checking enemy collision:",g)}}else console.log("No world or entityManager available for enemy check");return!0}createProjectile(e,t){const s=this.poolManager.getProjectile();s.position.copy(e),s.visible=!0;const i=new y(0,1,0),o=new fe;return o.setFromUnitVectors(i,t),s.quaternion.copy(o),s.velocity=t.clone().multiplyScalar(this.projectileSpeed),s.userData.isPlayerProjectile=!0,s.userData.sourceId="player",s.userData.damage=this.projectileDamage,this.addProjectileTrail(s,t),s.parent||this.scene.add(s),s.userData.creationTime=performance.now(),this.projectiles.push(s),s}setEnabled(e){e?this.world&&(this.enemySystem&&typeof this.enemySystem.setEnabled=="function"?this.enemySystem.setEnabled(!0):this.enemySystem&&(this.enemySystem.enabled=!0),this.combatSystem&&typeof this.combatSystem.setEnabled=="function"?this.combatSystem.setEnabled(!0):this.combatSystem&&(this.combatSystem.enabled=!0)):(this.clearAllProjectiles(),this.world&&(this.enemySystem&&typeof this.enemySystem.setEnabled=="function"?this.enemySystem.setEnabled(!1):this.enemySystem&&(this.enemySystem.enabled=!1),this.combatSystem&&typeof this.combatSystem.setEnabled=="function"?this.combatSystem.setEnabled(!1):this.combatSystem&&(this.combatSystem.enabled=!1))),console.log(`Combat systems ${e?"enabled":"disabled"}`)}addProjectileTrail(e,t){if(!this.poolManager){console.warn("PoolManager not available for projectile trail.");return}const n=this.poolManager.getTrailContainer();if(!n){console.warn("Failed to get trail container from pool.");return}e.add(n);const a=[];n.userData.particles=a,n.userData.isTrailActive=!0;for(let l=0;l<4;l++){const c=l/3,d=this.poolManager.getTrailParticle(l%window.game.trailParticleGeometries.length);if(!d){console.warn(`Failed to get trail particle ${l} from pool.`);continue}const h=t.clone().multiplyScalar(-c*4-2);d.position.copy(h),d.userData.creationTime=performance.now(),d.userData.initialOpacity=d.material.opacity,d.userData.initialScale=d.scale.x,n.add(d),a.push(d)}e.userData.trail=n;const r=()=>{if(!e.parent||!n.userData.isTrailActive){n.userData.isTrailActive=!1;return}for(let l=a.length-1;l>=0;l--){const c=a[l],d=performance.now()-c.userData.creationTime,h=Math.min(d/150,1);if(h>=1)this.poolManager.releaseTrailParticle(c),a.splice(l,1),c.parent&&c.parent.remove(c);else{c.material.opacity=c.userData.initialOpacity*(1-h);const u=c.userData.initialScale*(1-h);c.scale.set(u,u,u)}}if(a.length===0){n.userData.isTrailActive=!1;return}requestAnimationFrame(r)};r()}clearAllProjectiles(){for(const e of this.projectiles){if(e.userData&&e.userData.entityId&&this.world)try{this.world.destroyEntity(e.userData.entityId)}catch(t){console.error("Error removing projectile entity:",t)}this.poolManager.releaseProjectile(e)}this.projectiles=[],console.log("All projectiles cleared and returned to the pool")}createAimingTracer(e,t,s=3e3){const i=this.poolManager.getTracer(),o=e.clone().add(t.clone().multiplyScalar(s)),n=i.geometry.attributes.position.array;return n[0]=e.x,n[1]=e.y,n[2]=e.z,n[3]=o.x,n[4]=o.y,n[5]=o.z,i.geometry.attributes.position.needsUpdate=!0,i}createMuzzleFlash(e,t){const s=this.poolManager.getMuzzleFlash();s.position.copy(e);const i=e.clone().add(t.clone().normalize().multiplyScalar(10));s.lookAt(i),s.userData.initialPosition=e.clone(),s.userData.direction=t.clone();const o=s.userData.flashLight;return o&&(o.position.copy(e),o.intensity=200),s}dispose(){console.log("Disposing Combat module resources..."),this.clearAllProjectiles(),this.poolManager&&(this.poolManager.dispose(),this.poolManager=null),this.disposed=!0,console.log("Combat module resources disposed")}async importAndRegisterSystem(e,t){try{const s=await import(e);if(!s[t])return console.error(`[COMBAT] System class ${t} not found in module ${e}`),null;const i=s[t];let o;return t==="TrailSystem"||t==="VisualEffectsSystem"||t==="RenderSystem"?o=new i(this.world,this.scene):o=new i(this.world),o}catch(s){return console.error(`[COMBAT] Error importing system ${t} from ${e}:`,s),null}}}export{So as A,Si as C,wi as E,vi as F,Bs as G,Ct as P,bi as R,pe as S,ve as U,Ei as V,St as W,zt as _,Ci as a,yo as b,bo as c,wo as d,vo as e,xo as f,Nt as g,Co as h};
//# sourceMappingURL=modules-CbyahrMR.js.map
