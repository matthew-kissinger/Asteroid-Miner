const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/combat-oJGfwFeG.js","assets/three-DBvJLP14.js","assets/introSequence-BCk2nBwV.js","assets/pathUtils-CUZPms8F.js","assets/audio-BTuzEujB.js","assets/environment-C9XE_r0p.js","assets/ui-DLX1Dt1V.js","assets/ecs-systems-DNfKaFsz.js","assets/vendor-D1adT2yx.js"])))=>i.map(i=>d[i]);
var me=Object.defineProperty;var ge=(c,e,t)=>e in c?me(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var n=(c,e,t)=>ge(c,typeof e!="symbol"?e+"":e,t);import{T as pe,V as g,P as N,A as oe,S as ae,D as fe,H as ye,b as we,C as B,c as L,d as I,E as ve,R as be,U as Se,F as Me,e as ke,f as Ce,g as Ee,Q as re,I as Pe,O as Te,h as xe,i as Le,j as le,W as Ae,k as J,l as Ie,G as D,m as U,M as k,n as O,o as G,a as w,p as P,q as De,r as T,B as H,s as ce,t as he,u as Re,v as Be,w as Ue,x as Oe,y as j,z as Q,J as K,K as ee,L as te,N as Fe}from"./three-DBvJLP14.js";const He="modulepreload",_e=function(c){return"/Asteroid-Miner/"+c},ie={},R=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(t.map(l=>{if(l=_e(l),l in ie)return;ie[l]=!0;const d=l.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":He,d||(u.as="script"),u.crossOrigin="",u.href=l,a&&u.setAttribute("nonce",a),document.head.appendChild(u),d)return new Promise((f,p)=>{u.addEventListener("load",f),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})};function se(c){return typeof c=="object"&&c!==null}class Ge{constructor(){n(this,"typeToPool");n(this,"statsData");this.typeToPool=new Map,this.statsData={hits:0,misses:0}}register(e,{factory:t,reset:i,preallocate:s=0,maxSize:o=1/0}){if(!e)throw new Error("PoolRegistry.register requires a type");const r=this.typeToPool.get(e);if(r)return r;const a={objects:[],factory:t||(()=>({})),reset:i||function(){},maxSize:o};for(let l=0;l<s;l++)try{a.objects.push(a.factory())}catch{}return this.statsData.misses+=s,this.typeToPool.set(e,a),a}get(e,...t){const i=this.typeToPool.get(e);if(!i)throw new Error(`PoolRegistry.get: unknown type '${e}'`);let s;if(i.objects.length>0?(s=i.objects.pop(),this.statsData.hits+=1):(s=i.factory(),this.statsData.misses+=1),se(s)&&typeof s.reset=="function")s.reset(...t);else if(i.reset)try{i.reset(s,...t)}catch{}return this._flushPerf(),s}release(e,t){const i=this.typeToPool.get(e);if(i){if(se(t)&&typeof t.clear=="function")try{t.clear()}catch{}else if(i.reset)try{i.reset(t)}catch{}i.objects.length<i.maxSize&&i.objects.push(t)}}clear(e){const t=this.typeToPool.get(e);t&&(t.objects.length=0)}clearAll(){for(const[e]of this.typeToPool)this.clear(e)}stats(){return{hits:this.statsData.hits,misses:this.statsData.misses}}_flushPerf(){window.__perf&&(window.__perf.pools={...this.statsData})}}function ze(){const c=window;return c.poolRegistry||(c.poolRegistry=new Ge),c.poolRegistry}const y={enabled:!1};function de(c){y.enabled=c,globalThis.DEBUG_MODE=c}function Ve(){return de(!y.enabled),y.enabled}const E=Object.freeze({GAME_OVER:"game.over",PLAYER_CREATED:"player.created",TRANSFORM_UPDATED:"transform.updated",VFX_EXPLOSION:"vfx.explosion",MINING_START:"player.mining.start",MINING_STOP:"player.mining.stop",ENEMY_DESTROYED:"enemy.destroyed",WEAPON_FIRED:"weapon.fired",INPUT_VIBRATE:"input.vibrate"}),Ne={[E.GAME_OVER]:{reason:"string"},[E.PLAYER_CREATED]:{entity:"object"},[E.TRANSFORM_UPDATED]:{entity:"object"},[E.VFX_EXPLOSION]:{position:"object",color:"number",size:"number",duration:"number"},[E.MINING_START]:{sourceEntity:"object",targetEntity:"object"},[E.MINING_STOP]:{sourceEntity:"object"},[E.ENEMY_DESTROYED]:{entityId:"string"},[E.WEAPON_FIRED]:{entity:"object"},[E.INPUT_VIBRATE]:{intensity:"number",duration:"number"}};function _(c,e){if(!y||!y.enabled)return!0;const t=Ne[c];if(!t)return!0;if(typeof e!="object"||e==null)return V(c,"payload is not object");for(const[i,s]of Object.entries(t)){const o=e[i];if(s==="object"){if(typeof o!="object"||o==null)return V(c,`field ${i} must be object`)}else if(typeof o!==s)return V(c,`field ${i} must be ${s}`)}return!0}function V(c,e){return console.warn(`[EVENT VALIDATION] ${c}: ${e}`),!1}class ue{constructor(){n(this,"listeners");n(this,"queuedMessages");n(this,"dispatching");n(this,"highFrequencyTypes");this.listeners=new Map,this.queuedMessages=[],this.dispatching=!1,this.highFrequencyTypes=new Set(["transform.updated","physics.update","render.update"]),window.messageRegistry||(window.messageRegistry=new Set),window.messageRegistry.add(this),globalThis.mainMessageBus||(globalThis.mainMessageBus=this)}subscribe(e,t,i=null){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push({callback:t,context:i}),()=>this.unsubscribe(e,t,i)}unsubscribe(e,t,i=null){if(!this.listeners.has(e))return;const s=this.listeners.get(e),o=s.findIndex(r=>r.callback===t&&r.context===i);o!==-1&&s.splice(o,1),s.length===0&&this.listeners.delete(e)}fastPublish(e,t={}){try{_&&_(e,t)}catch{}if(!this.listeners.has(e))return;const i=this.listeners.get(e),s={type:e,data:t,timestamp:Date.now()};for(let o=0;o<i.length;o++){const r=i[o];r.callback.call(r.context,s)}}publish(e,t={}){try{_&&_(e,t)}catch{}if(this.highFrequencyTypes.has(e))return this.fastPublish(e,t);if(e==="game.over"){if(globalThis.mainMessageBus&&globalThis.mainMessageBus!==this){globalThis.mainMessageBus.publish(e,t);return}if(!this.listeners.has(e)){window.game&&window.game.gameOver(t.reason||"Unknown reason");return}}if(this.listeners.has(e)){if(this.dispatching){this.queuedMessages.push({type:e,data:t});return}try{this.dispatching=!0,this.listeners.get(e).forEach(s=>{try{s.callback.call(s.context,{type:e,data:t,timestamp:Date.now()})}catch{}})}finally{if(this.dispatching=!1,this.queuedMessages.length>0){const i=[...this.queuedMessages];this.queuedMessages=[],i.forEach(s=>{this.publish(s.type,s.data)})}}}}queue(e,t={}){this.queuedMessages.push({type:e,data:t})}static triggerGameOver(e,t){let i=null;globalThis.mainMessageBus?i=globalThis.mainMessageBus:window.game&&window.game.messageBus&&(i=window.game.messageBus),i&&i.publish("game.over",{reason:e,source:t})}}const $e=Object.freeze(Object.defineProperty({__proto__:null,MessageBus:ue},Symbol.toStringTag,{value:"Module"})),$=globalThis,S=$.mainMessageBus??new ue;$.mainMessageBus||($.mainMessageBus=S);const W=globalThis,M=W.objectPool??{registry:ze(),get(c,...e){try{return this.registry.get(c,...e)}catch{return y.enabled&&console.log(`Creating on-demand pool: ${c}`),this.registry.register(c,{factory:()=>({}),preallocate:10,maxSize:100}),this.registry.get(c,...e)}},release(c,e){this.registry.release(c,e)},createPool(c,e,t=10,i=100){this.registry.register(c,{factory:e,reset:s=>{s&&typeof s=="object"&&"reset"in s&&typeof s.reset=="function"&&s.reset()},preallocate:t,maxSize:i})},getStats(c){if(this.registry.typeToPool&&this.registry.typeToPool.has(c)){const e=this.registry.typeToPool.get(c);return{available:e?e.objects.length:0,maxSize:e?e.maxSize:0,hits:this.registry.statsData?this.registry.statsData.hits:0,misses:this.registry.statsData?this.registry.statsData.misses:0}}return null},clearAllPools(){if(this.registry.clearAll){this.registry.clearAll();return}this.registry.typeToPool&&this.registry.typeToPool.forEach(c=>{c.objects=[]})}};W.objectPool||(W.objectPool=M);function Gt(){window.THREE||(window.THREE=pe),de(!1),We()}function We(){const c={pool:[],maxSize:100,get:function(e=0,t=0,i=0){if(this.pool.length>0){const s=this.pool.pop();if(s)return s.set(e,t,i)}return new g(e,t,i)},release:function(e){this.pool.length<this.maxSize&&this.pool.push(e)}};window.vectorPool=c}class zt{constructor(e){n(this,"game");n(this,"introSequence");n(this,"introSequenceActive");this.game=e,this.introSequence=null,this.introSequenceActive=!1}async initializeGameSequence(){try{if(await new Promise(e=>setTimeout(e,100)),this.game.audio&&this.game.audio.audioContext&&this.game.audio.audioContext.state==="suspended")try{this.game.audio.resumeAudioContext()}catch{}this.game.ui&&this.game.ui.startScreen?this.game.ui.startScreen.show():this.fallbackToDefaultBehavior(),this.game.boundAnimate&&requestAnimationFrame(this.game.boundAnimate),this.initializeRemainingSystemsAsync()}catch(e){if(this.game.ui&&this.game.ui.showError){const t=e instanceof Error?e.message:String(e);this.game.ui.showError("Failed to initialize game: "+t)}else{const t=e instanceof Error?e.message:String(e);alert("Failed to initialize game: "+t)}}}async initializeRemainingSystemsAsync(){try{if(this.loadAudioAsync(),!this.game.combat){const{Combat:e}=await R(async()=>{const{Combat:t}=await import("./combat-oJGfwFeG.js");return{Combat:t}},__vite__mapDeps([0,1]));this.game.combat=new e(this.game.scene,this.game.spaceship),this.game.combat.world||setTimeout(()=>{this.game.combat&&this.game.combat.world&&this.game.combat.playerEntity||this.game.combat&&(console.warn("Combat ECS world or player entity not available after delay, recreating..."),this.game.combat.createPlayerReferenceEntity&&this.game.combat.createPlayerReferenceEntity())},1e3)}setTimeout(()=>{this.game.initializeObjectPools&&this.game.initializeObjectPools(),this.game.preWarmBasicShaders&&this.game.preWarmBasicShaders()},100)}catch{}}async loadAudioAsync(){try{this.game.audio&&this.game.audio.initialize().then(()=>{}).catch(()=>{})}catch{}}fallbackToDefaultBehavior(){this.game.startDocked&&this.game.startDocked()}async initIntroSequence(){const{IntroSequence:e}=await R(async()=>{const{IntroSequence:t}=await import("./introSequence-BCk2nBwV.js");return{IntroSequence:t}},__vite__mapDeps([2,1,3]));this.introSequence=new e(this.game.scene,this.game.camera,this.game.spaceship??null,this.game.audio??null),this.introSequence.onComplete=()=>{this.completeIntroSequence()}}async startIntroSequence(){if(this.introSequence||await this.initIntroSequence(),this.introSequenceActive=!0,typeof this.game.introSequenceActive<"u"&&(this.game.introSequenceActive=!0),this.game.combat&&this.game.combat.world){const t=this.game.combat.world.enemySystem;t&&t.freezeAllEnemies()}this.game.ui&&this.game.ui.combatDisplay&&this.game.ui.combatDisplay.hide(),this.game.ui&&this.game.ui.stargateInterface&&this.game.ui.stargateInterface.hide(),this.game.ui&&this.game.ui.hideUI(),this.game.spaceship&&this.game.spaceship.mesh&&(this.game.spaceship.mesh.position.set(0,0,50),this.game.spaceship.mesh.rotation.set(0,0,0));const e=this.introSequence;e&&e.startSequence(()=>{this.completeIntroSequence()})}completeIntroSequence(){if(this.introSequenceActive=!1,typeof this.game.introSequenceActive<"u"&&(this.game.introSequenceActive=!1),localStorage.setItem("introPlayed","true"),this.game.combat&&this.game.combat.world){const e=this.game.combat.world.enemySystem;e&&e.unfreezeAllEnemies()}this.game.ui&&this.game.ui.stargateInterface&&this.game.ui.stargateInterface.hide(),this.game.ui&&this.game.ui.showUI(),this.game.spaceship&&(this.game.spaceship.isDocked&&this.game.spaceship.undock(),this.game.spaceship.mesh&&console.log("Player position after intro:",this.game.spaceship.mesh.position.x,this.game.spaceship.mesh.position.y,this.game.spaceship.mesh.position.z)),this.game.ui&&this.game.ui.combatDisplay&&this.game.ui.combatDisplay.show(),S&&S.publish("intro.completed",{})}}class Vt{constructor(e){n(this,"game");n(this,"frameRateCap");n(this,"warmupFrames");n(this,"currentWarmupFrame");n(this,"performanceStable");n(this,"lastFrameTime");n(this,"actualFrameTime");n(this,"frameStartTime");n(this,"accumulator");n(this,"fixedDeltaTime");n(this,"fpsBuffer");n(this,"fpsBufferSize");n(this,"boundAnimate");n(this,"deltaTime");n(this,"lastUpdateTime");n(this,"frameCount");n(this,"currentFPS");this.game=e,this.frameRateCap=0,this.warmupFrames=10,this.currentWarmupFrame=0,this.performanceStable=!1,this.lastFrameTime=0,this.actualFrameTime=0,this.frameStartTime=0,this.accumulator=0,this.fixedDeltaTime=1/60,this.fpsBuffer=[],this.fpsBufferSize=15,this.boundAnimate=this.animate.bind(this),this.deltaTime=0,this.lastUpdateTime=performance.now(),this.frameCount=0,this.currentFPS=0}start(){this.boundAnimate&&requestAnimationFrame(this.boundAnimate)}animate(e){if(this.currentWarmupFrame<this.warmupFrames){this.currentWarmupFrame++,this.currentWarmupFrame===this.warmupFrames&&(this.lastFrameTime=e,this.frameStartTime=performance.now(),this.lastUpdateTime=performance.now(),this.performanceStable=!0),this.boundAnimate&&requestAnimationFrame(this.boundAnimate);return}if(!this.lastFrameTime){this.lastFrameTime=e,this.frameStartTime=performance.now(),this.boundAnimate&&requestAnimationFrame(this.boundAnimate);return}if(this.actualFrameTime=e-this.lastFrameTime,this.frameRateCap>0){const s=1e3/this.frameRateCap;if(e-this.lastFrameTime<s-.5){this.boundAnimate&&requestAnimationFrame(this.boundAnimate);return}this.lastFrameTime+=s,e-this.lastFrameTime>s&&(this.lastFrameTime=e-s)}else this.lastFrameTime=e;const t=performance.now(),i=Math.min((t-this.lastUpdateTime)/1e3,.1);for(this.lastUpdateTime=t,this.accumulator+=i;this.accumulator>=this.fixedDeltaTime;)this.deltaTime=this.fixedDeltaTime,this.game.gameTime+=this.deltaTime,this.game.update(this.deltaTime),this.accumulator-=this.fixedDeltaTime;this.game.renderer&&this.game.renderer.render&&this.game.renderer.render(),this.updateFPS(),this.boundAnimate&&requestAnimationFrame(this.boundAnimate)}updateFPS(){const e=this.actualFrameTime?1e3/this.actualFrameTime:60;this.fpsBuffer.push(e),this.fpsBuffer.length>this.fpsBufferSize&&this.fpsBuffer.shift();let t=0,i=0;for(let s=0;s<this.fpsBuffer.length;s++){const o=s+1;i+=this.fpsBuffer[s]*o,t+=o}this.currentFPS=Math.round(i/t),this.frameCount%5===0&&this.game.ui&&this.game.ui.updateFPS&&(this.frameRateCap>0?this.game.ui.updateFPS(this.currentFPS,this.frameRateCap):this.game.ui.updateFPS(this.currentFPS)),this.frameCount++}setFrameRateCap(e){this.frameRateCap=e}applyFrameRateSettings(){if(this.game.ui&&this.game.ui.settings){const e=this.game.ui.settings.getFrameRateCap?this.game.ui.settings.getFrameRateCap():0;if(e==="auto"||e===0)this.setFrameRateCap(0),this.detectRefreshRate().then(t=>{t&&t>0&&this.setFrameRateCap(t)});else{const t=typeof e=="string"?parseInt(e):e;this.setFrameRateCap(t)}}}async detectRefreshRate(){return new Promise(e=>{let t=0,i=0;const s=[],o=r=>{if(t===0)i=r;else if(t>10&&t<=70){const a=r-i;s.push(a),i=r}if(t++,t<80)requestAnimationFrame(o);else if(s.length>0){const a=s.reduce((f,p)=>f+p,0)/s.length,l=Math.round(1e3/a),d=[30,60,75,90,120,144,165,240,360];let h=60,u=Math.abs(l-60);for(const f of d){const p=Math.abs(l-f);p<u&&(u=p,h=f)}u<5?e(h):e(0)}else e(0)};requestAnimationFrame(o)})}destroy(){this.boundAnimate&&(cancelAnimationFrame(this.boundAnimate),this.boundAnimate=null)}}class qe{constructor(){n(this,"panel",null);n(this,"updateHzMs",500);n(this,"_gcObserver",null);n(this,"interval",null);this.ensurePerf();try{if("PerformanceObserver"in window){const e=new PerformanceObserver(t=>{for(const i of t.getEntries())if(i.entryType==="gc"){const s=this.ensurePerf();s.gc||(s.gc=0),s.gc+=1}});e.observe({entryTypes:["gc"]}),this._gcObserver=e}}catch(e){console.warn("PerformanceObserver for GC not available:",e)}document.addEventListener("keydown",e=>{e.key==="F3"&&this.toggle()})}toggle(){const e=this.ensurePerf();e.enabled=!e.enabled,e.enabled?(this.ensurePanel(),this.renderOnce()):this.destroy()}ensurePanel(){if(this.panel)return;const e=document.createElement("div");e.id="perf-overlay",e.style.position="fixed",e.style.top="8px",e.style.right="8px",e.style.minWidth="220px",e.style.maxWidth="320px",e.style.background="rgba(0,0,0,0.6)",e.style.color="#9ef7ff",e.style.fontFamily="monospace",e.style.fontSize="12px",e.style.lineHeight="1.4",e.style.padding="8px 10px",e.style.border="1px solid rgba(158,247,255,0.3)",e.style.borderRadius="6px",e.style.zIndex="99999",e.style.pointerEvents="none",e.innerHTML=this.renderContent(),document.body.appendChild(e),this.panel=e,this.interval=window.setInterval(()=>this.renderOnce(),this.updateHzMs)}renderOnce(){this.panel&&(this.panel.innerHTML=this.renderContent())}renderContent(){var s,o;const e=this.ensurePerf(),i=(e.systems?Object.entries(e.systems).slice(0,8):[]).map(([r,a])=>`<div>${r}: ${Number(a).toFixed(2)} ms</div>`).join("");return`<div style="opacity:.85"><div><b>Perf Overlay</b> (F3)</div><div>FPS: ${Math.round(e.fps||0)}</div><div>Sim: ${Number(e.simMs||0).toFixed(2)} ms</div><div>Render: ${Number(e.renderMs||0).toFixed(2)} ms</div><div>DrawCalls: ${e.drawCalls||0}</div><div>Instances: ${e.visibleInstances||0}</div><div>Pool hits/misses: ${((s=e.pools)==null?void 0:s.hits)||0} / ${((o=e.pools)==null?void 0:o.misses)||0}</div><div>GC: ${e.gc||0}</div><div style="margin-top:6px; border-top:1px solid rgba(158,247,255,.2)"><div><b>Systems</b></div>`+i+"</div></div>"}destroy(){this.interval!==null&&(clearInterval(this.interval),this.interval=null),this._gcObserver&&this._gcObserver.disconnect&&(this._gcObserver.disconnect(),this._gcObserver=null),this.panel&&this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel),this.panel=null}ensurePerf(){return window.__perf||(window.__perf={enabled:!1,fps:0,simMs:0,renderMs:0,drawCalls:0,visibleInstances:0,pools:{hits:0,misses:0},gc:0,systems:{}}),window.__perf}}function Ze(){return window.__perfOverlay||(window.__perfOverlay=new qe),window.__perfOverlay}class Nt{constructor(e){n(this,"game");this.game=e,this.setupDiagnostics()}setupDiagnostics(){Ze();const e=window.__perf??(window.__perf={enabled:!1,fps:0,simMs:0,renderMs:0,drawCalls:0,visibleInstances:0,pools:{hits:0,misses:0},gc:0,systems:{}});e.enabled=!1,window.setFPSLimit=t=>this.game.gameLoop?(this.game.gameLoop.setFrameRateCap(t),`FPS limit set to ${t>0?t:"unlimited"}`):"Game loop not initialized",window.togglePerf=()=>{if(e.enabled=!e.enabled,e.enabled)this.game.ui&&this.game.ui.initializePerformanceMonitor&&this.game.ui.initializePerformanceMonitor(),window.MemoryStats&&(window.MemoryStats.update(),window.MemoryStats.logReport());else{const t=document.getElementById("performance-stats");t&&t.remove(),this.game.ui&&this.game.ui.statsInterval&&(clearInterval(this.game.ui.statsInterval),this.game.ui.statsInterval=null)}return e.enabled?"enabled":"disabled"},window.playIntro=()=>this.game.startupSequence&&this.game.startupSequence.startIntroSequence?(this.game.startupSequence.startIntroSequence(),"Playing intro sequence..."):"Intro sequence not available",window.toggleDebug=()=>(Ve(),`Debug mode ${y.enabled?"enabled":"disabled"}`),window.gameState=()=>{var t,i,s;return{isGameOver:this.game.isGameOver,isDocked:(t=this.game.spaceship)==null?void 0:t.isDocked,introActive:this.game.introSequenceActive,hordeActive:this.game.isHordeActive,fps:(i=this.game.gameLoop)==null?void 0:i.currentFPS,gameTime:this.game.gameTime,difficulty:(s=this.game.difficultyManager)==null?void 0:s.currentLevel}},window.startHorde=()=>this.game.activateHordeMode?(this.game.activateHordeMode(),"Horde mode activated!"):"Horde mode not available",window.memStats=()=>window.MemoryStats?(window.MemoryStats.update(),window.MemoryStats.getReport()):"Memory stats not available",window.poolStats=t=>{if(M&&M.getStats){if(t)return M.getStats(t);{const i={},s=["projectile","enemy","particle","hitEffect","explosion"];for(const o of s){const r=M.getStats(o);r&&(i[o]=r)}return i}}return"Object pool not available"},window.entityCount=()=>{var t,i;if(this.game.combat&&this.game.combat.world&&this.game.combat.world.entityManager){const s=this.game.combat.world.entityManager.entities.size,o=((t=this.game.combat.world.systemManager)==null?void 0:t.systems.length)??0;return{entities:s,systems:o,sceneChildren:(i=this.game.scene)==null?void 0:i.children.length}}return"ECS world not available"}}}const Ye={sun:{color:16777215,intensity:3,position:{x:5e4,y:1e4,z:2e4}},ambient:{skyColor:2105392,groundColor:657936,intensity:.3},shadows:{enabled:!0,mapSize:4096,type:"PCFSoft",radius:2,blurSamples:25,bias:-1e-4,normalBias:.02,frustumSize:1e4,near:.5,far:5e4},bloom:{enabled:!0,strength:.8,radius:.4,threshold:.9},toneMapping:{type:"ACESFilmic",exposure:1},volumetric:{godRays:{enabled:!0,density:.96,weight:.4,decay:.95,exposure:.35,samples:100}},materials:{asteroids:{iron:{metalness:.7,roughness:.6,emissiveIntensity:.1},gold:{metalness:.9,roughness:.2,emissiveIntensity:.15},platinum:{metalness:.85,roughness:.15,emissiveIntensity:.1}},planets:{rocky:{metalness:.05,roughness:.85,clearcoat:.05},gasGiant:{metalness:0,roughness:.3,clearcoat:.2,sheen:.2},terrestrial:{metalness:.02,roughness:.4,clearcoat:.3,sheen:.1}}},performance:{shadowAutoUpdate:!0,shadowMapAutoUpdate:!0,logarithmicDepthBuffer:!0},fineTuning:{sunFlicker:{enabled:!0,minIntensity:.95,maxIntensity:1.05,speed:.015},distanceAttenuation:{enabled:!0,maxDistance:5e4,minExposure:.6,maxExposure:1}}};class Xe{constructor(e,t,i){n(this,"scene");n(this,"renderer");n(this,"camera");n(this,"sunLight");n(this,"ambientLight");n(this,"config");this.scene=e,this.renderer=t,this.camera=i,this.sunLight=null,this.ambientLight=null,this.config=Ye}setupLighting(){"shadowMap"in this.renderer&&(this.renderer.shadowMap.enabled=this.config.shadows.enabled,this.renderer.shadowMap.type=N,"autoUpdate"in this.renderer.shadowMap&&(this.renderer.shadowMap.autoUpdate=this.config.performance.shadowMapAutoUpdate)),"toneMapping"in this.renderer&&(this.config.toneMapping.type==="ACESFilmic"&&(this.renderer.toneMapping=oe),this.renderer.toneMappingExposure=this.config.toneMapping.exposure,this.renderer.outputColorSpace=ae),this.sunLight=new fe(this.config.sun.color,this.config.sun.intensity),this.sunLight.position.set(this.config.sun.position.x,this.config.sun.position.y,this.config.sun.position.z),this.sunLight.target.position.set(0,0,0),this.sunLight.castShadow=this.config.shadows.enabled,this.sunLight.shadow.mapSize.width=this.config.shadows.mapSize,this.sunLight.shadow.mapSize.height=this.config.shadows.mapSize;const e=this.config.shadows.frustumSize;this.sunLight.shadow.camera.left=-e,this.sunLight.shadow.camera.right=e,this.sunLight.shadow.camera.top=e,this.sunLight.shadow.camera.bottom=-e,this.sunLight.shadow.camera.near=this.config.shadows.near,this.sunLight.shadow.camera.far=this.config.shadows.far,this.sunLight.shadow.bias=this.config.shadows.bias,this.sunLight.shadow.normalBias=this.config.shadows.normalBias,this.sunLight.shadow.radius=this.config.shadows.radius,"blurSamples"in this.sunLight.shadow&&(this.sunLight.shadow.blurSamples=this.config.shadows.blurSamples),this.scene.add(this.sunLight),this.scene.add(this.sunLight.target),this.ambientLight=new ye(this.config.ambient.skyColor,this.config.ambient.groundColor,this.config.ambient.intensity),this.scene.add(this.ambientLight),console.log("Lighting setup complete using centralized LIGHTING_CONFIG")}updateSunPosition(e){this.sunLight&&(this.sunLight.target.position.copy(e),this.sunLight.target.updateMatrixWorld())}adjustLightingIntensity(e=1){const t=we.clamp(e,.5,2);this.sunLight&&(this.sunLight.intensity=this.config.sun.intensity*t)}updateExposure(e){"toneMappingExposure"in this.renderer&&(this.renderer.toneMappingExposure=this.config.toneMapping.exposure)}adjustLightingForRayType(e){this.ambientLight&&(this.ambientLight.intensity=this.config.ambient.intensity)}setShadowQuality(e){const i={low:2048,medium:4096,high:8192,ultra:16384}[e]||4096;this.sunLight&&this.sunLight.shadow&&(this.sunLight.shadow.mapSize.width=i,this.sunLight.shadow.mapSize.height=i,this.sunLight.shadow.map&&(this.sunLight.shadow.map.dispose(),this.sunLight.shadow.map=null))}handleResize(){}dispose(){this.sunLight&&this.sunLight.shadow&&this.sunLight.shadow.map&&this.sunLight.shadow.map.dispose(),[this.sunLight,this.ambientLight].forEach(e=>{e&&("target"in e&&e.target&&this.scene.remove(e.target),this.scene.remove(e))})}}function Je(){const c={uniforms:{tDiffuse:{value:null},lightPosition:{value:new L(.5,.5)},intensity:{value:.45},decay:{value:.94},density:{value:.6},weight:{value:.5},samples:{value:100},sunColor:{value:new B(16775920)},sunDistance:{value:.5},sunVisibility:{value:1},scattering:{value:.4},attenuationMultiplier:{value:3.5}},vertexShader:`
            varying vec2 vUv;
            
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,fragmentShader:`
            precision highp float;
            
            varying vec2 vUv;
            uniform sampler2D tDiffuse;
            uniform vec2 lightPosition;
            uniform float intensity;
            uniform float decay;
            uniform float density;
            uniform float weight;
            uniform int samples;
            uniform vec3 sunColor;
            uniform float sunDistance;
            uniform float sunVisibility;
            uniform float scattering;
            uniform float attenuationMultiplier;
            
            const int MAX_SAMPLES = 150;
            
            float illuminationDecay(float rayProgress, float dist) {
                // rayProgress: 0.0 to a1.0 (how far along the ray)
                // dist: normalized distance to sun (0 = close, 1 = far)
                
                // Base decay from exponential falloff
                float baseFalloff = pow(decay, rayProgress * 100.0);
                
                // More decay the further the sun is 
                float distanceAttenuation = 1.0 - (dist * dist * attenuationMultiplier);
                distanceAttenuation = max(0.0, distanceAttenuation);
                
                // Apply visibility factor
                float visibilityFactor = sunVisibility;
                
                return baseFalloff * distanceAttenuation * visibilityFactor;
            }
            
            void main() {
                // Get the texture color (original scene)
                vec4 sceneColor = texture2D(tDiffuse, vUv);
                
                // Calculate ray direction from pixel to light source
                vec2 rayVector = (vUv - lightPosition);
                float rayLength = length(rayVector);
                vec2 rayDirection = normalize(rayVector);
                
                // Skip calculation if ray is too long (reduces artifacts far from sun)
                if (rayLength > 1.0) {
                    gl_FragColor = sceneColor;
                    return;
                }
                
                // Angle factor (rays stronger when looking near sun)
                float angleFactor = 1.0 - rayLength;
                angleFactor = pow(angleFactor, 0.8); // Adjust the power for ray spread
                
                // Calculate ray sampling parameters
                vec2 sampleStep = -rayDirection * min(density, 1.0) / float(samples);
                
                // Use a tighter sampling box around the light source
                // This creates more defined rays and reduces artifacts
                float rayProgress = max(0.0, (1.0 - rayLength * 2.0)); // Start closer to light source
                vec2 samplePosition = vUv - sampleStep * rayProgress * 10.0; // Start closer to current position
                
                // Clamp sample count for performance
                int sampleCount = min(samples, MAX_SAMPLES);
                
                // Start with current scene color
                vec4 finalColor = sceneColor;
                
                // Calculate scattering factor based on distance and angle
                float scatterFactor = scattering * angleFactor * (1.0 - sunDistance * 0.5);
                
                // Sample the light path
                // Use a fixed loop to avoid gradient instruction warnings
                for (int i = 0; i < MAX_SAMPLES; i++) {
                    // Early exit condition without break (to avoid varying iteration)
                    float shouldSample = step(float(i), float(sampleCount) - 0.5);
                    
                    // Move along the ray
                    samplePosition += sampleStep;
                    
                    // Sample at the current position
                    // Note: texture2D in a loop with uniform iteration is fine
                    vec4 sampledColor = texture2D(tDiffuse, samplePosition);
                    
                    // Calculate illumination decay factor
                    float decayFactor = illuminationDecay(float(i) / float(sampleCount), sunDistance);
                    
                    // Create the ray sample with attenuation
                    vec4 raySample = sampledColor * decayFactor * weight * shouldSample;
                    
                    // Apply sun color to the ray (tinted by scene color)
                    raySample.rgb *= mix(sunColor, sampledColor.rgb, 0.3);
                    
                    // Apply scattering effect - brightens areas around sun
                    float scatterAmount = step(float(i), float(sampleCount) / 3.0 - 0.5);
                    raySample.rgb += sunColor * scatterFactor * decayFactor * 0.2 * 
                                     (1.0 - float(i) / max(float(sampleCount) / 3.0, 1.0)) * scatterAmount * shouldSample;
                    
                    // Add to accumulated color
                    finalColor += raySample;
                }
                
                // Apply master intensity factor
                finalColor *= mix(1.0, intensity, sunVisibility);
                
                // Preserve original scene color with a blend factor
                finalColor = mix(sceneColor, finalColor, min(0.95, intensity * sunVisibility));
                
                gl_FragColor = finalColor;
            }
        `},e=new I(c);return e.renderToScreen=!1,e}function je(){const c={uniforms:{tDiffuse:{value:null},lightPosition:{value:new L(.5,.5)},exposure:{value:.4},decay:{value:.93},density:{value:.8},weight:{value:.25},lightColor:{value:new B(16775920)}},vertexShader:`
            varying vec2 vUv;
            void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,fragmentShader:`
            precision highp float;
            
            varying vec2 vUv;
            uniform sampler2D tDiffuse;
            uniform vec2 lightPosition;
            uniform float exposure;
            uniform float decay;
            uniform float density;
            uniform float weight;
            uniform vec3 lightColor;
            
            const int NUM_SAMPLES = 24; // Reduced from 30 for better balance of quality and performance
            
            void main() {
                // Get the texture color
                vec4 color = texture2D(tDiffuse, vUv);
                
                // Ray direction
                vec2 texCoord = vUv;
                vec2 deltaTextCoord = (texCoord - lightPosition) * density / float(NUM_SAMPLES);
                
                // Start illumination decay at 1.0
                float illuminationDecay = 1.0;
                
                // Sample the light path with a fixed number of steps
                for(int i = 0; i < NUM_SAMPLES; i++) {
                    // Move along the ray
                    texCoord -= deltaTextCoord;
                    
                    // Sample at the current position
                    vec4 sampleColor = texture2D(tDiffuse, texCoord);
                    
                    // Apply decay and weight
                    sampleColor *= illuminationDecay * weight;
                    
                    // Apply light color
                    sampleColor.rgb *= lightColor;
                    
                    // Add to the final color
                    color += sampleColor;
                    
                    // Reduce illumination for the next sample
                    illuminationDecay *= decay;
                }
                
                // Apply exposure
                color *= exposure;
                
                // Output the final color
                gl_FragColor = color;
            }
        `},e=new I(c);return e.renderToScreen=!1,e}class Qe{constructor(e,t,i){n(this,"renderer");n(this,"scene");n(this,"camera");n(this,"composer");n(this,"bloomPass");n(this,"filmPass");n(this,"colorCorrectionPass");n(this,"vignettePass");n(this,"claudeRayPass");n(this,"godRayPass");n(this,"useBasicRendering");n(this,"volumetricLightEnabled");n(this,"useClaudeRays");this.renderer=e,this.scene=t,this.camera=i,this.composer=null,this.bloomPass=null,this.filmPass=null,this.colorCorrectionPass=null,this.vignettePass=null,this.claudeRayPass=null,this.godRayPass=null,this.useBasicRendering=!1,this.volumetricLightEnabled=!0,this.useClaudeRays=!1}setupPostProcessing(){try{this.composer=new ve(this.renderer);const e=new be(this.scene,this.camera);this.composer.addPass(e),this.setupGodRayEffects(),this.setupBloomPass(),this.setupFXAAPass(),this.setupColorCorrectionPass(),this.setupFilmPass(),this.setupVignettePass(),console.log("Post-processing setup complete")}catch(e){console.error("Error setting up post-processing:",e),console.log("Continuing with basic rendering without post-processing"),this.useBasicRendering=!0}}setupBloomPass(){try{this.bloomPass=new Se(new L(window.innerWidth,window.innerHeight),.2,.2,.95),this.composer.addPass(this.bloomPass)}catch(e){console.warn("Error setting up UnrealBloomPass:",e)}}setupFXAAPass(){try{const e=new I(Me);if(e.material&&e.material.uniforms&&e.material.uniforms.resolution){const t="getPixelRatio"in this.renderer?this.renderer.getPixelRatio():1;e.material.uniforms.resolution.value.x=1/(window.innerWidth*t),e.material.uniforms.resolution.value.y=1/(window.innerHeight*t),this.composer.addPass(e)}else console.warn("FXAAShader uniforms not as expected, skipping pass")}catch(e){console.warn("Error setting up FXAAShader:",e)}}setupColorCorrectionPass(){try{this.colorCorrectionPass=new I(ke),this.colorCorrectionPass.uniforms&&this.colorCorrectionPass.uniforms.powRGB&&this.colorCorrectionPass.uniforms.mulRGB?(this.colorCorrectionPass.uniforms.powRGB.value=new g(1.1,1.1,1.2),this.colorCorrectionPass.uniforms.mulRGB.value=new g(1.2,1.1,1),this.composer.addPass(this.colorCorrectionPass)):console.warn("ColorCorrectionShader uniforms not as expected, skipping pass")}catch(e){console.warn("Error setting up ColorCorrectionShader:",e)}}setupFilmPass(){try{this.filmPass=new I(Ce),this.filmPass.uniforms&&this.filmPass.uniforms.nIntensity&&this.filmPass.uniforms.sIntensity&&this.filmPass.uniforms.grayscale?(this.filmPass.uniforms.nIntensity.value=.08,this.filmPass.uniforms.sIntensity.value=.03,this.filmPass.uniforms.grayscale.value=0,this.composer.addPass(this.filmPass)):console.warn("FilmShader uniforms not as expected, skipping pass")}catch(e){console.warn("Error setting up FilmShader:",e)}}setupVignettePass(){try{this.vignettePass=new I(Ee),this.vignettePass.uniforms&&this.vignettePass.uniforms.offset&&this.vignettePass.uniforms.darkness?(this.vignettePass.uniforms.offset.value=.95,this.vignettePass.uniforms.darkness.value=1.6,this.composer.addPass(this.vignettePass)):console.warn("VignetteShader uniforms not as expected, skipping pass")}catch(e){console.warn("Error setting up VignetteShader:",e)}}setupGodRayEffects(){try{this.volumetricLightEnabled=!0,this.useClaudeRays=!1,this.claudeRayPass=je(),this.claudeRayPass.enabled=this.volumetricLightEnabled&&this.useClaudeRays,this.composer.addPass(this.claudeRayPass),console.log("Claude Rays effect created (disabled by default)"),this.godRayPass=Je(),this.godRayPass.enabled=this.volumetricLightEnabled&&!this.useClaudeRays,this.composer.addPass(this.godRayPass),console.log("New volumetric light ray effect added to post-processing chain")}catch(e){console.warn("Error setting up volumetric light shaders:",e)}}adjustBloom(e,t,i){this.bloomPass&&(this.bloomPass.strength=e!==void 0?e:this.bloomPass.strength,this.bloomPass.radius=t!==void 0?t:this.bloomPass.radius,this.bloomPass.threshold=i!==void 0?i:this.bloomPass.threshold)}update(e){if(this.filmPass&&this.filmPass.uniforms&&this.filmPass.uniforms.time&&this.filmPass.uniforms.time.value!==void 0)try{this.filmPass.uniforms.time.value+=e}catch(t){console.warn("Error updating film pass time:",t)}}handleResize(){if(this.composer){this.composer.setSize(window.innerWidth,window.innerHeight);try{const e="getPixelRatio"in this.renderer?this.renderer.getPixelRatio():1,t=this.composer.passes.find(i=>i.material&&i.material.uniforms&&i.material.uniforms.resolution&&i.material.uniforms.resolution.value);t&&(t.material.uniforms.resolution.value.x=1/(window.innerWidth*e),t.material.uniforms.resolution.value.y=1/(window.innerHeight*e))}catch(e){console.warn("Error updating FXAA resolution:",e)}}}render(){this.composer&&!this.useBasicRendering?this.composer.render():this.renderer.render(this.scene,this.camera)}dispose(){this.composer&&this.composer.passes.forEach(e=>{"dispose"in e&&typeof e.dispose=="function"&&e.dispose(),"material"in e&&e.material&&e.material.dispose()})}}class Ke{constructor(e){n(this,"scene");this.scene=e,this.setupSceneGuard()}setupSceneGuard(){typeof window<"u"&&(window.__rendererGuard=!1);const e=this.scene.add.bind(this.scene),t=this.scene.remove.bind(this.scene);this.scene.add=(...i)=>(!window.__rendererGuard&&window&&window.DEBUG_MODE&&console.warn("[RendererFacade] Direct scene.add detected outside renderer facade"),e(...i)),this.scene.remove=(...i)=>(!window.__rendererGuard&&window&&window.DEBUG_MODE&&console.warn("[RendererFacade] Direct scene.remove detected outside renderer facade"),t(...i))}add(e){this._withGuard(()=>this.scene.add(e))}addView(e,t){}removeView(e){}updateView(e,t){}_withGuard(e){const t=window.__rendererGuard;window.__rendererGuard=!0;try{return e()}finally{window.__rendererGuard=t}}findSunObject(){let e=null;return e=this.scene.getObjectByName("sun")??null,e||this.scene.traverse(t=>{t.name==="sun"&&(e=t)}),e}interpolateMeshes(e){const i=this.scene.ecsWorld;if(!(!i||!i.entityManager))try{if(!i.getEntitiesWithComponents)return;const s=i.getEntitiesWithComponents(["TransformComponent","MeshComponent"]);for(const o of s){const r=o.getComponent("TransformComponent"),a=o.getComponent("MeshComponent");if(!r||!a||!a.mesh)continue;const l=new re().copy(r.prevQuaternion).slerp(r.quaternion,e),d=new g().copy(r.prevPosition).lerp(r.position,e);a.mesh.position.copy(d),a.mesh.quaternion.copy(l)}}catch{}}}class et{constructor(e){n(this,"scene");n(this,"instancedMeshes");n(this,"_frameDrawCalls");n(this,"_frameVisibleInstances");n(this,"renderAlpha");this.scene=e,this.instancedMeshes=new Map,this._frameDrawCalls=0,this._frameVisibleInstances=0,this.renderAlpha=0}createInstancedMesh(e,t,i,s){const o=new Pe(t,i,s);return o.count=0,o.frustumCulled=!0,this.scene.add(o),this.instancedMeshes.set(e,{mesh:o,count:0,maxCount:s,dummy:new Te}),o}updateInstance(e,t,i,s,o){const r=this.instancedMeshes.get(e);if(!r)return-1;const a=t!==void 0?t:r.count;if(a>=r.count){if(a>=r.maxCount)return-1;r.count=a+1}return r.dummy.position.copy(i),s&&r.dummy.quaternion.copy(s),o&&r.dummy.scale.copy(o),r.dummy.updateMatrix(),r.mesh.setMatrixAt(a,r.dummy.matrix),r.mesh.instanceMatrix.needsUpdate=!0,a}updateInstancedMeshes(){for(const[,e]of this.instancedMeshes.entries())e.mesh.instanceMatrix.needsUpdate&&(e.mesh.instanceMatrix.needsUpdate=!1)}removeInstance(e,t){const i=this.instancedMeshes.get(e);if(!(!i||t>=i.count)){if(t<i.count-1){const s=new xe;i.mesh.getMatrixAt(i.count-1,s),i.mesh.setMatrixAt(t,s)}i.count--,i.mesh.count=i.count,i.mesh.instanceMatrix.needsUpdate=!0}}updatePerformanceCounters(e){this._frameDrawCalls=0,this._frameVisibleInstances=0;try{for(const[,s]of this.instancedMeshes)s&&s.mesh&&(this._frameVisibleInstances+=s.mesh.count||0)}catch{}return e.info.render.calls}finalizePerformanceCounters(e,t){const i=e.info.render.calls;this._frameDrawCalls=Math.max(0,i-t),window.__perf&&(window.__perf.drawCalls=i,window.__perf.visibleInstances=this._frameVisibleInstances)}dispose(){console.log("Disposing instanced meshes..."),this.instancedMeshes.forEach(e=>{e.mesh&&(e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&(Array.isArray(e.mesh.material)?e.mesh.material.forEach(t=>t.dispose()):e.mesh.material.dispose()),this.scene.remove(e.mesh))}),this.instancedMeshes.clear()}disposeMaterial(e){for(const t in e){const i=e[t];i&&i.isTexture&&i.dispose()}e.dispose()}}class tt{constructor(e,t,i){n(this,"postProcessingManager");n(this,"sceneApiManager");n(this,"camera");this.postProcessingManager=e,this.sceneApiManager=t,this.camera=i}update(){this.postProcessingManager.volumetricLightEnabled&&(this.postProcessingManager.useClaudeRays?this.updateClaudeRayPosition():this.updateVolumetricLightPosition())}updateClaudeRayPosition(){try{if(!this.postProcessingManager.claudeRayPass||!this.postProcessingManager.claudeRayPass.uniforms||!this.postProcessingManager.claudeRayPass.uniforms.lightPosition||!this.camera)return;const e=this.sceneApiManager.findSunObject();if(e){const t=new g;e.getWorldPosition(t);const i=t.clone();i.project(this.camera);const s=(i.x+1)/2,o=(i.y+1)/2;this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(s,o)}else this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(.5,.5)}catch(e){console.warn("Error updating Claude Ray position:",e),this.postProcessingManager.claudeRayPass&&this.postProcessingManager.claudeRayPass.uniforms&&this.postProcessingManager.claudeRayPass.uniforms.lightPosition&&this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(.5,.5)}}updateVolumetricLightPosition(){try{if(!this.postProcessingManager.godRayPass||!this.postProcessingManager.godRayPass.uniforms||!this.postProcessingManager.godRayPass.uniforms.lightPosition||!this.camera)return;const e=this.sceneApiManager.findSunObject();if(e){const t=new g;e.getWorldPosition(t);const i=t.clone();i.project(this.camera);const s=(i.x+1)/2,o=(i.y+1)/2,r=this.camera.position.distanceTo(t);this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(s,o);const l=Math.min(1,r/13e4);this.postProcessingManager.godRayPass.uniforms.sunDistance.value=l;const d=new g(0,0,-1).applyQuaternion(this.camera.quaternion),h=new g().subVectors(t,this.camera.position).normalize(),u=d.dot(h);this.postProcessingManager.godRayPass.uniforms.sunVisibility.value=Math.max(0,u)}else this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(.5,.5),this.postProcessingManager.godRayPass.uniforms.sunDistance.value=1,this.postProcessingManager.godRayPass.uniforms.sunVisibility.value=0}catch(e){console.warn("Error updating volumetric light position:",e),this.postProcessingManager.godRayPass&&this.postProcessingManager.godRayPass.uniforms&&(this.postProcessingManager.godRayPass.uniforms.lightPosition&&this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(.5,.5),this.postProcessingManager.godRayPass.uniforms.sunDistance&&(this.postProcessingManager.godRayPass.uniforms.sunDistance.value=1),this.postProcessingManager.godRayPass.uniforms.sunVisibility&&(this.postProcessingManager.godRayPass.uniforms.sunVisibility.value=0))}}setRayType(e){this.postProcessingManager.useClaudeRays=e,this.postProcessingManager.claudeRayPass&&(this.postProcessingManager.claudeRayPass.enabled=this.postProcessingManager.volumetricLightEnabled&&this.postProcessingManager.useClaudeRays),this.postProcessingManager.godRayPass&&(this.postProcessingManager.godRayPass.enabled=this.postProcessingManager.volumetricLightEnabled&&!this.postProcessingManager.useClaudeRays),console.log(`Using ${this.postProcessingManager.useClaudeRays?"Claude Rays":"Volumetric God Rays"} effect`)}setVolumetricLightEnabled(e){this.postProcessingManager.volumetricLightEnabled=e,this.postProcessingManager.useClaudeRays&&this.postProcessingManager.claudeRayPass?this.postProcessingManager.claudeRayPass.enabled=e:this.postProcessingManager.godRayPass&&(this.postProcessingManager.godRayPass.enabled=e),console.log(`Volumetric lighting ${e?"enabled":"disabled"}`)}updateVolumetricLightParams(e={}){if(!this.postProcessingManager.godRayPass||!this.postProcessingManager.godRayPass.uniforms)return;const t=this.postProcessingManager.godRayPass.uniforms;e.intensity!==void 0&&(t.intensity.value=e.intensity),e.decay!==void 0&&(t.decay.value=e.decay),e.density!==void 0&&(t.density.value=e.density),e.weight!==void 0&&(t.weight.value=e.weight),e.samples!==void 0&&(t.samples.value=e.samples),e.sunColor!==void 0&&(t.sunColor.value=new B(e.sunColor)),e.scattering!==void 0&&(t.scattering.value=e.scattering),e.attenuationMultiplier!==void 0&&(t.attenuationMultiplier.value=e.attenuationMultiplier)}updateClaudeRayParams(e={}){if(!this.postProcessingManager.claudeRayPass||!this.postProcessingManager.claudeRayPass.uniforms)return;const t=this.postProcessingManager.claudeRayPass.uniforms;e.exposure!==void 0&&(t.exposure.value=e.exposure),e.decay!==void 0&&(t.decay.value=e.decay),e.density!==void 0&&(t.density.value=e.density),e.weight!==void 0&&(t.weight.value=e.weight),e.lightColor!==void 0&&(t.lightColor.value=new B(e.lightColor))}setVolumetricLightIntensity(e){if(this.postProcessingManager.useClaudeRays){if(!this.postProcessingManager.claudeRayPass||!this.postProcessingManager.claudeRayPass.uniforms)return;e=Math.max(0,Math.min(1,e));const t=.2+e*.4,i=.15+e*.25,s=.7+e*.3;this.updateClaudeRayParams({exposure:t,weight:i,density:s})}else{if(!this.postProcessingManager.godRayPass||!this.postProcessingManager.godRayPass.uniforms)return;e=Math.max(0,Math.min(1,e)),this.updateVolumetricLightParams({intensity:.3+e*.4,weight:.35+e*.3,density:.45+e*.25,scattering:.25+e*.25})}console.log(`Volumetric light intensity set to ${e.toFixed(2)}`)}}class Y{constructor(){n(this,"scene");n(this,"camera");n(this,"renderer");n(this,"renderAlpha",0);n(this,"lightingManager");n(this,"postProcessingManager");n(this,"sceneApiManager");n(this,"renderHelpers");n(this,"volumetricLightingManager");n(this,"composer");n(this,"filmPass");n(this,"volumetricLightEnabled");n(this,"useClaudeRays");console.log("Initializing enhanced renderer..."),this.scene=new Le,this.camera=new le(50,window.innerWidth/window.innerHeight,.1,4e5),this.renderAlpha=0}static async create(){const e=new Y;return await e.init(),e}async init(){this.renderer=await this.createRenderer(),"shadowMap"in this.renderer&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=N),"toneMapping"in this.renderer&&(this.renderer.toneMapping=oe,this.renderer.toneMappingExposure=1),this.setupRenderer(),this.lightingManager=new Xe(this.scene,this.renderer,this.camera),this.postProcessingManager=new Qe(this.renderer,this.scene,this.camera),this.sceneApiManager=new Ke(this.scene),this.renderHelpers=new et(this.scene),this.volumetricLightingManager=new tt(this.postProcessingManager,this.sceneApiManager,this.camera),this.lightingManager.setupLighting(),this.postProcessingManager.setupPostProcessing(),this.setupResizeHandler(),this.scene.lightingManager=this.lightingManager,this.composer=this.postProcessingManager.composer||void 0,this.filmPass=this.postProcessingManager.filmPass||void 0,this.volumetricLightEnabled=this.postProcessingManager.volumetricLightEnabled,this.useClaudeRays=this.postProcessingManager.useClaudeRays,console.log("Enhanced renderer initialized successfully")}async createRenderer(){try{const e=new Ae({antialias:!0,powerPreference:"high-performance"});return await e.init(),console.log("WebGPU renderer initialized"),e}catch{console.log("WebGPU not available, falling back to WebGL2")}if(!J.isWebGL2Available()){const e=J.getWebGL2ErrorMessage();throw document.body.appendChild(e),console.error("WebGL 2 is required but not available."),new Error("WebGL 2 not available")}return console.log("WebGL 2 is available."),new Ie({antialias:!0,powerPreference:"high-performance",logarithmicDepthBuffer:!0,stencil:!0})}setupRenderer(){"setSize"in this.renderer&&this.renderer.setSize(window.innerWidth,window.innerHeight),"setClearColor"in this.renderer&&this.renderer.setClearColor(0),"domElement"in this.renderer&&document.body.appendChild(this.renderer.domElement),"outputColorSpace"in this.renderer&&(this.renderer.outputColorSpace=ae),this.camera.position.z=10,this.camera.far=4e5,this.camera.updateProjectionMatrix(),"shadowMap"in this.renderer&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=N,"autoUpdate"in this.renderer.shadowMap&&(this.renderer.shadowMap.autoUpdate=!0))}setupResizeHandler(){window.addEventListener("resize",()=>{this.handleResize()})}getScene(){return this.scene}getCamera(){return this.camera}handleResize(){if(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),"setSize"in this.renderer&&this.renderer.setSize(window.innerWidth,window.innerHeight),this.lightingManager&&this.lightingManager.handleResize(),this.composer){this.composer.setSize(window.innerWidth,window.innerHeight);try{const e="getPixelRatio"in this.renderer?this.renderer.getPixelRatio():1,t=this.composer.passes.find(i=>i.material&&i.material.uniforms&&i.material.uniforms.resolution&&i.material.uniforms.resolution.value);t&&(t.material.uniforms.resolution.value.x=1/(window.innerWidth*e),t.material.uniforms.resolution.value.y=1/(window.innerHeight*e))}catch(e){console.warn("Error updating FXAA resolution:",e)}}}add(e){this._withGuard(()=>this.scene.add(e))}adjustBloom(e,t,i){this.postProcessingManager&&this.postProcessingManager.adjustBloom(e,t,i)}update(e){if(this.filmPass&&this.filmPass.uniforms&&this.filmPass.uniforms.time&&this.filmPass.uniforms.time.value!==void 0)try{this.filmPass.uniforms.time.value+=e}catch(t){console.warn("Error updating film pass time:",t)}this.volumetricLightEnabled&&(this.useClaudeRays?this.updateClaudeRayPosition():this.updateVolumetricLightPosition()),this.updateInstancedMeshes()}render(){if(this.renderHelpers){const e=this.renderHelpers.updatePerformanceCounters(this.renderer);this.postProcessingManager&&this.postProcessingManager.render(),this.renderHelpers.finalizePerformanceCounters(this.renderer,e)}else this.postProcessingManager&&this.postProcessingManager.render()}interpolateMeshes(e){this.renderAlpha=e,this.sceneApiManager&&this.sceneApiManager.interpolateMeshes(e)}addView(e,t){this.sceneApiManager&&this.sceneApiManager.addView(e,t)}removeView(e){this.sceneApiManager&&this.sceneApiManager.removeView(e)}_withGuard(e){return this.sceneApiManager?this.sceneApiManager._withGuard(e):e()}updateView(e,t){this.sceneApiManager&&this.sceneApiManager.updateView(e,t)}createInstancedMesh(e,t,i,s){return this.renderHelpers?this.renderHelpers.createInstancedMesh(e,t,i,s):null}updateInstance(e,t,i,s,o){return this.renderHelpers?!!this.renderHelpers.updateInstance(e,t,i,s,o):!1}updateInstancedMeshes(){this.renderHelpers&&this.renderHelpers.updateInstancedMeshes()}removeInstance(e,t){this.renderHelpers&&this.renderHelpers.removeInstance(e,t)}dispose(){console.log("Disposing renderer resources..."),window.removeEventListener("resize",this.handleResize),this.postProcessingManager&&this.postProcessingManager.dispose(),this.lightingManager&&this.lightingManager.dispose(),this.renderHelpers&&this.renderHelpers.dispose(),this.scene.traverse(e=>{"geometry"in e&&e.geometry&&e.geometry.dispose(),"material"in e&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>{this.renderHelpers&&this.renderHelpers.disposeMaterial(t)}):this.renderHelpers&&this.renderHelpers.disposeMaterial(e.material))}),"dispose"in this.renderer&&this.renderer.dispose(),console.log("Renderer resources disposed")}setRayType(e){this.volumetricLightingManager&&this.lightingManager&&(this.volumetricLightingManager.setRayType(e),this.lightingManager.adjustLightingForRayType(e))}setVolumetricLightEnabled(e){this.volumetricLightingManager&&this.volumetricLightingManager.setVolumetricLightEnabled(e)}updateVolumetricLightParams(e={}){this.volumetricLightingManager&&this.volumetricLightingManager.updateVolumetricLightParams(e)}updateClaudeRayParams(e={}){this.volumetricLightingManager&&this.volumetricLightingManager.updateClaudeRayParams(e)}setVolumetricLightIntensity(e){this.volumetricLightingManager&&this.volumetricLightingManager.setVolumetricLightIntensity(e)}updateClaudeRayPosition(){this.volumetricLightingManager&&this.volumetricLightingManager.updateClaudeRayPosition()}updateVolumetricLightPosition(){this.volumetricLightingManager&&this.volumetricLightingManager.updateVolumetricLightPosition()}}class it{constructor(e,t){n(this,"mesh");n(this,"thrusterEffects");n(this,"time");this.mesh=t,this.thrusterEffects=[],this.time=0,this.createThrusterEffects()}createThrusterEffects(){const e=(t,i,s)=>{const{baseRadius:o,length:r,color:a,glowColor:l,type:d}=s,h=new D,u=8,f=[];for(let p=0;p<u;p++){const v=p/u,C=o*(1-v*.7),A=o*(1-(v+1/u)*.7),x=r/u,z=new U(C,A,x,12,1,!1),X=new k({color:new B(a).lerp(new B(l),v),transparent:!0,opacity:1-v*.3,blending:G,side:O,depthTest:!1}),F=new w(z,X);i.z!==0?(z.rotateX(Math.PI/2),F.position.z=i.z*(p*x+x/2)):i.x!==0&&(z.rotateZ(Math.PI/2),F.position.x=i.x*(p*x+x/2)),f.push({mesh:F,material:X}),h.add(F)}return h.position.copy(t),h.visible=!1,this.mesh.add(h),{group:h,beams:f,type:d}};this.thrusterEffects.push(e(new g(0,0,1.2),new g(0,0,1),{baseRadius:.25,length:2.5,color:16755200,glowColor:35071,type:"main"})),this.thrusterEffects.push(e(new g(.7,0,.2),new g(1,0,0),{baseRadius:.15,length:1,color:16755200,glowColor:43775,type:"right_thruster"})),this.thrusterEffects.push(e(new g(-.7,0,.2),new g(-1,0,0),{baseRadius:.15,length:1,color:16755200,glowColor:43775,type:"left_thruster"})),this.thrusterEffects.push(e(new g(0,0,-1.2),new g(0,0,-1),{baseRadius:.2,length:1.8,color:16746496,glowColor:16729088,type:"reverse"}))}updateParticles(e,t){this.time+=.016;const i=window.inputIntent||0,s=e.left||(i&4)!==0,o=e.right||(i&8)!==0;this.thrusterEffects.forEach(r=>{const{group:a,beams:l,type:d}=r;let h=!1,u=0;switch(d){case"main":h=e.forward||t.length()>1,u=e.forward?e.boost?1.5:1:.5;break;case"right_thruster":h=s,u=e.boost?1.5:1.2;break;case"left_thruster":h=o,u=e.boost?1.5:1.2;break;case"reverse":h=e.backward,u=e.boost?1.3:1;break}a.visible=h,h&&l&&l.forEach((f,p)=>{const v=p/l.length,C=.95+Math.sin(this.time*10+p)*.05;f.material.opacity=Math.max(.7,(1-v*.2)*u*C),f.mesh.scale.x=f.mesh.scale.y=1+Math.sin(this.time*8+p)*.05,f.mesh.scale.z=1+u*.3})})}updateTrailVisibility(e,t,i){const s=this.thrusterEffects.find(o=>o.type==="main");if(s){const o=t.forward||e&&i.length()>2;s.group.visible=o}}dispose(){this.thrusterEffects.forEach(e=>{e.group&&(e.group.parent&&e.group.parent.remove(e.group),e.group.traverse(t=>{if("geometry"in t&&t.geometry&&t.geometry.dispose(),"material"in t&&t.material){const i=t.material;Array.isArray(i)?i.forEach(s=>s.dispose()):i.dispose()}}))}),this.thrusterEffects=[]}}class st{constructor(e,t=2){n(this,"scene");n(this,"shipScale");n(this,"mesh");n(this,"thrusters");n(this,"leftCannon");n(this,"rightCannon");n(this,"leftEmitter");n(this,"rightEmitter");n(this,"miningLaser");this.scene=e,this.shipScale=t,this.mesh=null,this.thrusters=[],this.leftCannon=null,this.rightCannon=null,this.leftEmitter=null,this.rightEmitter=null,this.miningLaser=null}createSpaceship(){this.mesh=new D,this.mesh.scale.set(this.shipScale,this.shipScale,this.shipScale),this.mesh.position.set(0,2e3,0);const e=new D,t=new U(.4,.5,1.8,12),i=new P({color:16777215,specular:16766720,shininess:100,emissive:2236962,emissiveIntensity:.1}),s=new w(t,i);s.rotation.x=Math.PI/2,e.add(s);const o=new De(.4,.8,12),r=new w(o,i);return r.position.set(0,0,-1.2),r.rotation.x=-Math.PI/2,e.add(r),this.mesh.add(e),this._createCockpit(),this._createCannons(),this._createEmitters(),this.miningLaser=this.leftEmitter,this._createWings(),this._createGoldAccents(),this._createThrusters(),this.scene.add(this.mesh),this.mesh}_createCockpit(){const e=new T(.35,16,16,0,Math.PI*2,0,Math.PI/2),t=new P({color:8965375,specular:16777215,shininess:100,transparent:!0,opacity:.7,emissive:26367,emissiveIntensity:.1}),i=new w(e,t);i.position.set(0,.25,-.2),i.rotation.x=-Math.PI/2,this.mesh&&this.mesh.add(i)}_createCannons(){const e=new U(.08,.06,2,8),t=new P({color:16766720,specular:16777215,shininess:80,emissive:16766720,emissiveIntensity:.2});this.leftCannon=new w(e,t),this.leftCannon.position.set(.2,0,-1.5),this.leftCannon.rotation.x=Math.PI/2,this.mesh&&this.mesh.add(this.leftCannon),this.rightCannon=new w(e,t),this.rightCannon.position.set(-.2,0,-1.5),this.rightCannon.rotation.x=Math.PI/2,this.mesh&&this.mesh.add(this.rightCannon)}_createEmitters(){const e=new T(.08,16,16),t=new P({color:16737792,emissive:16724736,emissiveIntensity:1});this.leftEmitter=new w(e,t),this.leftEmitter.position.set(.2,0,-2.5),this.mesh&&this.mesh.add(this.leftEmitter),this.rightEmitter=new w(e,t),this.rightEmitter.position.set(-.2,0,-2.5),this.mesh&&this.mesh.add(this.rightEmitter)}_createWings(){const e=s=>{const o=new D,r=new P({color:16777215,specular:16766720,shininess:80,emissive:16777215,emissiveIntensity:.1}),a=new H(.1,.2,.6),l=new w(a,r);l.position.set(s?.55:-.55,0,.2),o.add(l);const d=new H(.8,.1,.5),h=new w(d,r);h.position.set(s?1:-1,0,.2),h.rotation.z=s?Math.PI/8:-Math.PI/8,o.add(h);const u=new H(.3,.08,.3),f=new P({color:16766720,specular:16777215,shininess:100,emissive:16766720,emissiveIntensity:.3}),p=new w(u,f);return p.position.set(s?1.4:-1.4,0,.2),p.rotation.z=s?Math.PI/6:-Math.PI/6,o.add(p),o},t=e(!0);this.mesh&&this.mesh.add(t);const i=e(!1);this.mesh&&this.mesh.add(i)}_createGoldAccents(){const e=(t,i,s,o,r,a,l=0,d=0,h=0)=>{const u=new H(t,i,s),f=new P({color:16766720,specular:16777215,shininess:100,emissive:16766720,emissiveIntensity:.3}),p=new w(u,f);return p.position.set(o,r,a),p.rotation.set(l,d,h),this.mesh&&this.mesh.add(p),p};e(.8,.05,.1,0,-.25,-.3),e(.8,.05,.1,0,-.25,.3),e(.05,.05,1,.3,-.25,0),e(.05,.05,1,-.3,-.25,0)}_createThrusters(){const e=new U(.2,.15,.5,8),t=new P({color:16766720,emissive:16733440,emissiveIntensity:.5}),i=new w(e,t);i.position.z=1.2,i.rotation.x=Math.PI,this.mesh&&this.mesh.add(i),this.thrusters.push({mesh:i,type:"main"});const s=new w(e.clone(),t.clone());s.position.z=-1,s.rotation.x=0,s.scale.set(.6,.6,.6),this.mesh&&this.mesh.add(s),this.thrusters.push({mesh:s,type:"reverse"});const o=new w(e.clone(),t.clone());o.position.set(.5,0,.5),o.rotation.z=Math.PI/2,o.scale.set(.5,.5,.5),this.mesh&&this.mesh.add(o),this.thrusters.push({mesh:o,type:"left"});const r=new w(e.clone(),t.clone());r.position.set(-.5,0,.5),r.rotation.z=-Math.PI/2,r.scale.set(.5,.5,.5),this.mesh&&this.mesh.add(r),this.thrusters.push({mesh:r,type:"right"})}getComponents(){return{mesh:this.mesh,thrusters:this.thrusters,leftCannon:this.leftCannon,rightCannon:this.rightCannon,leftEmitter:this.leftEmitter,rightEmitter:this.rightEmitter,miningLaser:this.miningLaser}}}class nt{constructor(e){n(this,"components");n(this,"fuelTankLevel");n(this,"fuelUpgradeCost");n(this,"engineLevel");n(this,"engineUpgradeCost");n(this,"miningLevel");n(this,"miningUpgradeCost");n(this,"hullLevel");n(this,"hullUpgradeCost");n(this,"scannerLevel");n(this,"scannerUpgradeCost");this.components=e,this.fuelTankLevel=1,this.fuelUpgradeCost=1e3,this.engineLevel=1,this.engineUpgradeCost=800,this.miningLevel=1,this.miningUpgradeCost=1200,this.hullLevel=1,this.hullUpgradeCost=1500,this.scannerLevel=1,this.scannerUpgradeCost=600}upgradeFuelTank(e){return console.log("Upgrading fuel tank"),e.maxFuel*=2,e.fuel=e.maxFuel,this.fuelTankLevel++,this.fuelUpgradeCost*=4,e.maxFuel}upgradeEngine(e){return console.log("Upgrading engines"),e.maxVelocity*=1.25,this.components.thrusters.forEach(t=>{if(t.mesh&&t.mesh.material){const i=t.mesh.material;i.emissiveIntensity+=.2,this.engineLevel%2===0?i.emissive.setHex(16746496):i.emissive.setHex(16755200)}}),this.engineLevel++,this.engineUpgradeCost=Math.floor(this.engineUpgradeCost*2.5),e.maxVelocity}upgradeMiningLaser(e){if(console.log("Upgrading mining laser"),e.miningEfficiency*=1.3,this.components.leftEmitter&&this.components.leftEmitter.material){this.components.leftEmitter.scale.set(1.1,1.1,1.1);const t=[16711680,16733440,16750848,16763904,16772608],i=this.components.leftEmitter.material;this.miningLevel<t.length&&(i.color.setHex(t[this.miningLevel]),i.emissive.setHex(t[this.miningLevel])),i.emissiveIntensity+=.2}if(this.components.rightEmitter&&this.components.rightEmitter.material){this.components.rightEmitter.scale.set(1.1,1.1,1.1);const t=[16711680,16733440,16750848,16763904,16772608],i=this.components.rightEmitter.material;this.miningLevel<t.length&&(i.color.setHex(t[this.miningLevel]),i.emissive.setHex(t[this.miningLevel])),i.emissiveIntensity+=.2}return this.components.leftCannon&&this.components.leftCannon.material&&(this.components.leftCannon.scale.x*=1.1,this.components.leftCannon.scale.y*=1.1),this.components.rightCannon&&this.components.rightCannon.material&&(this.components.rightCannon.scale.x*=1.1,this.components.rightCannon.scale.y*=1.1),this.miningLevel++,this.miningUpgradeCost=Math.floor(this.miningUpgradeCost*3),e.miningEfficiency}upgradeHull(e){if(console.log("Upgrading hull"),e.collisionResistance*=1.25,this.components.mesh){const t=this.components.mesh.children.find(i=>i instanceof D);t&&t.children&&t.children.forEach(i=>{if(i instanceof w&&i.material){const s=i.material;this.hullLevel%2===0?s.color.setHex(3195088):s.color.setHex(3199168),s.shininess+=10}})}return this.hullLevel++,this.hullUpgradeCost=Math.floor(this.hullUpgradeCost*2),e.collisionResistance}upgradeScanner(e){return console.log("Upgrading scanner"),e.scanRange*=1.2,this.scannerLevel++,this.scannerUpgradeCost=Math.floor(this.scannerUpgradeCost*1.8),e.scanRange}getUpgradeLevels(){return{fuelTankLevel:this.fuelTankLevel,fuelUpgradeCost:this.fuelUpgradeCost,engineLevel:this.engineLevel,engineUpgradeCost:this.engineUpgradeCost,miningLevel:this.miningLevel,miningUpgradeCost:this.miningUpgradeCost,hullLevel:this.hullLevel,hullUpgradeCost:this.hullUpgradeCost,scannerLevel:this.scannerLevel,scannerUpgradeCost:this.scannerUpgradeCost}}setUpgradeLevels(e){this.fuelTankLevel=e.fuelTankLevel||1,this.fuelUpgradeCost=e.fuelUpgradeCost||1e3,this.engineLevel=e.engineLevel||1,this.engineUpgradeCost=e.engineUpgradeCost||800,this.miningLevel=e.miningLevel||1,this.miningUpgradeCost=e.miningUpgradeCost||1200,this.hullLevel=e.hullLevel||1,this.hullUpgradeCost=e.hullUpgradeCost||1500,this.scannerLevel=e.scannerLevel||1,this.scannerUpgradeCost=e.scannerUpgradeCost||600}}class ot{constructor(e,t){n(this,"mesh");n(this,"scene");n(this,"undockLocation");this.mesh=e,this.scene=t,this.undockLocation=new g(0,1e4,0)}dock(e,t){console.log("Docking spaceship"),console.log("Spaceship values before docking:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,isDocked:e.isDocked}),e.isDocked=!0,e.velocity.set(0,0,0),this.mesh.visible=!1,console.log("Spaceship values after docking:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,isDocked:e.isDocked})}undock(e,t){console.log("Undocking spaceship"),console.log("Spaceship values before undocking:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,isDocked:e.isDocked});const i=e.shield;if(e.isDocked=!1,this.mesh.visible=!0,e.shield!==i&&(console.log(`SHIELD RESET DETECTED during undock! Value changed from ${i} to ${e.shield}`),console.log("Restoring shield value to:",i),e.shield=i),console.log("Spaceship values after undocking:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,isDocked:e.isDocked}),t&&t(),this.undockLocation)this.mesh.position.copy(this.undockLocation),this.mesh.rotation.set(Math.PI/2,0,0);else{const s=this.scene.getObjectByName("stargate");if(s){const o=s.position.clone();o.z+=550,this.mesh.position.copy(o),this.mesh.rotation.set(0,Math.PI,0)}}return e.velocity.set(0,0,0),this.mesh.position.clone()}setUndockLocation(e){this.undockLocation=e.clone()}getUndockLocation(){return this.undockLocation.clone()}}class at{constructor(){}refuel(e){return console.log("Refueling spaceship"),e.fuel=e.maxFuel,100}repairShield(e,t){const i=e.shield;if(console.log("===== SHIELD REPAIR INITIATED ====="),console.log(`Repairing shield: ${i}  ${e.maxShield}`),e.shield=e.maxShield,console.log(`Shield value is now: ${e.shield} (Expected: ${e.maxShield})`),console.log("Full spaceship state after shield repair:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,fuel:e.fuel,maxFuel:e.maxFuel}),console.log("===== SHIELD REPAIR COMPLETED ====="),window.game&&window.game.world)try{const s=window.game.world.getEntitiesByTag("player");if(s&&s.length>0){const o=s[0].getComponent("HealthComponent");if(o){const r=o.shield;o.shield=e.shield,console.log(`Direct shield update on HealthComponent: ${r}  ${o.shield}`)}}}catch(s){console.error("Error during direct HealthComponent update:",s)}return t&&t(),150}repairHull(e,t){const i=e.hull;if(console.log("===== HULL REPAIR INITIATED ====="),console.log(`Repairing hull: ${i}  ${e.maxHull}`),e.hull=e.maxHull,console.log(`Hull value is now: ${e.hull} (Expected: ${e.maxHull})`),console.log("Full spaceship state after hull repair:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull,fuel:e.fuel,maxFuel:e.maxFuel}),console.log("===== HULL REPAIR COMPLETED ====="),window.game&&window.game.world)try{const s=window.game.world.getEntitiesByTag("player");if(s&&s.length>0){const o=s[0].getComponent("HealthComponent");if(o){const r=o.health;o.health=e.hull,console.log(`Direct hull update on HealthComponent: ${r}  ${o.health}`)}}}catch(s){console.error("Error during direct HealthComponent update:",s)}return t&&t(),200}consumeFuel(e,t){if(t.forward||t.backward||t.left||t.right){let i=.01;t.boost&&(i*=3),e.fuel=Math.max(0,e.fuel-i)}return e.fuel>0}}class rt{constructor(e){n(this,"components");this.components=e}activateMiningLaser(){if(this.components.leftEmitter&&this.components.rightEmitter){const e=this.components.leftEmitter.material;e&&(e.emissiveIntensity=1.5),this.components.leftEmitter.scale.set(1.2,1.2,1.2);const t=this.components.rightEmitter.material;t&&(t.emissiveIntensity=1.5),this.components.rightEmitter.scale.set(1.2,1.2,1.2)}}deactivateMiningLaser(){if(this.components.leftEmitter&&this.components.rightEmitter){const e=this.components.leftEmitter.material;e&&(e.emissiveIntensity=1),this.components.leftEmitter.scale.set(1,1,1);const t=this.components.rightEmitter.material;t&&(t.emissiveIntensity=1),this.components.rightEmitter.scale.set(1,1,1)}}updateTrailVisibility(e,t,i,s){s&&s.updateTrailVisibility(e,t,i)}updateParticles(e,t,i){i&&i.updateParticles(e,t)}}class lt{constructor(){}subscribeToDestructionEvents(e,t){e&&(e.subscribe("entity.destroyed",i=>{const s=i.data.entity;if(s&&s.hasTag&&s.hasTag("player")){console.log("Player entity destroyed - updating spaceship state");const o=s.getComponent("HealthComponent");let r=0,a=0;o?(r=o.health,a=o.shield):(r=0,a=0),t(r,a)}}),console.log("Spaceship subscribed to destruction events"))}syncValuesToHealthComponent(e){console.log("Beginning shield and hull sync to HealthComponent"),console.log("Current spaceship values:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull});const t={shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull};console.log(`Preparing to sync values to player HealthComponent: Shield=${e.shield}, Hull=${e.hull}`);try{window.game&&window.game.messageBus?(window.game.messageBus.publish("player.syncHealth",t),console.log("Published player.syncHealth event to game.messageBus with values:",t)):window.mainMessageBus?(window.mainMessageBus.publish("player.syncHealth",t),console.log("Published player.syncHealth event to mainMessageBus with values:",t)):console.warn("No message bus available to sync health values")}catch(i){console.error("Error publishing sync event:",i)}try{if(window.game&&window.game.world){const i=window.game.world.getEntitiesByTag("player");if(console.log(`Found ${i?i.length:0} player entities for direct sync`),i&&i.length>0){const o=i[0].getComponent("HealthComponent");if(o){console.log("DIRECT SYNC - HealthComponent before sync:",{shield:o.shield,maxShield:o.maxShield,health:o.health,maxHealth:o.maxHealth}),console.log("DIRECT SYNC - Spaceship values to sync:",{shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull});const r=o.shield;o.shield=e.shield,o.maxShield=e.maxShield;const a=o.health;o.health=e.hull,o.maxHealth=e.maxHull,console.log(`Directly synced values to HealthComponent: Shield ${r}  ${o.shield}, Hull ${a}  ${o.health}`),console.log("DIRECT SYNC - HealthComponent after sync:",{shield:o.shield,maxShield:o.maxShield,health:o.health,maxHealth:o.maxHealth})}else console.warn("Player entity found but has no HealthComponent")}else console.warn("No player entities found for direct sync")}}catch(i){console.error("Error directly syncing values to HealthComponent:",i)}}}class ct{constructor(e){n(this,"scene");n(this,"mesh");n(this,"thrusters");n(this,"leftCannon");n(this,"rightCannon");n(this,"leftEmitter");n(this,"rightEmitter");n(this,"miningLaser");n(this,"velocity");n(this,"rotation");n(this,"thrust");n(this,"thrustPower");n(this,"strafePower");n(this,"trailEffects");n(this,"shipScale");n(this,"hull");n(this,"maxHull");n(this,"shield");n(this,"maxShield");n(this,"isDestroyed");n(this,"fuel");n(this,"maxFuel");n(this,"fuelConsumptionRate");n(this,"isDocked");n(this,"credits");n(this,"cargo");n(this,"maxVelocity");n(this,"miningEfficiency");n(this,"collisionResistance");n(this,"scanRange");n(this,"deployableLaserCount");n(this,"shipModel");n(this,"shipUpgrades");n(this,"shipDocking");n(this,"shipServices");n(this,"shipVisualEffects");n(this,"healthSync");this.scene=e,this.mesh=null,this.thrusters=[],this.leftCannon=null,this.rightCannon=null,this.leftEmitter=null,this.rightEmitter=null,this.miningLaser=null,this.velocity=new g(0,0,0),this.rotation=new ce(0,0,0),this.thrust={forward:!1,backward:!1,left:!1,right:!1,boost:!1},this.thrustPower=0,this.strafePower=0,this.trailEffects=null,this.shipScale=2,this.hull=100,this.maxHull=100,this.shield=50,this.maxShield=50,this.isDestroyed=!1,this.fuel=100,this.maxFuel=100,this.fuelConsumptionRate=.01,this.isDocked=!0,this.credits=1e3,this.cargo={iron:0,gold:0,platinum:0},this.maxVelocity=25,this.miningEfficiency=1,this.collisionResistance=1,this.scanRange=1e3,this.deployableLaserCount=0,this._initializeModules(),this.createSpaceship(),this.mesh&&(this.trailEffects=new it(this.scene,this.mesh),this.mesh.visible=!1)}_initializeModules(){this.shipModel=new st(this.scene,this.shipScale),this.shipUpgrades=null,this.shipDocking=null,this.shipServices=new at,this.shipVisualEffects=null,this.healthSync=new lt}createSpaceship(){this.mesh=this.shipModel.createSpaceship();const e=this.shipModel.getComponents();this.thrusters=e.thrusters,this.leftCannon=e.leftCannon??null,this.rightCannon=e.rightCannon??null,this.leftEmitter=e.leftEmitter??null,this.rightEmitter=e.rightEmitter??null,this.miningLaser=e.miningLaser??null,this.shipUpgrades=new nt(e),this.mesh&&(this.shipDocking=new ot(this.mesh,this.scene)),this.shipVisualEffects=new rt(e)}update(e){this.updateParticles&&!this.isDocked&&this.updateParticles()}activateMiningLaser(){var e;(e=this.shipVisualEffects)==null||e.activateMiningLaser()}deactivateMiningLaser(){var e;(e=this.shipVisualEffects)==null||e.deactivateMiningLaser()}updateParticles(){var e;(e=this.shipVisualEffects)==null||e.updateParticles(this.thrust,this.velocity,this.trailEffects)}updateTrailVisibility(e){var t;(t=this.shipVisualEffects)==null||t.updateTrailVisibility(e,this.thrust,this.velocity,this.trailEffects)}dock(){var e;(e=this.shipDocking)==null||e.dock(this,this.syncValuesToHealthComponent.bind(this))}undock(){var e;return(e=this.shipDocking)==null?void 0:e.undock(this,this.syncValuesToHealthComponent.bind(this))}refuel(){return this.shipServices.refuel(this)}repairShield(){return this.shipServices.repairShield(this,this.syncValuesToHealthComponent.bind(this))}repairHull(){return this.shipServices.repairHull(this,this.syncValuesToHealthComponent.bind(this))}consumeFuel(){return this.shipServices.consumeFuel(this,this.thrust)}upgradeFuelTank(){var e;return(e=this.shipUpgrades)==null?void 0:e.upgradeFuelTank(this)}upgradeEngine(){var e;return(e=this.shipUpgrades)==null?void 0:e.upgradeEngine(this)}upgradeMiningLaser(){var e;return(e=this.shipUpgrades)==null?void 0:e.upgradeMiningLaser(this)}upgradeHull(){var e;return(e=this.shipUpgrades)==null?void 0:e.upgradeHull(this)}upgradeScanner(){var e;return(e=this.shipUpgrades)==null?void 0:e.upgradeScanner(this)}get fuelTankLevel(){var e;return((e=this.shipUpgrades)==null?void 0:e.fuelTankLevel)||1}get fuelUpgradeCost(){var e;return((e=this.shipUpgrades)==null?void 0:e.fuelUpgradeCost)||1e3}get engineLevel(){var e;return((e=this.shipUpgrades)==null?void 0:e.engineLevel)||1}get engineUpgradeCost(){var e;return((e=this.shipUpgrades)==null?void 0:e.engineUpgradeCost)||800}get miningLevel(){var e;return((e=this.shipUpgrades)==null?void 0:e.miningLevel)||1}get miningUpgradeCost(){var e;return((e=this.shipUpgrades)==null?void 0:e.miningUpgradeCost)||1200}get hullLevel(){var e;return((e=this.shipUpgrades)==null?void 0:e.hullLevel)||1}get hullUpgradeCost(){var e;return((e=this.shipUpgrades)==null?void 0:e.hullUpgradeCost)||1500}get scannerLevel(){var e;return((e=this.shipUpgrades)==null?void 0:e.scannerLevel)||1}get scannerUpgradeCost(){var e;return((e=this.shipUpgrades)==null?void 0:e.scannerUpgradeCost)||600}subscribeToDestructionEvents(e){this.healthSync.subscribeToDestructionEvents(e,this.handleDestruction.bind(this))}syncValuesToHealthComponent(){this.healthSync.syncValuesToHealthComponent(this)}handleDestruction(e,t){this.isDestroyed=!0,this.hull=e,this.shield=t,this.mesh&&this.trailEffects&&this.trailEffects.particleSystems&&this.trailEffects.particleSystems.forEach(i=>{i&&i.system&&(i.system.visible=!1)})}get position(){return this.mesh?this.mesh.position:new g(0,0,0)}set position(e){this.mesh&&this.mesh.position.copy(e)}get undockLocation(){var e;return((e=this.shipDocking)==null?void 0:e.getUndockLocation())||new g(0,1e4,0)}set undockLocation(e){this.shipDocking&&this.shipDocking.setUndockLocation(e)}}const m=class m{constructor(e){n(this,"scene");n(this,"spaceship");n(this,"camera");n(this,"rotationState");n(this,"collided");n(this,"raycaster");n(this,"direction");n(this,"collisionDistance");n(this,"normalizedDeltaTime",0);n(this,"shakeIntensity",0);n(this,"shakeTime",0);n(this,"recoilIntensity",0);n(this,"recoilTime",0);n(this,"recoilDirection",new g);n(this,"currentZoom",1);n(this,"targetZoom",1);this.scene=e,this.spaceship=null,this.camera=null,this.rotationState={x:0,y:0},this.collided=!1,this.raycaster=new he,this.direction=new g(0,0,-1),this.collisionDistance=m.COLLISION_DISTANCE,this.subscribeToEvents()}subscribeToEvents(){S.subscribe("player.damaged",()=>{this.triggerShake(.5,.2)}),S.subscribe("entity.destroyed",()=>{this.triggerShake(.3,.15)}),S.subscribe("vfx.explosion",()=>{this.triggerShake(.8,.3)}),S.subscribe("weapon.fire",e=>{const{type:t,direction:i}=e.data||{};let s=0;switch(t){case"projectile":s=m.RECOIL_MAX_INTENSITY_PROJECTILE;break;case"laser":s=m.RECOIL_MAX_INTENSITY_LASER;break;case"heavy":s=m.RECOIL_MAX_INTENSITY_HEAVY;break;default:s=m.RECOIL_MAX_INTENSITY_PROJECTILE}i&&this.triggerRecoil(s,i)})}triggerShake(e,t){this.shakeIntensity=Math.max(this.shakeIntensity,e)}triggerRecoil(e,t){this.recoilIntensity=Math.max(this.recoilIntensity,e),this.recoilTime=0,this.recoilDirection.copy(t).negate()}setSpaceship(e){this.spaceship=e}setCamera(e){this.camera=e}update(e){if(!this.spaceship||this.spaceship.isDestroyed||this.spaceship.isDocked||window.game&&window.game.introSequenceActive)return;this.normalizedDeltaTime=e*60;const t=this.spaceship.consumeFuel();let i=new g(0,0,0),s=!1;const o=new g(0,0,-1);if(o.applyQuaternion(this.spaceship.mesh.quaternion),o.dot(this.spaceship.velocity),t){const a=window.inputIntent;let l,d,h,u,f;if(a!==void 0?(l=(a&1)!==0,d=(a&2)!==0,h=(a&4)!==0,u=(a&8)!==0,f=(a&16)!==0):(l=this.spaceship.thrust.forward,d=this.spaceship.thrust.backward,h=this.spaceship.thrust.left,u=this.spaceship.thrust.right,f=this.spaceship.thrust.boost),this.spaceship.thrust.forward=l,this.spaceship.thrust.backward=d,this.spaceship.thrust.left=h,this.spaceship.thrust.right=u,this.spaceship.thrust.boost=f,this.targetZoom=f?m.ZOOM_BOOST_MULTIPLIER:1,l){s=!0;const p=new g(0,0,-.5);f&&p.multiplyScalar(m.BOOST_MULTIPLIER),i.add(p)}if(d&&(s=!0,i.add(new g(0,0,m.THRUST_FORCE))),h&&(s=!0,i.add(new g(-.5,0,0))),u&&(s=!0,i.add(new g(m.THRUST_FORCE,0,0))),s){i.applyQuaternion(this.spaceship.mesh.quaternion),i.multiplyScalar(this.normalizedDeltaTime),this.spaceship.velocity.add(i);const p=this.getMaxVelocity();this.spaceship.velocity.length()>p&&this.spaceship.velocity.normalize().multiplyScalar(p)}}else this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.boost=!1;if(!s&&this.spaceship.velocity.length()>0){const a=m.FRICTION*this.normalizedDeltaTime;this.spaceship.velocity.length()>a?this.spaceship.velocity.multiplyScalar(1-a):this.spaceship.velocity.set(0,0,0)}const r=this.spaceship.velocity.clone().multiplyScalar(this.normalizedDeltaTime);if(this.spaceship.mesh.position.add(r),this.updateShipRotation(),this.updateCamera(),this.spaceship.trailEffects){const a=this.spaceship.velocity.length()>.1;this.spaceship.trailEffects.updateTrailVisibility(a,this.spaceship.thrust,this.spaceship.velocity),this.spaceship.trailEffects.updateParticles(this.spaceship.thrust,this.spaceship.velocity)}this.checkCollisions()}getMaxVelocity(){return this.spaceship&&this.spaceship.maxVelocity?this.spaceship.maxVelocity:m.MAX_VELOCITY}updateShipRotation(){if(!this.spaceship)return;const e=Math.PI*.45;this.rotationState.y=Math.max(Math.min(this.rotationState.y,e),-e);const t=new ce(this.rotationState.y,this.rotationState.x,0,"YXZ"),i=new re().setFromEuler(t);this.spaceship.mesh.quaternion.slerp(i,m.ROTATION_SPEED*this.normalizedDeltaTime)}updateCamera(){if(!this.spaceship||!this.camera)return;if(window.game&&window.game.introSequenceActive){console.log("Skipping camera update - intro sequence active");return}this.currentZoom+=(this.targetZoom-this.currentZoom)*m.ZOOM_LERP_SPEED;const e=this.spaceship.maxVelocity||m.MAX_VELOCITY,t=this.spaceship.velocity.length(),i=Math.min(t/e,1),s=1+i*m.CAMERA_VELOCITY_SCALE,r=m.CAMERA_BASE_OFFSET.clone().multiplyScalar(s).multiplyScalar(this.currentZoom).clone();r.applyQuaternion(this.spaceship.mesh.quaternion);const a=new g().copy(this.spaceship.mesh.position).add(r);this.camera.position.lerp(a,m.CAMERA_LAG),this.shakeIntensity>.01&&this.applyShake(),this.recoilIntensity>.01&&this.applyRecoil();const d=this.spaceship.velocity.clone().normalize().multiplyScalar(i*m.CAMERA_LOOKAHEAD_SCALE),h=new g(0,0,-60);h.applyQuaternion(this.spaceship.mesh.quaternion);const u=new g().copy(this.spaceship.mesh.position).add(h).add(d);this.camera.lookAt(u),(this.camera instanceof le||this.camera instanceof Re)&&(this.camera.far=4e5,this.camera.updateProjectionMatrix())}applyShake(){if(!this.camera||!this.spaceship)return;this.shakeTime+=this.normalizedDeltaTime*.016;const e=Math.sin(this.shakeTime*m.SHAKE_FREQUENCY)*this.shakeIntensity*.5,t=Math.sin(this.shakeTime*m.SHAKE_FREQUENCY*1.3)*this.shakeIntensity*.5,i=Math.sin(this.shakeTime*m.SHAKE_FREQUENCY*.8)*this.shakeIntensity*.3,s=Math.sin(this.shakeTime*m.SHAKE_FREQUENCY*2.5)*this.shakeIntensity*.25,o=Math.sin(this.shakeTime*m.SHAKE_FREQUENCY*3.1)*this.shakeIntensity*.25,r=new g(e+s,t+o,i),a=new g(1,0,0).applyQuaternion(this.camera.quaternion),l=new g(0,1,0).applyQuaternion(this.camera.quaternion),d=new g(0,0,-1).applyQuaternion(this.camera.quaternion),h=new g().addScaledVector(a,r.x).addScaledVector(l,r.y).addScaledVector(d,r.z);this.camera.position.add(h),this.shakeIntensity*=m.SHAKE_DECAY,this.shakeIntensity<.01&&(this.shakeIntensity=0)}applyRecoil(){if(!this.camera||!this.spaceship||this.recoilIntensity<=0)return;this.recoilTime+=this.normalizedDeltaTime*.016;const e=new g().copy(this.recoilDirection).multiplyScalar(this.recoilIntensity*Math.sin(this.recoilTime*m.RECOIL_FREQUENCY)*Math.exp(-this.recoilTime/m.RECOIL_DURATION));this.camera.position.add(e),this.recoilIntensity*=m.RECOIL_DECAY,this.recoilIntensity<.01&&(this.recoilIntensity=0,this.recoilTime=0)}updateRotation(e,t){this.rotationState.x-=e,this.rotationState.y-=t}checkCollisions(){if(!this.scene||!this.spaceship||!this.spaceship.mesh)return;const e=this.spaceship.mesh,t=15,i=e.position.clone();this.scene.traverse(a=>{a.type==="Mesh"&&"geometry"in a&&a.geometry&&typeof a.geometry=="object"&&"type"in a.geometry&&typeof a.geometry.type=="string"&&a.geometry.type.includes("SphereGeometry")&&"userData"in a&&typeof a.userData=="object"&&a.userData!==null&&"isPlayerProjectile"in a.userData&&a.userData.isPlayerProjectile&&"sourceId"in a.userData&&a.userData.sourceId});const s=[],o=this.scene.children.find(a=>a.name==="asteroidBelt");let r=[];o&&"userData"in o&&typeof o.userData=="object"&&o.userData!==null&&"asteroids"in o.userData?(r=o.userData.asteroids,s.push(...r.map(l=>l.mesh))):this.scene.traverse(a=>{if(a.type==="Mesh"&&"geometry"in a&&a.geometry&&typeof a.geometry=="object"&&"type"in a.geometry&&typeof a.geometry.type=="string"&&(a.geometry.type.includes("IcosahedronGeometry")||a.geometry.type.includes("TetrahedronGeometry")||a.geometry.type.includes("OctahedronGeometry"))){const l=Math.sqrt(a.position.x*a.position.x+a.position.z*a.position.z);l>16e3&&l<32e3&&s.push(a)}});for(const a of s){if(!a||!a.visible)continue;const l=i.distanceTo(a.position);let d=0;if(a.geometry&&"parameters"in a.geometry&&typeof a.geometry.parameters=="object"&&a.geometry.parameters!==null&&"radius"in a.geometry.parameters&&typeof a.geometry.parameters.radius=="number"?d=a.geometry.parameters.radius:d=60,l<t+d){y.enabled&&console.log("Asteroid collision detected!","Ship position:",i,"Asteroid position:",a.position,"Distance:",l,"Detection threshold:",t+d),this.handleCollision(a,"asteroid");return}}this.scene.traverse(a=>{if(a.type==="Mesh"&&"geometry"in a&&a.geometry&&typeof a.geometry=="object"&&"type"in a.geometry&&typeof a.geometry.type=="string"&&a.geometry.type.includes("SphereGeometry")&&a.scale.x>=1&&"userData"in a&&typeof a.userData=="object"&&a.userData!==null&&(!("id"in a.userData)||typeof a.userData.id!="string"||!a.userData.id.startsWith("asteroid-"))&&(!("isPlayerProjectile"in a.userData)||!a.userData.isPlayerProjectile)&&a!==e){const l=i.distanceTo(a.position);if("parameters"in a.geometry&&typeof a.geometry.parameters=="object"&&a.geometry.parameters!==null&&"radius"in a.geometry.parameters&&typeof a.geometry.parameters.radius=="number"){const d=a.geometry.parameters.radius*a.scale.x;if("material"in a&&a.material&&typeof a.material=="object"&&"emissive"in a.material&&a.material.emissive&&typeof a.material.emissive=="object"&&"r"in a.material.emissive&&"g"in a.material.emissive&&typeof a.material.emissive.r=="number"&&typeof a.material.emissive.g=="number"&&a.material.emissive.r>.5&&a.material.emissive.g>.5){if(l<d+t){this.handleCollision(a,"sun");return}}else if(l<d+t){this.handleCollision(a,"planet");return}}}})}handleCollision(e,t){if(this.collided||!this.scene||!this.spaceship)return;if(this.collided=!0,y.enabled&&(console.log("=== COLLISION DETECTED ==="),console.log(`Collision type: ${t}`),console.log(`Ship velocity at impact: ${this.spaceship.velocity.length().toFixed(2)} units/frame`),console.log(`Ship position: x=${this.spaceship.mesh.position.x.toFixed(0)}, y=${this.spaceship.mesh.position.y.toFixed(0)}, z=${this.spaceship.mesh.position.z.toFixed(0)}`),console.log(`${t} position: x=${e.position.x.toFixed(0)}, y=${e.position.y.toFixed(0)}, z=${e.position.z.toFixed(0)}`),console.log(`Hull resistance: ${this.spaceship.collisionResistance}`)),this.attemptCollisionRecovery(t)){if(y.enabled&&console.log("Hull absorbed collision damage!"),this.createRecoveryEffect(),e&&e.position){const h=new g().subVectors(this.spaceship.mesh.position,e.position).normalize();this.spaceship.velocity.copy(h.multiplyScalar(5))}window.game&&typeof window.game=="object"&&"audio"in window.game&&window.game.audio&&typeof window.game.audio=="object"&&"playSound"in window.game.audio&&typeof window.game.audio.playSound=="function"&&window.game.audio.playSound("boink"),setTimeout(()=>{this.collided=!1,y.enabled&&console.log("Collision state reset - ship ready for new collisions")},1e3);return}this.spaceship.velocity.set(0,0,0);let i,s,o,r;t==="sun"?(i=16776960,s=60,o="Your ship was incinerated by the sun!",r="SUN_DEATH"):t==="planet"?(i=3394815,s=40,o="Your ship crashed into a planet!",r="COLLISION_PLANET"):(i=16737792,s=20,o="Your ship was destroyed by an asteroid!",r="COLLISION_ASTEROID");const a=new T(s,32,32),l=new k({color:i,transparent:!0,opacity:.8}),d=new w(a,l);d.position.copy(this.spaceship.mesh.position),this.scene.add(d),this.animateExplosion(d),this.spaceship&&(this.spaceship.isDestroyed=!0),console.log("Physics: Initiating game over sequence for collision with",t),S&&typeof S.publish=="function"?(console.log("Physics: Using main message bus"),S.publish("game.over",{reason:o,source:"physics",collisionType:t,type:r})):window.game&&typeof window.game=="object"&&"messageBus"in window.game&&window.game.messageBus&&typeof window.game.messageBus=="object"&&"publish"in window.game.messageBus&&typeof window.game.messageBus.publish=="function"?(console.log("Physics: Using window.game.messageBus"),window.game.messageBus.publish("game.over",{reason:o,source:"physics",collisionType:t,type:r})):R(()=>Promise.resolve().then(()=>$e),void 0).then(h=>{const u=h.MessageBus;console.log("Physics: Using MessageBus.triggerGameOver"),u.triggerGameOver(o,"physics")}).catch(h=>{console.error("Physics: Error importing MessageBus:",h)})}attemptCollisionRecovery(e){if(!this.spaceship||!this.spaceship.collisionResistance)return!1;const t=this.spaceship.collisionResistance;let i=0;switch(e){case"asteroid":i=.5+(t-1)*.08,y.enabled&&console.log(`Asteroid collision recovery chance: ${(i*100).toFixed(1)}%`);break;case"planet":i=.1+(t-1)*.2,y.enabled&&console.log(`Planet collision recovery chance: ${(i*100).toFixed(1)}%`);break;case"sun":i=(t-1)*.05,y.enabled&&console.log(`Sun collision recovery chance: ${(i*100).toFixed(1)}%`);break;default:i=.2+(t-1)*.3,y.enabled&&console.log(`Generic collision recovery chance: ${(i*100).toFixed(1)}%`)}const s=Math.random(),o=s<i;return y.enabled&&console.log(`Recovery roll: ${s.toFixed(3)}, needed ${i.toFixed(3)} or lower to survive`),o}createRecoveryEffect(){if(!this.spaceship||!this.scene)return;const e=new T(60,32,32),t=new k({color:3198928,transparent:!0,opacity:.6,side:O}),i=new w(e,t);i.position.copy(this.spaceship.mesh.position),this.scene.add(i);let s=1;const o=.05,r=.02,a=()=>{if(s>2||i.material.opacity<=0){this.scene.remove(i);return}s+=o,i.scale.set(s,s,s),i.material instanceof k&&(i.material.opacity-=r),this.spaceship&&this.spaceship.mesh&&i.position.copy(this.spaceship.mesh.position),requestAnimationFrame(a)};a()}animateExplosion(e){let t=1;const i=.5,s=.02,o=()=>{if(t>20||e.material instanceof k&&e.material.opacity<=0){this.scene.remove(e);return}t+=i,e.scale.set(t,t,t),e.material instanceof k&&(e.material.opacity-=s),requestAnimationFrame(o)};o()}};n(m,"THRUST_FORCE",.5),n(m,"BOOST_MULTIPLIER",4),n(m,"MAX_VELOCITY",25),n(m,"ROTATION_SPEED",.3),n(m,"COLLISION_DISTANCE",15),n(m,"FRICTION",.01),n(m,"CAMERA_LAG",.1),n(m,"CAMERA_BASE_OFFSET",new g(0,5,25)),n(m,"CAMERA_VELOCITY_SCALE",.3),n(m,"CAMERA_LOOKAHEAD_SCALE",20),n(m,"SHAKE_DECAY",.95),n(m,"SHAKE_FREQUENCY",15),n(m,"RECOIL_DECAY",.85),n(m,"RECOIL_FREQUENCY",20),n(m,"RECOIL_DURATION",.05),n(m,"RECOIL_MAX_INTENSITY_PROJECTILE",.1),n(m,"RECOIL_MAX_INTENSITY_LASER",.2),n(m,"RECOIL_MAX_INTENSITY_HEAVY",.5),n(m,"ZOOM_BOOST_MULTIPLIER",1.3),n(m,"ZOOM_LERP_SPEED",.05);let q=m;class ht{constructor(e,t){n(this,"spaceship");n(this,"physics");n(this,"isPointerLocked");n(this,"mouseSensitivity");this.spaceship=e,this.physics=t,this.isPointerLocked=!1,this.mouseSensitivity=.001,this.setupKeyboardControls(),this.setupPointerLock()}setupKeyboardControls(){document.addEventListener("keydown",e=>{const t=window;if(!(this.spaceship.isDocked||t.game&&t.game.introSequenceActive))switch(e.key.toLowerCase()){case"w":t.inputIntent=(t.inputIntent||0)|1;break;case"s":t.inputIntent=(t.inputIntent||0)|2;break;case"a":t.inputIntent=(t.inputIntent||0)|4;break;case"d":t.inputIntent=(t.inputIntent||0)|8;break;case"shift":t.inputIntent=(t.inputIntent||0)|16;break}}),document.addEventListener("keyup",e=>{const t=window;if(t.game&&t.game.introSequenceActive){this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.boost=!1;return}const i=s=>{t.inputIntent=(t.inputIntent||0)&~s};switch(e.key.toLowerCase()){case"w":i(1);break;case"s":i(2);break;case"a":i(4);break;case"d":i(8);break;case"shift":i(16);break}})}setupPointerLock(){const e=document.querySelector("canvas");e.addEventListener("pointerdown",i=>{i.preventDefault(),!this.isPointerLocked&&!this.spaceship.isDocked&&e.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{document.pointerLockElement===e?(this.isPointerLocked=!0,document.addEventListener("pointermove",this.handlePointerMove.bind(this))):(this.isPointerLocked=!1,document.removeEventListener("pointermove",this.handlePointerMove.bind(this)))});const t=document.createElement("div");t.id="pointer-lock-instructions",t.innerHTML=`
            Click on the game to enable mouse rotation
        `,t.style.position="absolute",t.style.top="60px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.padding="10px 20px",t.style.borderRadius="20px",t.style.border="1px solid #30cfd0",t.style.boxShadow="0 0 10px #30cfd0",t.style.color="#fff",t.style.fontFamily="Courier New, monospace",t.style.zIndex="999",t.style.textAlign="center",document.body.appendChild(t),document.addEventListener("pointerlockchange",()=>{t.style.display=document.pointerLockElement?"none":"block"})}handlePointerMove(e){const t=window;if(t.game&&t.game.introSequenceActive||!this.isPointerLocked)return;const i=e.movementX||0,s=e.movementY||0;this.physics.updateRotation(i*this.mouseSensitivity,s*this.mouseSensitivity)}isLocked(){return this.isPointerLocked}exitPointerLock(){document.exitPointerLock&&document.exitPointerLock()}}class dt{constructor(e,t,i){n(this,"spaceship");n(this,"physics");n(this,"controls");n(this,"gamepads");n(this,"activeGamepadIndex");n(this,"enabled");n(this,"vibrationEnabled");n(this,"deadZone");n(this,"triggerDeadZone");n(this,"lookSensitivity");n(this,"movementSensitivity");n(this,"rotationSmoothing");n(this,"buttonMap");n(this,"axisMap");n(this,"buttonStates");n(this,"previousButtonStates");n(this,"wasFiring");n(this,"debugMode");n(this,"debugDisplay");n(this,"rightStickXAxis");n(this,"rightStickYAxis");n(this,"axisDetectionMode");this.spaceship=e,this.physics=t,this.controls=i,this.gamepads={},this.activeGamepadIndex=null,this.enabled=!0,this.vibrationEnabled=!0,this.deadZone=.15,this.triggerDeadZone=.15,this.lookSensitivity=1,this.movementSensitivity=1,this.rotationSmoothing={targetX:0,targetY:0,currentX:0,currentY:0,smoothingFactor:.15},this.buttonMap={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,BACK:8,START:9,L3:10,R3:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15},this.axisMap={LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3,LT:4,RT:5},this.buttonStates={},this.previousButtonStates={},this.wasFiring=!1,this.init(),this.debugMode=!1,this.debugDisplay=null,this.rightStickXAxis=3,this.rightStickYAxis=4,this.axisDetectionMode=!1,globalThis.mainMessageBus&&globalThis.mainMessageBus.subscribe("input.vibrate",s=>{s.data&&this.vibrate(s.data.intensity,s.data.duration)})}init(){if(!("getGamepads"in navigator)){console.warn("Gamepad API not supported in this browser");return}window.addEventListener("gamepadconnected",e=>{console.log(`Gamepad connected: ${e.gamepad.id} (index: ${e.gamepad.index})`),this.onGamepadConnected(e.gamepad)}),window.addEventListener("gamepaddisconnected",e=>{console.log(`Gamepad disconnected: ${e.gamepad.id} (index: ${e.gamepad.index})`),this.onGamepadDisconnected(e.gamepad)}),this.scanForGamepads(),console.log("Gamepad handler initialized - ready for controller input")}scanForGamepads(){const e=navigator.getGamepads();for(let t=0;t<e.length;t++){const i=e[t];i&&this.onGamepadConnected(i)}}onGamepadConnected(e){this.gamepads[e.index]=e,this.activeGamepadIndex===null&&(this.activeGamepadIndex=e.index,this.showNotification(`Controller connected: ${this.getGamepadName(e)}`),this.vibrate(.3,200))}onGamepadDisconnected(e){if(delete this.gamepads[e.index],this.activeGamepadIndex===e.index){this.activeGamepadIndex=null,this.showNotification("Controller disconnected");for(let t in this.gamepads){this.activeGamepadIndex=parseInt(t),this.showNotification(`Switched to controller: ${this.getGamepadName(this.gamepads[parseInt(t,10)])}`);break}}}getGamepadName(e){const t=e.id.toLowerCase();return t.includes("xbox")?"Xbox Controller":t.includes("playstation")||t.includes("dualshock")?"PlayStation Controller":t.includes("switch")||t.includes("pro controller")?"Switch Pro Controller":"Generic Controller"}update(e){var o;if(!this.enabled||this.activeGamepadIndex===null)return;const i=navigator.getGamepads()[this.activeGamepadIndex];if(!i)return;this.debugMode&&this.updateDebugDisplay(i);const s=window;if(s.game&&s.game.introSequenceActive||this.spaceship.isDocked){this.resetControls();return}this.previousButtonStates={...this.buttonStates},i.buttons.forEach((r,a)=>{this.buttonStates[a]=r.pressed}),this.handleMovement(i),this.handleCameraLook(i,e),this.handleButtons(i),this.handleTriggers(i),this.vibrationEnabled&&((o=this.controls.miningSystem)!=null&&o.isMining)&&this.vibrate(.2,100)}handleMovement(e){let t=this.applyDeadZone(e.axes[this.axisMap.LEFT_STICK_X]),i=this.applyDeadZone(e.axes[this.axisMap.LEFT_STICK_Y]);t=this.applyResponseCurve(t,2.5),i=this.applyResponseCurve(i,2.5),this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.right=!1,i<-.1?(this.spaceship.thrust.forward=!0,this.spaceship.thrustPower=Math.abs(i)):i>.1&&(this.spaceship.thrust.backward=!0,this.spaceship.thrustPower=Math.abs(i)),t<-.1?(this.spaceship.thrust.right=!0,this.spaceship.strafePower=Math.abs(t)):t>.1&&(this.spaceship.thrust.left=!0,this.spaceship.strafePower=Math.abs(t)),e.buttons[this.buttonMap.L3].pressed?this.spaceship.thrust.boost=!0:this.spaceship.thrust.boost=!1}handleCameraLook(e,t){let i=this.applyDeadZone(e.axes[3]||0),s=this.applyDeadZone(e.axes[4]||0);i=this.applyResponseCurve(i,2.5),s=this.applyResponseCurve(s,2.5);const o=.0015;this.rotationSmoothing.targetX=i*o*this.lookSensitivity*60,this.rotationSmoothing.targetY=s*o*this.lookSensitivity*60;const r=this.rotationSmoothing.smoothingFactor;this.rotationSmoothing.currentX+=(this.rotationSmoothing.targetX-this.rotationSmoothing.currentX)*r,this.rotationSmoothing.currentY+=(this.rotationSmoothing.targetY-this.rotationSmoothing.currentY)*r,Math.abs(this.rotationSmoothing.currentX)>1e-4||Math.abs(this.rotationSmoothing.currentY)>1e-4?this.physics.updateRotation(this.rotationSmoothing.currentX,this.rotationSmoothing.currentY):(this.rotationSmoothing.currentX=0,this.rotationSmoothing.currentY=0)}handleButtons(e){var t,i,s,o,r,a,l,d;if(this.wasButtonPressed(this.buttonMap.A)&&this.controls&&this.controls.targetingSystem&&this.controls.targetingSystem.toggleLockOn(),this.wasButtonPressed(this.buttonMap.B)&&this.controls&&this.controls.miningSystem&&this.controls.targetingSystem)if(this.controls.miningSystem.isMining)this.controls.miningSystem.stopMining();else{const h=(i=(t=this.controls.targetingSystem).getCurrentTarget)==null?void 0:i.call(t);h&&(this.controls.miningSystem.setTargetAsteroid(h),this.controls.miningSystem.startMining())}if(this.wasButtonPressed(this.buttonMap.X)&&this.controls&&this.controls.dockingSystem&&this.controls.dockingSystem.canDock&&this.controls.dockingSystem.canDock()&&((o=(s=this.controls.dockingSystem).initiateDocking)==null||o.call(s)),this.wasButtonPressed(this.buttonMap.Y)){const h=window;h.game&&h.game.deployTurret&&h.game.deployTurret()}if(this.wasButtonPressed(this.buttonMap.LB)&&this.controls&&this.controls.targetingSystem&&((a=(r=this.controls.targetingSystem).cycleLockOnTarget)==null||a.call(r,-1)),this.wasButtonPressed(this.buttonMap.RB)&&this.controls&&this.controls.targetingSystem){const h=(d=(l=this.controls.targetingSystem).cycleLockOnTarget)==null?void 0:d.call(l,1);h&&this.controls.miningSystem&&this.controls.miningSystem.setTargetAsteroid(h)}if(this.wasButtonPressed(this.buttonMap.DPAD_UP)){const h=window;h.game&&h.game.deployTurret&&h.game.deployTurret()}if(this.wasButtonPressed(this.buttonMap.DPAD_DOWN)){const h=window;h.game&&h.game.deployShieldDrone&&h.game.deployShieldDrone()}if(this.wasButtonPressed(this.buttonMap.START)){const h=window;h.game&&h.game.togglePause&&h.game.togglePause()}}handleTriggers(e){let t=0,i=0;e.buttons[7]&&(t=e.buttons[7].value),e.buttons[6]&&(i=e.buttons[6].value);const s=e.axes[4]||0,o=e.axes[5]||0;if(t<.01&&Math.abs(o)>.01&&(t=(o+1)/2),i<.01&&Math.abs(s)>.01&&(i=(s+1)/2),t=this.applyResponseCurve(t*2-1,2.5)*.5+.5,i=this.applyResponseCurve(i*2-1,2.5)*.5+.5,t>this.triggerDeadZone){if(!this.wasFiring){const r=window;r.game&&r.game.combat&&(r.game.combat.setFiring(!0),this.wasFiring=!0)}}else if(this.wasFiring){const r=window;r.game&&r.game.combat&&(r.game.combat.setFiring(!1),this.wasFiring=!1)}}applyDeadZone(e){return Math.abs(e)<this.deadZone?0:(e>0?1:-1)*((Math.abs(e)-this.deadZone)/(1-this.deadZone))}wasButtonPressed(e){return this.buttonStates[e]&&!this.previousButtonStates[e]}wasButtonReleased(e){return!this.buttonStates[e]&&this.previousButtonStates[e]}vibrate(e=.5,t=100){if(!this.vibrationEnabled||this.activeGamepadIndex===null)return;const o=navigator.getGamepads()[this.activeGamepadIndex];o&&o.vibrationActuator&&o.vibrationActuator.playEffect("dual-rumble",{startDelay:0,duration:t,weakMagnitude:e*.5,strongMagnitude:e})}resetControls(){this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.boost=!1,this.spaceship.thrustPower=1,this.spaceship.strafePower=1}showNotification(e){const t=document.createElement("div");t.style.position="fixed",t.style.bottom="100px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="#30cfd0",t.style.padding="10px 20px",t.style.borderRadius="5px",t.style.border="1px solid #30cfd0",t.style.fontFamily="monospace",t.style.fontSize="14px",t.style.zIndex="10000",t.textContent=" "+e,document.body.appendChild(t),setTimeout(()=>{t.style.transition="opacity 0.5s",t.style.opacity="0",setTimeout(()=>t.remove(),500)},3e3)}setLookSensitivity(e){this.lookSensitivity=Math.max(.1,Math.min(5,e))}setMovementSensitivity(e){this.movementSensitivity=Math.max(.1,Math.min(2,e))}setDeadZone(e){this.deadZone=Math.max(.05,Math.min(.3,e))}setVibration(e){this.vibrationEnabled=e}isConnected(){return this.activeGamepadIndex!==null}applyResponseCurve(e,t=2.5){const i=Math.sign(e),s=Math.abs(e);return i*Math.pow(s,t)}toggleDebug(){this.debugMode=!this.debugMode,this.debugMode?this.createDebugDisplay():this.removeDebugDisplay()}createDebugDisplay(){this.debugDisplay||(this.debugDisplay=document.createElement("div"),this.debugDisplay.id="gamepad-debug",this.debugDisplay.style.position="fixed",this.debugDisplay.style.top="10px",this.debugDisplay.style.right="10px",this.debugDisplay.style.backgroundColor="rgba(0, 0, 0, 0.8)",this.debugDisplay.style.color="#0f0",this.debugDisplay.style.padding="10px",this.debugDisplay.style.fontFamily="monospace",this.debugDisplay.style.fontSize="12px",this.debugDisplay.style.borderRadius="5px",this.debugDisplay.style.border="1px solid #0f0",this.debugDisplay.style.zIndex="10001",this.debugDisplay.style.maxWidth="300px",this.debugDisplay.style.pointerEvents="none",document.body.appendChild(this.debugDisplay))}removeDebugDisplay(){this.debugDisplay&&(this.debugDisplay.remove(),this.debugDisplay=null)}updateDebugDisplay(e){var a,l,d,h;this.debugDisplay||this.createDebugDisplay();let t="<strong> Gamepad Debug</strong><br>";t+=`Controller: ${e.id}<br>`,t+=`Mapping: ${e.mapping||"non-standard"}<br>`,t+=`<br><strong>All Axes (${e.axes.length}):</strong><br>`;for(let u=0;u<e.axes.length;u++){const f=e.axes[u].toFixed(2),p=u===this.rightStickXAxis,v=u===this.rightStickYAxis;t+=`[${u}]: ${f}${p?" (R-X)":v?" (R-Y)":""} `,u%2===1&&(t+="<br>")}t+="<br><strong>Detected Mapping:</strong><br>",t+="Left Stick: axes[0,1]<br>",t+=`Right Stick: axes[${this.rightStickXAxis},${this.rightStickYAxis}]<br>`;const i=((a=e.axes[this.rightStickXAxis])==null?void 0:a.toFixed(2))||"0",s=((l=e.axes[this.rightStickYAxis])==null?void 0:l.toFixed(2))||"0";t+=`Right Values: X=${i} Y=${s}<br>`;const o=((d=e.buttons[7])==null?void 0:d.value.toFixed(2))||"0",r=((h=e.buttons[6])==null?void 0:h.value.toFixed(2))||"0";t+="<br><strong>Triggers:</strong><br>",t+=`LT: ${r} | RT: ${o}<br>`,t+="<br><strong>Active:</strong><br>",this.spaceship.thrust.forward&&(t+=" Forward "),this.spaceship.thrust.backward&&(t+=" Backward "),this.spaceship.thrust.left&&(t+=" Right "),this.spaceship.thrust.right&&(t+=" Left "),this.spaceship.thrust.boost&&(t+=" Boost "),t+="<br><small>Press F8 to swap X/Y axes</small>",this.debugDisplay&&(this.debugDisplay.innerHTML=t)}swapRightStickAxes(){const e=this.rightStickXAxis;this.rightStickXAxis=this.rightStickYAxis,this.rightStickYAxis=e,console.log(`Swapped right stick axes: X is now axis ${this.rightStickXAxis}, Y is now axis ${this.rightStickYAxis}`),this.axisDetectionMode=!1}}function ne(c=65535,e=8,t=.3){const i=new k,s=Be(Ue.mul(e)).mul(t).add(1);try{i.colorNode=Oe(c).mul(s)}catch(o){i.color.setHex(c),console.warn("TSL colorNode not supported or failed, falling back to standard material color.",o)}return i.transparent=!0,i.opacity=.8,i.blending=G,i.depthWrite=!1,i.side=O,i}class ut{constructor(e,t){n(this,"scene");n(this,"spaceship");n(this,"laserMesh");n(this,"currentMaterial");this.scene=e,this.spaceship=t,this.laserMesh=null,this.currentMaterial=null}getThreeScene(){const e=window;return e.game&&e.game.renderer&&e.game.renderer.scene?e.game.renderer.scene:this.scene&&this.scene.isScene?this.scene:null}getLaserColor(e){if(!e)return 16724016;const t=e.toLowerCase();return t==="gold"?16763904:t==="platinum"?6750207:16724016}updateLaserBeam(e){if(!this.laserMesh||!e||!this.spaceship.mesh)return;const t=this.spaceship.mesh.position.clone(),i=new g(0,0,-60);i.applyQuaternion(this.spaceship.mesh.quaternion),t.add(i);const s=e.mesh.position.clone(),r=new g().subVectors(s,t).length();if(r<.01){this.laserMesh.visible=!1;return}const a=new g().addVectors(t,s).multiplyScalar(.5);this.laserMesh.position.copy(a),this.laserMesh.rotation.set(0,0,0),this.laserMesh.lookAt(s),this.laserMesh.rotateX(Math.PI/2);const l=.15,d=this.spaceship.miningEfficiency||1,h=l*Math.sqrt(d);this.laserMesh.scale.set(h/l,r,h/l),e.resourceType&&this.currentMaterial,this.laserMesh.visible=!0}setupLaserBeam(e){const t=this.getThreeScene();if(!t){console.error("LaserControl: Could not access Three.js scene");return}const i=document.getElementById("laser-beam");if(i&&i.remove(),this.laserMesh){if(e&&e.resourceType){const s=this.getLaserColor(e.resourceType);this.currentMaterial&&this.currentMaterial.dispose(),this.currentMaterial=ne(s,8,.3),this.laserMesh.material=this.currentMaterial}this.laserMesh.visible=!0}else{console.log("LaserControl: Creating 3D laser beam mesh");const s=new U(.15,.15,1,8),o=e&&e.resourceType?this.getLaserColor(e.resourceType):16724016;this.currentMaterial=ne(o,8,.3),this.laserMesh=new w(s,this.currentMaterial),this.laserMesh.visible=!1,t.add(this.laserMesh)}}dispose(){const e=this.getThreeScene();this.laserMesh&&(e&&e.remove(this.laserMesh),this.laserMesh.geometry&&this.laserMesh.geometry.dispose(),this.currentMaterial&&this.currentMaterial.dispose(),this.laserMesh=null,this.currentMaterial=null);const t=document.getElementById("laser-beam");t&&t.remove()}hideLaserBeam(){this.laserMesh&&(this.laserMesh.visible=!1)}activateSpaceshipLaser(){this.spaceship&&typeof this.spaceship.activateMiningLaser=="function"&&this.spaceship.activateMiningLaser()}deactivateSpaceshipLaser(){this.spaceship&&typeof this.spaceship.deactivateMiningLaser=="function"&&this.spaceship.deactivateMiningLaser()}}class mt{constructor(e,t=6e3){n(this,"spaceship");n(this,"miningDistance");this.spaceship=e,this.miningDistance=t}validateAsteroid(e){try{return console.log("TargetValidation: validating asteroid",e),!e||!e.mesh||!e.mesh.position?(console.error("TargetValidation: Invalid asteroid provided"),!1):!0}catch(t){return console.error("TargetValidation: Error validating asteroid:",t),!1}}isInRange(e){return!e||!e.mesh||!this.spaceship||!this.spaceship.mesh?!1:this.spaceship.mesh.position.distanceTo(e.mesh.position)<=this.miningDistance}getDistanceToTarget(e){return!e||!e.mesh||!this.spaceship||!this.spaceship.mesh?1/0:this.spaceship.mesh.position.distanceTo(e.mesh.position)}validateSpaceship(){return!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position?(console.error("TargetValidation: Spaceship is missing mesh or position"),!1):!0}canStartMining(e){if(!this.validateAsteroid(e))return{valid:!1,reason:"Invalid asteroid"};if(!this.validateSpaceship())return{valid:!1,reason:"Invalid spaceship"};const t=this.getDistanceToTarget(e);return t>this.miningDistance?{valid:!1,reason:"Out of range",distance:t,maxRange:this.miningDistance}:{valid:!0}}}class gt{constructor(){n(this,"resources");this.resources={iron:0,gold:0,platinum:0,orbs:{common:0,uncommon:0,rare:0,epic:0,legendary:0}}}addAsteroidResources(e,t=1){if(!e)return!1;const i=e.resourceType||"iron",s=(t-1)*.5;let o=0;switch(i.toLowerCase()){case"iron":o=Math.floor(Math.random()*5)+10;break;case"gold":o=Math.floor(Math.random()*3)+5;break;case"platinum":o=Math.floor(Math.random()*2)+2;break;default:o=10}switch(t>1&&Math.random()<s&&(o=Math.ceil(o*1.2)),i.toLowerCase()){case"iron":this.resources.iron+=o;break;case"gold":this.resources.gold+=o;break;case"platinum":this.resources.platinum+=o;break;default:this.resources.iron+=o}return console.log(`ResourceExtraction: Added ${o} ${i} from asteroid`),this.showResourceGainNotification(o,i),!0}showResourceGainNotification(e,t){let i="#a0a0a0";t==="gold"?i="#ffcc00":t==="platinum"&&(i="#66ffff");const s=document.createElement("div");s.textContent=`+${e} ${t.toUpperCase()}`,s.style.position="absolute",s.style.top="40%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.color=i,s.style.fontSize="24px",s.style.fontWeight="bold",s.style.textShadow="0 0 8px black",s.style.zIndex="1000",s.style.opacity="1",s.style.transition="all 1.5s ease-out",document.body.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.top="30%",setTimeout(()=>{document.body.contains(s)&&document.body.removeChild(s)},1500)},100)}getResources(){return{...this.resources}}getResource(e){const t=e.toLowerCase(),i=this.resources[t];return typeof i=="number"?i:0}}class pt{constructor(){}updateTargetInfo(e,t,i){var s,o,r,a;if(!(!e||!e.mesh||!t||!t.mesh))try{const l=window,d=((o=(s=l.gameInstance)==null?void 0:s.controls)==null?void 0:o.targetingSystem)||((a=(r=l.game)==null?void 0:r.controls)==null?void 0:a.targetingSystem);if(!(d&&d.isLockOnEnabled()))return;const u=t.mesh.position.distanceTo(e.mesh.position),f=u<=i,p=document.getElementById("target-distance");if(p){const A=f?" [IN RANGE]":" [OUT OF RANGE]",x=f?"#00ff00":"#ff4400";p.innerHTML=`Distance: ${Math.round(u)} units<span style="color: ${x}">${A}</span>`}const v=document.getElementById("target-info");v&&(v.style.color=f?"#30cfd0":"#ff4400",v.style.display="block");const C=document.getElementById("target-name");if(C&&e.resourceType){const A=e.resourceType.toUpperCase();f?(C.textContent=`${A} Asteroid`,C.style.color="#30cfd0"):(C.textContent=`${A} Asteroid - OUT OF RANGE`,C.style.color="#ff4400")}}catch(l){console.error("UIUpdates: Error updating target info:",l)}}updateMiningStatusWithTime(e,t,i=1){const s=document.getElementById("mining-status");if(!s||!e||!e.resourceType)return;const o=e.resourceType.toLowerCase(),r=Math.round(1/t);let a="";i>1&&(a=` [${Math.round(i*100)}% efficiency]`),s.textContent=`MINING ${o.toUpperCase()} (${r}s)${a}`,s.style.color="#ff4400"}resetMiningStatus(){const e=document.getElementById("mining-status");e&&(e.textContent="INACTIVE",e.style.color="#30cfd0")}setupMiningProgressBar(){let e=document.getElementById("mining-progress-container");if(e){e.style.display="block";const t=document.getElementById("mining-progress-bar");t&&(t.style.width="0%")}else{console.log("UIUpdates: Creating mining progress container"),e=document.createElement("div"),e.id="mining-progress-container",e.style.position="absolute",e.style.bottom="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.width="200px",e.style.height="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.5)",e.style.border="1px solid #30cfd0",e.style.zIndex="1000",document.body.appendChild(e);const t=document.createElement("div");t.id="mining-progress-bar",t.style.width="0%",t.style.height="100%",t.style.backgroundColor="#30cfd0",e.appendChild(t)}}updateMiningProgress(e){const t=document.getElementById("mining-progress-bar");t&&(t.style.width=`${e*100}%`)}hideMiningProgressBar(){const e=document.getElementById("mining-progress-container");e&&(e.style.display="none")}showOutOfRangeMessage(){var o,r,a,l;const e=window,t=((r=(o=e.gameInstance)==null?void 0:o.controls)==null?void 0:r.targetingSystem)||((l=(a=e.game)==null?void 0:a.controls)==null?void 0:l.targetingSystem),i=t&&t.isLockOnEnabled(),s=document.getElementById("target-info");s&&i&&(s.textContent="TARGET OUT OF RANGE",s.style.color="#ff4400",s.style.display="block",setTimeout(()=>{(!t||!t.isLockOnEnabled())&&(s.style.display="none")},2e3))}}class ft{constructor(e){n(this,"scene");n(this,"miningParticles");this.scene=e,this.miningParticles=null,this.setupMiningParticles()}setupMiningParticles(){const t=new j,i=new Q({color:16733440,size:1.5,blending:G,transparent:!0,opacity:.8}),s=new Float32Array(100*3);for(let o=0;o<100;o++)s[o*3]=0,s[o*3+1]=0,s[o*3+2]=0;t.setAttribute("position",new K(s,3)),this.miningParticles=new ee(t,i),this.miningParticles.visible=!1,this.scene.add(this.miningParticles)}showMiningParticles(e,t=1){if(this.miningParticles&&(this.miningParticles.visible=!0,e.resourceType&&this.miningParticles.material)){const i=e.resourceType.toLowerCase();i==="iron"?this.miningParticles.material.color.set(16733440):i==="gold"?this.miningParticles.material.color.set(16763904):i==="platinum"&&this.miningParticles.material.color.set(6750207),t>1&&(this.miningParticles.material.size=1.5*Math.sqrt(t))}}hideMiningParticles(){this.miningParticles&&(this.miningParticles.visible=!1)}updateMiningParticles(e=1){if(!this.miningParticles||!this.miningParticles.visible)return;const t=this.miningParticles.geometry.attributes.position.array,i=.3*e;for(let s=0;s<t.length;s+=3){const o=new g(t[s],t[s+1],t[s+2]);o.normalize().multiplyScalar(i),t[s]+=o.x,t[s+1]+=o.y,t[s+2]+=o.z,Math.sqrt(t[s]*t[s]+t[s+1]*t[s+1]+t[s+2]*t[s+2])>36&&(t[s]=(Math.random()-.5)*24,t[s+1]=(Math.random()-.5)*24,t[s+2]=(Math.random()-.5)*24)}this.miningParticles.geometry.attributes.position.needsUpdate=!0}setParticlesPosition(e){this.miningParticles&&this.miningParticles.visible&&this.miningParticles.position.copy(e)}createAsteroidBreakEffect(e){const i=new j,s=new Q({color:11184810,size:12,blending:G,transparent:!0,opacity:.8}),o=new Float32Array(50*3),r=[];for(let h=0;h<50;h++)o[h*3]=e.x,o[h*3+1]=e.y,o[h*3+2]=e.z,r.push({x:(Math.random()-.5)*8,y:(Math.random()-.5)*8,z:(Math.random()-.5)*8});i.setAttribute("position",new K(o,3));const a=new ee(i,s);this.scene.add(a);let l=0;const d=()=>{l++;const h=a.geometry.attributes.position.array;for(let u=0;u<50;u++)h[u*3]+=r[u].x,h[u*3+1]+=r[u].y,h[u*3+2]+=r[u].z;a.geometry.attributes.position.needsUpdate=!0,a.material.opacity=Math.max(0,.8-l*.02),l<40?requestAnimationFrame(d):this.scene.remove(a)};d()}cleanup(){this.miningParticles&&(this.miningParticles.geometry&&this.miningParticles.geometry.dispose(),this.miningParticles.material&&this.miningParticles.material.dispose(),this.scene.remove(this.miningParticles),this.miningParticles=null)}}class yt{constructor(e,t){n(this,"spaceship");n(this,"scene");n(this,"isMining");n(this,"targetAsteroid");n(this,"miningProgress");n(this,"lastDestroyedAsteroid");n(this,"miningSpeedByType");n(this,"miningSpeed");n(this,"miningDistance");n(this,"miningCooldown");n(this,"laserControl");n(this,"targetValidation");n(this,"resourceExtraction");n(this,"uiUpdates");n(this,"visualEffects");this.spaceship=e,this.scene=t,this.isMining=!1,this.targetAsteroid=null,this.miningProgress=0,this.lastDestroyedAsteroid=null,this.miningSpeedByType={iron:.133,gold:.044,platinum:.022},this.miningSpeed=.133,this.miningDistance=6e3,this.miningCooldown=0,this.laserControl=new ut(t,e),this.targetValidation=new mt(e,this.miningDistance),this.resourceExtraction=new gt,this.uiUpdates=new pt,this.visualEffects=new ft(t)}getMiningEfficiency(){return this.spaceship&&this.spaceship.miningEfficiency?this.spaceship.miningEfficiency:1}get resources(){return this.resourceExtraction.getResources()}setTargetAsteroid(e){try{if(console.log("MiningSystem: setTargetAsteroid called",e),!this.targetValidation.validateAsteroid(e))return!1;if(this.targetAsteroid=e,e&&e.resourceType){const t=e.resourceType.toLowerCase(),i=this.miningSpeedByType[t]||this.miningSpeedByType.iron,s=this.getMiningEfficiency();this.miningSpeed=i*s,console.log(`Mining ${t} asteroid with speed: ${this.miningSpeed} (efficiency: ${s}x)`),this.uiUpdates.updateTargetInfo(e,this.spaceship,this.miningDistance)}else this.miningSpeed=this.miningSpeedByType.iron*this.getMiningEfficiency();return!0}catch(t){return console.error("MiningSystem: Error in setTargetAsteroid:",t),!1}}startMining(){try{if(console.log("MiningSystem: startMining called"),!this.targetAsteroid){console.error("MiningSystem: Cannot start mining - no target asteroid set");return}const e=this.targetValidation.canStartMining(this.targetAsteroid);if(!e.valid){e.reason==="Out of range"&&this.uiUpdates.showOutOfRangeMessage(),console.log(`MiningSystem: ${e.reason}`);return}this.isMining=!0,this.miningProgress=0,console.log("MiningSystem: Mining state activated"),this.laserControl.setupLaserBeam(this.targetAsteroid),this.visualEffects.showMiningParticles(this.targetAsteroid,this.getMiningEfficiency()),this.uiUpdates.setupMiningProgressBar(),this.laserControl.activateSpaceshipLaser(),this.updateMiningStatusWithTime();const t=window;t.game&&t.game.audio?t.game.audio.playSound("mining-laser"):t.game&&t.game.audio&&t.game.audio.playSound("laser"),console.log("MiningSystem: Mining successfully started")}catch(e){console.error("MiningSystem: Error in startMining:",e),this.isMining=!1}}updateMiningStatusWithTime(){this.uiUpdates.updateMiningStatusWithTime(this.targetAsteroid,this.miningSpeed,this.getMiningEfficiency())}stopMining(){if(!this.isMining)return;this.isMining=!1,this.miningProgress=0,this.laserControl.hideLaserBeam(),this.visualEffects.hideMiningParticles(),this.uiUpdates.hideMiningProgressBar(),this.laserControl.deactivateSpaceshipLaser(),this.uiUpdates.resetMiningStatus();const e=window;e.game&&e.game.audio&&e.game.audio.stopSound("mining-laser")}update(e=1/60){this.miningCooldown>0&&this.miningCooldown--,this.isMining&&this.updateMining(e),this.visualEffects.updateMiningParticles(this.getMiningEfficiency()),this.targetAsteroid&&!this.isMining&&this.uiUpdates.updateTargetInfo(this.targetAsteroid,this.spaceship,this.miningDistance)}updateMining(e=1/60){if(!this.targetAsteroid||!this.isMining){this.stopMining();return}if(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)>this.miningDistance){this.stopMining();return}this.miningProgress+=this.miningSpeed*e,this.laserControl.updateLaserBeam(this.targetAsteroid),this.visualEffects.setParticlesPosition(this.targetAsteroid.mesh.position),this.miningProgress>=1&&(this.resourceExtraction.addAsteroidResources(this.targetAsteroid,this.getMiningEfficiency()),this.visualEffects.createAsteroidBreakEffect(this.targetAsteroid.mesh.position),this.lastDestroyedAsteroid=this.targetAsteroid,this.scene.remove(this.targetAsteroid.mesh),this.stopMining(),this.targetAsteroid=null),this.uiUpdates.updateMiningProgress(this.miningProgress)}getLastDestroyedAsteroid(){const e=this.lastDestroyedAsteroid;return this.lastDestroyedAsteroid=null,e}}class wt{constructor(e,t,i){n(this,"spaceship");n(this,"scene");n(this,"environment");n(this,"lockOnEnabled");n(this,"nearbyAsteroids");n(this,"currentLockOnIndex");n(this,"targetAsteroid");n(this,"scanRadius");n(this,"targetReticle");n(this,"offScreenContainer",null);n(this,"offScreenIndicator",null);n(this,"targetDisplay",null);n(this,"targetInfoElement",null);n(this,"scanRadiusCounter");n(this,"rescanCounter");n(this,"lookAtCounter");n(this,"pulseTime");n(this,"uiUpdateCounter");this.spaceship=e,this.scene=t,this.environment=i,this.lockOnEnabled=!1,this.nearbyAsteroids=[],this.currentLockOnIndex=-1,this.targetAsteroid=null,this.scanRadius=this.getScanRadius(),this.targetDisplay=document.getElementById("target-display"),this.targetInfoElement=document.getElementById("target-info"),this.createTargetReticle(),this.createOffScreenIndicators()}createTargetReticle(){const e=new te(150,180,32),t=new k({color:16724016,side:O,transparent:!0,opacity:.7});this.targetReticle=new w(e,t),this.targetReticle.visible=!1,this.scene.add(this.targetReticle);const i=new te(75,90,32),s=new k({color:16736352,side:O,transparent:!0,opacity:.5}),o=new w(i,s);this.targetReticle.add(o)}getScanRadius(){return this.spaceship&&this.spaceship.scanRange?this.spaceship.scanRange*5:5e3}toggleLockOn(){if(this.lockOnEnabled=!this.lockOnEnabled,this.lockOnEnabled){this.scanRadius=this.getScanRadius(),this.scanForAsteroids();const e=document.getElementById("target-info");if(e){e.style.display="block",e.style.color="#30cfd0";const t=document.getElementById("target-name");t&&(t.textContent="Scanning for targets...")}this.nearbyAsteroids.length>0&&this.findNearestTarget()}else{this.nearbyAsteroids=[],this.currentLockOnIndex=-1,this.targetAsteroid=null,this.targetReticle.visible=!1,this.hideOffScreenIndicators();const e=document.getElementById("target-info");e&&(e.style.display="none")}return this.lockOnEnabled}scanForAsteroids(){this.nearbyAsteroids=[];const e=this.spaceship.mesh.position,t=new he,i=[],s=this.environment.asteroids;if(s.forEach(o=>{if(!o.minable||!o.mesh.visible)return;const r=e.distanceTo(o.mesh.position);if(r<=this.scanRadius){const a=new g().subVectors(o.mesh.position,e).normalize();t.set(e,a),t.far=r;const l=t.intersectObjects(s.filter(d=>d.mesh&&d.mesh.visible).map(d=>d.mesh));l.length>0&&l[0].object===o.mesh&&i.push({asteroid:o,distance:r})}}),i.sort((o,r)=>o.distance-r.distance),this.nearbyAsteroids=i.map(o=>o.asteroid),this.nearbyAsteroids.length>0){this.currentLockOnIndex=0,this.updateLockedOnTarget();const o=document.getElementById("target-name");return o&&(o.textContent=`Target 1/${this.nearbyAsteroids.length} (${Math.round(this.nearbyAsteroids[0].mesh.position.distanceTo(e))} units)`),!0}else{const o=document.getElementById("target-name");return o&&(o.textContent="No targets in range"),this.targetReticle.visible=!1,this.targetAsteroid=null,!1}}cycleLockOnTarget(e){return!this.lockOnEnabled||this.nearbyAsteroids.length===0?null:(this.currentLockOnIndex=(this.currentLockOnIndex+1)%this.nearbyAsteroids.length,this.updateLockedOnTarget())}updateLockedOnTarget(){if(this.targetAsteroid=this.nearbyAsteroids[this.currentLockOnIndex],this.targetAsteroid){console.log(`Target locked: ${this.targetAsteroid.resourceType} asteroid`),this.targetReticle.position.copy(this.targetAsteroid.mesh.position),this.targetReticle.visible=!0;const e=new g().copy(this.scene.camera.position);if(this.targetReticle.lookAt(e),this.targetReticle.scale.set(1,1,1),this.targetReticle.material.opacity=.8,this.targetReticle.children.length>0){const t=this.targetReticle.children[0];t.material&&"opacity"in t.material&&(t.material.opacity=.8)}}return this.targetAsteroid}getCurrentTarget(){try{return console.log("TargetingSystem: getCurrentTarget called"),this.targetAsteroid?!this.targetAsteroid.mesh||!this.targetAsteroid.mesh.position?(console.error("TargetingSystem: Current target is invalid, clearing target"),this.targetAsteroid=null,null):(console.log("TargetingSystem: Returning current target:",this.targetAsteroid),this.targetAsteroid):(console.log("TargetingSystem: No current target"),null)}catch(e){return console.error("TargetingSystem: Error in getCurrentTarget:",e),null}}isLockOnEnabled(){return this.lockOnEnabled===!0}findNearestTarget(){try{if(!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position)return null;let e=[];const t=window,i=t.gameInstance||t.game;if(i&&i.environment&&Array.isArray(i.environment.asteroids))e=i.environment.asteroids;else return null;if(e.length===0)return null;let s=null,o=1/0;for(const r of e){if(!r||!r.mesh||!r.mesh.position||!r.mesh.visible||!r.minable)continue;const a=this.spaceship.mesh.position.distanceTo(r.mesh.position);a<o&&(o=a,s=r)}return s?(console.log("TargetingSystem: Found nearest target:",s),this.setTarget(s),s):(console.log("TargetingSystem: No valid asteroid found after checking all asteroids"),null)}catch(e){return console.error("TargetingSystem: Error in findNearestTarget:",e),null}}update(){if(this.scanRadiusCounter||(this.scanRadiusCounter=0),this.scanRadiusCounter++,this.scanRadiusCounter>=30&&(this.scanRadiusCounter=0,this.scanRadius=this.getScanRadius()),this.lockOnEnabled&&(this.rescanCounter||(this.rescanCounter=0),this.rescanCounter++,this.rescanCounter>=120&&(this.rescanCounter=0,this.scanForAsteroids(),this.nearbyAsteroids.length>0&&!this.targetAsteroid&&this.findNearestTarget())),this.lockOnEnabled&&this.targetAsteroid){this.targetReticle.position.copy(this.targetAsteroid.mesh.position),this.lookAtCounter||(this.lookAtCounter=0),this.lookAtCounter++,this.lookAtCounter>=10&&(this.lookAtCounter=0,this.targetReticle.lookAt(this.scene.camera.position)),this.targetReticle.rotation.z+=.005,this.targetReticle.children.length>0&&(this.targetReticle.children[0].rotation.z-=.01),this.pulseTime||(this.pulseTime=0),this.pulseTime+=.02;const t=.7+.2*Math.sin(this.pulseTime);if(this.targetReticle.material.opacity=t,this.uiUpdateCounter||(this.uiUpdateCounter=0),this.uiUpdateCounter++,this.uiUpdateCounter>=30){this.uiUpdateCounter=0;const i=document.getElementById("target-distance");if(i){const s=Math.round(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position));i.textContent=`Distance: ${s} units`}(!this.targetAsteroid.mesh.parent||this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)>this.scanRadius)&&this.scanForAsteroids()}if(this.targetReticle.visible=!0,this.uiUpdateCounter===15)if(this.isTargetOnScreen())this.hideOffScreenIndicators();else{const s=this.getTargetDirection();this.showOffScreenIndicator(s)}}}setTarget(e){try{if(console.log("TargetingSystem: setTarget called",e),!e){console.error("TargetingSystem: Cannot set null target");return}if(!e.mesh||!e.mesh.position){console.error("TargetingSystem: Target is missing mesh or position properties",e);return}if(this.targetAsteroid=e,this.targetDisplay&&(this.targetDisplay.style.display="block"),this.targetInfoElement){const t=this.calculateDistanceToTarget();let i=e.resourceType||"Unknown";i=i.charAt(0).toUpperCase()+i.slice(1),this.targetInfoElement.textContent=`${i} Asteroid - ${t.toFixed(0)}m`,this.targetInfoElement.style.color="#30cfd0",this.targetInfoElement.style.display="block"}return console.log("TargetingSystem: Target successfully set",this.targetAsteroid),this.lockOnEnabled=!0,!0}catch(t){return console.error("TargetingSystem: Error in setTarget:",t),!1}}calculateDistanceToTarget(){try{return!this.targetAsteroid||!this.targetAsteroid.mesh||!this.targetAsteroid.mesh.position?(console.error("TargetingSystem: Cannot calculate distance - invalid target asteroid"),1/0):!this.spaceship||!this.spaceship.mesh||!this.spaceship.mesh.position?(console.error("TargetingSystem: Cannot calculate distance - invalid spaceship"),1/0):this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position)}catch(e){return console.error("TargetingSystem: Error calculating distance to target:",e),1/0}}createOffScreenIndicators(){this.offScreenContainer=document.createElement("div"),this.offScreenContainer.id="off-screen-indicators",this.offScreenContainer.style.position="absolute",this.offScreenContainer.style.top="0",this.offScreenContainer.style.left="0",this.offScreenContainer.style.width="100%",this.offScreenContainer.style.height="100%",this.offScreenContainer.style.pointerEvents="none",this.offScreenContainer.style.display="none",document.body.appendChild(this.offScreenContainer),this.offScreenIndicator=document.createElement("div"),this.offScreenIndicator.style.position="absolute",this.offScreenIndicator.style.width="30px",this.offScreenIndicator.style.height="30px",this.offScreenIndicator.innerHTML=`
            <svg width="30" height="30" viewBox="0 0 30 30">
                <polygon points="15,0 30,30 15,22 0,30" fill="#ff3030" />
            </svg>
        `,this.offScreenIndicator.style.transformOrigin="center center",this.offScreenIndicator.style.display="none",this.offScreenContainer.appendChild(this.offScreenIndicator)}hideOffScreenIndicators(){this.offScreenContainer&&(this.offScreenContainer.style.display="none"),this.offScreenIndicator&&(this.offScreenIndicator.style.display="none")}showOffScreenIndicator(e){if(!this.offScreenContainer||!this.offScreenIndicator)return;this.offScreenContainer.style.display="block",this.offScreenIndicator.style.display="block";const t=Math.atan2(e.y,e.x)*(180/Math.PI),i=50,s=window.innerWidth/2,o=window.innerHeight/2,r=new L(e.x,e.y).normalize();let a,l;const d=Math.abs(r.y/r.x),h=o/s;d>h?(l=r.y>0?o-i:-o+i,a=l/r.y*r.x):(a=r.x>0?s-i:-s+i,l=a/r.x*r.y),this.offScreenIndicator.style.left=s+a+"px",this.offScreenIndicator.style.top=o+l+"px",this.offScreenIndicator.style.transform=`rotate(${t}deg)`}isTargetOnScreen(){if(!this.targetAsteroid||!this.targetAsteroid.mesh)return!1;const e=this.getScreenPosition(this.targetAsteroid.mesh.position),t=.1;return e.x>=-1+t&&e.x<=1-t&&e.y>=-1+t&&e.y<=1-t}getScreenPosition(e){const t=new g().copy(e);return t.project(this.scene.camera),new L(t.x,t.y)}getTargetDirection(){if(!this.targetAsteroid)return new L(0,0);const e=this.getScreenPosition(this.targetAsteroid.mesh.position);return new L(e.x,e.y)}}class vt{constructor(){n(this,"nearStargate");this.nearStargate=!1}checkStargateProximity(e,t,i){var r,a,l,d,h,u,f,p;if(e.isDocked||!t||!e||!e.mesh)return;const s=t.getPosition();if(!s)return;e.mesh.position.distanceTo(s)<2e3?(this.nearStargate=!0,i&&i.stargateInterface&&((a=(r=i.stargateInterface).showDockingPrompt)==null||a.call(r)),i&&i.controls&&i.controls.isMobile&&i.controls.touchControls&&((d=(l=i.controls.touchControls).showDockButton)==null||d.call(l))):(this.nearStargate=!1,i&&i.stargateInterface&&((u=(h=i.stargateInterface).hideDockingPrompt)==null||u.call(h)),i&&i.controls&&i.controls.isMobile&&i.controls.touchControls&&((p=(f=i.controls.touchControls).hideDockButton)==null||p.call(f)))}isNearStargate(){return this.nearStargate}}class bt{constructor(){n(this,"isDocked");n(this,"dockingAvailable");n(this,"autoPointerLockOnUndock");n(this,"preUndockShieldValue");this.isDocked=!1,this.dockingAvailable=!1,this.autoPointerLockOnUndock=!0,this.preUndockShieldValue=0}isMobileDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||window.innerWidth<900}dockWithStargate(e,t,i){var s,o,r;console.log("Docking with stargate"),e.isDocked?console.log("Ship is already docked, just showing UI"):(e.dock(),this.isDocked=!0,e.world&&e.world.messageBus&&(e.world.messageBus.publish("player.docked",{playerPosition:e.mesh.position.clone(),stargate:t}),console.log("Published player.docked event"))),this.isMobileDevice()&&(console.log("Mobile device detected - preparing for stargate UI"),document.body.classList.remove("undocking","modal-open"),document.body.style.position="static",document.body.style.touchAction="auto",document.body.style.pointerEvents="auto",document.body.style.overflow="auto"),i&&i.stargateInterface&&(console.log("Showing stargate UI..."),(o=(s=i.stargateInterface).showStargateUI)==null||o.call(s),this.isMobileDevice()&&setTimeout(()=>{const a=document.getElementById("stargate-ui");a&&a.style.display!=="block"&&(console.log("Forcing stargate UI display"),a.style.display="block")},100)),i&&((r=i.hideUI)==null||r.call(i)),document.pointerLockElement&&(document.exitPointerLock(),console.log("Exited pointer lock for UI interaction"))}async performStep(e,t){return new Promise(i=>{requestAnimationFrame(()=>{try{e(),console.log(`Completed step: ${t}`)}catch(s){console.error(`Error during step ${t}:`,s)}i()})})}async yieldToBrowser(){return new Promise(e=>requestAnimationFrame(()=>e()))}resetMobileStyles(){this.isMobileDevice()&&document.body.classList.remove("undocking","modal-open"),requestAnimationFrame(()=>{document.body.style.cssText="",document.body.style.overflow="auto",document.body.style.position="static",document.body.style.height="auto",document.body.style.width="auto",document.body.style.touchAction="auto",document.body.style.pointerEvents="auto",document.body.style.setProperty("-webkit-overflow-scrolling","touch"),document.body.classList.remove("modal-open","undocking"),document.querySelectorAll(".modal-content, #stargate-ui, #star-map").forEach(e=>{const t=e;t&&t.style&&(t.style.cssText="overflow: auto; -webkit-overflow-scrolling: touch;",t.scrollTop=0)})})}requestPointerLock(){const e=document.querySelector("canvas");e&&!document.pointerLockElement&&setTimeout(()=>{e.requestPointerLock(),console.log("Requested pointer lock for ship control")},200)}async undockFromStargate(e,t,i,s,o){var a;if(!e.isDocked){console.log("Not docked, can't undock");return}this.isMobileDevice()&&(document.body.classList.remove("undocking"),this.resetMobileStyles());const r=document.createElement("div");r.className="undocking-indicator",r.textContent="Undocking...",document.body.appendChild(r);try{console.log("Starting undock sequence..."),this.preUndockShieldValue=e.shield,console.log(`Storing pre-undock shield value: ${this.preUndockShieldValue}`),await this.performStep(()=>i(),"Closing modals"),await this.yieldToBrowser(),this.isMobileDevice()&&(await this.performStep(()=>this.resetMobileStyles(),"Resetting mobile styles"),await this.yieldToBrowser()),await this.performStep(()=>s(),"Hiding stargate UI"),await this.yieldToBrowser(),await this.performStep(()=>o(),"Showing game UI"),await this.yieldToBrowser(),console.log("Performing core undock..."),e.undock(),console.log("Syncing health values..."),e.shield===0&&this.preUndockShieldValue>0&&(console.log(`Fixing shield reset: Restoring to ${this.preUndockShieldValue}`),e.shield=this.preUndockShieldValue),e.syncValuesToHealthComponent();const l={shield:e.shield,maxShield:e.maxShield,hull:e.hull,maxHull:e.maxHull},d=window,h=((a=d.game)==null?void 0:a.messageBus)||d.mainMessageBus;h&&(h.publish("player.undocked",l),console.log("Published player.undocked event with health values:",l)),this.dockingAvailable=!1,this.autoPointerLockOnUndock&&!this.isMobileDevice()&&await this.performStep(()=>this.requestPointerLock(),"Requesting pointer lock"),console.log("Undock sequence complete")}catch(l){console.error("Error during undocking:",l)}finally{document.body.contains(r)&&document.body.removeChild(r),this.isMobileDevice()?(document.body.classList.remove("undocking","modal-open"),this.resetMobileStyles(),document.body.style.pointerEvents="",document.body.style.touchAction="",document.body.style.overflowY="",document.body.style.position=""):document.body.classList.remove("undocking")}}}class St{constructor(){n(this,"resources");this.resources=null}setupDockingControls(e,t,i,s){document.addEventListener("keydown",o=>{o.key.toLowerCase()==="q"&&(e.isNearStargate()&&!i.isDocked?(console.log("Q key pressed: Docking with stargate"),t.dockWithStargate(i,s.stargate,s)):i.isDocked?console.log("Q key pressed while docked: No action (use Undock button)"):e.isNearStargate()||console.log("Q key pressed but not near stargate"))}),this.setupStargateUIControls(i,s)}setupStargateUIControls(e,t){const i=document.getElementById("refuel-btn");i&&i.addEventListener("click",()=>{e.credits>=100&&(e.credits-=e.refuel(),this.updateStargateUI(e,t))});const s=document.getElementById("repair-shield-btn");s&&s.addEventListener("click",()=>{e.credits>=150&&(e.credits-=e.repairShield(),this.updateStargateUI(e,t))});const o=document.getElementById("repair-hull-btn");o&&o.addEventListener("click",()=>{e.credits>=200&&(e.credits-=e.repairHull(),this.updateStargateUI(e,t))}),this.setupUndockButton(),this.setupSellingButtons(e,t),this.setupUpgradeButtons(e,t)}setupUndockButton(){const e=document.getElementById("undock-btn");e&&e.addEventListener("touchstart",t=>{console.log("Touch started on undock button"),t.stopPropagation()},{passive:!1})}setupSellingButtons(e,t){const i=document.getElementById("sell-iron");i&&i.addEventListener("click",()=>{this.resources&&this.resources.iron>0&&(e.credits+=this.resources.iron*10,this.resources.iron=0,this.updateStargateUI(e,t))});const s=document.getElementById("sell-gold");s&&s.addEventListener("click",()=>{this.resources&&this.resources.gold>0&&(e.credits+=this.resources.gold*50,this.resources.gold=0,this.updateStargateUI(e,t))});const o=document.getElementById("sell-platinum");o&&o.addEventListener("click",()=>{this.resources&&this.resources.platinum>0&&(e.credits+=this.resources.platinum*200,this.resources.platinum=0,this.updateStargateUI(e,t))})}setupUpgradeButtons(e,t){this.setupUpgradeButton("upgrade-fuel-tank",()=>e.fuelUpgradeCost,()=>e.upgradeFuelTank(),e,t),this.setupUpgradeButton("upgrade-engine",()=>e.engineUpgradeCost,()=>e.upgradeEngine(),e,t),this.setupUpgradeButton("upgrade-mining",()=>e.miningUpgradeCost,()=>e.upgradeMiningLaser(),e,t),this.setupUpgradeButton("upgrade-hull",()=>e.hullUpgradeCost,()=>e.upgradeHull(),e,t),this.setupUpgradeButton("upgrade-scanner",()=>e.scannerUpgradeCost,()=>e.upgradeScanner(),e,t)}setupUpgradeButton(e,t,i,s,o){const r=document.getElementById(e);r&&r.addEventListener("click",()=>{const a=t();s.credits>=a&&(s.credits-=a,i(),e==="upgrade-mining"&&this.updateMiningSystem&&this.updateMiningSystem(s,o),this.updateStargateUI(s,o))})}updateMiningSystem(e,t){if(t&&t.controls&&t.controls.miningSystem){const i=t.controls.miningSystem;Object.keys(i.miningSpeedByType).forEach(s=>{const o=i.miningSpeedByType[s];i.miningSpeedByType[s]=o*e.miningEfficiency}),console.log("Mining system updated with new efficiency:",e.miningEfficiency)}}updateStargateUI(e,t){var i,s;t&&t.stargateInterface&&((s=(i=t.stargateInterface).updateStargateUI)==null||s.call(i,e,this.resources))}hideStargateUI(e){var t,i;e&&e.stargateInterface&&(document.body.classList.add("undocking"),(i=(t=e.stargateInterface).hideStargateUI)==null||i.call(t),console.log("Hiding stargate interface"))}showGameUI(e){var t;e&&(document.body.classList.remove("undocking"),(t=e.showUI)==null||t.call(e),console.log("Showing game UI"))}closeAllModals(){try{const e=document.getElementById("custom-system-creator");if(e&&window.getComputedStyle(e).display!=="none"){console.log("Closing custom system creator before undocking");const s=e.querySelector("#close-system-creator");s?s.click():e.style.display="none";const o=window;o.game&&o.game.ui&&(o.game.ui.starMap&&typeof o.game.ui.starMap.hide=="function"&&o.game.ui.starMap.hide(),o.game.ui.customSystemCreator&&typeof o.game.ui.customSystemCreator.hide=="function"&&o.game.ui.customSystemCreator.hide(),document.body.classList.remove("modal-open"))}const t=document.getElementById("star-map");if(t&&window.getComputedStyle(t).display!=="none"){console.log("Closing star map before undocking");const s=t.querySelector("#close-star-map");s?s.click():t.style.display="none"}document.querySelectorAll(".modal-container").forEach(s=>{const o=s;window.getComputedStyle(o).display!=="none"&&(console.log("Closing modal before undocking:",o.id||"unnamed modal"),o.style.display="none")})}catch(e){console.warn("Error while closing modals:",e)}}setResources(e){this.resources=e}}class Mt{constructor(e,t,i){n(this,"spaceship");n(this,"stargate");n(this,"ui");n(this,"proximityDetector");n(this,"dockingLogic");n(this,"uiIntegration");n(this,"isDocked");n(this,"nearStargate");n(this,"resources");this.spaceship=e,this.stargate=t,this.ui=i,this.proximityDetector=new vt,this.dockingLogic=new bt,this.uiIntegration=new St,this.isDocked=this.spaceship.isDocked,this.spaceship&&this.spaceship.undockLocation&&this.stargate&&this.spaceship.undockLocation.set(0,1e4,0),console.log("Initializing docking system, ship is "+(this.isDocked?"docked":"undocked")),this.setupDockingControls(),this.isDocked&&this.spaceship.world&&this.spaceship.world.messageBus&&(this.spaceship.world.messageBus.publish("player.docked",{playerPosition:this.spaceship.mesh?this.spaceship.mesh.position.clone():null,stargate:this.stargate}),console.log("Published initial player.docked event"))}setupDockingControls(){this.uiIntegration.setupDockingControls(this.proximityDetector,this.dockingLogic,this.spaceship,this.ui),this.setupUndockButton()}setupStargateUIControls(){this.uiIntegration.setupStargateUIControls(this.spaceship,this.ui)}setupUndockButton(){const e=document.getElementById("undock-btn");if(e){const t=i=>{i.preventDefault(),i.stopPropagation(),console.log(`Undock button ${i.type} event triggered`),this.dockingLogic.isMobileDevice()?(document.body.classList.remove("undocking","modal-open"),setTimeout(()=>{this.undockFromStargate()},50)):this.undockFromStargate()};e.addEventListener("click",t),e.addEventListener("touchend",t)}}dockWithStargate(){this.dockingLogic.dockWithStargate(this.spaceship,this.stargate,this.ui),this.isDocked=!0,this.updateStargateUI()}async undockFromStargate(){await this.dockingLogic.undockFromStargate(this.spaceship,this.ui,()=>this.uiIntegration.closeAllModals(),()=>this.uiIntegration.hideStargateUI(this.ui),()=>this.uiIntegration.showGameUI(this.ui)),this.isDocked=!1}updateStargateUI(){this.uiIntegration.updateStargateUI(this.spaceship,this.ui)}checkStargateProximity(){this.proximityDetector.checkStargateProximity(this.spaceship,this.stargate,this.ui),this.nearStargate=this.proximityDetector.isNearStargate()}update(){this.checkStargateProximity()}setResources(e){this.resources=e,this.uiIntegration.setResources(e)}}class kt{constructor(){n(this,"leftJoystickZone");n(this,"rightJoystickZone");this.leftJoystickZone=null,this.rightJoystickZone=null}createJoystickZones(){return this.createLeftJoystickZone(),this.createRightJoystickZone(),{leftZone:this.leftJoystickZone,rightZone:this.rightJoystickZone}}createLeftJoystickZone(){const e=document.createElement("div");return e.id="leftJoystickZone",e.style.position="absolute",e.style.bottom="50px",e.style.left="50px",e.style.width="100px",e.style.height="100px",e.style.zIndex="1000",e.addEventListener("touchstart",t=>t.preventDefault(),{passive:!1}),e.addEventListener("touchmove",t=>t.preventDefault(),{passive:!1}),e.addEventListener("touchend",t=>t.preventDefault(),{passive:!1}),document.body.appendChild(e),this.leftJoystickZone=e,e}createRightJoystickZone(){const e=document.createElement("div");return e.id="rightJoystickZone",e.style.position="absolute",e.style.bottom="50px",e.style.right="50px",e.style.width="100px",e.style.height="100px",e.style.zIndex="1000",e.addEventListener("touchstart",t=>t.preventDefault(),{passive:!1}),e.addEventListener("touchmove",t=>t.preventDefault(),{passive:!1}),e.addEventListener("touchend",t=>t.preventDefault(),{passive:!1}),document.body.appendChild(e),this.rightJoystickZone=e,e}hideZones(){this.leftJoystickZone&&(this.leftJoystickZone.style.display="none"),this.rightJoystickZone&&(this.rightJoystickZone.style.display="none")}showZones(){this.leftJoystickZone&&(this.leftJoystickZone.style.display="block"),this.rightJoystickZone&&(this.rightJoystickZone.style.display="block")}getLeftZone(){return this.leftJoystickZone}getRightZone(){return this.rightJoystickZone}}class Ct{constructor(){n(this,"buttons");n(this,"containers");this.buttons={fire:null,mine:null,target:null,dock:null,deployLaser:null},this.containers={left:null,right:null}}createActionButtons(){return this.createButtonContainers(),this.createFireButton(),this.createMineButton(),this.createTargetButton(),this.createDockButton(),this.createDeployLaserButton(),this.buttons}createButtonContainers(){const e=document.createElement("div");e.id="mobile-action-buttons-left",e.style.position="absolute",e.style.bottom="170px",e.style.left="20px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="15px",e.style.zIndex="1000",document.body.appendChild(e),this.containers.left=e;const t=document.createElement("div");t.id="mobile-action-buttons-right",t.style.position="absolute",t.style.bottom="170px",t.style.right="20px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px",t.style.zIndex="1000",document.body.appendChild(t),this.containers.right=t}createFireButton(){return this.buttons.fire=this.createActionButton(this.containers.left,"FIRE","rgba(255, 80, 80, 0.8)"),this.buttons.fire}createMineButton(){return this.buttons.mine=this.createActionButton(this.containers.left,"MINE","rgba(120, 220, 232, 0.8)"),this.buttons.mine}createTargetButton(){return this.buttons.target=this.createActionButton(this.containers.right,"TARGET","rgba(255, 215, 0, 0.8)"),this.buttons.target}createDockButton(){return this.buttons.dock=this.createActionButton(null,"DOCK","rgba(51, 153, 255, 0.8)"),this.buttons.dock.style.position="absolute",this.buttons.dock.style.top="50%",this.buttons.dock.style.left="50%",this.buttons.dock.style.transform="translate(-50%, -50%)",this.buttons.dock.style.width="100px",this.buttons.dock.style.height="100px",this.buttons.dock.style.fontSize="20px",this.buttons.dock.style.boxShadow="0 0 25px rgba(51, 153, 255, 0.8)",this.buttons.dock.style.zIndex="10000",this.buttons.dock.style.display="none",document.body.appendChild(this.buttons.dock),this.buttons.dock}createDeployLaserButton(){return this.buttons.deployLaser=this.createActionButton(this.containers.right,"DEPLOY","rgba(255, 100, 100, 0.8)"),this.buttons.deployLaser}createActionButton(e,t,i){const s=document.createElement("div");return s.className="mobile-action-button",s.textContent=t,s.style.width="60px",s.style.height="60px",s.style.borderRadius="50%",s.style.backgroundColor="rgba(10, 20, 30, 0.7)",s.style.border=`2px solid ${i}`,s.style.color=i,s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.fontFamily='"Rajdhani", sans-serif',s.style.fontSize="16px",s.style.fontWeight="bold",s.style.boxShadow=`0 0 10px ${i}`,s.style.userSelect="none",s.style.touchAction="manipulation",s.style.cursor="pointer",s.style.transform="translateZ(0)",s.style.setProperty("-webkit-tap-highlight-color","transparent"),s.style.backfaceVisibility="hidden",e&&e.appendChild(s),s}showDockButton(){if(this.buttons.dock){if(this.buttons.dock.style.display="flex",this.buttons.dock.style.zIndex="10000",this.buttons.dock.style.position="absolute",this.buttons.dock.style.top="50%",this.buttons.dock.style.left="50%",console.log("Showing dock button - near stargate"),!this.buttons.dock.style.animation&&(this.buttons.dock.style.animation="pulse 1.5s infinite",!document.getElementById("mobile-pulse-animation"))){const e=document.createElement("style");e.id="mobile-pulse-animation",e.textContent=`
                        @keyframes pulse {
                            0% { transform: translate(-50%, -50%) scale(1); }
                            50% { transform: translate(-50%, -50%) scale(1.1); }
                            100% { transform: translate(-50%, -50%) scale(1); }
                        }
                    `,document.head.appendChild(e)}console.log("Dock button shown with styles:",{display:this.buttons.dock.style.display,zIndex:this.buttons.dock.style.zIndex,position:this.buttons.dock.style.position,width:this.buttons.dock.style.width,height:this.buttons.dock.style.height})}}hideDockButton(){this.buttons.dock&&(this.buttons.dock.style.display="none")}hideButtons(){this.containers.left&&(this.containers.left.style.display="none"),this.containers.right&&(this.containers.right.style.display="none"),this.hideDockButton()}showButtons(){this.containers.left&&(this.containers.left.style.display="flex"),this.containers.right&&(this.containers.right.style.display="flex")}addButtonEvents(e,t,i=null){if(!e){console.error("ActionButtons: Cannot add events to null button");return}i?(e.addEventListener("touchstart",s=>{s.preventDefault(),e.style.transform="scale(0.95) translateZ(0)",t()},{passive:!1}),e.addEventListener("touchend",s=>{s.preventDefault(),e.style.transform="scale(1) translateZ(0)",i()},{passive:!1}),e.addEventListener("pointerdown",s=>{s.preventDefault(),s.pointerType!=="touch"&&(e.style.transform="scale(0.95) translateZ(0)",t())}),e.addEventListener("pointerup",s=>{s.preventDefault(),s.pointerType!=="touch"&&(e.style.transform="scale(1) translateZ(0)",i())}),e.addEventListener("mousedown",()=>{e.style.transform="scale(0.95) translateZ(0)",t()}),e.addEventListener("mouseup",()=>{e.style.transform="scale(1) translateZ(0)",i()})):(e.addEventListener("touchstart",s=>{s.preventDefault(),e.style.transform="scale(0.95) translateZ(0)",e===this.buttons.dock&&console.log("Dock button touchstart event fired")},{passive:!1}),e.addEventListener("touchend",s=>{s.preventDefault(),e.style.transform="scale(1) translateZ(0)",e===this.buttons.dock&&console.log("Dock button touchend event fired, calling handler"),t()},{passive:!1}),e.addEventListener("pointerdown",s=>{s.preventDefault(),s.pointerType!=="touch"&&(e.style.transform="scale(0.95) translateZ(0)",e===this.buttons.dock&&console.log("Dock button pointerdown event fired"))}),e.addEventListener("pointerup",s=>{s.preventDefault(),s.pointerType!=="touch"&&(e.style.transform="scale(1) translateZ(0)",e===this.buttons.dock&&console.log("Dock button pointerup event fired, calling handler"),t())}),e.addEventListener("mousedown",()=>{e.style.transform="scale(0.95) translateZ(0)"}),e.addEventListener("mouseup",()=>{e.style.transform="scale(1) translateZ(0)",t()}))}}class Et{constructor(e,t){n(this,"spaceship");n(this,"physics");n(this,"leftJoystick");n(this,"rightJoystick");n(this,"threshold");n(this,"isNippleLoaded");this.spaceship=e,this.physics=t,this.leftJoystick=null,this.rightJoystick=null,this.threshold=.1,this.isNippleLoaded=!1}async loadNippleJS(){return new Promise((e,t)=>{if(window.nipplejs){this.isNippleLoaded=!0,e();return}const s=document.createElement("script");s.src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js",s.async=!0,s.onload=()=>{this.isNippleLoaded=!0,e()},s.onerror=()=>t(new Error("Failed to load nipple.js")),document.head.appendChild(s)})}initializeJoysticks(e,t){const i=window;return!i.nipplejs||!this.isNippleLoaded?(console.error("nipplejs is not loaded"),!1):(this.leftJoystick=i.nipplejs.create({zone:e,mode:"static",position:{left:"50%",top:"50%"},color:"rgba(120, 220, 232, 0.8)",size:100,threshold:this.threshold,dynamicPage:!0,fadeTime:100,lockX:!1,lockY:!1}),this.rightJoystick=i.nipplejs.create({zone:t,mode:"static",position:{left:"50%",top:"50%"},color:"rgba(120, 220, 232, 0.8)",size:100,threshold:this.threshold,dynamicPage:!0,fadeTime:100,lockX:!1,lockY:!1}),this.setupJoystickEvents(),!0)}setupJoystickEvents(){if(!this.leftJoystick||!this.rightJoystick){console.error("Joysticks not initialized");return}this.leftJoystick.on("move",(e,t)=>{this.handleThrustJoystick(t)}).on("end",()=>{this.resetThrust()}),this.rightJoystick.on("move",(e,t)=>{this.handleRotationJoystick(t)}).on("end",()=>{})}handleThrustJoystick(e){if(this.spaceship.isDocked)return;this.resetThrust();const t=e.force>2?2:e.force,i=e.angle.radian;i>1&&i<2?this.spaceship.thrust.forward=!0:i>4&&i<5.5&&(this.spaceship.thrust.backward=!0),i>2.5&&i<4?this.spaceship.thrust.left=!0:(i>=0&&i<1||i>5.5)&&(this.spaceship.thrust.right=!0),this.spaceship.thrust.boost=t>1.5}handleRotationJoystick(e){if(this.spaceship.isDocked)return;const t=e.vector.x*e.force*.015,i=-e.vector.y*e.force*.015;this.physics.updateRotation(t,i)}resetThrust(){this.spaceship&&(this.spaceship.thrust.forward=!1,this.spaceship.thrust.backward=!1,this.spaceship.thrust.left=!1,this.spaceship.thrust.right=!1,this.spaceship.thrust.boost=!1)}destroy(){this.leftJoystick&&(this.leftJoystick.destroy(),this.leftJoystick=null),this.rightJoystick&&(this.rightJoystick.destroy(),this.rightJoystick=null)}}class Pt{constructor(){n(this,"isEnabled");n(this,"gestureCallbacks");n(this,"touchStartTime");n(this,"touchStartPos");n(this,"touchEndPos");n(this,"swipeThreshold");n(this,"tapTimeout");this.isEnabled=!1,this.gestureCallbacks=new Map,this.touchStartTime=0,this.touchStartPos={x:0,y:0},this.touchEndPos={x:0,y:0},this.swipeThreshold=50,this.tapTimeout=300}enable(){this.isEnabled||(this.isEnabled=!0,document.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),document.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd.bind(this),{passive:!1}))}disable(){this.isEnabled&&(this.isEnabled=!1,document.removeEventListener("touchstart",this.handleTouchStart.bind(this)),document.removeEventListener("touchmove",this.handleTouchMove.bind(this)),document.removeEventListener("touchend",this.handleTouchEnd.bind(this)))}handleTouchStart(e){if(!this.isEnabled||this.isTouchOnUIElement(e.target))return;const t=e.touches[0];this.touchStartTime=Date.now(),this.touchStartPos={x:t.clientX,y:t.clientY}}handleTouchMove(e){this.isEnabled&&(this.isTouchOnUIElement(e.target)||e.preventDefault())}handleTouchEnd(e){if(!this.isEnabled||this.isTouchOnUIElement(e.target))return;const t=e.changedTouches[0];this.touchEndPos={x:t.clientX,y:t.clientY};const i=Date.now()-this.touchStartTime,s=this.calculateDistance(this.touchStartPos,this.touchEndPos);if(i<=this.tapTimeout&&s<this.swipeThreshold)this.triggerGesture("tap",{position:this.touchEndPos,duration:i});else if(s>=this.swipeThreshold){const o=this.getSwipeDirection(this.touchStartPos,this.touchEndPos);this.triggerGesture("swipe",{direction:o,distance:s,duration:i,startPos:this.touchStartPos,endPos:this.touchEndPos})}}isTouchOnUIElement(e){const t=["#leftJoystickZone","#rightJoystickZone","#mobile-action-buttons-left","#mobile-action-buttons-right",".mobile-action-button"];for(const i of t)if(e&&"closest"in e&&typeof e.closest=="function"&&e.closest(i))return!0;return!1}calculateDistance(e,t){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}getSwipeDirection(e,t){const i=t.x-e.x,s=t.y-e.y;return Math.abs(i)>Math.abs(s)?i>0?"right":"left":s>0?"down":"up"}triggerGesture(e,t){const i=this.gestureCallbacks.get(e);i&&typeof i=="function"&&i(t)}onGesture(e,t){this.gestureCallbacks.set(e,t)}offGesture(e){this.gestureCallbacks.delete(e)}clearGestures(){this.gestureCallbacks.clear()}}class Tt{constructor(e){n(this,"spaceship");n(this,"miningSystem");n(this,"targetingSystem");this.spaceship=e,this.miningSystem=null,this.targetingSystem=null}setMiningSystem(e){this.miningSystem=e}setTargetingSystem(e){this.targetingSystem=e}handleMiningStart(){var e,t,i,s,o,r,a;try{if(console.log("MiningHandler: handleMiningStart called"),!this.targetingSystem){console.error("MiningHandler: Targeting system not available");return}if(!this.miningSystem){console.error("MiningHandler: Mining system not available");return}let l=this.targetingSystem.getCurrentTarget();if(console.log("MiningHandler: Initial target:",l),!l&&(console.log("MiningHandler: No target selected, enabling targeting and finding nearest target"),this.targetingSystem.isLockOnEnabled()||this.targetingSystem.toggleLockOn(),l=this.targetingSystem.findNearestTarget(),console.log("MiningHandler: Found nearest target:",l),!l)){console.log("MiningHandler: No targets in range after scan");return}if(!l||!l.mesh||!l.mesh.position){console.error("MiningHandler: Target asteroid is missing required properties",l);const d=window,h=d.gameInstance||d.game;if(h&&h.environment&&h.environment.asteroids&&h.environment.asteroids.length>0){console.log("MiningHandler: Attempting to get asteroid directly from environment");let u=1/0,f=null;for(const p of h.environment.asteroids)if(p&&p.mesh&&p.mesh.position&&this.spaceship&&this.spaceship.mesh){const v=p.mesh.position.distanceTo(this.spaceship.mesh.position);v<u&&(u=v,f=p)}if(f)console.log("MiningHandler: Found closest asteroid from environment:",f),l=f;else{console.error("MiningHandler: Could not find any valid asteroids in environment");return}}else{console.error("MiningHandler: Could not access environment to find asteroids");return}}if(console.log("MiningHandler: Target asteroid found:",l),!l||!l.mesh||!l.mesh.position){console.error("MiningHandler: Target asteroid is still invalid after fallback attempts");return}this.miningSystem.setTargetAsteroid(l),console.log("MiningHandler: Target set for mining:",{resourceType:l.resourceType||"unknown",position:((i=(t=(e=l.mesh)==null?void 0:e.position)==null?void 0:t.toArray)==null?void 0:i.call(t))??"no mesh",distance:(o=(s=l.mesh)==null?void 0:s.position)!=null&&o.distanceTo&&((a=(r=this.spaceship)==null?void 0:r.mesh)!=null&&a.position)?l.mesh.position.distanceTo(this.spaceship.mesh.position):"unknown"}),console.log("MiningHandler: Starting mining operation"),this.miningSystem.startMining(),console.log("MiningHandler: Mining started:",this.miningSystem.isMining)}catch(l){console.error("MiningHandler: Error in handleMiningStart:",l)}}handleMiningEnd(){try{if(console.log("MiningHandler: handleMiningEnd called"),!this.miningSystem){console.error("MiningHandler: Mining system not available for stopping");return}this.miningSystem.stopMining(),console.log("MiningHandler: Mining stopped")}catch(e){console.error("MiningHandler: Error stopping mining:",e)}}}class xt{constructor(){n(this,"weaponSystem");this.weaponSystem=null}setWeaponSystem(e){this.weaponSystem=e}handleFiringStart(){try{if(this.weaponSystem){typeof this.weaponSystem.setFiring=="function"?this.weaponSystem.setFiring(!0):this.weaponSystem.isWeaponActive=!0;const i=window,s=i.gameInstance||i.game;s&&s.audio&&s.audio.playSound("laser");return}const e=window,t=e.gameInstance||e.game;if(!t){console.error("WeaponHandler: No game reference found");return}if(t.combat){t.combat.setFiring(!0),t.audio&&t.audio.playSound("laser");return}if(t.weaponSystem){typeof t.weaponSystem.setFiring=="function"?t.weaponSystem.setFiring(!0):t.weaponSystem.isWeaponActive=!0,t.audio&&t.audio.playSound("laser");return}if(t.controls&&t.controls.weaponSystem){typeof t.controls.weaponSystem.setFiring=="function"?t.controls.weaponSystem.setFiring(!0):t.controls.weaponSystem.isWeaponActive=!0,t.audio&&t.audio.playSound("laser");return}console.error("WeaponHandler: No weapon system or combat system found")}catch(e){console.error("WeaponHandler: Error in handleFiringStart:",e)}}handleFiringEnd(){try{if(this.weaponSystem){typeof this.weaponSystem.setFiring=="function"?this.weaponSystem.setFiring(!1):this.weaponSystem.isWeaponActive=!1;const i=window,s=i.gameInstance||i.game;s&&s.audio&&s.audio.stopSound("laser");return}const e=window,t=e.gameInstance||e.game;if(!t){console.error("WeaponHandler: No game reference found");return}if(t.combat){t.combat.setFiring(!1),t.audio&&t.audio.stopSound("laser");return}if(t.weaponSystem){typeof t.weaponSystem.setFiring=="function"?t.weaponSystem.setFiring(!1):t.weaponSystem.isWeaponActive=!1,t.audio&&t.audio.stopSound("laser");return}if(t.controls&&t.controls.weaponSystem){typeof t.controls.weaponSystem.setFiring=="function"?t.controls.weaponSystem.setFiring(!1):t.controls.weaponSystem.isWeaponActive=!1,t.audio&&t.audio.stopSound("laser");return}console.error("WeaponHandler: No weapon system or combat system found")}catch(e){console.error("WeaponHandler: Error in handleFiringEnd:",e)}}}class Lt{constructor(){n(this,"dockingSystem");n(this,"targetingSystem");this.dockingSystem=null,this.targetingSystem=null}setDockingSystem(e){this.dockingSystem=e}setTargetingSystem(e){this.targetingSystem=e}handleDocking(){if(!this.dockingSystem){console.error("SystemActions: Docking system not available");return}console.log("SystemActions: Dock button pressed, attempting to dock with stargate"),this.dockingSystem.dockWithStargate()}handleTargeting(){if(!this.targetingSystem){console.error("SystemActions: Targeting system not available");return}this.targetingSystem.toggleLockOn()}handleDeployLaser(){console.log("SystemActions: Deploying laser turret");const e=window;e.mainMessageBus&&e.mainMessageBus.publish("input.deployLaser",{})}shouldShowDock(e){if(!this.dockingSystem||!e){const t=window,i=t.gameInstance||t.game;return i&&i.controls&&i.controls.dockingSystem&&e?!!i.controls.dockingSystem.nearStargate&&!e.isDocked:!1}return!!this.dockingSystem.nearStargate&&!e.isDocked}}let At=class{constructor(e,t){n(this,"spaceship");n(this,"physics");n(this,"isInitialized");n(this,"joystickZones");n(this,"actionButtons");n(this,"joystickHandler");n(this,"gestureDetector");n(this,"miningHandler");n(this,"weaponHandler");n(this,"systemActions");this.spaceship=e,this.physics=t,this.isInitialized=!1,this.joystickZones=new kt,this.actionButtons=new Ct,this.joystickHandler=new Et(e,t),this.gestureDetector=new Pt,this.miningHandler=new Tt(e),this.weaponHandler=new xt,this.systemActions=new Lt,this.createCrosshair(),this.initializeAsync()}async initializeAsync(){try{await this.joystickHandler.loadNippleJS(),this.setupTouchControls()}catch(e){console.error("Failed to load nipple.js:",e)}}setControlSystems(e){if(console.log("TouchControls: Setting control systems"),!e){console.error("TouchControls: Controls object is null or undefined");return}this.miningHandler.setMiningSystem(e.miningSystem??null),this.miningHandler.setTargetingSystem(e.targetingSystem??null),this.weaponHandler.setWeaponSystem(e.weaponSystem??null),this.systemActions.setDockingSystem(e.dockingSystem??null),this.systemActions.setTargetingSystem(e.targetingSystem??null);const t={hasMiningSystem:!!e.miningSystem,hasTargetingSystem:!!e.targetingSystem,hasDockingSystem:!!e.dockingSystem,hasWeaponSystem:!!e.weaponSystem};return console.log("TouchControls: Systems connected",t),!this.spaceship&&e.spaceship&&(this.spaceship=e.spaceship,console.log("TouchControls: Spaceship reference set from controls")),this}createCrosshair(){const e=document.createElement("div");e.id="mobile-crosshair",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="10px",e.style.height="10px",e.style.pointerEvents="none",e.style.zIndex="999",e.innerHTML=`
            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background-color: rgba(120, 220, 232, 0.8);"></div>
            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background-color: rgba(120, 220, 232, 0.8);"></div>
            <div style="position: absolute; top: 50%; left: 50%; width: 3px; height: 3px; background-color: rgba(120, 220, 232, 0.8); border-radius: 50%; transform: translate(-50%, -50%);"></div>
        `,document.body.appendChild(e)}setupTouchControls(){const e=this.joystickZones.createJoystickZones(),t=this.actionButtons.createActionButtons();setTimeout(()=>{this.joystickHandler.initializeJoysticks(e.leftZone,e.rightZone)&&(this.setupButtonEvents(t),this.isInitialized=!0)},100)}setupButtonEvents(e){this.actionButtons.addButtonEvents(e.fire,()=>this.weaponHandler.handleFiringStart(),()=>this.weaponHandler.handleFiringEnd()),this.actionButtons.addButtonEvents(e.mine,()=>this.miningHandler.handleMiningStart(),()=>this.miningHandler.handleMiningEnd()),this.actionButtons.addButtonEvents(e.target,()=>this.systemActions.handleTargeting()),this.actionButtons.addButtonEvents(e.dock,()=>{this.systemActions.handleDocking(),this.actionButtons.hideDockButton()}),this.actionButtons.addButtonEvents(e.deployLaser,()=>this.systemActions.handleDeployLaser())}hide(){this.joystickZones.hideZones(),this.actionButtons.hideButtons(),this.gestureDetector.disable()}show(){const e=window;if(this.spaceship&&this.spaceship.isDocked||e.game&&e.game.introSequenceActive){console.log("TouchControls: Not showing controls during docked state or intro sequence");return}this.joystickZones.showZones(),this.actionButtons.showButtons(),this.gestureDetector.enable()}update(){this.systemActions.shouldShowDock(this.spaceship)?this.actionButtons.showDockButton():this.actionButtons.hideDockButton()}showDockButton(){this.actionButtons.showDockButton()}hideDockButton(){this.actionButtons.hideDockButton()}};class It extends At{constructor(t,i){super(t,i);n(this,"leftJoystick");n(this,"rightJoystick");n(this,"dockButton");n(this,"mineButton");n(this,"fireButton");n(this,"targetButton");n(this,"threshold");n(this,"miningSystem");n(this,"targetingSystem");n(this,"dockingSystem");n(this,"weaponSystem");this.leftJoystick=null,this.rightJoystick=null,this.dockButton=null,this.mineButton=null,this.fireButton=null,this.targetButton=null,this.threshold=.1,this.miningSystem=null,this.targetingSystem=null,this.dockingSystem=null,this.weaponSystem=null}setControlSystems(t){const i=super.setControlSystems(t);return this.miningSystem=t.miningSystem,this.targetingSystem=t.targetingSystem,this.dockingSystem=t.dockingSystem,this.weaponSystem=t.weaponSystem,i}}const b=class b{static isMobile(){if(b._isMobileCache!==void 0)return b._isMobileCache;const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Android|iP(ad|hone|od)/i.test(navigator.userAgent),t="ontouchstart"in window||navigator.maxTouchPoints!==void 0&&navigator.maxTouchPoints>0||navigator.msMaxTouchPoints!==void 0&&navigator.msMaxTouchPoints>0||window.DocumentTouch&&document instanceof window.DocumentTouch,i=window.innerWidth<900,s=(()=>{const l=document.querySelector("meta[name=viewport]");return l instanceof HTMLMetaElement?l.content.includes("width=device-width"):!1})(),o="orientation"in window||"onorientationchange"in window,r="DeviceMotionEvent"in window||"DeviceOrientationEvent"in window,a=(()=>{const l=navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,d=/android/i.test(navigator.userAgent)&&!/mobile/i.test(navigator.userAgent);return l||d})();return b._isMobileCache=e||t&&(i||o||r||s||a),console.log(`MobileDetector: Device detected as ${b._isMobileCache?"mobile":"desktop"}`),console.log(`- UA: ${e}, touch: ${t}, screen: ${i}`),console.log(`- features: ${o}, motion: ${r}, tablet: ${a}`),b._isMobileCache}static resetCache(){b._isMobileCache=void 0}static hasTouch(){return"ontouchstart"in window||navigator.maxTouchPoints!==void 0&&navigator.maxTouchPoints>0||navigator.msMaxTouchPoints!==void 0&&navigator.msMaxTouchPoints>0||window.DocumentTouch&&document instanceof window.DocumentTouch}static getOrientation(){return window.innerHeight>window.innerWidth?"portrait":"landscape"}static addOrientationChangeHandler(e){let t=b.getOrientation();const i=()=>{const s=b.getOrientation();s!==t&&(t=s,b.resetCache(),e(s))};window.addEventListener("resize",i),"onorientationchange"in window&&window.addEventListener("orientationchange",i)}};n(b,"_isMobileCache");let Z=b;class Dt{constructor(e,t,i,s){n(this,"spaceship");n(this,"physics");n(this,"environment");n(this,"ui");n(this,"isMobile");n(this,"_wasDocked");n(this,"weaponSystem");n(this,"scene");n(this,"inputHandler");n(this,"gamepadHandler");n(this,"touchControls");n(this,"miningSystem");n(this,"targetingSystem");n(this,"dockingSystem");n(this,"resources");n(this,"lastAnomalyCheck");n(this,"currentAnomaly");n(this,"showingAnomalyNotification");n(this,"deploymentSystem");console.log("Initializing controls systems..."),this.spaceship=e,this.physics=t,this.environment=i,this.ui=s,this.isMobile=Z.isMobile(),this._wasDocked=e?e.isDocked:!1,this.weaponSystem=null,this.scene=t.scene,this.isMobile?(console.log("Initializing touch controls for mobile"),this.touchControls=new It(e,t),this.inputHandler={isLocked:()=>!1,exitPointerLock:()=>{}}):(console.log("Initializing keyboard/mouse controls"),this.inputHandler=new ht(e,t),console.log("Initializing gamepad support"),this.gamepadHandler=new dt(e,t,this)),this.miningSystem=new yt(e,this.scene),this.targetingSystem=new wt(e,this.scene,i),this.dockingSystem=new Mt(e,i.stargate,s),this.resources=this.miningSystem.resourceExtraction.resources,this.dockingSystem.setResources(this.resources),this.isMobile&&this.touchControls&&this.touchControls.setControlSystems(this),this.connectUpgradeEffects(),this.setupEventHandlers(),this.lastAnomalyCheck=0,this.currentAnomaly=null,this.showingAnomalyNotification=!1,console.log("Control systems initialized")}connectUpgradeEffects(){this.dockingSystem.updateMiningSystem=()=>{if(this.miningSystem&&this.spaceship){const e=this.spaceship.miningEfficiency||1;Object.keys(this.miningSystem.miningSpeedByType).forEach(t=>{this.miningSystem._originalMiningSpeedByType||(this.miningSystem._originalMiningSpeedByType={...this.miningSystem.miningSpeedByType});const i=this.miningSystem._originalMiningSpeedByType[t];this.miningSystem.miningSpeedByType[t]=i*e}),console.log("Mining speeds updated with efficiency:",e),this.miningSystem.targetAsteroid&&this.miningSystem.setTargetAsteroid(this.miningSystem.targetAsteroid)}}}setupEventHandlers(){if(this.isMobile){console.log("Mobile device detected, touch handlers are set in TouchControls class");return}document.addEventListener("keydown",e=>{switch(e.key.toLowerCase()){case"e":this.targetingSystem.toggleLockOn();break;case"f7":this.gamepadHandler&&(this.gamepadHandler.lookSensitivity=Math.max(.2,this.gamepadHandler.lookSensitivity-.2),console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`),this.showSensitivityNotification(this.gamepadHandler.lookSensitivity)),e.preventDefault();break;case"f8":this.gamepadHandler&&(this.gamepadHandler.lookSensitivity=Math.min(3,this.gamepadHandler.lookSensitivity+.2),console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`),this.showSensitivityNotification(this.gamepadHandler.lookSensitivity)),e.preventDefault();break;case"f9":this.gamepadHandler&&(this.gamepadHandler.toggleDebug(),console.log("Gamepad debug display toggled")),e.preventDefault();break;case"tab":if(this.targetingSystem.isLockOnEnabled()){const t=this.targetingSystem.cycleLockOnTarget();t&&this.miningSystem.setTargetAsteroid(t)}e.preventDefault();break;case"r":if(this.targetingSystem.isLockOnEnabled()){const t=this.targetingSystem.getCurrentTarget();t&&(this.miningSystem.setTargetAsteroid(t),this.miningSystem.isMining?this.miningSystem.stopMining():this.miningSystem.startMining())}break;case"t":console.log("Deploying laser turret"),window.mainMessageBus&&window.mainMessageBus.publish("input.deployLaser",{});break;case"g":console.log("Attempting to pick up an item"),window.mainMessageBus&&window.mainMessageBus.publish("input.pickupInteract",{});break}}),document.addEventListener("mousedown",e=>{e.button===0&&this.inputHandler.isLocked()&&window.game&&window.game.combat&&window.game.combat.setFiring(!0)}),document.addEventListener("mouseup",e=>{e.button===0&&window.game&&window.game.combat&&window.game.combat.setFiring(!1)})}setupStargateUIControls(){this.dockingSystem&&this.dockingSystem.setupStargateUIControls()}dockWithStargate(){this.dockingSystem?(this.dockingSystem.dockWithStargate(),this.isMobile&&this.touchControls&&this.touchControls.hide()):console.error("Docking system not initialized")}collectEnergyOrb(){if(!this.environment||!this.spaceship)return;const e=this.environment.checkAnomalyCollision(this.spaceship.mesh.position);if(!e)return;const t=this.environment.collectAnomalyOrb(e);if(!t)return;this.resources.orbs||(this.resources.orbs={common:0,uncommon:0,rare:0,epic:0,legendary:0}),this.resources.orbs[t.rarity]=(this.resources.orbs[t.rarity]||0)+1;let i;switch(t.rarity){case"legendary":i="#ff0000";break;case"epic":i="#ff6600";break;case"rare":i="#9900ff";break;case"uncommon":i="#0066ff";break;default:i="#00ff66";break}const s=t.rarity.charAt(0).toUpperCase()+t.rarity.slice(1);if(this.showAnomalyMessage(`Collected ${s} Energy Orb (${t.value} CR)`,i),this.triggerOrbCollectionEffect(e),window.game&&window.game.audio)switch(t.rarity){case"legendary":window.game.audio.playSoundEffect("powerup_legendary",.8);break;case"epic":window.game.audio.playSoundEffect("powerup_epic",.7);break;case"rare":window.game.audio.playSoundEffect("powerup_rare",.6);break;case"uncommon":window.game.audio.playSoundEffect("powerup_uncommon",.5);break;default:window.game.audio.playSoundEffect("powerup_common",.4);break}}triggerOrbCollectionEffect(e){var t;if(!(!this.scene||!e)&&window.game&&window.game.combat){const i=e.position.clone();window.game.combat.createExplosionEffect(i,2e3,!0),window.mainMessageBus&&window.mainMessageBus.publish("vfx.explosion",{position:i,color:(t=e.orb)==null?void 0:t.color,size:e.orb?e.orb.size*2:1,duration:2e3})}}showAnomalyMessage(e,t){if(this.showingAnomalyNotification)return;this.showingAnomalyNotification=!0;const i=document.createElement("div");i.style.position="fixed",i.style.top="30%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.backgroundColor="rgba(0, 0, 0, 0.8)",i.style.color=t||"#ffffff",i.style.padding="15px 30px",i.style.borderRadius="10px",i.style.border=`2px solid ${t||"#ffffff"}`,i.style.boxShadow=`0 0 15px ${t||"#ffffff"}`,i.style.fontFamily="Courier New, monospace",i.style.fontSize="18px",i.style.zIndex="1000",i.style.textAlign="center",i.style.pointerEvents="none",i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.style.opacity="0",i.style.transition="opacity 0.8s",setTimeout(()=>{i.remove(),this.showingAnomalyNotification=!1},800)},3e3)}showSensitivityNotification(e){const t=document.createElement("div");t.textContent=`Gamepad Sensitivity: ${e.toFixed(1)}`,t.style.position="fixed",t.style.top="100px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="#30cfd0",t.style.padding="10px 20px",t.style.borderRadius="5px",t.style.border="1px solid #30cfd0",t.style.fontFamily="monospace",t.style.fontSize="16px",t.style.zIndex="10000",t.style.pointerEvents="none",document.body.appendChild(t),setTimeout(()=>{t.style.transition="opacity 0.5s",t.style.opacity="0",setTimeout(()=>t.remove(),500)},2e3)}update(e=1/60){if(!(window.game&&window.game.introSequenceActive)){if(this.spaceship){const t=this._wasDocked,i=this.spaceship.isDocked;this.isMobile&&this.touchControls&&t!==i&&(i?this.touchControls.hide():this.touchControls.show(),this._wasDocked=i)}if(this.spaceship&&this.spaceship.isDocked){this.dockingSystem&&this.dockingSystem.update();return}if(this.gamepadHandler&&this.gamepadHandler.update(e),this.targetingSystem&&this.targetingSystem.update(),this.miningSystem){this.miningSystem.update(e);const t=this.miningSystem.getLastDestroyedAsteroid();t&&this.environment&&this.environment.asteroidBelt&&this.environment.asteroidBelt.removeAsteroid(t)}this.dockingSystem&&this.dockingSystem.update(),this.isMobile&&this.touchControls&&this.touchControls.update(),this.deploymentSystem&&this.deploymentSystem.update(),this.checkForAnomalyOrbs()}}checkForAnomalyOrbs(){if(!this.environment||!this.spaceship)return;const e=performance.now();if(e-this.lastAnomalyCheck<500)return;this.lastAnomalyCheck=e;const t=this.environment.checkAnomalyCollision(this.spaceship.mesh.position);t&&!t.orbCollected?(this.collectEnergyOrb(),this.currentAnomaly=null):t&&t!==this.currentAnomaly&&t.orbCollected?(this.currentAnomaly=t,this.showAnomalyMessage("Energy orb already collected","#ff3333")):t||(this.currentAnomaly=null)}get isMining(){return this.miningSystem?this.miningSystem.isMining:!1}get miningProgress(){return this.miningSystem?this.miningSystem.miningProgress:0}}class Wt{constructor(e){n(this,"game");this.game=e}async initializeCore(){y.enabled&&console.log("Creating audio manager...");const{AudioManager:e}=await R(async()=>{const{AudioManager:d}=await import("./audio-BTuzEujB.js");return{AudioManager:d}},__vite__mapDeps([4,3]));this.game.audio=new e,y.enabled&&console.log("Creating renderer..."),this.game.renderer=await Y.create(),y.enabled&&console.log("Renderer created, getting scene...");const t=this.game.renderer;this.game.scene=t.scene,this.game.camera=t.camera,y.enabled&&console.log("Scene and camera references obtained");const i=this.game.scene;i.camera=this.game.camera,y.enabled&&console.log("Initializing essential components...");const s=new q(this.game.scene);this.game.physics=s,s.setCamera(this.game.camera);const{Environment:o}=await R(async()=>{const{Environment:d}=await import("./environment-C9XE_r0p.js");return{Environment:d}},__vite__mapDeps([5,1])),r=new o(this.game.scene);this.game.environment=r,y.enabled&&console.log("Creating spaceship...");const a=new ct(this.game.scene);this.game.spaceship=a,s.setSpaceship(a),r.setSpaceship(a);const{UI:l}=await R(async()=>{const{UI:d}=await import("./ui-DLX1Dt1V.js");return{UI:d}},__vite__mapDeps([6,1,7,8]));this.game.ui=new l(a,r),this.game.ui.setCameraAndRenderer(this.game.camera,this.game.renderer),await this.game.ui.initializeUIComponents(),await this.game.ui.setAudio(this.game.audio),this.game.controls=new Dt(a,s,r,this.game.ui),this.game.ui.setControls(this.game.controls),y.enabled&&console.log("Initializing settings..."),await this.game.ui.initializeSettings(this.game)}setupEventHandlers(){window.addEventListener("resize",this.game.handleResize.bind(this.game)),document.addEventListener("visibilitychange",this.game.handleVisibilityChange.bind(this.game)),document.addEventListener("keydown",this.game.handleKeyDown.bind(this.game))}startDocked(){var e,t;console.log("Starting game in docked state"),this.game.spaceship?this.game.spaceship.isDocked?console.log("Spaceship already docked"):(console.log("Docking spaceship..."),this.game.spaceship.dock()):console.error("No spaceship found!"),this.game.camera&&(this.game.camera.position.set(0,1500,0),console.log("Camera position set for docked state")),this.game.controls&&this.game.controls.dockingSystem&&(this.game.controls.dockingSystem.isDocked=!0,console.log("Docking system updated")),this.game.ui&&this.game.ui.stargateInterface?(console.log("Showing stargate UI..."),(t=(e=this.game.ui.stargateInterface).showStargateUI)==null||t.call(e)):console.error("No stargate interface found!",this.game.ui)}}class Rt{constructor(){n(this,"params");n(this,"gameTime");n(this,"currentLevel");this.params={maxEnemies:10,spawnInterval:3,enemyHealth:20,enemyDamage:15,enemySpeed:700},this.gameTime=0,this.currentLevel=1}update(e){this.gameTime+=e;const t=this.gameTime/60,i=Math.floor(t/3)+1;if(i!==this.currentLevel){this.currentLevel=i;const s=1+Math.min(this.currentLevel-1,4)*.5;this.params.maxEnemies=Math.min(10*s,30),this.params.spawnInterval=Math.max(3/s,1),this.params.enemyHealth=Math.floor(20*s),this.params.enemyDamage=Math.floor(15*s),this.params.enemySpeed=Math.min(700*(1+.2*(this.currentLevel-1)),1400),y.enabled&&(console.log(`Difficulty increased to level ${this.currentLevel} (${s}x)`),console.log(`Parameters: maxEnemies=${this.params.maxEnemies}, spawnInterval=${this.params.spawnInterval}`),console.log(`Health=${this.params.enemyHealth}, Damage=${this.params.enemyDamage}, Speed=${this.params.enemySpeed}`))}}}const qt=Object.freeze(Object.defineProperty({__proto__:null,DifficultyManager:Rt},Symbol.toStringTag,{value:"Module"}));class Bt{constructor(e){n(this,"game");n(this,"isActive");n(this,"startTime");n(this,"survivalTime");this.game=e,this.isActive=!1,this.startTime=0,this.survivalTime=0}activate(){this.isActive||(y.enabled&&console.log("ACTIVATING HORDE MODE - EXTREME SURVIVAL CHALLENGE"),this.isActive=!0,this.startTime=performance.now(),this.survivalTime=0,this.game.isHordeActive=!0,this.game.hordeStartTime=this.startTime,this.game.hordeSurvivalTime=this.survivalTime,this.game.audio&&this.game.audio.playSound("boink"),S.publish("horde.activated",{startTime:this.startTime}),this.game.ui&&this.game.ui.showNotification&&this.game.ui.showNotification("HORDE MODE ACTIVATED - SURVIVE!",5e3),this.game.spaceship&&this.game.spaceship.isDocked&&(y.enabled&&console.log("Horde mode forcing undock from stargate"),this.game.spaceship.undock(),S.publish("player.requestUndock",{forced:!0,reason:"horde_mode_activation"}),setTimeout(()=>{y.enabled&&console.log("Horde mode ensuring HUD is visible"),this.game.ui&&this.game.ui.showUI&&this.game.ui.showUI()},200)))}update(){this.isActive&&(this.survivalTime=performance.now()-this.startTime,this.game.hordeSurvivalTime=this.survivalTime)}getFormattedSurvivalTime(){const e=Math.floor(this.survivalTime/1e3),t=Math.floor(e/60),i=e%60;return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}}const Zt=Object.freeze(Object.defineProperty({__proto__:null,HordeMode:Bt},Symbol.toStringTag,{value:"Module"}));class Ut{constructor(e){n(this,"game");this.game=e}update(){if(!(!this.game.audio||!this.game.spaceship))if(this.game.spaceship.isDocked)this.game.audio.stopSound("thrust");else if(this.game.spaceship.thrust.forward||this.game.spaceship.thrust.backward||this.game.spaceship.thrust.left||this.game.spaceship.thrust.right){this.game.audio.playSound("thrust");let t=.5;this.game.spaceship.thrust.forward&&(t+=.2),this.game.spaceship.thrust.backward&&(t+=.1),this.game.spaceship.thrust.left&&(t+=.1),this.game.spaceship.thrust.right&&(t+=.1),this.game.spaceship.thrust.boost&&(t*=1.5),this.game.audio.setThrustVolume(t)}else this.game.audio.stopSound("thrust")}}const Yt=Object.freeze(Object.defineProperty({__proto__:null,AudioUpdater:Ut},Symbol.toStringTag,{value:"Module"}));class Ot{constructor(e){n(this,"game");this.game=e}checkGameOver(){this.game.spaceship&&(this.game.spaceship.isDocked||this.game.spaceship.fuel<=0&&!this.game.environment.stargate.isNearby(this.game.spaceship.mesh.position)&&this.gameOver("Out of fuel! You drift endlessly through space..."))}gameOver(e){if(!this.game.isGameOver){if(this.game.isGameOver=!0,this.game.boundAnimate&&cancelAnimationFrame(this.game.boundAnimate),this.game.ui)if(this.game.hordeMode&&this.game.hordeMode.isActive){const t=this.game.hordeMode.getFormattedSurvivalTime();this.game.ui.showGameOver(`HORDE MODE - Survived: ${t}
${e}`)}else this.game.ui.showGameOver(e);this.game.audio&&this.game.audio.playSound("gameOver"),this.game.gameOverCleanupTimeout=setTimeout(()=>{this.cleanup()},5e3)}}cleanup(){M&&M.clearAllPools&&M.clearAllPools(),this.game.audio&&this.game.audio.cleanup&&this.game.audio.cleanup()}destroy(){this.game.gameLoop&&(this.game.gameLoop.destroy(),this.game.gameLoop=null),this.game.gameOverCleanupTimeout&&(clearTimeout(this.game.gameOverCleanupTimeout),this.game.gameOverCleanupTimeout=void 0),window.removeEventListener("resize",this.game.handleResize),document.removeEventListener("visibilitychange",this.game.handleVisibilityChange),document.removeEventListener("keydown",this.game.handleKeyDown),this.game.renderer&&(this.game.renderer.dispose(),this.game.renderer=null),this.game.audio&&(this.game.audio.dispose(),this.game.audio=null),this.game.physics&&(this.game.physics.dispose(),this.game.physics=null),this.game.spaceship&&(this.game.spaceship.dispose(),this.game.spaceship=null),this.game.environment&&(this.game.environment.dispose(),this.game.environment=null),this.game.controls&&(this.game.controls.dispose(),this.game.controls=null),this.game.ui&&(this.game.ui.dispose(),this.game.ui=null),this.game.combat&&(this.game.combat.dispose(),this.game.combat=null),window.game=null}}const Xt=Object.freeze(Object.defineProperty({__proto__:null,GameLifecycle:Ot},Symbol.toStringTag,{value:"Module"}));class Ft{constructor(e){n(this,"game");n(this,"projectileGeometry");n(this,"projectileMaterial");n(this,"hitEffectGeometry");this.game=e}preWarmBasicShaders(){const e=this.game.scene,t=this.game.camera,i=this.game.renderer;if(!e||!t||!i)return;this.projectileGeometry=new T(1.8,12,12),this.projectileMaterial=new Fe({color:65535,emissive:65535,emissiveIntensity:5,metalness:.7,roughness:.3});const s=new w(this.projectileGeometry,this.projectileMaterial);e.add(s),i.renderer.compile(e,t),i._withGuard(()=>e.remove(s))}initializeObjectPools(){try{this.hitEffectGeometry||(this.hitEffectGeometry=new T(2,8,8)),M.createPool("hitEffect",()=>{const s=new k({color:16733440,transparent:!0,opacity:.8}),o=new w(this.hitEffectGeometry,s);return o.visible=!1,{mesh:o,material:s,reset:function(r=16733440,a=1){this.material.color.set(r),this.material.opacity=.8,this.mesh.scale.set(a,a,a),this.mesh.visible=!0},clear:function(){this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.visible=!1}}},5,20),this.projectileGeometry||(this.projectileGeometry=new T(1.8,12,12));const e=new T(.5,4,4),t=new k({color:16733440,transparent:!0});M.createPool("particle",()=>{const s=new w(e,t.clone());return s.visible=!1,{mesh:s,velocity:new g,life:0,reset:function(o,r,a=16733440){this.mesh.position.copy(o),this.velocity.copy(r),this.mesh.material.color.set(a),this.mesh.material.opacity=1,this.mesh.visible=!0,this.life=1},update:function(o){return this.life-=o*2,this.life<=0?(this.clear(),!1):(this.mesh.position.add(this.velocity.clone().multiplyScalar(o)),this.mesh.material.opacity=this.life,!0)},clear:function(){this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.visible=!1,this.life=0}}},20,100);const i=15;M.createPool("explosion",()=>{const s=new D,o=[];for(let r=0;r<i;r++){const a=M.get("particle");a&&o.push(a)}return{container:s,particles:o,active:!1,reset:function(r,a=16733440,l=50){this.container.position.copy(r),this.active=!0;for(let d=0;d<i;d++)if(this.particles[d]){const h=new g((Math.random()-.5)*l,(Math.random()-.5)*l,(Math.random()-.5)*l);this.particles[d].reset(new g,h,a),this.container.add(this.particles[d].mesh)}this.container.parent||window.game.scene.add(this.container)},update:function(r){if(!this.active)return!1;let a=!1;for(let l=0;l<i;l++)this.particles[l]&&this.particles[l].life>0&&this.particles[l].update(r)&&(a=!0);return a?!0:(this.clear(),!1)},clear:function(){this.active=!1;for(let r=0;r<i;r++)this.particles[r]&&this.particles[r].clear();this.container.parent&&this.container.parent.remove(this.container)}}},5,20)}catch(e){console.error("Error initializing object pools:",e)}}}const Jt=Object.freeze(Object.defineProperty({__proto__:null,ObjectPools:Ft},Symbol.toStringTag,{value:"Module"}));export{Nt as D,Wt as G,ue as M,zt as S,R as _,Vt as a,y as b,Z as c,qt as d,Yt as e,Xt as f,ze as g,Zt as h,Gt as i,Jt as j,S as m,M as o};
//# sourceMappingURL=game-core-OtPnLuF2.js.map
