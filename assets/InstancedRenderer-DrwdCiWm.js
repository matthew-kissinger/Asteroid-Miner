import{i as f}from"./modules-C8iQvmdl.js";import{au as y,x as p,I as d,O as g}from"./three-DyZj7Xio.js";import"./core-BKht4hCZ.js";class T extends f{constructor(e,t){super(e),this.requiredComponents=["TransformComponent"],this.priority=95,this.scene=t,this.cellSize=e&&e.spatial?e.spatial.cellSize:400,this.cellMeshes=new Map,this.entityToInstance=new Map}initialize(){}getArchetype(e){return e.hasTag&&e.hasTag("enemy")?"enemy_drone":null}getCellKeyFromPosition(e){const t=Math.floor(e.x/this.cellSize)|0,i=Math.floor(e.y/this.cellSize)|0,s=Math.floor(e.z/this.cellSize)|0;return`${t}|${i}|${s}`}ensureCellMesh(e,t,i){const s=`${e}|${t}`;let o=this.cellMeshes.get(s);if(o)return o;let r,l;i&&i.geometry&&i.material?(r=i.geometry,l=i.material):(r=new y(2,8,8),l=new p({color:16711935}));const m=2048,a=new d(r,l,m);return a.count=0,a.frustumCulled=!0,this.scene.add(a),o={mesh:a,count:0,max:m,freeIds:[],dummy:new g},this.cellMeshes.set(s,o),o}allocateInstance(e){if(e.freeIds.length>0)return e.freeIds.pop();if(e.count>=e.max)return-1;const t=e.count;return e.count++,e.mesh.count=e.count,t}releaseInstance(e,t){t<0||e.freeIds.push(t)}update(e){const t=this.world;if(!t||!t.entityManager)return;const i=t.getEntitiesWithComponents(["TransformComponent","MeshComponent"]);for(const s of i){const o=this.getArchetype(s);if(!o)continue;const r=s.getComponent("MeshComponent");r&&r.mesh&&(r.mesh.visible=!1);const l=s.getComponent("TransformComponent"),m=this.getCellKeyFromPosition(l.position),a=`${m}|${o}`;let c=this.entityToInstance.get(s.id),n=this.cellMeshes.get(a);if(!c||c.key!==a){if(c){const u=this.cellMeshes.get(c.key);u&&this.releaseInstance(u,c.index)}n=this.ensureCellMesh(m,o,r?r.mesh:null);const h=this.allocateInstance(n);if(h===-1)continue;c={key:a,index:h},this.entityToInstance.set(s.id,c)}n||(n=this.cellMeshes.get(a)),n&&(n.dummy.position.copy(l.position),n.dummy.quaternion.copy(l.quaternion),n.dummy.scale.set(1,1,1),n.dummy.updateMatrix(),n.mesh.setMatrixAt(c.index,n.dummy.matrix),n.mesh.instanceMatrix.needsUpdate=!0)}}}export{T as InstancedRenderer};
//# sourceMappingURL=InstancedRenderer-DrwdCiWm.js.map
