{"version":3,"mappings":"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AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;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","names":["toTrianglesDrawMode","geometry","drawMode","TrianglesDrawMode","TriangleFanDrawMode","TriangleStripDrawMode","index","indices","position","i","numberOfTriangles","newIndices","newGeometry","GLTFLoader","Loader","manager","parser","GLTFMaterialsClearcoatExtension","GLTFMaterialsDispersionExtension","GLTFTextureBasisUExtension","GLTFTextureWebPExtension","GLTFTextureAVIFExtension","GLTFMaterialsSheenExtension","GLTFMaterialsTransmissionExtension","GLTFMaterialsVolumeExtension","GLTFMaterialsIorExtension","GLTFMaterialsEmissiveStrengthExtension","GLTFMaterialsSpecularExtension","GLTFMaterialsIridescenceExtension","GLTFMaterialsAnisotropyExtension","GLTFMaterialsBumpExtension","GLTFLightsExtension","GLTFMeshoptCompression","GLTFMeshGpuInstancing","url","onLoad","onProgress","onError","scope","resourcePath","relativeUrl","LoaderUtils","_onError","e","loader","FileLoader","data","gltf","dracoLoader","ktx2Loader","meshoptDecoder","callback","path","json","extensions","plugins","textDecoder","BINARY_EXTENSION_HEADER_MAGIC","EXTENSIONS","GLTFBinaryExtension","error","GLTFParser","plugin","extensionName","extensionsRequired","GLTFMaterialsUnlitExtension","GLTFDracoMeshCompressionExtension","GLTFTextureTransformExtension","GLTFMeshQuantizationExtension","resolve","reject","GLTFRegistry","objects","key","object","nodeDefs","nodeIndex","nodeLength","nodeDef","lightIndex","cacheKey","dependency","lightDef","lightNode","color","Color","LinearSRGBColorSpace","range","DirectionalLight","PointLight","SpotLight","assignExtrasToUserData","type","self","light","MeshBasicMaterial","materialParams","materialDef","pending","metallicRoughness","array","SRGBColorSpace","materialIndex","emissiveStrength","MeshPhysicalMaterial","extension","scale","Vector2","colorFactor","colorArray","textureIndex","textureDef","name","source","handler","isSupported","image","bufferView","extensionDef","buffer","decoder","res","byteOffset","byteLength","count","stride","result","meshDef","primitive","WEBGL_CONSTANTS","attributesDef","attributes","accessor","results","nodeObject","meshes","instancedMeshes","mesh","m","Matrix4","p","Vector3","q","Quaternion","s","instancedMesh","InstancedMesh","attributeName","attr","InstancedBufferAttribute","Object3D","BINARY_EXTENSION_HEADER_LENGTH","BINARY_EXTENSION_CHUNK_TYPES","headerView","chunkContentsLength","chunkView","chunkIndex","chunkLength","chunkType","contentArray","bufferViewIndex","gltfAttributeMap","threeAttributeMap","attributeNormalizedMap","attributeTypeMap","threeAttributeName","ATTRIBUTES","accessorDef","componentType","WEBGL_COMPONENT_TYPES","attribute","normalized","texture","transform","GLTFCubicSplineInterpolant","Interpolant","parameterPositions","sampleValues","sampleSize","resultBuffer","values","valueSize","offset","i1","t0","t","t1","stride2","stride3","td","pp","ppp","offset1","offset0","s2","s3","s0","s1","p0","m0","p1","m1","_q","GLTFCubicSplineQuaternionInterpolant","WEBGL_FILTERS","NearestFilter","LinearFilter","NearestMipmapNearestFilter","LinearMipmapNearestFilter","NearestMipmapLinearFilter","LinearMipmapLinearFilter","WEBGL_WRAPPINGS","ClampToEdgeWrapping","MirroredRepeatWrapping","RepeatWrapping","WEBGL_TYPE_SIZES","PATH_PROPERTIES","INTERPOLATION","InterpolateLinear","InterpolateDiscrete","ALPHA_MODES","createDefaultMaterial","cache","MeshStandardMaterial","FrontSide","addUnknownExtensionsToUserData","knownExtensions","objectDef","gltfDef","addMorphTargets","targets","hasMorphPosition","hasMorphNormal","hasMorphColor","il","target","pendingPositionAccessors","pendingNormalAccessors","pendingColorAccessors","pendingAccessor","accessors","morphPositions","morphNormals","morphColors","updateMorphTargets","targetNames","createPrimitiveKey","primitiveDef","geometryKey","dracoExtension","createAttributesKey","attributesKey","keys","getNormalizedComponentScale","constructor","getImageURIMimeType","uri","_identityMatrix","options","isSafari","safariVersion","isFirefox","firefoxVersion","userAgent","safariMatch","TextureLoader","ImageBitmapLoader","ext","dependencies","scene","skinDefs","meshDefs","skinIndex","skinLength","joints","ref","updateMappings","original","clone","mappings","child","func","defs","def","bufferIndex","bufferDef","bufferViewDef","accessorIndex","itemSize","TypedArray","BufferAttribute","pendingBufferViews","bufferViews","elementBytes","itemBytes","byteStride","bufferAttribute","ibSlice","ibCacheKey","ib","InterleavedBuffer","InterleavedBufferAttribute","itemSizeIndices","TypedArrayIndices","byteOffsetIndices","byteOffsetValues","sparseIndices","sparseValues","sourceIndex","sourceDef","promise","sampler","URL","sourceURI","isObjectURL","blob","imageBitmap","Texture","mapName","mapDef","colorSpace","gltfReference","material","useDerivativeTangents","useVertexColors","useFlatShading","pointsMaterial","PointsMaterial","Material","lineMaterial","LineBasicMaterial","cachedMaterial","materialType","materialExtensions","kmuExtension","DoubleSide","alphaMode","emissiveFactor","originalName","sanitizedName","PropertyBinding","primitives","createDracoPrimitive","addPrimitiveAttributes","cached","geometryPromise","BufferGeometry","meshIndex","materials","geometries","SkinnedMesh","Mesh","LineSegments","Line","LineLoop","Points","group","Group","cameraIndex","camera","cameraDef","params","PerspectiveCamera","MathUtils","OrthographicCamera","skinDef","inverseBindMatrices","jointNodes","bones","boneInverses","jointNode","mat","Skeleton","animationIndex","animationDef","animationName","pendingNodes","pendingInputAccessors","pendingOutputAccessors","pendingSamplers","pendingTargets","channel","input","output","nodes","inputAccessors","outputAccessors","samplers","tracks","node","inputAccessor","outputAccessor","createdTracks","k","AnimationClip","o","nodePending","childPending","childrenDef","skeletonPending","children","skeleton","nodeName","meshPromise","Bone","matrix","sceneIndex","sceneDef","nodeIds","reduceAssociations","reducedAssociations","value","targetName","TypedKeyframeTrack","NumberKeyframeTrack","QuaternionKeyframeTrack","VectorKeyframeTrack","interpolation","outputArray","j","jl","track","scaled","interpolantType","computeBounds","box","Box3","min","max","boxScale","maxDisplacement","vector","sphere","Sphere","assignAttributeAccessor","gltfAttributeName","ColorManagement","CopyShader","Pass","_camera","FullscreenTriangleGeometry","Float32BufferAttribute","_geometry","FullScreenQuad","renderer","ShaderPass","shader","textureID","ShaderMaterial","UniformsUtils","writeBuffer","readBuffer","MaskPass","context","state","writeValue","clearValue","ClearMaskPass","EffectComposer","renderTarget","size","WebGLRenderTarget","HalfFloatType","NoBlending","Clock","tmp","pass","passIndex","deltaTime","currentRenderTarget","maskActive","stencil","width","height","effectiveWidth","effectiveHeight","pixelRatio","RenderPass","overrideMaterial","clearColor","clearAlpha","oldAutoClear","oldClearAlpha","oldOverrideMaterial","LuminosityHighPassShader","UnrealBloomPass","resolution","strength","radius","threshold","resx","resy","renderTargetHorizontal","renderTargetVertical","highPassShader","kernelSizeArray","bloomFactors","AdditiveBlending","inputRenderTarget","kernelRadius","coefficients","nMips","FXAAShader","ColorCorrectionShader","FilmShader","VignetteShader","WebGL","canvas","ctx","version","names","contexts","message","element","Renderer","warning","THREE.Scene","THREE.PerspectiveCamera","THREE.WebGLRenderer","THREE.PCFSoftShadowMap","THREE.ACESFilmicToneMapping","originalAdd","originalRemove","args","THREE.SRGBColorSpace","renderPass","THREE.Vector2","fxaaPass","THREE.Vector3","ambientLight","THREE.AmbientLight","directionalLight","THREE.DirectionalLight","fillLight","hemisphereLight","THREE.HemisphereLight","ambientPointLight","THREE.PointLight","sun","sunWorldPos","screenVector","x","y","camToSunDistance","normalizedDistance","camDirection","sunDirection","dotProduct","inst","startCalls","endCalls","alpha","world","entities","entity","THREE.Quaternion","entityId","viewDef","fn","prev","props","maxCount","THREE.InstancedMesh","THREE.Object3D","quaternion","instance","idx","THREE.Matrix4","propertyName","property","godRayShader","THREE.Color","shaderPass","claudeRayShader","useClaudeRays","enabled","uniforms","intensity","exposure","weight","density","TrailEffects","createExhaustBeam","direction","config","baseRadius","length","glowColor","THREE.Group","segments","beams","topRadius","bottomRadius","segmentLength","THREE.CylinderGeometry","THREE.MeshBasicMaterial","THREE.AdditiveBlending","THREE.DoubleSide","beam","THREE.Mesh","thrust","velocity","intent","leftPressed","rightPressed","effect","shouldShow","flicker","isMoving","mainEffect","Spaceship","THREE.Euler","bodyGroup","cylinderGeometry","bodyMaterial","THREE.MeshPhongMaterial","bodyCylinder","noseGeometry","THREE.ConeGeometry","noseCone","cockpitGeometry","THREE.SphereGeometry","cockpitMaterial","cockpit","cannonGeometry","cannonMaterial","emitterGeometry","emitterMaterial","createCurvedWing","isLeft","wingGroup","wingMaterial","wingBaseGeom","THREE.BoxGeometry","wingBase","wingCurveGeom","wingCurve","wingTipGeom","goldMaterial","wingTip","leftWing","rightWing","addGoldAccent","depth","z","rotX","rotY","rotZ","accentGeom","accent","thrusterGeometry","thrusterMaterial","mainThruster","reverseThruster","leftThruster","rightThruster","shieldBeforeUndock","stargatePosition","oldShield","players","health","oldHealthShield","oldHull","oldHealthHull","consumptionRate","thruster","colors","part","messageBus","healthComponent","ps","valuesForSync","oldHealth","_Physics","THREE.Raycaster","spaceship","hasFuel","thrustVector","isThrusting","shipForward","forwardPressed","backwardPressed","boostPressed","forwardThrust","maxVelocity","friction","positionDelta","maxY","euler","targetQuaternion","rotatedOffset","lookAtPoint","deltaX","deltaY","shipRadius","shipPosition","_a","asteroidMeshes","asteroidBelt","asteroids","a","_b","_c","distFromCenter","asteroid","distance","asteroidRadius","planetRadius","bounceDirection","explosionColor","explosionSize","explosionMessage","collisionType","explosionGeometry","explosionMaterial","explosion","__vitePreload","module","MessageBus","err","resistance","recoveryChance","recoveryRoll","survived","shieldGeometry","shieldMaterial","shield","expandSpeed","fadeSpeed","animateShield","animate","__publicField","Physics","Skybox","THREE.TextureLoader","texturePath","adjustedTexturePath","starDensity","nebulaDensity","skyboxColor","brightness","skyboxTexture","skyMaterial","THREE.ShaderMaterial","THREE.BackSide","skyboxGeometry","Sun","sunGeometry","sunMaterial","THREE.FrontSide","sunCoreMesh","coronaGeometry","coronaMaterial","coronaMesh","outerCoronaGeometry","outerCoronaMaterial","outerCoronaMesh","sunLight","sunDirectionalLight","flareTextures","textureLoader","flare","mainFlareTexture","mainFlare","THREE.Sprite","THREE.SpriteMaterial","flareCount","flareTexture","angle","smallFlareTexture","smallFlare","farRadius","farAngle","farX","farY","smallSize","lightIntensityMultiplier","temperature","activity","coronaColor","outerCoronaColor","flareColor","intensityMultiplier","baseIntensity","viewDependentMultiplier","viewVector","cameraNormal","angleToCam","cameraPos","lightPos","camDistanceToSun","shadowSize","time","pulseSpeed","pulseFactor","mainScale","originalSize","orbit","orbitSpeed","opacity","reducedOpacity","THREE.CameraHelper","planetTextures","proceduralTextures","Planets","starSystemGenerator","solarSystemPlanets","systemId","generatedPlanets","customPlanets","planet","prefixes","suffixes","starClass","planetCount","planetData","sizeMultiplier","distanceMultiplier","colorPalette","prefix","suffix","sizeClass","baseDistance","distanceVariation","speed","rings","axialTilt","orbitalTilt","planetGeometry","planetMaterial","adjustedTextureUrl","customTexture","THREE.MeshStandardMaterial","planetMesh","ringGeometry","ringMaterial","ringMesh","THREE.RingGeometry","region","AsteroidBelt","THREE.IcosahedronGeometry","THREE.TetrahedronGeometry","THREE.OctahedronGeometry","positions","vertex","resourceRoll","resourceType","heightVariation","orbitRadius","orbitTilt","baseResourceAmount","multipliers","densityMultiplier","shouldBeVisible","maxDistance","closestAsteroid","closestDistance","flatX","flatZ","tiltY","tiltZ","Stargate","stargateGroup","THREE.TorusGeometry","ring","createAccentRing","tubeRadius","rotation","accentRing","outerRing1","outerRing2","innerRing","detailsGroup","parentGroup","innerStructure","thinRingGeometry","thinRingMaterial","portalShaderMaterial","portalGeometry","THREE.CircleGeometry","portal","portalLight","createPortalWisps","wispGeometry","wispMaterial","wisp","createNeonAccent","accentGroup","beamGeometry","beamMaterial","lightMesh","particle","pulse","StarSystemGenerator","solarSystem","id","classification","starColor","resourceMult","system","systemIds","solarConnections","targetId","extraConnectionCount","sourceId","targetSystemId","currentParams","targetParams","weights","total","sum","random","number","features","starDescriptions","classDescriptions","baseDistribution","classMultiplier","exceptId","selected","systemData","customSystem","_d","randomSystem","standardizedPlanets","dockingSystem","SystemTransition","THREE.Points","THREE.BufferGeometry","THREE.PointsMaterial","i3","theta","THREE.BufferAttribute","onComplete","elapsed","progress","warpSpeed","ApiClient","expiryTime","currentTime","fiveMinutesInMs","success","response","errorMessage","cb","expiryDate","errorData","systemName","description","planetName","cleanPath","CustomSystemCreator","environment","style","button","firstPlanetDesc","textarea","maxChars","counter","updateCounter","remaining","closeBtn","modalContent","newIndex","planetDiv","removeBtn","slider","planetDesc","newPlanet","scrollPos","sizeSlider","sizeValue","distanceSlider","distanceValue","speedSlider","speedValue","planetInputs","planetHeader","skyboxDesc","skyboxResponse","planets","planetIndex","nameInput","descInput","sizeInput","distanceInput","speedInput","ringsInput","planetResponse","alertOverlay","alertBox","messageEl","okButton","stargateUI","VibeVersePortals","surfaceGeometry","surfaceMaterial","surface","particleCount","particleGeometry","particleMaterial","THREE.Box3","THREE.CanvasTexture","labelGeometry","THREE.PlaneGeometry","labelMaterial","label","shipBox","targetUrl","finalUrl","nextPage","SpaceAnomalies","availableTypes","anomaly","typeToSpawn","anomaliesToRemove","crystal","arc","frame","anomalyCountEl","playerPosition","playerNearby","anomalyGroup","ringCount","hue","orbRarity","orb","crystals","crystalCount","crystalType","THREE.DodecahedronGeometry","saturation","lightness","phi","ringRadius","ringHue","ringColor","crystalSize","crystalGeometry","crystalHue","crystalColor","crystalMaterial","coreRadius","coreGeometry","coreColor","coreMaterial","core","arcCount","arcs","curve","THREE.CubicBezierCurve3","points","arcGeometry","arcColor","arcMaterial","THREE.LineBasicMaterial","THREE.Line","frames","frameCount","innerGeometry","edges","THREE.EdgesGeometry","innerMaterial","THREE.LineSegments","innerBox","particlePositions","particleSizes","particles","glowGeometry","glowMaterial","glow","rarity","orbGeometry","orbMaterial","glowSize","gradient","THREE.Texture","roll","closestAnomaly","orbData","floatOffset","rotationMatrix","crystalScale","controlPoint1","controlPoint2","pulseScale","velocities","maxDist","pos","corePulse","warpX","warpY","warpZ","initialPositions","phases","radialPulse","Environment","stargateRegion","resources","solarSystemParams","notification","asteroidBeltRegion","anomaliesRegion","anomalyType","orbStatus","nearbyAsteroids","sunRegion","InputHandler","physics","clearBit","bit","instructionsElement","movementX","movementY","GamepadHandler","controls","gamepads","gamepad","leftX","leftY","rightStickX","rightStickY","applyCurve","sign","abs","curvedX","curvedY","baseSpeed","smoothing","rtValue","axis5","buttonIndex","duration","html","isRightX","isRightY","rightX","rightY","rt","lt","temp","MiningSystem","efficiency","targetInfo","inRange","targetDistance","rangeStatus","rangeColor","laserBeam","laserColor","laserIntensity","miningProgressContainer","progressBar","miningStatusElement","secondsRequired","efficiencyText","asteroidPosition","shipOffset","tempVector","shipX","shipY","asteroidX","asteroidY","dx","dy","thickness","additionalBeam","particleSpeed","dir","bonusChance","amount","particleSystem","animateParticles","destroyedAsteroid","TargetingSystem","innerRingGeometry","innerRingMaterial","targetInfoElement","b","item","targetNameElement","lookAtPos","game","targetDistanceElement","screenPosition","targetDirection","margin","halfWidth","halfHeight","normalizedDir","edgeX","edgeY","slopeRatio","screenRatio","worldPosition","DockingSystem","stargate","ui","refuelBtn","repairShieldBtn","repairHullBtn","undockBtn","handleUndock","sellIronBtn","sellGoldBtn","sellPlatinumBtn","buttonId","costGetter","upgradeFunction","cost","miningSystem","stepFunction","stepName","container","loadingIndicator","newPosition","healthData","customSystemCreator","starMap","closeStarMapBtn","modal","TouchControls","systemStatus","crosshair","script","leftJoystickZone","rightJoystickZone","leftActionButtonsContainer","rightActionButtonsContainer","parent","text","evt","force","xMove","yMove","targetAsteroid","closestDist","dist","leftZone","rightZone","leftActionButtons","rightActionButtons","startHandler","endHandler","MobileDetector","userAgentCheck","touchCheck","screenCheck","viewportCheck","viewport","mobileFeatureCheck","motionCheck","isTablet","isIpad","isAndroidTablet","prevOrientation","checkOrientation","currentOrientation","Controls","originalSpeed","rarityColor","capitalizedRarity","sensitivity","wasDocked","isDocked","now","HUD","hudContainer","fontLink","scanlineEffect","activeScanline","flightPanel","panelHeader","statusIndicator","fuelRow","fuelLabel","fuelValue","fuelBarContainer","fuelBar","controlsButton","statusPanel","shieldRow","shieldLabel","shieldBarContainer","shieldBar","hullRow","hullLabel","hullBarContainer","hullBar","soundToggleBtn","isMuted","targetingSystem","locationPanel","resourcePanel","resourceHeader","createResourceRow","hexColor","row","hexIcon","capacityRow","capacityLabel","capacityValue","capacityBarContainer","capacityBar","notificationsArea","hordeIndicator","hordeContent","hordeLabel","survivalTime","panel","defaultValue","isIndicator","labelEl","valueEl","status","topLeft","topRight","bottomLeft","bottomRight","glitchAnimation","moveScanline","fuelPercent","creditsDisplay","totalSeconds","minutes","seconds","styleEl","shieldPercentage","shieldFound","hullPercentage","healthFound","locationName","currentSystem","coordsElement","fps","cap","fpsElement","frameId","MobileHUD","cargoContainer","cargoLabel","cargoValue","hordeContainer","hordeTimer","labelElement","barContainer","bar","anomalyContainer","anomalyLabel","anomalyCount","maxCargo","totalCargo","MiningDisplay","miningTime","ironAmount","goldAmount","platinumAmount","cargoCapacity","totalResources","maxCapacity","capacityPercentage","miningTimeElement","TargetingUI","lockOnDisplay","diagonalLines","targetIndicator","targetType","targetTypeElement","targetResourceElement","resourceColor","StargateInterface","blackjackGame","settings","dockingPrompt","settingsButton","starMapButton","blackjackButton","btn","laserCountElement","purchaseLaserBtn","updateOrbSellButton","orbCount","borderColor","currentCredits","activeColor","resourceAmount","tabButtons","customSystemBtn","hordeButton","content","title","buttons","yesBtn","noBtn","getAbsolutePath","relativePath","basePath","fullPath","GameOverScreen","gameOverContainer","gameOverTitle","gameOverMessage","resourcesSummary","restartButton","loadingStatus","displayMessage","wasHordeMode","hordeSurvivalTime","rawSurvivalTime","resourceData","iron","gold","platinum","hordeMessage","boinkSound","ControlsMenu","controlsMenu","controlsTitle","createControlRow","keyText","actionText","keySpan","actionSpan","showControlsButton","StarMap","stargateInterface","mapContainer","infoPanel","selectedSystem","closeButton","travelButton","travelHandler","event","rect","clickedSystem","systems","centerX","centerY","canvasX","canvasY","selectedCard","isConnected","isCurrentSystem","connections","connectedSystems","x1","y1","connectedId","connectedSystem","x2","y2","currentSystemData","isCurrent","isSelected","BlackjackGame","audio","scanlines","header","subtitle","gameArea","dealerArea","dealerHeader","dealerTitle","dealerScore","dealerCards","speechBubble","statusArea","gameStatus","playerArea","playerHeader","playerTitle","playerScore","playerCards","controlsArea","bettingControls","bettingTitle","resourceOptions","createResourceButton","resource","resourceName","addHoverEffect","removeHoverEffect","clickHandler","betAmountControls","betAmountDisplay","createControlButton","decreaseBtn","increaseBtn","gameActions","enableHoverEffects","disableHoverEffects","gameResources","suits","suit","card","hand","score","aces","faceDown","cardEl","backDesign","logo","topValue","topSuit","centerSymbol","bottomValue","bottomSuit","pattern","holoEffect","maxAmount","dealBtn","hitBtn","standBtn","doubleBtn","canDouble","canDeal","ironElement","goldElement","platinumElement","visibleScore","dealerPlayNextCard","faceDownEl","lastCard","winAmount","phrases","randomPhrase","Settings","savedSettings","parsedSettings","settingsContainer","backButton","applyButton","applyHandler","presetName","presetHandler","preset","THREE.PCFShadowMap","oldCap","performance","gl","debugInfo","quickMeasure","isGaming","isHighEnd","warmupFrames","timestamps","startTime","detectFrame","timestamp","intervals","delta","q1","q3","iqr","validRates","rate","avg","newRate","commonRates","closest","minDiff","commonRate","diff","StartScreen","startScreen","playButton","howToPlayButton","howToPlayModal","closeHowToPlayButton","timeToStartScreen","typedArrayPools","FixedArray","MemoryStats","report","UI","mobileCSS","wasMobile","fpsDisplay","fallbackOverlay","messageText","mobileHudContainer","pointerLockInstructions","statsContainer","memoryStats","fpsCounter","AudioManager","loadPromises","sound","gameplaySounds","audioData","audioBuffer","directory","handleInteraction","forceAudioResume","attachToButtons","attempts","interval","actionButtons","soundtrackFiles","dummyAudio","currentIndex","randomIndex","files","shuffledFiles","file","anyFilesExist","soundEffects","currentTrack","playPromise","sourceNode","gainNode","volumeMultiplier","thrustLevel","volume","Entity","component","componentTypeName","tag","allTags","hasTag","cacheInconsistent","EntityManager","entityOrId","componentTypes","SystemManager","systemType","SpatialHash","cellSize","ix","iy","iz","v","ix0","iy0","iz0","ix1","iy1","iz1","set","center","EntityIndex","view","World","entitiesWithMesh","System","Component$1","HealthComponent","Component","maxHealth","maxShield","oldMaxShield","oldMaxHealth","resistedAmount","shieldDamage","healthDamage","startHealth","healedAmount","startShield","rechargedAmount","regenAmount","healthRegenAmount","multiplier","oldMax","TransformComponent","tempMatrix","forward","right","up","RigidbodyComponent","mass","point","transformComponent","torque","impulse","velocityChange","angularVelocity","CombatSystem","validProjectileIds","projectiles","enemyProjectiles","projectileId","projectile","projectileTransform","projectileRigidbody","isPlayerProjectile","isEnemyProjectile","raycaster","projectilePosition","projectileDirection","rayOffset","rayOrigin","targetHit","meshComponent","intersections","intersection","targetTransform","damage","targetHealth","damageType","damageResult","effectColor","effectSize","hitEffect","objectPoolAvailable","effectMesh","useObjectPool","EnemyAIComponent","player","playerEntities","allEntities","playerTransform","distanceToPlayer","baseDirection","playerHealth","remainingDamage","entityWorld","properUp","moveSpeed","finalDirection","zigzag","circleSpeed","circleDir","char","strafeDir","approachDir","bobAmount","evasiveTime","horizontalEvasion","verticalEvasion","thrustPulse","separationDirection","separationStrength","dynamicInfluence","lookTarget","lateralMovement","bankAngle","bankQuaternion","amplitude","offsetX","offsetY","nextSpiral","lookAheadOffsetX","lookAheadOffsetY","tiltAngle","tiltQuaternion","MeshComponent","defaultGeom","defaultMat","visible","castShadow","receiveShadow","EnemyPoolManager","maxPoolSize","spectralEntity","enemyAI","newEntity","enemies","trailComponent","rigidbody","inconsistenciesFixed","poolEntityIds","duplicateIndices","activePooledEntities","enemyTaggedCount","pooledTaggedCount","inconsistentEntities","enemyTaggedEntities","entityFixed","EnemySpawner","modelPaths","tryLoadModel","xhr","maxEnemies","spawnFunction","currentSpawnInterval","spawnPoint","diffParams","poolManager","frequency","finalSize","rotationOffset","visualVariant","spectralMesh","prevGuard","transformComp","currentTransform","trailSystemRegistered","trailSystem","bodyGeometry","body","wingGeometry","wing1","wing2","model","colorIndex","selectedColor","emissiveIntensity","additionalEffects","shieldPhase","shimmerValue","haloGeometry","haloMaterial","halo","EnemyLifecycle","validEnemies","enemyId","entitiesScanned","enemyEntities","enemy","entitiesByTag","enemyMap","invalidEntities","activeEnemies","returnEnemyToPool","enemyIds","excessCount","EnemySystem","remainingTime","minutesPassed","baseMaxEnemies","maxEnemiesScale","maxSpawnInterval","baseSpawnInterval","healthMultiplier","damageMultiplier","speedMultiplier","separationForce","separationThreshold","nearbyEnemies","neighborId","neighbor","neighborTransform","awayVector","enemyEntity","enemyTransform","isTrackedEnemy","isInPool","timeSinceLastSpawn","RenderSystem","THREE.Frustum","checkComponentsAdded","msg","isInView","missingCount","CollisionSystem","cellX","cellY","cellZ","cellKey","isProjectile","cellRadius","speedFactor","dz","neighborKey","entityCellKeys","cellEntities","otherEntity","pairId","otherTransform","otherRigidbody","posA","radiusA","posB","radiusB","distanceSquared","radiusSum","playerProjectile","entityIsProjectile","otherIsEnemy","otherIsProjectile","entityIsEnemy","entityA","entityB","transformA","rigidbodyA","transformB","rigidbodyB","velocityAlongNormal","invMassA","invMassB","impulseScalar","percent","slop","penetration","correction","VisualEffectsSystem","usePooling","particlePos","particleMesh","effectId","dt","flash","TrailSystem","trail","ObjectPool","createFn","resetFn","initialSize","expandSize","activeObjects","disposeFn","ProjectilePoolManager","sharedAssets","glowMesh","muzzleFlash","flashLight","trailContainer","tracer","sizeIndex","travelProgress","travelDistance","stretchFactor","Combat","dummyGeometry","sphereGeometry","pointsPositions","pointsGeometry","dummyProjectile","dummyGlow","dummyTrail","dummyFlash","dummyTracer","dummyExplosion","dummyTrailContainer","trailParticle","tempScene","numPoints","THREE.Float32BufferAttribute","OptimizedProjectileStore","InstancedRenderer","existingEntity","playerEntity","introActive","isFiring","isVisible","tracersToRemove","beamGroup","userData","fadeProgress","dissolveDistance","newStartOffset","newStartPos","newLength","newMidpoint","opacityFactor","screenCenter","maxRange","leftOffset","rightOffset","weaponForwardOffset","leftWeaponPosition","rightWeaponPosition","leftHitEnemy","rightHitEnemy","enemyPosition","enemyMeshComponent","distanceToEnemy","enemySystem","syncError","rayLine","leftEndPoint","rightEndPoint","cylinderDefaultDirection","startPos","endPos","isHit","fadeTime","coreMesh","innerGlowGeometry","innerGlowMaterial","innerGlowMesh","outerGlowGeometry","outerGlowMaterial","outerGlowMesh","midpoint","trailParticles","ratio","animateTrail","currentScale","startPosition","endPosition","lookAtPosition","className","SystemClass"],"ignoreList":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],"sources":["../../node_modules/three/examples/jsm/utils/BufferGeometryUtils.js","../../node_modules/three/examples/jsm/loaders/GLTFLoader.js","../../node_modules/three/examples/jsm/shaders/CopyShader.js","../../node_modules/three/examples/jsm/postprocessing/Pass.js","../../node_modules/three/examples/jsm/postprocessing/ShaderPass.js","../../node_modules/three/examples/jsm/postprocessing/MaskPass.js","../../node_modules/three/examples/jsm/postprocessing/EffectComposer.js","../../node_modules/three/examples/jsm/postprocessing/RenderPass.js","../../node_modules/three/examples/jsm/shaders/LuminosityHighPassShader.js","../../node_modules/three/examples/jsm/postprocessing/UnrealBloomPass.js","../../node_modules/three/examples/jsm/shaders/FXAAShader.js","../../node_modules/three/examples/jsm/shaders/ColorCorrectionShader.js","../../node_modules/three/examples/jsm/shaders/FilmShader.js","../../node_modules/three/examples/jsm/shaders/VignetteShader.js","../../node_modules/three/examples/jsm/capabilities/WebGL.js","../../js/modules/renderer.js","../../js/modules/trail.js","../../js/modules/spaceship.js","../../js/modules/physics.js","../../js/modules/environment/skybox.js","../../js/modules/environment/sun.js","../../js/modules/environment/planets.js","../../js/modules/environment/asteroidBelt.js","../../js/modules/environment/stargate.js","../../js/modules/environment/starSystemGenerator.js","../../js/modules/environment/systemTransition.js","../../js/modules/utils/apiClient.js","../../js/modules/ui/customSystemCreator.js","../../js/modules/environment/vibeVersePortals.js","../../js/modules/environment/spaceAnomalies.js","../../js/modules/environment.js","../../js/modules/controls/inputHandler.js","../../js/modules/controls/gamepadHandler.js","../../js/modules/controls/miningSystem.js","../../js/modules/controls/targetingSystem.js","../../js/modules/controls/dockingSystem.js","../../js/modules/controls/touchControls.js","../../js/utils/mobileDetector.js","../../js/modules/controls.js","../../js/modules/ui/hud.js","../../js/modules/ui/mobileHUD.js","../../js/modules/ui/miningDisplay.js","../../js/modules/ui/targetingUI.js","../../js/modules/ui/stargateInterface.js","../../js/utils/pathUtils.js","../../js/modules/ui/gameOverScreen.js","../../js/modules/ui/controlsMenu.js","../../js/modules/ui/starMap.js","../../js/modules/ui/blackjackGame.js","../../js/modules/ui/settings.js","../../js/modules/ui/startScreen.js","../../js/utils/memoryManager.js","../../js/modules/ui.js","../../js/modules/audio.js","../../js/core/entity.js","../../js/core/entityManager.js","../../js/core/systemManager.js","../../js/core/spatial/SpatialHash.js","../../js/core/EntityIndex.js","../../js/core/world.js","../../js/core/system.js","../../js/core/component.js","../../js/components/combat/healthComponent.js","../../js/components/transform.js","../../js/components/physics/rigidbody.js","../../js/systems/combat/combatSystem.js","../../js/components/combat/enemyAI.js","../../js/components/rendering/mesh.js","../../js/systems/combat/enemyPoolManager.js","../../js/systems/combat/enemySpawner.js","../../js/systems/combat/enemyLifecycle.js","../../js/systems/combat/enemySystem.js","../../js/systems/rendering/renderSystem.js","../../js/systems/physics/collisionSystem.js","../../js/systems/rendering/visualEffectsSystem.js","../../js/systems/rendering/trailSystem.js","../../js/modules/pooling/ObjectPool.js","../../js/modules/pooling/ProjectilePoolManager.js","../../js/modules/combat.js"],"sourcesContent":["import {\n\tBufferAttribute,\n\tBufferGeometry,\n\tFloat32BufferAttribute,\n\tInstancedBufferAttribute,\n\tInterleavedBuffer,\n\tInterleavedBufferAttribute,\n\tTriangleFanDrawMode,\n\tTriangleStripDrawMode,\n\tTrianglesDrawMode,\n\tVector3,\n} from 'three';\n\n/** @module BufferGeometryUtils */\n\n/**\n * Computes vertex tangents using the MikkTSpace algorithm. MikkTSpace generates the same tangents consistently,\n * and is used in most modelling tools and normal map bakers. Use MikkTSpace for materials with normal maps,\n * because inconsistent tangents may lead to subtle visual issues in the normal map, particularly around mirrored\n * UV seams.\n *\n * In comparison to this method, {@link BufferGeometry#computeTangents} (a custom algorithm) generates tangents that\n * probably will not match the tangents in other software. The custom algorithm is sufficient for general use with a\n * custom material, and may be faster than MikkTSpace.\n *\n * Returns the original BufferGeometry. Indexed geometries will be de-indexed. Requires position, normal, and uv attributes.\n *\n * @param {BufferGeometry} geometry - The geometry to compute tangents for.\n * @param {Object} MikkTSpace - Instance of `examples/jsm/libs/mikktspace.module.js`, or `mikktspace` npm package.\n * Await `MikkTSpace.ready` before use.\n * @param {boolean} [negateSign=true] - Whether to negate the sign component (.w) of each tangent.\n * Required for normal map conventions in some formats, including glTF.\n * @return {BufferGeometry} The updated geometry.\n */\nfunction computeMikkTSpaceTangents( geometry, MikkTSpace, negateSign = true ) {\n\n\tif ( ! MikkTSpace || ! MikkTSpace.isReady ) {\n\n\t\tthrow new Error( 'BufferGeometryUtils: Initialized MikkTSpace library required.' );\n\n\t}\n\n\tif ( ! geometry.hasAttribute( 'position' ) || ! geometry.hasAttribute( 'normal' ) || ! geometry.hasAttribute( 'uv' ) ) {\n\n\t\tthrow new Error( 'BufferGeometryUtils: Tangents require \"position\", \"normal\", and \"uv\" attributes.' );\n\n\t}\n\n\tfunction getAttributeArray( attribute ) {\n\n\t\tif ( attribute.normalized || attribute.isInterleavedBufferAttribute ) {\n\n\t\t\tconst dstArray = new Float32Array( attribute.count * attribute.itemSize );\n\n\t\t\tfor ( let i = 0, j = 0; i < attribute.count; i ++ ) {\n\n\t\t\t\tdstArray[ j ++ ] = attribute.getX( i );\n\t\t\t\tdstArray[ j ++ ] = attribute.getY( i );\n\n\t\t\t\tif ( attribute.itemSize > 2 ) {\n\n\t\t\t\t\tdstArray[ j ++ ] = attribute.getZ( i );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn dstArray;\n\n\t\t}\n\n\t\tif ( attribute.array instanceof Float32Array ) {\n\n\t\t\treturn attribute.array;\n\n\t\t}\n\n\t\treturn new Float32Array( attribute.array );\n\n\t}\n\n\t// MikkTSpace algorithm requires non-indexed input.\n\n\tconst _geometry = geometry.index ? geometry.toNonIndexed() : geometry;\n\n\t// Compute vertex tangents.\n\n\tconst tangents = MikkTSpace.generateTangents(\n\n\t\tgetAttributeArray( _geometry.attributes.position ),\n\t\tgetAttributeArray( _geometry.attributes.normal ),\n\t\tgetAttributeArray( _geometry.attributes.uv )\n\n\t);\n\n\t// Texture coordinate convention of glTF differs from the apparent\n\t// default of the MikkTSpace library; .w component must be flipped.\n\n\tif ( negateSign ) {\n\n\t\tfor ( let i = 3; i < tangents.length; i += 4 ) {\n\n\t\t\ttangents[ i ] *= - 1;\n\n\t\t}\n\n\t}\n\n\t//\n\n\t_geometry.setAttribute( 'tangent', new BufferAttribute( tangents, 4 ) );\n\n\tif ( geometry !== _geometry ) {\n\n\t\tgeometry.copy( _geometry );\n\n\t}\n\n\treturn geometry;\n\n}\n\n/**\n * Merges a set of geometries into a single instance. All geometries must have compatible attributes.\n *\n * @param {Array<BufferGeometry>} geometries - The geometries to merge.\n * @param {boolean} [useGroups=false] - Whether to use groups or not.\n * @return {?BufferGeometry} The merged geometry. Returns `null` if the merge does not succeed.\n */\nfunction mergeGeometries( geometries, useGroups = false ) {\n\n\tconst isIndexed = geometries[ 0 ].index !== null;\n\n\tconst attributesUsed = new Set( Object.keys( geometries[ 0 ].attributes ) );\n\tconst morphAttributesUsed = new Set( Object.keys( geometries[ 0 ].morphAttributes ) );\n\n\tconst attributes = {};\n\tconst morphAttributes = {};\n\n\tconst morphTargetsRelative = geometries[ 0 ].morphTargetsRelative;\n\n\tconst mergedGeometry = new BufferGeometry();\n\n\tlet offset = 0;\n\n\tfor ( let i = 0; i < geometries.length; ++ i ) {\n\n\t\tconst geometry = geometries[ i ];\n\t\tlet attributesCount = 0;\n\n\t\t// ensure that all geometries are indexed, or none\n\n\t\tif ( isIndexed !== ( geometry.index !== null ) ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '. All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// gather attributes, exit early if they're different\n\n\t\tfor ( const name in geometry.attributes ) {\n\n\t\t\tif ( ! attributesUsed.has( name ) ) {\n\n\t\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '. All geometries must have compatible attributes; make sure \"' + name + '\" attribute exists among all geometries, or in none of them.' );\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t\tif ( attributes[ name ] === undefined ) attributes[ name ] = [];\n\n\t\t\tattributes[ name ].push( geometry.attributes[ name ] );\n\n\t\t\tattributesCount ++;\n\n\t\t}\n\n\t\t// ensure geometries have the same number of attributes\n\n\t\tif ( attributesCount !== attributesUsed.size ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '. Make sure all geometries have the same number of attributes.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// gather morph attributes, exit early if they're different\n\n\t\tif ( morphTargetsRelative !== geometry.morphTargetsRelative ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '. .morphTargetsRelative must be consistent throughout all geometries.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tfor ( const name in geometry.morphAttributes ) {\n\n\t\t\tif ( ! morphAttributesUsed.has( name ) ) {\n\n\t\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '.  .morphAttributes must be consistent throughout all geometries.' );\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t\tif ( morphAttributes[ name ] === undefined ) morphAttributes[ name ] = [];\n\n\t\t\tmorphAttributes[ name ].push( geometry.morphAttributes[ name ] );\n\n\t\t}\n\n\t\tif ( useGroups ) {\n\n\t\t\tlet count;\n\n\t\t\tif ( isIndexed ) {\n\n\t\t\t\tcount = geometry.index.count;\n\n\t\t\t} else if ( geometry.attributes.position !== undefined ) {\n\n\t\t\t\tcount = geometry.attributes.position.count;\n\n\t\t\t} else {\n\n\t\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index ' + i + '. The geometry must have either an index or a position attribute' );\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t\tmergedGeometry.addGroup( offset, count, i );\n\n\t\t\toffset += count;\n\n\t\t}\n\n\t}\n\n\t// merge indices\n\n\tif ( isIndexed ) {\n\n\t\tlet indexOffset = 0;\n\t\tconst mergedIndex = [];\n\n\t\tfor ( let i = 0; i < geometries.length; ++ i ) {\n\n\t\t\tconst index = geometries[ i ].index;\n\n\t\t\tfor ( let j = 0; j < index.count; ++ j ) {\n\n\t\t\t\tmergedIndex.push( index.getX( j ) + indexOffset );\n\n\t\t\t}\n\n\t\t\tindexOffset += geometries[ i ].attributes.position.count;\n\n\t\t}\n\n\t\tmergedGeometry.setIndex( mergedIndex );\n\n\t}\n\n\t// merge attributes\n\n\tfor ( const name in attributes ) {\n\n\t\tconst mergedAttribute = mergeAttributes( attributes[ name ] );\n\n\t\tif ( ! mergedAttribute ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the ' + name + ' attribute.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tmergedGeometry.setAttribute( name, mergedAttribute );\n\n\t}\n\n\t// merge morph attributes\n\n\tfor ( const name in morphAttributes ) {\n\n\t\tconst numMorphTargets = morphAttributes[ name ][ 0 ].length;\n\n\t\tif ( numMorphTargets === 0 ) break;\n\n\t\tmergedGeometry.morphAttributes = mergedGeometry.morphAttributes || {};\n\t\tmergedGeometry.morphAttributes[ name ] = [];\n\n\t\tfor ( let i = 0; i < numMorphTargets; ++ i ) {\n\n\t\t\tconst morphAttributesToMerge = [];\n\n\t\t\tfor ( let j = 0; j < morphAttributes[ name ].length; ++ j ) {\n\n\t\t\t\tmorphAttributesToMerge.push( morphAttributes[ name ][ j ][ i ] );\n\n\t\t\t}\n\n\t\t\tconst mergedMorphAttribute = mergeAttributes( morphAttributesToMerge );\n\n\t\t\tif ( ! mergedMorphAttribute ) {\n\n\t\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the ' + name + ' morphAttribute.' );\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t\tmergedGeometry.morphAttributes[ name ].push( mergedMorphAttribute );\n\n\t\t}\n\n\t}\n\n\treturn mergedGeometry;\n\n}\n\n/**\n * Merges a set of attributes into a single instance. All attributes must have compatible properties and types.\n * Instances of {@link InterleavedBufferAttribute} are not supported.\n *\n * @param {Array<BufferAttribute>} attributes - The attributes to merge.\n * @return {?BufferAttribute} The merged attribute. Returns `null` if the merge does not succeed.\n */\nfunction mergeAttributes( attributes ) {\n\n\tlet TypedArray;\n\tlet itemSize;\n\tlet normalized;\n\tlet gpuType = - 1;\n\tlet arrayLength = 0;\n\n\tfor ( let i = 0; i < attributes.length; ++ i ) {\n\n\t\tconst attribute = attributes[ i ];\n\n\t\tif ( TypedArray === undefined ) TypedArray = attribute.array.constructor;\n\t\tif ( TypedArray !== attribute.array.constructor ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tif ( itemSize === undefined ) itemSize = attribute.itemSize;\n\t\tif ( itemSize !== attribute.itemSize ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tif ( normalized === undefined ) normalized = attribute.normalized;\n\t\tif ( normalized !== attribute.normalized ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tif ( gpuType === - 1 ) gpuType = attribute.gpuType;\n\t\tif ( gpuType !== attribute.gpuType ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes.' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tarrayLength += attribute.count * itemSize;\n\n\t}\n\n\tconst array = new TypedArray( arrayLength );\n\tconst result = new BufferAttribute( array, itemSize, normalized );\n\tlet offset = 0;\n\n\tfor ( let i = 0; i < attributes.length; ++ i ) {\n\n\t\tconst attribute = attributes[ i ];\n\t\tif ( attribute.isInterleavedBufferAttribute ) {\n\n\t\t\tconst tupleOffset = offset / itemSize;\n\t\t\tfor ( let j = 0, l = attribute.count; j < l; j ++ ) {\n\n\t\t\t\tfor ( let c = 0; c < itemSize; c ++ ) {\n\n\t\t\t\t\tconst value = attribute.getComponent( j, c );\n\t\t\t\t\tresult.setComponent( j + tupleOffset, c, value );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tarray.set( attribute.array, offset );\n\n\t\t}\n\n\t\toffset += attribute.count * itemSize;\n\n\t}\n\n\tif ( gpuType !== undefined ) {\n\n\t\tresult.gpuType = gpuType;\n\n\t}\n\n\treturn result;\n\n}\n\n/**\n * Performs a deep clone of the given buffer attribute.\n *\n * @param {BufferAttribute} attribute - The attribute to clone.\n * @return {BufferAttribute} The cloned attribute.\n */\nfunction deepCloneAttribute( attribute ) {\n\n\tif ( attribute.isInstancedInterleavedBufferAttribute || attribute.isInterleavedBufferAttribute ) {\n\n\t\treturn deinterleaveAttribute( attribute );\n\n\t}\n\n\tif ( attribute.isInstancedBufferAttribute ) {\n\n\t\treturn new InstancedBufferAttribute().copy( attribute );\n\n\t}\n\n\treturn new BufferAttribute().copy( attribute );\n\n}\n\n/**\n * Interleaves a set of attributes and returns a new array of corresponding attributes that share a\n * single {@link InterleavedBuffer} instance. All attributes must have compatible types.\n *\n * @param {Array<BufferAttribute>} attributes - The attributes to interleave.\n * @return {Array<InterleavedBufferAttribute>} An array of interleaved attributes. If interleave does not succeed, the method returns `null`.\n */\nfunction interleaveAttributes( attributes ) {\n\n\t// Interleaves the provided attributes into an InterleavedBuffer and returns\n\t// a set of InterleavedBufferAttributes for each attribute\n\tlet TypedArray;\n\tlet arrayLength = 0;\n\tlet stride = 0;\n\n\t// calculate the length and type of the interleavedBuffer\n\tfor ( let i = 0, l = attributes.length; i < l; ++ i ) {\n\n\t\tconst attribute = attributes[ i ];\n\n\t\tif ( TypedArray === undefined ) TypedArray = attribute.array.constructor;\n\t\tif ( TypedArray !== attribute.array.constructor ) {\n\n\t\t\tconsole.error( 'AttributeBuffers of different types cannot be interleaved' );\n\t\t\treturn null;\n\n\t\t}\n\n\t\tarrayLength += attribute.array.length;\n\t\tstride += attribute.itemSize;\n\n\t}\n\n\t// Create the set of buffer attributes\n\tconst interleavedBuffer = new InterleavedBuffer( new TypedArray( arrayLength ), stride );\n\tlet offset = 0;\n\tconst res = [];\n\tconst getters = [ 'getX', 'getY', 'getZ', 'getW' ];\n\tconst setters = [ 'setX', 'setY', 'setZ', 'setW' ];\n\n\tfor ( let j = 0, l = attributes.length; j < l; j ++ ) {\n\n\t\tconst attribute = attributes[ j ];\n\t\tconst itemSize = attribute.itemSize;\n\t\tconst count = attribute.count;\n\t\tconst iba = new InterleavedBufferAttribute( interleavedBuffer, itemSize, offset, attribute.normalized );\n\t\tres.push( iba );\n\n\t\toffset += itemSize;\n\n\t\t// Move the data for each attribute into the new interleavedBuffer\n\t\t// at the appropriate offset\n\t\tfor ( let c = 0; c < count; c ++ ) {\n\n\t\t\tfor ( let k = 0; k < itemSize; k ++ ) {\n\n\t\t\t\tiba[ setters[ k ] ]( c, attribute[ getters[ k ] ]( c ) );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\treturn res;\n\n}\n\n/**\n * Returns a new, non-interleaved version of the given attribute.\n *\n * @param {InterleavedBufferAttribute} attribute - The interleaved attribute.\n * @return {BufferAttribute} The non-interleaved attribute.\n */\nfunction deinterleaveAttribute( attribute ) {\n\n\tconst cons = attribute.data.array.constructor;\n\tconst count = attribute.count;\n\tconst itemSize = attribute.itemSize;\n\tconst normalized = attribute.normalized;\n\n\tconst array = new cons( count * itemSize );\n\tlet newAttribute;\n\tif ( attribute.isInstancedInterleavedBufferAttribute ) {\n\n\t\tnewAttribute = new InstancedBufferAttribute( array, itemSize, normalized, attribute.meshPerAttribute );\n\n\t} else {\n\n\t\tnewAttribute = new BufferAttribute( array, itemSize, normalized );\n\n\t}\n\n\tfor ( let i = 0; i < count; i ++ ) {\n\n\t\tnewAttribute.setX( i, attribute.getX( i ) );\n\n\t\tif ( itemSize >= 2 ) {\n\n\t\t\tnewAttribute.setY( i, attribute.getY( i ) );\n\n\t\t}\n\n\t\tif ( itemSize >= 3 ) {\n\n\t\t\tnewAttribute.setZ( i, attribute.getZ( i ) );\n\n\t\t}\n\n\t\tif ( itemSize >= 4 ) {\n\n\t\t\tnewAttribute.setW( i, attribute.getW( i ) );\n\n\t\t}\n\n\t}\n\n\treturn newAttribute;\n\n}\n\n/**\n * Deinterleaves all attributes on the given geometry.\n *\n * @param {BufferGeometry} geometry - The geometry to deinterleave.\n */\nfunction deinterleaveGeometry( geometry ) {\n\n\tconst attributes = geometry.attributes;\n\tconst morphTargets = geometry.morphTargets;\n\tconst attrMap = new Map();\n\n\tfor ( const key in attributes ) {\n\n\t\tconst attr = attributes[ key ];\n\t\tif ( attr.isInterleavedBufferAttribute ) {\n\n\t\t\tif ( ! attrMap.has( attr ) ) {\n\n\t\t\t\tattrMap.set( attr, deinterleaveAttribute( attr ) );\n\n\t\t\t}\n\n\t\t\tattributes[ key ] = attrMap.get( attr );\n\n\t\t}\n\n\t}\n\n\tfor ( const key in morphTargets ) {\n\n\t\tconst attr = morphTargets[ key ];\n\t\tif ( attr.isInterleavedBufferAttribute ) {\n\n\t\t\tif ( ! attrMap.has( attr ) ) {\n\n\t\t\t\tattrMap.set( attr, deinterleaveAttribute( attr ) );\n\n\t\t\t}\n\n\t\t\tmorphTargets[ key ] = attrMap.get( attr );\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * Returns the amount of bytes used by all attributes to represent the geometry.\n *\n * @param {BufferGeometry} geometry - The geometry.\n * @return {number} The estimate bytes used.\n */\nfunction estimateBytesUsed( geometry ) {\n\n\t// Return the estimated memory used by this geometry in bytes\n\t// Calculate using itemSize, count, and BYTES_PER_ELEMENT to account\n\t// for InterleavedBufferAttributes.\n\tlet mem = 0;\n\tfor ( const name in geometry.attributes ) {\n\n\t\tconst attr = geometry.getAttribute( name );\n\t\tmem += attr.count * attr.itemSize * attr.array.BYTES_PER_ELEMENT;\n\n\t}\n\n\tconst indices = geometry.getIndex();\n\tmem += indices ? indices.count * indices.itemSize * indices.array.BYTES_PER_ELEMENT : 0;\n\treturn mem;\n\n}\n\n/**\n * Returns a new geometry with vertices for which all similar vertex attributes (within tolerance) are merged.\n *\n * @param {BufferGeometry} geometry - The geometry to merge vertices for.\n * @param {number} [tolerance=1e-4] - The tolerance value.\n * @return {BufferGeometry} - The new geometry with merged vertices.\n */\nfunction mergeVertices( geometry, tolerance = 1e-4 ) {\n\n\ttolerance = Math.max( tolerance, Number.EPSILON );\n\n\t// Generate an index buffer if the geometry doesn't have one, or optimize it\n\t// if it's already available.\n\tconst hashToIndex = {};\n\tconst indices = geometry.getIndex();\n\tconst positions = geometry.getAttribute( 'position' );\n\tconst vertexCount = indices ? indices.count : positions.count;\n\n\t// next value for triangle indices\n\tlet nextIndex = 0;\n\n\t// attributes and new attribute arrays\n\tconst attributeNames = Object.keys( geometry.attributes );\n\tconst tmpAttributes = {};\n\tconst tmpMorphAttributes = {};\n\tconst newIndices = [];\n\tconst getters = [ 'getX', 'getY', 'getZ', 'getW' ];\n\tconst setters = [ 'setX', 'setY', 'setZ', 'setW' ];\n\n\t// Initialize the arrays, allocating space conservatively. Extra\n\t// space will be trimmed in the last step.\n\tfor ( let i = 0, l = attributeNames.length; i < l; i ++ ) {\n\n\t\tconst name = attributeNames[ i ];\n\t\tconst attr = geometry.attributes[ name ];\n\n\t\ttmpAttributes[ name ] = new attr.constructor(\n\t\t\tnew attr.array.constructor( attr.count * attr.itemSize ),\n\t\t\tattr.itemSize,\n\t\t\tattr.normalized\n\t\t);\n\n\t\tconst morphAttributes = geometry.morphAttributes[ name ];\n\t\tif ( morphAttributes ) {\n\n\t\t\tif ( ! tmpMorphAttributes[ name ] ) tmpMorphAttributes[ name ] = [];\n\t\t\tmorphAttributes.forEach( ( morphAttr, i ) => {\n\n\t\t\t\tconst array = new morphAttr.array.constructor( morphAttr.count * morphAttr.itemSize );\n\t\t\t\ttmpMorphAttributes[ name ][ i ] = new morphAttr.constructor( array, morphAttr.itemSize, morphAttr.normalized );\n\n\t\t\t} );\n\n\t\t}\n\n\t}\n\n\t// convert the error tolerance to an amount of decimal places to truncate to\n\tconst halfTolerance = tolerance * 0.5;\n\tconst exponent = Math.log10( 1 / tolerance );\n\tconst hashMultiplier = Math.pow( 10, exponent );\n\tconst hashAdditive = halfTolerance * hashMultiplier;\n\tfor ( let i = 0; i < vertexCount; i ++ ) {\n\n\t\tconst index = indices ? indices.getX( i ) : i;\n\n\t\t// Generate a hash for the vertex attributes at the current index 'i'\n\t\tlet hash = '';\n\t\tfor ( let j = 0, l = attributeNames.length; j < l; j ++ ) {\n\n\t\t\tconst name = attributeNames[ j ];\n\t\t\tconst attribute = geometry.getAttribute( name );\n\t\t\tconst itemSize = attribute.itemSize;\n\n\t\t\tfor ( let k = 0; k < itemSize; k ++ ) {\n\n\t\t\t\t// double tilde truncates the decimal value\n\t\t\t\thash += `${ ~ ~ ( attribute[ getters[ k ] ]( index ) * hashMultiplier + hashAdditive ) },`;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// Add another reference to the vertex if it's already\n\t\t// used by another index\n\t\tif ( hash in hashToIndex ) {\n\n\t\t\tnewIndices.push( hashToIndex[ hash ] );\n\n\t\t} else {\n\n\t\t\t// copy data to the new index in the temporary attributes\n\t\t\tfor ( let j = 0, l = attributeNames.length; j < l; j ++ ) {\n\n\t\t\t\tconst name = attributeNames[ j ];\n\t\t\t\tconst attribute = geometry.getAttribute( name );\n\t\t\t\tconst morphAttributes = geometry.morphAttributes[ name ];\n\t\t\t\tconst itemSize = attribute.itemSize;\n\t\t\t\tconst newArray = tmpAttributes[ name ];\n\t\t\t\tconst newMorphArrays = tmpMorphAttributes[ name ];\n\n\t\t\t\tfor ( let k = 0; k < itemSize; k ++ ) {\n\n\t\t\t\t\tconst getterFunc = getters[ k ];\n\t\t\t\t\tconst setterFunc = setters[ k ];\n\t\t\t\t\tnewArray[ setterFunc ]( nextIndex, attribute[ getterFunc ]( index ) );\n\n\t\t\t\t\tif ( morphAttributes ) {\n\n\t\t\t\t\t\tfor ( let m = 0, ml = morphAttributes.length; m < ml; m ++ ) {\n\n\t\t\t\t\t\t\tnewMorphArrays[ m ][ setterFunc ]( nextIndex, morphAttributes[ m ][ getterFunc ]( index ) );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\thashToIndex[ hash ] = nextIndex;\n\t\t\tnewIndices.push( nextIndex );\n\t\t\tnextIndex ++;\n\n\t\t}\n\n\t}\n\n\t// generate result BufferGeometry\n\tconst result = geometry.clone();\n\tfor ( const name in geometry.attributes ) {\n\n\t\tconst tmpAttribute = tmpAttributes[ name ];\n\n\t\tresult.setAttribute( name, new tmpAttribute.constructor(\n\t\t\ttmpAttribute.array.slice( 0, nextIndex * tmpAttribute.itemSize ),\n\t\t\ttmpAttribute.itemSize,\n\t\t\ttmpAttribute.normalized,\n\t\t) );\n\n\t\tif ( ! ( name in tmpMorphAttributes ) ) continue;\n\n\t\tfor ( let j = 0; j < tmpMorphAttributes[ name ].length; j ++ ) {\n\n\t\t\tconst tmpMorphAttribute = tmpMorphAttributes[ name ][ j ];\n\n\t\t\tresult.morphAttributes[ name ][ j ] = new tmpMorphAttribute.constructor(\n\t\t\t\ttmpMorphAttribute.array.slice( 0, nextIndex * tmpMorphAttribute.itemSize ),\n\t\t\t\ttmpMorphAttribute.itemSize,\n\t\t\t\ttmpMorphAttribute.normalized,\n\t\t\t);\n\n\t\t}\n\n\t}\n\n\t// indices\n\n\tresult.setIndex( newIndices );\n\n\treturn result;\n\n}\n\n/**\n * Returns a new indexed geometry based on `TrianglesDrawMode` draw mode.\n * This mode corresponds to the `gl.TRIANGLES` primitive in WebGL.\n *\n * @param {BufferGeometry} geometry - The geometry to convert.\n * @param {number} drawMode - The current draw mode.\n * @return {BufferGeometry} The new geometry using `TrianglesDrawMode`.\n */\nfunction toTrianglesDrawMode( geometry, drawMode ) {\n\n\tif ( drawMode === TrianglesDrawMode ) {\n\n\t\tconsole.warn( 'THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles.' );\n\t\treturn geometry;\n\n\t}\n\n\tif ( drawMode === TriangleFanDrawMode || drawMode === TriangleStripDrawMode ) {\n\n\t\tlet index = geometry.getIndex();\n\n\t\t// generate index if not present\n\n\t\tif ( index === null ) {\n\n\t\t\tconst indices = [];\n\n\t\t\tconst position = geometry.getAttribute( 'position' );\n\n\t\t\tif ( position !== undefined ) {\n\n\t\t\t\tfor ( let i = 0; i < position.count; i ++ ) {\n\n\t\t\t\t\tindices.push( i );\n\n\t\t\t\t}\n\n\t\t\t\tgeometry.setIndex( indices );\n\t\t\t\tindex = geometry.getIndex();\n\n\t\t\t} else {\n\n\t\t\t\tconsole.error( 'THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible.' );\n\t\t\t\treturn geometry;\n\n\t\t\t}\n\n\t\t}\n\n\t\t//\n\n\t\tconst numberOfTriangles = index.count - 2;\n\t\tconst newIndices = [];\n\n\t\tif ( drawMode === TriangleFanDrawMode ) {\n\n\t\t\t// gl.TRIANGLE_FAN\n\n\t\t\tfor ( let i = 1; i <= numberOfTriangles; i ++ ) {\n\n\t\t\t\tnewIndices.push( index.getX( 0 ) );\n\t\t\t\tnewIndices.push( index.getX( i ) );\n\t\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\t// gl.TRIANGLE_STRIP\n\n\t\t\tfor ( let i = 0; i < numberOfTriangles; i ++ ) {\n\n\t\t\t\tif ( i % 2 === 0 ) {\n\n\t\t\t\t\tnewIndices.push( index.getX( i ) );\n\t\t\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\t\t\t\t\tnewIndices.push( index.getX( i + 2 ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tnewIndices.push( index.getX( i + 2 ) );\n\t\t\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\t\t\t\t\tnewIndices.push( index.getX( i ) );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( ( newIndices.length / 3 ) !== numberOfTriangles ) {\n\n\t\t\tconsole.error( 'THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.' );\n\n\t\t}\n\n\t\t// build final geometry\n\n\t\tconst newGeometry = geometry.clone();\n\t\tnewGeometry.setIndex( newIndices );\n\t\tnewGeometry.clearGroups();\n\n\t\treturn newGeometry;\n\n\t} else {\n\n\t\tconsole.error( 'THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:', drawMode );\n\t\treturn geometry;\n\n\t}\n\n}\n\n/**\n * Calculates the morphed attributes of a morphed/skinned BufferGeometry.\n *\n * Helpful for Raytracing or Decals (i.e. a `DecalGeometry` applied to a morphed Object with a `BufferGeometry`\n * will use the original `BufferGeometry`, not the morphed/skinned one, generating an incorrect result.\n * Using this function to create a shadow `Object3`D the `DecalGeometry` can be correctly generated).\n *\n * @param {Mesh|Line|Points} object - The 3D object to compute morph attributes for.\n * @return {Object} An object with original position/normal attributes and morphed ones.\n */\nfunction computeMorphedAttributes( object ) {\n\n\tconst _vA = new Vector3();\n\tconst _vB = new Vector3();\n\tconst _vC = new Vector3();\n\n\tconst _tempA = new Vector3();\n\tconst _tempB = new Vector3();\n\tconst _tempC = new Vector3();\n\n\tconst _morphA = new Vector3();\n\tconst _morphB = new Vector3();\n\tconst _morphC = new Vector3();\n\n\tfunction _calculateMorphedAttributeData(\n\t\tobject,\n\t\tattribute,\n\t\tmorphAttribute,\n\t\tmorphTargetsRelative,\n\t\ta,\n\t\tb,\n\t\tc,\n\t\tmodifiedAttributeArray\n\t) {\n\n\t\t_vA.fromBufferAttribute( attribute, a );\n\t\t_vB.fromBufferAttribute( attribute, b );\n\t\t_vC.fromBufferAttribute( attribute, c );\n\n\t\tconst morphInfluences = object.morphTargetInfluences;\n\n\t\tif ( morphAttribute && morphInfluences ) {\n\n\t\t\t_morphA.set( 0, 0, 0 );\n\t\t\t_morphB.set( 0, 0, 0 );\n\t\t\t_morphC.set( 0, 0, 0 );\n\n\t\t\tfor ( let i = 0, il = morphAttribute.length; i < il; i ++ ) {\n\n\t\t\t\tconst influence = morphInfluences[ i ];\n\t\t\t\tconst morph = morphAttribute[ i ];\n\n\t\t\t\tif ( influence === 0 ) continue;\n\n\t\t\t\t_tempA.fromBufferAttribute( morph, a );\n\t\t\t\t_tempB.fromBufferAttribute( morph, b );\n\t\t\t\t_tempC.fromBufferAttribute( morph, c );\n\n\t\t\t\tif ( morphTargetsRelative ) {\n\n\t\t\t\t\t_morphA.addScaledVector( _tempA, influence );\n\t\t\t\t\t_morphB.addScaledVector( _tempB, influence );\n\t\t\t\t\t_morphC.addScaledVector( _tempC, influence );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t_morphA.addScaledVector( _tempA.sub( _vA ), influence );\n\t\t\t\t\t_morphB.addScaledVector( _tempB.sub( _vB ), influence );\n\t\t\t\t\t_morphC.addScaledVector( _tempC.sub( _vC ), influence );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t_vA.add( _morphA );\n\t\t\t_vB.add( _morphB );\n\t\t\t_vC.add( _morphC );\n\n\t\t}\n\n\t\tif ( object.isSkinnedMesh ) {\n\n\t\t\tobject.applyBoneTransform( a, _vA );\n\t\t\tobject.applyBoneTransform( b, _vB );\n\t\t\tobject.applyBoneTransform( c, _vC );\n\n\t\t}\n\n\t\tmodifiedAttributeArray[ a * 3 + 0 ] = _vA.x;\n\t\tmodifiedAttributeArray[ a * 3 + 1 ] = _vA.y;\n\t\tmodifiedAttributeArray[ a * 3 + 2 ] = _vA.z;\n\t\tmodifiedAttributeArray[ b * 3 + 0 ] = _vB.x;\n\t\tmodifiedAttributeArray[ b * 3 + 1 ] = _vB.y;\n\t\tmodifiedAttributeArray[ b * 3 + 2 ] = _vB.z;\n\t\tmodifiedAttributeArray[ c * 3 + 0 ] = _vC.x;\n\t\tmodifiedAttributeArray[ c * 3 + 1 ] = _vC.y;\n\t\tmodifiedAttributeArray[ c * 3 + 2 ] = _vC.z;\n\n\t}\n\n\tconst geometry = object.geometry;\n\tconst material = object.material;\n\n\tlet a, b, c;\n\tconst index = geometry.index;\n\tconst positionAttribute = geometry.attributes.position;\n\tconst morphPosition = geometry.morphAttributes.position;\n\tconst morphTargetsRelative = geometry.morphTargetsRelative;\n\tconst normalAttribute = geometry.attributes.normal;\n\tconst morphNormal = geometry.morphAttributes.position;\n\n\tconst groups = geometry.groups;\n\tconst drawRange = geometry.drawRange;\n\tlet i, j, il, jl;\n\tlet group;\n\tlet start, end;\n\n\tconst modifiedPosition = new Float32Array( positionAttribute.count * positionAttribute.itemSize );\n\tconst modifiedNormal = new Float32Array( normalAttribute.count * normalAttribute.itemSize );\n\n\tif ( index !== null ) {\n\n\t\t// indexed buffer geometry\n\n\t\tif ( Array.isArray( material ) ) {\n\n\t\t\tfor ( i = 0, il = groups.length; i < il; i ++ ) {\n\n\t\t\t\tgroup = groups[ i ];\n\n\t\t\t\tstart = Math.max( group.start, drawRange.start );\n\t\t\t\tend = Math.min( ( group.start + group.count ), ( drawRange.start + drawRange.count ) );\n\n\t\t\t\tfor ( j = start, jl = end; j < jl; j += 3 ) {\n\n\t\t\t\t\ta = index.getX( j );\n\t\t\t\t\tb = index.getX( j + 1 );\n\t\t\t\t\tc = index.getX( j + 2 );\n\n\t\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\t\tobject,\n\t\t\t\t\t\tpositionAttribute,\n\t\t\t\t\t\tmorphPosition,\n\t\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\t\ta, b, c,\n\t\t\t\t\t\tmodifiedPosition\n\t\t\t\t\t);\n\n\t\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\t\tobject,\n\t\t\t\t\t\tnormalAttribute,\n\t\t\t\t\t\tmorphNormal,\n\t\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\t\ta, b, c,\n\t\t\t\t\t\tmodifiedNormal\n\t\t\t\t\t);\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tstart = Math.max( 0, drawRange.start );\n\t\t\tend = Math.min( index.count, ( drawRange.start + drawRange.count ) );\n\n\t\t\tfor ( i = start, il = end; i < il; i += 3 ) {\n\n\t\t\t\ta = index.getX( i );\n\t\t\t\tb = index.getX( i + 1 );\n\t\t\t\tc = index.getX( i + 2 );\n\n\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\tobject,\n\t\t\t\t\tpositionAttribute,\n\t\t\t\t\tmorphPosition,\n\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\ta, b, c,\n\t\t\t\t\tmodifiedPosition\n\t\t\t\t);\n\n\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\tobject,\n\t\t\t\t\tnormalAttribute,\n\t\t\t\t\tmorphNormal,\n\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\ta, b, c,\n\t\t\t\t\tmodifiedNormal\n\t\t\t\t);\n\n\t\t\t}\n\n\t\t}\n\n\t} else {\n\n\t\t// non-indexed buffer geometry\n\n\t\tif ( Array.isArray( material ) ) {\n\n\t\t\tfor ( i = 0, il = groups.length; i < il; i ++ ) {\n\n\t\t\t\tgroup = groups[ i ];\n\n\t\t\t\tstart = Math.max( group.start, drawRange.start );\n\t\t\t\tend = Math.min( ( group.start + group.count ), ( drawRange.start + drawRange.count ) );\n\n\t\t\t\tfor ( j = start, jl = end; j < jl; j += 3 ) {\n\n\t\t\t\t\ta = j;\n\t\t\t\t\tb = j + 1;\n\t\t\t\t\tc = j + 2;\n\n\t\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\t\tobject,\n\t\t\t\t\t\tpositionAttribute,\n\t\t\t\t\t\tmorphPosition,\n\t\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\t\ta, b, c,\n\t\t\t\t\t\tmodifiedPosition\n\t\t\t\t\t);\n\n\t\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\t\tobject,\n\t\t\t\t\t\tnormalAttribute,\n\t\t\t\t\t\tmorphNormal,\n\t\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\t\ta, b, c,\n\t\t\t\t\t\tmodifiedNormal\n\t\t\t\t\t);\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tstart = Math.max( 0, drawRange.start );\n\t\t\tend = Math.min( positionAttribute.count, ( drawRange.start + drawRange.count ) );\n\n\t\t\tfor ( i = start, il = end; i < il; i += 3 ) {\n\n\t\t\t\ta = i;\n\t\t\t\tb = i + 1;\n\t\t\t\tc = i + 2;\n\n\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\tobject,\n\t\t\t\t\tpositionAttribute,\n\t\t\t\t\tmorphPosition,\n\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\ta, b, c,\n\t\t\t\t\tmodifiedPosition\n\t\t\t\t);\n\n\t\t\t\t_calculateMorphedAttributeData(\n\t\t\t\t\tobject,\n\t\t\t\t\tnormalAttribute,\n\t\t\t\t\tmorphNormal,\n\t\t\t\t\tmorphTargetsRelative,\n\t\t\t\t\ta, b, c,\n\t\t\t\t\tmodifiedNormal\n\t\t\t\t);\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\tconst morphedPositionAttribute = new Float32BufferAttribute( modifiedPosition, 3 );\n\tconst morphedNormalAttribute = new Float32BufferAttribute( modifiedNormal, 3 );\n\n\treturn {\n\n\t\tpositionAttribute: positionAttribute,\n\t\tnormalAttribute: normalAttribute,\n\t\tmorphedPositionAttribute: morphedPositionAttribute,\n\t\tmorphedNormalAttribute: morphedNormalAttribute\n\n\t};\n\n}\n\n/**\n * Merges the {@link BufferGeometry#groups} for the given geometry.\n *\n * @param {BufferGeometry} geometry - The geometry to modify.\n * @return {BufferGeometry} - The updated geometry\n */\nfunction mergeGroups( geometry ) {\n\n\tif ( geometry.groups.length === 0 ) {\n\n\t\tconsole.warn( 'THREE.BufferGeometryUtils.mergeGroups(): No groups are defined. Nothing to merge.' );\n\t\treturn geometry;\n\n\t}\n\n\tlet groups = geometry.groups;\n\n\t// sort groups by material index\n\n\tgroups = groups.sort( ( a, b ) => {\n\n\t\tif ( a.materialIndex !== b.materialIndex ) return a.materialIndex - b.materialIndex;\n\n\t\treturn a.start - b.start;\n\n\t} );\n\n\t// create index for non-indexed geometries\n\n\tif ( geometry.getIndex() === null ) {\n\n\t\tconst positionAttribute = geometry.getAttribute( 'position' );\n\t\tconst indices = [];\n\n\t\tfor ( let i = 0; i < positionAttribute.count; i += 3 ) {\n\n\t\t\tindices.push( i, i + 1, i + 2 );\n\n\t\t}\n\n\t\tgeometry.setIndex( indices );\n\n\t}\n\n\t// sort index\n\n\tconst index = geometry.getIndex();\n\n\tconst newIndices = [];\n\n\tfor ( let i = 0; i < groups.length; i ++ ) {\n\n\t\tconst group = groups[ i ];\n\n\t\tconst groupStart = group.start;\n\t\tconst groupLength = groupStart + group.count;\n\n\t\tfor ( let j = groupStart; j < groupLength; j ++ ) {\n\n\t\t\tnewIndices.push( index.getX( j ) );\n\n\t\t}\n\n\t}\n\n\tgeometry.dispose(); // Required to force buffer recreation\n\tgeometry.setIndex( newIndices );\n\n\t// update groups indices\n\n\tlet start = 0;\n\n\tfor ( let i = 0; i < groups.length; i ++ ) {\n\n\t\tconst group = groups[ i ];\n\n\t\tgroup.start = start;\n\t\tstart += group.count;\n\n\t}\n\n\t// merge groups\n\n\tlet currentGroup = groups[ 0 ];\n\n\tgeometry.groups = [ currentGroup ];\n\n\tfor ( let i = 1; i < groups.length; i ++ ) {\n\n\t\tconst group = groups[ i ];\n\n\t\tif ( currentGroup.materialIndex === group.materialIndex ) {\n\n\t\t\tcurrentGroup.count += group.count;\n\n\t\t} else {\n\n\t\t\tcurrentGroup = group;\n\t\t\tgeometry.groups.push( currentGroup );\n\n\t\t}\n\n\t}\n\n\treturn geometry;\n\n}\n\n/**\n * Modifies the supplied geometry if it is non-indexed, otherwise creates a new,\n * non-indexed geometry. Returns the geometry with smooth normals everywhere except\n * faces that meet at an angle greater than the crease angle.\n *\n * @param {BufferGeometry} geometry - The geometry to modify.\n * @param {number} [creaseAngle=Math.PI/3] - The crease angle in radians.\n * @return {BufferGeometry} - The updated geometry\n */\nfunction toCreasedNormals( geometry, creaseAngle = Math.PI / 3 /* 60 degrees */ ) {\n\n\tconst creaseDot = Math.cos( creaseAngle );\n\tconst hashMultiplier = ( 1 + 1e-10 ) * 1e2;\n\n\t// reusable vectors\n\tconst verts = [ new Vector3(), new Vector3(), new Vector3() ];\n\tconst tempVec1 = new Vector3();\n\tconst tempVec2 = new Vector3();\n\tconst tempNorm = new Vector3();\n\tconst tempNorm2 = new Vector3();\n\n\t// hashes a vector\n\tfunction hashVertex( v ) {\n\n\t\tconst x = ~ ~ ( v.x * hashMultiplier );\n\t\tconst y = ~ ~ ( v.y * hashMultiplier );\n\t\tconst z = ~ ~ ( v.z * hashMultiplier );\n\t\treturn `${x},${y},${z}`;\n\n\t}\n\n\t// BufferGeometry.toNonIndexed() warns if the geometry is non-indexed\n\t// and returns the original geometry\n\tconst resultGeometry = geometry.index ? geometry.toNonIndexed() : geometry;\n\tconst posAttr = resultGeometry.attributes.position;\n\tconst vertexMap = {};\n\n\t// find all the normals shared by commonly located vertices\n\tfor ( let i = 0, l = posAttr.count / 3; i < l; i ++ ) {\n\n\t\tconst i3 = 3 * i;\n\t\tconst a = verts[ 0 ].fromBufferAttribute( posAttr, i3 + 0 );\n\t\tconst b = verts[ 1 ].fromBufferAttribute( posAttr, i3 + 1 );\n\t\tconst c = verts[ 2 ].fromBufferAttribute( posAttr, i3 + 2 );\n\n\t\ttempVec1.subVectors( c, b );\n\t\ttempVec2.subVectors( a, b );\n\n\t\t// add the normal to the map for all vertices\n\t\tconst normal = new Vector3().crossVectors( tempVec1, tempVec2 ).normalize();\n\t\tfor ( let n = 0; n < 3; n ++ ) {\n\n\t\t\tconst vert = verts[ n ];\n\t\t\tconst hash = hashVertex( vert );\n\t\t\tif ( ! ( hash in vertexMap ) ) {\n\n\t\t\t\tvertexMap[ hash ] = [];\n\n\t\t\t}\n\n\t\t\tvertexMap[ hash ].push( normal );\n\n\t\t}\n\n\t}\n\n\t// average normals from all vertices that share a common location if they are within the\n\t// provided crease threshold\n\tconst normalArray = new Float32Array( posAttr.count * 3 );\n\tconst normAttr = new BufferAttribute( normalArray, 3, false );\n\tfor ( let i = 0, l = posAttr.count / 3; i < l; i ++ ) {\n\n\t\t// get the face normal for this vertex\n\t\tconst i3 = 3 * i;\n\t\tconst a = verts[ 0 ].fromBufferAttribute( posAttr, i3 + 0 );\n\t\tconst b = verts[ 1 ].fromBufferAttribute( posAttr, i3 + 1 );\n\t\tconst c = verts[ 2 ].fromBufferAttribute( posAttr, i3 + 2 );\n\n\t\ttempVec1.subVectors( c, b );\n\t\ttempVec2.subVectors( a, b );\n\n\t\ttempNorm.crossVectors( tempVec1, tempVec2 ).normalize();\n\n\t\t// average all normals that meet the threshold and set the normal value\n\t\tfor ( let n = 0; n < 3; n ++ ) {\n\n\t\t\tconst vert = verts[ n ];\n\t\t\tconst hash = hashVertex( vert );\n\t\t\tconst otherNormals = vertexMap[ hash ];\n\t\t\ttempNorm2.set( 0, 0, 0 );\n\n\t\t\tfor ( let k = 0, lk = otherNormals.length; k < lk; k ++ ) {\n\n\t\t\t\tconst otherNorm = otherNormals[ k ];\n\t\t\t\tif ( tempNorm.dot( otherNorm ) > creaseDot ) {\n\n\t\t\t\t\ttempNorm2.add( otherNorm );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\ttempNorm2.normalize();\n\t\t\tnormAttr.setXYZ( i3 + n, tempNorm2.x, tempNorm2.y, tempNorm2.z );\n\n\t\t}\n\n\t}\n\n\tresultGeometry.setAttribute( 'normal', normAttr );\n\treturn resultGeometry;\n\n}\n\nexport {\n\tcomputeMikkTSpaceTangents,\n\tmergeGeometries,\n\tmergeAttributes,\n\tdeepCloneAttribute,\n\tdeinterleaveAttribute,\n\tdeinterleaveGeometry,\n\tinterleaveAttributes,\n\testimateBytesUsed,\n\tmergeVertices,\n\ttoTrianglesDrawMode,\n\tcomputeMorphedAttributes,\n\tmergeGroups,\n\ttoCreasedNormals\n};\n","import {\n\tAnimationClip,\n\tBone,\n\tBox3,\n\tBufferAttribute,\n\tBufferGeometry,\n\tClampToEdgeWrapping,\n\tColor,\n\tColorManagement,\n\tDirectionalLight,\n\tDoubleSide,\n\tFileLoader,\n\tFrontSide,\n\tGroup,\n\tImageBitmapLoader,\n\tInstancedMesh,\n\tInterleavedBuffer,\n\tInterleavedBufferAttribute,\n\tInterpolant,\n\tInterpolateDiscrete,\n\tInterpolateLinear,\n\tLine,\n\tLineBasicMaterial,\n\tLineLoop,\n\tLineSegments,\n\tLinearFilter,\n\tLinearMipmapLinearFilter,\n\tLinearMipmapNearestFilter,\n\tLinearSRGBColorSpace,\n\tLoader,\n\tLoaderUtils,\n\tMaterial,\n\tMathUtils,\n\tMatrix4,\n\tMesh,\n\tMeshBasicMaterial,\n\tMeshPhysicalMaterial,\n\tMeshStandardMaterial,\n\tMirroredRepeatWrapping,\n\tNearestFilter,\n\tNearestMipmapLinearFilter,\n\tNearestMipmapNearestFilter,\n\tNumberKeyframeTrack,\n\tObject3D,\n\tOrthographicCamera,\n\tPerspectiveCamera,\n\tPointLight,\n\tPoints,\n\tPointsMaterial,\n\tPropertyBinding,\n\tQuaternion,\n\tQuaternionKeyframeTrack,\n\tRepeatWrapping,\n\tSkeleton,\n\tSkinnedMesh,\n\tSphere,\n\tSpotLight,\n\tTexture,\n\tTextureLoader,\n\tTriangleFanDrawMode,\n\tTriangleStripDrawMode,\n\tVector2,\n\tVector3,\n\tVectorKeyframeTrack,\n\tSRGBColorSpace,\n\tInstancedBufferAttribute\n} from 'three';\nimport { toTrianglesDrawMode } from '../utils/BufferGeometryUtils.js';\n\n/**\n * A loader for the glTF 2.0 format.\n *\n * [glTF]{@link https://www.khronos.org/gltf/} (GL Transmission Format) is an [open format specification]{@link https://github.com/KhronosGroup/glTF/tree/main/specification/2.0}\n * for efficient delivery and loading of 3D content. Assets may be provided either in JSON (.gltf) or binary (.glb)\n * format. External files store textures (.jpg, .png) and additional binary data (.bin). A glTF asset may deliver\n * one or more scenes, including meshes, materials, textures, skins, skeletons, morph targets, animations, lights,\n * and/or cameras.\n *\n * `GLTFLoader` uses {@link ImageBitmapLoader} whenever possible. Be advised that image bitmaps are not\n * automatically GC-collected when they are no longer referenced, and they require special handling during\n * the disposal process.\n *\n * `GLTFLoader` supports the following glTF 2.0 extensions:\n * - KHR_draco_mesh_compression\n * - KHR_materials_clearcoat\n * - KHR_materials_dispersion\n * - KHR_materials_ior\n * - KHR_materials_specular\n * - KHR_materials_transmission\n * - KHR_materials_iridescence\n * - KHR_materials_unlit\n * - KHR_materials_volume\n * - KHR_mesh_quantization\n * - KHR_lights_punctual\n * - KHR_texture_basisu\n * - KHR_texture_transform\n * - EXT_texture_webp\n * - EXT_meshopt_compression\n * - EXT_mesh_gpu_instancing\n *\n * The following glTF 2.0 extension is supported by an external user plugin:\n * - [KHR_materials_variants]{@link https://github.com/takahirox/three-gltf-extensions}\n * - [MSFT_texture_dds]{@link https://github.com/takahirox/three-gltf-extensions}\n *\n * ```js\n * const loader = new GLTFLoader();\n *\n * // Optional: Provide a DRACOLoader instance to decode compressed mesh data\n * const dracoLoader = new DRACOLoader();\n * dracoLoader.setDecoderPath( '/examples/jsm/libs/draco/' );\n * loader.setDRACOLoader( dracoLoader );\n *\n * const gltf = await loader.loadAsync( 'models/gltf/duck/duck.gltf' );\n * scene.add( gltf.scene );\n * ```\n *\n * @augments Loader\n */\nclass GLTFLoader extends Loader {\n\n\t/**\n\t * Constructs a new glTF loader.\n\t *\n\t * @param {LoadingManager} [manager] - The loading manager.\n\t */\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t\tthis.dracoLoader = null;\n\t\tthis.ktx2Loader = null;\n\t\tthis.meshoptDecoder = null;\n\n\t\tthis.pluginCallbacks = [];\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsClearcoatExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsDispersionExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFTextureBasisUExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFTextureWebPExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFTextureAVIFExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsSheenExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsTransmissionExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsVolumeExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsIorExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsEmissiveStrengthExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsSpecularExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsIridescenceExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsAnisotropyExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsBumpExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFLightsExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMeshoptCompression( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMeshGpuInstancing( parser );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Starts loading from the given URL and passes the loaded glTF asset\n\t * to the `onLoad()` callback.\n\t *\n\t * @param {string} url - The path/URL of the file to be loaded. This can also be a data URI.\n\t * @param {function(GLTFLoader~LoadObject)} onLoad - Executed when the loading process has been finished.\n\t * @param {onProgressCallback} onProgress - Executed while the loading is in progress.\n\t * @param {onErrorCallback} onError - Executed when errors occur.\n\t */\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tconst scope = this;\n\n\t\tlet resourcePath;\n\n\t\tif ( this.resourcePath !== '' ) {\n\n\t\t\tresourcePath = this.resourcePath;\n\n\t\t} else if ( this.path !== '' ) {\n\n\t\t\t// If a base path is set, resources will be relative paths from that plus the relative path of the gltf file\n\t\t\t// Example  path = 'https://my-cnd-server.com/', url = 'assets/models/model.gltf'\n\t\t\t// resourcePath = 'https://my-cnd-server.com/assets/models/'\n\t\t\t// referenced resource 'model.bin' will be loaded from 'https://my-cnd-server.com/assets/models/model.bin'\n\t\t\t// referenced resource '../textures/texture.png' will be loaded from 'https://my-cnd-server.com/assets/textures/texture.png'\n\t\t\tconst relativeUrl = LoaderUtils.extractUrlBase( url );\n\t\t\tresourcePath = LoaderUtils.resolveURL( relativeUrl, this.path );\n\n\t\t} else {\n\n\t\t\tresourcePath = LoaderUtils.extractUrlBase( url );\n\n\t\t}\n\n\t\t// Tells the LoadingManager to track an extra item, which resolves after\n\t\t// the model is fully loaded. This means the count of items loaded will\n\t\t// be incorrect, but ensures manager.onLoad() does not fire early.\n\t\tthis.manager.itemStart( url );\n\n\t\tconst _onError = function ( e ) {\n\n\t\t\tif ( onError ) {\n\n\t\t\t\tonError( e );\n\n\t\t\t} else {\n\n\t\t\t\tconsole.error( e );\n\n\t\t\t}\n\n\t\t\tscope.manager.itemError( url );\n\t\t\tscope.manager.itemEnd( url );\n\n\t\t};\n\n\t\tconst loader = new FileLoader( this.manager );\n\n\t\tloader.setPath( this.path );\n\t\tloader.setResponseType( 'arraybuffer' );\n\t\tloader.setRequestHeader( this.requestHeader );\n\t\tloader.setWithCredentials( this.withCredentials );\n\n\t\tloader.load( url, function ( data ) {\n\n\t\t\ttry {\n\n\t\t\t\tscope.parse( data, resourcePath, function ( gltf ) {\n\n\t\t\t\t\tonLoad( gltf );\n\n\t\t\t\t\tscope.manager.itemEnd( url );\n\n\t\t\t\t}, _onError );\n\n\t\t\t} catch ( e ) {\n\n\t\t\t\t_onError( e );\n\n\t\t\t}\n\n\t\t}, onProgress, _onError );\n\n\t}\n\n\t/**\n\t * Sets the given Draco loader to this loader. Required for decoding assets\n\t * compressed with the `KHR_draco_mesh_compression` extension.\n\t *\n\t * @param {DRACOLoader} dracoLoader - The Draco loader to set.\n\t * @return {GLTFLoader} A reference to this loader.\n\t */\n\tsetDRACOLoader( dracoLoader ) {\n\n\t\tthis.dracoLoader = dracoLoader;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Sets the given KTX2 loader to this loader. Required for loading KTX2\n\t * compressed textures.\n\t *\n\t * @param {KTX2Loader} ktx2Loader - The KTX2 loader to set.\n\t * @return {GLTFLoader} A reference to this loader.\n\t */\n\tsetKTX2Loader( ktx2Loader ) {\n\n\t\tthis.ktx2Loader = ktx2Loader;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Sets the given meshopt decoder. Required for decoding assets\n\t * compressed with the `EXT_meshopt_compression` extension.\n\t *\n\t * @param {Object} meshoptDecoder - The meshopt decoder to set.\n\t * @return {GLTFLoader} A reference to this loader.\n\t */\n\tsetMeshoptDecoder( meshoptDecoder ) {\n\n\t\tthis.meshoptDecoder = meshoptDecoder;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Registers a plugin callback. This API is internally used to implement the various\n\t * glTF extensions but can also used by third-party code to add additional logic\n\t * to the loader.\n\t *\n\t * @param {function(parser:GLTFParser)} callback - The callback function to register.\n\t * @return {GLTFLoader} A reference to this loader.\n\t */\n\tregister( callback ) {\n\n\t\tif ( this.pluginCallbacks.indexOf( callback ) === - 1 ) {\n\n\t\t\tthis.pluginCallbacks.push( callback );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Unregisters a plugin callback.\n\t *\n\t * @param {Function} callback - The callback function to unregister.\n\t * @return {GLTFLoader} A reference to this loader.\n\t */\n\tunregister( callback ) {\n\n\t\tif ( this.pluginCallbacks.indexOf( callback ) !== - 1 ) {\n\n\t\t\tthis.pluginCallbacks.splice( this.pluginCallbacks.indexOf( callback ), 1 );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * Parses the given FBX data and returns the resulting group.\n\t *\n\t * @param {string|ArrayBuffer} data - The raw glTF data.\n\t * @param {string} path - The URL base path.\n\t * @param {function(GLTFLoader~LoadObject)} onLoad - Executed when the loading process has been finished.\n\t * @param {onErrorCallback} onError - Executed when errors occur.\n\t */\n\tparse( data, path, onLoad, onError ) {\n\n\t\tlet json;\n\t\tconst extensions = {};\n\t\tconst plugins = {};\n\t\tconst textDecoder = new TextDecoder();\n\n\t\tif ( typeof data === 'string' ) {\n\n\t\t\tjson = JSON.parse( data );\n\n\t\t} else if ( data instanceof ArrayBuffer ) {\n\n\t\t\tconst magic = textDecoder.decode( new Uint8Array( data, 0, 4 ) );\n\n\t\t\tif ( magic === BINARY_EXTENSION_HEADER_MAGIC ) {\n\n\t\t\t\ttry {\n\n\t\t\t\t\textensions[ EXTENSIONS.KHR_BINARY_GLTF ] = new GLTFBinaryExtension( data );\n\n\t\t\t\t} catch ( error ) {\n\n\t\t\t\t\tif ( onError ) onError( error );\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tjson = JSON.parse( extensions[ EXTENSIONS.KHR_BINARY_GLTF ].content );\n\n\t\t\t} else {\n\n\t\t\t\tjson = JSON.parse( textDecoder.decode( data ) );\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tjson = data;\n\n\t\t}\n\n\t\tif ( json.asset === undefined || json.asset.version[ 0 ] < 2 ) {\n\n\t\t\tif ( onError ) onError( new Error( 'THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.' ) );\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst parser = new GLTFParser( json, {\n\n\t\t\tpath: path || this.resourcePath || '',\n\t\t\tcrossOrigin: this.crossOrigin,\n\t\t\trequestHeader: this.requestHeader,\n\t\t\tmanager: this.manager,\n\t\t\tktx2Loader: this.ktx2Loader,\n\t\t\tmeshoptDecoder: this.meshoptDecoder\n\n\t\t} );\n\n\t\tparser.fileLoader.setRequestHeader( this.requestHeader );\n\n\t\tfor ( let i = 0; i < this.pluginCallbacks.length; i ++ ) {\n\n\t\t\tconst plugin = this.pluginCallbacks[ i ]( parser );\n\n\t\t\tif ( ! plugin.name ) console.error( 'THREE.GLTFLoader: Invalid plugin found: missing name' );\n\n\t\t\tplugins[ plugin.name ] = plugin;\n\n\t\t\t// Workaround to avoid determining as unknown extension\n\t\t\t// in addUnknownExtensionsToUserData().\n\t\t\t// Remove this workaround if we move all the existing\n\t\t\t// extension handlers to plugin system\n\t\t\textensions[ plugin.name ] = true;\n\n\t\t}\n\n\t\tif ( json.extensionsUsed ) {\n\n\t\t\tfor ( let i = 0; i < json.extensionsUsed.length; ++ i ) {\n\n\t\t\t\tconst extensionName = json.extensionsUsed[ i ];\n\t\t\t\tconst extensionsRequired = json.extensionsRequired || [];\n\n\t\t\t\tswitch ( extensionName ) {\n\n\t\t\t\t\tcase EXTENSIONS.KHR_MATERIALS_UNLIT:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFMaterialsUnlitExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFDracoMeshCompressionExtension( json, this.dracoLoader );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_TEXTURE_TRANSFORM:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFTextureTransformExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_MESH_QUANTIZATION:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFMeshQuantizationExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\n\t\t\t\t\t\tif ( extensionsRequired.indexOf( extensionName ) >= 0 && plugins[ extensionName ] === undefined ) {\n\n\t\t\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Unknown extension \"' + extensionName + '\".' );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tparser.setExtensions( extensions );\n\t\tparser.setPlugins( plugins );\n\t\tparser.parse( onLoad, onError );\n\n\t}\n\n\t/**\n\t * Async version of {@link GLTFLoader#parse}.\n\t *\n\t * @async\n\t * @param {string|ArrayBuffer} data - The raw glTF data.\n\t * @param {string} path - The URL base path.\n\t * @return {Promise<GLTFLoader~LoadObject>} A Promise that resolves with the loaded glTF when the parsing has been finished.\n\t */\n\tparseAsync( data, path ) {\n\n\t\tconst scope = this;\n\n\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\tscope.parse( data, path, resolve, reject );\n\n\t\t} );\n\n\t}\n\n}\n\n/* GLTFREGISTRY */\n\nfunction GLTFRegistry() {\n\n\tlet objects = {};\n\n\treturn\t{\n\n\t\tget: function ( key ) {\n\n\t\t\treturn objects[ key ];\n\n\t\t},\n\n\t\tadd: function ( key, object ) {\n\n\t\t\tobjects[ key ] = object;\n\n\t\t},\n\n\t\tremove: function ( key ) {\n\n\t\t\tdelete objects[ key ];\n\n\t\t},\n\n\t\tremoveAll: function () {\n\n\t\t\tobjects = {};\n\n\t\t}\n\n\t};\n\n}\n\n/*********************************/\n/********** EXTENSIONS ***********/\n/*********************************/\n\nconst EXTENSIONS = {\n\tKHR_BINARY_GLTF: 'KHR_binary_glTF',\n\tKHR_DRACO_MESH_COMPRESSION: 'KHR_draco_mesh_compression',\n\tKHR_LIGHTS_PUNCTUAL: 'KHR_lights_punctual',\n\tKHR_MATERIALS_CLEARCOAT: 'KHR_materials_clearcoat',\n\tKHR_MATERIALS_DISPERSION: 'KHR_materials_dispersion',\n\tKHR_MATERIALS_IOR: 'KHR_materials_ior',\n\tKHR_MATERIALS_SHEEN: 'KHR_materials_sheen',\n\tKHR_MATERIALS_SPECULAR: 'KHR_materials_specular',\n\tKHR_MATERIALS_TRANSMISSION: 'KHR_materials_transmission',\n\tKHR_MATERIALS_IRIDESCENCE: 'KHR_materials_iridescence',\n\tKHR_MATERIALS_ANISOTROPY: 'KHR_materials_anisotropy',\n\tKHR_MATERIALS_UNLIT: 'KHR_materials_unlit',\n\tKHR_MATERIALS_VOLUME: 'KHR_materials_volume',\n\tKHR_TEXTURE_BASISU: 'KHR_texture_basisu',\n\tKHR_TEXTURE_TRANSFORM: 'KHR_texture_transform',\n\tKHR_MESH_QUANTIZATION: 'KHR_mesh_quantization',\n\tKHR_MATERIALS_EMISSIVE_STRENGTH: 'KHR_materials_emissive_strength',\n\tEXT_MATERIALS_BUMP: 'EXT_materials_bump',\n\tEXT_TEXTURE_WEBP: 'EXT_texture_webp',\n\tEXT_TEXTURE_AVIF: 'EXT_texture_avif',\n\tEXT_MESHOPT_COMPRESSION: 'EXT_meshopt_compression',\n\tEXT_MESH_GPU_INSTANCING: 'EXT_mesh_gpu_instancing'\n};\n\n/**\n * Punctual Lights Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_lights_punctual\n *\n * @private\n */\nclass GLTFLightsExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_LIGHTS_PUNCTUAL;\n\n\t\t// Object3D instance caches\n\t\tthis.cache = { refs: {}, uses: {} };\n\n\t}\n\n\t_markDefs() {\n\n\t\tconst parser = this.parser;\n\t\tconst nodeDefs = this.parser.json.nodes || [];\n\n\t\tfor ( let nodeIndex = 0, nodeLength = nodeDefs.length; nodeIndex < nodeLength; nodeIndex ++ ) {\n\n\t\t\tconst nodeDef = nodeDefs[ nodeIndex ];\n\n\t\t\tif ( nodeDef.extensions\n\t\t\t\t\t&& nodeDef.extensions[ this.name ]\n\t\t\t\t\t&& nodeDef.extensions[ this.name ].light !== undefined ) {\n\n\t\t\t\tparser._addNodeRef( this.cache, nodeDef.extensions[ this.name ].light );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t_loadLight( lightIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst cacheKey = 'light:' + lightIndex;\n\t\tlet dependency = parser.cache.get( cacheKey );\n\n\t\tif ( dependency ) return dependency;\n\n\t\tconst json = parser.json;\n\t\tconst extensions = ( json.extensions && json.extensions[ this.name ] ) || {};\n\t\tconst lightDefs = extensions.lights || [];\n\t\tconst lightDef = lightDefs[ lightIndex ];\n\t\tlet lightNode;\n\n\t\tconst color = new Color( 0xffffff );\n\n\t\tif ( lightDef.color !== undefined ) color.setRGB( lightDef.color[ 0 ], lightDef.color[ 1 ], lightDef.color[ 2 ], LinearSRGBColorSpace );\n\n\t\tconst range = lightDef.range !== undefined ? lightDef.range : 0;\n\n\t\tswitch ( lightDef.type ) {\n\n\t\t\tcase 'directional':\n\t\t\t\tlightNode = new DirectionalLight( color );\n\t\t\t\tlightNode.target.position.set( 0, 0, - 1 );\n\t\t\t\tlightNode.add( lightNode.target );\n\t\t\t\tbreak;\n\n\t\t\tcase 'point':\n\t\t\t\tlightNode = new PointLight( color );\n\t\t\t\tlightNode.distance = range;\n\t\t\t\tbreak;\n\n\t\t\tcase 'spot':\n\t\t\t\tlightNode = new SpotLight( color );\n\t\t\t\tlightNode.distance = range;\n\t\t\t\t// Handle spotlight properties.\n\t\t\t\tlightDef.spot = lightDef.spot || {};\n\t\t\t\tlightDef.spot.innerConeAngle = lightDef.spot.innerConeAngle !== undefined ? lightDef.spot.innerConeAngle : 0;\n\t\t\t\tlightDef.spot.outerConeAngle = lightDef.spot.outerConeAngle !== undefined ? lightDef.spot.outerConeAngle : Math.PI / 4.0;\n\t\t\t\tlightNode.angle = lightDef.spot.outerConeAngle;\n\t\t\t\tlightNode.penumbra = 1.0 - lightDef.spot.innerConeAngle / lightDef.spot.outerConeAngle;\n\t\t\t\tlightNode.target.position.set( 0, 0, - 1 );\n\t\t\t\tlightNode.add( lightNode.target );\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: Unexpected light type: ' + lightDef.type );\n\n\t\t}\n\n\t\t// Some lights (e.g. spot) default to a position other than the origin. Reset the position\n\t\t// here, because node-level parsing will only override position if explicitly specified.\n\t\tlightNode.position.set( 0, 0, 0 );\n\n\t\tassignExtrasToUserData( lightNode, lightDef );\n\n\t\tif ( lightDef.intensity !== undefined ) lightNode.intensity = lightDef.intensity;\n\n\t\tlightNode.name = parser.createUniqueName( lightDef.name || ( 'light_' + lightIndex ) );\n\n\t\tdependency = Promise.resolve( lightNode );\n\n\t\tparser.cache.add( cacheKey, dependency );\n\n\t\treturn dependency;\n\n\t}\n\n\tgetDependency( type, index ) {\n\n\t\tif ( type !== 'light' ) return;\n\n\t\treturn this._loadLight( index );\n\n\t}\n\n\tcreateNodeAttachment( nodeIndex ) {\n\n\t\tconst self = this;\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\t\tconst lightDef = ( nodeDef.extensions && nodeDef.extensions[ this.name ] ) || {};\n\t\tconst lightIndex = lightDef.light;\n\n\t\tif ( lightIndex === undefined ) return null;\n\n\t\treturn this._loadLight( lightIndex ).then( function ( light ) {\n\n\t\t\treturn parser._getNodeRef( self.cache, lightIndex, light );\n\n\t\t} );\n\n\t}\n\n}\n\n/**\n * Unlit Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_unlit\n *\n * @private\n */\nclass GLTFMaterialsUnlitExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_UNLIT;\n\n\t}\n\n\tgetMaterialType() {\n\n\t\treturn MeshBasicMaterial;\n\n\t}\n\n\textendParams( materialParams, materialDef, parser ) {\n\n\t\tconst pending = [];\n\n\t\tmaterialParams.color = new Color( 1.0, 1.0, 1.0 );\n\t\tmaterialParams.opacity = 1.0;\n\n\t\tconst metallicRoughness = materialDef.pbrMetallicRoughness;\n\n\t\tif ( metallicRoughness ) {\n\n\t\t\tif ( Array.isArray( metallicRoughness.baseColorFactor ) ) {\n\n\t\t\t\tconst array = metallicRoughness.baseColorFactor;\n\n\t\t\t\tmaterialParams.color.setRGB( array[ 0 ], array[ 1 ], array[ 2 ], LinearSRGBColorSpace );\n\t\t\t\tmaterialParams.opacity = array[ 3 ];\n\n\t\t\t}\n\n\t\t\tif ( metallicRoughness.baseColorTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'map', metallicRoughness.baseColorTexture, SRGBColorSpace ) );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials Emissive Strength Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/blob/5768b3ce0ef32bc39cdf1bef10b948586635ead3/extensions/2.0/Khronos/KHR_materials_emissive_strength/README.md\n *\n * @private\n */\nclass GLTFMaterialsEmissiveStrengthExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst emissiveStrength = materialDef.extensions[ this.name ].emissiveStrength;\n\n\t\tif ( emissiveStrength !== undefined ) {\n\n\t\t\tmaterialParams.emissiveIntensity = emissiveStrength;\n\n\t\t}\n\n\t\treturn Promise.resolve();\n\n\t}\n\n}\n\n/**\n * Clearcoat Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_clearcoat\n *\n * @private\n */\nclass GLTFMaterialsClearcoatExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_CLEARCOAT;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.clearcoatFactor !== undefined ) {\n\n\t\t\tmaterialParams.clearcoat = extension.clearcoatFactor;\n\n\t\t}\n\n\t\tif ( extension.clearcoatTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatMap', extension.clearcoatTexture ) );\n\n\t\t}\n\n\t\tif ( extension.clearcoatRoughnessFactor !== undefined ) {\n\n\t\t\tmaterialParams.clearcoatRoughness = extension.clearcoatRoughnessFactor;\n\n\t\t}\n\n\t\tif ( extension.clearcoatRoughnessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatRoughnessMap', extension.clearcoatRoughnessTexture ) );\n\n\t\t}\n\n\t\tif ( extension.clearcoatNormalTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatNormalMap', extension.clearcoatNormalTexture ) );\n\n\t\t\tif ( extension.clearcoatNormalTexture.scale !== undefined ) {\n\n\t\t\t\tconst scale = extension.clearcoatNormalTexture.scale;\n\n\t\t\t\tmaterialParams.clearcoatNormalScale = new Vector2( scale, scale );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials dispersion Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Khronos/KHR_materials_dispersion\n *\n * @private\n */\nclass GLTFMaterialsDispersionExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_DISPERSION;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.dispersion = extension.dispersion !== undefined ? extension.dispersion : 0;\n\n\t\treturn Promise.resolve();\n\n\t}\n\n}\n\n/**\n * Iridescence Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_iridescence\n *\n * @private\n */\nclass GLTFMaterialsIridescenceExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_IRIDESCENCE;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.iridescenceFactor !== undefined ) {\n\n\t\t\tmaterialParams.iridescence = extension.iridescenceFactor;\n\n\t\t}\n\n\t\tif ( extension.iridescenceTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'iridescenceMap', extension.iridescenceTexture ) );\n\n\t\t}\n\n\t\tif ( extension.iridescenceIor !== undefined ) {\n\n\t\t\tmaterialParams.iridescenceIOR = extension.iridescenceIor;\n\n\t\t}\n\n\t\tif ( materialParams.iridescenceThicknessRange === undefined ) {\n\n\t\t\tmaterialParams.iridescenceThicknessRange = [ 100, 400 ];\n\n\t\t}\n\n\t\tif ( extension.iridescenceThicknessMinimum !== undefined ) {\n\n\t\t\tmaterialParams.iridescenceThicknessRange[ 0 ] = extension.iridescenceThicknessMinimum;\n\n\t\t}\n\n\t\tif ( extension.iridescenceThicknessMaximum !== undefined ) {\n\n\t\t\tmaterialParams.iridescenceThicknessRange[ 1 ] = extension.iridescenceThicknessMaximum;\n\n\t\t}\n\n\t\tif ( extension.iridescenceThicknessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'iridescenceThicknessMap', extension.iridescenceThicknessTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Sheen Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Khronos/KHR_materials_sheen\n *\n * @private\n */\nclass GLTFMaterialsSheenExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_SHEEN;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tmaterialParams.sheenColor = new Color( 0, 0, 0 );\n\t\tmaterialParams.sheenRoughness = 0;\n\t\tmaterialParams.sheen = 1;\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.sheenColorFactor !== undefined ) {\n\n\t\t\tconst colorFactor = extension.sheenColorFactor;\n\t\t\tmaterialParams.sheenColor.setRGB( colorFactor[ 0 ], colorFactor[ 1 ], colorFactor[ 2 ], LinearSRGBColorSpace );\n\n\t\t}\n\n\t\tif ( extension.sheenRoughnessFactor !== undefined ) {\n\n\t\t\tmaterialParams.sheenRoughness = extension.sheenRoughnessFactor;\n\n\t\t}\n\n\t\tif ( extension.sheenColorTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'sheenColorMap', extension.sheenColorTexture, SRGBColorSpace ) );\n\n\t\t}\n\n\t\tif ( extension.sheenRoughnessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'sheenRoughnessMap', extension.sheenRoughnessTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Transmission Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_transmission\n * Draft: https://github.com/KhronosGroup/glTF/pull/1698\n *\n * @private\n */\nclass GLTFMaterialsTransmissionExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_TRANSMISSION;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.transmissionFactor !== undefined ) {\n\n\t\t\tmaterialParams.transmission = extension.transmissionFactor;\n\n\t\t}\n\n\t\tif ( extension.transmissionTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'transmissionMap', extension.transmissionTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials Volume Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_volume\n *\n * @private\n */\nclass GLTFMaterialsVolumeExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_VOLUME;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.thickness = extension.thicknessFactor !== undefined ? extension.thicknessFactor : 0;\n\n\t\tif ( extension.thicknessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'thicknessMap', extension.thicknessTexture ) );\n\n\t\t}\n\n\t\tmaterialParams.attenuationDistance = extension.attenuationDistance || Infinity;\n\n\t\tconst colorArray = extension.attenuationColor || [ 1, 1, 1 ];\n\t\tmaterialParams.attenuationColor = new Color().setRGB( colorArray[ 0 ], colorArray[ 1 ], colorArray[ 2 ], LinearSRGBColorSpace );\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials ior Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_ior\n *\n * @private\n */\nclass GLTFMaterialsIorExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_IOR;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.ior = extension.ior !== undefined ? extension.ior : 1.5;\n\n\t\treturn Promise.resolve();\n\n\t}\n\n}\n\n/**\n * Materials specular Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_specular\n *\n * @private\n */\nclass GLTFMaterialsSpecularExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_SPECULAR;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.specularIntensity = extension.specularFactor !== undefined ? extension.specularFactor : 1.0;\n\n\t\tif ( extension.specularTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'specularIntensityMap', extension.specularTexture ) );\n\n\t\t}\n\n\t\tconst colorArray = extension.specularColorFactor || [ 1, 1, 1 ];\n\t\tmaterialParams.specularColor = new Color().setRGB( colorArray[ 0 ], colorArray[ 1 ], colorArray[ 2 ], LinearSRGBColorSpace );\n\n\t\tif ( extension.specularColorTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'specularColorMap', extension.specularColorTexture, SRGBColorSpace ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n\n/**\n * Materials bump Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/EXT_materials_bump\n *\n * @private\n */\nclass GLTFMaterialsBumpExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.EXT_MATERIALS_BUMP;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.bumpScale = extension.bumpFactor !== undefined ? extension.bumpFactor : 1.0;\n\n\t\tif ( extension.bumpTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'bumpMap', extension.bumpTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials anisotropy Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_anisotropy\n *\n * @private\n */\nclass GLTFMaterialsAnisotropyExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_ANISOTROPY;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.anisotropyStrength !== undefined ) {\n\n\t\t\tmaterialParams.anisotropy = extension.anisotropyStrength;\n\n\t\t}\n\n\t\tif ( extension.anisotropyRotation !== undefined ) {\n\n\t\t\tmaterialParams.anisotropyRotation = extension.anisotropyRotation;\n\n\t\t}\n\n\t\tif ( extension.anisotropyTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'anisotropyMap', extension.anisotropyTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * BasisU Texture Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_texture_basisu\n *\n * @private\n */\nclass GLTFTextureBasisUExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_TEXTURE_BASISU;\n\n\t}\n\n\tloadTexture( textureIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\n\t\tif ( ! textureDef.extensions || ! textureDef.extensions[ this.name ] ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst extension = textureDef.extensions[ this.name ];\n\t\tconst loader = parser.options.ktx2Loader;\n\n\t\tif ( ! loader ) {\n\n\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( this.name ) >= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures' );\n\n\t\t\t} else {\n\n\t\t\t\t// Assumes that the extension is optional and that a fallback texture is present\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn parser.loadTextureImage( textureIndex, extension.source, loader );\n\n\t}\n\n}\n\n/**\n * WebP Texture Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_texture_webp\n *\n * @private\n */\nclass GLTFTextureWebPExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.EXT_TEXTURE_WEBP;\n\t\tthis.isSupported = null;\n\n\t}\n\n\tloadTexture( textureIndex ) {\n\n\t\tconst name = this.name;\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\n\t\tif ( ! textureDef.extensions || ! textureDef.extensions[ name ] ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst extension = textureDef.extensions[ name ];\n\t\tconst source = json.images[ extension.source ];\n\n\t\tlet loader = parser.textureLoader;\n\t\tif ( source.uri ) {\n\n\t\t\tconst handler = parser.options.manager.getHandler( source.uri );\n\t\t\tif ( handler !== null ) loader = handler;\n\n\t\t}\n\n\t\treturn this.detectSupport().then( function ( isSupported ) {\n\n\t\t\tif ( isSupported ) return parser.loadTextureImage( textureIndex, extension.source, loader );\n\n\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( name ) >= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: WebP required by asset but unsupported.' );\n\n\t\t\t}\n\n\t\t\t// Fall back to PNG or JPEG.\n\t\t\treturn parser.loadTexture( textureIndex );\n\n\t\t} );\n\n\t}\n\n\tdetectSupport() {\n\n\t\tif ( ! this.isSupported ) {\n\n\t\t\tthis.isSupported = new Promise( function ( resolve ) {\n\n\t\t\t\tconst image = new Image();\n\n\t\t\t\t// Lossy test image. Support for lossy images doesn't guarantee support for all\n\t\t\t\t// WebP images, unfortunately.\n\t\t\t\timage.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';\n\n\t\t\t\timage.onload = image.onerror = function () {\n\n\t\t\t\t\tresolve( image.height === 1 );\n\n\t\t\t\t};\n\n\t\t\t} );\n\n\t\t}\n\n\t\treturn this.isSupported;\n\n\t}\n\n}\n\n/**\n * AVIF Texture Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_texture_avif\n *\n * @private\n */\nclass GLTFTextureAVIFExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.EXT_TEXTURE_AVIF;\n\t\tthis.isSupported = null;\n\n\t}\n\n\tloadTexture( textureIndex ) {\n\n\t\tconst name = this.name;\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\n\t\tif ( ! textureDef.extensions || ! textureDef.extensions[ name ] ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst extension = textureDef.extensions[ name ];\n\t\tconst source = json.images[ extension.source ];\n\n\t\tlet loader = parser.textureLoader;\n\t\tif ( source.uri ) {\n\n\t\t\tconst handler = parser.options.manager.getHandler( source.uri );\n\t\t\tif ( handler !== null ) loader = handler;\n\n\t\t}\n\n\t\treturn this.detectSupport().then( function ( isSupported ) {\n\n\t\t\tif ( isSupported ) return parser.loadTextureImage( textureIndex, extension.source, loader );\n\n\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( name ) >= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: AVIF required by asset but unsupported.' );\n\n\t\t\t}\n\n\t\t\t// Fall back to PNG or JPEG.\n\t\t\treturn parser.loadTexture( textureIndex );\n\n\t\t} );\n\n\t}\n\n\tdetectSupport() {\n\n\t\tif ( ! this.isSupported ) {\n\n\t\t\tthis.isSupported = new Promise( function ( resolve ) {\n\n\t\t\t\tconst image = new Image();\n\n\t\t\t\t// Lossy test image.\n\t\t\t\timage.src = 'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=';\n\t\t\t\timage.onload = image.onerror = function () {\n\n\t\t\t\t\tresolve( image.height === 1 );\n\n\t\t\t\t};\n\n\t\t\t} );\n\n\t\t}\n\n\t\treturn this.isSupported;\n\n\t}\n\n}\n\n/**\n * meshopt BufferView Compression Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_meshopt_compression\n *\n * @private\n */\nclass GLTFMeshoptCompression {\n\n\tconstructor( parser ) {\n\n\t\tthis.name = EXTENSIONS.EXT_MESHOPT_COMPRESSION;\n\t\tthis.parser = parser;\n\n\t}\n\n\tloadBufferView( index ) {\n\n\t\tconst json = this.parser.json;\n\t\tconst bufferView = json.bufferViews[ index ];\n\n\t\tif ( bufferView.extensions && bufferView.extensions[ this.name ] ) {\n\n\t\t\tconst extensionDef = bufferView.extensions[ this.name ];\n\n\t\t\tconst buffer = this.parser.getDependency( 'buffer', extensionDef.buffer );\n\t\t\tconst decoder = this.parser.options.meshoptDecoder;\n\n\t\t\tif ( ! decoder || ! decoder.supported ) {\n\n\t\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( this.name ) >= 0 ) {\n\n\t\t\t\t\tthrow new Error( 'THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files' );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// Assumes that the extension is optional and that fallback buffer data is present\n\t\t\t\t\treturn null;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn buffer.then( function ( res ) {\n\n\t\t\t\tconst byteOffset = extensionDef.byteOffset || 0;\n\t\t\t\tconst byteLength = extensionDef.byteLength || 0;\n\n\t\t\t\tconst count = extensionDef.count;\n\t\t\t\tconst stride = extensionDef.byteStride;\n\n\t\t\t\tconst source = new Uint8Array( res, byteOffset, byteLength );\n\n\t\t\t\tif ( decoder.decodeGltfBufferAsync ) {\n\n\t\t\t\t\treturn decoder.decodeGltfBufferAsync( count, stride, source, extensionDef.mode, extensionDef.filter ).then( function ( res ) {\n\n\t\t\t\t\t\treturn res.buffer;\n\n\t\t\t\t\t} );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// Support for MeshoptDecoder 0.18 or earlier, without decodeGltfBufferAsync\n\t\t\t\t\treturn decoder.ready.then( function () {\n\n\t\t\t\t\t\tconst result = new ArrayBuffer( count * stride );\n\t\t\t\t\t\tdecoder.decodeGltfBuffer( new Uint8Array( result ), count, stride, source, extensionDef.mode, extensionDef.filter );\n\t\t\t\t\t\treturn result;\n\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * GPU Instancing Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_mesh_gpu_instancing\n *\n * @private\n */\nclass GLTFMeshGpuInstancing {\n\n\tconstructor( parser ) {\n\n\t\tthis.name = EXTENSIONS.EXT_MESH_GPU_INSTANCING;\n\t\tthis.parser = parser;\n\n\t}\n\n\tcreateNodeMesh( nodeIndex ) {\n\n\t\tconst json = this.parser.json;\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\tif ( ! nodeDef.extensions || ! nodeDef.extensions[ this.name ] ||\n\t\t\tnodeDef.mesh === undefined ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst meshDef = json.meshes[ nodeDef.mesh ];\n\n\t\t// No Points or Lines + Instancing support yet\n\n\t\tfor ( const primitive of meshDef.primitives ) {\n\n\t\t\tif ( primitive.mode !== WEBGL_CONSTANTS.TRIANGLES &&\n\t\t\t\t primitive.mode !== WEBGL_CONSTANTS.TRIANGLE_STRIP &&\n\t\t\t\t primitive.mode !== WEBGL_CONSTANTS.TRIANGLE_FAN &&\n\t\t\t\t primitive.mode !== undefined ) {\n\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst extensionDef = nodeDef.extensions[ this.name ];\n\t\tconst attributesDef = extensionDef.attributes;\n\n\t\t// @TODO: Can we support InstancedMesh + SkinnedMesh?\n\n\t\tconst pending = [];\n\t\tconst attributes = {};\n\n\t\tfor ( const key in attributesDef ) {\n\n\t\t\tpending.push( this.parser.getDependency( 'accessor', attributesDef[ key ] ).then( accessor => {\n\n\t\t\t\tattributes[ key ] = accessor;\n\t\t\t\treturn attributes[ key ];\n\n\t\t\t} ) );\n\n\t\t}\n\n\t\tif ( pending.length < 1 ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tpending.push( this.parser.createNodeMesh( nodeIndex ) );\n\n\t\treturn Promise.all( pending ).then( results => {\n\n\t\t\tconst nodeObject = results.pop();\n\t\t\tconst meshes = nodeObject.isGroup ? nodeObject.children : [ nodeObject ];\n\t\t\tconst count = results[ 0 ].count; // All attribute counts should be same\n\t\t\tconst instancedMeshes = [];\n\n\t\t\tfor ( const mesh of meshes ) {\n\n\t\t\t\t// Temporal variables\n\t\t\t\tconst m = new Matrix4();\n\t\t\t\tconst p = new Vector3();\n\t\t\t\tconst q = new Quaternion();\n\t\t\t\tconst s = new Vector3( 1, 1, 1 );\n\n\t\t\t\tconst instancedMesh = new InstancedMesh( mesh.geometry, mesh.material, count );\n\n\t\t\t\tfor ( let i = 0; i < count; i ++ ) {\n\n\t\t\t\t\tif ( attributes.TRANSLATION ) {\n\n\t\t\t\t\t\tp.fromBufferAttribute( attributes.TRANSLATION, i );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( attributes.ROTATION ) {\n\n\t\t\t\t\t\tq.fromBufferAttribute( attributes.ROTATION, i );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( attributes.SCALE ) {\n\n\t\t\t\t\t\ts.fromBufferAttribute( attributes.SCALE, i );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tinstancedMesh.setMatrixAt( i, m.compose( p, q, s ) );\n\n\t\t\t\t}\n\n\t\t\t\t// Add instance attributes to the geometry, excluding TRS.\n\t\t\t\tfor ( const attributeName in attributes ) {\n\n\t\t\t\t\tif ( attributeName === '_COLOR_0' ) {\n\n\t\t\t\t\t\tconst attr = attributes[ attributeName ];\n\t\t\t\t\t\tinstancedMesh.instanceColor = new InstancedBufferAttribute( attr.array, attr.itemSize, attr.normalized );\n\n\t\t\t\t\t} else if ( attributeName !== 'TRANSLATION' &&\n\t\t\t\t\t\t attributeName !== 'ROTATION' &&\n\t\t\t\t\t\t attributeName !== 'SCALE' ) {\n\n\t\t\t\t\t\tmesh.geometry.setAttribute( attributeName, attributes[ attributeName ] );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// Just in case\n\t\t\t\tObject3D.prototype.copy.call( instancedMesh, mesh );\n\n\t\t\t\tthis.parser.assignFinalMaterial( instancedMesh );\n\n\t\t\t\tinstancedMeshes.push( instancedMesh );\n\n\t\t\t}\n\n\t\t\tif ( nodeObject.isGroup ) {\n\n\t\t\t\tnodeObject.clear();\n\n\t\t\t\tnodeObject.add( ... instancedMeshes );\n\n\t\t\t\treturn nodeObject;\n\n\t\t\t}\n\n\t\t\treturn instancedMeshes[ 0 ];\n\n\t\t} );\n\n\t}\n\n}\n\n/* BINARY EXTENSION */\nconst BINARY_EXTENSION_HEADER_MAGIC = 'glTF';\nconst BINARY_EXTENSION_HEADER_LENGTH = 12;\nconst BINARY_EXTENSION_CHUNK_TYPES = { JSON: 0x4E4F534A, BIN: 0x004E4942 };\n\nclass GLTFBinaryExtension {\n\n\tconstructor( data ) {\n\n\t\tthis.name = EXTENSIONS.KHR_BINARY_GLTF;\n\t\tthis.content = null;\n\t\tthis.body = null;\n\n\t\tconst headerView = new DataView( data, 0, BINARY_EXTENSION_HEADER_LENGTH );\n\t\tconst textDecoder = new TextDecoder();\n\n\t\tthis.header = {\n\t\t\tmagic: textDecoder.decode( new Uint8Array( data.slice( 0, 4 ) ) ),\n\t\t\tversion: headerView.getUint32( 4, true ),\n\t\t\tlength: headerView.getUint32( 8, true )\n\t\t};\n\n\t\tif ( this.header.magic !== BINARY_EXTENSION_HEADER_MAGIC ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Unsupported glTF-Binary header.' );\n\n\t\t} else if ( this.header.version < 2.0 ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Legacy binary file detected.' );\n\n\t\t}\n\n\t\tconst chunkContentsLength = this.header.length - BINARY_EXTENSION_HEADER_LENGTH;\n\t\tconst chunkView = new DataView( data, BINARY_EXTENSION_HEADER_LENGTH );\n\t\tlet chunkIndex = 0;\n\n\t\twhile ( chunkIndex < chunkContentsLength ) {\n\n\t\t\tconst chunkLength = chunkView.getUint32( chunkIndex, true );\n\t\t\tchunkIndex += 4;\n\n\t\t\tconst chunkType = chunkView.getUint32( chunkIndex, true );\n\t\t\tchunkIndex += 4;\n\n\t\t\tif ( chunkType === BINARY_EXTENSION_CHUNK_TYPES.JSON ) {\n\n\t\t\t\tconst contentArray = new Uint8Array( data, BINARY_EXTENSION_HEADER_LENGTH + chunkIndex, chunkLength );\n\t\t\t\tthis.content = textDecoder.decode( contentArray );\n\n\t\t\t} else if ( chunkType === BINARY_EXTENSION_CHUNK_TYPES.BIN ) {\n\n\t\t\t\tconst byteOffset = BINARY_EXTENSION_HEADER_LENGTH + chunkIndex;\n\t\t\t\tthis.body = data.slice( byteOffset, byteOffset + chunkLength );\n\n\t\t\t}\n\n\t\t\t// Clients must ignore chunks with unknown types.\n\n\t\t\tchunkIndex += chunkLength;\n\n\t\t}\n\n\t\tif ( this.content === null ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: JSON content not found.' );\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * DRACO Mesh Compression Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_draco_mesh_compression\n *\n * @private\n */\nclass GLTFDracoMeshCompressionExtension {\n\n\tconstructor( json, dracoLoader ) {\n\n\t\tif ( ! dracoLoader ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: No DRACOLoader instance provided.' );\n\n\t\t}\n\n\t\tthis.name = EXTENSIONS.KHR_DRACO_MESH_COMPRESSION;\n\t\tthis.json = json;\n\t\tthis.dracoLoader = dracoLoader;\n\t\tthis.dracoLoader.preload();\n\n\t}\n\n\tdecodePrimitive( primitive, parser ) {\n\n\t\tconst json = this.json;\n\t\tconst dracoLoader = this.dracoLoader;\n\t\tconst bufferViewIndex = primitive.extensions[ this.name ].bufferView;\n\t\tconst gltfAttributeMap = primitive.extensions[ this.name ].attributes;\n\t\tconst threeAttributeMap = {};\n\t\tconst attributeNormalizedMap = {};\n\t\tconst attributeTypeMap = {};\n\n\t\tfor ( const attributeName in gltfAttributeMap ) {\n\n\t\t\tconst threeAttributeName = ATTRIBUTES[ attributeName ] || attributeName.toLowerCase();\n\n\t\t\tthreeAttributeMap[ threeAttributeName ] = gltfAttributeMap[ attributeName ];\n\n\t\t}\n\n\t\tfor ( const attributeName in primitive.attributes ) {\n\n\t\t\tconst threeAttributeName = ATTRIBUTES[ attributeName ] || attributeName.toLowerCase();\n\n\t\t\tif ( gltfAttributeMap[ attributeName ] !== undefined ) {\n\n\t\t\t\tconst accessorDef = json.accessors[ primitive.attributes[ attributeName ] ];\n\t\t\t\tconst componentType = WEBGL_COMPONENT_TYPES[ accessorDef.componentType ];\n\n\t\t\t\tattributeTypeMap[ threeAttributeName ] = componentType.name;\n\t\t\t\tattributeNormalizedMap[ threeAttributeName ] = accessorDef.normalized === true;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn parser.getDependency( 'bufferView', bufferViewIndex ).then( function ( bufferView ) {\n\n\t\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\t\tdracoLoader.decodeDracoFile( bufferView, function ( geometry ) {\n\n\t\t\t\t\tfor ( const attributeName in geometry.attributes ) {\n\n\t\t\t\t\t\tconst attribute = geometry.attributes[ attributeName ];\n\t\t\t\t\t\tconst normalized = attributeNormalizedMap[ attributeName ];\n\n\t\t\t\t\t\tif ( normalized !== undefined ) attribute.normalized = normalized;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve( geometry );\n\n\t\t\t\t}, threeAttributeMap, attributeTypeMap, LinearSRGBColorSpace, reject );\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n}\n\n/**\n * Texture Transform Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_texture_transform\n *\n * @private\n */\nclass GLTFTextureTransformExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_TEXTURE_TRANSFORM;\n\n\t}\n\n\textendTexture( texture, transform ) {\n\n\t\tif ( ( transform.texCoord === undefined || transform.texCoord === texture.channel )\n\t\t\t&& transform.offset === undefined\n\t\t\t&& transform.rotation === undefined\n\t\t\t&& transform.scale === undefined ) {\n\n\t\t\t// See https://github.com/mrdoob/three.js/issues/21819.\n\t\t\treturn texture;\n\n\t\t}\n\n\t\ttexture = texture.clone();\n\n\t\tif ( transform.texCoord !== undefined ) {\n\n\t\t\ttexture.channel = transform.texCoord;\n\n\t\t}\n\n\t\tif ( transform.offset !== undefined ) {\n\n\t\t\ttexture.offset.fromArray( transform.offset );\n\n\t\t}\n\n\t\tif ( transform.rotation !== undefined ) {\n\n\t\t\ttexture.rotation = transform.rotation;\n\n\t\t}\n\n\t\tif ( transform.scale !== undefined ) {\n\n\t\t\ttexture.repeat.fromArray( transform.scale );\n\n\t\t}\n\n\t\ttexture.needsUpdate = true;\n\n\t\treturn texture;\n\n\t}\n\n}\n\n/**\n * Mesh Quantization Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_mesh_quantization\n *\n * @private\n */\nclass GLTFMeshQuantizationExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_MESH_QUANTIZATION;\n\n\t}\n\n}\n\n/*********************************/\n/********** INTERPOLATION ********/\n/*********************************/\n\n// Spline Interpolation\n// Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#appendix-c-spline-interpolation\nclass GLTFCubicSplineInterpolant extends Interpolant {\n\n\tconstructor( parameterPositions, sampleValues, sampleSize, resultBuffer ) {\n\n\t\tsuper( parameterPositions, sampleValues, sampleSize, resultBuffer );\n\n\t}\n\n\tcopySampleValue_( index ) {\n\n\t\t// Copies a sample value to the result buffer. See description of glTF\n\t\t// CUBICSPLINE values layout in interpolate_() function below.\n\n\t\tconst result = this.resultBuffer,\n\t\t\tvalues = this.sampleValues,\n\t\t\tvalueSize = this.valueSize,\n\t\t\toffset = index * valueSize * 3 + valueSize;\n\n\t\tfor ( let i = 0; i !== valueSize; i ++ ) {\n\n\t\t\tresult[ i ] = values[ offset + i ];\n\n\t\t}\n\n\t\treturn result;\n\n\t}\n\n\tinterpolate_( i1, t0, t, t1 ) {\n\n\t\tconst result = this.resultBuffer;\n\t\tconst values = this.sampleValues;\n\t\tconst stride = this.valueSize;\n\n\t\tconst stride2 = stride * 2;\n\t\tconst stride3 = stride * 3;\n\n\t\tconst td = t1 - t0;\n\n\t\tconst p = ( t - t0 ) / td;\n\t\tconst pp = p * p;\n\t\tconst ppp = pp * p;\n\n\t\tconst offset1 = i1 * stride3;\n\t\tconst offset0 = offset1 - stride3;\n\n\t\tconst s2 = - 2 * ppp + 3 * pp;\n\t\tconst s3 = ppp - pp;\n\t\tconst s0 = 1 - s2;\n\t\tconst s1 = s3 - pp + p;\n\n\t\t// Layout of keyframe output values for CUBICSPLINE animations:\n\t\t//   [ inTangent_1, splineVertex_1, outTangent_1, inTangent_2, splineVertex_2, ... ]\n\t\tfor ( let i = 0; i !== stride; i ++ ) {\n\n\t\t\tconst p0 = values[ offset0 + i + stride ]; // splineVertex_k\n\t\t\tconst m0 = values[ offset0 + i + stride2 ] * td; // outTangent_k * (t_k+1 - t_k)\n\t\t\tconst p1 = values[ offset1 + i + stride ]; // splineVertex_k+1\n\t\t\tconst m1 = values[ offset1 + i ] * td; // inTangent_k+1 * (t_k+1 - t_k)\n\n\t\t\tresult[ i ] = s0 * p0 + s1 * m0 + s2 * p1 + s3 * m1;\n\n\t\t}\n\n\t\treturn result;\n\n\t}\n\n}\n\nconst _q = new Quaternion();\n\nclass GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant {\n\n\tinterpolate_( i1, t0, t, t1 ) {\n\n\t\tconst result = super.interpolate_( i1, t0, t, t1 );\n\n\t\t_q.fromArray( result ).normalize().toArray( result );\n\n\t\treturn result;\n\n\t}\n\n}\n\n\n/*********************************/\n/********** INTERNALS ************/\n/*********************************/\n\n/* CONSTANTS */\n\nconst WEBGL_CONSTANTS = {\n\tFLOAT: 5126,\n\t//FLOAT_MAT2: 35674,\n\tFLOAT_MAT3: 35675,\n\tFLOAT_MAT4: 35676,\n\tFLOAT_VEC2: 35664,\n\tFLOAT_VEC3: 35665,\n\tFLOAT_VEC4: 35666,\n\tLINEAR: 9729,\n\tREPEAT: 10497,\n\tSAMPLER_2D: 35678,\n\tPOINTS: 0,\n\tLINES: 1,\n\tLINE_LOOP: 2,\n\tLINE_STRIP: 3,\n\tTRIANGLES: 4,\n\tTRIANGLE_STRIP: 5,\n\tTRIANGLE_FAN: 6,\n\tUNSIGNED_BYTE: 5121,\n\tUNSIGNED_SHORT: 5123\n};\n\nconst WEBGL_COMPONENT_TYPES = {\n\t5120: Int8Array,\n\t5121: Uint8Array,\n\t5122: Int16Array,\n\t5123: Uint16Array,\n\t5125: Uint32Array,\n\t5126: Float32Array\n};\n\nconst WEBGL_FILTERS = {\n\t9728: NearestFilter,\n\t9729: LinearFilter,\n\t9984: NearestMipmapNearestFilter,\n\t9985: LinearMipmapNearestFilter,\n\t9986: NearestMipmapLinearFilter,\n\t9987: LinearMipmapLinearFilter\n};\n\nconst WEBGL_WRAPPINGS = {\n\t33071: ClampToEdgeWrapping,\n\t33648: MirroredRepeatWrapping,\n\t10497: RepeatWrapping\n};\n\nconst WEBGL_TYPE_SIZES = {\n\t'SCALAR': 1,\n\t'VEC2': 2,\n\t'VEC3': 3,\n\t'VEC4': 4,\n\t'MAT2': 4,\n\t'MAT3': 9,\n\t'MAT4': 16\n};\n\nconst ATTRIBUTES = {\n\tPOSITION: 'position',\n\tNORMAL: 'normal',\n\tTANGENT: 'tangent',\n\tTEXCOORD_0: 'uv',\n\tTEXCOORD_1: 'uv1',\n\tTEXCOORD_2: 'uv2',\n\tTEXCOORD_3: 'uv3',\n\tCOLOR_0: 'color',\n\tWEIGHTS_0: 'skinWeight',\n\tJOINTS_0: 'skinIndex',\n};\n\nconst PATH_PROPERTIES = {\n\tscale: 'scale',\n\ttranslation: 'position',\n\trotation: 'quaternion',\n\tweights: 'morphTargetInfluences'\n};\n\nconst INTERPOLATION = {\n\tCUBICSPLINE: undefined, // We use a custom interpolant (GLTFCubicSplineInterpolation) for CUBICSPLINE tracks. Each\n\t\t                        // keyframe track will be initialized with a default interpolation type, then modified.\n\tLINEAR: InterpolateLinear,\n\tSTEP: InterpolateDiscrete\n};\n\nconst ALPHA_MODES = {\n\tOPAQUE: 'OPAQUE',\n\tMASK: 'MASK',\n\tBLEND: 'BLEND'\n};\n\n/**\n * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#default-material\n *\n * @private\n * @param {Object<string, Material>} cache\n * @return {Material}\n */\nfunction createDefaultMaterial( cache ) {\n\n\tif ( cache[ 'DefaultMaterial' ] === undefined ) {\n\n\t\tcache[ 'DefaultMaterial' ] = new MeshStandardMaterial( {\n\t\t\tcolor: 0xFFFFFF,\n\t\t\temissive: 0x000000,\n\t\t\tmetalness: 1,\n\t\t\troughness: 1,\n\t\t\ttransparent: false,\n\t\t\tdepthTest: true,\n\t\t\tside: FrontSide\n\t\t} );\n\n\t}\n\n\treturn cache[ 'DefaultMaterial' ];\n\n}\n\nfunction addUnknownExtensionsToUserData( knownExtensions, object, objectDef ) {\n\n\t// Add unknown glTF extensions to an object's userData.\n\n\tfor ( const name in objectDef.extensions ) {\n\n\t\tif ( knownExtensions[ name ] === undefined ) {\n\n\t\t\tobject.userData.gltfExtensions = object.userData.gltfExtensions || {};\n\t\t\tobject.userData.gltfExtensions[ name ] = objectDef.extensions[ name ];\n\n\t\t}\n\n\t}\n\n}\n\n/**\n *\n * @private\n * @param {Object3D|Material|BufferGeometry|Object} object\n * @param {GLTF.definition} gltfDef\n */\nfunction assignExtrasToUserData( object, gltfDef ) {\n\n\tif ( gltfDef.extras !== undefined ) {\n\n\t\tif ( typeof gltfDef.extras === 'object' ) {\n\n\t\t\tObject.assign( object.userData, gltfDef.extras );\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Ignoring primitive type .extras, ' + gltfDef.extras );\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#morph-targets\n *\n * @private\n * @param {BufferGeometry} geometry\n * @param {Array<GLTF.Target>} targets\n * @param {GLTFParser} parser\n * @return {Promise<BufferGeometry>}\n */\nfunction addMorphTargets( geometry, targets, parser ) {\n\n\tlet hasMorphPosition = false;\n\tlet hasMorphNormal = false;\n\tlet hasMorphColor = false;\n\n\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\tconst target = targets[ i ];\n\n\t\tif ( target.POSITION !== undefined ) hasMorphPosition = true;\n\t\tif ( target.NORMAL !== undefined ) hasMorphNormal = true;\n\t\tif ( target.COLOR_0 !== undefined ) hasMorphColor = true;\n\n\t\tif ( hasMorphPosition && hasMorphNormal && hasMorphColor ) break;\n\n\t}\n\n\tif ( ! hasMorphPosition && ! hasMorphNormal && ! hasMorphColor ) return Promise.resolve( geometry );\n\n\tconst pendingPositionAccessors = [];\n\tconst pendingNormalAccessors = [];\n\tconst pendingColorAccessors = [];\n\n\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\tconst target = targets[ i ];\n\n\t\tif ( hasMorphPosition ) {\n\n\t\t\tconst pendingAccessor = target.POSITION !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.POSITION )\n\t\t\t\t: geometry.attributes.position;\n\n\t\t\tpendingPositionAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t\tif ( hasMorphNormal ) {\n\n\t\t\tconst pendingAccessor = target.NORMAL !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.NORMAL )\n\t\t\t\t: geometry.attributes.normal;\n\n\t\t\tpendingNormalAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t\tif ( hasMorphColor ) {\n\n\t\t\tconst pendingAccessor = target.COLOR_0 !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.COLOR_0 )\n\t\t\t\t: geometry.attributes.color;\n\n\t\t\tpendingColorAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t}\n\n\treturn Promise.all( [\n\t\tPromise.all( pendingPositionAccessors ),\n\t\tPromise.all( pendingNormalAccessors ),\n\t\tPromise.all( pendingColorAccessors )\n\t] ).then( function ( accessors ) {\n\n\t\tconst morphPositions = accessors[ 0 ];\n\t\tconst morphNormals = accessors[ 1 ];\n\t\tconst morphColors = accessors[ 2 ];\n\n\t\tif ( hasMorphPosition ) geometry.morphAttributes.position = morphPositions;\n\t\tif ( hasMorphNormal ) geometry.morphAttributes.normal = morphNormals;\n\t\tif ( hasMorphColor ) geometry.morphAttributes.color = morphColors;\n\t\tgeometry.morphTargetsRelative = true;\n\n\t\treturn geometry;\n\n\t} );\n\n}\n\n/**\n *\n * @private\n * @param {Mesh} mesh\n * @param {GLTF.Mesh} meshDef\n */\nfunction updateMorphTargets( mesh, meshDef ) {\n\n\tmesh.updateMorphTargets();\n\n\tif ( meshDef.weights !== undefined ) {\n\n\t\tfor ( let i = 0, il = meshDef.weights.length; i < il; i ++ ) {\n\n\t\t\tmesh.morphTargetInfluences[ i ] = meshDef.weights[ i ];\n\n\t\t}\n\n\t}\n\n\t// .extras has user-defined data, so check that .extras.targetNames is an array.\n\tif ( meshDef.extras && Array.isArray( meshDef.extras.targetNames ) ) {\n\n\t\tconst targetNames = meshDef.extras.targetNames;\n\n\t\tif ( mesh.morphTargetInfluences.length === targetNames.length ) {\n\n\t\t\tmesh.morphTargetDictionary = {};\n\n\t\t\tfor ( let i = 0, il = targetNames.length; i < il; i ++ ) {\n\n\t\t\t\tmesh.morphTargetDictionary[ targetNames[ i ] ] = i;\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.' );\n\n\t\t}\n\n\t}\n\n}\n\nfunction createPrimitiveKey( primitiveDef ) {\n\n\tlet geometryKey;\n\n\tconst dracoExtension = primitiveDef.extensions && primitiveDef.extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ];\n\n\tif ( dracoExtension ) {\n\n\t\tgeometryKey = 'draco:' + dracoExtension.bufferView\n\t\t\t\t+ ':' + dracoExtension.indices\n\t\t\t\t+ ':' + createAttributesKey( dracoExtension.attributes );\n\n\t} else {\n\n\t\tgeometryKey = primitiveDef.indices + ':' + createAttributesKey( primitiveDef.attributes ) + ':' + primitiveDef.mode;\n\n\t}\n\n\tif ( primitiveDef.targets !== undefined ) {\n\n\t\tfor ( let i = 0, il = primitiveDef.targets.length; i < il; i ++ ) {\n\n\t\t\tgeometryKey += ':' + createAttributesKey( primitiveDef.targets[ i ] );\n\n\t\t}\n\n\t}\n\n\treturn geometryKey;\n\n}\n\nfunction createAttributesKey( attributes ) {\n\n\tlet attributesKey = '';\n\n\tconst keys = Object.keys( attributes ).sort();\n\n\tfor ( let i = 0, il = keys.length; i < il; i ++ ) {\n\n\t\tattributesKey += keys[ i ] + ':' + attributes[ keys[ i ] ] + ';';\n\n\t}\n\n\treturn attributesKey;\n\n}\n\nfunction getNormalizedComponentScale( constructor ) {\n\n\t// Reference:\n\t// https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_mesh_quantization#encoding-quantized-data\n\n\tswitch ( constructor ) {\n\n\t\tcase Int8Array:\n\t\t\treturn 1 / 127;\n\n\t\tcase Uint8Array:\n\t\t\treturn 1 / 255;\n\n\t\tcase Int16Array:\n\t\t\treturn 1 / 32767;\n\n\t\tcase Uint16Array:\n\t\t\treturn 1 / 65535;\n\n\t\tdefault:\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Unsupported normalized accessor component type.' );\n\n\t}\n\n}\n\nfunction getImageURIMimeType( uri ) {\n\n\tif ( uri.search( /\\.jpe?g($|\\?)/i ) > 0 || uri.search( /^data\\:image\\/jpeg/ ) === 0 ) return 'image/jpeg';\n\tif ( uri.search( /\\.webp($|\\?)/i ) > 0 || uri.search( /^data\\:image\\/webp/ ) === 0 ) return 'image/webp';\n\tif ( uri.search( /\\.ktx2($|\\?)/i ) > 0 || uri.search( /^data\\:image\\/ktx2/ ) === 0 ) return 'image/ktx2';\n\n\treturn 'image/png';\n\n}\n\nconst _identityMatrix = new Matrix4();\n\n/* GLTF PARSER */\n\nclass GLTFParser {\n\n\tconstructor( json = {}, options = {} ) {\n\n\t\tthis.json = json;\n\t\tthis.extensions = {};\n\t\tthis.plugins = {};\n\t\tthis.options = options;\n\n\t\t// loader object cache\n\t\tthis.cache = new GLTFRegistry();\n\n\t\t// associations between Three.js objects and glTF elements\n\t\tthis.associations = new Map();\n\n\t\t// BufferGeometry caching\n\t\tthis.primitiveCache = {};\n\n\t\t// Node cache\n\t\tthis.nodeCache = {};\n\n\t\t// Object3D instance caches\n\t\tthis.meshCache = { refs: {}, uses: {} };\n\t\tthis.cameraCache = { refs: {}, uses: {} };\n\t\tthis.lightCache = { refs: {}, uses: {} };\n\n\t\tthis.sourceCache = {};\n\t\tthis.textureCache = {};\n\n\t\t// Track node names, to ensure no duplicates\n\t\tthis.nodeNamesUsed = {};\n\n\t\t// Use an ImageBitmapLoader if imageBitmaps are supported. Moves much of the\n\t\t// expensive work of uploading a texture to the GPU off the main thread.\n\n\t\tlet isSafari = false;\n\t\tlet safariVersion = - 1;\n\t\tlet isFirefox = false;\n\t\tlet firefoxVersion = - 1;\n\n\t\tif ( typeof navigator !== 'undefined' ) {\n\n\t\t\tconst userAgent = navigator.userAgent;\n\n\t\t\tisSafari = /^((?!chrome|android).)*safari/i.test( userAgent ) === true;\n\t\t\tconst safariMatch = userAgent.match( /Version\\/(\\d+)/ );\n\t\t\tsafariVersion = isSafari && safariMatch ? parseInt( safariMatch[ 1 ], 10 ) : - 1;\n\n\t\t\tisFirefox = userAgent.indexOf( 'Firefox' ) > - 1;\n\t\t\tfirefoxVersion = isFirefox ? userAgent.match( /Firefox\\/([0-9]+)\\./ )[ 1 ] : - 1;\n\n\t\t}\n\n\t\tif ( typeof createImageBitmap === 'undefined' || ( isSafari && safariVersion < 17 ) || ( isFirefox && firefoxVersion < 98 ) ) {\n\n\t\t\tthis.textureLoader = new TextureLoader( this.options.manager );\n\n\t\t} else {\n\n\t\t\tthis.textureLoader = new ImageBitmapLoader( this.options.manager );\n\n\t\t}\n\n\t\tthis.textureLoader.setCrossOrigin( this.options.crossOrigin );\n\t\tthis.textureLoader.setRequestHeader( this.options.requestHeader );\n\n\t\tthis.fileLoader = new FileLoader( this.options.manager );\n\t\tthis.fileLoader.setResponseType( 'arraybuffer' );\n\n\t\tif ( this.options.crossOrigin === 'use-credentials' ) {\n\n\t\t\tthis.fileLoader.setWithCredentials( true );\n\n\t\t}\n\n\t}\n\n\tsetExtensions( extensions ) {\n\n\t\tthis.extensions = extensions;\n\n\t}\n\n\tsetPlugins( plugins ) {\n\n\t\tthis.plugins = plugins;\n\n\t}\n\n\tparse( onLoad, onError ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\n\t\t// Clear the loader cache\n\t\tthis.cache.removeAll();\n\t\tthis.nodeCache = {};\n\n\t\t// Mark the special nodes/meshes in json for efficient parse\n\t\tthis._invokeAll( function ( ext ) {\n\n\t\t\treturn ext._markDefs && ext._markDefs();\n\n\t\t} );\n\n\t\tPromise.all( this._invokeAll( function ( ext ) {\n\n\t\t\treturn ext.beforeRoot && ext.beforeRoot();\n\n\t\t} ) ).then( function () {\n\n\t\t\treturn Promise.all( [\n\n\t\t\t\tparser.getDependencies( 'scene' ),\n\t\t\t\tparser.getDependencies( 'animation' ),\n\t\t\t\tparser.getDependencies( 'camera' ),\n\n\t\t\t] );\n\n\t\t} ).then( function ( dependencies ) {\n\n\t\t\tconst result = {\n\t\t\t\tscene: dependencies[ 0 ][ json.scene || 0 ],\n\t\t\t\tscenes: dependencies[ 0 ],\n\t\t\t\tanimations: dependencies[ 1 ],\n\t\t\t\tcameras: dependencies[ 2 ],\n\t\t\t\tasset: json.asset,\n\t\t\t\tparser: parser,\n\t\t\t\tuserData: {}\n\t\t\t};\n\n\t\t\taddUnknownExtensionsToUserData( extensions, result, json );\n\n\t\t\tassignExtrasToUserData( result, json );\n\n\t\t\treturn Promise.all( parser._invokeAll( function ( ext ) {\n\n\t\t\t\treturn ext.afterRoot && ext.afterRoot( result );\n\n\t\t\t} ) ).then( function () {\n\n\t\t\t\tfor ( const scene of result.scenes ) {\n\n\t\t\t\t\tscene.updateMatrixWorld();\n\n\t\t\t\t}\n\n\t\t\t\tonLoad( result );\n\n\t\t\t} );\n\n\t\t} ).catch( onError );\n\n\t}\n\n\t/**\n\t * Marks the special nodes/meshes in json for efficient parse.\n\t *\n\t * @private\n\t */\n\t_markDefs() {\n\n\t\tconst nodeDefs = this.json.nodes || [];\n\t\tconst skinDefs = this.json.skins || [];\n\t\tconst meshDefs = this.json.meshes || [];\n\n\t\t// Nothing in the node definition indicates whether it is a Bone or an\n\t\t// Object3D. Use the skins' joint references to mark bones.\n\t\tfor ( let skinIndex = 0, skinLength = skinDefs.length; skinIndex < skinLength; skinIndex ++ ) {\n\n\t\t\tconst joints = skinDefs[ skinIndex ].joints;\n\n\t\t\tfor ( let i = 0, il = joints.length; i < il; i ++ ) {\n\n\t\t\t\tnodeDefs[ joints[ i ] ].isBone = true;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// Iterate over all nodes, marking references to shared resources,\n\t\t// as well as skeleton joints.\n\t\tfor ( let nodeIndex = 0, nodeLength = nodeDefs.length; nodeIndex < nodeLength; nodeIndex ++ ) {\n\n\t\t\tconst nodeDef = nodeDefs[ nodeIndex ];\n\n\t\t\tif ( nodeDef.mesh !== undefined ) {\n\n\t\t\t\tthis._addNodeRef( this.meshCache, nodeDef.mesh );\n\n\t\t\t\t// Nothing in the mesh definition indicates whether it is\n\t\t\t\t// a SkinnedMesh or Mesh. Use the node's mesh reference\n\t\t\t\t// to mark SkinnedMesh if node has skin.\n\t\t\t\tif ( nodeDef.skin !== undefined ) {\n\n\t\t\t\t\tmeshDefs[ nodeDef.mesh ].isSkinnedMesh = true;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( nodeDef.camera !== undefined ) {\n\n\t\t\t\tthis._addNodeRef( this.cameraCache, nodeDef.camera );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Counts references to shared node / Object3D resources. These resources\n\t * can be reused, or \"instantiated\", at multiple nodes in the scene\n\t * hierarchy. Mesh, Camera, and Light instances are instantiated and must\n\t * be marked. Non-scenegraph resources (like Materials, Geometries, and\n\t * Textures) can be reused directly and are not marked here.\n\t *\n\t * Example: CesiumMilkTruck sample model reuses \"Wheel\" meshes.\n\t *\n\t * @private\n\t * @param {Object} cache\n\t * @param {Object3D} index\n\t */\n\t_addNodeRef( cache, index ) {\n\n\t\tif ( index === undefined ) return;\n\n\t\tif ( cache.refs[ index ] === undefined ) {\n\n\t\t\tcache.refs[ index ] = cache.uses[ index ] = 0;\n\n\t\t}\n\n\t\tcache.refs[ index ] ++;\n\n\t}\n\n\t/**\n\t * Returns a reference to a shared resource, cloning it if necessary.\n\t *\n\t * @private\n\t * @param {Object} cache\n\t * @param {number} index\n\t * @param {Object} object\n\t * @return {Object}\n\t */\n\t_getNodeRef( cache, index, object ) {\n\n\t\tif ( cache.refs[ index ] <= 1 ) return object;\n\n\t\tconst ref = object.clone();\n\n\t\t// Propagates mappings to the cloned object, prevents mappings on the\n\t\t// original object from being lost.\n\t\tconst updateMappings = ( original, clone ) => {\n\n\t\t\tconst mappings = this.associations.get( original );\n\t\t\tif ( mappings != null ) {\n\n\t\t\t\tthis.associations.set( clone, mappings );\n\n\t\t\t}\n\n\t\t\tfor ( const [ i, child ] of original.children.entries() ) {\n\n\t\t\t\tupdateMappings( child, clone.children[ i ] );\n\n\t\t\t}\n\n\t\t};\n\n\t\tupdateMappings( object, ref );\n\n\t\tref.name += '_instance_' + ( cache.uses[ index ] ++ );\n\n\t\treturn ref;\n\n\t}\n\n\t_invokeOne( func ) {\n\n\t\tconst extensions = Object.values( this.plugins );\n\t\textensions.push( this );\n\n\t\tfor ( let i = 0; i < extensions.length; i ++ ) {\n\n\t\t\tconst result = func( extensions[ i ] );\n\n\t\t\tif ( result ) return result;\n\n\t\t}\n\n\t\treturn null;\n\n\t}\n\n\t_invokeAll( func ) {\n\n\t\tconst extensions = Object.values( this.plugins );\n\t\textensions.unshift( this );\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0; i < extensions.length; i ++ ) {\n\n\t\t\tconst result = func( extensions[ i ] );\n\n\t\t\tif ( result ) pending.push( result );\n\n\t\t}\n\n\t\treturn pending;\n\n\t}\n\n\t/**\n\t * Requests the specified dependency asynchronously, with caching.\n\t *\n\t * @private\n\t * @param {string} type\n\t * @param {number} index\n\t * @return {Promise<Object3D|Material|THREE.Texture|AnimationClip|ArrayBuffer|Object>}\n\t */\n\tgetDependency( type, index ) {\n\n\t\tconst cacheKey = type + ':' + index;\n\t\tlet dependency = this.cache.get( cacheKey );\n\n\t\tif ( ! dependency ) {\n\n\t\t\tswitch ( type ) {\n\n\t\t\t\tcase 'scene':\n\t\t\t\t\tdependency = this.loadScene( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'node':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadNode && ext.loadNode( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'mesh':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadMesh && ext.loadMesh( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'accessor':\n\t\t\t\t\tdependency = this.loadAccessor( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'bufferView':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadBufferView && ext.loadBufferView( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'buffer':\n\t\t\t\t\tdependency = this.loadBuffer( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'material':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadMaterial && ext.loadMaterial( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'texture':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadTexture && ext.loadTexture( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'skin':\n\t\t\t\t\tdependency = this.loadSkin( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'animation':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadAnimation && ext.loadAnimation( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'camera':\n\t\t\t\t\tdependency = this.loadCamera( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext != this && ext.getDependency && ext.getDependency( type, index );\n\n\t\t\t\t\t} );\n\n\t\t\t\t\tif ( ! dependency ) {\n\n\t\t\t\t\t\tthrow new Error( 'Unknown type: ' + type );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tthis.cache.add( cacheKey, dependency );\n\n\t\t}\n\n\t\treturn dependency;\n\n\t}\n\n\t/**\n\t * Requests all dependencies of the specified type asynchronously, with caching.\n\t *\n\t * @private\n\t * @param {string} type\n\t * @return {Promise<Array<Object>>}\n\t */\n\tgetDependencies( type ) {\n\n\t\tlet dependencies = this.cache.get( type );\n\n\t\tif ( ! dependencies ) {\n\n\t\t\tconst parser = this;\n\t\t\tconst defs = this.json[ type + ( type === 'mesh' ? 'es' : 's' ) ] || [];\n\n\t\t\tdependencies = Promise.all( defs.map( function ( def, index ) {\n\n\t\t\t\treturn parser.getDependency( type, index );\n\n\t\t\t} ) );\n\n\t\t\tthis.cache.add( type, dependencies );\n\n\t\t}\n\n\t\treturn dependencies;\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#buffers-and-buffer-views\n\t *\n\t * @private\n\t * @param {number} bufferIndex\n\t * @return {Promise<ArrayBuffer>}\n\t */\n\tloadBuffer( bufferIndex ) {\n\n\t\tconst bufferDef = this.json.buffers[ bufferIndex ];\n\t\tconst loader = this.fileLoader;\n\n\t\tif ( bufferDef.type && bufferDef.type !== 'arraybuffer' ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: ' + bufferDef.type + ' buffer type is not supported.' );\n\n\t\t}\n\n\t\t// If present, GLB container is required to be the first buffer.\n\t\tif ( bufferDef.uri === undefined && bufferIndex === 0 ) {\n\n\t\t\treturn Promise.resolve( this.extensions[ EXTENSIONS.KHR_BINARY_GLTF ].body );\n\n\t\t}\n\n\t\tconst options = this.options;\n\n\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\tloader.load( LoaderUtils.resolveURL( bufferDef.uri, options.path ), resolve, undefined, function () {\n\n\t\t\t\treject( new Error( 'THREE.GLTFLoader: Failed to load buffer \"' + bufferDef.uri + '\".' ) );\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#buffers-and-buffer-views\n\t *\n\t * @private\n\t * @param {number} bufferViewIndex\n\t * @return {Promise<ArrayBuffer>}\n\t */\n\tloadBufferView( bufferViewIndex ) {\n\n\t\tconst bufferViewDef = this.json.bufferViews[ bufferViewIndex ];\n\n\t\treturn this.getDependency( 'buffer', bufferViewDef.buffer ).then( function ( buffer ) {\n\n\t\t\tconst byteLength = bufferViewDef.byteLength || 0;\n\t\t\tconst byteOffset = bufferViewDef.byteOffset || 0;\n\t\t\treturn buffer.slice( byteOffset, byteOffset + byteLength );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#accessors\n\t *\n\t * @private\n\t * @param {number} accessorIndex\n\t * @return {Promise<BufferAttribute|InterleavedBufferAttribute>}\n\t */\n\tloadAccessor( accessorIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\n\t\tconst accessorDef = this.json.accessors[ accessorIndex ];\n\n\t\tif ( accessorDef.bufferView === undefined && accessorDef.sparse === undefined ) {\n\n\t\t\tconst itemSize = WEBGL_TYPE_SIZES[ accessorDef.type ];\n\t\t\tconst TypedArray = WEBGL_COMPONENT_TYPES[ accessorDef.componentType ];\n\t\t\tconst normalized = accessorDef.normalized === true;\n\n\t\t\tconst array = new TypedArray( accessorDef.count * itemSize );\n\t\t\treturn Promise.resolve( new BufferAttribute( array, itemSize, normalized ) );\n\n\t\t}\n\n\t\tconst pendingBufferViews = [];\n\n\t\tif ( accessorDef.bufferView !== undefined ) {\n\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.bufferView ) );\n\n\t\t} else {\n\n\t\t\tpendingBufferViews.push( null );\n\n\t\t}\n\n\t\tif ( accessorDef.sparse !== undefined ) {\n\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.sparse.indices.bufferView ) );\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.sparse.values.bufferView ) );\n\n\t\t}\n\n\t\treturn Promise.all( pendingBufferViews ).then( function ( bufferViews ) {\n\n\t\t\tconst bufferView = bufferViews[ 0 ];\n\n\t\t\tconst itemSize = WEBGL_TYPE_SIZES[ accessorDef.type ];\n\t\t\tconst TypedArray = WEBGL_COMPONENT_TYPES[ accessorDef.componentType ];\n\n\t\t\t// For VEC3: itemSize is 3, elementBytes is 4, itemBytes is 12.\n\t\t\tconst elementBytes = TypedArray.BYTES_PER_ELEMENT;\n\t\t\tconst itemBytes = elementBytes * itemSize;\n\t\t\tconst byteOffset = accessorDef.byteOffset || 0;\n\t\t\tconst byteStride = accessorDef.bufferView !== undefined ? json.bufferViews[ accessorDef.bufferView ].byteStride : undefined;\n\t\t\tconst normalized = accessorDef.normalized === true;\n\t\t\tlet array, bufferAttribute;\n\n\t\t\t// The buffer is not interleaved if the stride is the item size in bytes.\n\t\t\tif ( byteStride && byteStride !== itemBytes ) {\n\n\t\t\t\t// Each \"slice\" of the buffer, as defined by 'count' elements of 'byteStride' bytes, gets its own InterleavedBuffer\n\t\t\t\t// This makes sure that IBA.count reflects accessor.count properly\n\t\t\t\tconst ibSlice = Math.floor( byteOffset / byteStride );\n\t\t\t\tconst ibCacheKey = 'InterleavedBuffer:' + accessorDef.bufferView + ':' + accessorDef.componentType + ':' + ibSlice + ':' + accessorDef.count;\n\t\t\t\tlet ib = parser.cache.get( ibCacheKey );\n\n\t\t\t\tif ( ! ib ) {\n\n\t\t\t\t\tarray = new TypedArray( bufferView, ibSlice * byteStride, accessorDef.count * byteStride / elementBytes );\n\n\t\t\t\t\t// Integer parameters to IB/IBA are in array elements, not bytes.\n\t\t\t\t\tib = new InterleavedBuffer( array, byteStride / elementBytes );\n\n\t\t\t\t\tparser.cache.add( ibCacheKey, ib );\n\n\t\t\t\t}\n\n\t\t\t\tbufferAttribute = new InterleavedBufferAttribute( ib, itemSize, ( byteOffset % byteStride ) / elementBytes, normalized );\n\n\t\t\t} else {\n\n\t\t\t\tif ( bufferView === null ) {\n\n\t\t\t\t\tarray = new TypedArray( accessorDef.count * itemSize );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tarray = new TypedArray( bufferView, byteOffset, accessorDef.count * itemSize );\n\n\t\t\t\t}\n\n\t\t\t\tbufferAttribute = new BufferAttribute( array, itemSize, normalized );\n\n\t\t\t}\n\n\t\t\t// https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#sparse-accessors\n\t\t\tif ( accessorDef.sparse !== undefined ) {\n\n\t\t\t\tconst itemSizeIndices = WEBGL_TYPE_SIZES.SCALAR;\n\t\t\t\tconst TypedArrayIndices = WEBGL_COMPONENT_TYPES[ accessorDef.sparse.indices.componentType ];\n\n\t\t\t\tconst byteOffsetIndices = accessorDef.sparse.indices.byteOffset || 0;\n\t\t\t\tconst byteOffsetValues = accessorDef.sparse.values.byteOffset || 0;\n\n\t\t\t\tconst sparseIndices = new TypedArrayIndices( bufferViews[ 1 ], byteOffsetIndices, accessorDef.sparse.count * itemSizeIndices );\n\t\t\t\tconst sparseValues = new TypedArray( bufferViews[ 2 ], byteOffsetValues, accessorDef.sparse.count * itemSize );\n\n\t\t\t\tif ( bufferView !== null ) {\n\n\t\t\t\t\t// Avoid modifying the original ArrayBuffer, if the bufferView wasn't initialized with zeroes.\n\t\t\t\t\tbufferAttribute = new BufferAttribute( bufferAttribute.array.slice(), bufferAttribute.itemSize, bufferAttribute.normalized );\n\n\t\t\t\t}\n\n\t\t\t\t// Ignore normalized since we copy from sparse\n\t\t\t\tbufferAttribute.normalized = false;\n\n\t\t\t\tfor ( let i = 0, il = sparseIndices.length; i < il; i ++ ) {\n\n\t\t\t\t\tconst index = sparseIndices[ i ];\n\n\t\t\t\t\tbufferAttribute.setX( index, sparseValues[ i * itemSize ] );\n\t\t\t\t\tif ( itemSize >= 2 ) bufferAttribute.setY( index, sparseValues[ i * itemSize + 1 ] );\n\t\t\t\t\tif ( itemSize >= 3 ) bufferAttribute.setZ( index, sparseValues[ i * itemSize + 2 ] );\n\t\t\t\t\tif ( itemSize >= 4 ) bufferAttribute.setW( index, sparseValues[ i * itemSize + 3 ] );\n\t\t\t\t\tif ( itemSize >= 5 ) throw new Error( 'THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.' );\n\n\t\t\t\t}\n\n\t\t\t\tbufferAttribute.normalized = normalized;\n\n\t\t\t}\n\n\t\t\treturn bufferAttribute;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#textures\n\t *\n\t * @private\n\t * @param {number} textureIndex\n\t * @return {Promise<THREE.Texture|null>}\n\t */\n\tloadTexture( textureIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst options = this.options;\n\t\tconst textureDef = json.textures[ textureIndex ];\n\t\tconst sourceIndex = textureDef.source;\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tlet loader = this.textureLoader;\n\n\t\tif ( sourceDef.uri ) {\n\n\t\t\tconst handler = options.manager.getHandler( sourceDef.uri );\n\t\t\tif ( handler !== null ) loader = handler;\n\n\t\t}\n\n\t\treturn this.loadTextureImage( textureIndex, sourceIndex, loader );\n\n\t}\n\n\tloadTextureImage( textureIndex, sourceIndex, loader ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tconst cacheKey = ( sourceDef.uri || sourceDef.bufferView ) + ':' + textureDef.sampler;\n\n\t\tif ( this.textureCache[ cacheKey ] ) {\n\n\t\t\t// See https://github.com/mrdoob/three.js/issues/21559.\n\t\t\treturn this.textureCache[ cacheKey ];\n\n\t\t}\n\n\t\tconst promise = this.loadImageSource( sourceIndex, loader ).then( function ( texture ) {\n\n\t\t\ttexture.flipY = false;\n\n\t\t\ttexture.name = textureDef.name || sourceDef.name || '';\n\n\t\t\tif ( texture.name === '' && typeof sourceDef.uri === 'string' && sourceDef.uri.startsWith( 'data:image/' ) === false ) {\n\n\t\t\t\ttexture.name = sourceDef.uri;\n\n\t\t\t}\n\n\t\t\tconst samplers = json.samplers || {};\n\t\t\tconst sampler = samplers[ textureDef.sampler ] || {};\n\n\t\t\ttexture.magFilter = WEBGL_FILTERS[ sampler.magFilter ] || LinearFilter;\n\t\t\ttexture.minFilter = WEBGL_FILTERS[ sampler.minFilter ] || LinearMipmapLinearFilter;\n\t\t\ttexture.wrapS = WEBGL_WRAPPINGS[ sampler.wrapS ] || RepeatWrapping;\n\t\t\ttexture.wrapT = WEBGL_WRAPPINGS[ sampler.wrapT ] || RepeatWrapping;\n\t\t\ttexture.generateMipmaps = ! texture.isCompressedTexture && texture.minFilter !== NearestFilter && texture.minFilter !== LinearFilter;\n\n\t\t\tparser.associations.set( texture, { textures: textureIndex } );\n\n\t\t\treturn texture;\n\n\t\t} ).catch( function () {\n\n\t\t\treturn null;\n\n\t\t} );\n\n\t\tthis.textureCache[ cacheKey ] = promise;\n\n\t\treturn promise;\n\n\t}\n\n\tloadImageSource( sourceIndex, loader ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst options = this.options;\n\n\t\tif ( this.sourceCache[ sourceIndex ] !== undefined ) {\n\n\t\t\treturn this.sourceCache[ sourceIndex ].then( ( texture ) => texture.clone() );\n\n\t\t}\n\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tconst URL = self.URL || self.webkitURL;\n\n\t\tlet sourceURI = sourceDef.uri || '';\n\t\tlet isObjectURL = false;\n\n\t\tif ( sourceDef.bufferView !== undefined ) {\n\n\t\t\t// Load binary image data from bufferView, if provided.\n\n\t\t\tsourceURI = parser.getDependency( 'bufferView', sourceDef.bufferView ).then( function ( bufferView ) {\n\n\t\t\t\tisObjectURL = true;\n\t\t\t\tconst blob = new Blob( [ bufferView ], { type: sourceDef.mimeType } );\n\t\t\t\tsourceURI = URL.createObjectURL( blob );\n\t\t\t\treturn sourceURI;\n\n\t\t\t} );\n\n\t\t} else if ( sourceDef.uri === undefined ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Image ' + sourceIndex + ' is missing URI and bufferView' );\n\n\t\t}\n\n\t\tconst promise = Promise.resolve( sourceURI ).then( function ( sourceURI ) {\n\n\t\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\t\tlet onLoad = resolve;\n\n\t\t\t\tif ( loader.isImageBitmapLoader === true ) {\n\n\t\t\t\t\tonLoad = function ( imageBitmap ) {\n\n\t\t\t\t\t\tconst texture = new Texture( imageBitmap );\n\t\t\t\t\t\ttexture.needsUpdate = true;\n\n\t\t\t\t\t\tresolve( texture );\n\n\t\t\t\t\t};\n\n\t\t\t\t}\n\n\t\t\t\tloader.load( LoaderUtils.resolveURL( sourceURI, options.path ), onLoad, undefined, reject );\n\n\t\t\t} );\n\n\t\t} ).then( function ( texture ) {\n\n\t\t\t// Clean up resources and configure Texture.\n\n\t\t\tif ( isObjectURL === true ) {\n\n\t\t\t\tURL.revokeObjectURL( sourceURI );\n\n\t\t\t}\n\n\t\t\tassignExtrasToUserData( texture, sourceDef );\n\n\t\t\ttexture.userData.mimeType = sourceDef.mimeType || getImageURIMimeType( sourceDef.uri );\n\n\t\t\treturn texture;\n\n\t\t} ).catch( function ( error ) {\n\n\t\t\tconsole.error( 'THREE.GLTFLoader: Couldn\\'t load texture', sourceURI );\n\t\t\tthrow error;\n\n\t\t} );\n\n\t\tthis.sourceCache[ sourceIndex ] = promise;\n\t\treturn promise;\n\n\t}\n\n\t/**\n\t * Asynchronously assigns a texture to the given material parameters.\n\t *\n\t * @private\n\t * @param {Object} materialParams\n\t * @param {string} mapName\n\t * @param {Object} mapDef\n\t * @param {string} [colorSpace]\n\t * @return {Promise<Texture>}\n\t */\n\tassignTexture( materialParams, mapName, mapDef, colorSpace ) {\n\n\t\tconst parser = this;\n\n\t\treturn this.getDependency( 'texture', mapDef.index ).then( function ( texture ) {\n\n\t\t\tif ( ! texture ) return null;\n\n\t\t\tif ( mapDef.texCoord !== undefined && mapDef.texCoord > 0 ) {\n\n\t\t\t\ttexture = texture.clone();\n\t\t\t\ttexture.channel = mapDef.texCoord;\n\n\t\t\t}\n\n\t\t\tif ( parser.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ] ) {\n\n\t\t\t\tconst transform = mapDef.extensions !== undefined ? mapDef.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ] : undefined;\n\n\t\t\t\tif ( transform ) {\n\n\t\t\t\t\tconst gltfReference = parser.associations.get( texture );\n\t\t\t\t\ttexture = parser.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ].extendTexture( texture, transform );\n\t\t\t\t\tparser.associations.set( texture, gltfReference );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( colorSpace !== undefined ) {\n\n\t\t\t\ttexture.colorSpace = colorSpace;\n\n\t\t\t}\n\n\t\t\tmaterialParams[ mapName ] = texture;\n\n\t\t\treturn texture;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Assigns final material to a Mesh, Line, or Points instance. The instance\n\t * already has a material (generated from the glTF material options alone)\n\t * but reuse of the same glTF material may require multiple threejs materials\n\t * to accommodate different primitive types, defines, etc. New materials will\n\t * be created if necessary, and reused from a cache.\n\t *\n\t * @private\n\t * @param {Object3D} mesh Mesh, Line, or Points instance.\n\t */\n\tassignFinalMaterial( mesh ) {\n\n\t\tconst geometry = mesh.geometry;\n\t\tlet material = mesh.material;\n\n\t\tconst useDerivativeTangents = geometry.attributes.tangent === undefined;\n\t\tconst useVertexColors = geometry.attributes.color !== undefined;\n\t\tconst useFlatShading = geometry.attributes.normal === undefined;\n\n\t\tif ( mesh.isPoints ) {\n\n\t\t\tconst cacheKey = 'PointsMaterial:' + material.uuid;\n\n\t\t\tlet pointsMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! pointsMaterial ) {\n\n\t\t\t\tpointsMaterial = new PointsMaterial();\n\t\t\t\tMaterial.prototype.copy.call( pointsMaterial, material );\n\t\t\t\tpointsMaterial.color.copy( material.color );\n\t\t\t\tpointsMaterial.map = material.map;\n\t\t\t\tpointsMaterial.sizeAttenuation = false; // glTF spec says points should be 1px\n\n\t\t\t\tthis.cache.add( cacheKey, pointsMaterial );\n\n\t\t\t}\n\n\t\t\tmaterial = pointsMaterial;\n\n\t\t} else if ( mesh.isLine ) {\n\n\t\t\tconst cacheKey = 'LineBasicMaterial:' + material.uuid;\n\n\t\t\tlet lineMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! lineMaterial ) {\n\n\t\t\t\tlineMaterial = new LineBasicMaterial();\n\t\t\t\tMaterial.prototype.copy.call( lineMaterial, material );\n\t\t\t\tlineMaterial.color.copy( material.color );\n\t\t\t\tlineMaterial.map = material.map;\n\n\t\t\t\tthis.cache.add( cacheKey, lineMaterial );\n\n\t\t\t}\n\n\t\t\tmaterial = lineMaterial;\n\n\t\t}\n\n\t\t// Clone the material if it will be modified\n\t\tif ( useDerivativeTangents || useVertexColors || useFlatShading ) {\n\n\t\t\tlet cacheKey = 'ClonedMaterial:' + material.uuid + ':';\n\n\t\t\tif ( useDerivativeTangents ) cacheKey += 'derivative-tangents:';\n\t\t\tif ( useVertexColors ) cacheKey += 'vertex-colors:';\n\t\t\tif ( useFlatShading ) cacheKey += 'flat-shading:';\n\n\t\t\tlet cachedMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! cachedMaterial ) {\n\n\t\t\t\tcachedMaterial = material.clone();\n\n\t\t\t\tif ( useVertexColors ) cachedMaterial.vertexColors = true;\n\t\t\t\tif ( useFlatShading ) cachedMaterial.flatShading = true;\n\n\t\t\t\tif ( useDerivativeTangents ) {\n\n\t\t\t\t\t// https://github.com/mrdoob/three.js/issues/11438#issuecomment-507003995\n\t\t\t\t\tif ( cachedMaterial.normalScale ) cachedMaterial.normalScale.y *= - 1;\n\t\t\t\t\tif ( cachedMaterial.clearcoatNormalScale ) cachedMaterial.clearcoatNormalScale.y *= - 1;\n\n\t\t\t\t}\n\n\t\t\t\tthis.cache.add( cacheKey, cachedMaterial );\n\n\t\t\t\tthis.associations.set( cachedMaterial, this.associations.get( material ) );\n\n\t\t\t}\n\n\t\t\tmaterial = cachedMaterial;\n\n\t\t}\n\n\t\tmesh.material = material;\n\n\t}\n\n\tgetMaterialType( /* materialIndex */ ) {\n\n\t\treturn MeshStandardMaterial;\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#materials\n\t *\n\t * @private\n\t * @param {number} materialIndex\n\t * @return {Promise<Material>}\n\t */\n\tloadMaterial( materialIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\t\tconst materialDef = json.materials[ materialIndex ];\n\n\t\tlet materialType;\n\t\tconst materialParams = {};\n\t\tconst materialExtensions = materialDef.extensions || {};\n\n\t\tconst pending = [];\n\n\t\tif ( materialExtensions[ EXTENSIONS.KHR_MATERIALS_UNLIT ] ) {\n\n\t\t\tconst kmuExtension = extensions[ EXTENSIONS.KHR_MATERIALS_UNLIT ];\n\t\t\tmaterialType = kmuExtension.getMaterialType();\n\t\t\tpending.push( kmuExtension.extendParams( materialParams, materialDef, parser ) );\n\n\t\t} else {\n\n\t\t\t// Specification:\n\t\t\t// https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#metallic-roughness-material\n\n\t\t\tconst metallicRoughness = materialDef.pbrMetallicRoughness || {};\n\n\t\t\tmaterialParams.color = new Color( 1.0, 1.0, 1.0 );\n\t\t\tmaterialParams.opacity = 1.0;\n\n\t\t\tif ( Array.isArray( metallicRoughness.baseColorFactor ) ) {\n\n\t\t\t\tconst array = metallicRoughness.baseColorFactor;\n\n\t\t\t\tmaterialParams.color.setRGB( array[ 0 ], array[ 1 ], array[ 2 ], LinearSRGBColorSpace );\n\t\t\t\tmaterialParams.opacity = array[ 3 ];\n\n\t\t\t}\n\n\t\t\tif ( metallicRoughness.baseColorTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'map', metallicRoughness.baseColorTexture, SRGBColorSpace ) );\n\n\t\t\t}\n\n\t\t\tmaterialParams.metalness = metallicRoughness.metallicFactor !== undefined ? metallicRoughness.metallicFactor : 1.0;\n\t\t\tmaterialParams.roughness = metallicRoughness.roughnessFactor !== undefined ? metallicRoughness.roughnessFactor : 1.0;\n\n\t\t\tif ( metallicRoughness.metallicRoughnessTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'metalnessMap', metallicRoughness.metallicRoughnessTexture ) );\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'roughnessMap', metallicRoughness.metallicRoughnessTexture ) );\n\n\t\t\t}\n\n\t\t\tmaterialType = this._invokeOne( function ( ext ) {\n\n\t\t\t\treturn ext.getMaterialType && ext.getMaterialType( materialIndex );\n\n\t\t\t} );\n\n\t\t\tpending.push( Promise.all( this._invokeAll( function ( ext ) {\n\n\t\t\t\treturn ext.extendMaterialParams && ext.extendMaterialParams( materialIndex, materialParams );\n\n\t\t\t} ) ) );\n\n\t\t}\n\n\t\tif ( materialDef.doubleSided === true ) {\n\n\t\t\tmaterialParams.side = DoubleSide;\n\n\t\t}\n\n\t\tconst alphaMode = materialDef.alphaMode || ALPHA_MODES.OPAQUE;\n\n\t\tif ( alphaMode === ALPHA_MODES.BLEND ) {\n\n\t\t\tmaterialParams.transparent = true;\n\n\t\t\t// See: https://github.com/mrdoob/three.js/issues/17706\n\t\t\tmaterialParams.depthWrite = false;\n\n\t\t} else {\n\n\t\t\tmaterialParams.transparent = false;\n\n\t\t\tif ( alphaMode === ALPHA_MODES.MASK ) {\n\n\t\t\t\tmaterialParams.alphaTest = materialDef.alphaCutoff !== undefined ? materialDef.alphaCutoff : 0.5;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.normalTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'normalMap', materialDef.normalTexture ) );\n\n\t\t\tmaterialParams.normalScale = new Vector2( 1, 1 );\n\n\t\t\tif ( materialDef.normalTexture.scale !== undefined ) {\n\n\t\t\t\tconst scale = materialDef.normalTexture.scale;\n\n\t\t\t\tmaterialParams.normalScale.set( scale, scale );\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.occlusionTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'aoMap', materialDef.occlusionTexture ) );\n\n\t\t\tif ( materialDef.occlusionTexture.strength !== undefined ) {\n\n\t\t\t\tmaterialParams.aoMapIntensity = materialDef.occlusionTexture.strength;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.emissiveFactor !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tconst emissiveFactor = materialDef.emissiveFactor;\n\t\t\tmaterialParams.emissive = new Color().setRGB( emissiveFactor[ 0 ], emissiveFactor[ 1 ], emissiveFactor[ 2 ], LinearSRGBColorSpace );\n\n\t\t}\n\n\t\tif ( materialDef.emissiveTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'emissiveMap', materialDef.emissiveTexture, SRGBColorSpace ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending ).then( function () {\n\n\t\t\tconst material = new materialType( materialParams );\n\n\t\t\tif ( materialDef.name ) material.name = materialDef.name;\n\n\t\t\tassignExtrasToUserData( material, materialDef );\n\n\t\t\tparser.associations.set( material, { materials: materialIndex } );\n\n\t\t\tif ( materialDef.extensions ) addUnknownExtensionsToUserData( extensions, material, materialDef );\n\n\t\t\treturn material;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * When Object3D instances are targeted by animation, they need unique names.\n\t *\n\t * @private\n\t * @param {string} originalName\n\t * @return {string}\n\t */\n\tcreateUniqueName( originalName ) {\n\n\t\tconst sanitizedName = PropertyBinding.sanitizeNodeName( originalName || '' );\n\n\t\tif ( sanitizedName in this.nodeNamesUsed ) {\n\n\t\t\treturn sanitizedName + '_' + ( ++ this.nodeNamesUsed[ sanitizedName ] );\n\n\t\t} else {\n\n\t\t\tthis.nodeNamesUsed[ sanitizedName ] = 0;\n\n\t\t\treturn sanitizedName;\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#geometry\n\t *\n\t * Creates BufferGeometries from primitives.\n\t *\n\t * @private\n\t * @param {Array<GLTF.Primitive>} primitives\n\t * @return {Promise<Array<BufferGeometry>>}\n\t */\n\tloadGeometries( primitives ) {\n\n\t\tconst parser = this;\n\t\tconst extensions = this.extensions;\n\t\tconst cache = this.primitiveCache;\n\n\t\tfunction createDracoPrimitive( primitive ) {\n\n\t\t\treturn extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ]\n\t\t\t\t.decodePrimitive( primitive, parser )\n\t\t\t\t.then( function ( geometry ) {\n\n\t\t\t\t\treturn addPrimitiveAttributes( geometry, primitive, parser );\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = primitives.length; i < il; i ++ ) {\n\n\t\t\tconst primitive = primitives[ i ];\n\t\t\tconst cacheKey = createPrimitiveKey( primitive );\n\n\t\t\t// See if we've already created this geometry\n\t\t\tconst cached = cache[ cacheKey ];\n\n\t\t\tif ( cached ) {\n\n\t\t\t\t// Use the cached geometry if it exists\n\t\t\t\tpending.push( cached.promise );\n\n\t\t\t} else {\n\n\t\t\t\tlet geometryPromise;\n\n\t\t\t\tif ( primitive.extensions && primitive.extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ] ) {\n\n\t\t\t\t\t// Use DRACO geometry if available\n\t\t\t\t\tgeometryPromise = createDracoPrimitive( primitive );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// Otherwise create a new geometry\n\t\t\t\t\tgeometryPromise = addPrimitiveAttributes( new BufferGeometry(), primitive, parser );\n\n\t\t\t\t}\n\n\t\t\t\t// Cache this geometry\n\t\t\t\tcache[ cacheKey ] = { primitive: primitive, promise: geometryPromise };\n\n\t\t\t\tpending.push( geometryPromise );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#meshes\n\t *\n\t * @private\n\t * @param {number} meshIndex\n\t * @return {Promise<Group|Mesh|SkinnedMesh|Line|Points>}\n\t */\n\tloadMesh( meshIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\n\t\tconst meshDef = json.meshes[ meshIndex ];\n\t\tconst primitives = meshDef.primitives;\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = primitives.length; i < il; i ++ ) {\n\n\t\t\tconst material = primitives[ i ].material === undefined\n\t\t\t\t? createDefaultMaterial( this.cache )\n\t\t\t\t: this.getDependency( 'material', primitives[ i ].material );\n\n\t\t\tpending.push( material );\n\n\t\t}\n\n\t\tpending.push( parser.loadGeometries( primitives ) );\n\n\t\treturn Promise.all( pending ).then( function ( results ) {\n\n\t\t\tconst materials = results.slice( 0, results.length - 1 );\n\t\t\tconst geometries = results[ results.length - 1 ];\n\n\t\t\tconst meshes = [];\n\n\t\t\tfor ( let i = 0, il = geometries.length; i < il; i ++ ) {\n\n\t\t\t\tconst geometry = geometries[ i ];\n\t\t\t\tconst primitive = primitives[ i ];\n\n\t\t\t\t// 1. create Mesh\n\n\t\t\t\tlet mesh;\n\n\t\t\t\tconst material = materials[ i ];\n\n\t\t\t\tif ( primitive.mode === WEBGL_CONSTANTS.TRIANGLES ||\n\t\t\t\t\t\tprimitive.mode === WEBGL_CONSTANTS.TRIANGLE_STRIP ||\n\t\t\t\t\t\tprimitive.mode === WEBGL_CONSTANTS.TRIANGLE_FAN ||\n\t\t\t\t\t\tprimitive.mode === undefined ) {\n\n\t\t\t\t\t// .isSkinnedMesh isn't in glTF spec. See ._markDefs()\n\t\t\t\t\tmesh = meshDef.isSkinnedMesh === true\n\t\t\t\t\t\t? new SkinnedMesh( geometry, material )\n\t\t\t\t\t\t: new Mesh( geometry, material );\n\n\t\t\t\t\tif ( mesh.isSkinnedMesh === true ) {\n\n\t\t\t\t\t\t// normalize skin weights to fix malformed assets (see #15319)\n\t\t\t\t\t\tmesh.normalizeSkinWeights();\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( primitive.mode === WEBGL_CONSTANTS.TRIANGLE_STRIP ) {\n\n\t\t\t\t\t\tmesh.geometry = toTrianglesDrawMode( mesh.geometry, TriangleStripDrawMode );\n\n\t\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.TRIANGLE_FAN ) {\n\n\t\t\t\t\t\tmesh.geometry = toTrianglesDrawMode( mesh.geometry, TriangleFanDrawMode );\n\n\t\t\t\t\t}\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINES ) {\n\n\t\t\t\t\tmesh = new LineSegments( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINE_STRIP ) {\n\n\t\t\t\t\tmesh = new Line( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINE_LOOP ) {\n\n\t\t\t\t\tmesh = new LineLoop( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.POINTS ) {\n\n\t\t\t\t\tmesh = new Points( geometry, material );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthrow new Error( 'THREE.GLTFLoader: Primitive mode unsupported: ' + primitive.mode );\n\n\t\t\t\t}\n\n\t\t\t\tif ( Object.keys( mesh.geometry.morphAttributes ).length > 0 ) {\n\n\t\t\t\t\tupdateMorphTargets( mesh, meshDef );\n\n\t\t\t\t}\n\n\t\t\t\tmesh.name = parser.createUniqueName( meshDef.name || ( 'mesh_' + meshIndex ) );\n\n\t\t\t\tassignExtrasToUserData( mesh, meshDef );\n\n\t\t\t\tif ( primitive.extensions ) addUnknownExtensionsToUserData( extensions, mesh, primitive );\n\n\t\t\t\tparser.assignFinalMaterial( mesh );\n\n\t\t\t\tmeshes.push( mesh );\n\n\t\t\t}\n\n\t\t\tfor ( let i = 0, il = meshes.length; i < il; i ++ ) {\n\n\t\t\t\tparser.associations.set( meshes[ i ], {\n\t\t\t\t\tmeshes: meshIndex,\n\t\t\t\t\tprimitives: i\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\tif ( meshes.length === 1 ) {\n\n\t\t\t\tif ( meshDef.extensions ) addUnknownExtensionsToUserData( extensions, meshes[ 0 ], meshDef );\n\n\t\t\t\treturn meshes[ 0 ];\n\n\t\t\t}\n\n\t\t\tconst group = new Group();\n\n\t\t\tif ( meshDef.extensions ) addUnknownExtensionsToUserData( extensions, group, meshDef );\n\n\t\t\tparser.associations.set( group, { meshes: meshIndex } );\n\n\t\t\tfor ( let i = 0, il = meshes.length; i < il; i ++ ) {\n\n\t\t\t\tgroup.add( meshes[ i ] );\n\n\t\t\t}\n\n\t\t\treturn group;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#cameras\n\t *\n\t * @private\n\t * @param {number} cameraIndex\n\t * @return {Promise<THREE.Camera>}\n\t */\n\tloadCamera( cameraIndex ) {\n\n\t\tlet camera;\n\t\tconst cameraDef = this.json.cameras[ cameraIndex ];\n\t\tconst params = cameraDef[ cameraDef.type ];\n\n\t\tif ( ! params ) {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing camera parameters.' );\n\t\t\treturn;\n\n\t\t}\n\n\t\tif ( cameraDef.type === 'perspective' ) {\n\n\t\t\tcamera = new PerspectiveCamera( MathUtils.radToDeg( params.yfov ), params.aspectRatio || 1, params.znear || 1, params.zfar || 2e6 );\n\n\t\t} else if ( cameraDef.type === 'orthographic' ) {\n\n\t\t\tcamera = new OrthographicCamera( - params.xmag, params.xmag, params.ymag, - params.ymag, params.znear, params.zfar );\n\n\t\t}\n\n\t\tif ( cameraDef.name ) camera.name = this.createUniqueName( cameraDef.name );\n\n\t\tassignExtrasToUserData( camera, cameraDef );\n\n\t\treturn Promise.resolve( camera );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#skins\n\t *\n\t * @private\n\t * @param {number} skinIndex\n\t * @return {Promise<Skeleton>}\n\t */\n\tloadSkin( skinIndex ) {\n\n\t\tconst skinDef = this.json.skins[ skinIndex ];\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = skinDef.joints.length; i < il; i ++ ) {\n\n\t\t\tpending.push( this._loadNodeShallow( skinDef.joints[ i ] ) );\n\n\t\t}\n\n\t\tif ( skinDef.inverseBindMatrices !== undefined ) {\n\n\t\t\tpending.push( this.getDependency( 'accessor', skinDef.inverseBindMatrices ) );\n\n\t\t} else {\n\n\t\t\tpending.push( null );\n\n\t\t}\n\n\t\treturn Promise.all( pending ).then( function ( results ) {\n\n\t\t\tconst inverseBindMatrices = results.pop();\n\t\t\tconst jointNodes = results;\n\n\t\t\t// Note that bones (joint nodes) may or may not be in the\n\t\t\t// scene graph at this time.\n\n\t\t\tconst bones = [];\n\t\t\tconst boneInverses = [];\n\n\t\t\tfor ( let i = 0, il = jointNodes.length; i < il; i ++ ) {\n\n\t\t\t\tconst jointNode = jointNodes[ i ];\n\n\t\t\t\tif ( jointNode ) {\n\n\t\t\t\t\tbones.push( jointNode );\n\n\t\t\t\t\tconst mat = new Matrix4();\n\n\t\t\t\t\tif ( inverseBindMatrices !== null ) {\n\n\t\t\t\t\t\tmat.fromArray( inverseBindMatrices.array, i * 16 );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tboneInverses.push( mat );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Joint \"%s\" could not be found.', skinDef.joints[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn new Skeleton( bones, boneInverses );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#animations\n\t *\n\t * @private\n\t * @param {number} animationIndex\n\t * @return {Promise<AnimationClip>}\n\t */\n\tloadAnimation( animationIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst parser = this;\n\n\t\tconst animationDef = json.animations[ animationIndex ];\n\t\tconst animationName = animationDef.name ? animationDef.name : 'animation_' + animationIndex;\n\n\t\tconst pendingNodes = [];\n\t\tconst pendingInputAccessors = [];\n\t\tconst pendingOutputAccessors = [];\n\t\tconst pendingSamplers = [];\n\t\tconst pendingTargets = [];\n\n\t\tfor ( let i = 0, il = animationDef.channels.length; i < il; i ++ ) {\n\n\t\t\tconst channel = animationDef.channels[ i ];\n\t\t\tconst sampler = animationDef.samplers[ channel.sampler ];\n\t\t\tconst target = channel.target;\n\t\t\tconst name = target.node;\n\t\t\tconst input = animationDef.parameters !== undefined ? animationDef.parameters[ sampler.input ] : sampler.input;\n\t\t\tconst output = animationDef.parameters !== undefined ? animationDef.parameters[ sampler.output ] : sampler.output;\n\n\t\t\tif ( target.node === undefined ) continue;\n\n\t\t\tpendingNodes.push( this.getDependency( 'node', name ) );\n\t\t\tpendingInputAccessors.push( this.getDependency( 'accessor', input ) );\n\t\t\tpendingOutputAccessors.push( this.getDependency( 'accessor', output ) );\n\t\t\tpendingSamplers.push( sampler );\n\t\t\tpendingTargets.push( target );\n\n\t\t}\n\n\t\treturn Promise.all( [\n\n\t\t\tPromise.all( pendingNodes ),\n\t\t\tPromise.all( pendingInputAccessors ),\n\t\t\tPromise.all( pendingOutputAccessors ),\n\t\t\tPromise.all( pendingSamplers ),\n\t\t\tPromise.all( pendingTargets )\n\n\t\t] ).then( function ( dependencies ) {\n\n\t\t\tconst nodes = dependencies[ 0 ];\n\t\t\tconst inputAccessors = dependencies[ 1 ];\n\t\t\tconst outputAccessors = dependencies[ 2 ];\n\t\t\tconst samplers = dependencies[ 3 ];\n\t\t\tconst targets = dependencies[ 4 ];\n\n\t\t\tconst tracks = [];\n\n\t\t\tfor ( let i = 0, il = nodes.length; i < il; i ++ ) {\n\n\t\t\t\tconst node = nodes[ i ];\n\t\t\t\tconst inputAccessor = inputAccessors[ i ];\n\t\t\t\tconst outputAccessor = outputAccessors[ i ];\n\t\t\t\tconst sampler = samplers[ i ];\n\t\t\t\tconst target = targets[ i ];\n\n\t\t\t\tif ( node === undefined ) continue;\n\n\t\t\t\tif ( node.updateMatrix ) {\n\n\t\t\t\t\tnode.updateMatrix();\n\n\t\t\t\t}\n\n\t\t\t\tconst createdTracks = parser._createAnimationTracks( node, inputAccessor, outputAccessor, sampler, target );\n\n\t\t\t\tif ( createdTracks ) {\n\n\t\t\t\t\tfor ( let k = 0; k < createdTracks.length; k ++ ) {\n\n\t\t\t\t\t\ttracks.push( createdTracks[ k ] );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn new AnimationClip( animationName, undefined, tracks );\n\n\t\t} );\n\n\t}\n\n\tcreateNodeMesh( nodeIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst parser = this;\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\tif ( nodeDef.mesh === undefined ) return null;\n\n\t\treturn parser.getDependency( 'mesh', nodeDef.mesh ).then( function ( mesh ) {\n\n\t\t\tconst node = parser._getNodeRef( parser.meshCache, nodeDef.mesh, mesh );\n\n\t\t\t// if weights are provided on the node, override weights on the mesh.\n\t\t\tif ( nodeDef.weights !== undefined ) {\n\n\t\t\t\tnode.traverse( function ( o ) {\n\n\t\t\t\t\tif ( ! o.isMesh ) return;\n\n\t\t\t\t\tfor ( let i = 0, il = nodeDef.weights.length; i < il; i ++ ) {\n\n\t\t\t\t\t\to.morphTargetInfluences[ i ] = nodeDef.weights[ i ];\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#nodes-and-hierarchy\n\t *\n\t * @private\n\t * @param {number} nodeIndex\n\t * @return {Promise<Object3D>}\n\t */\n\tloadNode( nodeIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst parser = this;\n\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\tconst nodePending = parser._loadNodeShallow( nodeIndex );\n\n\t\tconst childPending = [];\n\t\tconst childrenDef = nodeDef.children || [];\n\n\t\tfor ( let i = 0, il = childrenDef.length; i < il; i ++ ) {\n\n\t\t\tchildPending.push( parser.getDependency( 'node', childrenDef[ i ] ) );\n\n\t\t}\n\n\t\tconst skeletonPending = nodeDef.skin === undefined\n\t\t\t? Promise.resolve( null )\n\t\t\t: parser.getDependency( 'skin', nodeDef.skin );\n\n\t\treturn Promise.all( [\n\t\t\tnodePending,\n\t\t\tPromise.all( childPending ),\n\t\t\tskeletonPending\n\t\t] ).then( function ( results ) {\n\n\t\t\tconst node = results[ 0 ];\n\t\t\tconst children = results[ 1 ];\n\t\t\tconst skeleton = results[ 2 ];\n\n\t\t\tif ( skeleton !== null ) {\n\n\t\t\t\t// This full traverse should be fine because\n\t\t\t\t// child glTF nodes have not been added to this node yet.\n\t\t\t\tnode.traverse( function ( mesh ) {\n\n\t\t\t\t\tif ( ! mesh.isSkinnedMesh ) return;\n\n\t\t\t\t\tmesh.bind( skeleton, _identityMatrix );\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\tfor ( let i = 0, il = children.length; i < il; i ++ ) {\n\n\t\t\t\tnode.add( children[ i ] );\n\n\t\t\t}\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t}\n\n\t// ._loadNodeShallow() parses a single node.\n\t// skin and child nodes are created and added in .loadNode() (no '_' prefix).\n\t_loadNodeShallow( nodeIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\t\tconst parser = this;\n\n\t\t// This method is called from .loadNode() and .loadSkin().\n\t\t// Cache a node to avoid duplication.\n\n\t\tif ( this.nodeCache[ nodeIndex ] !== undefined ) {\n\n\t\t\treturn this.nodeCache[ nodeIndex ];\n\n\t\t}\n\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\t// reserve node's name before its dependencies, so the root has the intended name.\n\t\tconst nodeName = nodeDef.name ? parser.createUniqueName( nodeDef.name ) : '';\n\n\t\tconst pending = [];\n\n\t\tconst meshPromise = parser._invokeOne( function ( ext ) {\n\n\t\t\treturn ext.createNodeMesh && ext.createNodeMesh( nodeIndex );\n\n\t\t} );\n\n\t\tif ( meshPromise ) {\n\n\t\t\tpending.push( meshPromise );\n\n\t\t}\n\n\t\tif ( nodeDef.camera !== undefined ) {\n\n\t\t\tpending.push( parser.getDependency( 'camera', nodeDef.camera ).then( function ( camera ) {\n\n\t\t\t\treturn parser._getNodeRef( parser.cameraCache, nodeDef.camera, camera );\n\n\t\t\t} ) );\n\n\t\t}\n\n\t\tparser._invokeAll( function ( ext ) {\n\n\t\t\treturn ext.createNodeAttachment && ext.createNodeAttachment( nodeIndex );\n\n\t\t} ).forEach( function ( promise ) {\n\n\t\t\tpending.push( promise );\n\n\t\t} );\n\n\t\tthis.nodeCache[ nodeIndex ] = Promise.all( pending ).then( function ( objects ) {\n\n\t\t\tlet node;\n\n\t\t\t// .isBone isn't in glTF spec. See ._markDefs\n\t\t\tif ( nodeDef.isBone === true ) {\n\n\t\t\t\tnode = new Bone();\n\n\t\t\t} else if ( objects.length > 1 ) {\n\n\t\t\t\tnode = new Group();\n\n\t\t\t} else if ( objects.length === 1 ) {\n\n\t\t\t\tnode = objects[ 0 ];\n\n\t\t\t} else {\n\n\t\t\t\tnode = new Object3D();\n\n\t\t\t}\n\n\t\t\tif ( node !== objects[ 0 ] ) {\n\n\t\t\t\tfor ( let i = 0, il = objects.length; i < il; i ++ ) {\n\n\t\t\t\t\tnode.add( objects[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( nodeDef.name ) {\n\n\t\t\t\tnode.userData.name = nodeDef.name;\n\t\t\t\tnode.name = nodeName;\n\n\t\t\t}\n\n\t\t\tassignExtrasToUserData( node, nodeDef );\n\n\t\t\tif ( nodeDef.extensions ) addUnknownExtensionsToUserData( extensions, node, nodeDef );\n\n\t\t\tif ( nodeDef.matrix !== undefined ) {\n\n\t\t\t\tconst matrix = new Matrix4();\n\t\t\t\tmatrix.fromArray( nodeDef.matrix );\n\t\t\t\tnode.applyMatrix4( matrix );\n\n\t\t\t} else {\n\n\t\t\t\tif ( nodeDef.translation !== undefined ) {\n\n\t\t\t\t\tnode.position.fromArray( nodeDef.translation );\n\n\t\t\t\t}\n\n\t\t\t\tif ( nodeDef.rotation !== undefined ) {\n\n\t\t\t\t\tnode.quaternion.fromArray( nodeDef.rotation );\n\n\t\t\t\t}\n\n\t\t\t\tif ( nodeDef.scale !== undefined ) {\n\n\t\t\t\t\tnode.scale.fromArray( nodeDef.scale );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( ! parser.associations.has( node ) ) {\n\n\t\t\t\tparser.associations.set( node, {} );\n\n\t\t\t}\n\n\t\t\tparser.associations.get( node ).nodes = nodeIndex;\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t\treturn this.nodeCache[ nodeIndex ];\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#scenes\n\t *\n\t * @private\n\t * @param {number} sceneIndex\n\t * @return {Promise<Group>}\n\t */\n\tloadScene( sceneIndex ) {\n\n\t\tconst extensions = this.extensions;\n\t\tconst sceneDef = this.json.scenes[ sceneIndex ];\n\t\tconst parser = this;\n\n\t\t// Loader returns Group, not Scene.\n\t\t// See: https://github.com/mrdoob/three.js/issues/18342#issuecomment-578981172\n\t\tconst scene = new Group();\n\t\tif ( sceneDef.name ) scene.name = parser.createUniqueName( sceneDef.name );\n\n\t\tassignExtrasToUserData( scene, sceneDef );\n\n\t\tif ( sceneDef.extensions ) addUnknownExtensionsToUserData( extensions, scene, sceneDef );\n\n\t\tconst nodeIds = sceneDef.nodes || [];\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = nodeIds.length; i < il; i ++ ) {\n\n\t\t\tpending.push( parser.getDependency( 'node', nodeIds[ i ] ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending ).then( function ( nodes ) {\n\n\t\t\tfor ( let i = 0, il = nodes.length; i < il; i ++ ) {\n\n\t\t\t\tscene.add( nodes[ i ] );\n\n\t\t\t}\n\n\t\t\t// Removes dangling associations, associations that reference a node that\n\t\t\t// didn't make it into the scene.\n\t\t\tconst reduceAssociations = ( node ) => {\n\n\t\t\t\tconst reducedAssociations = new Map();\n\n\t\t\t\tfor ( const [ key, value ] of parser.associations ) {\n\n\t\t\t\t\tif ( key instanceof Material || key instanceof Texture ) {\n\n\t\t\t\t\t\treducedAssociations.set( key, value );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tnode.traverse( ( node ) => {\n\n\t\t\t\t\tconst mappings = parser.associations.get( node );\n\n\t\t\t\t\tif ( mappings != null ) {\n\n\t\t\t\t\t\treducedAssociations.set( node, mappings );\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t\treturn reducedAssociations;\n\n\t\t\t};\n\n\t\t\tparser.associations = reduceAssociations( scene );\n\n\t\t\treturn scene;\n\n\t\t} );\n\n\t}\n\n\t_createAnimationTracks( node, inputAccessor, outputAccessor, sampler, target ) {\n\n\t\tconst tracks = [];\n\n\t\tconst targetName = node.name ? node.name : node.uuid;\n\t\tconst targetNames = [];\n\n\t\tif ( PATH_PROPERTIES[ target.path ] === PATH_PROPERTIES.weights ) {\n\n\t\t\tnode.traverse( function ( object ) {\n\n\t\t\t\tif ( object.morphTargetInfluences ) {\n\n\t\t\t\t\ttargetNames.push( object.name ? object.name : object.uuid );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\ttargetNames.push( targetName );\n\n\t\t}\n\n\t\tlet TypedKeyframeTrack;\n\n\t\tswitch ( PATH_PROPERTIES[ target.path ] ) {\n\n\t\t\tcase PATH_PROPERTIES.weights:\n\n\t\t\t\tTypedKeyframeTrack = NumberKeyframeTrack;\n\t\t\t\tbreak;\n\n\t\t\tcase PATH_PROPERTIES.rotation:\n\n\t\t\t\tTypedKeyframeTrack = QuaternionKeyframeTrack;\n\t\t\t\tbreak;\n\n\t\t\tcase PATH_PROPERTIES.translation:\n\t\t\tcase PATH_PROPERTIES.scale:\n\n\t\t\t\tTypedKeyframeTrack = VectorKeyframeTrack;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\n\t\t\t\tswitch ( outputAccessor.itemSize ) {\n\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\tTypedKeyframeTrack = NumberKeyframeTrack;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\tcase 3:\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tTypedKeyframeTrack = VectorKeyframeTrack;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t}\n\n\t\tconst interpolation = sampler.interpolation !== undefined ? INTERPOLATION[ sampler.interpolation ] : InterpolateLinear;\n\n\n\t\tconst outputArray = this._getArrayFromAccessor( outputAccessor );\n\n\t\tfor ( let j = 0, jl = targetNames.length; j < jl; j ++ ) {\n\n\t\t\tconst track = new TypedKeyframeTrack(\n\t\t\t\ttargetNames[ j ] + '.' + PATH_PROPERTIES[ target.path ],\n\t\t\t\tinputAccessor.array,\n\t\t\t\toutputArray,\n\t\t\t\tinterpolation\n\t\t\t);\n\n\t\t\t// Override interpolation with custom factory method.\n\t\t\tif ( sampler.interpolation === 'CUBICSPLINE' ) {\n\n\t\t\t\tthis._createCubicSplineTrackInterpolant( track );\n\n\t\t\t}\n\n\t\t\ttracks.push( track );\n\n\t\t}\n\n\t\treturn tracks;\n\n\t}\n\n\t_getArrayFromAccessor( accessor ) {\n\n\t\tlet outputArray = accessor.array;\n\n\t\tif ( accessor.normalized ) {\n\n\t\t\tconst scale = getNormalizedComponentScale( outputArray.constructor );\n\t\t\tconst scaled = new Float32Array( outputArray.length );\n\n\t\t\tfor ( let j = 0, jl = outputArray.length; j < jl; j ++ ) {\n\n\t\t\t\tscaled[ j ] = outputArray[ j ] * scale;\n\n\t\t\t}\n\n\t\t\toutputArray = scaled;\n\n\t\t}\n\n\t\treturn outputArray;\n\n\t}\n\n\t_createCubicSplineTrackInterpolant( track ) {\n\n\t\ttrack.createInterpolant = function InterpolantFactoryMethodGLTFCubicSpline( result ) {\n\n\t\t\t// A CUBICSPLINE keyframe in glTF has three output values for each input value,\n\t\t\t// representing inTangent, splineVertex, and outTangent. As a result, track.getValueSize()\n\t\t\t// must be divided by three to get the interpolant's sampleSize argument.\n\n\t\t\tconst interpolantType = ( this instanceof QuaternionKeyframeTrack ) ? GLTFCubicSplineQuaternionInterpolant : GLTFCubicSplineInterpolant;\n\n\t\t\treturn new interpolantType( this.times, this.values, this.getValueSize() / 3, result );\n\n\t\t};\n\n\t\t// Mark as CUBICSPLINE. `track.getInterpolation()` doesn't support custom interpolants.\n\t\ttrack.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline = true;\n\n\t}\n\n}\n\n/**\n *\n * @private\n * @param {BufferGeometry} geometry\n * @param {GLTF.Primitive} primitiveDef\n * @param {GLTFParser} parser\n */\nfunction computeBounds( geometry, primitiveDef, parser ) {\n\n\tconst attributes = primitiveDef.attributes;\n\n\tconst box = new Box3();\n\n\tif ( attributes.POSITION !== undefined ) {\n\n\t\tconst accessor = parser.json.accessors[ attributes.POSITION ];\n\n\t\tconst min = accessor.min;\n\t\tconst max = accessor.max;\n\n\t\t// glTF requires 'min' and 'max', but VRM (which extends glTF) currently ignores that requirement.\n\n\t\tif ( min !== undefined && max !== undefined ) {\n\n\t\t\tbox.set(\n\t\t\t\tnew Vector3( min[ 0 ], min[ 1 ], min[ 2 ] ),\n\t\t\t\tnew Vector3( max[ 0 ], max[ 1 ], max[ 2 ] )\n\t\t\t);\n\n\t\t\tif ( accessor.normalized ) {\n\n\t\t\t\tconst boxScale = getNormalizedComponentScale( WEBGL_COMPONENT_TYPES[ accessor.componentType ] );\n\t\t\t\tbox.min.multiplyScalar( boxScale );\n\t\t\t\tbox.max.multiplyScalar( boxScale );\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing min/max properties for accessor POSITION.' );\n\n\t\t\treturn;\n\n\t\t}\n\n\t} else {\n\n\t\treturn;\n\n\t}\n\n\tconst targets = primitiveDef.targets;\n\n\tif ( targets !== undefined ) {\n\n\t\tconst maxDisplacement = new Vector3();\n\t\tconst vector = new Vector3();\n\n\t\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\t\tconst target = targets[ i ];\n\n\t\t\tif ( target.POSITION !== undefined ) {\n\n\t\t\t\tconst accessor = parser.json.accessors[ target.POSITION ];\n\t\t\t\tconst min = accessor.min;\n\t\t\t\tconst max = accessor.max;\n\n\t\t\t\t// glTF requires 'min' and 'max', but VRM (which extends glTF) currently ignores that requirement.\n\n\t\t\t\tif ( min !== undefined && max !== undefined ) {\n\n\t\t\t\t\t// we need to get max of absolute components because target weight is [-1,1]\n\t\t\t\t\tvector.setX( Math.max( Math.abs( min[ 0 ] ), Math.abs( max[ 0 ] ) ) );\n\t\t\t\t\tvector.setY( Math.max( Math.abs( min[ 1 ] ), Math.abs( max[ 1 ] ) ) );\n\t\t\t\t\tvector.setZ( Math.max( Math.abs( min[ 2 ] ), Math.abs( max[ 2 ] ) ) );\n\n\n\t\t\t\t\tif ( accessor.normalized ) {\n\n\t\t\t\t\t\tconst boxScale = getNormalizedComponentScale( WEBGL_COMPONENT_TYPES[ accessor.componentType ] );\n\t\t\t\t\t\tvector.multiplyScalar( boxScale );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// Note: this assumes that the sum of all weights is at most 1. This isn't quite correct - it's more conservative\n\t\t\t\t\t// to assume that each target can have a max weight of 1. However, for some use cases - notably, when morph targets\n\t\t\t\t\t// are used to implement key-frame animations and as such only two are active at a time - this results in very large\n\t\t\t\t\t// boxes. So for now we make a box that's sometimes a touch too small but is hopefully mostly of reasonable size.\n\t\t\t\t\tmaxDisplacement.max( vector );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing min/max properties for accessor POSITION.' );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// As per comment above this box isn't conservative, but has a reasonable size for a very large number of morph targets.\n\t\tbox.expandByVector( maxDisplacement );\n\n\t}\n\n\tgeometry.boundingBox = box;\n\n\tconst sphere = new Sphere();\n\n\tbox.getCenter( sphere.center );\n\tsphere.radius = box.min.distanceTo( box.max ) / 2;\n\n\tgeometry.boundingSphere = sphere;\n\n}\n\n/**\n *\n * @private\n * @param {BufferGeometry} geometry\n * @param {GLTF.Primitive} primitiveDef\n * @param {GLTFParser} parser\n * @return {Promise<BufferGeometry>}\n */\nfunction addPrimitiveAttributes( geometry, primitiveDef, parser ) {\n\n\tconst attributes = primitiveDef.attributes;\n\n\tconst pending = [];\n\n\tfunction assignAttributeAccessor( accessorIndex, attributeName ) {\n\n\t\treturn parser.getDependency( 'accessor', accessorIndex )\n\t\t\t.then( function ( accessor ) {\n\n\t\t\t\tgeometry.setAttribute( attributeName, accessor );\n\n\t\t\t} );\n\n\t}\n\n\tfor ( const gltfAttributeName in attributes ) {\n\n\t\tconst threeAttributeName = ATTRIBUTES[ gltfAttributeName ] || gltfAttributeName.toLowerCase();\n\n\t\t// Skip attributes already provided by e.g. Draco extension.\n\t\tif ( threeAttributeName in geometry.attributes ) continue;\n\n\t\tpending.push( assignAttributeAccessor( attributes[ gltfAttributeName ], threeAttributeName ) );\n\n\t}\n\n\tif ( primitiveDef.indices !== undefined && ! geometry.index ) {\n\n\t\tconst accessor = parser.getDependency( 'accessor', primitiveDef.indices ).then( function ( accessor ) {\n\n\t\t\tgeometry.setIndex( accessor );\n\n\t\t} );\n\n\t\tpending.push( accessor );\n\n\t}\n\n\tif ( ColorManagement.workingColorSpace !== LinearSRGBColorSpace && 'COLOR_0' in attributes ) {\n\n\t\tconsole.warn( `THREE.GLTFLoader: Converting vertex colors from \"srgb-linear\" to \"${ColorManagement.workingColorSpace}\" not supported.` );\n\n\t}\n\n\tassignExtrasToUserData( geometry, primitiveDef );\n\n\tcomputeBounds( geometry, primitiveDef, parser );\n\n\treturn Promise.all( pending ).then( function () {\n\n\t\treturn primitiveDef.targets !== undefined\n\t\t\t? addMorphTargets( geometry, primitiveDef.targets, parser )\n\t\t\t: geometry;\n\n\t} );\n\n}\n\n/**\n * Loader result of `GLTFLoader`.\n *\n * @typedef {Object} GLTFLoader~LoadObject\n * @property {Array<AnimationClip>} animations - An array of animation clips.\n * @property {Object} asset - Meta data about the loaded asset.\n * @property {Array<Camera>} cameras - An array of cameras.\n * @property {GLTFParser} parser - A reference to the internal parser.\n * @property {Group} scene - The default scene.\n * @property {Array<Group>} scenes - glTF assets might define multiple scenes.\n * @property {Object} userData - Additional data.\n **/\n\nexport { GLTFLoader };\n","/** @module CopyShader */\n\n/**\n * Full-screen copy shader pass.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst CopyShader = {\n\n\tname: 'CopyShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'opacity': { value: 1.0 }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}`\n\n};\n\nexport { CopyShader };\n","import {\n\tBufferGeometry,\n\tFloat32BufferAttribute,\n\tOrthographicCamera,\n\tMesh\n} from 'three';\n\n/**\n * Abstract base class for all post processing passes.\n *\n * This module is only relevant for post processing with {@link WebGLRenderer}.\n *\n * @abstract\n */\nclass Pass {\n\n\t/**\n\t * Constructs a new pass.\n\t */\n\tconstructor() {\n\n\t\t/**\n\t\t * This flag can be used for type testing.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @readonly\n\t\t * @default true\n\t\t */\n\t\tthis.isPass = true;\n\n\t\t/**\n\t\t * If set to `true`, the pass is processed by the composer.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default true\n\t\t */\n\t\tthis.enabled = true;\n\n\t\t/**\n\t\t * If set to `true`, the pass indicates to swap read and write buffer after rendering.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default true\n\t\t */\n\t\tthis.needsSwap = true;\n\n\t\t/**\n\t\t * If set to `true`, the pass clears its buffer before rendering\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.clear = false;\n\n\t\t/**\n\t\t * If set to `true`, the result of the pass is rendered to screen. The last pass in the composers\n\t\t * pass chain gets automatically rendered to screen, no matter how this property is configured.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.renderToScreen = false;\n\n\t}\n\n\t/**\n\t * Sets the size of the pass.\n\t *\n\t * @abstract\n\t * @param {number} width - The width to set.\n\t * @param {number} height - The width to set.\n\t */\n\tsetSize( /* width, height */ ) {}\n\n\t/**\n\t * This method holds the render logic of a pass. It must be implemented in all derived classes.\n\t *\n\t * @abstract\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( /* renderer, writeBuffer, readBuffer, deltaTime, maskActive */ ) {\n\n\t\tconsole.error( 'THREE.Pass: .render() must be implemented in derived pass.' );\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this\n\t * method whenever the pass is no longer used in your app.\n\t *\n\t * @abstract\n\t */\n\tdispose() {}\n\n}\n\n// Helper for passes that need to fill the viewport with a single quad.\n\nconst _camera = new OrthographicCamera( - 1, 1, 1, - 1, 0, 1 );\n\n// https://github.com/mrdoob/three.js/pull/21358\n\nclass FullscreenTriangleGeometry extends BufferGeometry {\n\n\tconstructor() {\n\n\t\tsuper();\n\n\t\tthis.setAttribute( 'position', new Float32BufferAttribute( [ - 1, 3, 0, - 1, - 1, 0, 3, - 1, 0 ], 3 ) );\n\t\tthis.setAttribute( 'uv', new Float32BufferAttribute( [ 0, 2, 0, 0, 2, 0 ], 2 ) );\n\n\t}\n\n}\n\nconst _geometry = new FullscreenTriangleGeometry();\n\n\n/**\n * This module is a helper for passes which need to render a full\n * screen effect which is quite common in context of post processing.\n *\n * The intended usage is to reuse a single full screen quad for rendering\n * subsequent passes by just reassigning the `material` reference.\n *\n * This module can only be used with {@link WebGLRenderer}.\n *\n * @augments Mesh\n */\nclass FullScreenQuad {\n\n\t/**\n\t * Constructs a new full screen quad.\n\t *\n\t * @param {?Material} material - The material to render te full screen quad with.\n\t */\n\tconstructor( material ) {\n\n\t\tthis._mesh = new Mesh( _geometry, material );\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this\n\t * method whenever the instance is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tthis._mesh.geometry.dispose();\n\n\t}\n\n\t/**\n\t * Renders the full screen quad.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t */\n\trender( renderer ) {\n\n\t\trenderer.render( this._mesh, _camera );\n\n\t}\n\n\t/**\n\t * The quad's material.\n\t *\n\t * @type {?Material}\n\t */\n\tget material() {\n\n\t\treturn this._mesh.material;\n\n\t}\n\n\tset material( value ) {\n\n\t\tthis._mesh.material = value;\n\n\t}\n\n}\n\nexport { Pass, FullScreenQuad };\n","import {\n\tShaderMaterial,\n\tUniformsUtils\n} from 'three';\nimport { Pass, FullScreenQuad } from './Pass.js';\n\n/**\n * This pass can be used to create a post processing effect\n * with a raw GLSL shader object. Useful for implementing custom\n * effects.\n *\n * ```js\n * const fxaaPass = new ShaderPass( FXAAShader );\n * composer.addPass( fxaaPass );\n * ```\n *\n * @augments Pass\n */\nclass ShaderPass extends Pass {\n\n\t/**\n\t * Constructs a new shader pass.\n\t *\n\t * @param {Object|ShaderMaterial} [shader] - A shader object holding vertex and fragment shader as well as\n\t * defines and uniforms. It's also valid to pass a custom shader material.\n\t * @param {string} [textureID='tDiffuse'] - The name of the texture uniform that should sample\n\t * the read buffer.\n\t */\n\tconstructor( shader, textureID = 'tDiffuse' ) {\n\n\t\tsuper();\n\n\t\t/**\n\t\t * The name of the texture uniform that should sample the read buffer.\n\t\t *\n\t\t * @type {string}\n\t\t * @default 'tDiffuse'\n\t\t */\n\t\tthis.textureID = textureID;\n\n\t\t/**\n\t\t * The pass uniforms.\n\t\t *\n\t\t * @type {?Object}\n\t\t */\n\t\tthis.uniforms = null;\n\n\t\t/**\n\t\t * The pass material.\n\t\t *\n\t\t * @type {?ShaderMaterial}\n\t\t */\n\t\tthis.material = null;\n\n\t\tif ( shader instanceof ShaderMaterial ) {\n\n\t\t\tthis.uniforms = shader.uniforms;\n\n\t\t\tthis.material = shader;\n\n\t\t} else if ( shader ) {\n\n\t\t\tthis.uniforms = UniformsUtils.clone( shader.uniforms );\n\n\t\t\tthis.material = new ShaderMaterial( {\n\n\t\t\t\tname: ( shader.name !== undefined ) ? shader.name : 'unspecified',\n\t\t\t\tdefines: Object.assign( {}, shader.defines ),\n\t\t\t\tuniforms: this.uniforms,\n\t\t\t\tvertexShader: shader.vertexShader,\n\t\t\t\tfragmentShader: shader.fragmentShader\n\n\t\t\t} );\n\n\t\t}\n\n\t\t// internals\n\n\t\tthis._fsQuad = new FullScreenQuad( this.material );\n\n\t}\n\n\t/**\n\t * Performs the shader pass.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( renderer, writeBuffer, readBuffer /*, deltaTime, maskActive */ ) {\n\n\t\tif ( this.uniforms[ this.textureID ] ) {\n\n\t\t\tthis.uniforms[ this.textureID ].value = readBuffer.texture;\n\n\t\t}\n\n\t\tthis._fsQuad.material = this.material;\n\n\t\tif ( this.renderToScreen ) {\n\n\t\t\trenderer.setRenderTarget( null );\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t} else {\n\n\t\t\trenderer.setRenderTarget( writeBuffer );\n\t\t\t// TODO: Avoid using autoClear properties, see https://github.com/mrdoob/three.js/pull/15571#issuecomment-465669600\n\t\t\tif ( this.clear ) renderer.clear( renderer.autoClearColor, renderer.autoClearDepth, renderer.autoClearStencil );\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this\n\t * method whenever the pass is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tthis.material.dispose();\n\n\t\tthis._fsQuad.dispose();\n\n\t}\n\n}\n\nexport { ShaderPass };\n","import { Pass } from './Pass.js';\n\n/**\n * This pass can be used to define a mask during post processing.\n * Meaning only areas of subsequent post processing are affected\n * which lie in the masking area of this pass. Internally, the masking\n * is implemented with the stencil buffer.\n *\n * ```js\n * const maskPass = new MaskPass( scene, camera );\n * composer.addPass( maskPass );\n * ```\n *\n * @augments Pass\n */\nclass MaskPass extends Pass {\n\n\t/**\n\t * Constructs a new mask pass.\n\t *\n\t * @param {Scene} scene - The 3D objects in this scene will define the mask.\n\t * @param {Camera} camera - The camera.\n\t */\n\tconstructor( scene, camera ) {\n\n\t\tsuper();\n\n\t\t/**\n\t\t * The scene that defines the mask.\n\t\t *\n\t\t * @type {Scene}\n\t\t */\n\t\tthis.scene = scene;\n\n\t\t/**\n\t\t * The camera.\n\t\t *\n\t\t * @type {Camera}\n\t\t */\n\t\tthis.camera = camera;\n\n\t\t/**\n\t\t * Overwritten to perform a clear operation by default.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default true\n\t\t */\n\t\tthis.clear = true;\n\n\t\t/**\n\t\t * Overwritten to disable the swap.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.needsSwap = false;\n\n\t\t/**\n\t\t * Whether to inverse the mask or not.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.inverse = false;\n\n\t}\n\n\t/**\n\t * Performs a mask pass with the configured scene and camera.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( renderer, writeBuffer, readBuffer /*, deltaTime, maskActive */ ) {\n\n\t\tconst context = renderer.getContext();\n\t\tconst state = renderer.state;\n\n\t\t// don't update color or depth\n\n\t\tstate.buffers.color.setMask( false );\n\t\tstate.buffers.depth.setMask( false );\n\n\t\t// lock buffers\n\n\t\tstate.buffers.color.setLocked( true );\n\t\tstate.buffers.depth.setLocked( true );\n\n\t\t// set up stencil\n\n\t\tlet writeValue, clearValue;\n\n\t\tif ( this.inverse ) {\n\n\t\t\twriteValue = 0;\n\t\t\tclearValue = 1;\n\n\t\t} else {\n\n\t\t\twriteValue = 1;\n\t\t\tclearValue = 0;\n\n\t\t}\n\n\t\tstate.buffers.stencil.setTest( true );\n\t\tstate.buffers.stencil.setOp( context.REPLACE, context.REPLACE, context.REPLACE );\n\t\tstate.buffers.stencil.setFunc( context.ALWAYS, writeValue, 0xffffffff );\n\t\tstate.buffers.stencil.setClear( clearValue );\n\t\tstate.buffers.stencil.setLocked( true );\n\n\t\t// draw into the stencil buffer\n\n\t\trenderer.setRenderTarget( readBuffer );\n\t\tif ( this.clear ) renderer.clear();\n\t\trenderer.render( this.scene, this.camera );\n\n\t\trenderer.setRenderTarget( writeBuffer );\n\t\tif ( this.clear ) renderer.clear();\n\t\trenderer.render( this.scene, this.camera );\n\n\t\t// unlock color and depth buffer and make them writable for subsequent rendering/clearing\n\n\t\tstate.buffers.color.setLocked( false );\n\t\tstate.buffers.depth.setLocked( false );\n\n\t\tstate.buffers.color.setMask( true );\n\t\tstate.buffers.depth.setMask( true );\n\n\t\t// only render where stencil is set to 1\n\n\t\tstate.buffers.stencil.setLocked( false );\n\t\tstate.buffers.stencil.setFunc( context.EQUAL, 1, 0xffffffff ); // draw if == 1\n\t\tstate.buffers.stencil.setOp( context.KEEP, context.KEEP, context.KEEP );\n\t\tstate.buffers.stencil.setLocked( true );\n\n\t}\n\n}\n\n/**\n * This pass can be used to clear a mask previously defined with {@link MaskPass}.\n *\n * ```js\n * const clearPass = new ClearMaskPass();\n * composer.addPass( clearPass );\n * ```\n *\n * @augments Pass\n */\nclass ClearMaskPass extends Pass {\n\n\t/**\n\t * Constructs a new clear mask pass.\n\t */\n\tconstructor() {\n\n\t\tsuper();\n\n\t\t/**\n\t\t * Overwritten to disable the swap.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.needsSwap = false;\n\n\t}\n\n\t/**\n\t * Performs the clear of the currently defined mask.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( renderer /*, writeBuffer, readBuffer, deltaTime, maskActive */ ) {\n\n\t\trenderer.state.buffers.stencil.setLocked( false );\n\t\trenderer.state.buffers.stencil.setTest( false );\n\n\t}\n\n}\n\nexport { MaskPass, ClearMaskPass };\n","import {\n\tClock,\n\tHalfFloatType,\n\tNoBlending,\n\tVector2,\n\tWebGLRenderTarget\n} from 'three';\nimport { CopyShader } from '../shaders/CopyShader.js';\nimport { ShaderPass } from './ShaderPass.js';\nimport { ClearMaskPass, MaskPass } from './MaskPass.js';\n\n/**\n * Used to implement post-processing effects in three.js.\n * The class manages a chain of post-processing passes to produce the final visual result.\n * Post-processing passes are executed in order of their addition/insertion.\n * The last pass is automatically rendered to screen.\n *\n * This module can only be used with {@link WebGLRenderer}.\n *\n * ```js\n * const composer = new EffectComposer( renderer );\n *\n * // adding some passes\n * const renderPass = new RenderPass( scene, camera );\n * composer.addPass( renderPass );\n *\n * const glitchPass = new GlitchPass();\n * composer.addPass( glitchPass );\n *\n * const outputPass = new OutputPass()\n * composer.addPass( outputPass );\n *\n * function animate() {\n *\n * \tcomposer.render(); // instead of renderer.render()\n *\n * }\n * ```\n */\nclass EffectComposer {\n\n\t/**\n\t * Constructs a new effect composer.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} [renderTarget] - This render target and a clone will\n\t * be used as the internal read and write buffers. If not given, the composer creates\n\t * the buffers automatically.\n\t */\n\tconstructor( renderer, renderTarget ) {\n\n\t\t/**\n\t\t * The renderer.\n\t\t *\n\t\t * @type {WebGLRenderer}\n\t\t */\n\t\tthis.renderer = renderer;\n\n\t\tthis._pixelRatio = renderer.getPixelRatio();\n\n\t\tif ( renderTarget === undefined ) {\n\n\t\t\tconst size = renderer.getSize( new Vector2() );\n\t\t\tthis._width = size.width;\n\t\t\tthis._height = size.height;\n\n\t\t\trenderTarget = new WebGLRenderTarget( this._width * this._pixelRatio, this._height * this._pixelRatio, { type: HalfFloatType } );\n\t\t\trenderTarget.texture.name = 'EffectComposer.rt1';\n\n\t\t} else {\n\n\t\t\tthis._width = renderTarget.width;\n\t\t\tthis._height = renderTarget.height;\n\n\t\t}\n\n\t\tthis.renderTarget1 = renderTarget;\n\t\tthis.renderTarget2 = renderTarget.clone();\n\t\tthis.renderTarget2.texture.name = 'EffectComposer.rt2';\n\n\t\t/**\n\t\t * A reference to the internal write buffer. Passes usually write\n\t\t * their result into this buffer.\n\t\t *\n\t\t * @type {WebGLRenderTarget}\n\t\t */\n\t\tthis.writeBuffer = this.renderTarget1;\n\n\t\t/**\n\t\t * A reference to the internal read buffer. Passes usually read\n\t\t * the previous render result from this buffer.\n\t\t *\n\t\t * @type {WebGLRenderTarget}\n\t\t */\n\t\tthis.readBuffer = this.renderTarget2;\n\n\t\t/**\n\t\t * Whether the final pass is rendered to the screen (default framebuffer) or not.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default true\n\t\t */\n\t\tthis.renderToScreen = true;\n\n\t\t/**\n\t\t * An array representing the (ordered) chain of post-processing passes.\n\t\t *\n\t\t * @type {Array<Pass>}\n\t\t */\n\t\tthis.passes = [];\n\n\t\t/**\n\t\t * A copy pass used for internal swap operations.\n\t\t *\n\t\t * @private\n\t\t * @type {ShaderPass}\n\t\t */\n\t\tthis.copyPass = new ShaderPass( CopyShader );\n\t\tthis.copyPass.material.blending = NoBlending;\n\n\t\t/**\n\t\t * The intenral clock for managing time data.\n\t\t *\n\t\t * @private\n\t\t * @type {Clock}\n\t\t */\n\t\tthis.clock = new Clock();\n\n\t}\n\n\t/**\n\t * Swaps the internal read/write buffers.\n\t */\n\tswapBuffers() {\n\n\t\tconst tmp = this.readBuffer;\n\t\tthis.readBuffer = this.writeBuffer;\n\t\tthis.writeBuffer = tmp;\n\n\t}\n\n\t/**\n\t * Adds the given pass to the pass chain.\n\t *\n\t * @param {Pass} pass - The pass to add.\n\t */\n\taddPass( pass ) {\n\n\t\tthis.passes.push( pass );\n\t\tpass.setSize( this._width * this._pixelRatio, this._height * this._pixelRatio );\n\n\t}\n\n\t/**\n\t * Inserts the given pass at a given index.\n\t *\n\t * @param {Pass} pass - The pass to insert.\n\t * @param {number} index - The index into the pass chain.\n\t */\n\tinsertPass( pass, index ) {\n\n\t\tthis.passes.splice( index, 0, pass );\n\t\tpass.setSize( this._width * this._pixelRatio, this._height * this._pixelRatio );\n\n\t}\n\n\t/**\n\t * Removes the given pass from the pass chain.\n\t *\n\t * @param {Pass} pass - The pass to remove.\n\t */\n\tremovePass( pass ) {\n\n\t\tconst index = this.passes.indexOf( pass );\n\n\t\tif ( index !== - 1 ) {\n\n\t\t\tthis.passes.splice( index, 1 );\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Returns `true` if the pass for the given index is the last enabled pass in the pass chain.\n\t *\n\t * @param {number} passIndex - The pass index.\n\t * @return {boolean} Whether the the pass for the given index is the last pass in the pass chain.\n\t */\n\tisLastEnabledPass( passIndex ) {\n\n\t\tfor ( let i = passIndex + 1; i < this.passes.length; i ++ ) {\n\n\t\t\tif ( this.passes[ i ].enabled ) {\n\n\t\t\t\treturn false;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn true;\n\n\t}\n\n\t/**\n\t * Executes all enabled post-processing passes in order to produce the final frame.\n\t *\n\t * @param {number} deltaTime - The delta time in seconds. If not given, the composer computes\n\t * its own time delta value.\n\t */\n\trender( deltaTime ) {\n\n\t\t// deltaTime value is in seconds\n\n\t\tif ( deltaTime === undefined ) {\n\n\t\t\tdeltaTime = this.clock.getDelta();\n\n\t\t}\n\n\t\tconst currentRenderTarget = this.renderer.getRenderTarget();\n\n\t\tlet maskActive = false;\n\n\t\tfor ( let i = 0, il = this.passes.length; i < il; i ++ ) {\n\n\t\t\tconst pass = this.passes[ i ];\n\n\t\t\tif ( pass.enabled === false ) continue;\n\n\t\t\tpass.renderToScreen = ( this.renderToScreen && this.isLastEnabledPass( i ) );\n\t\t\tpass.render( this.renderer, this.writeBuffer, this.readBuffer, deltaTime, maskActive );\n\n\t\t\tif ( pass.needsSwap ) {\n\n\t\t\t\tif ( maskActive ) {\n\n\t\t\t\t\tconst context = this.renderer.getContext();\n\t\t\t\t\tconst stencil = this.renderer.state.buffers.stencil;\n\n\t\t\t\t\t//context.stencilFunc( context.NOTEQUAL, 1, 0xffffffff );\n\t\t\t\t\tstencil.setFunc( context.NOTEQUAL, 1, 0xffffffff );\n\n\t\t\t\t\tthis.copyPass.render( this.renderer, this.writeBuffer, this.readBuffer, deltaTime );\n\n\t\t\t\t\t//context.stencilFunc( context.EQUAL, 1, 0xffffffff );\n\t\t\t\t\tstencil.setFunc( context.EQUAL, 1, 0xffffffff );\n\n\t\t\t\t}\n\n\t\t\t\tthis.swapBuffers();\n\n\t\t\t}\n\n\t\t\tif ( MaskPass !== undefined ) {\n\n\t\t\t\tif ( pass instanceof MaskPass ) {\n\n\t\t\t\t\tmaskActive = true;\n\n\t\t\t\t} else if ( pass instanceof ClearMaskPass ) {\n\n\t\t\t\t\tmaskActive = false;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.renderer.setRenderTarget( currentRenderTarget );\n\n\t}\n\n\t/**\n\t * Resets the internal state of the EffectComposer.\n\t *\n\t * @param {WebGLRenderTarget} [renderTarget] - This render target has the same purpose like\n\t * the one from the constructor. If set, it is used to setup the read and write buffers.\n\t */\n\treset( renderTarget ) {\n\n\t\tif ( renderTarget === undefined ) {\n\n\t\t\tconst size = this.renderer.getSize( new Vector2() );\n\t\t\tthis._pixelRatio = this.renderer.getPixelRatio();\n\t\t\tthis._width = size.width;\n\t\t\tthis._height = size.height;\n\n\t\t\trenderTarget = this.renderTarget1.clone();\n\t\t\trenderTarget.setSize( this._width * this._pixelRatio, this._height * this._pixelRatio );\n\n\t\t}\n\n\t\tthis.renderTarget1.dispose();\n\t\tthis.renderTarget2.dispose();\n\t\tthis.renderTarget1 = renderTarget;\n\t\tthis.renderTarget2 = renderTarget.clone();\n\n\t\tthis.writeBuffer = this.renderTarget1;\n\t\tthis.readBuffer = this.renderTarget2;\n\n\t}\n\n\t/**\n\t * Resizes the internal read and write buffers as well as all passes. Similar to {@link WebGLRenderer#setSize},\n\t * this method honors the current pixel ration.\n\t *\n\t * @param {number} width - The width in logical pixels.\n\t * @param {number} height - The height in logical pixels.\n\t */\n\tsetSize( width, height ) {\n\n\t\tthis._width = width;\n\t\tthis._height = height;\n\n\t\tconst effectiveWidth = this._width * this._pixelRatio;\n\t\tconst effectiveHeight = this._height * this._pixelRatio;\n\n\t\tthis.renderTarget1.setSize( effectiveWidth, effectiveHeight );\n\t\tthis.renderTarget2.setSize( effectiveWidth, effectiveHeight );\n\n\t\tfor ( let i = 0; i < this.passes.length; i ++ ) {\n\n\t\t\tthis.passes[ i ].setSize( effectiveWidth, effectiveHeight );\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Sets device pixel ratio. This is usually used for HiDPI device to prevent blurring output.\n\t * Setting the pixel ratio will automatically resize the composer.\n\t *\n\t * @param {number} pixelRatio - The pixel ratio to set.\n\t */\n\tsetPixelRatio( pixelRatio ) {\n\n\t\tthis._pixelRatio = pixelRatio;\n\n\t\tthis.setSize( this._width, this._height );\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this\n\t * method whenever the composer is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tthis.renderTarget1.dispose();\n\t\tthis.renderTarget2.dispose();\n\n\t\tthis.copyPass.dispose();\n\n\t}\n\n}\n\nexport { EffectComposer };\n","import {\n\tColor\n} from 'three';\nimport { Pass } from './Pass.js';\n\n/**\n * This class represents a render pass. It takes a camera and a scene and produces\n * a beauty pass for subsequent post processing effects.\n *\n * ```js\n * const renderPass = new RenderPass( scene, camera );\n * composer.addPass( renderPass );\n * ```\n *\n * @augments Pass\n */\nclass RenderPass extends Pass {\n\n\t/**\n\t * Constructs a new render pass.\n\t *\n\t * @param {Scene} scene - The scene to render.\n\t * @param {Camera} camera - The camera.\n\t * @param {?Material} [overrideMaterial=null] - The override material. If set, this material is used\n\t * for all objects in the scene.\n\t * @param {?(number|Color|string)} [clearColor=null] - The clear color of the render pass.\n\t * @param {?number} [clearAlpha=null] - The clear alpha of the render pass.\n\t */\n\tconstructor( scene, camera, overrideMaterial = null, clearColor = null, clearAlpha = null ) {\n\n\t\tsuper();\n\n\t\t/**\n\t\t * The scene to render.\n\t\t *\n\t\t * @type {Scene}\n\t\t */\n\t\tthis.scene = scene;\n\n\t\t/**\n\t\t * The camera.\n\t\t *\n\t\t * @type {Camera}\n\t\t */\n\t\tthis.camera = camera;\n\n\t\t/**\n\t\t * The override material. If set, this material is used\n\t\t * for all objects in the scene.\n\t\t *\n\t\t * @type {?Material}\n\t\t * @default null\n\t\t */\n\t\tthis.overrideMaterial = overrideMaterial;\n\n\t\t/**\n\t\t * The clear color of the render pass.\n\t\t *\n\t\t * @type {?(number|Color|string)}\n\t\t * @default null\n\t\t */\n\t\tthis.clearColor = clearColor;\n\n\t\t/**\n\t\t * The clear alpha of the render pass.\n\t\t *\n\t\t * @type {?number}\n\t\t * @default null\n\t\t */\n\t\tthis.clearAlpha = clearAlpha;\n\n\t\t/**\n\t\t * Overwritten to perform a clear operation by default.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default true\n\t\t */\n\t\tthis.clear = true;\n\n\t\t/**\n\t\t * If set to `true`, only the depth can be cleared when `clear` is to `false`.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.clearDepth = false;\n\n\t\t/**\n\t\t * Overwritten to disable the swap.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.needsSwap = false;\n\t\tthis._oldClearColor = new Color();\n\n\t}\n\n\t/**\n\t * Performs a beauty pass with the configured scene and camera.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( renderer, writeBuffer, readBuffer /*, deltaTime, maskActive */ ) {\n\n\t\tconst oldAutoClear = renderer.autoClear;\n\t\trenderer.autoClear = false;\n\n\t\tlet oldClearAlpha, oldOverrideMaterial;\n\n\t\tif ( this.overrideMaterial !== null ) {\n\n\t\t\toldOverrideMaterial = this.scene.overrideMaterial;\n\n\t\t\tthis.scene.overrideMaterial = this.overrideMaterial;\n\n\t\t}\n\n\t\tif ( this.clearColor !== null ) {\n\n\t\t\trenderer.getClearColor( this._oldClearColor );\n\t\t\trenderer.setClearColor( this.clearColor, renderer.getClearAlpha() );\n\n\t\t}\n\n\t\tif ( this.clearAlpha !== null ) {\n\n\t\t\toldClearAlpha = renderer.getClearAlpha();\n\t\t\trenderer.setClearAlpha( this.clearAlpha );\n\n\t\t}\n\n\t\tif ( this.clearDepth == true ) {\n\n\t\t\trenderer.clearDepth();\n\n\t\t}\n\n\t\trenderer.setRenderTarget( this.renderToScreen ? null : readBuffer );\n\n\t\tif ( this.clear === true ) {\n\n\t\t\t// TODO: Avoid using autoClear properties, see https://github.com/mrdoob/three.js/pull/15571#issuecomment-465669600\n\t\t\trenderer.clear( renderer.autoClearColor, renderer.autoClearDepth, renderer.autoClearStencil );\n\n\t\t}\n\n\t\trenderer.render( this.scene, this.camera );\n\n\t\t// restore\n\n\t\tif ( this.clearColor !== null ) {\n\n\t\t\trenderer.setClearColor( this._oldClearColor );\n\n\t\t}\n\n\t\tif ( this.clearAlpha !== null ) {\n\n\t\t\trenderer.setClearAlpha( oldClearAlpha );\n\n\t\t}\n\n\t\tif ( this.overrideMaterial !== null ) {\n\n\t\t\tthis.scene.overrideMaterial = oldOverrideMaterial;\n\n\t\t}\n\n\t\trenderer.autoClear = oldAutoClear;\n\n\t}\n\n}\n\nexport { RenderPass };\n","import {\n\tColor\n} from 'three';\n\n/** @module LuminosityHighPassShader */\n\n/**\n * Luminosity high pass shader.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst LuminosityHighPassShader = {\n\n\tname: 'LuminosityHighPassShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'luminosityThreshold': { value: 1.0 },\n\t\t'smoothWidth': { value: 1.0 },\n\t\t'defaultColor': { value: new Color( 0x000000 ) },\n\t\t'defaultOpacity': { value: 0.0 }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat v = luminance( texel.xyz );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}`\n\n};\n\nexport { LuminosityHighPassShader };\n","import {\n\tAdditiveBlending,\n\tColor,\n\tHalfFloatType,\n\tMeshBasicMaterial,\n\tShaderMaterial,\n\tUniformsUtils,\n\tVector2,\n\tVector3,\n\tWebGLRenderTarget\n} from 'three';\nimport { Pass, FullScreenQuad } from './Pass.js';\nimport { CopyShader } from '../shaders/CopyShader.js';\nimport { LuminosityHighPassShader } from '../shaders/LuminosityHighPassShader.js';\n\n/**\n * This pass is inspired by the bloom pass of Unreal Engine. It creates a\n * mip map chain of bloom textures and blurs them with different radii. Because\n * of the weighted combination of mips, and because larger blurs are done on\n * higher mips, this effect provides good quality and performance.\n *\n * When using this pass, tone mapping must be enabled in the renderer settings.\n *\n * Reference:\n * - [Bloom in Unreal Engine]{@link https://docs.unrealengine.com/latest/INT/Engine/Rendering/PostProcessEffects/Bloom/}\n *\n * ```js\n * const resolution = new THREE.Vector2( window.innerWidth, window.innerHeight );\n * const bloomPass = new UnrealBloomPass( resolution, 1.5, 0.4, 0.85 );\n * composer.addPass( bloomPass );\n * ```\n *\n * @augments Pass\n */\nclass UnrealBloomPass extends Pass {\n\n\t/**\n\t * Constructs a new Unreal Bloom pass.\n\t *\n\t * @param {Vector2} [resolution] - The effect's resolution.\n\t * @param {number} [strength=1] - The Bloom strength.\n\t * @param {number} radius - The Bloom radius.\n\t * @param {number} threshold - The luminance threshold limits which bright areas contribute to the Bloom effect.\n\t */\n\tconstructor( resolution, strength = 1, radius, threshold ) {\n\n\t\tsuper();\n\n\t\t/**\n\t\t * The Bloom strength.\n\t\t *\n\t\t * @type {number}\n\t\t * @default 1\n\t\t */\n\t\tthis.strength = strength;\n\n\t\t/**\n\t\t * The Bloom radius.\n\t\t *\n\t\t * @type {number}\n\t\t */\n\t\tthis.radius = radius;\n\n\t\t/**\n\t\t * The luminance threshold limits which bright areas contribute to the Bloom effect.\n\t\t *\n\t\t * @type {number}\n\t\t */\n\t\tthis.threshold = threshold;\n\n\t\t/**\n\t\t * The effect's resolution.\n\t\t *\n\t\t * @type {Vector2}\n\t\t * @default (256,256)\n\t\t */\n\t\tthis.resolution = ( resolution !== undefined ) ? new Vector2( resolution.x, resolution.y ) : new Vector2( 256, 256 );\n\n\t\t/**\n\t\t * The effect's clear color\n\t\t *\n\t\t * @type {Color}\n\t\t * @default (0,0,0)\n\t\t */\n\t\tthis.clearColor = new Color( 0, 0, 0 );\n\n\t\t/**\n\t\t * Overwritten to disable the swap.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @default false\n\t\t */\n\t\tthis.needsSwap = false;\n\n\t\t// internals\n\n\t\t// render targets\n\t\tthis.renderTargetsHorizontal = [];\n\t\tthis.renderTargetsVertical = [];\n\t\tthis.nMips = 5;\n\t\tlet resx = Math.round( this.resolution.x / 2 );\n\t\tlet resy = Math.round( this.resolution.y / 2 );\n\n\t\tthis.renderTargetBright = new WebGLRenderTarget( resx, resy, { type: HalfFloatType } );\n\t\tthis.renderTargetBright.texture.name = 'UnrealBloomPass.bright';\n\t\tthis.renderTargetBright.texture.generateMipmaps = false;\n\n\t\tfor ( let i = 0; i < this.nMips; i ++ ) {\n\n\t\t\tconst renderTargetHorizontal = new WebGLRenderTarget( resx, resy, { type: HalfFloatType } );\n\n\t\t\trenderTargetHorizontal.texture.name = 'UnrealBloomPass.h' + i;\n\t\t\trenderTargetHorizontal.texture.generateMipmaps = false;\n\n\t\t\tthis.renderTargetsHorizontal.push( renderTargetHorizontal );\n\n\t\t\tconst renderTargetVertical = new WebGLRenderTarget( resx, resy, { type: HalfFloatType } );\n\n\t\t\trenderTargetVertical.texture.name = 'UnrealBloomPass.v' + i;\n\t\t\trenderTargetVertical.texture.generateMipmaps = false;\n\n\t\t\tthis.renderTargetsVertical.push( renderTargetVertical );\n\n\t\t\tresx = Math.round( resx / 2 );\n\n\t\t\tresy = Math.round( resy / 2 );\n\n\t\t}\n\n\t\t// luminosity high pass material\n\n\t\tconst highPassShader = LuminosityHighPassShader;\n\t\tthis.highPassUniforms = UniformsUtils.clone( highPassShader.uniforms );\n\n\t\tthis.highPassUniforms[ 'luminosityThreshold' ].value = threshold;\n\t\tthis.highPassUniforms[ 'smoothWidth' ].value = 0.01;\n\n\t\tthis.materialHighPassFilter = new ShaderMaterial( {\n\t\t\tuniforms: this.highPassUniforms,\n\t\t\tvertexShader: highPassShader.vertexShader,\n\t\t\tfragmentShader: highPassShader.fragmentShader\n\t\t} );\n\n\t\t// gaussian blur materials\n\n\t\tthis.separableBlurMaterials = [];\n\t\tconst kernelSizeArray = [ 3, 5, 7, 9, 11 ];\n\t\tresx = Math.round( this.resolution.x / 2 );\n\t\tresy = Math.round( this.resolution.y / 2 );\n\n\t\tfor ( let i = 0; i < this.nMips; i ++ ) {\n\n\t\t\tthis.separableBlurMaterials.push( this._getSeparableBlurMaterial( kernelSizeArray[ i ] ) );\n\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'invSize' ].value = new Vector2( 1 / resx, 1 / resy );\n\n\t\t\tresx = Math.round( resx / 2 );\n\n\t\t\tresy = Math.round( resy / 2 );\n\n\t\t}\n\n\t\t// composite material\n\n\t\tthis.compositeMaterial = this._getCompositeMaterial( this.nMips );\n\t\tthis.compositeMaterial.uniforms[ 'blurTexture1' ].value = this.renderTargetsVertical[ 0 ].texture;\n\t\tthis.compositeMaterial.uniforms[ 'blurTexture2' ].value = this.renderTargetsVertical[ 1 ].texture;\n\t\tthis.compositeMaterial.uniforms[ 'blurTexture3' ].value = this.renderTargetsVertical[ 2 ].texture;\n\t\tthis.compositeMaterial.uniforms[ 'blurTexture4' ].value = this.renderTargetsVertical[ 3 ].texture;\n\t\tthis.compositeMaterial.uniforms[ 'blurTexture5' ].value = this.renderTargetsVertical[ 4 ].texture;\n\t\tthis.compositeMaterial.uniforms[ 'bloomStrength' ].value = strength;\n\t\tthis.compositeMaterial.uniforms[ 'bloomRadius' ].value = 0.1;\n\n\t\tconst bloomFactors = [ 1.0, 0.8, 0.6, 0.4, 0.2 ];\n\t\tthis.compositeMaterial.uniforms[ 'bloomFactors' ].value = bloomFactors;\n\t\tthis.bloomTintColors = [ new Vector3( 1, 1, 1 ), new Vector3( 1, 1, 1 ), new Vector3( 1, 1, 1 ), new Vector3( 1, 1, 1 ), new Vector3( 1, 1, 1 ) ];\n\t\tthis.compositeMaterial.uniforms[ 'bloomTintColors' ].value = this.bloomTintColors;\n\n\t\t// blend material\n\n\t\tthis.copyUniforms = UniformsUtils.clone( CopyShader.uniforms );\n\n\t\tthis.blendMaterial = new ShaderMaterial( {\n\t\t\tuniforms: this.copyUniforms,\n\t\t\tvertexShader: CopyShader.vertexShader,\n\t\t\tfragmentShader: CopyShader.fragmentShader,\n\t\t\tblending: AdditiveBlending,\n\t\t\tdepthTest: false,\n\t\t\tdepthWrite: false,\n\t\t\ttransparent: true\n\t\t} );\n\n\t\tthis._oldClearColor = new Color();\n\t\tthis._oldClearAlpha = 1;\n\n\t\tthis._basic = new MeshBasicMaterial();\n\n\t\tthis._fsQuad = new FullScreenQuad( null );\n\n\t}\n\n\t/**\n\t * Frees the GPU-related resources allocated by this instance. Call this\n\t * method whenever the pass is no longer used in your app.\n\t */\n\tdispose() {\n\n\t\tfor ( let i = 0; i < this.renderTargetsHorizontal.length; i ++ ) {\n\n\t\t\tthis.renderTargetsHorizontal[ i ].dispose();\n\n\t\t}\n\n\t\tfor ( let i = 0; i < this.renderTargetsVertical.length; i ++ ) {\n\n\t\t\tthis.renderTargetsVertical[ i ].dispose();\n\n\t\t}\n\n\t\tthis.renderTargetBright.dispose();\n\n\t\t//\n\n\t\tfor ( let i = 0; i < this.separableBlurMaterials.length; i ++ ) {\n\n\t\t\tthis.separableBlurMaterials[ i ].dispose();\n\n\t\t}\n\n\t\tthis.compositeMaterial.dispose();\n\t\tthis.blendMaterial.dispose();\n\t\tthis._basic.dispose();\n\n\t\t//\n\n\t\tthis._fsQuad.dispose();\n\n\t}\n\n\t/**\n\t * Sets the size of the pass.\n\t *\n\t * @param {number} width - The width to set.\n\t * @param {number} height - The width to set.\n\t */\n\tsetSize( width, height ) {\n\n\t\tlet resx = Math.round( width / 2 );\n\t\tlet resy = Math.round( height / 2 );\n\n\t\tthis.renderTargetBright.setSize( resx, resy );\n\n\t\tfor ( let i = 0; i < this.nMips; i ++ ) {\n\n\t\t\tthis.renderTargetsHorizontal[ i ].setSize( resx, resy );\n\t\t\tthis.renderTargetsVertical[ i ].setSize( resx, resy );\n\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'invSize' ].value = new Vector2( 1 / resx, 1 / resy );\n\n\t\t\tresx = Math.round( resx / 2 );\n\t\t\tresy = Math.round( resy / 2 );\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Performs the Bloom pass.\n\t *\n\t * @param {WebGLRenderer} renderer - The renderer.\n\t * @param {WebGLRenderTarget} writeBuffer - The write buffer. This buffer is intended as the rendering\n\t * destination for the pass.\n\t * @param {WebGLRenderTarget} readBuffer - The read buffer. The pass can access the result from the\n\t * previous pass from this buffer.\n\t * @param {number} deltaTime - The delta time in seconds.\n\t * @param {boolean} maskActive - Whether masking is active or not.\n\t */\n\trender( renderer, writeBuffer, readBuffer, deltaTime, maskActive ) {\n\n\t\trenderer.getClearColor( this._oldClearColor );\n\t\tthis._oldClearAlpha = renderer.getClearAlpha();\n\t\tconst oldAutoClear = renderer.autoClear;\n\t\trenderer.autoClear = false;\n\n\t\trenderer.setClearColor( this.clearColor, 0 );\n\n\t\tif ( maskActive ) renderer.state.buffers.stencil.setTest( false );\n\n\t\t// Render input to screen\n\n\t\tif ( this.renderToScreen ) {\n\n\t\t\tthis._fsQuad.material = this._basic;\n\t\t\tthis._basic.map = readBuffer.texture;\n\n\t\t\trenderer.setRenderTarget( null );\n\t\t\trenderer.clear();\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t}\n\n\t\t// 1. Extract Bright Areas\n\n\t\tthis.highPassUniforms[ 'tDiffuse' ].value = readBuffer.texture;\n\t\tthis.highPassUniforms[ 'luminosityThreshold' ].value = this.threshold;\n\t\tthis._fsQuad.material = this.materialHighPassFilter;\n\n\t\trenderer.setRenderTarget( this.renderTargetBright );\n\t\trenderer.clear();\n\t\tthis._fsQuad.render( renderer );\n\n\t\t// 2. Blur All the mips progressively\n\n\t\tlet inputRenderTarget = this.renderTargetBright;\n\n\t\tfor ( let i = 0; i < this.nMips; i ++ ) {\n\n\t\t\tthis._fsQuad.material = this.separableBlurMaterials[ i ];\n\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'colorTexture' ].value = inputRenderTarget.texture;\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'direction' ].value = UnrealBloomPass.BlurDirectionX;\n\t\t\trenderer.setRenderTarget( this.renderTargetsHorizontal[ i ] );\n\t\t\trenderer.clear();\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'colorTexture' ].value = this.renderTargetsHorizontal[ i ].texture;\n\t\t\tthis.separableBlurMaterials[ i ].uniforms[ 'direction' ].value = UnrealBloomPass.BlurDirectionY;\n\t\t\trenderer.setRenderTarget( this.renderTargetsVertical[ i ] );\n\t\t\trenderer.clear();\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t\tinputRenderTarget = this.renderTargetsVertical[ i ];\n\n\t\t}\n\n\t\t// Composite All the mips\n\n\t\tthis._fsQuad.material = this.compositeMaterial;\n\t\tthis.compositeMaterial.uniforms[ 'bloomStrength' ].value = this.strength;\n\t\tthis.compositeMaterial.uniforms[ 'bloomRadius' ].value = this.radius;\n\t\tthis.compositeMaterial.uniforms[ 'bloomTintColors' ].value = this.bloomTintColors;\n\n\t\trenderer.setRenderTarget( this.renderTargetsHorizontal[ 0 ] );\n\t\trenderer.clear();\n\t\tthis._fsQuad.render( renderer );\n\n\t\t// Blend it additively over the input texture\n\n\t\tthis._fsQuad.material = this.blendMaterial;\n\t\tthis.copyUniforms[ 'tDiffuse' ].value = this.renderTargetsHorizontal[ 0 ].texture;\n\n\t\tif ( maskActive ) renderer.state.buffers.stencil.setTest( true );\n\n\t\tif ( this.renderToScreen ) {\n\n\t\t\trenderer.setRenderTarget( null );\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t} else {\n\n\t\t\trenderer.setRenderTarget( readBuffer );\n\t\t\tthis._fsQuad.render( renderer );\n\n\t\t}\n\n\t\t// Restore renderer settings\n\n\t\trenderer.setClearColor( this._oldClearColor, this._oldClearAlpha );\n\t\trenderer.autoClear = oldAutoClear;\n\n\t}\n\n\t// internals\n\n\t_getSeparableBlurMaterial( kernelRadius ) {\n\n\t\tconst coefficients = [];\n\n\t\tfor ( let i = 0; i < kernelRadius; i ++ ) {\n\n\t\t\tcoefficients.push( 0.39894 * Math.exp( - 0.5 * i * i / ( kernelRadius * kernelRadius ) ) / kernelRadius );\n\n\t\t}\n\n\t\treturn new ShaderMaterial( {\n\n\t\t\tdefines: {\n\t\t\t\t'KERNEL_RADIUS': kernelRadius\n\t\t\t},\n\n\t\t\tuniforms: {\n\t\t\t\t'colorTexture': { value: null },\n\t\t\t\t'invSize': { value: new Vector2( 0.5, 0.5 ) }, // inverse texture size\n\t\t\t\t'direction': { value: new Vector2( 0.5, 0.5 ) },\n\t\t\t\t'gaussianCoefficients': { value: coefficients } // precomputed Gaussian coefficients\n\t\t\t},\n\n\t\t\tvertexShader:\n\t\t\t\t`varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}`,\n\n\t\t\tfragmentShader:\n\t\t\t\t`#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}`\n\t\t} );\n\n\t}\n\n\t_getCompositeMaterial( nMips ) {\n\n\t\treturn new ShaderMaterial( {\n\n\t\t\tdefines: {\n\t\t\t\t'NUM_MIPS': nMips\n\t\t\t},\n\n\t\t\tuniforms: {\n\t\t\t\t'blurTexture1': { value: null },\n\t\t\t\t'blurTexture2': { value: null },\n\t\t\t\t'blurTexture3': { value: null },\n\t\t\t\t'blurTexture4': { value: null },\n\t\t\t\t'blurTexture5': { value: null },\n\t\t\t\t'bloomStrength': { value: 1.0 },\n\t\t\t\t'bloomFactors': { value: null },\n\t\t\t\t'bloomTintColors': { value: null },\n\t\t\t\t'bloomRadius': { value: 0.0 }\n\t\t\t},\n\n\t\t\tvertexShader:\n\t\t\t\t`varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}`,\n\n\t\t\tfragmentShader:\n\t\t\t\t`varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}`\n\t\t} );\n\n\t}\n\n}\n\nUnrealBloomPass.BlurDirectionX = new Vector2( 1.0, 0.0 );\nUnrealBloomPass.BlurDirectionY = new Vector2( 0.0, 1.0 );\n\nexport { UnrealBloomPass };\n","import {\n\tVector2\n} from 'three';\n\n/** @module FXAAShader */\n\n/**\n * FXAA algorithm from NVIDIA, C# implementation by Jasper Flick, GLSL port by Dave Hoskins.\n *\n * References:\n * - {@link http://developer.download.nvidia.com/assets/gamedev/files/sdk/11/FXAA_WhitePaper.pdf}.\n * - {@link https://catlikecoding.com/unity/tutorials/advanced-rendering/fxaa/}.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst FXAAShader = {\n\n\tname: 'FXAAShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'resolution': { value: new Vector2( 1 / 1024, 1 / 512 ) }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec2 resolution;\n\t\tvarying vec2 vUv;\n\n\t\t#define EDGE_STEP_COUNT 6\n\t\t#define EDGE_GUESS 8.0\n\t\t#define EDGE_STEPS 1.0, 1.5, 2.0, 2.0, 2.0, 4.0\n\t\tconst float edgeSteps[EDGE_STEP_COUNT] = float[EDGE_STEP_COUNT]( EDGE_STEPS );\n\n\t\tfloat _ContrastThreshold = 0.0312;\n\t\tfloat _RelativeThreshold = 0.063;\n\t\tfloat _SubpixelBlending = 1.0;\n\n\t\tvec4 Sample( sampler2D  tex2D, vec2 uv ) {\n\n\t\t\treturn texture( tex2D, uv );\n\n\t\t}\n\n\t\tfloat SampleLuminance( sampler2D tex2D, vec2 uv ) {\n\n\t\t\treturn dot( Sample( tex2D, uv ).rgb, vec3( 0.3, 0.59, 0.11 ) );\n\n\t\t}\n\n\t\tfloat SampleLuminance( sampler2D tex2D, vec2 texSize, vec2 uv, float uOffset, float vOffset ) {\n\n\t\t\tuv += texSize * vec2(uOffset, vOffset);\n\t\t\treturn SampleLuminance(tex2D, uv);\n\n\t\t}\n\n\t\tstruct LuminanceData {\n\n\t\t\tfloat m, n, e, s, w;\n\t\t\tfloat ne, nw, se, sw;\n\t\t\tfloat highest, lowest, contrast;\n\n\t\t};\n\n\t\tLuminanceData SampleLuminanceNeighborhood( sampler2D tex2D, vec2 texSize, vec2 uv ) {\n\n\t\t\tLuminanceData l;\n\t\t\tl.m = SampleLuminance( tex2D, uv );\n\t\t\tl.n = SampleLuminance( tex2D, texSize, uv,  0.0,  1.0 );\n\t\t\tl.e = SampleLuminance( tex2D, texSize, uv,  1.0,  0.0 );\n\t\t\tl.s = SampleLuminance( tex2D, texSize, uv,  0.0, -1.0 );\n\t\t\tl.w = SampleLuminance( tex2D, texSize, uv, -1.0,  0.0 );\n\n\t\t\tl.ne = SampleLuminance( tex2D, texSize, uv,  1.0,  1.0 );\n\t\t\tl.nw = SampleLuminance( tex2D, texSize, uv, -1.0,  1.0 );\n\t\t\tl.se = SampleLuminance( tex2D, texSize, uv,  1.0, -1.0 );\n\t\t\tl.sw = SampleLuminance( tex2D, texSize, uv, -1.0, -1.0 );\n\n\t\t\tl.highest = max( max( max( max( l.n, l.e ), l.s ), l.w ), l.m );\n\t\t\tl.lowest = min( min( min( min( l.n, l.e ), l.s ), l.w ), l.m );\n\t\t\tl.contrast = l.highest - l.lowest;\n\t\t\treturn l;\n\n\t\t}\n\n\t\tbool ShouldSkipPixel( LuminanceData l ) {\n\n\t\t\tfloat threshold = max( _ContrastThreshold, _RelativeThreshold * l.highest );\n\t\t\treturn l.contrast < threshold;\n\n\t\t}\n\n\t\tfloat DeterminePixelBlendFactor( LuminanceData l ) {\n\n\t\t\tfloat f = 2.0 * ( l.n + l.e + l.s + l.w );\n\t\t\tf += l.ne + l.nw + l.se + l.sw;\n\t\t\tf *= 1.0 / 12.0;\n\t\t\tf = abs( f - l.m );\n\t\t\tf = clamp( f / l.contrast, 0.0, 1.0 );\n\n\t\t\tfloat blendFactor = smoothstep( 0.0, 1.0, f );\n\t\t\treturn blendFactor * blendFactor * _SubpixelBlending;\n\n\t\t}\n\n\t\tstruct EdgeData {\n\n\t\t\tbool isHorizontal;\n\t\t\tfloat pixelStep;\n\t\t\tfloat oppositeLuminance, gradient;\n\n\t\t};\n\n\t\tEdgeData DetermineEdge( vec2 texSize, LuminanceData l ) {\n\n\t\t\tEdgeData e;\n\t\t\tfloat horizontal =\n\t\t\t\tabs( l.n + l.s - 2.0 * l.m ) * 2.0 +\n\t\t\t\tabs( l.ne + l.se - 2.0 * l.e ) +\n\t\t\t\tabs( l.nw + l.sw - 2.0 * l.w );\n\t\t\tfloat vertical =\n\t\t\t\tabs( l.e + l.w - 2.0 * l.m ) * 2.0 +\n\t\t\t\tabs( l.ne + l.nw - 2.0 * l.n ) +\n\t\t\t\tabs( l.se + l.sw - 2.0 * l.s );\n\t\t\te.isHorizontal = horizontal >= vertical;\n\n\t\t\tfloat pLuminance = e.isHorizontal ? l.n : l.e;\n\t\t\tfloat nLuminance = e.isHorizontal ? l.s : l.w;\n\t\t\tfloat pGradient = abs( pLuminance - l.m );\n\t\t\tfloat nGradient = abs( nLuminance - l.m );\n\n\t\t\te.pixelStep = e.isHorizontal ? texSize.y : texSize.x;\n\n\t\t\tif (pGradient < nGradient) {\n\n\t\t\t\te.pixelStep = -e.pixelStep;\n\t\t\t\te.oppositeLuminance = nLuminance;\n\t\t\t\te.gradient = nGradient;\n\n\t\t\t} else {\n\n\t\t\t\te.oppositeLuminance = pLuminance;\n\t\t\t\te.gradient = pGradient;\n\n\t\t\t}\n\n\t\t\treturn e;\n\n\t\t}\n\n\t\tfloat DetermineEdgeBlendFactor( sampler2D  tex2D, vec2 texSize, LuminanceData l, EdgeData e, vec2 uv ) {\n\n\t\t\tvec2 uvEdge = uv;\n\t\t\tvec2 edgeStep;\n\t\t\tif (e.isHorizontal) {\n\n\t\t\t\tuvEdge.y += e.pixelStep * 0.5;\n\t\t\t\tedgeStep = vec2( texSize.x, 0.0 );\n\n\t\t\t} else {\n\n\t\t\t\tuvEdge.x += e.pixelStep * 0.5;\n\t\t\t\tedgeStep = vec2( 0.0, texSize.y );\n\n\t\t\t}\n\n\t\t\tfloat edgeLuminance = ( l.m + e.oppositeLuminance ) * 0.5;\n\t\t\tfloat gradientThreshold = e.gradient * 0.25;\n\n\t\t\tvec2 puv = uvEdge + edgeStep * edgeSteps[0];\n\t\t\tfloat pLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;\n\t\t\tbool pAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;\n\n\t\t\tfor ( int i = 1; i < EDGE_STEP_COUNT && !pAtEnd; i++ ) {\n\n\t\t\t\tpuv += edgeStep * edgeSteps[i];\n\t\t\t\tpLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;\n\t\t\t\tpAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;\n\n\t\t\t}\n\n\t\t\tif ( !pAtEnd ) {\n\n\t\t\t\tpuv += edgeStep * EDGE_GUESS;\n\n\t\t\t}\n\n\t\t\tvec2 nuv = uvEdge - edgeStep * edgeSteps[0];\n\t\t\tfloat nLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;\n\t\t\tbool nAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;\n\n\t\t\tfor ( int i = 1; i < EDGE_STEP_COUNT && !nAtEnd; i++ ) {\n\n\t\t\t\tnuv -= edgeStep * edgeSteps[i];\n\t\t\t\tnLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;\n\t\t\t\tnAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;\n\n\t\t\t}\n\n\t\t\tif ( !nAtEnd ) {\n\n\t\t\t\tnuv -= edgeStep * EDGE_GUESS;\n\n\t\t\t}\n\n\t\t\tfloat pDistance, nDistance;\n\t\t\tif ( e.isHorizontal ) {\n\n\t\t\t\tpDistance = puv.x - uv.x;\n\t\t\t\tnDistance = uv.x - nuv.x;\n\n\t\t\t} else {\n\n\t\t\t\tpDistance = puv.y - uv.y;\n\t\t\t\tnDistance = uv.y - nuv.y;\n\n\t\t\t}\n\n\t\t\tfloat shortestDistance;\n\t\t\tbool deltaSign;\n\t\t\tif ( pDistance <= nDistance ) {\n\n\t\t\t\tshortestDistance = pDistance;\n\t\t\t\tdeltaSign = pLuminanceDelta >= 0.0;\n\n\t\t\t} else {\n\n\t\t\t\tshortestDistance = nDistance;\n\t\t\t\tdeltaSign = nLuminanceDelta >= 0.0;\n\n\t\t\t}\n\n\t\t\tif ( deltaSign == ( l.m - edgeLuminance >= 0.0 ) ) {\n\n\t\t\t\treturn 0.0;\n\n\t\t\t}\n\n\t\t\treturn 0.5 - shortestDistance / ( pDistance + nDistance );\n\n\t\t}\n\n\t\tvec4 ApplyFXAA( sampler2D  tex2D, vec2 texSize, vec2 uv ) {\n\n\t\t\tLuminanceData luminance = SampleLuminanceNeighborhood( tex2D, texSize, uv );\n\t\t\tif ( ShouldSkipPixel( luminance ) ) {\n\n\t\t\t\treturn Sample( tex2D, uv );\n\n\t\t\t}\n\n\t\t\tfloat pixelBlend = DeterminePixelBlendFactor( luminance );\n\t\t\tEdgeData edge = DetermineEdge( texSize, luminance );\n\t\t\tfloat edgeBlend = DetermineEdgeBlendFactor( tex2D, texSize, luminance, edge, uv );\n\t\t\tfloat finalBlend = max( pixelBlend, edgeBlend );\n\n\t\t\tif (edge.isHorizontal) {\n\n\t\t\t\tuv.y += edge.pixelStep * finalBlend;\n\n\t\t\t} else {\n\n\t\t\t\tuv.x += edge.pixelStep * finalBlend;\n\n\t\t\t}\n\n\t\t\treturn Sample( tex2D, uv );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = ApplyFXAA( tDiffuse, resolution.xy, vUv );\n\n\t\t}`\n\n};\n\nexport { FXAAShader };\n","import {\n\tVector3\n} from 'three';\n\n/** @module ColorCorrectionShader */\n\n/**\n * Color correction shader.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst ColorCorrectionShader = {\n\n\tname: 'ColorCorrectionShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'powRGB': { value: new Vector3( 2, 2, 2 ) },\n\t\t'mulRGB': { value: new Vector3( 1, 1, 1 ) },\n\t\t'addRGB': { value: new Vector3( 0, 0, 0 ) }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 powRGB;\n\t\tuniform vec3 mulRGB;\n\t\tuniform vec3 addRGB;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor.rgb = mulRGB * pow( ( gl_FragColor.rgb + addRGB ), powRGB );\n\n\t\t}`\n\n};\n\nexport { ColorCorrectionShader };\n","/** @module FilmShader */\n\n/**\n * TODO\n *\n * Used by {@link FilmPass}.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst FilmShader = {\n\n\tname: 'FilmShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'time': { value: 0.0 },\n\t\t'intensity': { value: 0.5 },\n\t\t'grayscale': { value: false }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\t#include <common>\n\n\t\tuniform float intensity;\n\t\tuniform bool grayscale;\n\t\tuniform float time;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat noise = rand( fract( vUv + time ) );\n\n\t\t\tvec3 color = base.rgb + base.rgb * clamp( 0.1 + noise, 0.0, 1.0 );\n\n\t\t\tcolor = mix( base.rgb, color, intensity );\n\n\t\t\tif ( grayscale ) {\n\n\t\t\t\tcolor = vec3( luminance( color ) ); // assuming linear-srgb\n\n\t\t\t}\n\n\t\t\tgl_FragColor = vec4( color, base.a );\n\n\t\t}`,\n\n};\n\nexport { FilmShader };\n","/** @module VignetteShader */\n\n/**\n * Based on [PaintEffect postprocess from ro.me]{@link http://code.google.com/p/3-dreams-of-black/source/browse/deploy/js/effects/PaintEffect.js}.\n *\n * @constant\n * @type {ShaderMaterial~Shader}\n */\nconst VignetteShader = {\n\n\tname: 'VignetteShader',\n\n\tuniforms: {\n\n\t\t'tDiffuse': { value: null },\n\t\t'offset': { value: 1.0 },\n\t\t'darkness': { value: 1.0 }\n\n\t},\n\n\tvertexShader: /* glsl */`\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}`,\n\n\tfragmentShader: /* glsl */`\n\n\t\tuniform float offset;\n\t\tuniform float darkness;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t// Eskil's vignette\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tvec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );\n\t\t\tgl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );\n\n\t\t}`\n\n};\n\nexport { VignetteShader };\n","/**\n * A utility module with basic WebGL 2 capability testing.\n *\n * @hideconstructor\n */\nclass WebGL {\n\n\t/**\n\t * Returns `true` if WebGL 2 is available.\n\t *\n\t * @return {boolean} Whether WebGL 2 is available or not.\n\t */\n\tstatic isWebGL2Available() {\n\n\t\ttry {\n\n\t\t\tconst canvas = document.createElement( 'canvas' );\n\t\t\treturn !! ( window.WebGL2RenderingContext && canvas.getContext( 'webgl2' ) );\n\n\t\t} catch ( e ) {\n\n\t\t\treturn false;\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Returns `true` if the given color space is available. This method can only be used\n\t * if WebGL 2 is supported.\n\t *\n\t * @param {string} colorSpace - The color space to test.\n\t * @return {boolean} Whether the given color space is available or not.\n\t */\n\tstatic isColorSpaceAvailable( colorSpace ) {\n\n\t\ttry {\n\n\t\t\tconst canvas = document.createElement( 'canvas' );\n\t\t\tconst ctx = window.WebGL2RenderingContext && canvas.getContext( 'webgl2' );\n\t\t\tctx.drawingBufferColorSpace = colorSpace;\n\t\t\treturn ctx.drawingBufferColorSpace === colorSpace; // deepscan-disable-line SAME_OPERAND_VALUE\n\n\t\t} catch ( e ) {\n\n\t\t\treturn false;\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Returns a `div` element representing a formatted error message that can be appended in\n\t * web sites if WebGL 2 isn't supported.\n\t *\n\t * @return {HTMLDivElement} A `div` element representing a formatted error message that WebGL 2 isn't supported.\n\t */\n\tstatic getWebGL2ErrorMessage() {\n\n\t\treturn this._getErrorMessage( 2 );\n\n\t}\n\n\t// private\n\n\tstatic _getErrorMessage( version ) {\n\n\t\tconst names = {\n\t\t\t1: 'WebGL',\n\t\t\t2: 'WebGL 2'\n\t\t};\n\n\t\tconst contexts = {\n\t\t\t1: window.WebGLRenderingContext,\n\t\t\t2: window.WebGL2RenderingContext\n\t\t};\n\n\t\tlet message = 'Your $0 does not seem to support <a href=\"http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation\" style=\"color:#000\">$1</a>';\n\n\t\tconst element = document.createElement( 'div' );\n\t\telement.id = 'webglmessage';\n\t\telement.style.fontFamily = 'monospace';\n\t\telement.style.fontSize = '13px';\n\t\telement.style.fontWeight = 'normal';\n\t\telement.style.textAlign = 'center';\n\t\telement.style.background = '#fff';\n\t\telement.style.color = '#000';\n\t\telement.style.padding = '1.5em';\n\t\telement.style.width = '400px';\n\t\telement.style.margin = '5em auto 0';\n\n\t\tif ( contexts[ version ] ) {\n\n\t\t\tmessage = message.replace( '$0', 'graphics card' );\n\n\t\t} else {\n\n\t\t\tmessage = message.replace( '$0', 'browser' );\n\n\t\t}\n\n\t\tmessage = message.replace( '$1', names[ version ] );\n\n\t\telement.innerHTML = message;\n\n\t\treturn element;\n\n\t}\n\n\t// @deprecated, r168\n\n\tstatic isWebGLAvailable() {\n\n\t\tconsole.warn( 'isWebGLAvailable() has been deprecated and will be removed in r178. Use isWebGL2Available() instead.' );\n\n\t\ttry {\n\n\t\t\tconst canvas = document.createElement( 'canvas' );\n\t\t\treturn !! ( window.WebGLRenderingContext && ( canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ) );\n\n\t\t} catch ( e ) {\n\n\t\t\treturn false;\n\n\t\t}\n\n\t}\n\n\tstatic getWebGLErrorMessage() {\n\n\t\tconsole.warn( 'getWebGLErrorMessage() has been deprecated and will be removed in r178. Use getWebGL2ErrorMessage() instead.' );\n\n\t\treturn this._getErrorMessage( 1 );\n\n\t}\n\n}\n\nexport default WebGL;\n","// renderer.js - Handles the Three.js scene, camera, renderer setup and post-processing\r\n\r\nimport * as THREE from 'three';\r\nimport { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';\r\nimport { RenderPass } from 'three/addons/postprocessing/RenderPass.js';\r\nimport { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';\r\nimport { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';\r\nimport { FXAAShader } from 'three/addons/shaders/FXAAShader.js';\r\nimport { ColorCorrectionShader } from 'three/addons/shaders/ColorCorrectionShader.js';\r\nimport { FilmShader } from 'three/addons/shaders/FilmShader.js';\r\nimport { VignetteShader } from 'three/addons/shaders/VignetteShader.js';\r\nimport WebGL from 'three/addons/capabilities/WebGL.js';\r\n\r\nexport class Renderer {\r\n    constructor() {\r\n        console.log(\"Initializing enhanced renderer...\");\r\n        \r\n        // Check for WebGL 2 support\r\n        if (!WebGL.isWebGL2Available()) {\r\n            const warning = WebGL.getWebGL2ErrorMessage();\r\n            document.body.appendChild(warning);\r\n            console.error(\"WebGL 2 is required but not available.\");\r\n            throw new Error(\"WebGL 2 not available\");\r\n        } else {\r\n            console.log(\"WebGL 2 is available.\");\r\n        }\r\n        \r\n        this.scene = new THREE.Scene();\r\n        this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 400000);\r\n        \r\n        // Create renderer with HDR support\r\n        this.renderer = new THREE.WebGLRenderer({ \r\n            antialias: true,\r\n            powerPreference: \"high-performance\",\r\n            logarithmicDepthBuffer: true, // Better for space scenes with huge distance ranges\r\n            stencil: true, // Explicitly enable stencil buffer (default changed to false in r163)\r\n        });\r\n        \r\n        // Enable shadow mapping\r\n        this.renderer.shadowMap.enabled = true;\r\n        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n        \r\n        // Use the new physically correct lighting system (default in r155+)\r\n        this.renderer.useLegacyLights = false;\r\n        \r\n        // Set tone mapping for HDR rendering\r\n        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n        this.renderer.toneMappingExposure = 1.0;\r\n        \r\n        // Setup for instanced meshes\r\n        this.instancedMeshes = new Map();\r\n        \r\n    this.setupRenderer();\r\n        this.setupPostProcessing();\r\n        this.setupLighting();\r\n        this.setupResizeHandler();\r\n        console.log(\"Enhanced renderer initialized successfully\");\r\n\r\n    // Perf counters\r\n    this._frameDrawCalls = 0;\r\n    this._frameVisibleInstances = 0;\r\n    // Interpolation alpha provided by main\r\n    this.renderAlpha = 0;\r\n\r\n    // Renderer facade guard\r\n    if (typeof window !== 'undefined') {\r\n      window.__rendererGuard = false;\r\n    }\r\n\r\n    // Wrap scene add/remove to warn on direct mutations\r\n    const originalAdd = this.scene.add.bind(this.scene);\r\n    const originalRemove = this.scene.remove.bind(this.scene);\r\n    this.scene.add = (...args) => {\r\n      if (!window.__rendererGuard && window && window.DEBUG_MODE) {\r\n        console.warn('[RendererFacade] Direct scene.add detected outside renderer facade');\r\n      }\r\n      return originalAdd(...args);\r\n    };\r\n    this.scene.remove = (...args) => {\r\n      if (!window.__rendererGuard && window && window.DEBUG_MODE) {\r\n        console.warn('[RendererFacade] Direct scene.remove detected outside renderer facade');\r\n      }\r\n      return originalRemove(...args);\r\n    };\r\n    }\r\n    \r\n    setupRenderer() {\r\n        this.renderer.setSize(window.innerWidth, window.innerHeight);\r\n        this.renderer.setClearColor(0x000000);\r\n        document.body.appendChild(this.renderer.domElement);\r\n        \r\n        // Set the output color space to sRGB\r\n        this.renderer.outputColorSpace = THREE.SRGBColorSpace;\r\n        \r\n        // Position camera - brought closer for better visibility\r\n        this.camera.position.z = 10;\r\n        \r\n        // Make sure the camera can see far enough to show the skybox\r\n        this.camera.far = 400000;\r\n        this.camera.updateProjectionMatrix();\r\n\r\n        // Enhance shadow mapping for better quality eclipse effects\r\n        this.renderer.shadowMap.enabled = true;\r\n        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n        this.renderer.shadowMap.autoUpdate = true;\r\n    }\r\n    \r\n    setupPostProcessing() {\r\n        try {\r\n            // Create a composer for post-processing effects\r\n            this.composer = new EffectComposer(this.renderer);\r\n            \r\n            // Add the render pass\r\n            const renderPass = new RenderPass(this.scene, this.camera);\r\n            this.composer.addPass(renderPass);\r\n            \r\n            // Add godray effect based on settings\r\n            this.setupGodRayEffects();\r\n            \r\n            try {\r\n                // Add bloom effect for sun, engines, etc.\r\n                this.bloomPass = new UnrealBloomPass(\r\n                    new THREE.Vector2(window.innerWidth, window.innerHeight),\r\n                    0.2,    // strength (further reduced from 0.3)\r\n                    0.2,    // radius (further reduced from 0.3)\r\n                    0.95    // threshold (further increased from 0.9 to only affect the very brightest parts)\r\n                );\r\n                this.composer.addPass(this.bloomPass);\r\n            } catch (error) {\r\n                console.warn(\"Error setting up UnrealBloomPass:\", error);\r\n            }\r\n            \r\n            try {\r\n                // Add FXAA for edge aliasing\r\n                const fxaaPass = new ShaderPass(FXAAShader);\r\n                if (fxaaPass.material && fxaaPass.material.uniforms && fxaaPass.material.uniforms.resolution) {\r\n                    const pixelRatio = this.renderer.getPixelRatio();\r\n                    fxaaPass.material.uniforms.resolution.value.x = 1 / (window.innerWidth * pixelRatio);\r\n                    fxaaPass.material.uniforms.resolution.value.y = 1 / (window.innerHeight * pixelRatio);\r\n                    this.composer.addPass(fxaaPass);\r\n                } else {\r\n                    console.warn(\"FXAAShader uniforms not as expected, skipping pass\");\r\n                }\r\n            } catch (error) {\r\n                console.warn(\"Error setting up FXAAShader:\", error);\r\n            }\r\n            \r\n            try {\r\n                // Add color correction effects\r\n                this.colorCorrectionPass = new ShaderPass(ColorCorrectionShader);\r\n                if (this.colorCorrectionPass.uniforms && this.colorCorrectionPass.uniforms.powRGB && this.colorCorrectionPass.uniforms.mulRGB) {\r\n                    this.colorCorrectionPass.uniforms.powRGB.value = new THREE.Vector3(1.1, 1.1, 1.2); // Slightly blue tint\r\n                    this.colorCorrectionPass.uniforms.mulRGB.value = new THREE.Vector3(1.2, 1.1, 1.0); // Warmer highlights\r\n                    this.composer.addPass(this.colorCorrectionPass);\r\n                } else {\r\n                    console.warn(\"ColorCorrectionShader uniforms not as expected, skipping pass\");\r\n                }\r\n            } catch (error) {\r\n                console.warn(\"Error setting up ColorCorrectionShader:\", error);\r\n            }\r\n            \r\n            try {\r\n                // Add subtle film grain for more cinematic feel\r\n                this.filmPass = new ShaderPass(FilmShader);\r\n                if (this.filmPass.uniforms && this.filmPass.uniforms.nIntensity && \r\n                    this.filmPass.uniforms.sIntensity && this.filmPass.uniforms.grayscale) {\r\n                    this.filmPass.uniforms.nIntensity.value = 0.15; // Noise intensity\r\n                    this.filmPass.uniforms.sIntensity.value = 0.05; // Scanline intensity\r\n                    this.filmPass.uniforms.grayscale.value = 0; // Color\r\n                    this.composer.addPass(this.filmPass);\r\n                } else {\r\n                    console.warn(\"FilmShader uniforms not as expected, skipping pass\");\r\n                }\r\n            } catch (error) {\r\n                console.warn(\"Error setting up FilmShader:\", error);\r\n            }\r\n            \r\n            try {\r\n                // Add vignette effect\r\n                this.vignettePass = new ShaderPass(VignetteShader);\r\n                if (this.vignettePass.uniforms && this.vignettePass.uniforms.offset && this.vignettePass.uniforms.darkness) {\r\n                    this.vignettePass.uniforms.offset.value = 0.95;\r\n                    this.vignettePass.uniforms.darkness.value = 1.6;\r\n                    this.composer.addPass(this.vignettePass);\r\n                } else {\r\n                    console.warn(\"VignetteShader uniforms not as expected, skipping pass\");\r\n                }\r\n            } catch (error) {\r\n                console.warn(\"Error setting up VignetteShader:\", error);\r\n            }\r\n            \r\n            console.log(\"Post-processing setup complete\");\r\n        } catch (error) {\r\n            console.error(\"Error setting up post-processing:\", error);\r\n            console.log(\"Continuing with basic rendering without post-processing\");\r\n            // Set a flag to use basic rendering instead\r\n            this.useBasicRendering = true;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Setup for volumetric lighting (god rays) effects\r\n     * Handles both the new realistic godray effect and the original \"Claude Rays\"\r\n     */\r\n    setupGodRayEffects() {\r\n        try {\r\n            // Initialize flags for volumetric lighting effects\r\n            this.volumetricLightEnabled = true;     // Master toggle for any god ray effect\r\n            this.useClaudeRays = false;             // Toggle between new godRays (false) and Claude Rays (true)\r\n            \r\n            // Create the original \"Claude Rays\" effect (disabled by default)\r\n            this.claudeRayPass = this.createClaudeRayShader();\r\n            this.claudeRayPass.enabled = this.volumetricLightEnabled && this.useClaudeRays;\r\n            this.composer.addPass(this.claudeRayPass);\r\n            console.log(\"Claude Rays effect created (disabled by default)\");\r\n            \r\n            // Create the new improved volumetric lighting effect\r\n            this.godRayPass = this.createVolumetricLightShader();\r\n            this.godRayPass.enabled = this.volumetricLightEnabled && !this.useClaudeRays;\r\n            this.composer.addPass(this.godRayPass);\r\n            console.log(\"New volumetric light ray effect added to post-processing chain\");\r\n        } catch (error) {\r\n            console.warn(\"Error setting up volumetric light shaders:\", error);\r\n        }\r\n    }\r\n    \r\n    setupLighting() {\r\n        // Ambient light - reduced for better shadow visibility\r\n        const ambientLight = new THREE.AmbientLight(0x404050, 1.0); // Reduced from 2.5\r\n        this.scene.add(ambientLight);\r\n        this.ambientLight = ambientLight; // Store reference to adjust later\r\n\r\n        // Directional light - kept the same\r\n        const directionalLight = new THREE.DirectionalLight(0xffffe0, 2.0);\r\n        directionalLight.position.set(1, 0.5, 1).normalize();\r\n        directionalLight.castShadow = true;\r\n        // Configure shadow properties\r\n        directionalLight.shadow.mapSize.width = 2048;\r\n        directionalLight.shadow.mapSize.height = 2048;\r\n        directionalLight.shadow.camera.near = 0.5;\r\n        directionalLight.shadow.camera.far = 500;\r\n        directionalLight.shadow.bias = -0.0005;\r\n        this.scene.add(directionalLight);\r\n        \r\n        // Fill light - reduced for better shadow definition\r\n        const fillLight = new THREE.DirectionalLight(0xaaccff, 0.3); // Reduced from 0.8\r\n        fillLight.position.set(-1, -0.3, -1).normalize();\r\n        this.scene.add(fillLight);\r\n        \r\n        // Hemisphere light - reduced for better contrast\r\n        const hemisphereLight = new THREE.HemisphereLight(0x606090, 0x101020, 0.4); // Reduced from 0.8\r\n        this.scene.add(hemisphereLight);\r\n        \r\n        // Ambient point light - reduced brightness\r\n        const ambientPointLight = new THREE.PointLight(0xffffff, 1.2, 1200, 2); // Reduced from 2.5\r\n        ambientPointLight.position.set(0, 500, 0); // Positioned high up\r\n        this.scene.add(ambientPointLight);\r\n    }\r\n    \r\n    setupResizeHandler() {\r\n        window.addEventListener('resize', () => {\r\n            this.handleResize();\r\n        });\r\n    }\r\n    \r\n    // Explicitly define getter methods for scene and camera\r\n    getScene() {\r\n        return this.scene;\r\n    }\r\n    \r\n    getCamera() {\r\n        return this.camera;\r\n    }\r\n    \r\n    // Resize handler method\r\n    handleResize() {\r\n        this.camera.aspect = window.innerWidth / window.innerHeight;\r\n        this.camera.updateProjectionMatrix();\r\n        this.renderer.setSize(window.innerWidth, window.innerHeight);\r\n        \r\n        // Update composer size if it exists\r\n        if (this.composer) {\r\n            this.composer.setSize(window.innerWidth, window.innerHeight);\r\n        \r\n            // Update FXAA resolution\r\n            try {\r\n                const pixelRatio = this.renderer.getPixelRatio();\r\n                const fxaaPass = this.composer.passes.find(pass => \r\n                    pass.material && \r\n                    pass.material.uniforms && \r\n                    pass.material.uniforms.resolution &&\r\n                    pass.material.uniforms.resolution.value\r\n                );\r\n                \r\n                if (fxaaPass) {\r\n                    fxaaPass.material.uniforms.resolution.value.x = 1 / (window.innerWidth * pixelRatio);\r\n                    fxaaPass.material.uniforms.resolution.value.y = 1 / (window.innerHeight * pixelRatio);\r\n                }\r\n            } catch (error) {\r\n                console.warn(\"Error updating FXAA resolution:\", error);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Add an object to the scene through guarded path\r\n    add(object) {\r\n        return this._withGuard(() => this.scene.add(object));\r\n    }\r\n    \r\n    // Allow dynamic adjustment of post-processing settings\r\n    adjustBloom(strength, radius, threshold) {\r\n        if (this.bloomPass) {\r\n            this.bloomPass.strength = strength !== undefined ? strength : this.bloomPass.strength;\r\n            this.bloomPass.radius = radius !== undefined ? radius : this.bloomPass.radius;\r\n            this.bloomPass.threshold = threshold !== undefined ? threshold : this.bloomPass.threshold;\r\n        }\r\n    }\r\n    \r\n    // Update for dynamic visual effects\r\n    update(deltaTime) {\r\n        // Update film grain with time for animation\r\n        if (this.filmPass && this.filmPass.uniforms && this.filmPass.uniforms.time && this.filmPass.uniforms.time.value !== undefined) {\r\n            try {\r\n                this.filmPass.uniforms.time.value += deltaTime;\r\n            } catch (error) {\r\n                console.warn(\"Error updating film pass time:\", error);\r\n            }\r\n        }\r\n        \r\n        // Update volumetric light ray position if sun is present\r\n        if (this.volumetricLightEnabled) {\r\n            if (this.useClaudeRays) {\r\n                this.updateClaudeRayPosition();\r\n            } else {\r\n                this.updateVolumetricLightPosition();\r\n            }\r\n        }\r\n        \r\n        // Update instanced meshes\r\n        this.updateInstancedMeshes();\r\n    }\r\n    \r\n    /**\r\n     * Update the light position for Claude Rays\r\n     */\r\n    updateClaudeRayPosition() {\r\n        try {\r\n            // Ensure we have the required objects\r\n            if (!this.claudeRayPass || !this.claudeRayPass.uniforms || !this.claudeRayPass.uniforms.lightPosition) {\r\n                return;\r\n            }\r\n            \r\n            if (!this.camera || !this.scene) {\r\n                return;\r\n            }\r\n            \r\n            // Try to find the sun in the scene\r\n            let sun = this.findSunObject();\r\n            \r\n            if (sun) {\r\n                // Get sun world position\r\n                const sunWorldPos = new THREE.Vector3();\r\n                sun.getWorldPosition(sunWorldPos);\r\n                \r\n                // Create a vector to hold the screen position\r\n                const screenVector = sunWorldPos.clone();\r\n                \r\n                // Project to camera space\r\n                screenVector.project(this.camera);\r\n                \r\n                // Convert to normalized device coordinates (NDC)\r\n                const x = (screenVector.x + 1) / 2;\r\n                const y = (screenVector.y + 1) / 2;\r\n                \r\n                // Update the shader uniform with the new position\r\n                this.claudeRayPass.uniforms.lightPosition.value.set(x, y);\r\n            } else {\r\n                // Default to center if sun not found\r\n                this.claudeRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\r\n            }\r\n        } catch (error) {\r\n            console.warn('Error updating Claude Ray position:', error);\r\n            \r\n            // Set a default position in case of error\r\n            if (this.claudeRayPass && this.claudeRayPass.uniforms && this.claudeRayPass.uniforms.lightPosition) {\r\n                this.claudeRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update the light position for volumetric rays\r\n     */\r\n    updateVolumetricLightPosition() {\r\n        try {\r\n            // Ensure we have the required objects\r\n            if (!this.godRayPass || !this.godRayPass.uniforms || !this.godRayPass.uniforms.lightPosition) {\r\n                return;\r\n            }\r\n            \r\n            if (!this.camera || !this.scene) {\r\n                return;\r\n            }\r\n            \r\n            // Try to find the sun in the scene\r\n            let sun = this.findSunObject();\r\n            \r\n            if (sun) {\r\n                // Get sun world position\r\n                const sunWorldPos = new THREE.Vector3();\r\n                sun.getWorldPosition(sunWorldPos);\r\n                \r\n                // Create a vector to hold the screen position\r\n                const screenVector = sunWorldPos.clone();\r\n                \r\n                // Project to camera space\r\n                screenVector.project(this.camera);\r\n                \r\n                // Convert to normalized device coordinates (NDC)\r\n                const x = (screenVector.x + 1) / 2;\r\n                const y = (screenVector.y + 1) / 2;\r\n                \r\n                // Calculate distance from camera to sun for attenuation\r\n                const camToSunDistance = this.camera.position.distanceTo(sunWorldPos);\r\n                \r\n                // Update the shader uniforms\r\n                this.godRayPass.uniforms.lightPosition.value.set(x, y);\r\n                \r\n                // Update distance - normalized to 0-1 range for shader\r\n                // Base the max distance on the sun's size and visibility range\r\n                const maxDistance = 130000; // Increased from 100000 for longer rays\r\n                const normalizedDistance = Math.min(1.0, camToSunDistance / maxDistance);\r\n                this.godRayPass.uniforms.sunDistance.value = normalizedDistance;\r\n                \r\n                // Calculate if sun is in front of camera (dot product with camera direction)\r\n                const camDirection = new THREE.Vector3(0, 0, -1).applyQuaternion(this.camera.quaternion);\r\n                const sunDirection = new THREE.Vector3().subVectors(sunWorldPos, this.camera.position).normalize();\r\n                const dotProduct = camDirection.dot(sunDirection);\r\n                \r\n                // Sun is visible when dot product is positive (sun is in front of camera)\r\n                this.godRayPass.uniforms.sunVisibility.value = Math.max(0, dotProduct);\r\n            } else {\r\n                // Default to center if sun not found\r\n                this.godRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\r\n                this.godRayPass.uniforms.sunDistance.value = 1.0; // Far away\r\n                this.godRayPass.uniforms.sunVisibility.value = 0.0; // Not visible\r\n            }\r\n        } catch (error) {\r\n            console.warn('Error updating volumetric light position:', error);\r\n            \r\n            // Set default values in case of error\r\n            if (this.godRayPass && this.godRayPass.uniforms) {\r\n                if (this.godRayPass.uniforms.lightPosition) {\r\n                    this.godRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\r\n                }\r\n                if (this.godRayPass.uniforms.sunDistance) {\r\n                    this.godRayPass.uniforms.sunDistance.value = 1.0;\r\n                }\r\n                if (this.godRayPass.uniforms.sunVisibility) {\r\n                    this.godRayPass.uniforms.sunVisibility.value = 0.0;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Helper method to find the sun object in the scene\r\n     * @returns {THREE.Object3D|null} The sun object or null if not found\r\n     */\r\n    findSunObject() {\r\n        let sun = null;\r\n        \r\n        // First try by name\r\n        sun = this.scene.getObjectByName('sun');\r\n        \r\n        // If not found by name, try to find by traversing scene\r\n        if (!sun) {\r\n            this.scene.traverse(object => {\r\n                if (object.name === 'sun') {\r\n                    sun = object;\r\n                }\r\n            });\r\n        }\r\n        \r\n        return sun;\r\n    }\r\n    \r\n    // Override the render method to use the composer if available, otherwise fallback to basic rendering\r\n    render() {\r\n    // reset counters\r\n    this._frameDrawCalls = 0;\r\n    this._frameVisibleInstances = 0;\r\n\r\n    // count visible instances from instancedMeshes map\r\n    try {\r\n      for (const [, inst] of this.instancedMeshes) {\r\n        if (inst && inst.mesh) {\r\n          this._frameVisibleInstances += inst.mesh.count || 0;\r\n        }\r\n      }\r\n    } catch {}\r\n\r\n    // track render start\r\n    const ctx = this.renderer.info;\r\n    const startCalls = ctx.render.calls;\r\n    if (this.composer && !this.useBasicRendering) {\r\n      this.composer.render();\r\n    } else {\r\n      this.renderer.render(this.scene, this.camera);\r\n    }\r\n    const endCalls = this.renderer.info.render.calls;\r\n    this._frameDrawCalls = Math.max(0, endCalls - startCalls);\r\n\r\n    if (window.__perf) {\r\n      window.__perf.drawCalls = endCalls; // total since reset\r\n      window.__perf.visibleInstances = this._frameVisibleInstances;\r\n    }\r\n    }\r\n\r\n  // Interpolate ECS meshes before compositing\r\n  interpolateMeshes(alpha) {\r\n    this.renderAlpha = alpha;\r\n    // If ECS world present on scene, interpolate known meshes\r\n    const world = this.scene && this.scene.ecsWorld ? this.scene.ecsWorld : null;\r\n    if (!world || !world.entityManager) return;\r\n    try {\r\n      const entities = world.getEntitiesWithComponents(['TransformComponent', 'MeshComponent']);\r\n      for (const entity of entities) {\r\n        const t = entity.getComponent('TransformComponent');\r\n        const m = entity.getComponent('MeshComponent');\r\n        if (!t || !m || !m.mesh) continue;\r\n        // slerp rotation\r\n        const q = new THREE.Quaternion().copy(t.prevQuaternion).slerp(t.quaternion, alpha);\r\n        // lerp position\r\n        const p = new THREE.Vector3().copy(t.prevPosition).lerp(t.position, alpha);\r\n        m.mesh.position.copy(p);\r\n        m.mesh.quaternion.copy(q);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  // Facade API for views\r\n  addView(entityId, viewDef) {\r\n    // For future: create mesh/instanced entry based on viewDef\r\n    // Placeholder; current rendering handled by systems\r\n  }\r\n\r\n  removeView(entityId) {\r\n    // Placeholder for centralized removal\r\n  }\r\n\r\n  _withGuard(fn) {\r\n    const prev = window.__rendererGuard;\r\n    window.__rendererGuard = true;\r\n    try { return fn(); } finally { window.__rendererGuard = prev; }\r\n  }\r\n\r\n  updateView(entityId, props) {\r\n    // Placeholder for centralized updates\r\n  }\r\n    \r\n    /**\r\n     * Create an instanced mesh for efficient rendering of many similar objects\r\n     * @param {string} key Unique identifier for this instanced mesh type\r\n     * @param {THREE.BufferGeometry} geometry The geometry to instance\r\n     * @param {THREE.Material} material The material to use\r\n     * @param {number} maxCount Maximum number of instances\r\n     * @returns {THREE.InstancedMesh} The created instanced mesh\r\n     */\r\n    createInstancedMesh(key, geometry, material, maxCount) {\r\n        const instancedMesh = new THREE.InstancedMesh(geometry, material, maxCount);\r\n        instancedMesh.count = 0; // Start with 0 visible instances\r\n        instancedMesh.frustumCulled = true;\r\n        this.scene.add(instancedMesh);\r\n        \r\n        this.instancedMeshes.set(key, {\r\n            mesh: instancedMesh,\r\n            count: 0,\r\n            maxCount: maxCount,\r\n            dummy: new THREE.Object3D() // Reusable temporary Object3D for matrix calculations\r\n        });\r\n        \r\n        return instancedMesh;\r\n    }\r\n    \r\n    /**\r\n     * Add or update an instance in an instanced mesh\r\n     * @param {string} key The instanced mesh identifier\r\n     * @param {number} index Index of the instance to update (or next available)\r\n     * @param {THREE.Vector3} position Position of the instance\r\n     * @param {THREE.Quaternion} quaternion Rotation of the instance\r\n     * @param {THREE.Vector3} scale Scale of the instance\r\n     * @returns {number} The index of the instance\r\n     */\r\n    updateInstance(key, index, position, quaternion, scale) {\r\n        const instance = this.instancedMeshes.get(key);\r\n        if (!instance) return -1;\r\n        \r\n        // Determine index to use\r\n        const idx = (index !== undefined) ? index : instance.count;\r\n        \r\n        // If we're adding a new instance, increment the count\r\n        if (idx >= instance.count) {\r\n            if (idx >= instance.maxCount) return -1; // Can't exceed max count\r\n            instance.count = idx + 1;\r\n        }\r\n        \r\n        // Update matrix using dummy object\r\n        instance.dummy.position.copy(position);\r\n        if (quaternion) instance.dummy.quaternion.copy(quaternion);\r\n        if (scale) instance.dummy.scale.copy(scale);\r\n        instance.dummy.updateMatrix();\r\n        \r\n        // Apply to instanced mesh\r\n        instance.mesh.setMatrixAt(idx, instance.dummy.matrix);\r\n        instance.mesh.instanceMatrix.needsUpdate = true;\r\n        \r\n        return idx;\r\n    }\r\n    \r\n    /**\r\n     * Update instanced meshes\r\n     */\r\n    updateInstancedMeshes() {\r\n        for (const [key, instance] of this.instancedMeshes.entries()) {\r\n            if (instance.mesh.instanceMatrix.needsUpdate) {\r\n                instance.mesh.instanceMatrix.needsUpdate = false;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Remove an instance from an instanced mesh\r\n     * @param {string} key The instanced mesh identifier\r\n     * @param {number} index Index of the instance to remove\r\n     */\r\n    removeInstance(key, index) {\r\n        const instance = this.instancedMeshes.get(key);\r\n        if (!instance || index >= instance.count) return;\r\n        \r\n        // Move the last instance to this slot if it's not the last one\r\n        if (index < instance.count - 1) {\r\n            // Get the matrix of the last instance\r\n            const matrix = new THREE.Matrix4();\r\n            instance.mesh.getMatrixAt(instance.count - 1, matrix);\r\n            \r\n            // Set it at the removed index\r\n            instance.mesh.setMatrixAt(index, matrix);\r\n        }\r\n        \r\n        // Decrease count\r\n        instance.count--;\r\n        instance.mesh.count = instance.count;\r\n        instance.mesh.instanceMatrix.needsUpdate = true;\r\n    }\r\n    \r\n    /**\r\n     * Properly dispose of Three.js resources to prevent memory leaks\r\n     */\r\n    dispose() {\r\n        console.log(\"Disposing renderer resources...\");\r\n        \r\n        // Remove event listener\r\n        window.removeEventListener('resize', this.handleResize);\r\n        \r\n        // Dispose of post-processing\r\n        if (this.composer) {\r\n            this.composer.passes.forEach(pass => {\r\n                if (pass.dispose) pass.dispose();\r\n                if (pass.material) {\r\n                    pass.material.dispose();\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Dispose of instanced meshes\r\n        this.instancedMeshes.forEach(instance => {\r\n            if (instance.mesh) {\r\n                if (instance.mesh.geometry) instance.mesh.geometry.dispose();\r\n                if (instance.mesh.material) {\r\n                    if (Array.isArray(instance.mesh.material)) {\r\n                        instance.mesh.material.forEach(material => material.dispose());\r\n                    } else {\r\n                        instance.mesh.material.dispose();\r\n                    }\r\n                }\r\n                this.scene.remove(instance.mesh);\r\n            }\r\n        });\r\n        \r\n        // Dispose of scene objects\r\n        this.scene.traverse(object => {\r\n            if (object.geometry) object.geometry.dispose();\r\n            \r\n            if (object.material) {\r\n                if (Array.isArray(object.material)) {\r\n                    object.material.forEach(material => this.disposeMaterial(material));\r\n                } else {\r\n                    this.disposeMaterial(object.material);\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Dispose of renderer\r\n        this.renderer.dispose();\r\n        \r\n        console.log(\"Renderer resources disposed\");\r\n    }\r\n    \r\n    /**\r\n     * Helper method to dispose of materials and their textures\r\n     * @param {THREE.Material} material The material to dispose\r\n     */\r\n    disposeMaterial(material) {\r\n        // Dispose textures\r\n        for (const propertyName in material) {\r\n            const property = material[propertyName];\r\n            if (property && property.isTexture) {\r\n                property.dispose();\r\n            }\r\n        }\r\n        \r\n        // Dispose the material itself\r\n        material.dispose();\r\n    }\r\n    \r\n    /**\r\n     * Create a volumetric light shader for realistic god ray effects\r\n     * @returns {ShaderPass} Shader pass for new volumetric lighting\r\n     */\r\n    createVolumetricLightShader() {\r\n        // New improved volumetric light ray shader\r\n        const godRayShader = {\r\n            uniforms: {\r\n                tDiffuse: { value: null },\r\n                lightPosition: { value: new THREE.Vector2(0.5, 0.5) },\r\n                intensity: { value: 0.45 },         // Increased from 0.3\r\n                decay: { value: 0.94 },             // Adjusted from 0.95 for better distance\r\n                density: { value: 0.6 },            // Increased from 0.5\r\n                weight: { value: 0.5 },             // Increased from 0.4\r\n                samples: { value: 100 },            // Sample count - higher = better quality but slower\r\n                sunColor: { value: new THREE.Color(0xFFFAF0) },   // Sun color\r\n                sunDistance: { value: 0.5 },        // Distance to sun (0-1 normalized)\r\n                sunVisibility: { value: 1.0 },      // Whether sun is in front of camera (0-1)\r\n                scattering: { value: 0.4 },         // Increased from 0.3\r\n                attenuationMultiplier: { value: 3.5 } // Reduced from 5.0 to allow rays to travel further\r\n            },\r\n            \r\n            vertexShader: `\r\n                varying vec2 vUv;\r\n                \r\n                void main() {\r\n                    vUv = uv;\r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            \r\n            fragmentShader: `\r\n                precision highp float;\r\n                \r\n                varying vec2 vUv;\r\n                uniform sampler2D tDiffuse;\r\n                uniform vec2 lightPosition;\r\n                uniform float intensity;\r\n                uniform float decay;\r\n                uniform float density;\r\n                uniform float weight;\r\n                uniform int samples;\r\n                uniform vec3 sunColor;\r\n                uniform float sunDistance;\r\n                uniform float sunVisibility;\r\n                uniform float scattering;\r\n                uniform float attenuationMultiplier;\r\n                \r\n                const int MAX_SAMPLES = 150;\r\n                \r\n                float illuminationDecay(float rayProgress, float dist) {\r\n                    // rayProgress: 0.0 to a1.0 (how far along the ray)\r\n                    // dist: normalized distance to sun (0 = close, 1 = far)\r\n                    \r\n                    // Base decay from exponential falloff\r\n                    float baseFalloff = pow(decay, rayProgress * 100.0);\r\n                    \r\n                    // More decay the further the sun is \r\n                    float distanceAttenuation = 1.0 - (dist * dist * attenuationMultiplier);\r\n                    distanceAttenuation = max(0.0, distanceAttenuation);\r\n                    \r\n                    // Apply visibility factor\r\n                    float visibilityFactor = sunVisibility;\r\n                    \r\n                    return baseFalloff * distanceAttenuation * visibilityFactor;\r\n                }\r\n                \r\n                void main() {\r\n                    // Get the texture color (original scene)\r\n                    vec4 sceneColor = texture2D(tDiffuse, vUv);\r\n                    \r\n                    // Calculate ray direction from pixel to light source\r\n                    vec2 rayVector = (vUv - lightPosition);\r\n                    float rayLength = length(rayVector);\r\n                    vec2 rayDirection = normalize(rayVector);\r\n                    \r\n                    // Skip calculation if ray is too long (reduces artifacts far from sun)\r\n                    if (rayLength > 1.0) {\r\n                        gl_FragColor = sceneColor;\r\n                        return;\r\n                    }\r\n                    \r\n                    // Angle factor (rays stronger when looking near sun)\r\n                    float angleFactor = 1.0 - rayLength;\r\n                    angleFactor = pow(angleFactor, 0.8); // Adjust the power for ray spread\r\n                    \r\n                    // Calculate ray sampling parameters\r\n                    vec2 sampleStep = -rayDirection * min(density, 1.0) / float(samples);\r\n                    \r\n                    // Use a tighter sampling box around the light source\r\n                    // This creates more defined rays and reduces artifacts\r\n                    float rayProgress = max(0.0, (1.0 - rayLength * 2.0)); // Start closer to light source\r\n                    vec2 samplePosition = vUv - sampleStep * rayProgress * 10.0; // Start closer to current position\r\n                    \r\n                    // Clamp sample count for performance\r\n                    int sampleCount = min(samples, MAX_SAMPLES);\r\n                    \r\n                    // Start with current scene color\r\n                    vec4 finalColor = sceneColor;\r\n                    \r\n                    // Calculate scattering factor based on distance and angle\r\n                    float scatterFactor = scattering * angleFactor * (1.0 - sunDistance * 0.5);\r\n                    \r\n                    // Sample the light path\r\n                    for (int i = 0; i < MAX_SAMPLES; i++) {\r\n                        if (i >= sampleCount) break;\r\n                        \r\n                        // Move along the ray\r\n                        samplePosition += sampleStep;\r\n                        \r\n                        // Sample at the current position\r\n                        vec4 sampledColor = texture2D(tDiffuse, samplePosition);\r\n                        \r\n                        // Calculate illumination decay factor\r\n                        float decayFactor = illuminationDecay(float(i) / float(sampleCount), sunDistance);\r\n                        \r\n                        // Create the ray sample with attenuation\r\n                        vec4 raySample = sampledColor * decayFactor * weight;\r\n                        \r\n                        // Apply sun color to the ray (tinted by scene color)\r\n                        raySample.rgb *= mix(sunColor, sampledColor.rgb, 0.3);\r\n                        \r\n                        // Apply scattering effect - brightens areas around sun\r\n                        if (i < sampleCount / 3) {\r\n                            raySample.rgb += sunColor * scatterFactor * decayFactor * 0.2 * (1.0 - float(i) / float(sampleCount / 3));\r\n                        }\r\n                        \r\n                        // Add to accumulated color\r\n                        finalColor += raySample;\r\n                    }\r\n                    \r\n                    // Apply master intensity factor\r\n                    finalColor *= mix(1.0, intensity, sunVisibility);\r\n                    \r\n                    // Preserve original scene color with a blend factor\r\n                    finalColor = mix(sceneColor, finalColor, min(0.95, intensity * sunVisibility));\r\n                    \r\n                    gl_FragColor = finalColor;\r\n                }\r\n            `\r\n        };\r\n        \r\n        // Create and return a shader pass\r\n        const shaderPass = new ShaderPass(godRayShader);\r\n        shaderPass.renderToScreen = false;\r\n        \r\n        return shaderPass;\r\n    }\r\n    \r\n    /**\r\n     * Create the original \"Claude Ray\" shader (the original implementation renamed)\r\n     * @returns {ShaderPass} Shader pass for the original effect\r\n     */\r\n    createClaudeRayShader() {\r\n        // Original volumetric light ray shader (renamed to Claude Rays)\r\n        const claudeRayShader = {\r\n            uniforms: {\r\n                tDiffuse: { value: null },\r\n                lightPosition: { value: new THREE.Vector2(0.5, 0.5) },\r\n                exposure: { value: 0.4 },    // Reduced from 0.6\r\n                decay: { value: 0.93 },\r\n                density: { value: 0.8 },     // Reduced from 0.96\r\n                weight: { value: 0.25 },     // Reduced from 0.4\r\n                lightColor: { value: new THREE.Color(0xFFFAF0) }  // Matches sun directional light\r\n            },\r\n            vertexShader: `\r\n                varying vec2 vUv;\r\n                void main() {\r\n                    vUv = uv;\r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            fragmentShader: `\r\n                precision highp float;\r\n                \r\n                varying vec2 vUv;\r\n                uniform sampler2D tDiffuse;\r\n                uniform vec2 lightPosition;\r\n                uniform float exposure;\r\n                uniform float decay;\r\n                uniform float density;\r\n                uniform float weight;\r\n                uniform vec3 lightColor;\r\n                \r\n                const int NUM_SAMPLES = 24; // Reduced from 30 for better balance of quality and performance\r\n                \r\n                void main() {\r\n                    // Get the texture color\r\n                    vec4 color = texture2D(tDiffuse, vUv);\r\n                    \r\n                    // Ray direction\r\n                    vec2 texCoord = vUv;\r\n                    vec2 deltaTextCoord = (texCoord - lightPosition) * density / float(NUM_SAMPLES);\r\n                    \r\n                    // Start illumination decay at 1.0\r\n                    float illuminationDecay = 1.0;\r\n                    \r\n                    // Sample the light path with a fixed number of steps\r\n                    for(int i = 0; i < NUM_SAMPLES; i++) {\r\n                        // Move along the ray\r\n                        texCoord -= deltaTextCoord;\r\n                        \r\n                        // Sample at the current position\r\n                        vec4 sampleColor = texture2D(tDiffuse, texCoord);\r\n                        \r\n                        // Apply decay and weight\r\n                        sampleColor *= illuminationDecay * weight;\r\n                        \r\n                        // Apply light color\r\n                        sampleColor.rgb *= lightColor;\r\n                        \r\n                        // Add to the final color\r\n                        color += sampleColor;\r\n                        \r\n                        // Reduce illumination for the next sample\r\n                        illuminationDecay *= decay;\r\n                    }\r\n                    \r\n                    // Apply exposure\r\n                    color *= exposure;\r\n                    \r\n                    // Output the final color\r\n                    gl_FragColor = color;\r\n                }\r\n            `\r\n        };\r\n        \r\n        // Create and return a shader pass\r\n        const shaderPass = new ShaderPass(claudeRayShader);\r\n        shaderPass.renderToScreen = false;\r\n        \r\n        return shaderPass;\r\n    }\r\n    \r\n    /**\r\n     * Toggle the type of volumetric lighting effect\r\n     * @param {boolean} useClaudeRays - If true, use original Claude Rays; if false, use new god rays\r\n     */\r\n    setRayType(useClaudeRays) {\r\n        this.useClaudeRays = useClaudeRays;\r\n        \r\n        // Enable/disable appropriate shader passes\r\n        if (this.claudeRayPass) {\r\n            this.claudeRayPass.enabled = this.volumetricLightEnabled && this.useClaudeRays;\r\n        }\r\n        \r\n        if (this.godRayPass) {\r\n            this.godRayPass.enabled = this.volumetricLightEnabled && !this.useClaudeRays;\r\n        }\r\n        \r\n        // Adjust ambient lighting based on ray type\r\n        this.adjustLightingForRayType();\r\n        \r\n        console.log(`Using ${this.useClaudeRays ? 'Claude Rays' : 'Volumetric God Rays'} effect`);\r\n    }\r\n    \r\n    /**\r\n     * Adjust scene lighting based on current ray type\r\n     * Standard god rays need more ambient light to prevent planets from being too dark\r\n     */\r\n    adjustLightingForRayType() {\r\n        if (!this.ambientLight) return;\r\n        \r\n        if (this.useClaudeRays) {\r\n            // For Claude Rays - use original darker ambient lighting\r\n            this.ambientLight.intensity = 1.0;\r\n        } else {\r\n            // For standard god rays - increase ambient lighting to better illuminate planets\r\n            this.ambientLight.intensity = 1.8; // Increased from 1.0\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Toggle volumetric light rays effect (master toggle)\r\n     * @param {boolean} enabled Whether to enable or disable all ray effects\r\n     */\r\n    setVolumetricLightEnabled(enabled) {\r\n        this.volumetricLightEnabled = enabled;\r\n        \r\n        // Update enabled state of current ray effect\r\n        if (this.useClaudeRays && this.claudeRayPass) {\r\n            this.claudeRayPass.enabled = enabled;\r\n        } else if (this.godRayPass) {\r\n            this.godRayPass.enabled = enabled;\r\n        }\r\n        \r\n        console.log(`Volumetric lighting ${enabled ? 'enabled' : 'disabled'}`);\r\n    }\r\n    \r\n    /**\r\n     * Update volumetric light parameters for the new god ray shader\r\n     * @param {Object} params Parameters to update\r\n     */\r\n    updateVolumetricLightParams(params = {}) {\r\n        if (!this.godRayPass || !this.godRayPass.uniforms) return;\r\n        \r\n        const uniforms = this.godRayPass.uniforms;\r\n        \r\n        if (params.intensity !== undefined) uniforms.intensity.value = params.intensity;\r\n        if (params.decay !== undefined) uniforms.decay.value = params.decay;\r\n        if (params.density !== undefined) uniforms.density.value = params.density;\r\n        if (params.weight !== undefined) uniforms.weight.value = params.weight;\r\n        if (params.samples !== undefined) uniforms.samples.value = params.samples;\r\n        if (params.sunColor !== undefined) uniforms.sunColor.value = new THREE.Color(params.sunColor);\r\n        if (params.scattering !== undefined) uniforms.scattering.value = params.scattering;\r\n        if (params.attenuationMultiplier !== undefined) uniforms.attenuationMultiplier.value = params.attenuationMultiplier;\r\n    }\r\n    \r\n    /**\r\n     * Update Claude Ray parameters\r\n     * @param {Object} params Parameters to update\r\n     */\r\n    updateClaudeRayParams(params = {}) {\r\n        if (!this.claudeRayPass || !this.claudeRayPass.uniforms) return;\r\n        \r\n        const uniforms = this.claudeRayPass.uniforms;\r\n        \r\n        if (params.exposure !== undefined) uniforms.exposure.value = params.exposure;\r\n        if (params.decay !== undefined) uniforms.decay.value = params.decay;\r\n        if (params.density !== undefined) uniforms.density.value = params.density;\r\n        if (params.weight !== undefined) uniforms.weight.value = params.weight;\r\n        if (params.lightColor !== undefined) uniforms.lightColor.value = new THREE.Color(params.lightColor);\r\n    }\r\n    \r\n    /**\r\n     * Set overall volumetric light ray intensity with a single parameter\r\n     * @param {number} intensity Value from 0-1 controlling overall ray intensity\r\n     */\r\n    setVolumetricLightIntensity(intensity) {\r\n        if (this.useClaudeRays) {\r\n            // For Claude Rays\r\n            if (!this.claudeRayPass || !this.claudeRayPass.uniforms) return;\r\n            \r\n            // Clamp intensity between 0 and 1\r\n            intensity = Math.max(0, Math.min(1, intensity));\r\n            \r\n            // Scale the intensity to reasonable parameter ranges\r\n            const exposure = 0.2 + (intensity * 0.4);  // Range: 0.2-0.6\r\n            const weight = 0.15 + (intensity * 0.25);  // Range: 0.15-0.4\r\n            const density = 0.7 + (intensity * 0.3);   // Range: 0.7-1.0\r\n            \r\n            // Update the shader parameters\r\n            this.updateClaudeRayParams({\r\n                exposure: exposure,\r\n                weight: weight,\r\n                density: density\r\n            });\r\n        } else {\r\n            // For new god rays\r\n            if (!this.godRayPass || !this.godRayPass.uniforms) return;\r\n            \r\n            // Clamp intensity between 0 and 1\r\n            intensity = Math.max(0, Math.min(1, intensity));\r\n            \r\n            // Scale intensity for new shader parameters with higher base values\r\n            this.updateVolumetricLightParams({\r\n                intensity: 0.3 + (intensity * 0.4),  // Increased base intensity\r\n                weight: 0.35 + (intensity * 0.3),    // Increased from 0.3 + intensity * 0.2\r\n                density: 0.45 + (intensity * 0.25),  // Increased from 0.4 + intensity * 0.2\r\n                scattering: 0.25 + (intensity * 0.25) // Increased from 0.2 + intensity * 0.2\r\n            });\r\n        }\r\n        \r\n        console.log(`Volumetric light intensity set to ${intensity.toFixed(2)}`);\r\n    }\r\n}","// trail.js - Thruster exhaust effects for spaceship\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class TrailEffects {\r\n    constructor(scene, mesh) {\r\n        this.scene = scene;\r\n        this.mesh = mesh; // The spaceship mesh\r\n        this.thrusterEffects = [];\r\n        this.time = 0;\r\n        \r\n        // Initialize effects\r\n        this.createThrusterEffects();\r\n    }\r\n    \r\n    createThrusterEffects() {\r\n        // Create exhaust beam effect using multiple overlapping cylinders\r\n        const createExhaustBeam = (position, direction, config) => {\r\n            const { baseRadius, length, color, glowColor, type } = config;\r\n            const group = new THREE.Group();\r\n            \r\n            // Create multiple cylinder segments for tapered effect\r\n            const segments = 8;\r\n            const beams = [];\r\n            \r\n            for (let i = 0; i < segments; i++) {\r\n                const t = i / segments;\r\n                \r\n                // Taper the radius\r\n                const topRadius = baseRadius * (1 - t * 0.7);\r\n                const bottomRadius = baseRadius * (1 - (t + 1/segments) * 0.7);\r\n                const segmentLength = length / segments;\r\n                \r\n                // Create cylinder geometry\r\n                const geometry = new THREE.CylinderGeometry(\r\n                    topRadius,\r\n                    bottomRadius,\r\n                    segmentLength,\r\n                    12, // More segments for smoother look\r\n                    1,\r\n                    false\r\n                );\r\n                \r\n                // Create material with gradient\r\n                const material = new THREE.MeshBasicMaterial({\r\n                    color: new THREE.Color(color).lerp(new THREE.Color(glowColor), t),\r\n                    transparent: true,\r\n                    opacity: 1.0 - t * 0.3, // High opacity\r\n                    blending: THREE.AdditiveBlending,\r\n                    side: THREE.DoubleSide,\r\n                    depthTest: false // Always render on top\r\n                });\r\n                \r\n                const beam = new THREE.Mesh(geometry, material);\r\n                \r\n                // Position each segment along the exhaust direction\r\n                if (direction.z !== 0) {\r\n                    // Main/reverse thrusters - point along Z\r\n                    geometry.rotateX(Math.PI / 2);\r\n                    beam.position.z = direction.z * (i * segmentLength + segmentLength/2);\r\n                } else if (direction.x !== 0) {\r\n                    // Side thrusters - point along X (perpendicular to ship)\r\n                    geometry.rotateZ(Math.PI / 2);\r\n                    beam.position.x = direction.x * (i * segmentLength + segmentLength/2);\r\n                }\r\n                \r\n                beams.push({ mesh: beam, material });\r\n                group.add(beam);\r\n            }\r\n            \r\n            // Position the group at the thruster location\r\n            group.position.copy(position);\r\n            \r\n            group.visible = false;\r\n            \r\n            // Debug: log thruster creation  \r\n            // console.log(`Created ${type} thruster at position:`, position);\r\n            this.mesh.add(group);\r\n            \r\n            return { group, beams, type };\r\n        };\r\n        \r\n        // Main thruster - big blue/orange exhaust\r\n        this.thrusterEffects.push(createExhaustBeam(\r\n            new THREE.Vector3(0, 0, 1.2), // Back of ship (ship scale is 2.0)\r\n            new THREE.Vector3(0, 0, 1), // Points backward\r\n            {\r\n                baseRadius: 0.25, // Scaled for ship size\r\n                length: 2.5, // Good length for exhaust\r\n                color: 0xffaa00, // Orange core\r\n                glowColor: 0x0088ff, // Blue edges\r\n                type: 'main'\r\n            }\r\n        ));\r\n        \r\n        // RIGHT side thruster - fires when A pressed to push ship LEFT\r\n        this.thrusterEffects.push(createExhaustBeam(\r\n            new THREE.Vector3(0.7, 0, 0.2), // Right side of ship\r\n            new THREE.Vector3(1, 0, 0), // Shoots right (away from ship)\r\n            {\r\n                baseRadius: 0.15,\r\n                length: 1.0, // Shorter exhaust\r\n                color: 0xffaa00,\r\n                glowColor: 0x00aaff,\r\n                type: 'right_thruster' // RIGHT thruster\r\n            }\r\n        ));\r\n        \r\n        // LEFT side thruster - fires when D pressed to push ship RIGHT\r\n        this.thrusterEffects.push(createExhaustBeam(\r\n            new THREE.Vector3(-0.7, 0, 0.2), // Left side of ship\r\n            new THREE.Vector3(-1, 0, 0), // Shoots left (away from ship)\r\n            {\r\n                baseRadius: 0.15,\r\n                length: 1.0, // Shorter exhaust\r\n                color: 0xffaa00,\r\n                glowColor: 0x00aaff,\r\n                type: 'left_thruster' // LEFT thruster\r\n            }\r\n        ));\r\n        \r\n        // Reverse thruster\r\n        this.thrusterEffects.push(createExhaustBeam(\r\n            new THREE.Vector3(0, 0, -1.2), // Front of ship\r\n            new THREE.Vector3(0, 0, -1), // Points forward\r\n            {\r\n                baseRadius: 0.2,\r\n                length: 1.8,\r\n                color: 0xff8800,\r\n                glowColor: 0xff4400,\r\n                type: 'reverse'\r\n            }\r\n        ));\r\n    }\r\n    \r\n    updateParticles(thrust, velocity) {\r\n        this.time += 0.016;\r\n        \r\n        // Check window.inputIntent for keyboard controls\r\n        const intent = window.inputIntent || 0;\r\n        const leftPressed = thrust.left || ((intent & 4) !== 0);  // A key\r\n        const rightPressed = thrust.right || ((intent & 8) !== 0); // D key\r\n        \r\n        // Update each thruster effect\r\n        this.thrusterEffects.forEach(effect => {\r\n            const { group, beams, type } = effect;\r\n            \r\n            let shouldShow = false;\r\n            let intensity = 0;\r\n            \r\n            // Determine visibility based on thrust\r\n            switch(type) {\r\n                case 'main':\r\n                    shouldShow = thrust.forward || velocity.length() > 1.0;\r\n                    intensity = thrust.forward ? (thrust.boost ? 1.5 : 1.0) : 0.5;\r\n                    break;\r\n                case 'right_thruster':\r\n                    // RIGHT thruster fires when A pressed (to move ship LEFT)\r\n                    shouldShow = leftPressed; // A key\r\n                    intensity = thrust.boost ? 1.5 : 1.2;\r\n                    if (shouldShow) console.log('RIGHT thruster firing to move LEFT');\r\n                    break;\r\n                case 'left_thruster':\r\n                    // LEFT thruster fires when D pressed (to move ship RIGHT)\r\n                    shouldShow = rightPressed; // D key\r\n                    intensity = thrust.boost ? 1.5 : 1.2;\r\n                    if (shouldShow) console.log('LEFT thruster firing to move RIGHT');\r\n                    break;\r\n                case 'reverse':\r\n                    shouldShow = thrust.backward;\r\n                    intensity = thrust.boost ? 1.3 : 1.0;\r\n                    break;\r\n            }\r\n            \r\n            group.visible = shouldShow;\r\n            \r\n            if (shouldShow && beams) {\r\n                // Animate the exhaust\r\n                beams.forEach((beam, index) => {\r\n                    const t = index / beams.length;\r\n                    \r\n                    // Very subtle flicker\r\n                    const flicker = 0.95 + Math.sin(this.time * 10 + index) * 0.05;\r\n                    \r\n                    // Update opacity for animation - ensure visibility\r\n                    beam.material.opacity = Math.max(0.7, (1.0 - t * 0.2) * intensity * flicker);\r\n                    \r\n                    // Subtle scale animation\r\n                    beam.mesh.scale.x = beam.mesh.scale.y = 1.0 + Math.sin(this.time * 8 + index) * 0.05;\r\n                    beam.mesh.scale.z = 1.0 + intensity * 0.3; // Longer when boosting\r\n                });\r\n            }\r\n        });\r\n    }\r\n    \r\n    updateTrailVisibility(isMoving, thrust, velocity) {\r\n        // Update main thruster visibility based on movement\r\n        const mainEffect = this.thrusterEffects.find(e => e.type === 'main');\r\n        if (mainEffect) {\r\n            const shouldShow = thrust.forward || (isMoving && velocity.length() > 2.0);\r\n            mainEffect.group.visible = shouldShow;\r\n        }\r\n    }\r\n    \r\n    dispose() {\r\n        // Clean up all thruster effects\r\n        this.thrusterEffects.forEach(effect => {\r\n            if (effect.group) {\r\n                if (effect.group.parent) {\r\n                    effect.group.parent.remove(effect.group);\r\n                }\r\n                \r\n                // Dispose of all children\r\n                effect.group.traverse(child => {\r\n                    if (child.geometry) child.geometry.dispose();\r\n                    if (child.material) child.material.dispose();\r\n                });\r\n            }\r\n        });\r\n        \r\n        this.thrusterEffects = [];\r\n    }\r\n}","// spaceship.js - Handles spaceship creation and management\r\n\r\nimport * as THREE from 'three';\r\nimport { TrailEffects } from './trail.js';\r\n\r\nexport class Spaceship {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.mesh = null;\r\n        this.thrusters = [];\r\n        this.leftCannon = null;\r\n        this.rightCannon = null;\r\n        this.leftEmitter = null;\r\n        this.rightEmitter = null;\r\n        this.miningLaser = null; // Will point to leftEmitter during initialization\r\n        this.velocity = new THREE.Vector3(0, 0, 0);\r\n        this.rotation = new THREE.Euler(0, 0, 0);\r\n        this.thrust = {\r\n            forward: false,\r\n            backward: false,\r\n            left: false,\r\n            right: false,\r\n            boost: false\r\n        };\r\n        this.trailEffects = null; // Will be initialized after mesh creation\r\n        this.shipScale = 2.0; // New property to track ship scale\r\n        \r\n        // Combat properties\r\n        this.hull = 100; // Current hull health\r\n        this.maxHull = 100; // Maximum hull health\r\n        this.shield = 50; // Current shield value\r\n        this.maxShield = 50; // Maximum shield value\r\n        this.isDestroyed = false; // Track if ship is destroyed\r\n        \r\n        // Docking and fuel properties\r\n        this.fuel = 100; // Start with full fuel\r\n        this.maxFuel = 100;\r\n        this.fuelConsumptionRate = 0.01; // Fuel used per frame when thrusting\r\n        this.isDocked = true; // Start docked by default (CHANGED FROM FALSE TO TRUE)\r\n        this.credits = 1000; // Starting credits\r\n        \r\n        // Initialize cargo (empty by default)\r\n        this.cargo = {\r\n            iron: 0,\r\n            gold: 0,\r\n            platinum: 0\r\n        };\r\n        \r\n        // Track fuel tank upgrades\r\n        this.fuelTankLevel = 1;\r\n        this.fuelUpgradeCost = 1000; // Initial upgrade cost\r\n        \r\n        // New upgrade properties for enhanced ship systems\r\n        this.engineLevel = 1;\r\n        this.engineUpgradeCost = 800;\r\n        this.maxVelocity = 25.0; // Starting max velocity\r\n        \r\n        this.miningLevel = 1;\r\n        this.miningUpgradeCost = 1200;\r\n        this.miningEfficiency = 1.0; // Multiplier for mining speed\r\n        \r\n        this.hullLevel = 1;\r\n        this.hullUpgradeCost = 1500;\r\n        this.collisionResistance = 1.0; // Multiplier for collision damage resistance\r\n        \r\n        this.scannerLevel = 1;\r\n        this.scannerUpgradeCost = 600;\r\n        this.scanRange = 1000; // Base scanner range\r\n        \r\n        // Deployable lasers\r\n        this.deployableLaserCount = 0; // Number of deployable lasers\r\n        \r\n        // Position where ship should undock to - moved further away from the sun\r\n        this.undockLocation = new THREE.Vector3(0, 10000, 0); // Middle of the stargate\r\n        \r\n        console.log(\"Creating spaceship...\");\r\n        this.createSpaceship();\r\n        \r\n        // Initialize trail effects after spaceship mesh is created\r\n        this.trailEffects = new TrailEffects(this.scene, this.mesh);\r\n        \r\n        // Start the ship invisible since it's docked\r\n        if (this.mesh) {\r\n            this.mesh.visible = false;\r\n        }\r\n        \r\n        console.log(\"Spaceship created successfully (docked state)\");\r\n    }\r\n    \r\n    // Methods for updating spaceship state in game loop\r\n    update(deltaTime) {\r\n        // Update any continuous effects or animations\r\n        if (this.updateParticles && !this.isDocked) {\r\n            this.updateParticles();\r\n        }\r\n    }\r\n    \r\n    createSpaceship() {\r\n        // Create spaceship group\r\n        this.mesh = new THREE.Group();\r\n        \r\n        // Scale the entire ship\r\n        this.mesh.scale.set(this.shipScale, this.shipScale, this.shipScale);\r\n        \r\n        // Set initial position to a safe location far from the sun\r\n        this.mesh.position.set(0, 2000, 0); // Position near stargate initially\r\n        \r\n        // Create the main body of the ship - sleek aerodynamic design using basic geometries\r\n        // Use a cylinder with a cone at the front instead of CapsuleGeometry\r\n        const bodyGroup = new THREE.Group();\r\n        \r\n        // Main hull cylinder\r\n        const cylinderGeometry = new THREE.CylinderGeometry(0.4, 0.5, 1.8, 12);\r\n        const bodyMaterial = new THREE.MeshPhongMaterial({ \r\n            color: 0xFFFFFF, // White base\r\n            specular: 0xFFD700, // Gold specular highlights\r\n            shininess: 100,\r\n            emissive: 0x222222,\r\n            emissiveIntensity: 0.1\r\n        });\r\n        \r\n        const bodyCylinder = new THREE.Mesh(cylinderGeometry, bodyMaterial);\r\n        bodyCylinder.rotation.x = Math.PI / 2; // Rotate to point forward\r\n        bodyGroup.add(bodyCylinder);\r\n        \r\n        // Front nose cone\r\n        const noseGeometry = new THREE.ConeGeometry(0.4, 0.8, 12);\r\n        const noseCone = new THREE.Mesh(noseGeometry, bodyMaterial);\r\n        noseCone.position.set(0, 0, -1.2);\r\n        noseCone.rotation.x = -Math.PI / 2; // Point forward\r\n        bodyGroup.add(noseCone);\r\n        \r\n        // Add the complete body to the ship\r\n        this.mesh.add(bodyGroup);\r\n        \r\n        // Add cockpit - glass dome\r\n        const cockpitGeometry = new THREE.SphereGeometry(0.35, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);\r\n        const cockpitMaterial = new THREE.MeshPhongMaterial({ \r\n            color: 0x88CCFF,\r\n            specular: 0xFFFFFF,\r\n            shininess: 100,\r\n            transparent: true,\r\n            opacity: 0.7,\r\n            emissive: 0x0066FF,\r\n            emissiveIntensity: 0.1\r\n        });\r\n        const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);\r\n        cockpit.position.set(0, 0.25, -0.2);\r\n        cockpit.rotation.x = -Math.PI / 2;\r\n        this.mesh.add(cockpit);\r\n        \r\n        // Add dual front cannons\r\n        const cannonGeometry = new THREE.CylinderGeometry(0.08, 0.06, 2.0, 8);\r\n        const cannonMaterial = new THREE.MeshPhongMaterial({ \r\n            color: 0xFFD700, // Gold\r\n            specular: 0xFFFFFF,\r\n            shininess: 80,\r\n            emissive: 0xFFD700,\r\n            emissiveIntensity: 0.2\r\n        });\r\n        \r\n        // Left cannon\r\n        this.leftCannon = new THREE.Mesh(cannonGeometry, cannonMaterial);\r\n        this.leftCannon.position.set(0.2, 0, -1.5); // Left side of cockpit\r\n        this.leftCannon.rotation.x = Math.PI / 2; // Point forward\r\n        this.mesh.add(this.leftCannon);\r\n        \r\n        // Right cannon\r\n        this.rightCannon = new THREE.Mesh(cannonGeometry, cannonMaterial);\r\n        this.rightCannon.position.set(-0.2, 0, -1.5); // Right side of cockpit\r\n        this.rightCannon.rotation.x = Math.PI / 2; // Point forward\r\n        this.mesh.add(this.rightCannon);\r\n        \r\n        // Add cannon emitters (glowing tips)\r\n        const emitterGeometry = new THREE.SphereGeometry(0.08, 16, 16);\r\n        const emitterMaterial = new THREE.MeshPhongMaterial({ \r\n            color: 0xFF6600,\r\n            emissive: 0xFF3300,\r\n            emissiveIntensity: 1\r\n        });\r\n        \r\n        // Left emitter\r\n        this.leftEmitter = new THREE.Mesh(emitterGeometry, emitterMaterial);\r\n        this.leftEmitter.position.set(0.2, 0, -2.5); // Front of left cannon\r\n        this.mesh.add(this.leftEmitter);\r\n        \r\n        // Right emitter\r\n        this.rightEmitter = new THREE.Mesh(emitterGeometry, emitterMaterial);\r\n        this.rightEmitter.position.set(-0.2, 0, -2.5); // Front of right cannon\r\n        this.mesh.add(this.rightEmitter);\r\n        \r\n        // Create mining laser emitter (use one of the cannons for mining)\r\n        this.miningLaser = this.leftEmitter;\r\n        \r\n        // Add curved wings - using custom shape for curves\r\n        const createCurvedWing = (isLeft) => {\r\n            const wingGroup = new THREE.Group();\r\n            \r\n            // Create curved wing shape using multiple segments\r\n            const wingMaterial = new THREE.MeshPhongMaterial({ \r\n                color: 0xFFFFFF, // White\r\n                specular: 0xFFD700, // Gold specular \r\n                shininess: 80,\r\n                emissive: 0xFFFFFF,\r\n                emissiveIntensity: 0.1\r\n            });\r\n            \r\n            // Wing base connecting to ship body\r\n            const wingBaseGeom = new THREE.BoxGeometry(0.1, 0.2, 0.6);\r\n            const wingBase = new THREE.Mesh(wingBaseGeom, wingMaterial);\r\n            wingBase.position.set(isLeft ? 0.55 : -0.55, 0, 0.2);\r\n            wingGroup.add(wingBase);\r\n            \r\n            // Curved part of wing - using custom curved mesh\r\n            const wingCurveGeom = new THREE.BoxGeometry(0.8, 0.1, 0.5);\r\n            const wingCurve = new THREE.Mesh(wingCurveGeom, wingMaterial);\r\n            \r\n            // Rotate and position to create curved wing effect\r\n            wingCurve.position.set(isLeft ? 1 : -1, 0, 0.2);\r\n            wingCurve.rotation.z = isLeft ? Math.PI / 8 : -Math.PI / 8;\r\n            wingGroup.add(wingCurve);\r\n            \r\n            // Wing tip with gold accent\r\n            const wingTipGeom = new THREE.BoxGeometry(0.3, 0.08, 0.3);\r\n            const goldMaterial = new THREE.MeshPhongMaterial({ \r\n                color: 0xFFD700, // Gold\r\n                specular: 0xFFFFFF, \r\n                shininess: 100,\r\n                emissive: 0xFFD700,\r\n                emissiveIntensity: 0.3\r\n            });\r\n            \r\n            const wingTip = new THREE.Mesh(wingTipGeom, goldMaterial);\r\n            wingTip.position.set(isLeft ? 1.4 : -1.4, 0, 0.2);\r\n            wingTip.rotation.z = isLeft ? Math.PI / 6 : -Math.PI / 6;\r\n            wingGroup.add(wingTip);\r\n            \r\n            return wingGroup;\r\n        };\r\n        \r\n        // Add wings to ship\r\n        const leftWing = createCurvedWing(true);\r\n        this.mesh.add(leftWing);\r\n        \r\n        const rightWing = createCurvedWing(false);\r\n        this.mesh.add(rightWing);\r\n        \r\n        // Add gold accents to body\r\n        const addGoldAccent = (width, height, depth, x, y, z, rotX = 0, rotY = 0, rotZ = 0) => {\r\n            const accentGeom = new THREE.BoxGeometry(width, height, depth);\r\n            const goldMaterial = new THREE.MeshPhongMaterial({ \r\n                color: 0xFFD700, // Gold\r\n                specular: 0xFFFFFF,\r\n                shininess: 100,\r\n                emissive: 0xFFD700,\r\n                emissiveIntensity: 0.3\r\n            });\r\n            \r\n            const accent = new THREE.Mesh(accentGeom, goldMaterial);\r\n            accent.position.set(x, y, z);\r\n            accent.rotation.set(rotX, rotY, rotZ);\r\n            this.mesh.add(accent);\r\n            return accent;\r\n        };\r\n        \r\n        // Add gold accents along the body\r\n        addGoldAccent(0.8, 0.05, 0.1, 0, -0.25, -0.3);\r\n        addGoldAccent(0.8, 0.05, 0.1, 0, -0.25, 0.3);\r\n        addGoldAccent(0.05, 0.05, 1.0, 0.3, -0.25, 0);\r\n        addGoldAccent(0.05, 0.05, 1.0, -0.3, -0.25, 0);\r\n        \r\n        // Add thrusters\r\n        const thrusterGeometry = new THREE.CylinderGeometry(0.2, 0.15, 0.5, 8);\r\n        const thrusterMaterial = new THREE.MeshPhongMaterial({ \r\n            color: 0xFFD700, // Gold\r\n            emissive: 0xFF5500,\r\n            emissiveIntensity: 0.5\r\n        });\r\n        \r\n        // Main thrusters (back)\r\n        const mainThruster = new THREE.Mesh(thrusterGeometry, thrusterMaterial);\r\n        mainThruster.position.z = 1.2; // Position at the back of the ship\r\n        mainThruster.rotation.x = Math.PI; // Point backward\r\n        this.mesh.add(mainThruster);\r\n        this.thrusters.push({ mesh: mainThruster, type: 'main' });\r\n        \r\n        // Front/Reverse thruster (new)\r\n        const reverseThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\r\n        reverseThruster.position.z = -1.0; // Position at the front of the ship\r\n        reverseThruster.rotation.x = 0; // Point forward\r\n        reverseThruster.scale.set(0.6, 0.6, 0.6); // Make it slightly smaller than main thruster\r\n        this.mesh.add(reverseThruster);\r\n        this.thrusters.push({ mesh: reverseThruster, type: 'reverse' });\r\n        \r\n        // Side thrusters for lateral movement\r\n        const leftThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\r\n        leftThruster.position.set(0.5, 0, 0.5);\r\n        leftThruster.rotation.z = Math.PI / 2; // Point to the right (for leftward thrust)\r\n        leftThruster.scale.set(0.5, 0.5, 0.5); // Make side thrusters smaller\r\n        this.mesh.add(leftThruster);\r\n        this.thrusters.push({ mesh: leftThruster, type: 'left' });\r\n        \r\n        const rightThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\r\n        rightThruster.position.set(-0.5, 0, 0.5);\r\n        rightThruster.rotation.z = -Math.PI / 2; // Point to the left (for rightward thrust)\r\n        rightThruster.scale.set(0.5, 0.5, 0.5); // Make side thrusters smaller\r\n        this.mesh.add(rightThruster);\r\n        this.thrusters.push({ mesh: rightThruster, type: 'right' });\r\n        \r\n        // Add to scene\r\n        this.scene.add(this.mesh);\r\n    }\r\n    \r\n    // Create mining laser beam - the actual beam is handled by the Controls class\r\n    activateMiningLaser() {\r\n        // Activate both emitters for a more powerful effect\r\n        if (this.leftEmitter && this.rightEmitter) {\r\n            // Left emitter\r\n            this.leftEmitter.material.emissiveIntensity = 1.5;\r\n            this.leftEmitter.scale.set(1.2, 1.2, 1.2);\r\n            \r\n            // Right emitter\r\n            this.rightEmitter.material.emissiveIntensity = 1.5;\r\n            this.rightEmitter.scale.set(1.2, 1.2, 1.2);\r\n        }\r\n    }\r\n    \r\n    deactivateMiningLaser() {\r\n        // Deactivate both emitters\r\n        if (this.leftEmitter && this.rightEmitter) {\r\n            // Left emitter\r\n            this.leftEmitter.material.emissiveIntensity = 1;\r\n            this.leftEmitter.scale.set(1, 1, 1);\r\n            \r\n            // Right emitter\r\n            this.rightEmitter.material.emissiveIntensity = 1;\r\n            this.rightEmitter.scale.set(1, 1, 1);\r\n        }\r\n    }\r\n    \r\n    // Removed createThrusterParticles - now in trail.js\r\n    \r\n    /* REMOVED THRUSTER PARTICLES CODE - NOW IN trail.js */\r\n    \r\n    // Removed createTrailEffect - now in trail.js\r\n    \r\n    updateParticles() {\r\n        // Delegate to trail effects module\r\n        if (this.trailEffects) {\r\n            this.trailEffects.updateParticles(this.thrust, this.velocity);\r\n        }\r\n    }\r\n    \r\n    /* REMOVED OLD updateParticles CODE - NOW IN trail.js */\r\n\r\n    dock() {\r\n        console.log(\"Docking spaceship\");\r\n        console.log(\"Spaceship values before docking:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            isDocked: this.isDocked\r\n        });\r\n        \r\n        this.isDocked = true;\r\n        this.velocity.set(0, 0, 0);\r\n        this.mesh.visible = false;\r\n        \r\n        console.log(\"Spaceship values after docking:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            isDocked: this.isDocked\r\n        });\r\n    }\r\n\r\n    undock() {\r\n        console.log(\"Undocking spaceship\");\r\n        console.log(\"Spaceship values before undocking:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            isDocked: this.isDocked\r\n        });\r\n        \r\n        // Store shield value before undocking to diagnose reset issue\r\n        const shieldBeforeUndock = this.shield;\r\n        \r\n        this.isDocked = false;\r\n        this.mesh.visible = true;\r\n        \r\n        // Check if shield was reset and restore it\r\n        if (this.shield !== shieldBeforeUndock) {\r\n            console.log(`SHIELD RESET DETECTED during undock! Value changed from ${shieldBeforeUndock} to ${this.shield}`);\r\n            console.log(\"Restoring shield value to:\", shieldBeforeUndock);\r\n            this.shield = shieldBeforeUndock;\r\n        }\r\n        \r\n        console.log(\"Spaceship values after undocking:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            isDocked: this.isDocked\r\n        });\r\n        \r\n        // When undocking, attempt to sync shield and hull values to the HealthComponent\r\n        this.syncValuesToHealthComponent();\r\n        \r\n        // If an undock location is specified, use that instead\r\n        if (this.undockLocation) {\r\n            this.mesh.position.copy(this.undockLocation);\r\n            \r\n            // Point away from the stargate (down toward sun)\r\n            this.mesh.rotation.set(Math.PI/2, 0, 0);\r\n        } else {\r\n            // Original behavior - position just outside the docking bay\r\n            const stargatePosition = this.scene.getObjectByName('stargate').position.clone();\r\n            stargatePosition.z += 550; // Move in front of the docking bay\r\n            this.mesh.position.copy(stargatePosition);\r\n            \r\n            // Reset rotation to face away from the stargate\r\n            this.mesh.rotation.set(0, Math.PI, 0);\r\n        }\r\n        \r\n        this.velocity.set(0, 0, 0); // This line resets velocity, but it's fine since we're undocking\r\n        \r\n        return this.mesh.position.clone();\r\n    }\r\n\r\n    refuel() {\r\n        console.log(\"Refueling spaceship\");\r\n        this.fuel = this.maxFuel;\r\n        return 100; // Cost of refueling\r\n    }\r\n\r\n    repairShield() {\r\n        const oldShield = this.shield;\r\n        console.log(`===== SHIELD REPAIR INITIATED =====`);\r\n        console.log(`Repairing shield: ${oldShield} → ${this.maxShield}`);\r\n        \r\n        // CRITICAL FIX: Set and verify shield repair\r\n        this.shield = this.maxShield;\r\n        console.log(`Shield value is now: ${this.shield} (Expected: ${this.maxShield})`);\r\n        \r\n        // Log full spaceship state for debugging\r\n        console.log(\"Full spaceship state after shield repair:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            fuel: this.fuel,\r\n            maxFuel: this.maxFuel\r\n        });\r\n        console.log(`===== SHIELD REPAIR COMPLETED =====`);\r\n        \r\n        // Sync the updated shield value to the player entity's HealthComponent\r\n        // Use direct entity access for more reliable syncing\r\n        if (window.game && window.game.world) {\r\n            try {\r\n                const players = window.game.world.getEntitiesByTag('player');\r\n                if (players && players.length > 0) {\r\n                    const health = players[0].getComponent('HealthComponent');\r\n                    if (health) {\r\n                        // Update shield directly on the component\r\n                        const oldHealthShield = health.shield;\r\n                        health.shield = this.shield;\r\n                        console.log(`Direct shield update on HealthComponent: ${oldHealthShield} → ${health.shield}`);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Error during direct HealthComponent update:\", e);\r\n            }\r\n        }\r\n        \r\n        // Also use the normal sync method\r\n        this.syncValuesToHealthComponent();\r\n        \r\n        return 150; // Cost of shield repair\r\n    }\r\n\r\n    repairHull() {\r\n        const oldHull = this.hull;\r\n        console.log(`===== HULL REPAIR INITIATED =====`);\r\n        console.log(`Repairing hull: ${oldHull} → ${this.maxHull}`);\r\n        \r\n        // CRITICAL FIX: Set and verify hull repair\r\n        this.hull = this.maxHull;\r\n        console.log(`Hull value is now: ${this.hull} (Expected: ${this.maxHull})`);\r\n        \r\n        // Log full spaceship state for debugging\r\n        console.log(\"Full spaceship state after hull repair:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull,\r\n            fuel: this.fuel,\r\n            maxFuel: this.maxFuel\r\n        });\r\n        console.log(`===== HULL REPAIR COMPLETED =====`);\r\n        \r\n        // Sync the updated hull value to the player entity's HealthComponent\r\n        // Use direct entity access for more reliable syncing\r\n        if (window.game && window.game.world) {\r\n            try {\r\n                const players = window.game.world.getEntitiesByTag('player');\r\n                if (players && players.length > 0) {\r\n                    const health = players[0].getComponent('HealthComponent');\r\n                    if (health) {\r\n                        // Update hull directly on the component\r\n                        const oldHealthHull = health.health;\r\n                        health.health = this.hull;\r\n                        console.log(`Direct hull update on HealthComponent: ${oldHealthHull} → ${health.health}`);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Error during direct HealthComponent update:\", e);\r\n            }\r\n        }\r\n        \r\n        // Also use the normal sync method\r\n        this.syncValuesToHealthComponent();\r\n        \r\n        return 200; // Cost of hull repair\r\n    }\r\n\r\n    consumeFuel() {\r\n        // Consume fuel when thrusting\r\n        if (this.thrust.forward || this.thrust.backward || this.thrust.left || this.thrust.right) {\r\n            let consumptionRate = this.fuelConsumptionRate;\r\n            \r\n            // Extra consumption when boosting\r\n            if (this.thrust.boost) {\r\n                consumptionRate *= 3;\r\n            }\r\n            \r\n            this.fuel = Math.max(0, this.fuel - consumptionRate);\r\n        }\r\n        \r\n        // Return true if we have fuel, false if empty\r\n        return this.fuel > 0;\r\n    }\r\n\r\n    // Add a new method for upgrading the fuel tank\r\n    upgradeFuelTank() {\r\n        console.log(\"Upgrading fuel tank\");\r\n        \r\n        // Double the fuel capacity\r\n        this.maxFuel *= 2;\r\n        \r\n        // Increase the fuel level to match the new capacity\r\n        this.fuel = this.maxFuel;\r\n        \r\n        // Increase the upgrade level\r\n        this.fuelTankLevel++;\r\n        \r\n        // Calculate the new upgrade cost (4x the previous cost)\r\n        this.fuelUpgradeCost *= 4;\r\n        \r\n        return this.maxFuel;\r\n    }\r\n    \r\n    // New method for upgrading engines\r\n    upgradeEngine() {\r\n        console.log(\"Upgrading engines\");\r\n        \r\n        // Increase max velocity by 25%\r\n        this.maxVelocity *= 1.25;\r\n        \r\n        // Upgrade visual appearance of thrusters\r\n        this.thrusters.forEach(thruster => {\r\n            if (thruster.mesh && thruster.mesh.material) {\r\n                // Make thrusters more intense with each upgrade\r\n                thruster.mesh.material.emissiveIntensity += 0.2;\r\n                \r\n                // Change thruster color slightly with each upgrade to show progression\r\n                if (this.engineLevel % 2 === 0) { // Every even level\r\n                    thruster.mesh.material.emissive.setHex(0xff8800); // More orange\r\n                } else {\r\n                    thruster.mesh.material.emissive.setHex(0xffaa00); // More yellow\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Increase the upgrade level\r\n        this.engineLevel++;\r\n        \r\n        // Calculate the new upgrade cost (2.5x the previous cost)\r\n        this.engineUpgradeCost = Math.floor(this.engineUpgradeCost * 2.5);\r\n        \r\n        return this.maxVelocity;\r\n    }\r\n    \r\n    // New method for upgrading mining laser\r\n    upgradeMiningLaser() {\r\n        console.log(\"Upgrading mining laser\");\r\n        \r\n        // Increase mining efficiency by 30%\r\n        this.miningEfficiency *= 1.3;\r\n        \r\n        // Upgrade visual appearance of mining laser emitters\r\n        if (this.leftEmitter && this.leftEmitter.material) {\r\n            // Increase the size of the left emitter\r\n            this.leftEmitter.scale.set(1.1, 1.1, 1.1);\r\n            \r\n            // Change the color based on level to show progression\r\n            const colors = [0xff0000, 0xff5500, 0xff9900, 0xffcc00, 0xffee00];\r\n            if (this.miningLevel < colors.length) {\r\n                this.leftEmitter.material.color.setHex(colors[this.miningLevel]);\r\n                this.leftEmitter.material.emissive.setHex(colors[this.miningLevel]);\r\n            }\r\n            \r\n            // Increase the emissive intensity\r\n            this.leftEmitter.material.emissiveIntensity += 0.2;\r\n        }\r\n        \r\n        // Also upgrade the right emitter to match\r\n        if (this.rightEmitter && this.rightEmitter.material) {\r\n            // Increase the size of the right emitter\r\n            this.rightEmitter.scale.set(1.1, 1.1, 1.1);\r\n            \r\n            // Change the color based on level to show progression\r\n            const colors = [0xff0000, 0xff5500, 0xff9900, 0xffcc00, 0xffee00];\r\n            if (this.miningLevel < colors.length) {\r\n                this.rightEmitter.material.color.setHex(colors[this.miningLevel]);\r\n                this.rightEmitter.material.emissive.setHex(colors[this.miningLevel]);\r\n            }\r\n            \r\n            // Increase the emissive intensity\r\n            this.rightEmitter.material.emissiveIntensity += 0.2;\r\n        }\r\n        \r\n        // Also update the cannons\r\n        if (this.leftCannon && this.leftCannon.material) {\r\n            // Make the cannons thicker with each upgrade\r\n            this.leftCannon.scale.x *= 1.1;\r\n            this.leftCannon.scale.y *= 1.1;\r\n        }\r\n        \r\n        if (this.rightCannon && this.rightCannon.material) {\r\n            // Make the cannons thicker with each upgrade\r\n            this.rightCannon.scale.x *= 1.1;\r\n            this.rightCannon.scale.y *= 1.1;\r\n        }\r\n        \r\n        // Increase the upgrade level\r\n        this.miningLevel++;\r\n        \r\n        // Calculate the new upgrade cost (3x the previous cost)\r\n        this.miningUpgradeCost = Math.floor(this.miningUpgradeCost * 3);\r\n        \r\n        return this.miningEfficiency;\r\n    }\r\n    \r\n    // New method for upgrading hull\r\n    upgradeHull() {\r\n        console.log(\"Upgrading hull\");\r\n        \r\n        // Increase collision resistance by 25%\r\n        this.collisionResistance *= 1.25;\r\n        \r\n        // Modify ship appearance to show hull upgrade\r\n        const bodyGroup = this.mesh.children.find(child => child instanceof THREE.Group);\r\n        \r\n        if (bodyGroup && bodyGroup.children) {\r\n            // Update both the cylinder and cone parts of the ship body\r\n            bodyGroup.children.forEach(part => {\r\n                if (part instanceof THREE.Mesh && part.material) {\r\n                    // Change the hull color slightly to indicate higher grade material\r\n                    if (this.hullLevel % 2 === 0) {\r\n                        // Even levels: more blue tint\r\n                        part.material.color.setHex(0x30c0d0);\r\n                    } else {\r\n                        // Odd levels: more green tint\r\n                        part.material.color.setHex(0x30d0c0);\r\n                    }\r\n                    \r\n                    // Increase shininess with each level to suggest better armor\r\n                    part.material.shininess += 10;\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Increase the upgrade level\r\n        this.hullLevel++;\r\n        \r\n        // Calculate the new upgrade cost (2x the previous cost)\r\n        this.hullUpgradeCost = Math.floor(this.hullUpgradeCost * 2);\r\n        \r\n        return this.collisionResistance;\r\n    }\r\n    \r\n    // New method for upgrading scanner\r\n    upgradeScanner() {\r\n        console.log(\"Upgrading scanner\");\r\n        \r\n        // Increase scanner range by 20%\r\n        this.scanRange *= 1.2;\r\n        \r\n        // Add visual indicator for scanner upgrade (could add scan dish or antenna)\r\n        // This is a simplified version - in a real implementation, you'd want to\r\n        // add actual mesh components to the ship\r\n        \r\n        // Increase the upgrade level\r\n        this.scannerLevel++;\r\n        \r\n        // Calculate the new upgrade cost (1.8x the previous cost)\r\n        this.scannerUpgradeCost = Math.floor(this.scannerUpgradeCost * 1.8);\r\n        \r\n        return this.scanRange;\r\n    }\r\n\r\n    updateTrailVisibility(isMoving) {\r\n        // Delegate to trail effects module\r\n        if (this.trailEffects) {\r\n            this.trailEffects.updateTrailVisibility(isMoving, this.thrust, this.velocity);\r\n        }\r\n    }\r\n    \r\n    /* REMOVED OLD updateTrailVisibility CODE - NOW IN trail.js */\r\n    \r\n    /**\r\n     * Subscribe to player entity destruction events\r\n     * @param {MessageBus} messageBus The game's message bus\r\n     */\r\n    subscribeToDestructionEvents(messageBus) {\r\n        if (!messageBus) return;\r\n        \r\n        messageBus.subscribe('entity.destroyed', (message) => {\r\n            const entity = message.data.entity;\r\n            \r\n            // Check if this is the player entity\r\n            if (entity && entity.hasTag && entity.hasTag('player')) {\r\n                console.log(\"Player entity destroyed - updating spaceship state\");\r\n                this.isDestroyed = true;\r\n                \r\n                // Update hull and shield values from the player entity if available\r\n                const healthComponent = entity.getComponent('HealthComponent');\r\n                if (healthComponent) {\r\n                    this.hull = healthComponent.health;\r\n                    this.shield = healthComponent.shield;\r\n                } else {\r\n                    // If no health component, just set to 0\r\n                    this.hull = 0;\r\n                    this.shield = 0;\r\n                }\r\n                \r\n                // Make visual changes to show destroyed state\r\n                this.handleDestruction();\r\n            }\r\n        });\r\n        \r\n        console.log(\"Spaceship subscribed to destruction events\");\r\n    }\r\n    \r\n    /**\r\n     * Handle ship destruction effects\r\n     */\r\n    handleDestruction() {\r\n        // Visual and behavioral changes for destroyed state\r\n        if (this.mesh) {\r\n            // Disable thrusters via trail effects\r\n            if (this.trailEffects) {\r\n                this.trailEffects.particleSystems.forEach(ps => {\r\n                    if (ps && ps.system) {\r\n                        ps.system.visible = false;\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // Trail disabled via trail effects module\r\n            \r\n            // Could add explosion effect, damage texture, etc.\r\n        }\r\n    }\r\n\r\n    // Method to sync hull and shield values to the player entity's HealthComponent\r\n    syncValuesToHealthComponent() {\r\n        console.log(\"Beginning shield and hull sync to HealthComponent\");\r\n        \r\n        console.log(\"Current spaceship values:\", {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull\r\n        });\r\n        \r\n        // Store the values that need to be synced to the HealthComponent\r\n        const valuesForSync = {\r\n            shield: this.shield,\r\n            maxShield: this.maxShield,\r\n            hull: this.hull,\r\n            maxHull: this.maxHull\r\n        };\r\n        \r\n        console.log(`Preparing to sync values to player HealthComponent: Shield=${this.shield}, Hull=${this.hull}`);\r\n        \r\n        // Try using the MessageBus to broadcast the sync event\r\n        try {\r\n            if (window.game && window.game.messageBus) {\r\n                // Use the message bus to publish a sync event for any interested components\r\n                window.game.messageBus.publish('player.syncHealth', valuesForSync);\r\n                console.log(\"Published player.syncHealth event to game.messageBus with values:\", valuesForSync);\r\n            } else if (window.mainMessageBus) {\r\n                // Try using the global message bus\r\n                window.mainMessageBus.publish('player.syncHealth', valuesForSync);\r\n                console.log(\"Published player.syncHealth event to mainMessageBus with values:\", valuesForSync);\r\n            } else {\r\n                console.warn(\"No message bus available to sync health values\");\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error publishing sync event:\", e);\r\n        }\r\n        \r\n        // Also try direct access as a fallback\r\n        try {\r\n            if (window.game && window.game.world) {\r\n                const players = window.game.world.getEntitiesByTag('player');\r\n                console.log(`Found ${players ? players.length : 0} player entities for direct sync`);\r\n                \r\n                if (players && players.length > 0) {\r\n                    const player = players[0];\r\n                    const health = player.getComponent('HealthComponent');\r\n                    \r\n                    if (health) {\r\n                        // Log pre-sync state\r\n                        console.log(\"DIRECT SYNC - HealthComponent before sync:\", {\r\n                            shield: health.shield,\r\n                            maxShield: health.maxShield,\r\n                            health: health.health,\r\n                            maxHealth: health.maxHealth\r\n                        });\r\n                        \r\n                        console.log(\"DIRECT SYNC - Spaceship values to sync:\", {\r\n                            shield: this.shield,\r\n                            maxShield: this.maxShield,\r\n                            hull: this.hull,\r\n                            maxHull: this.maxHull\r\n                        });\r\n                        \r\n                        // Sync shield value\r\n                        const oldShield = health.shield;\r\n                        health.shield = this.shield;\r\n                        health.maxShield = this.maxShield;\r\n                        \r\n                        // Sync hull value\r\n                        const oldHealth = health.health;\r\n                        health.health = this.hull;\r\n                        health.maxHealth = this.maxHull;\r\n                        \r\n                        console.log(`Directly synced values to HealthComponent: Shield ${oldShield} → ${health.shield}, Hull ${oldHealth} → ${health.health}`);\r\n                        \r\n                        // Verify sync was successful\r\n                        console.log(\"DIRECT SYNC - HealthComponent after sync:\", {\r\n                            shield: health.shield,\r\n                            maxShield: health.maxShield,\r\n                            health: health.health,\r\n                            maxHealth: health.maxHealth\r\n                        });\r\n                    } else {\r\n                        console.warn(\"Player entity found but has no HealthComponent\");\r\n                    }\r\n                } else {\r\n                    console.warn(\"No player entities found for direct sync\");\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error directly syncing values to HealthComponent:\", e);\r\n        }\r\n    }\r\n} ","// physics.js - Handles physics calculations and movement\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class Physics {\r\n    // Physics constants - significantly increased for super-fast movement\r\n    static THRUST_FORCE = 0.5;      // 5x increase from previous 0.1\r\n    static BOOST_MULTIPLIER = 4;    // Keep the same boost multiplier\r\n    static MAX_VELOCITY = 25.0;     // Default maximum velocity (will use spaceship's value if available)\r\n    static ROTATION_SPEED = 0.3;    // Increased for more responsive controls\r\n    static COLLISION_DISTANCE = 15; // Reduced from 70 to match actual ship size\r\n    static FRICTION = 0.01;         // Small friction to help with control (new)\r\n    \r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.spaceship = null; // Will be set later\r\n        this.camera = null; // Will be set later\r\n        \r\n        // Virtual rotation state for pointer lock\r\n        this.rotationState = {\r\n            x: 0,\r\n            y: 0\r\n        };\r\n        \r\n        // Collision state\r\n        this.collided = false;\r\n        \r\n        // For collision detection\r\n        this.raycaster = new THREE.Raycaster();\r\n        this.direction = new THREE.Vector3(0, 0, -1);\r\n        this.collisionDistance = Physics.COLLISION_DISTANCE; // Use the class constant for consistency\r\n    }\r\n    \r\n    // Set spaceship reference\r\n    setSpaceship(spaceship) {\r\n        this.spaceship = spaceship;\r\n    }\r\n    \r\n    // Set camera reference\r\n    setCamera(camera) {\r\n        this.camera = camera;\r\n    }\r\n    \r\n    update(deltaTime) {\r\n        if (!this.spaceship || this.spaceship.isDestroyed) return;\r\n        \r\n        // Check if ship is docked - skip physics if docked\r\n        if (this.spaceship.isDocked) return;\r\n        \r\n        // Skip physics updates if intro sequence is active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            return;\r\n        }\r\n        \r\n        // Use a normalized deltaTime to standardize physics at 60 FPS feel\r\n        // This is the key to frame rate independence\r\n        this.normalizedDeltaTime = deltaTime * 60;\r\n        \r\n        // Check if we have fuel\r\n        const hasFuel = this.spaceship.consumeFuel();\r\n        \r\n        // Apply thrust based on controls - only if we have fuel\r\n        let thrustVector = new THREE.Vector3(0, 0, 0);\r\n        let isThrusting = false;\r\n        \r\n        // Get the ship's forward direction\r\n        const shipForward = new THREE.Vector3(0, 0, -1);\r\n        shipForward.applyQuaternion(this.spaceship.mesh.quaternion);\r\n        \r\n        // Calculate dot product to determine how much we're moving forward\r\n        const forwardVelocity = shipForward.dot(this.spaceship.velocity);\r\n        \r\n        // Visual effects are now handled entirely by the trail module\r\n        // Physics only handles movement calculations\r\n        \r\n        if (hasFuel) {\r\n            // NOTE: Player authority migrating to ECS. Respect global inputIntent when available.\r\n            const intent = window.inputIntent || 0;\r\n            const forwardPressed = this.spaceship.thrust.forward || ((intent & 1) !== 0);\r\n            const backwardPressed = this.spaceship.thrust.backward || ((intent & 2) !== 0);\r\n            const leftPressed = this.spaceship.thrust.left || ((intent & 4) !== 0);\r\n            const rightPressed = this.spaceship.thrust.right || ((intent & 8) !== 0);\r\n            const boostPressed = this.spaceship.thrust.boost || ((intent & 16) !== 0);\r\n\r\n            // Forward thrust handling\r\n            if (forwardPressed) {\r\n                isThrusting = true;\r\n                const forwardThrust = new THREE.Vector3(0, 0, -Physics.THRUST_FORCE);\r\n                if (boostPressed) forwardThrust.multiplyScalar(Physics.BOOST_MULTIPLIER);\r\n                thrustVector.add(forwardThrust);\r\n                \r\n                // Visual effects handled by trail module\r\n            }\r\n            // Visual effects handled by trail module\r\n            \r\n            // Backward thrust handling\r\n            if (backwardPressed) {\r\n                isThrusting = true;\r\n                thrustVector.add(new THREE.Vector3(0, 0, Physics.THRUST_FORCE));\r\n                \r\n                // Visual effects handled by trail module\r\n            }\r\n            // Visual effects handled by trail module\r\n            \r\n            // Left thrust handling - A key pressed, move LEFT (negative X)\r\n            if (leftPressed) {\r\n                isThrusting = true;\r\n                thrustVector.add(new THREE.Vector3(-Physics.THRUST_FORCE, 0, 0));\r\n                \r\n                // Visual effects handled by trail module\r\n            }\r\n            // Visual effects handled by trail module\r\n            \r\n            // Right thrust handling - D key pressed, move RIGHT (positive X)\r\n            if (rightPressed) {\r\n                isThrusting = true;\r\n                thrustVector.add(new THREE.Vector3(Physics.THRUST_FORCE, 0, 0));\r\n                \r\n                // Visual effects handled by trail module\r\n            }\r\n            // Visual effects handled by trail module\r\n            \r\n            if (isThrusting) {\r\n                // Apply thrust in world space (only if actively thrusting)\r\n                thrustVector.applyQuaternion(this.spaceship.mesh.quaternion);\r\n                \r\n                // Apply thrust scaled by normalized delta time\r\n                thrustVector.multiplyScalar(this.normalizedDeltaTime);\r\n                this.spaceship.velocity.add(thrustVector);\r\n                \r\n                // Get the current max velocity from the spaceship\r\n                const maxVelocity = this.getMaxVelocity();\r\n                \r\n                // Cap velocity at maximum speed\r\n                if (this.spaceship.velocity.length() > maxVelocity) {\r\n                    this.spaceship.velocity.normalize().multiplyScalar(maxVelocity);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Add a small amount of \"space friction\" to make controls more manageable\r\n        // This isn't realistic physics but makes the game more enjoyable to play\r\n        if (!isThrusting && this.spaceship.velocity.length() > 0) {\r\n            const friction = Physics.FRICTION * this.normalizedDeltaTime;\r\n            if (this.spaceship.velocity.length() > friction) {\r\n                this.spaceship.velocity.multiplyScalar(1 - friction);\r\n            } else {\r\n                this.spaceship.velocity.set(0, 0, 0);\r\n            }\r\n        }\r\n        \r\n        // CRITICAL: Always update position based on current velocity (Newton's first law)\r\n        // Objects in motion stay in motion unless acted upon by a force\r\n        // Scale position update by normalized delta time\r\n        const positionDelta = this.spaceship.velocity.clone().multiplyScalar(this.normalizedDeltaTime);\r\n        this.spaceship.mesh.position.add(positionDelta);\r\n        \r\n        // Apply rotation based on rotationState\r\n        this.updateShipRotation();\r\n        \r\n        // Update camera position\r\n        this.updateCamera();\r\n        \r\n        // Update trail effects based on movement and thrust\r\n        if (this.spaceship.trailEffects) {\r\n            // Show effects based on ANY thrust or movement\r\n            const isThrusting = this.spaceship.thrust.forward || \r\n                               this.spaceship.thrust.backward || \r\n                               this.spaceship.thrust.left || \r\n                               this.spaceship.thrust.right;\r\n            const isMoving = this.spaceship.velocity.length() > 0.1;\r\n            \r\n            // Update trail effects directly\r\n            this.spaceship.trailEffects.updateTrailVisibility(isMoving, this.spaceship.thrust, this.spaceship.velocity);\r\n            this.spaceship.trailEffects.updateParticles(this.spaceship.thrust, this.spaceship.velocity);\r\n        }\r\n        \r\n        // Check for collisions with asteroids and planets\r\n        this.checkCollisions();\r\n    }\r\n    \r\n    // Helper method to get the max velocity from the spaceship or use the default\r\n    getMaxVelocity() {\r\n        return this.spaceship && this.spaceship.maxVelocity \r\n            ? this.spaceship.maxVelocity \r\n            : Physics.MAX_VELOCITY;\r\n    }\r\n    \r\n    updateShipRotation() {\r\n        if (!this.spaceship) return;\r\n        \r\n        // Cap y rotation to prevent flipping over (optional, can be adjusted or removed)\r\n        const maxY = Math.PI * 0.45; // Limit to ~45 degrees up/down\r\n        this.rotationState.y = Math.max(Math.min(this.rotationState.y, maxY), -maxY);\r\n        \r\n        // Create a quaternion for rotation\r\n        const euler = new THREE.Euler(this.rotationState.y, this.rotationState.x, 0, 'YXZ');\r\n        const targetQuaternion = new THREE.Quaternion().setFromEuler(euler);\r\n        \r\n        // Smoothly interpolate current rotation to target rotation\r\n        // Use rotation speed scaled by normalized delta time\r\n        this.spaceship.mesh.quaternion.slerp(targetQuaternion, Physics.ROTATION_SPEED * this.normalizedDeltaTime);\r\n    }\r\n    \r\n    updateCamera() {\r\n        if (!this.spaceship || !this.camera) return;\r\n        \r\n        // Skip camera updates if intro sequence is active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            console.log(\"Skipping camera update - intro sequence active\");\r\n            return;\r\n        }\r\n        \r\n        // Update the camera to follow the spaceship with offset\r\n        // Camera moved much closer to ship for a zoomed-in view\r\n        const cameraOffset = new THREE.Vector3(0, 5, 25); // Brought much closer (was 0, 15, 75)\r\n        \r\n        // Apply spaceship rotation to camera offset\r\n        const rotatedOffset = cameraOffset.clone();\r\n        rotatedOffset.applyQuaternion(this.spaceship.mesh.quaternion);\r\n        \r\n        // Position camera behind and slightly above the spaceship\r\n        this.camera.position.copy(this.spaceship.mesh.position).add(rotatedOffset);\r\n        \r\n        // Look ahead of the spaceship\r\n        const lookAtPoint = new THREE.Vector3(0, 0, -60); // Adjusted lookAt point (was -200)\r\n        lookAtPoint.applyQuaternion(this.spaceship.mesh.quaternion);\r\n        lookAtPoint.add(this.spaceship.mesh.position);\r\n        \r\n        this.camera.lookAt(lookAtPoint);\r\n        \r\n        // Force visible frustum (debugging purposes)\r\n        this.camera.far = 400000; // Ensure far clip plane is beyond skybox\r\n        this.camera.updateProjectionMatrix();\r\n    }\r\n    \r\n    // Update rotation based on mouse movement deltas\r\n    updateRotation(deltaX, deltaY) {\r\n        // Update the rotation directly\r\n        this.rotationState.x -= deltaX;\r\n        this.rotationState.y -= deltaY;\r\n    }\r\n    \r\n    // Check for collisions with asteroids and planets\r\n    checkCollisions() {\r\n        if (!this.scene || !this.spaceship) return;\r\n        \r\n        // Set a smaller collision radius based on actual ship size\r\n        // This was previously Physics.COLLISION_DISTANCE (70) which was too large\r\n        const shipRadius = 15; // Reduced from 70 to match actual ship size\r\n        const shipPosition = this.spaceship.mesh.position.clone();\r\n        \r\n        // First check if we're colliding with our own projectiles and skip those\r\n        this.scene.traverse(object => {\r\n            if (object.type === 'Mesh' && \r\n                object.geometry.type?.includes('SphereGeometry') && \r\n                object.userData.isPlayerProjectile &&\r\n                object.userData.sourceId === 'player') {\r\n                \r\n                // Skip our own projectiles - don't even process them\r\n                return;\r\n            }\r\n        });\r\n        \r\n        // 1. Check collisions with asteroids\r\n        const asteroidMeshes = [];\r\n        \r\n        // Direct access to the asteroid belt if possible\r\n        const asteroidBelt = this.scene.children.find(child => child.name === 'asteroidBelt');\r\n        let asteroids = [];\r\n        \r\n        // If we can get direct access to asteroid belt object, use that for better performance\r\n        if (asteroidBelt && asteroidBelt.userData && asteroidBelt.userData.asteroids) {\r\n            asteroids = asteroidBelt.userData.asteroids;\r\n            asteroidMeshes.push(...asteroids.map(a => a.mesh));\r\n        } else {\r\n            // Otherwise do the more expensive scene traversal\r\n            this.scene.traverse(object => {\r\n                // Check for asteroids using geometry type\r\n                if (object.type === 'Mesh' && \r\n                    (object.geometry.type?.includes('IcosahedronGeometry') || \r\n                     object.geometry.type?.includes('TetrahedronGeometry') || \r\n                     object.geometry.type?.includes('OctahedronGeometry'))) {\r\n                    \r\n                    // Only consider objects within the asteroid belt range to avoid false positives\r\n                    const distFromCenter = Math.sqrt(\r\n                        object.position.x * object.position.x + \r\n                        object.position.z * object.position.z\r\n                    );\r\n                    \r\n                    // Only include objects in the appropriate distance range from the center\r\n                    // This helps avoid mistaking other geometric objects for asteroids\r\n                    if (distFromCenter > 16000 && distFromCenter < 32000) {\r\n                        asteroidMeshes.push(object);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Check distance to each asteroid - precise collision detection\r\n        for (const asteroid of asteroidMeshes) {\r\n            // Skip null items or invisible asteroids\r\n            if (!asteroid || !asteroid.visible) continue;\r\n            \r\n            const distance = shipPosition.distanceTo(asteroid.position);\r\n            \r\n            // Use actual size from geometry if available - no artificial inflation\r\n            let asteroidRadius = 0;\r\n            \r\n            if (asteroid.geometry && asteroid.geometry.parameters && asteroid.geometry.parameters.radius) {\r\n                // Use the exact geometry radius without multiplication\r\n                asteroidRadius = asteroid.geometry.parameters.radius;\r\n            } else {\r\n                // Fallback size - more accurate estimation\r\n                asteroidRadius = 60; // 4x original value to match larger asteroids\r\n            }\r\n            \r\n            // If collision detected - uses the sum of actual ship and asteroid radii\r\n            if (distance < (shipRadius + asteroidRadius)) {\r\n                // Only log collision in debug mode\r\n                if (window.DEBUG_MODE) {\r\n                    console.log(\"Asteroid collision detected!\", \r\n                        \"Ship position:\", shipPosition,\r\n                        \"Asteroid position:\", asteroid.position,\r\n                        \"Distance:\", distance, \r\n                        \"Detection threshold:\", (shipRadius + asteroidRadius));\r\n                }\r\n                \r\n                this.handleCollision(asteroid, \"asteroid\");\r\n                return; // Exit after first collision\r\n            }\r\n        }\r\n        \r\n        // 2. Check collisions with planets\r\n        this.scene.traverse(object => {\r\n            // Check if this is a planet - they typically have larger scale\r\n            if (object.type === 'Mesh' && \r\n                object.geometry.type.includes('SphereGeometry') && \r\n                object.scale.x >= 1 && // To filter out particles and small objects\r\n                !object.userData.id?.startsWith('asteroid-') && // Not an asteroid\r\n                !object.userData.isPlayerProjectile && // Not a player projectile\r\n                object !== this.spaceship.mesh) { // Not the spaceship itself\r\n                \r\n                const distance = shipPosition.distanceTo(object.position);\r\n                \r\n                // For planets, we use the actual geometry radius without artificial inflation\r\n                const planetRadius = object.geometry.parameters.radius * object.scale.x;\r\n                \r\n                // If the object is the sun\r\n                if (object.material.emissive && \r\n                    object.material.emissive.r > 0.5 && \r\n                    object.material.emissive.g > 0.5) {\r\n                    // Sun collision: if we're within the exact combined radius\r\n                    if (distance < planetRadius + shipRadius) {\r\n                        this.handleCollision(object, \"sun\");\r\n                        return;\r\n                    }\r\n                } \r\n                // Regular planet collision\r\n                else if (distance < planetRadius + shipRadius) {\r\n                    this.handleCollision(object, \"planet\");\r\n                    return;\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    handleCollision(object, type) {\r\n        if (this.collided || !this.scene) return; // Only handle the first collision\r\n        \r\n        this.collided = true;\r\n        \r\n        // Enhanced logging for collision diagnostics (only in debug mode)\r\n        if (window.DEBUG_MODE) {\r\n            console.log(\"=== COLLISION DETECTED ===\");\r\n            console.log(`Collision type: ${type}`);\r\n            console.log(`Ship velocity at impact: ${this.spaceship.velocity.length().toFixed(2)} units/frame`);\r\n            console.log(`Ship position: x=${this.spaceship.mesh.position.x.toFixed(0)}, y=${this.spaceship.mesh.position.y.toFixed(0)}, z=${this.spaceship.mesh.position.z.toFixed(0)}`);\r\n            console.log(`${type} position: x=${object.position.x.toFixed(0)}, y=${object.position.y.toFixed(0)}, z=${object.position.z.toFixed(0)}`);\r\n            console.log(`Hull resistance: ${this.spaceship.collisionResistance}`);\r\n        }\r\n        \r\n        // Apply hull resistance to see if we survive the collision\r\n        if (this.attemptCollisionRecovery(type)) {\r\n            if (window.DEBUG_MODE) console.log(\"Hull absorbed collision damage!\");\r\n            this.createRecoveryEffect();\r\n            \r\n            // Bounce away from the collision point\r\n            if (object && object.position) {\r\n                const bounceDirection = new THREE.Vector3()\r\n                    .subVectors(this.spaceship.mesh.position, object.position)\r\n                    .normalize();\r\n                \r\n                // Apply a bounce force\r\n                this.spaceship.velocity.copy(bounceDirection.multiplyScalar(5));\r\n            }\r\n            \r\n            // Play the \"boink\" sound for minor collisions\r\n            if (window.game && window.game.audio) {\r\n                window.game.audio.playSound('boink');\r\n            }\r\n            \r\n            // Reset collision state after a short delay\r\n            setTimeout(() => {\r\n                this.collided = false;\r\n                if (window.DEBUG_MODE) console.log(\"Collision state reset - ship ready for new collisions\");\r\n            }, 1000);\r\n            \r\n            return;\r\n        }\r\n        \r\n        // If we didn't recover, publish game over event instead of handling directly\r\n        // Stop the ship\r\n        this.spaceship.velocity.set(0, 0, 0);\r\n        \r\n        // Different explosion effects based on collision type\r\n        let explosionColor, explosionSize, explosionMessage, collisionType;\r\n        \r\n        if (type === \"sun\") {\r\n            // Solar collision - big, bright yellow explosion\r\n            explosionColor = 0xffff00;\r\n            explosionSize = 60; // 4x original size (was 15)\r\n            explosionMessage = \"Your ship was incinerated by the sun!\";\r\n            collisionType = \"SUN_DEATH\";\r\n        } else if (type === \"planet\") {\r\n            // Planet collision - large blue-tinted explosion\r\n            explosionColor = 0x33ccff;\r\n            explosionSize = 40; // 4x original size (was 10)\r\n            explosionMessage = \"Your ship crashed into a planet!\";\r\n            collisionType = \"COLLISION_PLANET\";\r\n        } else {\r\n            // Default asteroid collision - smaller orange explosion\r\n            explosionColor = 0xff6600;\r\n            explosionSize = 20; // 4x original size (was 5)\r\n            explosionMessage = \"Your ship was destroyed by an asteroid!\";\r\n            collisionType = \"COLLISION_ASTEROID\";\r\n        }\r\n        \r\n        // Create visual effect for the collision\r\n        const explosionGeometry = new THREE.SphereGeometry(explosionSize, 32, 32);\r\n        const explosionMaterial = new THREE.MeshBasicMaterial({\r\n            color: explosionColor,\r\n            transparent: true,\r\n            opacity: 0.8\r\n        });\r\n        const explosion = new THREE.Mesh(explosionGeometry, explosionMaterial);\r\n        explosion.position.copy(this.spaceship.mesh.position);\r\n        this.scene.add(explosion);\r\n        \r\n        // Animate the explosion\r\n        this.animateExplosion(explosion);\r\n        \r\n        // Mark the ship as destroyed internally\r\n        if (this.spaceship) {\r\n            this.spaceship.isDestroyed = true;\r\n        }\r\n        \r\n        \r\n        console.log(\"Physics: Initiating game over sequence for collision with\", type);\r\n        \r\n        // Use window.mainMessageBus if available\r\n        if (window.mainMessageBus) {\r\n            console.log(\"Physics: Using window.mainMessageBus\");\r\n            window.mainMessageBus.publish('game.over', {\r\n                reason: explosionMessage,\r\n                source: \"physics\",\r\n                collisionType: type,\r\n                type: collisionType\r\n            });\r\n        } else if (window.game && window.game.messageBus) {\r\n            // Use game message bus if main message bus not available\r\n            console.log(\"Physics: Using window.game.messageBus\");\r\n            window.game.messageBus.publish('game.over', {\r\n                reason: explosionMessage,\r\n                source: \"physics\",\r\n                collisionType: type,\r\n                type: collisionType\r\n            });\r\n        } else {\r\n            // Only use MessageBus.triggerGameOver if no direct access\r\n            import('../core/messageBus.js').then(module => {\r\n                const MessageBus = module.MessageBus;\r\n                console.log(\"Physics: Using MessageBus.triggerGameOver\");\r\n                \r\n                MessageBus.triggerGameOver(explosionMessage, \"physics\");\r\n            }).catch(err => {\r\n                console.error(\"Physics: Error importing MessageBus:\", err);\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Method to attempt to recover from a collision based on hull resistance\r\n    attemptCollisionRecovery(collisionType) {\r\n        if (!this.spaceship || !this.spaceship.collisionResistance) \r\n            return false;\r\n        \r\n        // Get the hull resistance value\r\n        const resistance = this.spaceship.collisionResistance;\r\n        \r\n        // Different collision types have different chances of recovery\r\n        // Higher resistance increases chances\r\n        let recoveryChance = 0;\r\n        \r\n        switch (collisionType) {\r\n            case \"asteroid\":\r\n                // 50% base chance + 8% per hull level as requested\r\n                recoveryChance = 0.50 + (resistance - 1) * 0.08;\r\n                if (window.DEBUG_MODE) console.log(`Asteroid collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\r\n                break;\r\n            case \"planet\":\r\n                // Start with 10% chance, increased by hull resistance\r\n                recoveryChance = 0.1 + (resistance - 1) * 0.2;\r\n                if (window.DEBUG_MODE) console.log(`Planet collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\r\n                break;\r\n            case \"sun\":\r\n                // Almost no chance to survive sun collision\r\n                recoveryChance = (resistance - 1) * 0.05;\r\n                if (window.DEBUG_MODE) console.log(`Sun collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\r\n                break;\r\n            default:\r\n                recoveryChance = 0.2 + (resistance - 1) * 0.3;\r\n                if (window.DEBUG_MODE) console.log(`Generic collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\r\n        }\r\n        \r\n        // Random chance based on recovery probability\r\n        const recoveryRoll = Math.random();\r\n        const survived = recoveryRoll < recoveryChance;\r\n        \r\n        if (window.DEBUG_MODE) console.log(`Recovery roll: ${recoveryRoll.toFixed(3)}, needed ${recoveryChance.toFixed(3)} or lower to survive`);\r\n        \r\n        return survived;\r\n    }\r\n    \r\n    // Create a visual effect when the ship survives a collision\r\n    createRecoveryEffect() {\r\n        if (!this.spaceship || !this.scene) return;\r\n        \r\n        // Create a shield-like effect around the ship\r\n        const shieldGeometry = new THREE.SphereGeometry(60, 32, 32); // 4x original size (was 15)\r\n        const shieldMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0x30cfd0,\r\n            transparent: true,\r\n            opacity: 0.6,\r\n            side: THREE.DoubleSide\r\n        });\r\n        \r\n        const shield = new THREE.Mesh(shieldGeometry, shieldMaterial);\r\n        shield.position.copy(this.spaceship.mesh.position);\r\n        this.scene.add(shield);\r\n        \r\n        // Animate the shield (expand and fade out)\r\n        let scale = 1;\r\n        const expandSpeed = 0.05;\r\n        const fadeSpeed = 0.02;\r\n        \r\n        const animateShield = () => {\r\n            if (scale > 2 || shield.material.opacity <= 0) {\r\n                this.scene.remove(shield);\r\n                return;\r\n            }\r\n            \r\n            scale += expandSpeed;\r\n            shield.scale.set(scale, scale, scale);\r\n            shield.material.opacity -= fadeSpeed;\r\n            \r\n            // Update shield position to follow ship\r\n            if (this.spaceship && this.spaceship.mesh) {\r\n                shield.position.copy(this.spaceship.mesh.position);\r\n            }\r\n            \r\n            requestAnimationFrame(animateShield);\r\n        };\r\n        \r\n        animateShield();\r\n    }\r\n    \r\n    animateExplosion(explosion) {\r\n        let scale = 1;\r\n        const expandSpeed = 0.5;\r\n        const fadeSpeed = 0.02;\r\n        \r\n        const animate = () => {\r\n            if (scale > 20 || explosion.material.opacity <= 0) {\r\n                this.scene.remove(explosion);\r\n                return;\r\n            }\r\n            \r\n            scale += expandSpeed;\r\n            explosion.scale.set(scale, scale, scale);\r\n            explosion.material.opacity -= fadeSpeed;\r\n            \r\n            requestAnimationFrame(animate);\r\n        };\r\n        \r\n        animate();\r\n    }\r\n}","// skybox.js - Creates and manages advanced procedural skybox with volumetric effects\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class Skybox {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.skybox = null;\r\n        this.time = 0;\r\n        \r\n        // Create texture loader\r\n        this.textureLoader = new THREE.TextureLoader();\r\n        \r\n        // Load the Milky Way texture\r\n        this.milkyWayTexture = this.textureLoader.load('./assets/2k_stars_milky_way.jpg');\r\n        this.milkyWayTexture.colorSpace = THREE.SRGBColorSpace;\r\n        \r\n        // Store additional skybox textures\r\n        this.skyboxTextures = {};\r\n        \r\n        // Store initial parameters for the Solar System\r\n        this.solarSystemParams = {\r\n            starDensity: 1.0,\r\n            nebulaDensity: 0.5,\r\n            color: 0xFFFFFF,\r\n            texturePath: './assets/2k_stars_milky_way.jpg',\r\n            brightness: 1.0 // Default brightness for Solar System\r\n        };\r\n        \r\n        this.createProceduralSkybox(this.solarSystemParams);\r\n    }\r\n    \r\n    // Update skybox based on star system parameters\r\n    updateForSystem(params) {\r\n        if (!params) return;\r\n        \r\n        console.log(\"Updating skybox with parameters:\", params);\r\n        \r\n        // Special case for Solar System - ensure consistent appearance\r\n        if (params.isSolarSystem || \r\n            (params.color === 0xFFFFFF && params.starDensity === 1.0 && params.nebulaDensity === 0.5)) {\r\n            console.log(\"Detected Solar System skybox parameters, using stored solar system configuration\");\r\n            params = this.solarSystemParams;\r\n        }\r\n        \r\n        // Remove existing skybox\r\n        if (this.skybox) {\r\n            console.log(\"Removing existing skybox\");\r\n            this.scene.remove(this.skybox);\r\n        }\r\n        \r\n        // Reset time for consistent star pattern\r\n        if (params.resetTime) {\r\n            this.time = 0;\r\n        }\r\n        \r\n        // Create new skybox with system parameters\r\n        this.createProceduralSkybox(params);\r\n    }\r\n    \r\n    // Load texture if needed and return it\r\n    getTexture(texturePath) {\r\n        // Use default Milky Way texture if none specified\r\n        if (!texturePath) {\r\n            return this.milkyWayTexture;\r\n        }\r\n        \r\n        // Return Milky Way texture for the default Solar System texture\r\n        if (texturePath === './assets/2k_stars_milky_way.jpg') {\r\n            return this.milkyWayTexture;\r\n        }\r\n        \r\n        // Fix texture path for API server images\r\n        let adjustedTexturePath = texturePath;\r\n        \r\n        // Check if this is an image from our API server\r\n        if (texturePath.startsWith('/images/')) {\r\n            // If running on port 8000, adjust URL to point to port 8001\r\n            if (window.location.port === '8000') {\r\n                const serverHost = window.location.hostname;\r\n                adjustedTexturePath = `http://${serverHost}:8001${texturePath}`;\r\n                console.log(`Adjusted texture path to API server: ${adjustedTexturePath}`);\r\n            }\r\n        }\r\n        \r\n        // Load the texture if not already loaded\r\n        if (!this.skyboxTextures[texturePath]) {\r\n            console.log(`Loading new skybox texture: ${adjustedTexturePath}`);\r\n            this.skyboxTextures[texturePath] = this.textureLoader.load(adjustedTexturePath);\r\n            this.skyboxTextures[texturePath].colorSpace = THREE.SRGBColorSpace;\r\n        }\r\n        \r\n        return this.skyboxTextures[texturePath];\r\n    }\r\n    \r\n    createProceduralSkybox(params = {}) {\r\n        // Apply system parameters if provided\r\n        let starDensity = params?.starDensity || 1.0;\r\n        let nebulaDensity = params?.nebulaDensity || 0.5;\r\n        let skyboxColor = params?.color || 0x000000;\r\n        let brightness = params?.brightness !== undefined ? params.brightness : 1.0;\r\n        const size = 320000; // Very large size to contain entire game world (4x original)\r\n        const texturePath = params?.texturePath || './assets/2k_stars_milky_way.jpg';\r\n        \r\n        console.log(`Creating enhanced skybox with star density: ${starDensity}, nebula density: ${nebulaDensity}, color: 0x${skyboxColor.toString(16)}, texture: ${texturePath}, brightness: ${brightness}`);\r\n        \r\n        // Get the appropriate texture\r\n        const skyboxTexture = this.getTexture(texturePath);\r\n        \r\n        // Create advanced shader material for skybox with texture\r\n        const skyMaterial = new THREE.ShaderMaterial({\r\n            uniforms: {\r\n                time: { value: this.time || 0 },\r\n                milkyWayTexture: { value: skyboxTexture },\r\n                starDensity: { value: starDensity },\r\n                nebulaDensity: { value: nebulaDensity },\r\n                skyColor: { value: new THREE.Color(skyboxColor) },\r\n                brightness: { value: brightness }\r\n            },\r\n            vertexShader: `\r\n                varying vec2 vUv;\r\n                varying vec3 vPosition;\r\n                \r\n                void main() {\r\n                    vUv = uv;\r\n                    vPosition = position;\r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            fragmentShader: `\r\n                uniform sampler2D milkyWayTexture;\r\n                uniform float time;\r\n                uniform float starDensity;\r\n                uniform float nebulaDensity;\r\n                uniform vec3 skyColor;\r\n                uniform float brightness;\r\n                \r\n                varying vec2 vUv;\r\n                varying vec3 vPosition;\r\n                \r\n                void main() {\r\n                    // Sample the Milky Way texture with adjusted brightness\r\n                    vec4 milkyWay = texture2D(milkyWayTexture, vUv);\r\n                    milkyWay.rgb *= 1.5 * brightness; // Apply brightness factor\r\n                    \r\n                    // Use only the Milky Way texture without procedural stars\r\n                    vec3 finalColor = milkyWay.rgb * nebulaDensity * 1.2 * brightness;\r\n                    \r\n                    // Reduced ambient light\r\n                    finalColor += vec3(0.05);\r\n                    \r\n                    // Subtle color tint\r\n                    finalColor = mix(finalColor, skyColor * 1.2 * brightness, 0.1);\r\n                    \r\n                    // Apply gamma correction for more natural brightness\r\n                    finalColor = pow(finalColor, vec3(0.9));\r\n                    \r\n                    gl_FragColor = vec4(finalColor, 1.0);\r\n                }\r\n            `,\r\n            side: THREE.BackSide\r\n        });\r\n        \r\n        // Create the skybox mesh\r\n        const skyboxGeometry = new THREE.BoxGeometry(size, size, size);\r\n        this.skybox = new THREE.Mesh(skyboxGeometry, skyMaterial);\r\n        \r\n        // Rotate the skybox to align the Milky Way with the galactic plane\r\n        this.skybox.rotation.x = Math.PI / 4;\r\n        this.skybox.rotation.y = Math.PI / 6;\r\n        \r\n        this.scene.add(this.skybox);\r\n        \r\n        // Store material for updates\r\n        this.skyMaterial = skyMaterial;\r\n        \r\n        console.log(\"Enhanced skybox created with texture\");\r\n    }\r\n    \r\n    update(deltaTime = 0.016, camera) {\r\n        // Update skybox animation\r\n        if (this.skyMaterial) {\r\n            this.time += deltaTime * 0.1; // Slower star movement\r\n            this.skyMaterial.uniforms.time.value = this.time;\r\n        }\r\n        \r\n        // Keep skybox centered on camera if it exists\r\n        if (this.skybox && camera) {\r\n            this.skybox.position.copy(camera.position);\r\n        }\r\n    }\r\n}","// sun.js - Creates and manages the sun object (central star) with volumetric rendering\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class Sun {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.sun = null;\r\n        this.sunFlickerIntensity = 1.0;\r\n        this.sunFlickerDirection = 0.02;\r\n        this.time = 0;\r\n        this.sunType = 'G'; // Default sun type (G-type like our Sun)\r\n        this.lensFlares = []; // Store multiple flare elements\r\n        this.createSun();\r\n    }\r\n    \r\n    createSun() {\r\n        // Create a group to hold all sun-related elements\r\n        this.sun = new THREE.Group();\r\n        this.sun.name = 'sun'; // Add name for easier identification\r\n        this.scene.add(this.sun);\r\n        \r\n        // Create the core sun sphere with increased size\r\n        const sunGeometry = new THREE.SphereGeometry(1000, 64, 64); // Reduced from 1200\r\n        \r\n        // Use advanced shader material for the sun surface\r\n        const sunMaterial = new THREE.ShaderMaterial({\r\n            uniforms: {\r\n                time: { value: 0 },\r\n                sunColor: { value: new THREE.Color(0xff7700) },\r\n                surfaceDetail: { value: 1.2 }, // Increased detail\r\n                surfaceDistortion: { value: 0.3 }, // Increased distortion\r\n                sunActivity: { value: 0.8 } // Increased activity\r\n            },\r\n            vertexShader: `\r\n                varying vec3 vNormal;\r\n                varying vec2 vUv;\r\n                varying vec3 vPosition;\r\n                \r\n                void main() {\r\n                    vUv = uv;\r\n                    vNormal = normalize(normalMatrix * normal);\r\n                    vPosition = position;\r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            fragmentShader: `\r\n                uniform float time;\r\n                uniform vec3 sunColor;\r\n                uniform float surfaceDetail;\r\n                uniform float surfaceDistortion;\r\n                uniform float sunActivity;\r\n                \r\n                varying vec3 vNormal;\r\n                varying vec2 vUv;\r\n                varying vec3 vPosition;\r\n                \r\n                // Noise functions for surface detail\r\n                float hash(float n) { return fract(sin(n) * 43758.5453123); }\r\n                float hash(vec2 p) { return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453); }\r\n                \r\n                float noise(vec3 x) {\r\n                    vec3 p = floor(x);\r\n                    vec3 f = fract(x);\r\n                    f = f * f * (3.0 - 2.0 * f);\r\n                    \r\n                    float n = p.x + p.y * 157.0 + 113.0 * p.z;\r\n                    return mix(\r\n                        mix(mix(hash(n + 0.0), hash(n + 1.0), f.x),\r\n                            mix(hash(n + 157.0), hash(n + 158.0), f.x), f.y),\r\n                        mix(mix(hash(n + 113.0), hash(n + 114.0), f.x),\r\n                            mix(hash(n + 270.0), hash(n + 271.0), f.x), f.y),\r\n                        f.z);\r\n                }\r\n                \r\n                // Fractional Brownian Motion for layered detail\r\n                float fbm(vec3 x) {\r\n                    float v = 0.0;\r\n                    float a = 0.5;\r\n                    vec3 shift = vec3(100);\r\n                    \r\n                    for (int i = 0; i < 7; ++i) { // Increased iterations for more detail\r\n                        v += a * noise(x);\r\n                        x = x * 2.0 + shift;\r\n                        a *= 0.5;\r\n                    }\r\n                    \r\n                    return v;\r\n                }\r\n                \r\n                void main() {\r\n                    // Calculate dynamic granulation based on noise\r\n                    vec3 surfacePos = vPosition * surfaceDetail * 0.01;\r\n                    float granulation = fbm(surfacePos + time * 0.15); // Increased speed\r\n                    \r\n                    // Calculate solar prominences and flares with more dynamic movement\r\n                    float flareBase = fbm(surfacePos * 2.5 + time * 0.3); // Increased detail and speed\r\n                    float flares = pow(flareBase, 1.8) * sunActivity;\r\n                    flares = smoothstep(0.65, 0.9, flares); // Lower threshold for more flares\r\n                    \r\n                    // Create dynamic hotspots that move across the surface\r\n                    float hotspots = fbm(surfacePos * 3.0 + time * 0.2) * fbm(surfacePos * 1.5 - time * 0.1);\r\n                    hotspots = pow(hotspots, 3.0) * 1.5;\r\n                    \r\n                    // Calculate normal distortion for surface waves with more turbulence\r\n                    vec3 distortedNormal = vNormal;\r\n                    distortedNormal.x += noise(surfacePos * 6.0 + time * 0.15) * surfaceDistortion;\r\n                    distortedNormal.y += noise(surfacePos * 6.0 + time * 0.2) * surfaceDistortion;\r\n                    distortedNormal.z += noise(surfacePos * 6.0 + time * 0.17) * surfaceDistortion;\r\n                    distortedNormal = normalize(distortedNormal);\r\n                    \r\n                    // Edge brightness (limb darkening inverse - brighter at the edges)\r\n                    float edgeBrightness = 1.0 - dot(distortedNormal, vec3(0.0, 0.0, 1.0));\r\n                    edgeBrightness = pow(edgeBrightness, 2.5) * 0.4; // Reduced power and multiplier\r\n                    \r\n                    // Create fire-like color variations\r\n                    vec3 baseColor = sunColor;\r\n                    vec3 hotColor = vec3(1.0, 0.8, 0.4); // Yellow-white hot spots\r\n                    vec3 flareColor = vec3(1.0, 0.6, 0.3); // Orange-red flares\r\n                    \r\n                    // Combine effects for a more dynamic fireball look\r\n                    vec3 finalColor = baseColor * (1.0 + granulation * 0.4);\r\n                    finalColor = mix(finalColor, hotColor, hotspots);\r\n                    finalColor += flareColor * flares;\r\n                    finalColor += vec3(1.0, 0.9, 0.7) * edgeBrightness;\r\n                    \r\n                    // Output with HDR values\r\n                    gl_FragColor = vec4(finalColor, 1.0);\r\n                }\r\n            `,\r\n            side: THREE.FrontSide\r\n        });\r\n        \r\n        const sunCoreMesh = new THREE.Mesh(sunGeometry, sunMaterial);\r\n        this.sun.add(sunCoreMesh);\r\n        \r\n        // Add corona layer (volumetric glow effect)\r\n        const coronaGeometry = new THREE.SphereGeometry(2000, 64, 64); // Reduced from 2400\r\n        const coronaMaterial = new THREE.ShaderMaterial({\r\n            uniforms: {\r\n                time: { value: 0 },\r\n                coronaColor: { value: new THREE.Color(0xff9940) },\r\n                viewVector: { value: new THREE.Vector3(0, 0, 1) },\r\n                turbulence: { value: 0.6 } // Medium turbulence\r\n            },\r\n            vertexShader: `\r\n                uniform vec3 viewVector;\r\n                varying vec3 vNormal;\r\n                varying vec3 vPosition;\r\n                varying float vIntensity;\r\n                \r\n                void main() {\r\n                    vNormal = normalize(normalMatrix * normal);\r\n                    vPosition = position;\r\n                    \r\n                    // Calculate view-dependent intensity with less view dependency\r\n                    vec3 viewDir = normalize(viewVector);\r\n                    // Use a lower exponent and add a base intensity to ensure visibility from all angles\r\n                    vIntensity = pow(1.15 - dot(vNormal, viewDir), 1.5) * 0.8 + 0.2;\r\n                    \r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            fragmentShader: `\r\n                uniform float time;\r\n                uniform vec3 coronaColor;\r\n                uniform float turbulence;\r\n                \r\n                varying vec3 vNormal;\r\n                varying vec3 vPosition;\r\n                varying float vIntensity;\r\n                \r\n                // Noise functions\r\n                float hash(vec3 p) {\r\n                    p = fract(p * vec3(443.897, 441.423, 437.195));\r\n                    p += dot(p, p.yzx + 19.19);\r\n                    return fract((p.x + p.y) * p.z);\r\n                }\r\n                \r\n                float noise(vec3 p) {\r\n                    vec3 i = floor(p);\r\n                    vec3 f = fract(p);\r\n                    f = f*f*(3.0-2.0*f);\r\n                    \r\n                    return mix(\r\n                        mix(mix(hash(i), hash(i + vec3(1,0,0)), f.x),\r\n                            mix(hash(i + vec3(0,1,0)), hash(i + vec3(1,1,0)), f.x), f.y),\r\n                        mix(mix(hash(i + vec3(0,0,1)), hash(i + vec3(1,0,1)), f.x),\r\n                            mix(hash(i + vec3(0,1,1)), hash(i + vec3(1,1,1)), f.x), f.y), f.z);\r\n                }\r\n                \r\n                float fbm(vec3 p) {\r\n                    float f = 0.0;\r\n                    float weight = 0.5;\r\n                    for (int i = 0; i < 5; i++) {\r\n                        f += weight * noise(p);\r\n                        weight *= 0.5;\r\n                        p *= 2.0;\r\n                    }\r\n                    return f;\r\n                }\r\n                \r\n                void main() {\r\n                    // Add turbulence to the corona intensity based on position\r\n                    float turbulenceFactor = fbm(vPosition * 0.005 + time * 0.15) * turbulence;\r\n                    float finalIntensity = vIntensity * (1.0 + turbulenceFactor);\r\n                    \r\n                    // Create dynamic wisps in the corona for a fire-like effect\r\n                    float wisps = fbm(vPosition * 0.01 - time * 0.05) * fbm(vPosition * 0.02 + time * 0.1);\r\n                    wisps = pow(wisps, 2.0) * 0.5;\r\n                    \r\n                    // HDR color with variation\r\n                    vec3 finalColor = coronaColor * (finalIntensity + wisps);\r\n                    \r\n                    // Add color variation based on intensity\r\n                    if (finalIntensity > 0.7) {\r\n                        finalColor = mix(finalColor, vec3(1.0, 0.9, 0.7), (finalIntensity - 0.7) * 3.0);\r\n                    }\r\n                    \r\n                    // Add transparency at the edges for volumetric feel\r\n                    float alpha = smoothstep(0.0, 0.15, finalIntensity + wisps * 0.5);\r\n                    \r\n                    gl_FragColor = vec4(finalColor, alpha * 0.9); // Slightly more transparent\r\n                }\r\n            `,\r\n            transparent: true,\r\n            blending: THREE.AdditiveBlending,\r\n            depthWrite: false,\r\n            side: THREE.BackSide\r\n        });\r\n        \r\n        const coronaMesh = new THREE.Mesh(coronaGeometry, coronaMaterial);\r\n        this.sun.add(coronaMesh);\r\n        \r\n        // Add outer corona for extended glow\r\n        const outerCoronaGeometry = new THREE.SphereGeometry(3000, 32, 32); // Reduced from 3600\r\n        const outerCoronaMaterial = new THREE.ShaderMaterial({\r\n            uniforms: {\r\n                time: { value: 0 },\r\n                coronaColor: { value: new THREE.Color(0xff8800) },\r\n                viewVector: { value: new THREE.Vector3(0, 0, 1) }\r\n            },\r\n            vertexShader: `\r\n                uniform vec3 viewVector;\r\n                varying float vIntensity;\r\n                varying vec3 vPosition;\r\n                \r\n                void main() {\r\n                    vec3 vNormal = normalize(normalMatrix * normal);\r\n                    vec3 vNormel = normalize(viewVector);\r\n                    // Less extreme view dependency to ensure more consistent appearance\r\n                    vIntensity = pow(1.05 - dot(vNormal, vNormel), 2.0) * 0.7 + 0.3;\r\n                    vPosition = position;\r\n                    \r\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n                }\r\n            `,\r\n            fragmentShader: `\r\n                uniform float time;\r\n                uniform vec3 coronaColor;\r\n                varying float vIntensity;\r\n                varying vec3 vPosition;\r\n                \r\n                // Simple noise for variation\r\n                float hash(vec3 p) {\r\n                    p = fract(p * vec3(443.897, 441.423, 437.195));\r\n                    p += dot(p, p.yzx + 19.19);\r\n                    return fract((p.x + p.y) * p.z);\r\n                }\r\n                \r\n                float noise(vec3 p) {\r\n                    vec3 i = floor(p);\r\n                    vec3 f = fract(p);\r\n                    f = f*f*(3.0-2.0*f);\r\n                    \r\n                    return mix(\r\n                        mix(mix(hash(i), hash(i + vec3(1,0,0)), f.x),\r\n                            mix(hash(i + vec3(0,1,0)), hash(i + vec3(1,1,0)), f.x), f.y),\r\n                        mix(mix(hash(i + vec3(0,0,1)), hash(i + vec3(1,0,1)), f.x),\r\n                            mix(hash(i + vec3(0,1,1)), hash(i + vec3(1,1,1)), f.x), f.y), f.z);\r\n                }\r\n                \r\n                void main() {\r\n                    // Apply time-based pulsing with noise variation\r\n                    float noiseVal = noise(vPosition * 0.002 + time * 0.1);\r\n                    float pulseIntensity = vIntensity * (1.0 + 0.2 * sin(time + noiseVal * 5.0));\r\n                    \r\n                    // Add subtle fire-like variations\r\n                    pulseIntensity += noiseVal * 0.2;\r\n                    \r\n                    vec3 glow = coronaColor * pulseIntensity;\r\n                    gl_FragColor = vec4(glow, pulseIntensity * 0.4); // Reduced from 0.6\r\n                }\r\n            `,\r\n            transparent: true,\r\n            blending: THREE.AdditiveBlending,\r\n            depthWrite: false,\r\n            side: THREE.BackSide\r\n        });\r\n        \r\n        const outerCoronaMesh = new THREE.Mesh(outerCoronaGeometry, outerCoronaMaterial);\r\n        this.sun.add(outerCoronaMesh);\r\n        \r\n        // Add sun light with increased intensity but focused on a smaller range\r\n        const sunLight = new THREE.PointLight(0xFFFAF0, 200000, 100000, 2); // Using pure white with a hint of warmth\r\n        this.sun.add(sunLight);\r\n        \r\n        // Create multiple lens flare elements distributed around the sun\r\n        this.createFireballFlares();\r\n        \r\n        // Store material references for updates\r\n        this.sunMaterial = sunMaterial;\r\n        this.coronaMaterial = coronaMaterial;\r\n        this.outerCoronaMaterial = outerCoronaMaterial;\r\n        this.sunLight = sunLight;\r\n\r\n        // Store base light intensity for balancing\r\n        this.baseLightIntensity = 200000; // Increased from 100000\r\n        \r\n        // Add a directional light for casting shadows across the solar system\r\n        const sunDirectionalLight = new THREE.DirectionalLight(0xFFFAF0, 1.5);\r\n        sunDirectionalLight.position.set(0, 0, 0);\r\n        sunDirectionalLight.castShadow = true;\r\n        \r\n        // Configure shadow mapping for large-scale space scene\r\n        sunDirectionalLight.shadow.mapSize.width = 4096;\r\n        sunDirectionalLight.shadow.mapSize.height = 4096;\r\n        sunDirectionalLight.shadow.camera.near = 1000;\r\n        sunDirectionalLight.shadow.camera.far = 100000;\r\n        sunDirectionalLight.shadow.camera.left = -50000;\r\n        sunDirectionalLight.shadow.camera.right = 50000;\r\n        sunDirectionalLight.shadow.camera.top = 50000;\r\n        sunDirectionalLight.shadow.camera.bottom = -50000;\r\n        sunDirectionalLight.shadow.bias = -0.00005;\r\n        sunDirectionalLight.shadow.normalBias = 0.02;\r\n        sunDirectionalLight.shadow.radius = 2; // For softer shadows\r\n\r\n        // Use PCFSoftShadowMap for better shadow quality\r\n        if (this.scene && this.scene.renderer) {\r\n            this.scene.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n        }\r\n        \r\n        this.sun.add(sunDirectionalLight);\r\n        this.sunDirectionalLight = sunDirectionalLight;\r\n    }\r\n    \r\n    // New method to create multiple flare elements\r\n    createFireballFlares() {\r\n        // Load different flare textures\r\n        const flareTextures = [\r\n            'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare0.png',\r\n            'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare2.png',\r\n            'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/textures/lensflare/lensflare3.png'\r\n        ];\r\n        \r\n        const textureLoader = new THREE.TextureLoader();\r\n        \r\n        // Clear any existing flares\r\n        this.lensFlares.forEach(flare => {\r\n            if (flare.parent) flare.parent.remove(flare);\r\n        });\r\n        this.lensFlares = [];\r\n        \r\n        // Create main central flare\r\n        const mainFlareTexture = textureLoader.load(flareTextures[0]);\r\n        mainFlareTexture.colorSpace = THREE.SRGBColorSpace;\r\n        const mainFlare = new THREE.Sprite(new THREE.SpriteMaterial({\r\n            map: mainFlareTexture,\r\n            color: 0xffaa55,\r\n            transparent: true,\r\n            blending: THREE.AdditiveBlending,\r\n            depthTest: false\r\n        }));\r\n        mainFlare.scale.set(700, 700, 1.0);\r\n        this.sun.add(mainFlare);\r\n        this.lensFlares.push(mainFlare);\r\n        \r\n        // Create smaller surrounding flares\r\n        const flareCount = 8;\r\n        const radius = 300; // Distance from center\r\n        \r\n        for (let i = 0; i < flareCount; i++) {\r\n            // Alternate between flare textures\r\n            const textureIndex = 1 + (i % 2);\r\n            const flareTexture = textureLoader.load(flareTextures[textureIndex]);\r\n            flareTexture.colorSpace = THREE.SRGBColorSpace;\r\n            \r\n            // Create flare with varying colors\r\n            const flare = new THREE.Sprite(new THREE.SpriteMaterial({\r\n                map: flareTexture,\r\n                color: i % 3 === 0 ? 0xffcc77 : (i % 3 === 1 ? 0xff8855 : 0xff6622),\r\n                transparent: true,\r\n                blending: THREE.AdditiveBlending,\r\n                depthTest: false\r\n            }));\r\n            \r\n            // Position around the sun at different angles\r\n            const angle = (i / flareCount) * Math.PI * 2;\r\n            const x = Math.cos(angle) * radius;\r\n            const y = Math.sin(angle) * radius;\r\n            flare.position.set(x, y, 0);\r\n            \r\n            // Random size variations\r\n            const size = 200 + Math.random() * 200;\r\n            flare.scale.set(size, size, 1.0);\r\n            \r\n            // Store in array and add to sun\r\n            this.sun.add(flare);\r\n            this.lensFlares.push(flare);\r\n            \r\n            // Create an additional layer of smaller flares\r\n            if (i % 2 === 0) {\r\n                const smallFlareTexture = textureLoader.load(flareTextures[i % 3]);\r\n                smallFlareTexture.colorSpace = THREE.SRGBColorSpace;\r\n                \r\n                const smallFlare = new THREE.Sprite(new THREE.SpriteMaterial({\r\n                    map: smallFlareTexture,\r\n                    color: 0xffaa22,\r\n                    transparent: true,\r\n                    blending: THREE.AdditiveBlending,\r\n                    depthTest: false\r\n                }));\r\n                \r\n                // Position at twice the radius\r\n                const farRadius = radius * 2;\r\n                const farAngle = angle + (Math.random() * 0.2 - 0.1);\r\n                const farX = Math.cos(farAngle) * farRadius;\r\n                const farY = Math.sin(farAngle) * farRadius;\r\n                smallFlare.position.set(farX, farY, 0);\r\n                \r\n                // Smaller size\r\n                const smallSize = 100 + Math.random() * 150;\r\n                smallFlare.scale.set(smallSize, smallSize, 1.0);\r\n                \r\n                this.sun.add(smallFlare);\r\n                this.lensFlares.push(smallFlare);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Update sun based on star type (O, B, A, F, G, K, M)\r\n    updateSunType(type, lightIntensityMultiplier = 1.0) {\r\n        this.sunType = type || 'G';\r\n        let color, temperature, activity;\r\n        \r\n        // Set sun properties based on star classification\r\n        switch(this.sunType) {\r\n            case 'O': // Hot blue stars\r\n                color = 0x9db4ff;\r\n                temperature = 30000;\r\n                activity = 0.8;\r\n                break;\r\n            case 'B': // Blue-white\r\n                color = 0xaabfff;\r\n                temperature = 20000;\r\n                activity = 0.75;\r\n                break;\r\n            case 'A': // White\r\n                color = 0xcad7ff;\r\n                temperature = 10000;\r\n                activity = 0.7;\r\n                break;\r\n            case 'F': // Yellow-white\r\n                color = 0xf8f7ff;\r\n                temperature = 7000;\r\n                activity = 0.65;\r\n                break;\r\n            case 'G': // Yellow (like our Sun)\r\n                color = 0xfff4ea;\r\n                temperature = 5500;\r\n                activity = 0.6;\r\n                break;\r\n            case 'K': // Orange\r\n                color = 0xffd2a1;\r\n                temperature = 4000;\r\n                activity = 0.5;\r\n                break;\r\n            case 'M': // Red\r\n                color = 0xffcc6f;\r\n                temperature = 3000;\r\n                activity = 0.4;\r\n                break;\r\n            default: // Default to G-type\r\n                color = 0xfff4ea;\r\n                temperature = 5500;\r\n                activity = 0.6;\r\n        }\r\n        \r\n        // Update material colors and parameters\r\n        if (this.sunMaterial) {\r\n            this.sunMaterial.uniforms.sunColor.value.setHex(color);\r\n            this.sunMaterial.uniforms.sunActivity.value = activity;\r\n        }\r\n        \r\n        if (this.coronaMaterial) {\r\n            // Adjust corona color to be slightly lighter\r\n            const coronaColor = new THREE.Color(color);\r\n            coronaColor.r = Math.min(1.0, coronaColor.r * 1.2);\r\n            coronaColor.g = Math.min(1.0, coronaColor.g * 1.1);\r\n            coronaColor.b = Math.min(1.0, coronaColor.b * 1.0);\r\n            this.coronaMaterial.uniforms.coronaColor.value = coronaColor;\r\n        }\r\n        \r\n        if (this.outerCoronaMaterial) {\r\n            // Adjust outer corona color\r\n            const outerCoronaColor = new THREE.Color(color);\r\n            outerCoronaColor.r = Math.min(1.0, outerCoronaColor.r * 1.3);\r\n            outerCoronaColor.g = Math.min(1.0, outerCoronaColor.g * 1.2);\r\n            outerCoronaColor.b = Math.min(1.0, outerCoronaColor.b * 1.1);\r\n            this.outerCoronaMaterial.uniforms.coronaColor.value = outerCoronaColor;\r\n        }\r\n        \r\n        // Update light color\r\n        if (this.sunLight) {\r\n            this.sunLight.color.setHex(color);\r\n            // Adjust light intensity based on temperature and physical units\r\n            this.sunLight.intensity = (200000 + (temperature / 10000) * 200000) * lightIntensityMultiplier;\r\n        }\r\n        \r\n        // Update lens flare colors\r\n        this.lensFlares.forEach((flare, index) => {\r\n            if (flare && flare.material) {\r\n                const flareColor = new THREE.Color(color);\r\n                // Add variations to the flare colors\r\n                if (index % 3 === 0) {\r\n                    flareColor.r = Math.min(1.0, flareColor.r * 1.2);\r\n                } else if (index % 3 === 1) {\r\n                    flareColor.g = Math.min(1.0, flareColor.g * 1.1);\r\n                }\r\n                flare.material.color = flareColor;\r\n            }\r\n        });\r\n        \r\n        console.log(`Updated sun to type ${this.sunType}, color: ${color.toString(16)}, intensity multiplier: ${lightIntensityMultiplier}`);\r\n    }\r\n    \r\n    getRadius() {\r\n        return 3000; // Return the radius of the sun's boundary (reduced from 3600)\r\n    }\r\n    \r\n    getPosition() {\r\n        return new THREE.Vector3(0, 0, 0); // Sun is at the center\r\n    }\r\n    \r\n    update(deltaTime = 0.016) {\r\n        if (!this.sun) return;\r\n        \r\n        // Update time for all shaders\r\n        this.time += deltaTime * 0.4; // Slow down the animation slightly\r\n        \r\n        if (this.sunMaterial && this.sunMaterial.uniforms.time) {\r\n            this.sunMaterial.uniforms.time.value = this.time;\r\n        }\r\n        \r\n        if (this.coronaMaterial && this.coronaMaterial.uniforms.time) {\r\n            this.coronaMaterial.uniforms.time.value = this.time;\r\n        }\r\n        \r\n        if (this.outerCoronaMaterial && this.outerCoronaMaterial.uniforms.time) {\r\n            this.outerCoronaMaterial.uniforms.time.value = this.time;\r\n        }\r\n        \r\n        // Add flickering effect to simulate solar activity\r\n        this.sunFlickerIntensity += this.sunFlickerDirection;\r\n        if (this.sunFlickerIntensity > 1.2) {\r\n            this.sunFlickerIntensity = 1.2;\r\n            this.sunFlickerDirection = -Math.random() * 0.03;\r\n        } else if (this.sunFlickerIntensity < 0.9) {\r\n            this.sunFlickerIntensity = 0.9;\r\n            this.sunFlickerDirection = Math.random() * 0.03;\r\n        }\r\n        \r\n        // Apply flickering to light intensity - preserve any multiplier that was applied\r\n        if (this.sunLight) {\r\n            const intensityMultiplier = this.sunLight._intensityMultiplier || 1.0;\r\n            const baseIntensity = this.baseLightIntensity + (this.sunType === 'G' ? 30000 : \r\n                                         (this.sunType === 'O' || this.sunType === 'B') ? 100000 : \r\n                                         (this.sunType === 'M') ? 10000 : 50000);\r\n            \r\n            // Apply view-dependent intensity adjustment\r\n            let viewDependentMultiplier = 1.0;\r\n            if (this.scene && this.scene.camera) {\r\n                // Calculate angle between camera and sun\r\n                const viewVector = new THREE.Vector3().subVectors(\r\n                    this.scene.camera.position,\r\n                    this.sun.position\r\n                ).normalize();\r\n                \r\n                const cameraNormal = new THREE.Vector3(0, 0, -1).applyQuaternion(this.scene.camera.quaternion);\r\n                const angleToCam = viewVector.dot(cameraNormal);\r\n                \r\n                // Reduce intensity when looking directly at sun to prevent overwhelming brightness\r\n                if (angleToCam > 0.8) {\r\n                    viewDependentMultiplier = 0.5 + (1.0 - angleToCam) * 0.5;\r\n                }\r\n            }\r\n            \r\n            this.sunLight.intensity = baseIntensity * this.sunFlickerIntensity * intensityMultiplier * viewDependentMultiplier;\r\n        }\r\n        \r\n        // Update directional light for shadow casting\r\n        if (this.sunDirectionalLight && this.scene && this.scene.camera) {\r\n            // Get camera position\r\n            const cameraPos = this.scene.camera.position.clone();\r\n            \r\n            // Calculate vector from sun to camera\r\n            const sunToCam = cameraPos.clone().sub(this.sun.position).normalize();\r\n            \r\n            // Set the directional light to point toward the camera\r\n            // This ensures shadows are cast in the correct direction relative to the viewer\r\n            const distanceFactor = 15000; // Large distance to ensure the light covers the scene\r\n            const lightPos = sunToCam.clone().multiplyScalar(-distanceFactor).add(this.sun.position);\r\n            \r\n            // Update light position\r\n            this.sunDirectionalLight.position.copy(lightPos);\r\n            this.sunDirectionalLight.target.position.copy(this.sun.position);\r\n            \r\n            // Ensure the target is in the scene\r\n            if (!this.sunDirectionalLight.target.parent) {\r\n                this.scene.add(this.sunDirectionalLight.target);\r\n            }\r\n            \r\n            // Adjust shadow camera frustum based on camera distance from sun\r\n            const camDistanceToSun = cameraPos.distanceTo(this.sun.position);\r\n            const shadowSize = Math.max(50000, camDistanceToSun * 2);\r\n            \r\n            this.sunDirectionalLight.shadow.camera.left = -shadowSize;\r\n            this.sunDirectionalLight.shadow.camera.right = shadowSize;\r\n            this.sunDirectionalLight.shadow.camera.top = shadowSize;\r\n            this.sunDirectionalLight.shadow.camera.bottom = -shadowSize;\r\n            this.sunDirectionalLight.shadow.camera.updateProjectionMatrix();\r\n            \r\n            // Apply flickering to directional light intensity as well\r\n            this.sunDirectionalLight.intensity = 1.5 * this.sunFlickerIntensity;\r\n        }\r\n        \r\n        // Update camera-relative uniforms if available\r\n        if (this.scene && this.scene.camera) {\r\n            const viewVector = new THREE.Vector3().subVectors(\r\n                this.scene.camera.position,\r\n                this.sun.position\r\n            ).normalize();\r\n            \r\n            if (this.coronaMaterial && this.coronaMaterial.uniforms.viewVector) {\r\n                this.coronaMaterial.uniforms.viewVector.value = viewVector;\r\n            }\r\n            \r\n            if (this.outerCoronaMaterial && this.outerCoronaMaterial.uniforms.viewVector) {\r\n                this.outerCoronaMaterial.uniforms.viewVector.value = viewVector;\r\n            }\r\n            \r\n            // Animate the flares for a more dynamic fireball effect\r\n            const time = this.time;\r\n            this.lensFlares.forEach((flare, index) => {\r\n                if (!flare) return;\r\n                \r\n                // Scale flares with slight pulsing\r\n                const pulseSpeed = 0.5 + (index % 3) * 0.3;\r\n                const pulseFactor = 0.9 + Math.sin(time * pulseSpeed + index) * 0.1;\r\n                \r\n                // Different behavior for the main flare vs the surrounding flares\r\n                if (index === 0) {\r\n                    // Main flare - just pulse\r\n                    const mainScale = 700 * pulseFactor;\r\n                    flare.scale.set(mainScale, mainScale, 1.0);\r\n                } else {\r\n                    // Surrounding flares - move slightly and pulse\r\n                    const originalSize = 200 + (index % 3) * 100;\r\n                    const size = originalSize * pulseFactor;\r\n                    flare.scale.set(size, size, 1.0);\r\n                    \r\n                    // Slightly move position in circular pattern for surrounding flares\r\n                    if (flare.userData.originalPos) {\r\n                        const orbit = 0.1 + (index % 5) * 0.05;\r\n                        const orbitSpeed = 0.3 + (index % 4) * 0.1;\r\n                        flare.position.x = flare.userData.originalPos.x + Math.sin(time * orbitSpeed) * orbit * originalSize;\r\n                        flare.position.y = flare.userData.originalPos.y + Math.cos(time * orbitSpeed) * orbit * originalSize;\r\n                    } else {\r\n                        // Store original position on first update\r\n                        flare.userData.originalPos = flare.position.clone();\r\n                    }\r\n                }\r\n                \r\n                // Adjust opacity based on camera angle \r\n                const angleToCam = viewVector.dot(new THREE.Vector3(0, 0, -1).applyQuaternion(this.scene.camera.quaternion));\r\n                \r\n                // More balanced opacity calculations to maintain visibility across viewing angles\r\n                if (angleToCam > 0.5) {\r\n                    // Gentler falloff when looking more directly at the sun\r\n                    const opacity = Math.min(1.0, (angleToCam - 0.5) / 0.3 + 0.3);\r\n                    flare.material.opacity = opacity;\r\n                    flare.visible = true;\r\n                } else {\r\n                    // Still show flares at wider angles, with less extreme falloff\r\n                    const reducedOpacity = Math.max(0.1, (angleToCam + 0.5) / 1.0) * 0.5;\r\n                    flare.material.opacity = reducedOpacity;\r\n                    flare.visible = true; // Always keep visible for more consistency\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n    // New method to toggle shadow camera helper for debugging\r\n    toggleShadowHelper(enabled) {\r\n        // Remove existing helper if any\r\n        if (this.shadowHelper && this.shadowHelper.parent) {\r\n            this.shadowHelper.parent.remove(this.shadowHelper);\r\n            this.shadowHelper = null;\r\n        }\r\n        \r\n        if (enabled && this.sunDirectionalLight && this.scene) {\r\n            // Create and add shadow camera helper\r\n            this.shadowHelper = new THREE.CameraHelper(this.sunDirectionalLight.shadow.camera);\r\n            this.scene.add(this.shadowHelper);\r\n            console.log(\"Shadow camera helper enabled - showing sun shadow frustum\");\r\n        }\r\n    }\r\n}","// planets.js - Creates and manages the planets in the solar system\r\n\r\nimport * as THREE from 'three';\r\n\r\n// Import TextureLoader if not already imported at the top\r\nconst textureLoader = new THREE.TextureLoader();\r\n\r\n// Load all planet textures\r\nconst planetTextures = {\r\n    mercury: textureLoader.load('./assets/2k_mercury.jpg'),\r\n    venus: {\r\n        surface: textureLoader.load('./assets/2k_venus_surface.jpg'),\r\n        atmosphere: textureLoader.load('./assets/2k_venus_atmosphere.jpg')\r\n    },\r\n    earth: textureLoader.load('./assets/2k_earth_daymap.jpg'),\r\n    mars: textureLoader.load('./assets/2k_mars.jpg'),\r\n    jupiter: textureLoader.load('./assets/2k_jupiter.jpg'),\r\n    saturn: {\r\n        surface: textureLoader.load('./assets/2k_saturn.jpg'),\r\n        rings: textureLoader.load('./assets/2k_saturn_ring_alpha.png')\r\n    },\r\n    uranus: textureLoader.load('./assets/2k_uranus.jpg'),\r\n    neptune: textureLoader.load('./assets/2k_neptune.jpg')\r\n};\r\n\r\n// Set the correct color space for all planet textures\r\nplanetTextures.mercury.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.venus.surface.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.venus.atmosphere.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.earth.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.mars.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.jupiter.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.saturn.surface.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.saturn.rings.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.uranus.colorSpace = THREE.SRGBColorSpace;\r\nplanetTextures.neptune.colorSpace = THREE.SRGBColorSpace;\r\n\r\n// Load the custom procedural textures (p1-p22)\r\nconst proceduralTextures = [];\r\nfor (let i = 1; i <= 22; i++) {\r\n    const texture = textureLoader.load(`./assets/p${i}.jpeg`);\r\n    texture.colorSpace = THREE.SRGBColorSpace;\r\n    proceduralTextures.push(texture);\r\n}\r\n\r\nexport class Planets {\r\n    constructor(scene, starSystemGenerator) {\r\n        this.scene = scene;\r\n        this.starSystemGenerator = starSystemGenerator;\r\n        this.planets = [];\r\n        this.planetRegions = {};\r\n        this.currentSystemId = 'Solar System'; // Default to our Solar System\r\n        this.systemPlanets = {};\r\n        \r\n        // Initialize our solar system planets\r\n        this.createHomeSolarSystem();\r\n    }\r\n    \r\n    // Create our home solar system (the only non-procedural system)\r\n    createHomeSolarSystem() {\r\n        // Planet data for our Solar System: name, size, distance from sun, orbit speed, color, rings\r\n        const solarSystemPlanets = [\r\n            { name: \"Mercury\", size: 220, distance: 4800, speed: 0.0016, color: 0xaaaaaa, rings: false },\r\n            { name: \"Venus\", size: 400, distance: 8000, speed: 0.0013, color: 0xe6cc9c, rings: false },\r\n            { name: \"Earth\", size: 420, distance: 12000, speed: 0.0010, color: 0x4169e1, rings: false },\r\n            { name: \"Mars\", size: 320, distance: 16800, speed: 0.0008, color: 0xc65d45, rings: false },\r\n            // Wider asteroid belt\r\n            { name: \"Jupiter\", size: 1000, distance: 30000, speed: 0.0004, color: 0xd6b27e, rings: true },\r\n            { name: \"Saturn\", size: 880, distance: 40000, speed: 0.0003, color: 0xf0e5c9, rings: true },\r\n            { name: \"Uranus\", size: 720, distance: 56000, speed: 0.0002, color: 0xcaecf1, rings: true },\r\n            { name: \"Neptune\", size: 700, distance: 72000, speed: 0.00016, color: 0x5fa3db, rings: false },\r\n        ];\r\n        \r\n        // Store our solar system planets for future reference\r\n        this.systemPlanets['Solar System'] = solarSystemPlanets;\r\n        \r\n        // Create the actual planet objects\r\n        this.createPlanetsForSystem('Solar System');\r\n    }\r\n    \r\n    // Create planet objects for the current system\r\n    createPlanetsForSystem(systemId) {\r\n        // Clear existing planets\r\n        this.clearPlanets();\r\n        \r\n        // Update current system\r\n        this.currentSystemId = systemId;\r\n        \r\n        // If we already have planet data for this system, use it\r\n        if (this.systemPlanets[systemId]) {\r\n            this.createPlanetsFromData(this.systemPlanets[systemId]);\r\n            return;\r\n        }\r\n        \r\n        // Otherwise, we need to generate planets for this system\r\n        const generatedPlanets = this.generatePlanetsForSystem(systemId);\r\n        this.systemPlanets[systemId] = generatedPlanets;\r\n        this.createPlanetsFromData(generatedPlanets);\r\n    }\r\n    \r\n    // Generate procedural planets for a new star system\r\n    generatePlanetsForSystem(systemId) {\r\n        console.log(`Generating new planets for system: ${systemId}`);\r\n        \r\n        // Check if this is a custom system with predefined planets\r\n        if (this.starSystemGenerator && this.starSystemGenerator.customPlanetData && this.starSystemGenerator.customPlanetData[systemId]) {\r\n            const customPlanets = this.starSystemGenerator.customPlanetData[systemId];\r\n            console.log(`Using ${customPlanets.length} custom planets for system: ${systemId}`);\r\n            \r\n            // Log the texture URLs for debugging\r\n            customPlanets.forEach(planet => {\r\n                if (planet.textureUrl) {\r\n                    console.log(`Custom planet ${planet.name} has texture URL: ${planet.textureUrl}`);\r\n                } else {\r\n                    console.log(`Custom planet ${planet.name} does not have a texture URL`);\r\n                }\r\n            });\r\n            \r\n            // Return the custom planet data directly\r\n            return this.starSystemGenerator.customPlanetData[systemId];\r\n        }\r\n        \r\n        // Planet name word banks for procedural generation\r\n        const prefixes = [\r\n            'New', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Nova', 'Proxima', 'Ultima',\r\n            'Astro', 'Cosmo', 'Stella', 'Terra', 'Astra', 'Prime', 'Orb'\r\n        ];\r\n        \r\n        const suffixes = [\r\n            'sphere', 'world', 'orb', 'terra', 'oid', 'globus', 'ium', 'ian',\r\n            'aria', 'anth', 'urus', 'alos', 'onos', 'era', 'ax', 'is', 'os'\r\n        ];\r\n        \r\n        // Get a random star system data (assuming there's a starSystemGenerator with this info)\r\n        // This is a fallback if we don't have access to real system data\r\n        const starClass = systemId.includes('System-') ? systemId.split('-')[1][0] : 'M';\r\n        \r\n        // Generate between 1-8 planets for this system\r\n        const planetCount = 2 + Math.floor(Math.random() * 7); // 2-8 planets\r\n        const planetData = [];\r\n        \r\n        // Determine system characteristics based on star class\r\n        let sizeMultiplier = 1.0;\r\n        let distanceMultiplier = 1.0;\r\n        let colorPalette = [];\r\n        \r\n        // Adjust planet parameters based on star class\r\n        switch (starClass) {\r\n            case 'O': // Blue giants - larger planets, further apart\r\n                sizeMultiplier = 1.8;\r\n                distanceMultiplier = 1.6;\r\n                colorPalette = [0x6666ff, 0x9999ff, 0xccccff, 0xaaaaff, 0x8888dd];\r\n                break;\r\n            case 'B': // Blue-white stars - larger planets, varying colors\r\n                sizeMultiplier = 1.5;\r\n                distanceMultiplier = 1.3;\r\n                colorPalette = [0x99aaff, 0xaabbff, 0xccccff, 0xddddff, 0xbbaacc];\r\n                break;\r\n            case 'A': // White stars - medium planets\r\n                sizeMultiplier = 1.3;\r\n                distanceMultiplier = 1.1;\r\n                colorPalette = [0xccccff, 0xddddff, 0xeeeeff, 0xffffff, 0xddccdd];\r\n                break;\r\n            case 'F': // Yellow-white stars - Earth-like\r\n                sizeMultiplier = 1.1;\r\n                distanceMultiplier = 1.0;\r\n                colorPalette = [0x99aaff, 0xaaccaa, 0xccddcc, 0xffccaa, 0xeeeecc];\r\n                break;\r\n            case 'G': // Yellow stars (like our sun) - Earth-like\r\n                sizeMultiplier = 1.0;\r\n                distanceMultiplier = 1.0;\r\n                colorPalette = [0xaaaaaa, 0x4169e1, 0xc65d45, 0xd6b27e, 0xf0e5c9];\r\n                break;\r\n            case 'K': // Orange stars - smaller planets\r\n                sizeMultiplier = 0.8;\r\n                distanceMultiplier = 0.9;\r\n                colorPalette = [0xe6cc9c, 0xccaa88, 0xddbb99, 0xbb9977, 0xcc8866];\r\n                break;\r\n            case 'M': // Red dwarfs - small planets, close together\r\n                sizeMultiplier = 0.6;\r\n                distanceMultiplier = 0.7;\r\n                colorPalette = [0xcc6644, 0xdd7755, 0xee8866, 0xff9977, 0xbb5533];\r\n                break;\r\n            default:\r\n                colorPalette = [0xaaaaaa, 0x4169e1, 0xc65d45, 0xd6b27e, 0xf0e5c9];\r\n        }\r\n        \r\n        // Generate each planet\r\n        for (let i = 0; i < planetCount; i++) {\r\n            // Generate a random name\r\n            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];\r\n            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];\r\n            const name = `${prefix}${suffix}`;\r\n            \r\n            // Determine planet size (smaller planets more common)\r\n            const sizeClass = Math.random();\r\n            let size;\r\n            if (sizeClass < 0.5) {\r\n                // Small planet (50% chance)\r\n                size = (240 + Math.random() * 200) * sizeMultiplier; // 4x bigger: (60 + random*50) * 4\r\n            } else if (sizeClass < 0.8) {\r\n                // Medium planet (30% chance)\r\n                size = (440 + Math.random() * 280) * sizeMultiplier; // 4x bigger: (110 + random*70) * 4\r\n            } else {\r\n                // Large planet (20% chance)\r\n                size = (720 + Math.random() * 360) * sizeMultiplier; // 4x bigger: (180 + random*90) * 4\r\n            }\r\n            \r\n            // Distance increases with each planet, with some randomness\r\n            const baseDistance = 4800 + (i * 8000); // 4x bigger: (1200 + i*2000) * 4\r\n            const distanceVariation = baseDistance * 0.2; // 20% variation\r\n            const distance = (baseDistance + (Math.random() * distanceVariation - distanceVariation/2)) * distanceMultiplier;\r\n            \r\n            // Orbit speed (inversely proportional to distance)\r\n            const speed = 0.002 / (distance / 1000);\r\n            \r\n            // Random color from palette\r\n            const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];\r\n            \r\n            // Chance of rings based on size (larger planets more likely to have rings)\r\n            const rings = size > 600 ? Math.random() < 0.4 : false; // 4x bigger threshold: 150 * 4 = 600\r\n            \r\n            // Add axial and orbital tilt\r\n            const axialTilt = Math.random() * Math.PI * 0.5; // Up to 90 degrees axial tilt\r\n            const orbitalTilt = Math.random() * Math.PI * 0.2; // Up to ~35 degrees orbital tilt\r\n            \r\n            planetData.push({\r\n                name,\r\n                size: Math.floor(size),\r\n                distance: Math.floor(distance),\r\n                speed,\r\n                color,\r\n                rings,\r\n                axialTilt,\r\n                orbitalTilt\r\n            });\r\n        }\r\n        \r\n        return planetData;\r\n    }\r\n    \r\n    // Create planet objects from data array\r\n    createPlanetsFromData(planetData) {\r\n        // Clear existing planets first\r\n        this.clearPlanets();\r\n        \r\n        planetData.forEach(planet => {\r\n            // Create planet\r\n            const planetGeometry = new THREE.SphereGeometry(planet.size, 32, 32);\r\n            let planetMaterial;\r\n            \r\n            // Check if this is a custom planet with its own texture\r\n            if (planet.textureUrl) {\r\n                console.log(`Creating planet ${planet.name} with custom texture: ${planet.textureUrl}`);\r\n                \r\n                // Fix texture path for API server images\r\n                let adjustedTextureUrl = planet.textureUrl;\r\n                \r\n                // Check if this is an image from our API server\r\n                if (planet.textureUrl.startsWith('/images/')) {\r\n                    // If running on port 8000, adjust URL to point to port 8001\r\n                    if (window.location.port === '8000') {\r\n                        const serverHost = window.location.hostname;\r\n                        adjustedTextureUrl = `http://${serverHost}:8001${planet.textureUrl}`;\r\n                        console.log(`Adjusted planet texture path to API server: ${adjustedTextureUrl}`);\r\n                    }\r\n                }\r\n                \r\n                // Load the custom texture\r\n                const customTexture = textureLoader.load(adjustedTextureUrl);\r\n                customTexture.colorSpace = THREE.SRGBColorSpace;\r\n                \r\n                // Create material with custom texture\r\n                planetMaterial = new THREE.MeshStandardMaterial({\r\n                    map: customTexture,\r\n                    roughness: 0.7,\r\n                    metalness: 0.2,\r\n                    flatShading: false,\r\n                    emissive: new THREE.Color(planet.color || 0xffffff),\r\n                    emissiveIntensity: 0.2,\r\n                    emissiveMap: customTexture\r\n                });\r\n            } else {\r\n                // Use standard planet textures based on planet name\r\n                switch(planet.name) {\r\n                    case \"Mercury\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.mercury,\r\n                            roughness: 0.7,\r\n                            metalness: 0.2,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0x555555),\r\n                            emissiveIntensity: 0.2,\r\n                            emissiveMap: planetTextures.mercury\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Venus\":\r\n                        // Create Venus with surface and atmosphere\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.venus.surface,\r\n                            roughness: 0.6,\r\n                            metalness: 0.1,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0xe6cc9c),\r\n                            emissiveIntensity: 0.25,\r\n                            emissiveMap: planetTextures.venus.surface\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Earth\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.earth,\r\n                            roughness: 0.5,\r\n                            metalness: 0.1,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0x4169e1),\r\n                            emissiveIntensity: 0.2,\r\n                            emissiveMap: planetTextures.earth\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Mars\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.mars,\r\n                            roughness: 0.7,\r\n                            metalness: 0.1,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0xc65d45),\r\n                            emissiveIntensity: 0.25,\r\n                            emissiveMap: planetTextures.mars\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Jupiter\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.jupiter,\r\n                            roughness: 0.5,\r\n                            metalness: 0.0,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0xd6b27e),\r\n                            emissiveIntensity: 0.2,\r\n                            emissiveMap: planetTextures.jupiter\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Saturn\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.saturn.surface,\r\n                            roughness: 0.6,\r\n                            metalness: 0.1,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0xf0e5c9),\r\n                            emissiveIntensity: 0.2,\r\n                            emissiveMap: planetTextures.saturn.surface\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Uranus\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.uranus,\r\n                            roughness: 0.5,\r\n                            metalness: 0.0,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0x88bbcc),\r\n                            emissiveIntensity: 0.25,\r\n                            emissiveMap: planetTextures.uranus\r\n                        });\r\n                        break;\r\n                        \r\n                    case \"Neptune\":\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: planetTextures.neptune,\r\n                            roughness: 0.5,\r\n                            metalness: 0.0,\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(0x5fa3db),\r\n                            emissiveIntensity: 0.25,\r\n                            emissiveMap: planetTextures.neptune\r\n                        });\r\n                        break;\r\n                        \r\n                    default:\r\n                        // For other planets, use a procedural texture from the collection\r\n                        const textureIndex = Math.floor(Math.random() * proceduralTextures.length);\r\n                        planetMaterial = new THREE.MeshStandardMaterial({\r\n                            map: proceduralTextures[textureIndex],\r\n                            roughness: 0.6,\r\n                            metalness: 0.2,\r\n                            color: new THREE.Color(planet.color),\r\n                            flatShading: false,\r\n                            emissive: new THREE.Color(planet.color),\r\n                            emissiveIntensity: 0.3,\r\n                            emissiveMap: proceduralTextures[textureIndex]\r\n                        });\r\n                        break;\r\n                }\r\n            }\r\n            \r\n            // Create the planet mesh\r\n            const planetMesh = new THREE.Mesh(planetGeometry, planetMaterial);\r\n            \r\n            // Position the planet at its orbital distance\r\n            const angle = Math.random() * Math.PI * 2;\r\n            \r\n            // Apply orbital tilt if specified\r\n            let orbitalTilt = planet.orbitalTilt || 0;\r\n            let axialTilt = planet.axialTilt || 0;\r\n            \r\n            // Position planet with orbital tilt\r\n            planetMesh.position.x = Math.cos(angle) * planet.distance;\r\n            planetMesh.position.y = Math.sin(orbitalTilt) * planet.distance;\r\n            planetMesh.position.z = Math.sin(angle) * Math.cos(orbitalTilt) * planet.distance;\r\n            \r\n            // Apply axial tilt to planet rotation\r\n            planetMesh.rotation.x = axialTilt;\r\n            \r\n            // Enable shadows for eclipse effects\r\n            planetMesh.castShadow = true;\r\n            planetMesh.receiveShadow = true;\r\n            \r\n            // Add the planet to the scene\r\n            this.scene.add(planetMesh);\r\n            \r\n            // Create planet rings if specified\r\n            if (planet.rings) {\r\n                let ringGeometry, ringMaterial, ringMesh;\r\n                \r\n                // Special case for Saturn\r\n                if (planet.name === \"Saturn\") {\r\n                    // Create ring geometry\r\n                    ringGeometry = new THREE.RingGeometry(planet.size * 1.4, planet.size * 2.0, 32);\r\n                    \r\n                    // Create custom material for Saturn with transparency\r\n                    ringMaterial = new THREE.MeshStandardMaterial({\r\n                        map: planetTextures.saturn.rings,\r\n                        side: THREE.DoubleSide,\r\n                        transparent: true,\r\n                        opacity: 0.8,\r\n                        roughness: 0.8,\r\n                        metalness: 0.1,\r\n                        emissive: new THREE.Color(0xf0e5c9),\r\n                        emissiveIntensity: 0.2,\r\n                        emissiveMap: planetTextures.saturn.rings\r\n                    });\r\n                } else {\r\n                    // Generic rings for other planets\r\n                    ringGeometry = new THREE.RingGeometry(planet.size * 1.3, planet.size * 1.8, 32);\r\n                    ringMaterial = new THREE.MeshStandardMaterial({\r\n                        color: planet.color,\r\n                        side: THREE.DoubleSide,\r\n                        transparent: true,\r\n                        opacity: 0.4,\r\n                        roughness: 0.7,\r\n                        metalness: 0.2,\r\n                        emissive: new THREE.Color(planet.color),\r\n                        emissiveIntensity: 0.3\r\n                    });\r\n                }\r\n                \r\n                ringMesh = new THREE.Mesh(ringGeometry, ringMaterial);\r\n                \r\n                // Rotate rings to be flat (perpendicular to y-axis)\r\n                ringMesh.rotation.x = Math.PI / 2;\r\n                \r\n                // Enable shadows for rings\r\n                ringMesh.castShadow = true;\r\n                ringMesh.receiveShadow = true;\r\n                \r\n                // Add rings to planet\r\n                planetMesh.add(ringMesh);\r\n            }\r\n            \r\n            // Store planet data for orbiting\r\n            this.planets.push({\r\n                mesh: planetMesh,\r\n                distance: planet.distance,\r\n                speed: planet.speed,\r\n                angle: angle,\r\n                orbitalTilt: orbitalTilt\r\n            });\r\n            \r\n            // Store planet regions for game mechanics\r\n            this.planetRegions[planet.name] = {\r\n                name: planet.name,\r\n                position: planetMesh.position.clone(),\r\n                radius: planet.size * 2\r\n            };\r\n        });\r\n    }\r\n    \r\n    // Clear all existing planets\r\n    clearPlanets() {\r\n        // Remove planets from scene and clear arrays\r\n        this.planets.forEach(planet => {\r\n            this.scene.remove(planet.mesh);\r\n        });\r\n        \r\n        this.planets = [];\r\n        this.planetRegions = {};\r\n    }\r\n    \r\n    // Set up planet system for specified star system\r\n    updateForSystem(systemId) {\r\n        console.log(`Updating planets for system: ${systemId}`);\r\n        \r\n        // Generate and create planets for this system if we haven't already\r\n        this.createPlanetsForSystem(systemId);\r\n        \r\n        // Return true to indicate success\r\n        return true;\r\n    }\r\n    \r\n    getPlanetRegions() {\r\n        return this.planetRegions;\r\n    }\r\n    \r\n    getPlanets() {\r\n        return this.planets;\r\n    }\r\n    \r\n    update(deltaTime) {\r\n        // Update planet orbits\r\n        this.planets.forEach(planet => {\r\n            // Update orbit angle based on speed\r\n            planet.angle += planet.speed * deltaTime;\r\n            \r\n            // Calculate new position\r\n            planet.mesh.position.x = Math.cos(planet.angle) * planet.distance;\r\n            planet.mesh.position.z = Math.sin(planet.angle) * Math.cos(planet.orbitalTilt) * planet.distance;\r\n            planet.mesh.position.y = Math.sin(planet.angle) * Math.sin(planet.orbitalTilt) * planet.distance;\r\n            \r\n            // Rotate the planet\r\n            planet.mesh.rotation.y += deltaTime * 0.1;\r\n            \r\n            // FIXED: Update planet region for location tracking\r\n            // Use the planet mesh's position directly to find the matching planet region\r\n            // since the planet object doesn't contain the name property\r\n            if (planet.mesh) {\r\n                // Iterate through planet regions and find the one with a position matching this planet\r\n                Object.values(this.planetRegions).forEach(region => {\r\n                    if (region && region.position) {\r\n                        // Check if this region position is close to the planet position\r\n                        // If it's very close, it's likely the same planet\r\n                        const distance = region.position.distanceTo(planet.mesh.position);\r\n                        if (distance < 5000) { // A reasonable threshold\r\n                            region.position.copy(planet.mesh.position);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n}","// asteroidBelt.js - Creates and manages the asteroid belt\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class AsteroidBelt {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.asteroids = [];\r\n        this.innerRadius = 20000;\r\n        this.outerRadius = 28000;\r\n        this.width = 1800;\r\n        this.resourceMultipliers = { iron: 1.0, gold: 1.0, platinum: 1.0 };\r\n        \r\n        this.createAsteroidBelt();\r\n    }\r\n    \r\n    createAsteroidBelt() {\r\n        const asteroidCount = 1000;\r\n        \r\n        for (let i = 0; i < asteroidCount; i++) {\r\n            // Random asteroid size - Much larger for better visibility\r\n            const size = Math.random() * 120 + 120; // Dramatically increased size for visibility\r\n            \r\n            // Use different geometries for variety\r\n            let geometry;\r\n            const type = Math.floor(Math.random() * 3);\r\n            if (type === 0) {\r\n                geometry = new THREE.IcosahedronGeometry(size, 0);\r\n            } else if (type === 1) {\r\n                geometry = new THREE.TetrahedronGeometry(size, 0);\r\n            } else {\r\n                geometry = new THREE.OctahedronGeometry(size, 0);\r\n            }\r\n            \r\n            // Deform the geometry to make it look more like an asteroid\r\n            const positions = geometry.attributes.position;\r\n            for (let j = 0; j < positions.count; j++) {\r\n                const vertex = new THREE.Vector3();\r\n                vertex.fromBufferAttribute(positions, j);\r\n                \r\n                // Add some random bumps\r\n                vertex.x += (Math.random() - 0.5) * 0.4 * size;\r\n                vertex.y += (Math.random() - 0.5) * 0.4 * size;\r\n                vertex.z += (Math.random() - 0.5) * 0.4 * size;\r\n                \r\n                positions.setXYZ(j, vertex.x, vertex.y, vertex.z);\r\n            }\r\n            \r\n            // Update geometry\r\n            geometry.computeVertexNormals();\r\n            \r\n            // Material with different color variations - brighter for better visibility\r\n            const color = new THREE.Color();\r\n            const resourceRoll = Math.random();\r\n            let resourceType = null;\r\n            \r\n            // Determine resource type based on probability\r\n            if (resourceRoll < 0.7) {\r\n                // 70% iron asteroids (common) - brightened\r\n                color.setHSL(0.02, 0.30, 0.35 + Math.random() * 0.2); // Much brighter\r\n                resourceType = 'iron';\r\n            } else if (resourceRoll < 0.93) {\r\n                // 23% gold asteroids (uncommon) - brightened\r\n                color.setHSL(0.12, 0.7, 0.5 + Math.random() * 0.2); // Much brighter\r\n                resourceType = 'gold';\r\n            } else {\r\n                // 7% platinum asteroids (rare) - brightened\r\n                color.setHSL(0.1, 0.3, 0.7 + Math.random() * 0.15); // Much brighter\r\n                resourceType = 'platinum';\r\n            }\r\n            \r\n            // Enhanced material with higher emissive properties for better visibility\r\n            const material = new THREE.MeshStandardMaterial({\r\n                color: color,\r\n                roughness: 0.6 + Math.random() * 0.2, // Reduced roughness\r\n                metalness: 0.4 + Math.random() * 0.4, // Increased metalness\r\n                flatShading: true,\r\n                emissive: color.clone().multiplyScalar(0.3), // Add emissive glow\r\n                emissiveIntensity: 0.2 // Subtle glow for better visibility\r\n            });\r\n            \r\n            // Create the mesh\r\n            const mesh = new THREE.Mesh(geometry, material);\r\n            \r\n            // Position in asteroid belt with variation using torus pattern\r\n            const angle = Math.random() * Math.PI * 2;\r\n            const radius = this.innerRadius + Math.random() * (this.outerRadius - this.innerRadius);\r\n            const heightVariation = (Math.random() - 0.5) * this.width;\r\n            \r\n            mesh.position.set(\r\n                Math.cos(angle) * radius,\r\n                heightVariation,\r\n                Math.sin(angle) * radius\r\n            );\r\n            \r\n            // Apply random axial tilt (rotation on local axis)\r\n            mesh.rotation.set(\r\n                Math.random() * Math.PI,\r\n                Math.random() * Math.PI,\r\n                Math.random() * Math.PI\r\n            );\r\n            \r\n            // Setup orbital parameters\r\n            const orbitSpeed = 0.0001 + Math.random() * 0.0001; // Slow orbit\r\n            const orbitRadius = radius; // Use initial radius\r\n            \r\n            // Add random orbital tilt\r\n            const orbitTilt = Math.random() * Math.PI * 0.15; // Reduced to ~27 degrees max tilt\r\n            \r\n            // Add to scene\r\n            this.scene.add(mesh);\r\n            \r\n            // Add to asteroids array with metadata\r\n            const baseResourceAmount = 50 + Math.random() * 50; // Base amount before multipliers\r\n            this.asteroids.push({\r\n                mesh: mesh,\r\n                size: size,\r\n                orbitSpeed: orbitSpeed,\r\n                orbitRadius: orbitRadius,\r\n                orbitAngle: angle,\r\n                orbitTilt: orbitTilt,\r\n                initialHeight: heightVariation, // Store initial height variation\r\n                rotationSpeed: {\r\n                    x: (Math.random() - 0.5) * 0.005,\r\n                    y: (Math.random() - 0.5) * 0.005,\r\n                    z: (Math.random() - 0.5) * 0.005\r\n                },\r\n                resourceType: resourceType,\r\n                baseResourceAmount: baseResourceAmount, // Base amount\r\n                resourceAmount: baseResourceAmount, // Current amount\r\n                maxResourceAmount: baseResourceAmount, // Max capacity\r\n                minable: true\r\n            });\r\n        }\r\n    }\r\n    \r\n    getRegionInfo() {\r\n        return {\r\n            center: new THREE.Vector3(0, 0, 0),\r\n            innerRadius: this.innerRadius,\r\n            outerRadius: this.outerRadius\r\n        };\r\n    }\r\n    \r\n    getAsteroids() {\r\n        return this.asteroids;\r\n    }\r\n    \r\n    // Set resource multipliers based on the current star system\r\n    setResourceMultipliers(multipliers) {\r\n        if (!multipliers) return;\r\n        this.resourceMultipliers = multipliers;\r\n        \r\n        // Update existing asteroids with new resource distributions\r\n        this.updateAsteroidResources();\r\n        console.log(\"Updated asteroid belt with resource multipliers:\", multipliers);\r\n    }\r\n    \r\n    // Update asteroid resources based on current system\r\n    updateAsteroidResources() {\r\n        this.asteroids.forEach(asteroid => {\r\n            if (asteroid.resourceType) {\r\n                // Apply system-specific multipliers to resource amounts\r\n                switch (asteroid.resourceType) {\r\n                    case 'iron':\r\n                        asteroid.resourceAmount = asteroid.baseResourceAmount * this.resourceMultipliers.iron;\r\n                        break;\r\n                    case 'gold':\r\n                        asteroid.resourceAmount = asteroid.baseResourceAmount * this.resourceMultipliers.gold;\r\n                        break;\r\n                    case 'platinum':\r\n                        asteroid.resourceAmount = asteroid.baseResourceAmount * this.resourceMultipliers.platinum;\r\n                        break;\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Update asteroid density based on system characteristics\r\n    updateForSystem(params) {\r\n        if (!params) return;\r\n        \r\n        // Update density if provided\r\n        if (params.asteroidDensity) {\r\n            this.updateDensity(params.asteroidDensity);\r\n        }\r\n        \r\n        // Update resource distribution if provided\r\n        if (params.resourceMultipliers) {\r\n            this.setResourceMultipliers(params.resourceMultipliers);\r\n        }\r\n    }\r\n    \r\n    // Update asteroid density\r\n    updateDensity(densityMultiplier = 1.0) {\r\n        if (densityMultiplier < 0.5) densityMultiplier = 0.5; // Minimum density\r\n        if (densityMultiplier > 3.0) densityMultiplier = 3.0; // Maximum density\r\n        \r\n        // Adjust asteroid visibility based on density\r\n        this.asteroids.forEach((asteroid, index) => {\r\n            // Use index to ensure consistent visibility\r\n            const shouldBeVisible = (index % 10) < (densityMultiplier * 5);\r\n            asteroid.mesh.visible = shouldBeVisible;\r\n        });\r\n    }\r\n    \r\n    // Helper function to find the closest asteroid to a point (for mining)\r\n    findClosestAsteroid(position, maxDistance = 1600) {\r\n        let closestAsteroid = null;\r\n        let closestDistance = maxDistance;\r\n        \r\n        this.asteroids.forEach(asteroid => {\r\n            // Skip asteroids that aren't minable or visible\r\n            if (!asteroid.minable || !asteroid.mesh.visible) return;\r\n            \r\n            const distance = position.distanceTo(asteroid.mesh.position);\r\n            if (distance < closestDistance) {\r\n                closestDistance = distance;\r\n                closestAsteroid = asteroid;\r\n            }\r\n        });\r\n        \r\n        return closestAsteroid;\r\n    }\r\n    \r\n    removeAsteroid(asteroid) {\r\n        // Remove the asteroid from the scene\r\n        this.scene.remove(asteroid.mesh);\r\n        \r\n        // Remove from asteroid array\r\n        const index = this.asteroids.findIndex(a => a === asteroid);\r\n        if (index !== -1) {\r\n            this.asteroids.splice(index, 1);\r\n        }\r\n    }\r\n    \r\n    update() {\r\n        // Update asteroid positions and rotations with orbital tilt\r\n        this.asteroids.forEach(asteroid => {\r\n            // Rotate the asteroid (axial rotation)\r\n            asteroid.mesh.rotation.x += asteroid.rotationSpeed.x;\r\n            asteroid.mesh.rotation.y += asteroid.rotationSpeed.y;\r\n            asteroid.mesh.rotation.z += asteroid.rotationSpeed.z;\r\n            \r\n            // Orbit around sun with tilt\r\n            asteroid.orbitAngle += asteroid.orbitSpeed;\r\n            \r\n            // Calculate orbit position with tilt\r\n            const flatX = Math.cos(asteroid.orbitAngle) * asteroid.orbitRadius;\r\n            const flatZ = Math.sin(asteroid.orbitAngle) * asteroid.orbitRadius;\r\n            \r\n            // Apply orbit tilt if it exists\r\n            if (asteroid.orbitTilt) {\r\n                // Apply orbital tilt by rotating the position around the X axis\r\n                const tiltY = flatZ * Math.sin(asteroid.orbitTilt);\r\n                const tiltZ = flatZ * Math.cos(asteroid.orbitTilt);\r\n                \r\n                asteroid.mesh.position.x = flatX;\r\n                asteroid.mesh.position.z = tiltZ;\r\n                asteroid.mesh.position.y = tiltY + asteroid.initialHeight; // Use stored initial height variation\r\n            } else {\r\n                // Regular orbit\r\n                asteroid.mesh.position.x = flatX;\r\n                asteroid.mesh.position.z = flatZ;\r\n                asteroid.mesh.position.y = asteroid.initialHeight;\r\n            }\r\n        });\r\n    }\r\n}","// stargate.js - Creates and manages the stargate\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class Stargate {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.stargate = null;\r\n        this.navLights = [];\r\n        this.portalParticles = [];\r\n        this.createStargate();\r\n    }\r\n    \r\n    createStargate() {\r\n        // Create a stargate group\r\n        const stargateGroup = new THREE.Group();\r\n        stargateGroup.name = 'stargate';\r\n        \r\n        // Main ring - matte black\r\n        const ringGeometry = new THREE.TorusGeometry(1000, 200, 32, 100);\r\n        const ringMaterial = new THREE.MeshStandardMaterial({\r\n          color: 0x111111,\r\n          roughness: 0.9,\r\n          metalness: 0.1,\r\n          emissive: 0x000000\r\n        });\r\n        const ring = new THREE.Mesh(ringGeometry, ringMaterial);\r\n        stargateGroup.add(ring);\r\n        \r\n        // Neon turquoise accent rings\r\n        const createAccentRing = (radius, tubeRadius, position = {x: 0, y: 0, z: 0}, rotation = {x: 0, y: 0, z: 0}) => {\r\n          const geometry = new THREE.TorusGeometry(radius, tubeRadius, 16, 100);\r\n          const material = new THREE.MeshStandardMaterial({\r\n            color: 0x00ffff,\r\n            emissive: 0x00ffff,\r\n            emissiveIntensity: 1.5,\r\n            roughness: 0.2,\r\n            metalness: 0.8\r\n          });\r\n          const accentRing = new THREE.Mesh(geometry, material);\r\n          accentRing.position.set(position.x, position.y, position.z);\r\n          accentRing.rotation.set(rotation.x, rotation.y, rotation.z);\r\n          return accentRing;\r\n        };\r\n        \r\n        // Add accent rings on outer edges - make them brighter\r\n        const outerRing1 = createAccentRing(1060, 10);\r\n        const outerRing2 = createAccentRing(940, 10);\r\n        // Add an inner ring to enhance portal effect\r\n        const innerRing = createAccentRing(850, 5);\r\n        stargateGroup.add(outerRing1);\r\n        stargateGroup.add(outerRing2);\r\n        stargateGroup.add(innerRing);\r\n        \r\n        // Create enhanced turquoise portal in the center\r\n        this.createPortalEffect(stargateGroup);\r\n        \r\n        // Add neon accent details\r\n        const detailsGroup = this.createNeonDetails();\r\n        stargateGroup.add(detailsGroup);\r\n        \r\n        // Position the stargate at 2x height from the original position\r\n        stargateGroup.position.set(0, 10000, 0);\r\n        stargateGroup.rotation.x = Math.PI / 2; // Horizontal orientation\r\n        \r\n        // Add to scene\r\n        this.scene.add(stargateGroup);\r\n        this.stargate = stargateGroup;\r\n        \r\n        // Create a counter-rotating inner ring for additional portal effect\r\n        this.createCounterRotatingRing(stargateGroup);\r\n    }\r\n    \r\n    createCounterRotatingRing(parentGroup) {\r\n        // Create a separate rotating group for the inner portal structure\r\n        const innerStructure = new THREE.Group();\r\n        \r\n        // Add a thin ring that rotates opposite to the main stargate\r\n        const thinRingGeometry = new THREE.TorusGeometry(820, 3, 16, 100);\r\n        const thinRingMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0x00ffff,\r\n            emissive: 0x00ffff,\r\n            emissiveIntensity: 2,\r\n            roughness: 0.1,\r\n            metalness: 0.9,\r\n            transparent: true,\r\n            opacity: 0.7\r\n        });\r\n        \r\n        // Create 3 counter-rotating rings\r\n        for (let i = 0; i < 3; i++) {\r\n            const ring = new THREE.Mesh(thinRingGeometry, thinRingMaterial.clone());\r\n            ring.rotation.x = Math.PI * i / 3;\r\n            ring.rotation.y = Math.PI * i / 3;\r\n            innerStructure.add(ring);\r\n        }\r\n        \r\n        parentGroup.add(innerStructure);\r\n        this.counterRotatingRing = innerStructure;\r\n    }\r\n    \r\n    createPortalEffect(parentGroup) {\r\n        // Enhanced custom shader material for the portal\r\n        const portalShaderMaterial = new THREE.ShaderMaterial({\r\n          uniforms: {\r\n            time: { value: 0 },\r\n            resolution: { value: new THREE.Vector2(1024, 1024) },\r\n            baseColor: { value: new THREE.Color(0x00ffff) }\r\n          },\r\n          vertexShader: `\r\n            varying vec2 vUv;\r\n            \r\n            void main() {\r\n              vUv = uv;\r\n              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n            }\r\n          `,\r\n          fragmentShader: `\r\n            uniform float time;\r\n            uniform vec2 resolution;\r\n            uniform vec3 baseColor;\r\n            varying vec2 vUv;\r\n            \r\n            // Simple noise function\r\n            float noise(vec2 p) {\r\n              return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453);\r\n            }\r\n            \r\n            // Smoothed noise\r\n            float smoothNoise(vec2 p) {\r\n              vec2 ip = floor(p);\r\n              vec2 fp = fract(p);\r\n              \r\n              vec2 u = fp * fp * (3.0 - 2.0 * fp);\r\n              \r\n              float a = noise(ip);\r\n              float b = noise(ip + vec2(1.0, 0.0));\r\n              float c = noise(ip + vec2(0.0, 1.0));\r\n              float d = noise(ip + vec2(1.0, 1.0));\r\n              \r\n              return mix(mix(a, b, u.x), mix(c, d, u.x), u.y);\r\n            }\r\n            \r\n            // Fractal Brownian Motion\r\n            float fbm(vec2 p) {\r\n              float value = 0.0;\r\n              float amplitude = 0.5;\r\n              float frequency = 3.0;\r\n              \r\n              for (int i = 0; i < 6; i++) {\r\n                value += amplitude * smoothNoise(p * frequency);\r\n                amplitude *= 0.5;\r\n                frequency *= 2.0;\r\n              }\r\n              \r\n              return value;\r\n            }\r\n            \r\n            void main() {\r\n              // Convert uv to be centered at (0.5, 0.5) with range -1 to 1\r\n              vec2 centeredUV = (vUv - 0.5) * 2.0;\r\n              float dist = length(centeredUV);\r\n              \r\n              // Create angle for rotation\r\n              float angle = atan(centeredUV.y, centeredUV.x);\r\n              \r\n              // Enhanced swirling effect parameters - more aggressive\r\n              float swirl = sin(angle * 6.0 + time * 2.0) * 0.5 + 0.5;\r\n              float pulse = sin(time * 0.8) * 0.5 + 0.5;\r\n              \r\n              // Create more distorted coordinates for noise - enhances warp feel\r\n              vec2 distortedUV = vec2(\r\n                centeredUV.x + sin(time * 0.7 + centeredUV.y * 5.0) * 0.2,\r\n                centeredUV.y + cos(time * 0.6 + centeredUV.x * 5.0) * 0.2\r\n              );\r\n              \r\n              // Create noise patterns - more contrast\r\n              float noiseValue = fbm(distortedUV * 3.0 + time * 0.3);\r\n              float ripple = sin(dist * 20.0 - time * 3.0) * 0.5 + 0.5;\r\n              \r\n              // Combine effects with more intensity\r\n              float alpha = smoothstep(0.9, 0.0, dist);\r\n              float intensity = mix(noiseValue, ripple, 0.7) * swirl * pulse;\r\n              \r\n              // Enhanced portal colors - bright cyan to deep blue\r\n              vec3 darkColor = vec3(0.0, 0.1, 0.3);\r\n              vec3 brightColor = vec3(0.0, 1.0, 1.0) * 2.0;\r\n              vec3 accentColor = vec3(0.3, 0.8, 1.0);\r\n              \r\n              // More complex color mixing\r\n              vec3 finalColor = mix(darkColor, brightColor, intensity);\r\n              finalColor = mix(finalColor, accentColor, ripple * swirl);\r\n              \r\n              // Enhanced edge glow for portal effect\r\n              float edgeGlow = smoothstep(0.8, 0.4, dist) * smoothstep(0.0, 0.6, dist);\r\n              finalColor = mix(finalColor, brightColor, edgeGlow * pulse);\r\n              \r\n              // Add portal event horizon effect\r\n              float eventHorizon = smoothstep(0.8, 0.78, dist) * 2.0;\r\n              finalColor += vec3(0.0, 1.0, 1.0) * eventHorizon;\r\n              \r\n              gl_FragColor = vec4(finalColor, alpha);\r\n            }\r\n          `,\r\n          transparent: true,\r\n          side: THREE.DoubleSide\r\n        });\r\n        \r\n        // Create portal disc using the shader material\r\n        const portalGeometry = new THREE.CircleGeometry(800, 128);\r\n        const portal = new THREE.Mesh(portalGeometry, portalShaderMaterial);\r\n        parentGroup.add(portal);\r\n        \r\n        // Enhanced portal glow light\r\n        const portalLight = new THREE.PointLight(0x00ffff, 400, 2000, 2);\r\n        portalLight.position.set(0, 0, 0);\r\n        parentGroup.add(portalLight);\r\n        \r\n        // Add some more volumetric effects around the portal\r\n        const createPortalWisps = () => {\r\n          const wispGeometry = new THREE.TorusGeometry(650, 10, 8, 100);\r\n          const wispMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0x00ffff,\r\n            emissive: 0x00ffff,\r\n            emissiveIntensity: 2,\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            side: THREE.DoubleSide\r\n          });\r\n        \r\n          const wisp = new THREE.Mesh(wispGeometry, wispMaterial);\r\n          wisp.rotation.x = Math.random() * Math.PI;\r\n          wisp.rotation.y = Math.random() * Math.PI;\r\n          \r\n          // Store animation parameters - more dramatic for enhanced effect\r\n          wisp.userData = {\r\n            rotationSpeed: {\r\n              x: (Math.random() - 0.5) * 0.02,  // 10x faster rotation\r\n              y: (Math.random() - 0.5) * 0.02,\r\n              z: (Math.random() - 0.5) * 0.02\r\n            },\r\n            pulseSpeed: 0.5 + Math.random() * 0.3\r\n          };\r\n          \r\n          this.portalParticles.push(wisp);\r\n          return wisp;\r\n        };\r\n        \r\n        // Add more wisps for enhanced effect\r\n        for (let i = 0; i < 8; i++) {\r\n          parentGroup.add(createPortalWisps());\r\n        }\r\n        \r\n        // Store the shader material for animation updates\r\n        this.portalShaderMaterial = portalShaderMaterial;\r\n        this.portalLight = portalLight;\r\n    }\r\n  \r\n    createNeonDetails() {\r\n        const detailsGroup = new THREE.Group();\r\n        \r\n        // Create evenly spaced neon accents around the ring\r\n        const createNeonAccent = (angle) => {\r\n          const accentGroup = new THREE.Group();\r\n          \r\n          // Neon light beam\r\n          const beamGeometry = new THREE.CylinderGeometry(10, 10, 300, 8);\r\n          const beamMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0x00ffff,\r\n            emissive: 0x00ffff,\r\n            emissiveIntensity: 1,\r\n            transparent: true,\r\n            opacity: 0.8\r\n          });\r\n          const beam = new THREE.Mesh(beamGeometry, beamMaterial);\r\n          beam.rotation.x = Math.PI / 2; // Align with ring\r\n          \r\n          // Light source for glow\r\n          const light = new THREE.PointLight(0x00ffff, 100, 400, 2);\r\n          light.position.set(0, 0, 0);\r\n          \r\n          accentGroup.add(beam);\r\n          accentGroup.add(light);\r\n          \r\n          // Position on the ring\r\n          accentGroup.position.x = Math.cos(angle) * 1000;\r\n          accentGroup.position.y = Math.sin(angle) * 1000;\r\n          accentGroup.rotation.z = angle - Math.PI / 2; // Orient toward center\r\n          \r\n          // Store for animation\r\n          light.userData = {\r\n            originalIntensity: light.intensity,\r\n            phase: Math.random() * Math.PI * 2\r\n          };\r\n          \r\n          this.navLights.push({ light, lightMesh: beam });\r\n          \r\n          return accentGroup;\r\n        };\r\n        \r\n        // Add 8 neon accents evenly around the ring\r\n        for (let i = 0; i < 8; i++) {\r\n          const angle = (i / 8) * Math.PI * 2;\r\n          detailsGroup.add(createNeonAccent(angle));\r\n        }\r\n        \r\n        return detailsGroup;\r\n    }\r\n    \r\n    getPosition() {\r\n        // Updated to 2x height from the sun\r\n        return new THREE.Vector3(0, 10000, 0);\r\n    }\r\n    \r\n    getRegionInfo() {\r\n        // Updated center position to match new height\r\n        return {\r\n            center: new THREE.Vector3(0, 10000, 0),\r\n            radius: 2000\r\n        };\r\n    }\r\n    \r\n    update() {\r\n        // Animate navigation lights with pulsing effect\r\n        if (this.navLights) {\r\n          this.navLights.forEach(({ light, lightMesh }) => {\r\n                const time = Date.now() * 0.001;\r\n                const flicker = 0.7 + 0.3 * Math.sin(time * 2 + light.userData.phase);\r\n                \r\n                light.intensity = light.userData.originalIntensity * flicker;\r\n                \r\n            // Also update the light beam material\r\n            if (lightMesh.material) {\r\n              lightMesh.material.emissiveIntensity = flicker;\r\n              lightMesh.material.opacity = 0.5 + (flicker * 0.5);\r\n            }\r\n          });\r\n        }\r\n        \r\n        // Update shader time for the portal effect\r\n        if (this.portalShaderMaterial) {\r\n          this.portalShaderMaterial.uniforms.time.value = Date.now() * 0.001;\r\n          \r\n          // Make portal light pulse with time\r\n          if (this.portalLight) {\r\n            const time = Date.now() * 0.001;\r\n            this.portalLight.intensity = 400 + Math.sin(time * 2.0) * 150;\r\n          }\r\n        }\r\n        \r\n        // Animate the portal wisp effects\r\n        if (this.portalParticles) {\r\n          this.portalParticles.forEach(particle => {\r\n            const time = Date.now() * 0.001;\r\n            \r\n            // Apply rotation based on stored rotation speeds\r\n            if (particle.userData.rotationSpeed) {\r\n              particle.rotation.x += particle.userData.rotationSpeed.x;\r\n              particle.rotation.y += particle.userData.rotationSpeed.y;\r\n              particle.rotation.z += particle.userData.rotationSpeed.z;\r\n            }\r\n            \r\n            // Apply subtle scale pulsing if present\r\n            if (particle.userData.pulseSpeed) {\r\n              const pulse = 0.9 + 0.2 * Math.sin(time * particle.userData.pulseSpeed);\r\n              particle.scale.set(pulse, pulse, pulse);\r\n            }\r\n          });\r\n        }\r\n        \r\n        // Update counter-rotating ring\r\n        if (this.counterRotatingRing) {\r\n          this.counterRotatingRing.rotation.x += 0.006; // Counter rotate\r\n          this.counterRotatingRing.rotation.y += 0.009;\r\n          this.counterRotatingRing.rotation.z -= 0.003;\r\n        }\r\n        \r\n        // Rotate the stargate on all three axes for a more dynamic spinning effect (30x faster)\r\n        if (this.stargate) {\r\n          this.stargate.rotation.x += 0.003;   // 30x faster rotation on X axis (was 0.0001)\r\n          this.stargate.rotation.y += 0.0045;  // 30x faster rotation on Y axis (was 0.00015)\r\n          this.stargate.rotation.z += 0.006;   // 30x faster rotation on Z axis (was 0.0002)\r\n        }\r\n    }\r\n} ","// starSystemGenerator.js - Procedural generation of star systems\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class StarSystemGenerator {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.systems = {}; // Stores all generated star systems\r\n        this.currentSystem = null; // Currently active system\r\n        this.warpGates = {}; // Map of connections between systems\r\n        this.starClasses = ['O', 'B', 'A', 'F', 'G', 'K', 'M']; // Star classification\r\n        this.systemClassifications = [\r\n            'Resource-Rich', \r\n            'Ancient', \r\n            'Unstable', \r\n            'Barren', \r\n            'Hazardous', \r\n            'Peaceful'\r\n        ];\r\n        \r\n        // Available skybox textures for non-Solar systems\r\n        this.skyboxTextures = [\r\n            './assets/s1.jpg',\r\n            './assets/s2.jpg',\r\n            './assets/s3.jpg',\r\n            './assets/s4.jpg',\r\n            './assets/s5.jpg',\r\n            './assets/s6.jpg',\r\n            './assets/s7.jpg',\r\n            './assets/s8.jpg',\r\n            './assets/s9.jpg'\r\n        ];\r\n        \r\n        // Resource distribution by star type\r\n        this.resourceDistribution = {\r\n            'O': { iron: 0.3, gold: 0.4, platinum: 0.3 }, // Hot blue stars - balanced\r\n            'B': { iron: 0.2, gold: 0.3, platinum: 0.5 }, // Blue-white - platinum rich\r\n            'A': { iron: 0.2, gold: 0.5, platinum: 0.3 }, // White - gold rich\r\n            'F': { iron: 0.3, gold: 0.4, platinum: 0.3 }, // Yellow-white - balanced\r\n            'G': { iron: 0.4, gold: 0.3, platinum: 0.3 }, // Yellow (like our sun) - iron rich\r\n            'K': { iron: 0.5, gold: 0.3, platinum: 0.2 }, // Orange - iron rich\r\n            'M': { iron: 0.6, gold: 0.2, platinum: 0.2 }  // Red dwarfs - iron rich\r\n        };\r\n        \r\n        // Resource multipliers by system classification\r\n        this.classificationMultipliers = {\r\n            'Resource-Rich': { iron: 2.0, gold: 2.0, platinum: 2.0 },\r\n            'Ancient': { iron: 1.0, gold: 1.5, platinum: 2.5 },\r\n            'Unstable': { iron: 1.0, gold: 1.0, platinum: 3.0 },\r\n            'Barren': { iron: 0.5, gold: 0.5, platinum: 0.5 },\r\n            'Hazardous': { iron: 1.5, gold: 1.5, platinum: 1.5 },\r\n            'Peaceful': { iron: 1.0, gold: 1.0, platinum: 1.0 },\r\n            'Home System': { iron: 1.0, gold: 1.0, platinum: 1.0 }\r\n        };\r\n        \r\n        // Initialize the system\r\n        this.initializeSystems();\r\n    }\r\n    \r\n    // Initialize star systems with Solar System as default\r\n    initializeSystems() {\r\n        console.log(\"Initializing star systems...\");\r\n        \r\n        // First create our Solar System as the starting point\r\n        this.createSolarSystem();\r\n        \r\n        // Generate a few more star systems\r\n        this.generateRandomSystems(5);\r\n        \r\n        // Create connections between systems via warp gates\r\n        this.createSystemConnections();\r\n        \r\n        // Set Solar System as current system\r\n        this.setCurrentSystem('Solar System');\r\n        \r\n        console.log(\"Star systems initialized\");\r\n    }\r\n    \r\n    // Create our Solar System\r\n    createSolarSystem() {\r\n        // Add solar system with predefined properties and Earth as special planet\r\n        const solarSystem = {\r\n            id: 'Solar System',\r\n            name: 'Solar System',\r\n            starClass: 'G',\r\n            classification: 'Home System',\r\n            starColor: 0xFFFF00, // Yellow sun\r\n            planetCount: 8,\r\n            asteroidDensity: 1.0,\r\n            specialFeatures: ['Earth'],\r\n            description: 'Our home system, with Earth as the starting location.',\r\n            connections: [], // Will be populated later\r\n            position: new THREE.Vector3(0, 0, 0), // Center point for the star map\r\n            skyboxParams: {\r\n                starDensity: 1.0,\r\n                nebulaDensity: 0.5,\r\n                color: 0xFFFFFF,\r\n                texturePath: './assets/2k_stars_milky_way.jpg', // Default Milky Way texture\r\n                brightness: 1.0 // Full brightness for Solar System\r\n            },\r\n            resourceMultipliers: {\r\n                iron: 1.0, \r\n                gold: 1.0, \r\n                platinum: 1.0\r\n            }\r\n        };\r\n        \r\n        this.systems['Solar System'] = solarSystem;\r\n    }\r\n    \r\n    // Generate random star systems\r\n    generateRandomSystems(count) {\r\n        for (let i = 0; i < count; i++) {\r\n            const id = `System-${i+1}`;\r\n            const starClass = this.getRandomStarClass();\r\n            const classification = this.getRandomClassification();\r\n            \r\n            // Determine color based on star class\r\n            const starColor = this.getStarColorFromClass(starClass);\r\n            \r\n            // Calculate resource distribution based on star class and classification\r\n            const resourceMult = this.calculateResourceMultipliers(starClass, classification);\r\n            \r\n            // Select a random skybox texture\r\n            const skyboxTexture = this.getRandomSkyboxTexture();\r\n            \r\n            // Create the system\r\n            const system = {\r\n                id: id,\r\n                name: this.generateSystemName(starClass),\r\n                starClass: starClass,\r\n                classification: classification,\r\n                starColor: starColor,\r\n                planetCount: this.getRandomInt(2, 10),\r\n                asteroidDensity: this.getRandomFloat(0.5, 2.5),\r\n                specialFeatures: this.generateSpecialFeatures(classification),\r\n                description: this.generateDescription(starClass, classification),\r\n                connections: [], // Will be populated later\r\n                position: this.generateMapPosition(), // Position in the star map\r\n                skyboxParams: {\r\n                    starDensity: this.getRandomFloat(0.7, 1.5),\r\n                    nebulaDensity: this.getRandomFloat(0.3, 1.2),\r\n                    color: this.getSkyboxColorFromClass(starClass),\r\n                    texturePath: skyboxTexture,\r\n                    brightness: 0.8 // Changed from 0.5 to 0.8\r\n                },\r\n                resourceMultipliers: resourceMult\r\n            };\r\n            \r\n            this.systems[id] = system;\r\n        }\r\n    }\r\n    \r\n    // Get a random skybox texture for non-Solar systems\r\n    getRandomSkyboxTexture() {\r\n        return this.skyboxTextures[this.getRandomInt(0, this.skyboxTextures.length - 1)];\r\n    }\r\n    \r\n    // Create connections between systems\r\n    createSystemConnections() {\r\n        // Map all systems to ensure each has at least one connection\r\n        const systemIds = Object.keys(this.systems);\r\n        \r\n        // Connect Solar System to at least two random systems\r\n        const solarSystem = this.systems['Solar System'];\r\n        const solarConnections = this.getRandomSystemsExcept('Solar System', 2);\r\n        \r\n        for (const targetId of solarConnections) {\r\n            this.createConnection('Solar System', targetId);\r\n        }\r\n        \r\n        // Ensure each system has at least one connection\r\n        for (const systemId of systemIds) {\r\n            const system = this.systems[systemId];\r\n            \r\n            // If no connections yet, create one\r\n            if (system.connections.length === 0) {\r\n                // Find a random system to connect to (that is not itself)\r\n                const targetId = this.getRandomSystemExcept(systemId);\r\n                this.createConnection(systemId, targetId);\r\n            }\r\n        }\r\n        \r\n        // Add some additional random connections for more interesting network\r\n        const extraConnectionCount = Math.floor(systemIds.length / 2);\r\n        for (let i = 0; i < extraConnectionCount; i++) {\r\n            const sourceId = systemIds[this.getRandomInt(0, systemIds.length - 1)];\r\n            const targetId = this.getRandomSystemExcept(sourceId);\r\n            \r\n            // Ensure we're not creating a duplicate connection\r\n            if (!this.systems[sourceId].connections.includes(targetId)) {\r\n                this.createConnection(sourceId, targetId);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Create a connection between two systems\r\n    createConnection(sourceId, targetId) {\r\n        // Add to connections list of both systems\r\n        this.systems[sourceId].connections.push(targetId);\r\n        this.systems[targetId].connections.push(sourceId);\r\n        \r\n        // Register in warp gates map\r\n        if (!this.warpGates[sourceId]) {\r\n            this.warpGates[sourceId] = [];\r\n        }\r\n        if (!this.warpGates[targetId]) {\r\n            this.warpGates[targetId] = [];\r\n        }\r\n        \r\n        this.warpGates[sourceId].push(targetId);\r\n        this.warpGates[targetId].push(sourceId);\r\n        \r\n        console.log(`Created connection between ${sourceId} and ${targetId}`);\r\n    }\r\n    \r\n    // Get list of connections for current system\r\n    getCurrentSystemConnections() {\r\n        if (!this.currentSystem) return [];\r\n        return this.systems[this.currentSystem].connections;\r\n    }\r\n    \r\n    // Get resource distribution for current system\r\n    getCurrentSystemResources() {\r\n        if (!this.currentSystem) return { iron: 1, gold: 1, platinum: 1 };\r\n        \r\n        const system = this.systems[this.currentSystem];\r\n        return system.resourceMultipliers;\r\n    }\r\n    \r\n    // Set the current active system\r\n    setCurrentSystem(systemId) {\r\n        if (this.systems[systemId]) {\r\n            this.currentSystem = systemId;\r\n            console.log(`Traveled to system: ${systemId}`);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    \r\n    // Travel to a connected system\r\n    travelToSystem(targetSystemId) {\r\n        // Verify the target system exists\r\n        if (!this.systems[targetSystemId]) {\r\n            console.error(`System ${targetSystemId} does not exist`);\r\n            return false;\r\n        }\r\n        \r\n        // Verify there is a connection from current to target\r\n        const connections = this.getCurrentSystemConnections();\r\n        if (!connections.includes(targetSystemId)) {\r\n            console.error(`No connection from ${this.currentSystem} to ${targetSystemId}`);\r\n            return false;\r\n        }\r\n        \r\n        // Check if the ship is docked\r\n        if (window.game && window.game.spaceship && window.game.spaceship.isDocked) {\r\n            console.log(\"Player is docked during interstellar travel\");\r\n        }\r\n        \r\n        // Log current system params\r\n        if (this.systems[this.currentSystem]) {\r\n            const currentParams = this.systems[this.currentSystem].skyboxParams;\r\n            console.log(`${this.currentSystem} skybox params before travel: \r\n                         color=${currentParams.color.toString(16)}, \r\n                         starDensity=${currentParams.starDensity}, \r\n                         nebulaDensity=${currentParams.nebulaDensity}, \r\n                         texture=${currentParams.texturePath}`);\r\n        }\r\n        \r\n        // Log target system params\r\n        if (this.systems[targetSystemId]) {\r\n            const targetParams = this.systems[targetSystemId].skyboxParams;\r\n            console.log(`Traveling to ${targetSystemId} with skybox params: \r\n                         color=${targetParams.color.toString(16)}, \r\n                         starDensity=${targetParams.starDensity}, \r\n                         nebulaDensity=${targetParams.nebulaDensity}, \r\n                         texture=${targetParams.texturePath}`);\r\n        }\r\n        \r\n        // Set the new current system\r\n        this.setCurrentSystem(targetSystemId);\r\n        return true;\r\n    }\r\n    \r\n    // Get all star systems for the map\r\n    getAllSystems() {\r\n        return this.systems;\r\n    }\r\n    \r\n    // Get current system data\r\n    getCurrentSystemData() {\r\n        if (!this.currentSystem) return null;\r\n        return this.systems[this.currentSystem];\r\n    }\r\n    \r\n    // Helper methods\r\n    getRandomStarClass() {\r\n        const weights = [1, 2, 5, 10, 15, 20, 50]; // More common to have M class stars, rarer to have O class\r\n        const total = weights.reduce((sum, weight) => sum + weight, 0);\r\n        let random = Math.random() * total;\r\n        \r\n        for (let i = 0; i < weights.length; i++) {\r\n            if (random < weights[i]) {\r\n                return this.starClasses[i];\r\n            }\r\n            random -= weights[i];\r\n        }\r\n        \r\n        return this.starClasses[this.getRandomInt(0, this.starClasses.length - 1)];\r\n    }\r\n    \r\n    getRandomClassification() {\r\n        return this.systemClassifications[this.getRandomInt(0, this.systemClassifications.length - 1)];\r\n    }\r\n    \r\n    getStarColorFromClass(starClass) {\r\n        // Star colors based on spectral classification\r\n        const colors = {\r\n            'O': 0x9bb0ff, // Blue\r\n            'B': 0xaabfff, // Blue-white\r\n            'A': 0xcad7ff, // White\r\n            'F': 0xf8f7ff, // Yellow-white\r\n            'G': 0xfff4ea, // Yellow (like our sun)\r\n            'K': 0xffd2a1, // Orange\r\n            'M': 0xffcc6f  // Red\r\n        };\r\n        \r\n        return colors[starClass] || 0xffffff;\r\n    }\r\n    \r\n    getSkyboxColorFromClass(starClass) {\r\n        // Skybox colors based on spectral classification\r\n        const colors = {\r\n            'O': 0x0000ff, // Blue tint\r\n            'B': 0x4444ff, // Blue-white tint\r\n            'A': 0x8888ff, // White-blue tint\r\n            'F': 0xddddff, // Yellow-white tint\r\n            'G': 0xffffdd, // Yellow tint\r\n            'K': 0xffddaa, // Orange tint\r\n            'M': 0xff8866  // Red tint\r\n        };\r\n        \r\n        return colors[starClass] || 0xffffff;\r\n    }\r\n    \r\n    generateSystemName(starClass) {\r\n        const prefixes = [\r\n            'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',\r\n            'Proxima', 'Nova', 'Sirius', 'Vega', 'Rigel', 'Antares', 'Arcturus'\r\n        ];\r\n        \r\n        const suffixes = [\r\n            'Prime', 'Major', 'Minor', 'A', 'B', 'I', 'II', 'III', 'IV', 'V'\r\n        ];\r\n        \r\n        const prefix = prefixes[this.getRandomInt(0, prefixes.length - 1)];\r\n        const suffix = this.getRandomInt(0, 10) > 7 ? ` ${suffixes[this.getRandomInt(0, suffixes.length - 1)]}` : '';\r\n        const number = this.getRandomInt(1, 999);\r\n        \r\n        return `${prefix} ${starClass}${number}${suffix}`;\r\n    }\r\n    \r\n    generateSpecialFeatures(classification) {\r\n        const features = [];\r\n        \r\n        // Add classification-specific features\r\n        switch (classification) {\r\n            case 'Resource-Rich':\r\n                features.push('Dense Asteroid Fields', 'Rich Mineral Veins');\r\n                break;\r\n            case 'Ancient':\r\n                features.push('Abandoned Structures', 'Ancient Artifacts');\r\n                break;\r\n            case 'Unstable':\r\n                features.push('Solar Flares', 'Radiation Bursts');\r\n                break;\r\n            case 'Barren':\r\n                features.push('Minimal Resources', 'Few Planets');\r\n                break;\r\n            case 'Hazardous':\r\n                features.push('Asteroid Storms', 'Energy Anomalies');\r\n                break;\r\n            case 'Peaceful':\r\n                features.push('Stable Environment', 'Optimal Mining Conditions');\r\n                break;\r\n        }\r\n        \r\n        return features;\r\n    }\r\n    \r\n    generateDescription(starClass, classification) {\r\n        // Base descriptions by star class\r\n        const starDescriptions = {\r\n            'O': \"A rare, hot blue star system with intense radiation.\",\r\n            'B': \"A blue-white star system with high energy output.\",\r\n            'A': \"A white star system with moderate radiation levels.\",\r\n            'F': \"A yellow-white star system with mild conditions.\",\r\n            'G': \"A yellow star system similar to our Solar System.\",\r\n            'K': \"An orange star system with reduced energy output.\",\r\n            'M': \"A common red dwarf system with low energy output.\"\r\n        };\r\n        \r\n        // Additional descriptions by classification\r\n        const classDescriptions = {\r\n            'Resource-Rich': \"The system is known for its abundant resources and dense asteroid fields.\",\r\n            'Ancient': \"This ancient system contains remnants of long-lost civilizations.\",\r\n            'Unstable': \"Be cautious as unpredictable stellar activity occurs in this system.\",\r\n            'Barren': \"Resources are scarce in this mostly empty star system.\",\r\n            'Hazardous': \"Environmental hazards make mining operations difficult but rewarding.\",\r\n            'Peaceful': \"This system offers stable and optimal conditions for mining operations.\",\r\n            'Home System': \"Our home system, containing Earth and the origin of humanity.\"\r\n        };\r\n        \r\n        return `${starDescriptions[starClass]} ${classDescriptions[classification]}`;\r\n    }\r\n    \r\n    calculateResourceMultipliers(starClass, classification) {\r\n        const baseDistribution = this.resourceDistribution[starClass];\r\n        const classMultiplier = this.classificationMultipliers[classification];\r\n        \r\n        return {\r\n            iron: baseDistribution.iron * classMultiplier.iron,\r\n            gold: baseDistribution.gold * classMultiplier.gold, \r\n            platinum: baseDistribution.platinum * classMultiplier.platinum\r\n        };\r\n    }\r\n    \r\n    generateMapPosition() {\r\n        // Generate a position for the star map UI\r\n        // This is in abstract coordinates for the 2D map, not the 3D world\r\n        const radius = 150 + Math.random() * 100; // Distance from center\r\n        const angle = Math.random() * Math.PI * 2; // Random angle\r\n        \r\n        const x = Math.cos(angle) * radius;\r\n        const y = Math.sin(angle) * radius;\r\n        \r\n        return new THREE.Vector3(x, y, 0);\r\n    }\r\n    \r\n    getRandomSystemsExcept(exceptId, count) {\r\n        const systemIds = Object.keys(this.systems).filter(id => id !== exceptId);\r\n        const selected = [];\r\n        \r\n        // Select random systems up to count\r\n        for (let i = 0; i < Math.min(count, systemIds.length); i++) {\r\n            const index = this.getRandomInt(0, systemIds.length - 1);\r\n            selected.push(systemIds[index]);\r\n            systemIds.splice(index, 1); // Remove to avoid duplicates\r\n        }\r\n        \r\n        return selected;\r\n    }\r\n    \r\n    getRandomSystemExcept(exceptId) {\r\n        const systemIds = Object.keys(this.systems).filter(id => id !== exceptId);\r\n        const index = this.getRandomInt(0, systemIds.length - 1);\r\n        return systemIds[index];\r\n    }\r\n    \r\n    // Utility methods\r\n    getRandomInt(min, max) {\r\n        return Math.floor(Math.random() * (max - min + 1)) + min;\r\n    }\r\n    \r\n    getRandomFloat(min, max) {\r\n        return Math.random() * (max - min) + min;\r\n    }\r\n    \r\n    // Add this method to the StarSystemGenerator class\r\n    addCustomSystem(systemData) {\r\n        if (!systemData || !systemData.id || !systemData.name) {\r\n            console.error('Invalid system data', systemData);\r\n            return false;\r\n        }\r\n        \r\n        // Check if a system with this ID already exists\r\n        if (this.systems[systemData.id]) {\r\n            console.warn(`System with ID ${systemData.id} already exists, overwriting`);\r\n        }\r\n        \r\n        console.log(`Adding custom system: ${systemData.name} (${systemData.id})`);\r\n        \r\n        // Create or update the custom system\r\n        const customSystem = {\r\n            id: systemData.id,\r\n            name: systemData.name,\r\n            starClass: systemData.starClass || this.getRandomStarClass(),\r\n            classification: systemData.classification || 'Custom',\r\n            starColor: systemData.starColor || this.getStarColorFromClass(systemData.starClass || 'G'),\r\n            planetCount: systemData.planetData ? systemData.planetData.length : 0,\r\n            asteroidDensity: systemData.asteroidDensity || 1.0,\r\n            specialFeatures: systemData.specialFeatures || ['User Created'],\r\n            description: systemData.description || 'A custom star system created by the user',\r\n            connections: [], // Will be populated by createConnection\r\n            position: systemData.position || this.generateMapPosition(),\r\n            skyboxParams: {\r\n                starDensity: systemData.skyboxParams?.starDensity || 1.0,\r\n                nebulaDensity: systemData.skyboxParams?.nebulaDensity || 0.8,\r\n                color: systemData.skyboxParams?.color || this.getSkyboxColorFromClass(systemData.starClass || 'G'),\r\n                texturePath: systemData.skyboxUrl || this.getRandomSkyboxTexture(),\r\n                brightness: systemData.skyboxParams?.brightness || 0.8,\r\n                isCustomTexture: !!systemData.skyboxUrl // Flag to indicate custom texture\r\n            },\r\n            resourceMultipliers: systemData.resourceMultipliers || {\r\n                iron: 1.0,\r\n                gold: 1.0,\r\n                platinum: 1.0\r\n            },\r\n            isCustomSystem: true // Flag to mark as custom\r\n        };\r\n        \r\n        // Store custom planet data if provided\r\n        if (systemData.planetData && Array.isArray(systemData.planetData)) {\r\n            this.storePlanetData(systemData.id, systemData.planetData);\r\n        }\r\n        \r\n        // Add the system to our collection\r\n        this.systems[systemData.id] = customSystem;\r\n        \r\n        // Create a connection to Solar System or another random system\r\n        this.createConnection('Solar System', systemData.id);\r\n        \r\n        // Create an additional random connection\r\n        const randomSystem = this.getRandomSystemExcept(systemData.id, 'Solar System');\r\n        if (randomSystem) {\r\n            this.createConnection(systemData.id, randomSystem);\r\n        }\r\n        \r\n        console.log(`Custom system ${systemData.name} added successfully with connections to Solar System and ${randomSystem || 'no other system'}`);\r\n        \r\n        return true;\r\n    }\r\n    \r\n    // Add this method to store custom planet data\r\n    storePlanetData(systemId, planetData) {\r\n        if (!Array.isArray(planetData)) {\r\n            console.error('Planet data must be an array');\r\n            return;\r\n        }\r\n        \r\n        // Create a new array to store standardized planet data\r\n        const standardizedPlanets = [];\r\n        \r\n        // Process each planet\r\n        for (let i = 0; i < planetData.length; i++) {\r\n            const planet = planetData[i];\r\n            \r\n            standardizedPlanets.push({\r\n                name: planet.name || `Planet-${i+1}`,\r\n                size: planet.size || (300 + Math.random() * 500),\r\n                distance: planet.distance || (4800 + (i * 8000) + (Math.random() * 2000)),\r\n                speed: planet.speed || (0.001 + (Math.random() * 0.001)),\r\n                color: planet.color || this.getRandomColor(),\r\n                rings: planet.rings !== undefined ? planet.rings : Math.random() > 0.7,\r\n                textureUrl: planet.textureUrl || null, // Custom texture URL\r\n                axialTilt: planet.axialTilt || (Math.random() * Math.PI * 0.5),\r\n                orbitalTilt: planet.orbitalTilt || (Math.random() * Math.PI * 0.2)\r\n            });\r\n        }\r\n        \r\n        // Store the planet data for this system\r\n        if (!this.customPlanetData) {\r\n            this.customPlanetData = {};\r\n        }\r\n        \r\n        this.customPlanetData[systemId] = standardizedPlanets;\r\n        console.log(`Stored ${standardizedPlanets.length} planets for system ${systemId}`);\r\n    }\r\n    \r\n    // Helper method to generate a random color\r\n    getRandomColor() {\r\n        return Math.floor(Math.random() * 0xFFFFFF);\r\n    }\r\n\r\n    /**\r\n     * Returns player to stargate after interstellar travel\r\n     * Should be called after travel to ensure proper docking state\r\n     */\r\n    returnFromTravel() {\r\n        console.log(\"StarSystemGenerator: Handling return from interstellar travel\");\r\n        \r\n        // Check if game and spaceship are available\r\n        if (!window.game || !window.game.spaceship) {\r\n            console.error(\"StarSystemGenerator: Cannot return from travel - game or spaceship not found\");\r\n            return false;\r\n        }\r\n        \r\n        // Ensure the player is docked after travel\r\n        if (!window.game.spaceship.isDocked) {\r\n            console.log(\"StarSystemGenerator: Setting ship to docked state after travel\");\r\n            window.game.spaceship.dock();\r\n        }\r\n        \r\n        // Reposition ship near stargate\r\n        const dockingSystem = window.game.controls?.dockingSystem;\r\n        if (dockingSystem) {\r\n            console.log(\"StarSystemGenerator: Repositioning ship near stargate\");\r\n            dockingSystem.positionNearStargate();\r\n            \r\n            // Show stargate UI\r\n            if (typeof dockingSystem.showStargateUI === 'function') {\r\n                console.log(\"StarSystemGenerator: Showing stargate UI via docking system\");\r\n                dockingSystem.showStargateUI();\r\n                return true;\r\n            }\r\n        }\r\n        \r\n        // Fallback - try to find UI or stargate interface directly\r\n        if (window.game.ui?.stargateInterface?.showStargateUI) {\r\n            console.log(\"StarSystemGenerator: Showing stargate UI via game.ui.stargateInterface\");\r\n            window.game.ui.stargateInterface.showStargateUI();\r\n            return true;\r\n        }\r\n        \r\n        console.warn(\"StarSystemGenerator: Could not fully complete return from travel\");\r\n        return false;\r\n    }\r\n}","// systemTransition.js - Handles the visual transition between star systems\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class SystemTransition {\r\n    constructor(scene, camera) {\r\n        this.scene = scene;\r\n        this.camera = camera;\r\n        this.isTransitioning = false;\r\n        this.transitionDuration = 3000; // milliseconds\r\n        this.onTransitionComplete = null;\r\n        \r\n        // Create transition elements\r\n        this.setupTransitionElements();\r\n    }\r\n    \r\n    setupTransitionElements() {\r\n        // Warp tunnel effect\r\n        this.warpTunnel = new THREE.Points(\r\n            new THREE.BufferGeometry(),\r\n            new THREE.PointsMaterial({\r\n                color: 0x30cfd0,\r\n                size: 2,\r\n                blending: THREE.AdditiveBlending,\r\n                transparent: true,\r\n                sizeAttenuation: true\r\n            })\r\n        );\r\n        \r\n        // Create particles for warp effect\r\n        this.createWarpParticles();\r\n        \r\n        // Flash overlay for transition effect\r\n        this.createOverlay();\r\n    }\r\n    \r\n    createWarpParticles() {\r\n        // Number of particles\r\n        const particleCount = 2000;\r\n        \r\n        // Create position array\r\n        const positions = new Float32Array(particleCount * 3);\r\n        \r\n        // Initialize particle positions in a tunnel shape\r\n        for (let i = 0; i < particleCount; i++) {\r\n            const i3 = i * 3;\r\n            \r\n            // Polar coordinates for tunnel shape\r\n            const radius = 50 + Math.random() * 50;\r\n            const theta = Math.random() * Math.PI * 2;\r\n            const length = -500 - Math.random() * 3000; // Negative z is forward\r\n            \r\n            // Convert to Cartesian\r\n            positions[i3] = radius * Math.cos(theta);     // x\r\n            positions[i3 + 1] = radius * Math.sin(theta); // y\r\n            positions[i3 + 2] = length;                   // z\r\n        }\r\n        \r\n        // Add to buffer geometry\r\n        this.warpTunnel.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n        \r\n        // Store original positions for resetting\r\n        this.originalPositions = new Float32Array(positions);\r\n    }\r\n    \r\n    createOverlay() {\r\n        // Create a DOM overlay for the flash effect\r\n        this.overlay = document.createElement('div');\r\n        this.overlay.id = 'warp-overlay';\r\n        this.overlay.style.position = 'fixed';\r\n        this.overlay.style.top = '0';\r\n        this.overlay.style.left = '0';\r\n        this.overlay.style.width = '100%';\r\n        this.overlay.style.height = '100%';\r\n        this.overlay.style.backgroundColor = '#30cfd0';\r\n        this.overlay.style.opacity = '0';\r\n        this.overlay.style.transition = 'opacity 0.5s';\r\n        this.overlay.style.pointerEvents = 'none';\r\n        this.overlay.style.zIndex = '9999';\r\n        \r\n        // Add to DOM but hide initially\r\n        document.body.appendChild(this.overlay);\r\n    }\r\n    \r\n    // Start a transition between systems\r\n    startTransition(onComplete) {\r\n        if (this.isTransitioning) return;\r\n        \r\n        console.log(\"Starting system transition...\");\r\n        this.isTransitioning = true;\r\n        \r\n        // Store callback\r\n        this.onTransitionComplete = onComplete;\r\n        \r\n        // Add warp tunnel to scene\r\n        this.scene.add(this.warpTunnel);\r\n        \r\n        // Position the camera for the transition\r\n        this.initialCameraPosition = this.camera.position.clone();\r\n        this.initialCameraRotation = this.camera.rotation.clone();\r\n        \r\n        // Start transition animation\r\n        this.startTime = Date.now();\r\n        \r\n        // Show overlay\r\n        this.showOverlay();\r\n        \r\n        // Start animation\r\n        this.animate();\r\n    }\r\n    \r\n    // Animation loop for transition\r\n    animate() {\r\n        if (!this.isTransitioning) return;\r\n        \r\n        const currentTime = Date.now();\r\n        const elapsed = currentTime - this.startTime;\r\n        const progress = Math.min(elapsed / this.transitionDuration, 1.0);\r\n        \r\n        // Update warp effect\r\n        this.updateWarpEffect(progress);\r\n        \r\n        // Check if transition is complete\r\n        if (progress >= 1.0) {\r\n            this.completeTransition();\r\n            return;\r\n        }\r\n        \r\n        // Continue animation\r\n        requestAnimationFrame(this.animate.bind(this));\r\n    }\r\n    \r\n    // Update warp tunnel effect\r\n    updateWarpEffect(progress) {\r\n        // Get positions\r\n        const positions = this.warpTunnel.geometry.attributes.position.array;\r\n        \r\n        // Adjust warp speed based on progress\r\n        const warpSpeed = 3 + progress * 20;\r\n        \r\n        // Update particle positions\r\n        for (let i = 0; i < positions.length; i += 3) {\r\n            // Move particles toward camera\r\n            positions[i + 2] += warpSpeed; // z value\r\n            \r\n            // Reset particles that go past the camera\r\n            if (positions[i + 2] > 100) {\r\n                // Reset to original position with an offset to create continuous tunnel\r\n                positions[i] = this.originalPositions[i];\r\n                positions[i + 1] = this.originalPositions[i + 1];\r\n                positions[i + 2] = this.originalPositions[i + 2] - 500; // Return to end of tunnel\r\n            }\r\n        }\r\n        \r\n        // Update buffer geometry\r\n        this.warpTunnel.geometry.attributes.position.needsUpdate = true;\r\n        \r\n        // Update camera animation - slight movement to enhance effect\r\n        if (this.camera) {\r\n            this.camera.rotation.z += 0.0005 * Math.sin(progress * Math.PI);\r\n        }\r\n    }\r\n    \r\n    // Show overlay with flash effect\r\n    showOverlay() {\r\n        if (!this.overlay) return;\r\n        \r\n        // Start with low opacity\r\n        this.overlay.style.opacity = '0.2';\r\n        \r\n        // Schedule flash toward end of transition\r\n        setTimeout(() => {\r\n            this.overlay.style.opacity = '1';\r\n            \r\n            // Fade out after flash\r\n            setTimeout(() => {\r\n                this.overlay.style.opacity = '0';\r\n            }, 500);\r\n        }, this.transitionDuration - 1000);\r\n    }\r\n    \r\n    // Complete the transition\r\n    completeTransition() {\r\n        console.log(\"System transition complete\");\r\n        this.isTransitioning = false;\r\n        \r\n        // Remove warp tunnel from scene\r\n        this.scene.remove(this.warpTunnel);\r\n        \r\n        // Reset camera position and rotation\r\n        if (this.camera && this.initialCameraPosition && this.initialCameraRotation) {\r\n            this.camera.position.copy(this.initialCameraPosition);\r\n            this.camera.rotation.copy(this.initialCameraRotation);\r\n        }\r\n        \r\n        // Call completion callback if provided\r\n        if (this.onTransitionComplete && typeof this.onTransitionComplete === 'function') {\r\n            // Use setTimeout to make sure this executes after the animation frame\r\n            setTimeout(() => {\r\n                console.log(\"Executing transition completion callback\");\r\n                this.onTransitionComplete();\r\n            }, 100);\r\n        }\r\n    }\r\n}","// apiClient.js - Client for interacting with the skybox generation API\r\n\r\nexport class ApiClient {\r\n    constructor() {\r\n        // API configuration\r\n        this.apiBaseUrl = this.getApiBaseUrl();\r\n        \r\n        // In-memory token storage (no localStorage)\r\n        this.token = null;\r\n        this.tokenExpiry = null;\r\n        \r\n        // Default client ID\r\n        this.clientId = 'game_client';\r\n        \r\n        // For token refresh\r\n        this.isRefreshing = false;\r\n        this.refreshCallbacks = [];\r\n        \r\n        console.log(`API Client initialized with base URL: ${this.apiBaseUrl}`);\r\n    }\r\n    \r\n    // Get base URL from environment or use default\r\n    getApiBaseUrl() {\r\n        // For local development\r\n        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {\r\n            return 'http://localhost:8001';\r\n        }\r\n        \r\n        // For production - Use the Heroku app URL\r\n        return 'https://aminer-skybox-generator-833fe937a945.herokuapp.com';\r\n    }\r\n    \r\n    // Check if token is valid and not expired\r\n    hasValidToken() {\r\n        if (!this.token || !this.tokenExpiry) {\r\n            return false;\r\n        }\r\n        \r\n        const expiryTime = new Date(this.tokenExpiry).getTime();\r\n        const currentTime = new Date().getTime();\r\n        \r\n        // Consider token expired if less than 5 minutes remain\r\n        const fiveMinutesInMs = 5 * 60 * 1000;\r\n        return (expiryTime - currentTime) > fiveMinutesInMs;\r\n    }\r\n    \r\n    // Clear token from memory\r\n    clearToken() {\r\n        this.token = null;\r\n        this.tokenExpiry = null;\r\n    }\r\n    \r\n    // Get a new token from the API\r\n    async getToken() {\r\n        // Prevent multiple simultaneous refresh attempts\r\n        if (this.isRefreshing) {\r\n            return new Promise((resolve) => {\r\n                this.refreshCallbacks.push((success) => resolve(success));\r\n            });\r\n        }\r\n        \r\n        this.isRefreshing = true;\r\n        \r\n        try {\r\n            const response = await fetch(`${this.apiBaseUrl}/token`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({ client_id: this.clientId })\r\n            });\r\n            \r\n            if (!response.ok) {\r\n                const errorData = await response.json();\r\n                const errorMessage = errorData.detail || 'Failed to get token';\r\n                console.error(`Token error (${response.status}): ${errorMessage}`);\r\n                \r\n                // Execute callbacks with failure\r\n                this.refreshCallbacks.forEach(cb => cb(false));\r\n                this.refreshCallbacks = [];\r\n                this.isRefreshing = false;\r\n                \r\n                throw new Error(errorMessage);\r\n            }\r\n            \r\n            const data = await response.json();\r\n            \r\n            // Save token in memory\r\n            this.token = data.access_token;\r\n            \r\n            // Set expiry (tokens are valid for 1 hour)\r\n            const expiryDate = new Date();\r\n            expiryDate.setHours(expiryDate.getHours() + 1);\r\n            this.tokenExpiry = expiryDate.toISOString();\r\n            \r\n            // Execute callbacks with success\r\n            this.refreshCallbacks.forEach(cb => cb(true));\r\n            this.refreshCallbacks = [];\r\n            this.isRefreshing = false;\r\n            \r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error getting token:', error);\r\n            \r\n            // Execute callbacks with failure\r\n            this.refreshCallbacks.forEach(cb => cb(false));\r\n            this.refreshCallbacks = [];\r\n            this.isRefreshing = false;\r\n            \r\n            return false;\r\n        }\r\n    }\r\n    \r\n    // Handle API response errors\r\n    async handleApiResponse(response) {\r\n        if (response.status === 401) {\r\n            // Token has expired or is invalid\r\n            this.clearToken();\r\n            \r\n            // Try to get a new token and retry the request\r\n            const success = await this.getToken();\r\n            if (!success) {\r\n                throw new Error('Authentication failed. Please reload the application.');\r\n            }\r\n            \r\n            // Return false to indicate a retry is needed\r\n            return false;\r\n        }\r\n        \r\n        if (response.status === 429) {\r\n            // Rate limit exceeded\r\n            throw new Error('Rate limit exceeded. Please try again later.');\r\n        }\r\n        \r\n        if (!response.ok) {\r\n            const errorData = await response.json();\r\n            throw new Error(errorData.message || errorData.detail || `Error: ${response.status} ${response.statusText}`);\r\n        }\r\n        \r\n        // Return true to indicate success\r\n        return true;\r\n    }\r\n    \r\n    // Generate a skybox based on the system name and description\r\n    async generateSkybox(systemName, description) {\r\n        // Get a new token if current one is invalid\r\n        if (!this.hasValidToken()) {\r\n            const success = await this.getToken();\r\n            if (!success) {\r\n                throw new Error('Failed to authenticate with the API');\r\n            }\r\n        }\r\n        \r\n        // Make request to generate skybox\r\n        const response = await fetch(`${this.apiBaseUrl}/generate-skybox`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${this.token}`\r\n            },\r\n            body: JSON.stringify({\r\n                system_name: systemName,\r\n                skybox_description: description\r\n            })\r\n        });\r\n        \r\n        // Handle response errors\r\n        const isValid = await this.handleApiResponse(response);\r\n        if (!isValid) {\r\n            // Retry the request with the new token\r\n            return this.generateSkybox(systemName, description);\r\n        }\r\n        \r\n        return await response.json();\r\n    }\r\n    \r\n    // Generate a planet texture based on the planet name and description\r\n    async generatePlanet(planetName, description) {\r\n        // Get a new token if current one is invalid\r\n        if (!this.hasValidToken()) {\r\n            const success = await this.getToken();\r\n            if (!success) {\r\n                throw new Error('Failed to authenticate with the API');\r\n            }\r\n        }\r\n        \r\n        // Make request to generate planet\r\n        const response = await fetch(`${this.apiBaseUrl}/generate-planet`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${this.token}`\r\n            },\r\n            body: JSON.stringify({\r\n                planet_name: planetName,\r\n                planet_description: description\r\n            })\r\n        });\r\n        \r\n        // Handle response errors\r\n        const isValid = await this.handleApiResponse(response);\r\n        if (!isValid) {\r\n            // Retry the request with the new token\r\n            return this.generatePlanet(planetName, description);\r\n        }\r\n        \r\n        return await response.json();\r\n    }\r\n    \r\n    // Convert a relative image path to a full URL\r\n    getFullImageUrl(relativeUrl) {\r\n        // If it's already a full URL, return as is\r\n        if (relativeUrl.startsWith('http')) {\r\n            return relativeUrl;\r\n        }\r\n        \r\n        // Remove leading slash if present\r\n        const cleanPath = relativeUrl.startsWith('/') ? relativeUrl.substring(1) : relativeUrl;\r\n        \r\n        // Get the API base URL\r\n        const baseUrl = this.apiBaseUrl;\r\n        \r\n        // Join with API base URL\r\n        return `${baseUrl}/${cleanPath}`;\r\n    }\r\n} ","// customSystemCreator.js - UI for creating custom star systems with AI-generated assets\r\n\r\nimport { ApiClient } from '../utils/apiClient.js';\r\n\r\nexport class CustomSystemCreator {\r\n    constructor(starSystemGenerator, environment) {\r\n        this.starSystemGenerator = starSystemGenerator;\r\n        this.environment = environment;\r\n        this.apiClient = new ApiClient();\r\n        this.isVisible = false;\r\n        this.isGenerating = false;\r\n        this.generatedSkyboxUrl = null;\r\n        this.generatedPlanetUrls = [];\r\n        this.systemData = null;\r\n        this.isMobile = this.detectMobile();\r\n        \r\n        // Initialize UI\r\n        this.createUI();\r\n        this.setupEventHandlers();\r\n        \r\n        // Setup the sliders for the first planet\r\n        this.setupSliderListeners(1);\r\n    }\r\n    \r\n    detectMobile() {\r\n        return ('ontouchstart' in window) || \r\n               (navigator.maxTouchPoints > 0) || \r\n               (navigator.msMaxTouchPoints > 0) ||\r\n               (window.innerWidth < 900);\r\n    }\r\n    \r\n    createUI() {\r\n        // Create main container\r\n        this.container = document.createElement('div');\r\n        this.container.id = 'custom-system-creator';\r\n        this.container.className = 'modal-container';\r\n        this.container.style.display = 'none';\r\n        \r\n        // Create modal content with mobile optimizations\r\n        this.container.innerHTML = `\r\n            <div class=\"modal-content\" style=\"${this.isMobile ? 'width: 94%; max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 100px; overscroll-behavior: contain;' : ''}\">\r\n                <div class=\"modal-header\">\r\n                    <h2>Create New Star System</h2>\r\n                    <button id=\"close-system-creator\" class=\"close-btn\" style=\"${this.isMobile ? 'font-size: 28px; padding: 12px; min-height: 48px; min-width: 48px;' : ''}\">&times;</button>\r\n                </div>\r\n                <div class=\"modal-body\" style=\"${this.isMobile ? 'padding-bottom: 150px;' : ''}\">\r\n                    <div id=\"system-creator-form\">\r\n                        <div class=\"form-group\">\r\n                            <label for=\"system-name\">System Name:</label>\r\n                            <input type=\"text\" id=\"system-name\" placeholder=\"Enter a name for your star system\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px; height: 48px;' : ''}\">\r\n                        </div>\r\n                        \r\n                        <div class=\"form-group\">\r\n                            <label for=\"skybox-description\">Skybox Description:</label>\r\n                            <textarea id=\"skybox-description\" rows=\"${this.isMobile ? '3' : '4'}\" placeholder=\"Describe the skybox/space environment (e.g., 'A vibrant nebula with blue and purple clouds, dotted with bright stars')\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px;' : ''}\"></textarea>\r\n                        </div>\r\n                        \r\n                        <div class=\"form-group\">\r\n                            <label for=\"star-class\">Star Class:</label>\r\n                            <select id=\"star-class\" class=\"form-control\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px; height: 48px;' : ''}\">\r\n                                <option value=\"O\">O - Blue Giant (Hot, Blue)</option>\r\n                                <option value=\"B\">B - Blue-White</option>\r\n                                <option value=\"A\">A - White</option>\r\n                                <option value=\"F\">F - Yellow-White</option>\r\n                                <option value=\"G\" selected>G - Yellow (Sun-like)</option>\r\n                                <option value=\"K\">K - Orange</option>\r\n                                <option value=\"M\">M - Red Dwarf</option>\r\n                            </select>\r\n                            <p class=\"help-text\">Different star classes affect the lighting and appearance of your system.</p>\r\n                        </div>\r\n                        \r\n                        <div id=\"planet-descriptions\">\r\n                            <div class=\"form-group planet-input\">\r\n                                <h3>Planet 1</h3>\r\n                                <label for=\"planet-name-1\">Planet Name:</label>\r\n                                <input type=\"text\" id=\"planet-name-1\" placeholder=\"Enter a name for this planet\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px; height: 48px;' : ''}\">\r\n                                \r\n                                <label for=\"planet-description-1\">Planet Description:</label>\r\n                                <textarea id=\"planet-description-1\" rows=\"${this.isMobile ? '2' : '3'}\" placeholder=\"Describe the planet (e.g., 'A rocky planet with large oceans and ice caps')\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px;' : ''}\"></textarea>\r\n                                \r\n                                <div class=\"planet-properties\">\r\n                                    <div class=\"property-row\">\r\n                                        <label for=\"planet-size-1\">Size:</label>\r\n                                        <input type=\"range\" id=\"planet-size-1\" min=\"300\" max=\"1000\" value=\"450\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                                        <span class=\"slider-value\" id=\"planet-size-value-1\">450</span>\r\n                                    </div>\r\n                                    \r\n                                    <div class=\"property-row\">\r\n                                        <label for=\"planet-distance-1\">Distance from Star:</label>\r\n                                        <input type=\"range\" id=\"planet-distance-1\" min=\"4000\" max=\"60000\" value=\"8000\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                                        <span class=\"slider-value\" id=\"planet-distance-value-1\">8000</span>\r\n                                    </div>\r\n                                    \r\n                                    <div class=\"property-row\">\r\n                                        <label for=\"planet-speed-1\">Orbit Speed:</label>\r\n                                        <input type=\"range\" id=\"planet-speed-1\" min=\"1\" max=\"10\" value=\"5\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                                        <span class=\"slider-value\" id=\"planet-speed-value-1\">0.0015</span>\r\n                                    </div>\r\n                                    \r\n                                    <div class=\"property-row\" style=\"${this.isMobile ? 'margin-top: 15px;' : ''}\">\r\n                                        <label for=\"planet-rings-1\">Has Rings:</label>\r\n                                        <input type=\"checkbox\" id=\"planet-rings-1\" style=\"${this.isMobile ? 'transform: scale(1.7); margin: 0 15px; min-height: 24px; min-width: 24px;' : ''}\">\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <button id=\"add-planet-btn\" class=\"secondary-btn\" style=\"${this.isMobile ? 'min-height: 50px; padding: 14px; font-size: 16px; width: 100%; margin: 15px 0;' : ''}\">+ Add Another Planet</button>\r\n                        \r\n                        <div class=\"form-actions\">\r\n                            <button id=\"generate-system-btn\" class=\"primary-btn\" style=\"${this.isMobile ? 'min-height: 54px; padding: 16px; font-size: 18px; margin-top: 20px; width: 100%;' : ''}\">Generate System</button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div id=\"generation-progress\" style=\"display: none;\">\r\n                        <h3>Generating your star system...</h3>\r\n                        <div class=\"progress-bar\">\r\n                            <div class=\"progress-fill\"></div>\r\n                        </div>\r\n                        <p id=\"generation-status\">Initializing...</p>\r\n                    </div>\r\n                    \r\n                    <div id=\"system-preview\" style=\"display: none;\">\r\n                        <h3>Preview</h3>\r\n                        <div class=\"preview-container\" style=\"${this.isMobile ? 'flex-direction: column;' : ''}\">\r\n                            <div class=\"skybox-preview\" style=\"${this.isMobile ? 'width: 100%; margin-bottom: 20px;' : ''}\">\r\n                                <h4>Skybox</h4>\r\n                                <img id=\"skybox-preview-img\" src=\"\" alt=\"Skybox Preview\">\r\n                            </div>\r\n                            <div class=\"planets-preview\" id=\"planets-preview\" style=\"${this.isMobile ? 'width: 100%;' : ''}\">\r\n                                <!-- Planet previews will be added here dynamically -->\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"form-actions\" style=\"${this.isMobile ? 'padding-bottom: 30px;' : ''}\">\r\n                            <button id=\"travel-to-system-btn\" class=\"primary-btn\" style=\"${this.isMobile ? 'min-height: 54px; padding: 16px; font-size: 18px; width: 100%; margin-top: 20px;' : ''}\">Travel to System</button>\r\n                            <button id=\"regenerate-system-btn\" class=\"secondary-btn\" style=\"${this.isMobile ? 'min-height: 48px; padding: 14px; font-size: 16px; width: 100%; margin-top: 15px;' : ''}\">Regenerate</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        `;\r\n        \r\n        // Add to document\r\n        document.body.appendChild(this.container);\r\n        \r\n        // Capture references to elements\r\n        this.systemNameInput = document.getElementById('system-name');\r\n        this.skyboxDescription = document.getElementById('skybox-description');\r\n        this.planetDescriptions = document.getElementById('planet-descriptions');\r\n        this.addPlanetBtn = document.getElementById('add-planet-btn');\r\n        this.generateSystemBtn = document.getElementById('generate-system-btn');\r\n        this.generationProgress = document.getElementById('generation-progress');\r\n        this.generationStatus = document.getElementById('generation-status');\r\n        this.systemForm = document.getElementById('system-creator-form');\r\n        this.systemPreview = document.getElementById('system-preview');\r\n        this.skyboxPreviewImg = document.getElementById('skybox-preview-img');\r\n        this.planetsPreview = document.getElementById('planets-preview');\r\n        this.travelToSystemBtn = document.getElementById('travel-to-system-btn');\r\n        this.regenerateSystemBtn = document.getElementById('regenerate-system-btn');\r\n        \r\n        // Add mobile styles\r\n        if (this.isMobile) {\r\n            this.addMobileStyles();\r\n        }\r\n    }\r\n    \r\n    addMobileStyles() {\r\n        // Add CSS for better mobile experience if not already present\r\n        if (!document.getElementById('custom-system-creator-mobile-styles')) {\r\n            const style = document.createElement('style');\r\n            style.id = 'custom-system-creator-mobile-styles';\r\n            style.innerHTML = `\r\n                @media (max-width: 900px) {\r\n                    /* Mobile-specific styles for CustomSystemCreator */\r\n                    #custom-system-creator .modal-content {\r\n                        border-radius: 10px;\r\n                        padding-bottom: 120px;\r\n                    }\r\n                    \r\n                    #custom-system-creator .form-group {\r\n                        margin-bottom: 24px;\r\n                    }\r\n                    \r\n                    #custom-system-creator label {\r\n                        font-size: 16px;\r\n                        margin-bottom: 10px;\r\n                        display: block;\r\n                    }\r\n                    \r\n                    #custom-system-creator .property-row {\r\n                        flex-direction: column;\r\n                        align-items: flex-start;\r\n                        margin-bottom: 20px;\r\n                    }\r\n                    \r\n                    #custom-system-creator .property-row label {\r\n                        margin-bottom: 10px;\r\n                        width: 100%;\r\n                    }\r\n                    \r\n                    #custom-system-creator .slider {\r\n                        width: 100%;\r\n                        margin: 10px 0;\r\n                    }\r\n                    \r\n                    #custom-system-creator .slider-value {\r\n                        margin-top: 5px;\r\n                        align-self: flex-end;\r\n                    }\r\n                    \r\n                    #custom-system-creator .planet-input {\r\n                        padding: 20px;\r\n                        margin-bottom: 30px;\r\n                    }\r\n                    \r\n                    #custom-system-creator input[type=\"text\"],\r\n                    #custom-system-creator textarea,\r\n                    #custom-system-creator select {\r\n                        font-size: 16px !important;\r\n                        padding: 14px !important;\r\n                    }\r\n                    \r\n                    #custom-system-creator .planet-preview {\r\n                        flex: 0 0 100%;\r\n                        margin-bottom: 15px;\r\n                    }\r\n                    \r\n                    #custom-system-creator .form-actions {\r\n                        text-align: center;\r\n                    }\r\n                    \r\n                    /* Better slider for touch */\r\n                    #custom-system-creator input[type=\"range\"] {\r\n                        -webkit-appearance: none;\r\n                        height: 30px;\r\n                        background: #0d1e2f;\r\n                        border-radius: 15px;\r\n                        padding: 0;\r\n                        outline: none;\r\n                    }\r\n                    \r\n                    #custom-system-creator input[type=\"range\"]::-webkit-slider-thumb {\r\n                        -webkit-appearance: none;\r\n                        width: 30px;\r\n                        height: 30px;\r\n                        border-radius: 50%;\r\n                        background: #4a9dff;\r\n                        cursor: pointer;\r\n                    }\r\n                    \r\n                    #custom-system-creator input[type=\"range\"]::-moz-range-thumb {\r\n                        width: 30px;\r\n                        height: 30px;\r\n                        border-radius: 50%;\r\n                        background: #4a9dff;\r\n                        cursor: pointer;\r\n                        border: none;\r\n                    }\r\n                    \r\n                    /* Touch ripple effect for buttons */\r\n                    .ripple {\r\n                        position: relative;\r\n                        overflow: hidden;\r\n                        transform: translate3d(0, 0, 0);\r\n                    }\r\n                    \r\n                    .ripple:after {\r\n                        content: \"\";\r\n                        display: block;\r\n                        position: absolute;\r\n                        width: 100%;\r\n                        height: 100%;\r\n                        top: 0;\r\n                        left: 0;\r\n                        pointer-events: none;\r\n                        background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);\r\n                        background-repeat: no-repeat;\r\n                        background-position: 50%;\r\n                        transform: scale(10, 10);\r\n                        opacity: 0;\r\n                        transition: transform .5s, opacity 1s;\r\n                    }\r\n                    \r\n                    .ripple:active:after {\r\n                        transform: scale(0, 0);\r\n                        opacity: .3;\r\n                        transition: 0s;\r\n                    }\r\n                    \r\n                    /* Character counter for text areas */\r\n                    .char-counter {\r\n                        font-size: 12px;\r\n                        color: #aaa;\r\n                        text-align: right;\r\n                        margin-top: 5px;\r\n                    }\r\n                    \r\n                    .char-counter.warning {\r\n                        color: #ff9900;\r\n                    }\r\n                    \r\n                    .char-counter.error {\r\n                        color: #ff3030;\r\n                    }\r\n                }\r\n            `;\r\n            document.head.appendChild(style);\r\n        }\r\n        \r\n        // Add ripple effect to all buttons\r\n        this.addRippleEffect();\r\n        \r\n        // Add character counters to textareas\r\n        this.addCharacterCounters();\r\n    }\r\n    \r\n    // Add ripple effect to buttons for better touch feedback\r\n    addRippleEffect() {\r\n        if (!this.isMobile) return;\r\n        \r\n        const buttons = this.container.querySelectorAll('button');\r\n        buttons.forEach(button => {\r\n            if (!button.classList.contains('ripple')) {\r\n                button.classList.add('ripple');\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Add character counters to textareas\r\n    addCharacterCounters() {\r\n        if (!this.isMobile) return;\r\n        \r\n        // Skybox description\r\n        this.addCharacterCounter(this.skyboxDescription, 250);\r\n        \r\n        // Add counter to first planet and set up event listener for future planets\r\n        const firstPlanetDesc = document.getElementById('planet-description-1');\r\n        if (firstPlanetDesc) {\r\n            this.addCharacterCounter(firstPlanetDesc, 150);\r\n        }\r\n    }\r\n    \r\n    // Helper function to add character counter to a text area\r\n    addCharacterCounter(textarea, maxChars) {\r\n        if (!textarea) return;\r\n        \r\n        // Create counter element\r\n        const counter = document.createElement('div');\r\n        counter.className = 'char-counter';\r\n        \r\n        // Update counter text\r\n        const updateCounter = () => {\r\n            const remaining = maxChars - textarea.value.length;\r\n            counter.textContent = `${remaining} characters remaining`;\r\n            \r\n            // Change color based on remaining characters\r\n            counter.className = 'char-counter';\r\n            if (remaining < 30) {\r\n                counter.classList.add('warning');\r\n            }\r\n            if (remaining < 10) {\r\n                counter.classList.add('error');\r\n            }\r\n            \r\n            // Enforce character limit\r\n            if (remaining < 0) {\r\n                textarea.value = textarea.value.substring(0, maxChars);\r\n                counter.textContent = \"0 characters remaining\";\r\n            }\r\n        };\r\n        \r\n        // Add event listeners\r\n        textarea.addEventListener('input', updateCounter);\r\n        textarea.addEventListener('keydown', (e) => {\r\n            // Allow deletion even at max characters\r\n            if (textarea.value.length >= maxChars && \r\n                e.key !== 'Backspace' && \r\n                e.key !== 'Delete' && \r\n                e.key !== 'ArrowLeft' && \r\n                e.key !== 'ArrowRight' &&\r\n                !e.ctrlKey && \r\n                !e.metaKey) {\r\n                e.preventDefault();\r\n            }\r\n        });\r\n        \r\n        // Set initial counter\r\n        updateCounter();\r\n        \r\n        // Add counter after textarea\r\n        textarea.parentNode.insertBefore(counter, textarea.nextSibling);\r\n        \r\n        // Set maxlength attribute (fallback)\r\n        textarea.setAttribute('maxlength', maxChars.toString());\r\n    }\r\n    \r\n    setupEventHandlers() {\r\n        // Close button\r\n        const closeBtn = document.getElementById('close-system-creator');\r\n        closeBtn.addEventListener('click', () => {\r\n            this.hide();\r\n            this.playUISound();\r\n        });\r\n        \r\n        // For mobile, add touch event listener with sound\r\n        if (this.isMobile) {\r\n            closeBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                this.hide();\r\n                this.playUISound();\r\n            });\r\n            \r\n            // Ensure scrolling works by fixing container event handling\r\n            this.container.addEventListener('touchmove', (e) => {\r\n                // Allow default touchmove behavior (scrolling)\r\n                e.stopPropagation();\r\n            }, { passive: true });\r\n            \r\n            // Improve scroll performance\r\n            const modalContent = this.container.querySelector('.modal-content');\r\n            if (modalContent) {\r\n                modalContent.addEventListener('touchstart', () => {}, { passive: true });\r\n                modalContent.addEventListener('touchmove', () => {}, { passive: true });\r\n            }\r\n        }\r\n        \r\n        // Add Planet button\r\n        this.addPlanetBtn.addEventListener('click', () => {\r\n            this.addPlanetInput();\r\n            this.playUISound();\r\n        });\r\n        \r\n        if (this.isMobile) {\r\n            this.addPlanetBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                this.addPlanetInput();\r\n                this.playUISound();\r\n            });\r\n        }\r\n        \r\n        // Generate System button\r\n        this.generateSystemBtn.addEventListener('click', () => {\r\n            this.generateSystem();\r\n            this.playUISound();\r\n        });\r\n        \r\n        if (this.isMobile) {\r\n            this.generateSystemBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                this.generateSystem();\r\n                this.playUISound();\r\n            });\r\n        }\r\n        \r\n        // Travel to System button\r\n        this.travelToSystemBtn.addEventListener('click', () => {\r\n            this.travelToSystem();\r\n            this.playUISound();\r\n        });\r\n        \r\n        if (this.isMobile) {\r\n            this.travelToSystemBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                this.travelToSystem();\r\n                this.playUISound();\r\n            });\r\n        }\r\n        \r\n        // Regenerate button\r\n        this.regenerateSystemBtn.addEventListener('click', () => {\r\n            this.systemPreview.style.display = 'none';\r\n            this.systemForm.style.display = 'block';\r\n            this.playUISound();\r\n        });\r\n        \r\n        if (this.isMobile) {\r\n            this.regenerateSystemBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                this.systemPreview.style.display = 'none';\r\n                this.systemForm.style.display = 'block';\r\n                this.playUISound();\r\n            });\r\n        }\r\n        \r\n        // ESC key to close\r\n        document.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Escape' && this.isVisible) {\r\n                this.hide();\r\n            }\r\n        });\r\n        \r\n        // Click outside to close\r\n        this.container.addEventListener('click', (e) => {\r\n            if (e.target === this.container) {\r\n                this.hide();\r\n            }\r\n        });\r\n        \r\n        // Handle mobile touch start on container to properly manage touch events\r\n        if (this.isMobile) {\r\n            this.container.addEventListener('touchstart', (e) => {\r\n                // Only close if the touch is directly on the container background\r\n                if (e.target === this.container) {\r\n                    e.preventDefault();\r\n                    this.hide();\r\n                }\r\n            }, { passive: false });\r\n        }\r\n    }\r\n    \r\n    addPlanetInput() {\r\n        const planetInputs = this.planetDescriptions.getElementsByClassName('planet-input');\r\n        const newIndex = planetInputs.length + 1;\r\n        \r\n        const planetDiv = document.createElement('div');\r\n        planetDiv.className = 'form-group planet-input';\r\n        planetDiv.innerHTML = `\r\n            <h3>Planet ${newIndex}</h3>\r\n            <label for=\"planet-name-${newIndex}\">Planet Name:</label>\r\n            <input type=\"text\" id=\"planet-name-${newIndex}\" placeholder=\"Enter a name for this planet\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px; height: 48px;' : ''}\">\r\n            \r\n            <label for=\"planet-description-${newIndex}\">Planet Description:</label>\r\n            <textarea id=\"planet-description-${newIndex}\" rows=\"${this.isMobile ? '2' : '3'}\" placeholder=\"Describe the planet (e.g., 'A rocky planet with large oceans and ice caps')\" style=\"${this.isMobile ? 'font-size: 16px; padding: 14px;' : ''}\" maxlength=\"150\"></textarea>\r\n            \r\n            <div class=\"planet-properties\">\r\n                <div class=\"property-row\">\r\n                    <label for=\"planet-size-${newIndex}\">Size:</label>\r\n                    <input type=\"range\" id=\"planet-size-${newIndex}\" min=\"300\" max=\"1000\" value=\"450\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                    <span class=\"slider-value\" id=\"planet-size-value-${newIndex}\">450</span>\r\n                </div>\r\n                \r\n                <div class=\"property-row\">\r\n                    <label for=\"planet-distance-${newIndex}\">Distance from Star:</label>\r\n                    <input type=\"range\" id=\"planet-distance-${newIndex}\" min=\"4000\" max=\"60000\" value=\"${4000 + newIndex * 6000}\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                    <span class=\"slider-value\" id=\"planet-distance-value-${newIndex}\">${4000 + newIndex * 6000}</span>\r\n                </div>\r\n                \r\n                <div class=\"property-row\">\r\n                    <label for=\"planet-speed-${newIndex}\">Orbit Speed:</label>\r\n                    <input type=\"range\" id=\"planet-speed-${newIndex}\" min=\"1\" max=\"10\" value=\"5\" class=\"slider\" style=\"${this.isMobile ? 'height: 30px; margin: 10px 0;' : ''}\">\r\n                    <span class=\"slider-value\" id=\"planet-speed-value-${newIndex}\">0.0015</span>\r\n                </div>\r\n                \r\n                <div class=\"property-row\" style=\"${this.isMobile ? 'margin-top: 15px;' : ''}\">\r\n                    <label for=\"planet-rings-${newIndex}\">Has Rings:</label>\r\n                    <input type=\"checkbox\" id=\"planet-rings-${newIndex}\" style=\"${this.isMobile ? 'transform: scale(1.7); margin: 0 15px; min-height: 24px; min-width: 24px;' : ''}\">\r\n                </div>\r\n            </div>\r\n            \r\n            <button class=\"remove-planet-btn danger-btn ${this.isMobile ? 'ripple' : ''}\" style=\"${this.isMobile ? 'min-height: 50px; padding: 14px; font-size: 16px; right: 15px; top: 15px;' : ''}\">Remove</button>\r\n        `;\r\n        \r\n        this.planetDescriptions.appendChild(planetDiv);\r\n        \r\n        // Set up event listeners for the sliders\r\n        this.setupSliderListeners(newIndex);\r\n        \r\n        // Add event listener to remove button\r\n        const removeBtn = planetDiv.querySelector('.remove-planet-btn');\r\n        removeBtn.addEventListener('click', () => {\r\n            planetDiv.remove();\r\n            this.updatePlanetNumbers();\r\n            this.playUISound();\r\n        });\r\n        \r\n        // Add touch-specific event handlers for mobile\r\n        if (this.isMobile) {\r\n            removeBtn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                planetDiv.remove();\r\n                this.updatePlanetNumbers();\r\n                this.playUISound();\r\n            });\r\n            \r\n            // Also add touch events to sliders for better mobile interaction\r\n            const sliders = planetDiv.querySelectorAll('input[type=\"range\"]');\r\n            sliders.forEach(slider => {\r\n                slider.addEventListener('touchstart', () => {\r\n                    // Add active class for visual feedback\r\n                    slider.classList.add('slider-active');\r\n                });\r\n                \r\n                slider.addEventListener('touchend', () => {\r\n                    // Remove active class when touch ends\r\n                    slider.classList.remove('slider-active');\r\n                });\r\n            });\r\n            \r\n            // Add character counter to the new planet's description\r\n            const planetDesc = planetDiv.querySelector(`textarea[id^=\"planet-description-\"]`);\r\n            if (planetDesc) {\r\n                this.addCharacterCounter(planetDesc, 150);\r\n            }\r\n        }\r\n        \r\n        // If on mobile, scroll to the new planet section with improved handling\r\n        if (this.isMobile) {\r\n            // Clear any existing scroll timeout\r\n            if (this.scrollTimeout) {\r\n                clearTimeout(this.scrollTimeout);\r\n            }\r\n            \r\n            // Use a safer scrolling approach that won't freeze the UI\r\n            this.scrollTimeout = setTimeout(() => {\r\n                try {\r\n                    const modalContent = this.container.querySelector('.modal-content');\r\n                    const newPlanet = this.planetDescriptions.lastElementChild;\r\n                    \r\n                    if (modalContent && newPlanet) {\r\n                        // Calculate scroll position\r\n                        const planetPos = newPlanet.offsetTop;\r\n                        const scrollPos = planetPos - (modalContent.clientHeight / 4);\r\n                        \r\n                        // Use manual scrolling instead of scrollIntoView for better control\r\n                        modalContent.scrollTo({\r\n                            top: scrollPos,\r\n                            behavior: 'smooth'\r\n                        });\r\n                    }\r\n                } catch (err) {\r\n                    console.warn(\"Error during scroll:\", err);\r\n                }\r\n            }, 100);\r\n        }\r\n    }\r\n    \r\n    setupSliderListeners(index) {\r\n        // Size slider\r\n        const sizeSlider = document.getElementById(`planet-size-${index}`);\r\n        const sizeValue = document.getElementById(`planet-size-value-${index}`);\r\n        \r\n        sizeSlider.addEventListener('input', () => {\r\n            sizeValue.textContent = sizeSlider.value;\r\n        });\r\n        \r\n        // Distance slider\r\n        const distanceSlider = document.getElementById(`planet-distance-${index}`);\r\n        const distanceValue = document.getElementById(`planet-distance-value-${index}`);\r\n        \r\n        distanceSlider.addEventListener('input', () => {\r\n            distanceValue.textContent = distanceSlider.value;\r\n        });\r\n        \r\n        // Speed slider\r\n        const speedSlider = document.getElementById(`planet-speed-${index}`);\r\n        const speedValue = document.getElementById(`planet-speed-value-${index}`);\r\n        \r\n        speedSlider.addEventListener('input', () => {\r\n            // Convert 1-10 range to 0.001-0.002 range\r\n            const speed = 0.001 + (speedSlider.value - 1) * (0.001 / 9);\r\n            speedValue.textContent = speed.toFixed(4);\r\n        });\r\n        \r\n        // For mobile, add visual feedback\r\n        if (this.isMobile) {\r\n            const sliders = [sizeSlider, distanceSlider, speedSlider];\r\n            sliders.forEach(slider => {\r\n                slider.addEventListener('touchstart', () => {\r\n                    // Add active class for visual feedback\r\n                    slider.classList.add('slider-active');\r\n                });\r\n                \r\n                slider.addEventListener('touchend', () => {\r\n                    // Remove active class when touch ends\r\n                    slider.classList.remove('slider-active');\r\n                });\r\n            });\r\n        }\r\n    }\r\n    \r\n    updatePlanetNumbers() {\r\n        const planetInputs = this.planetDescriptions.getElementsByClassName('planet-input');\r\n        for (let i = 0; i < planetInputs.length; i++) {\r\n            const planetDiv = planetInputs[i];\r\n            const planetHeader = planetDiv.querySelector('h3');\r\n            planetHeader.textContent = `Planet ${i + 1}`;\r\n        }\r\n    }\r\n    \r\n    async generateSystem() {\r\n        // Validate inputs\r\n        const systemName = this.systemNameInput.value.trim();\r\n        const skyboxDesc = this.skyboxDescription.value.trim();\r\n        const starClass = document.getElementById('star-class').value;\r\n        \r\n        if (!systemName || !skyboxDesc) {\r\n            this.showMobileAlert('Please enter a system name and skybox description.');\r\n            return;\r\n        }\r\n        \r\n        // Show progress UI\r\n        this.systemForm.style.display = 'none';\r\n        this.generationProgress.style.display = 'block';\r\n        this.isGenerating = true;\r\n        \r\n        try {\r\n            // Check for auth token or get one\r\n            if (!this.apiClient.hasValidToken()) {\r\n                this.updateGenerationStatus('Authenticating...');\r\n                await this.apiClient.getToken();\r\n            }\r\n            \r\n            // Generate skybox\r\n            this.updateGenerationStatus('Generating skybox...');\r\n            const skyboxResponse = await this.apiClient.generateSkybox(systemName, skyboxDesc);\r\n            \r\n            if (!skyboxResponse.success) {\r\n                throw new Error(skyboxResponse.message || 'Failed to generate skybox');\r\n            }\r\n            \r\n            if (!skyboxResponse.image_paths || skyboxResponse.image_paths.length === 0) {\r\n                throw new Error('No skybox images were generated');\r\n            }\r\n            \r\n            this.generatedSkyboxUrl = skyboxResponse.image_paths[0];\r\n            \r\n            // Collect planet data\r\n            const planets = [];\r\n            const planetInputs = this.planetDescriptions.getElementsByClassName('planet-input');\r\n            \r\n            for (let i = 0; i < planetInputs.length; i++) {\r\n                const planetDiv = planetInputs[i];\r\n                const planetIndex = i + 1;\r\n                \r\n                const nameInput = planetDiv.querySelector(`input[id^=\"planet-name-\"]`);\r\n                const descInput = planetDiv.querySelector(`textarea[id^=\"planet-description-\"]`);\r\n                const sizeInput = planetDiv.querySelector(`input[id^=\"planet-size-\"]`);\r\n                const distanceInput = planetDiv.querySelector(`input[id^=\"planet-distance-\"]`);\r\n                const speedInput = planetDiv.querySelector(`input[id^=\"planet-speed-\"]`);\r\n                const ringsInput = planetDiv.querySelector(`input[id^=\"planet-rings-\"]`);\r\n                \r\n                const planetName = nameInput.value.trim();\r\n                const planetDesc = descInput.value.trim();\r\n                \r\n                if (planetName && planetDesc) {\r\n                    // Calculate speed from slider (1-10 to 0.001-0.002)\r\n                    const speedValue = parseFloat(speedInput.value);\r\n                    const orbitSpeed = 0.001 + (speedValue - 1) * (0.001 / 9);\r\n                    \r\n                    planets.push({ \r\n                        name: planetName, \r\n                        description: planetDesc,\r\n                        size: parseInt(sizeInput.value),\r\n                        distance: parseInt(distanceInput.value),\r\n                        speed: orbitSpeed,\r\n                        rings: ringsInput.checked\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // Generate planets\r\n            this.generatedPlanetUrls = [];\r\n            for (let i = 0; i < planets.length; i++) {\r\n                const planet = planets[i];\r\n                this.updateGenerationStatus(`Generating planet ${i+1} of ${planets.length}: ${planet.name}...`);\r\n                \r\n                const planetResponse = await this.apiClient.generatePlanet(planet.name, planet.description);\r\n                \r\n                if (planetResponse.success && planetResponse.image_paths && planetResponse.image_paths.length > 0) {\r\n                    this.generatedPlanetUrls.push({\r\n                        name: planet.name,\r\n                        url: planetResponse.image_paths[0]\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // Create system data\r\n            this.systemData = {\r\n                id: `Custom-${Date.now()}`,\r\n                name: systemName,\r\n                starClass: starClass,\r\n                classification: 'Custom',\r\n                description: `Custom star system with ${planets.length} planets`,\r\n                skyboxUrl: this.generatedSkyboxUrl,\r\n                // Add light intensity multiplier to reduce brightness by 20%\r\n                lightIntensityMultiplier: 0.8,\r\n                planetData: planets.map((planet, i) => {\r\n                    return {\r\n                        name: planet.name,\r\n                        textureUrl: this.generatedPlanetUrls[i]?.url || null,\r\n                        // Use the custom planet properties\r\n                        size: planet.size,\r\n                        distance: planet.distance,\r\n                        speed: planet.speed,\r\n                        color: this.getStarColorForClass(starClass),\r\n                        rings: planet.rings\r\n                    };\r\n                })\r\n            };\r\n            \r\n            // Show preview\r\n            this.showSystemPreview();\r\n            \r\n        } catch (error) {\r\n            console.error('Error generating system:', error);\r\n            this.showMobileAlert(`Failed to generate system: ${error.message}`);\r\n            this.generationProgress.style.display = 'none';\r\n            this.systemForm.style.display = 'block';\r\n        }\r\n        \r\n        this.isGenerating = false;\r\n    }\r\n    \r\n    showSystemPreview() {\r\n        // Update skybox preview\r\n        if (this.generatedSkyboxUrl) {\r\n            this.skyboxPreviewImg.src = this.apiClient.getFullImageUrl(this.generatedSkyboxUrl);\r\n        }\r\n        \r\n        // Update planet previews\r\n        this.planetsPreview.innerHTML = '';\r\n        this.generatedPlanetUrls.forEach(planet => {\r\n            const planetDiv = document.createElement('div');\r\n            planetDiv.className = 'planet-preview';\r\n            planetDiv.innerHTML = `\r\n                <h4>${planet.name}</h4>\r\n                <img src=\"${this.apiClient.getFullImageUrl(planet.url)}\" alt=\"${planet.name}\">\r\n            `;\r\n            this.planetsPreview.appendChild(planetDiv);\r\n        });\r\n        \r\n        // Show preview UI\r\n        this.generationProgress.style.display = 'none';\r\n        this.systemPreview.style.display = 'block';\r\n        \r\n        // If on mobile, scroll to top of preview\r\n        if (this.isMobile) {\r\n            setTimeout(() => {\r\n                this.systemPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n            }, 50);\r\n        }\r\n    }\r\n    \r\n    travelToSystem() {\r\n        if (!this.systemData) {\r\n            this.showMobileAlert('No system data available. Please generate a system first.');\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            // Add the custom system to the star system generator\r\n            const success = this.starSystemGenerator.addCustomSystem(this.systemData);\r\n            \r\n            if (!success) {\r\n                throw new Error('Failed to add custom system');\r\n            }\r\n            \r\n            // Hide UI\r\n            this.hide();\r\n            \r\n            // Travel to the new system\r\n            if (this.environment && this.environment.travelToSystem) {\r\n                this.environment.travelToSystem(this.systemData.id);\r\n            } else {\r\n                console.error('Environment or travelToSystem method not available');\r\n            }\r\n            \r\n        } catch (error) {\r\n            console.error('Error traveling to custom system:', error);\r\n            this.showMobileAlert(`Failed to travel to custom system: ${error.message}`);\r\n        }\r\n    }\r\n    \r\n    updateGenerationStatus(message) {\r\n        if (this.generationStatus) {\r\n            this.generationStatus.textContent = message;\r\n            console.log('Generation status:', message);\r\n        }\r\n    }\r\n    \r\n    getStarColorForClass(starClass) {\r\n        // Star colors based on spectral classification\r\n        const colors = {\r\n            'O': 0x9bb0ff, // Blue\r\n            'B': 0xaabfff, // Blue-white\r\n            'A': 0xcad7ff, // White\r\n            'F': 0xf8f7ff, // Yellow-white\r\n            'G': 0xfff4ea, // Yellow (like our sun)\r\n            'K': 0xffd2a1, // Orange\r\n            'M': 0xffcc6f  // Red\r\n        };\r\n        \r\n        return colors[starClass] || 0xfff4ea; // Default to G-class if undefined\r\n    }\r\n    \r\n    // Mobile-friendly alert that doesn't block UI thread\r\n    showMobileAlert(message) {\r\n        if (this.isMobile) {\r\n            // Create a custom alert overlay for mobile\r\n            const alertOverlay = document.createElement('div');\r\n            alertOverlay.style.position = 'fixed';\r\n            alertOverlay.style.top = '0';\r\n            alertOverlay.style.left = '0';\r\n            alertOverlay.style.width = '100%';\r\n            alertOverlay.style.height = '100%';\r\n            alertOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';\r\n            alertOverlay.style.display = 'flex';\r\n            alertOverlay.style.justifyContent = 'center';\r\n            alertOverlay.style.alignItems = 'center';\r\n            alertOverlay.style.zIndex = '10000';\r\n            \r\n            const alertBox = document.createElement('div');\r\n            alertBox.style.backgroundColor = '#0a1a2a';\r\n            alertBox.style.color = '#c5d8f1';\r\n            alertBox.style.padding = '20px';\r\n            alertBox.style.borderRadius = '10px';\r\n            alertBox.style.maxWidth = '80%';\r\n            alertBox.style.textAlign = 'center';\r\n            alertBox.style.border = '2px solid #2c5a8c';\r\n            \r\n            const messageEl = document.createElement('p');\r\n            messageEl.textContent = message;\r\n            messageEl.style.marginBottom = '20px';\r\n            messageEl.style.fontSize = '16px';\r\n            \r\n            const okButton = document.createElement('button');\r\n            okButton.textContent = 'OK';\r\n            okButton.style.padding = '12px 30px';\r\n            okButton.style.fontSize = '16px';\r\n            okButton.style.backgroundColor = '#2c5a8c';\r\n            okButton.style.color = 'white';\r\n            okButton.style.border = 'none';\r\n            okButton.style.borderRadius = '5px';\r\n            okButton.style.minHeight = '48px';\r\n            okButton.style.minWidth = '120px';\r\n            \r\n            alertBox.appendChild(messageEl);\r\n            alertBox.appendChild(okButton);\r\n            alertOverlay.appendChild(alertBox);\r\n            document.body.appendChild(alertOverlay);\r\n            \r\n            // Play sound if available\r\n            this.playUISound();\r\n            \r\n            // Handle button click and touch\r\n            okButton.addEventListener('click', () => {\r\n                document.body.removeChild(alertOverlay);\r\n            });\r\n            \r\n            okButton.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                document.body.removeChild(alertOverlay);\r\n                this.playUISound();\r\n            });\r\n            \r\n        } else {\r\n            // Fall back to regular alert for desktop\r\n            alert(message);\r\n        }\r\n    }\r\n    \r\n    playUISound() {\r\n        // Play UI sound if audio is available\r\n        if (window.game && window.game.audio) {\r\n            window.game.audio.playSound('boink');\r\n        }\r\n    }\r\n    \r\n    show() {\r\n        if (this.container) {\r\n            // Reset any previous state\r\n            this.cleanupBeforeHiding();\r\n            \r\n            this.container.style.display = 'flex';\r\n            this.isVisible = true;\r\n            \r\n            // Reset UI state\r\n            this.systemForm.style.display = 'block';\r\n            this.generationProgress.style.display = 'none';\r\n            this.systemPreview.style.display = 'none';\r\n            \r\n            // Play sound if available\r\n            this.playUISound();\r\n            \r\n            // For mobile, ensure scrolling works properly\r\n            if (this.isMobile) {\r\n                // Enable proper scrolling\r\n                const modalContent = this.container.querySelector('.modal-content');\r\n                if (modalContent) {\r\n                    // Reset scroll position to top\r\n                    modalContent.scrollTop = 0;\r\n                    \r\n                    // Ensure overflow settings are correct\r\n                    modalContent.style.overflowY = 'auto';\r\n                    modalContent.style.webkitOverflowScrolling = 'touch';\r\n                    modalContent.style.overscrollBehavior = 'contain';\r\n                }\r\n                \r\n                // Add body class to prevent background scrolling\r\n                document.body.classList.add('modal-open');\r\n                \r\n                // Delayed focus to avoid iOS keyboard issues\r\n                this.scrollTimeout = setTimeout(() => {\r\n                    if (this.systemNameInput) {\r\n                        this.systemNameInput.focus();\r\n                    }\r\n                }, 300);\r\n            } else {\r\n                // Focus on system name input\r\n                setTimeout(() => {\r\n                    if (this.systemNameInput) {\r\n                        this.systemNameInput.focus();\r\n                    }\r\n                }, 300);\r\n            }\r\n            \r\n            // Add CSS for the modal-open class if it doesn't exist\r\n            if (!document.getElementById('modal-open-style') && this.isMobile) {\r\n                const style = document.createElement('style');\r\n                style.id = 'modal-open-style';\r\n                style.textContent = `\r\n                    .modal-open {\r\n                        overflow: hidden;\r\n                        position: fixed;\r\n                        width: 100%;\r\n                        height: 100%;\r\n                    }\r\n                `;\r\n                document.head.appendChild(style);\r\n            }\r\n            \r\n            // Restore custom styles which were removed in previous edit\r\n            if (!document.getElementById('custom-system-creator-styles')) {\r\n                const style = document.createElement('style');\r\n                style.id = 'custom-system-creator-styles';\r\n                style.textContent = `\r\n                    .property-row {\r\n                        display: flex;\r\n                        align-items: center;\r\n                        margin-bottom: 10px;\r\n                    }\r\n                    \r\n                    .property-row label {\r\n                        flex: 0 0 150px;\r\n                        margin-right: 10px;\r\n                    }\r\n                    \r\n                    .property-row .slider {\r\n                        flex: 1;\r\n                        height: 10px;\r\n                        background: #2a2a2a;\r\n                        outline: none;\r\n                        border-radius: 5px;\r\n                    }\r\n                    \r\n                    .property-row .slider-value {\r\n                        flex: 0 0 60px;\r\n                        margin-left: 10px;\r\n                        text-align: right;\r\n                    }\r\n                    \r\n                    .planet-properties {\r\n                        background: rgba(0, 0, 0, 0.2);\r\n                        padding: 15px;\r\n                        border-radius: 5px;\r\n                        margin-top: 10px;\r\n                        margin-bottom: 15px;\r\n                    }\r\n                    \r\n                    .help-text {\r\n                        font-size: 12px;\r\n                        color: #aaa;\r\n                        margin-top: 5px;\r\n                    }\r\n                    \r\n                    select.form-control {\r\n                        width: 100%;\r\n                        padding: 8px;\r\n                        border-radius: 4px;\r\n                        background: #25303e;\r\n                        color: white;\r\n                        border: 1px solid #3a5472;\r\n                    }\r\n                    \r\n                    /* Active slider styles */\r\n                    .slider-active {\r\n                        background: #3a5472 !important;\r\n                    }\r\n                    \r\n                    /* Add smooth transitions */\r\n                    #custom-system-creator button {\r\n                        transition: all 0.2s ease;\r\n                    }\r\n                    \r\n                    #custom-system-creator button:active {\r\n                        transform: scale(0.95);\r\n                    }\r\n                `;\r\n                document.head.appendChild(style);\r\n            }\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        if (this.container && !this.isGenerating) {\r\n            // Stop any ongoing processes\r\n            this.cleanupBeforeHiding();\r\n            \r\n            this.container.style.display = 'none';\r\n            this.isVisible = false;\r\n            \r\n            // Play sound if available\r\n            this.playUISound();\r\n            \r\n            // Show the stargate UI when closing the custom system creator\r\n            // Similar to how StarMap does it\r\n            setTimeout(() => {\r\n                if (window.game && window.game.ui && window.game.ui.stargateInterface) {\r\n                    console.log(\"CustomSystemCreator: Returning to stargate UI\");\r\n                    window.game.ui.stargateInterface.showStargateUI();\r\n                } else {\r\n                    // Direct DOM access as last resort\r\n                    const stargateUI = document.getElementById('stargate-ui');\r\n                    if (stargateUI) {\r\n                        stargateUI.style.display = 'block';\r\n                        console.log(\"CustomSystemCreator: Showed stargate UI via direct DOM access\");\r\n                    } else {\r\n                        console.warn(\"CustomSystemCreator: Could not find stargate UI to return to\");\r\n                    }\r\n                }\r\n            }, 100); // Short delay to ensure state is settled\r\n        }\r\n    }\r\n    \r\n    toggle() {\r\n        if (this.isVisible) {\r\n            this.hide();\r\n        } else {\r\n            this.show();\r\n        }\r\n    }\r\n    \r\n    // Add a new method to handle cleanup before hiding\r\n    cleanupBeforeHiding() {\r\n        // Reset form state if needed\r\n        if (this.isGenerating) {\r\n            this.isGenerating = false;\r\n            this.generationProgress.style.display = 'none';\r\n            this.systemForm.style.display = 'block';\r\n        }\r\n        \r\n        // Cancel any pending animations/scrolls\r\n        if (this.scrollTimeout) {\r\n            clearTimeout(this.scrollTimeout);\r\n            this.scrollTimeout = null;\r\n        }\r\n        \r\n        // Ensure we're not in transition state\r\n        document.body.style.pointerEvents = 'auto';\r\n        \r\n        // Force release any touch captures (helps with freezing issues)\r\n        if (this.isMobile) {\r\n            document.body.style.touchAction = 'auto';\r\n            \r\n            // Force redraw to clear any pending UI states\r\n            this.container.style.display = 'none';\r\n            void this.container.offsetHeight; // Force reflow\r\n        }\r\n    }\r\n    \r\n    // Add method to clean up when component is destroyed\r\n    destroy() {\r\n        // Clean up any event listeners or resources\r\n        this.cleanupBeforeHiding();\r\n        \r\n        // Remove modal-open class if it was added\r\n        document.body.classList.remove('modal-open');\r\n        \r\n        // Remove from DOM\r\n        if (this.container && this.container.parentNode) {\r\n            this.container.parentNode.removeChild(this.container);\r\n        }\r\n    }\r\n} ","// vibeVersePortals.js - Implements VibeVerse portal entrance and exit\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class VibeVersePortals {\r\n    constructor(scene, spaceship) {\r\n        this.scene = scene;\r\n        this.spaceship = spaceship;\r\n        this.startPortalGroup = null;\r\n        this.exitPortalGroup = null;\r\n        this.startPortalBox = null;\r\n        this.exitPortalBox = null;\r\n        this.startPortalParticleSystem = null;\r\n        this.exitPortalParticleSystem = null;\r\n        \r\n        // Check if we should create a start portal\r\n        this.shouldCreateStartPortal = new URLSearchParams(window.location.search).has('portal');\r\n        \r\n        // Get reference URL if it exists\r\n        this.refUrl = new URLSearchParams(window.location.search).get('ref') || '';\r\n        \r\n        // Initialize portals\r\n        this.init();\r\n    }\r\n    \r\n    init() {\r\n        // Create start portal if needed (based on URL parameter)\r\n        if (this.shouldCreateStartPortal) {\r\n            this.createStartPortal();\r\n        }\r\n        \r\n        // Exit portal removed - no longer creating it\r\n    }\r\n    \r\n    createStartPortal() {\r\n        // Create a portal group\r\n        this.startPortalGroup = new THREE.Group();\r\n        this.startPortalGroup.name = 'startPortal';\r\n        \r\n        // Create portal ring - INCREASED SIZE\r\n        const ringGeometry = new THREE.TorusGeometry(150, 15, 32, 100);\r\n        const ringMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0xff0000,\r\n            emissive: 0xff0000,\r\n            emissiveIntensity: 0.5,\r\n            roughness: 0.3,\r\n            metalness: 0.7\r\n        });\r\n        const ring = new THREE.Mesh(ringGeometry, ringMaterial);\r\n        this.startPortalGroup.add(ring);\r\n        \r\n        // Create portal surface (semi-transparent) - INCREASED SIZE\r\n        const surfaceGeometry = new THREE.CircleGeometry(135, 32);\r\n        const surfaceMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            side: THREE.DoubleSide\r\n        });\r\n        const surface = new THREE.Mesh(surfaceGeometry, surfaceMaterial);\r\n        surface.position.z = 0.1; // Slight offset to avoid z-fighting\r\n        this.startPortalGroup.add(surface);\r\n        \r\n        // Create particle system\r\n        const particleCount = 500;\r\n        const particleGeometry = new THREE.BufferGeometry();\r\n        const positions = new Float32Array(particleCount * 3);\r\n        \r\n        // Position particles in a ring pattern - ADJUSTED FOR LARGER SIZE\r\n        for (let i = 0; i < particleCount; i++) {\r\n            const angle = (i / particleCount) * Math.PI * 2;\r\n            const radius = 135 + (Math.random() * 30 - 15); // Random variation around the ring\r\n            \r\n            positions[i * 3] = Math.cos(angle) * radius;\r\n            positions[i * 3 + 1] = Math.sin(angle) * radius;\r\n            positions[i * 3 + 2] = (Math.random() - 0.5) * 15; // Small variation in z\r\n        }\r\n        \r\n        particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n        \r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0xff5555,\r\n            size: 3.5, // Increased particle size\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true\r\n        });\r\n        \r\n        this.startPortalParticleSystem = new THREE.Points(particleGeometry, particleMaterial);\r\n        this.startPortalGroup.add(this.startPortalParticleSystem);\r\n        \r\n        // Position the portal higher above the stargate and centered on y-axis\r\n        this.startPortalGroup.position.set(0, 15000, 0); // Centered above stargate\r\n        this.startPortalGroup.rotation.x = Math.PI / 2; // Face straight down\r\n        \r\n        // Add to scene\r\n        this.scene.add(this.startPortalGroup);\r\n        \r\n        // Create collision box\r\n        this.startPortalBox = new THREE.Box3().setFromObject(this.startPortalGroup);\r\n        \r\n        console.log(\"Start portal created at position:\", this.startPortalGroup.position);\r\n    }\r\n    \r\n    createExitPortal() {\r\n        // Create a portal group\r\n        this.exitPortalGroup = new THREE.Group();\r\n        this.exitPortalGroup.name = 'exitPortal';\r\n        \r\n        // Create portal ring - INCREASED SIZE\r\n        const ringGeometry = new THREE.TorusGeometry(150, 15, 32, 100);\r\n        const ringMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0x00ff00,\r\n            emissive: 0x00ff00,\r\n            emissiveIntensity: 0.5,\r\n            roughness: 0.3,\r\n            metalness: 0.7\r\n        });\r\n        const ring = new THREE.Mesh(ringGeometry, ringMaterial);\r\n        this.exitPortalGroup.add(ring);\r\n        \r\n        // Create portal surface (semi-transparent) - INCREASED SIZE\r\n        const surfaceGeometry = new THREE.CircleGeometry(135, 32);\r\n        const surfaceMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0x00ff00,\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            side: THREE.DoubleSide\r\n        });\r\n        const surface = new THREE.Mesh(surfaceGeometry, surfaceMaterial);\r\n        surface.position.z = 0.1; // Slight offset to avoid z-fighting\r\n        this.exitPortalGroup.add(surface);\r\n        \r\n        // Create particle system\r\n        const particleCount = 500;\r\n        const particleGeometry = new THREE.BufferGeometry();\r\n        const positions = new Float32Array(particleCount * 3);\r\n        \r\n        // Position particles in a ring pattern - ADJUSTED FOR LARGER SIZE\r\n        for (let i = 0; i < particleCount; i++) {\r\n            const angle = (i / particleCount) * Math.PI * 2;\r\n            const radius = 135 + (Math.random() * 30 - 15); // Random variation around the ring\r\n            \r\n            positions[i * 3] = Math.cos(angle) * radius;\r\n            positions[i * 3 + 1] = Math.sin(angle) * radius;\r\n            positions[i * 3 + 2] = (Math.random() - 0.5) * 15; // Small variation in z\r\n        }\r\n        \r\n        particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n        \r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0x55ff55,\r\n            size: 3.5, // Increased particle size\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true\r\n        });\r\n        \r\n        this.exitPortalParticleSystem = new THREE.Points(particleGeometry, particleMaterial);\r\n        this.exitPortalGroup.add(this.exitPortalParticleSystem);\r\n        \r\n        // Create text label for the portal - INCREASED SIZE\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = 1024; // Increased size\r\n        canvas.height = 256; // Increased size\r\n        const ctx = canvas.getContext('2d');\r\n        ctx.fillStyle = 'black';\r\n        ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n        ctx.font = '72px Arial'; // Increased font size\r\n        ctx.fillStyle = '#00ff00';\r\n        ctx.textAlign = 'center';\r\n        ctx.textBaseline = 'middle';\r\n        ctx.fillText('VIBEVERSE PORTAL', canvas.width / 2, canvas.height / 2);\r\n        \r\n        const texture = new THREE.CanvasTexture(canvas);\r\n        const labelGeometry = new THREE.PlaneGeometry(200, 50); // Increased size\r\n        const labelMaterial = new THREE.MeshBasicMaterial({\r\n            map: texture,\r\n            transparent: true,\r\n            side: THREE.DoubleSide\r\n        });\r\n        \r\n        const label = new THREE.Mesh(labelGeometry, labelMaterial);\r\n        label.position.set(0, 200, 0); // Position above the portal (increased)\r\n        this.exitPortalGroup.add(label);\r\n        \r\n        // Position the portal higher above the stargate and centered on y-axis\r\n        this.exitPortalGroup.position.set(0, 16000, 0); // Centered above stargate, bit higher than start portal\r\n        this.exitPortalGroup.rotation.x = Math.PI / 2; // Face straight down\r\n        \r\n        // Add to scene\r\n        this.scene.add(this.exitPortalGroup);\r\n        \r\n        // Create collision box\r\n        this.exitPortalBox = new THREE.Box3().setFromObject(this.exitPortalGroup);\r\n        \r\n        console.log(\"Exit portal created at position:\", this.exitPortalGroup.position);\r\n    }\r\n    \r\n    animateStartPortal(deltaTime) {\r\n        if (!this.startPortalGroup || !this.startPortalParticleSystem) return;\r\n        \r\n        // Rotate particle system\r\n        this.startPortalParticleSystem.rotation.z += deltaTime * 0.5;\r\n        \r\n        // Update collision box (only periodically to save performance)\r\n        if (Math.random() < 0.05) {\r\n            this.startPortalBox.setFromObject(this.startPortalGroup);\r\n        }\r\n    }\r\n    \r\n    animateExitPortal(deltaTime) {\r\n        if (!this.exitPortalGroup || !this.exitPortalParticleSystem) return;\r\n        \r\n        // Rotate particle system\r\n        this.exitPortalParticleSystem.rotation.z += deltaTime * 0.5;\r\n        \r\n        // Update collision box (only periodically to save performance)\r\n        if (Math.random() < 0.05) {\r\n            this.exitPortalBox.setFromObject(this.exitPortalGroup);\r\n        }\r\n    }\r\n    \r\n    checkPortalInteractions(deltaTime) {\r\n        if (!this.spaceship || !this.spaceship.mesh) return;\r\n        \r\n        // Create a box for the spaceship (used for collision detection)\r\n        const shipBox = new THREE.Box3().setFromObject(this.spaceship.mesh);\r\n        \r\n        // Check start portal interaction (if it exists)\r\n        if (this.startPortalGroup && this.startPortalBox) {\r\n            const distance = this.spaceship.mesh.position.distanceTo(this.startPortalGroup.position);\r\n            \r\n            // If player is close to the start portal - INCREASED DETECTION RANGE\r\n            if (distance < 400) { // Increased from 200 to match much larger portal size\r\n                // Check for collision\r\n                if (shipBox.intersectsBox(this.startPortalBox)) {\r\n                    this.handleStartPortalEntry();\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Exit portal interaction removed\r\n    }\r\n    \r\n    handleStartPortalEntry() {\r\n        // Prevent multiple redirects\r\n        if (this._isRedirecting) return;\r\n        this._isRedirecting = true;\r\n        \r\n        console.log(\"Player entered start portal\");\r\n        \r\n        // Get the reference URL from the query parameter\r\n        let targetUrl = this.refUrl;\r\n        \r\n        // Make sure the URL has the https:// prefix\r\n        if (targetUrl && !targetUrl.startsWith('http')) {\r\n            targetUrl = 'https://' + targetUrl;\r\n        }\r\n        \r\n        // If no target URL, do nothing\r\n        if (!targetUrl) {\r\n            console.error(\"No target URL specified for portal\");\r\n            this._isRedirecting = false;\r\n            return;\r\n        }\r\n        \r\n        // Parse current URL parameters (excluding 'ref')\r\n        const currentParams = new URLSearchParams(window.location.search);\r\n        currentParams.delete('ref');\r\n        currentParams.delete('portal');\r\n        \r\n        // Create a URL object for the target\r\n        let finalUrl;\r\n        try {\r\n            finalUrl = new URL(targetUrl);\r\n            \r\n            // Append any other current parameters to the target URL\r\n            for (const [key, value] of currentParams.entries()) {\r\n                finalUrl.searchParams.append(key, value);\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Invalid target URL:\", targetUrl);\r\n            this._isRedirecting = false;\r\n            return;\r\n        }\r\n        \r\n        console.log(\"Redirecting to:\", finalUrl.toString());\r\n        \r\n        // Short delay before redirecting\r\n        setTimeout(() => {\r\n            window.location.href = finalUrl.toString();\r\n        }, 100);\r\n    }\r\n    \r\n    handleExitPortalEntry() {\r\n        // Prevent multiple redirects\r\n        if (this._isRedirecting) return;\r\n        this._isRedirecting = true;\r\n        \r\n        console.log(\"Player entered exit portal\");\r\n        \r\n        // Construct next page URL\r\n        let nextPage = 'https://portal.pieter.com';\r\n        \r\n        // Get current parameters\r\n        const currentParams = new URLSearchParams(window.location.search);\r\n        \r\n        // Create URL object\r\n        const url = new URL(nextPage);\r\n        \r\n        // Add required parameters\r\n        url.searchParams.append('portal', 'true');\r\n        url.searchParams.append('username', this.getUsername());\r\n        url.searchParams.append('color', 'white'); // Default color\r\n        url.searchParams.append('speed', this.getPlayerSpeed());\r\n        \r\n        // Copy other parameters from current URL\r\n        for (const [key, value] of currentParams.entries()) {\r\n            if (!['portal', 'username', 'color', 'speed'].includes(key)) {\r\n                url.searchParams.append(key, value);\r\n            }\r\n        }\r\n        \r\n        console.log(\"Redirecting to:\", url.toString());\r\n        \r\n        // Short delay before redirecting\r\n        setTimeout(() => {\r\n            window.location.href = url.toString();\r\n        }, 100);\r\n    }\r\n    \r\n    getUsername() {\r\n        // Get username from game state if available\r\n        if (window.game && window.game.selfUsername) {\r\n            return window.game.selfUsername;\r\n        }\r\n        \r\n        // Fallback: generate a random username\r\n        return `Miner${Math.floor(Math.random() * 10000)}`;\r\n    }\r\n    \r\n    getPlayerSpeed() {\r\n        // Get current speed from game state if available\r\n        if (window.game && window.game.currentSpeed) {\r\n            return window.game.currentSpeed.toString();\r\n        }\r\n        \r\n        // Try to get speed from spaceship if available\r\n        if (this.spaceship && this.spaceship.velocity) {\r\n            return this.spaceship.velocity.length().toString();\r\n        }\r\n        \r\n        // Fallback: default speed\r\n        return '10';\r\n    }\r\n    \r\n    update(deltaTime) {\r\n        // Animate start portal only (if it exists)\r\n        this.animateStartPortal(deltaTime);\r\n        \r\n        // Check for portal interactions\r\n        this.checkPortalInteractions(deltaTime);\r\n    }\r\n    \r\n    dispose() {\r\n        // Clean up resources\r\n        if (this.startPortalGroup) {\r\n            this.scene.remove(this.startPortalGroup);\r\n        }\r\n        \r\n        if (this.exitPortalGroup) {\r\n            this.scene.remove(this.exitPortalGroup);\r\n        }\r\n        \r\n        // Clear references\r\n        this.startPortalGroup = null;\r\n        this.exitPortalGroup = null;\r\n        this.startPortalBox = null;\r\n        this.exitPortalBox = null;\r\n        this.startPortalParticleSystem = null;\r\n        this.exitPortalParticleSystem = null;\r\n    }\r\n} ","// spaceAnomalies.js - Creates and manages space anomalies with collectible energy orbs\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class SpaceAnomalies {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.anomalies = [];\r\n        \r\n        // Anomalies are outside the asteroid belt\r\n        this.minRadius = 32000; // Beyond asteroid belt\r\n        this.maxRadius = 45000; // Not too far into deep space\r\n        this.width = 3000; // Height variation\r\n        \r\n        // Scale factors for size\r\n        this.anomalyScale = 4; // Make anomalies 4x bigger\r\n        this.orbScale = 4;     // Make orbs 4x bigger\r\n        \r\n        // Orb rarity and values\r\n        this.orbValues = {\r\n            common: 100,    // Green orb - 100 credits\r\n            uncommon: 500,  // Blue orb - 500 credits\r\n            rare: 1500,     // Purple orb - 1500 credits\r\n            epic: 5000,     // Orange orb - 5000 credits\r\n            legendary: 15000 // Red orb - 15000 credits\r\n        };\r\n        \r\n        // Initialize timer system for dynamic anomaly spawning\r\n        this.spawnTimer = 0;\r\n        this.checkInterval = 60; // Check every 60 seconds (1 minute)\r\n        this.spawnChance = 0.5; // 50% chance to spawn a new anomaly\r\n        this.despawnChance = 0.3; // 30% chance for an anomaly to despawn\r\n        \r\n        // Available anomaly types\r\n        this.anomalyTypes = [\r\n            'vortex',\r\n            'crystalCluster',\r\n            'nebulaNexus',\r\n            'quantumFlux',\r\n            'darkMatter'\r\n        ];\r\n        \r\n        // Maximum number of anomalies that can exist simultaneously\r\n        this.maxAnomalies = 5;\r\n        \r\n        // Notify about active anomalies\r\n        this.updateAnomalyCountDisplay();\r\n    }\r\n\r\n    // --- Renderer facade helpers ---\r\n    _getRenderer() {\r\n        return (window.game && window.game.renderer) ? window.game.renderer : null;\r\n    }\r\n\r\n    _addToScene(object) {\r\n        const renderer = this._getRenderer();\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => renderer.add(object));\r\n        } else if (this.scene && typeof this.scene.add === 'function') {\r\n            this.scene.add(object);\r\n        }\r\n    }\r\n\r\n    _removeFromScene(object) {\r\n        const renderer = this._getRenderer();\r\n        if (!object) return;\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => this.scene.remove(object));\r\n        } else if (this.scene && typeof this.scene.remove === 'function') {\r\n            this.scene.remove(object);\r\n        }\r\n    }\r\n    \r\n    // Method to check and potentially spawn/despawn anomalies\r\n    checkAnomalySpawning(deltaTime) {\r\n        // Increment timer\r\n        this.spawnTimer += deltaTime;\r\n        \r\n        // Check if it's time to evaluate spawn/despawn\r\n        if (this.spawnTimer >= this.checkInterval) {\r\n            // Reset timer\r\n            this.spawnTimer -= this.checkInterval;\r\n            \r\n            // Check for potential new anomaly spawn\r\n            if (this.anomalies.length < this.maxAnomalies && Math.random() < this.spawnChance) {\r\n                // Determine which anomaly type to spawn\r\n                const availableTypes = this.anomalyTypes.filter(type => \r\n                    !this.anomalies.some(anomaly => anomaly.type === type)\r\n                );\r\n                \r\n                if (availableTypes.length > 0) {\r\n                    const typeToSpawn = availableTypes[Math.floor(Math.random() * availableTypes.length)];\r\n                    this.spawnAnomaly(typeToSpawn);\r\n                    \r\n                    // Update HUD with new count\r\n                    this.updateAnomalyCountDisplay();\r\n                }\r\n            }\r\n            \r\n            // Check each existing anomaly for potential despawn\r\n            const anomaliesToRemove = [];\r\n            this.anomalies.forEach(anomaly => {\r\n                if (Math.random() < this.despawnChance) {\r\n                    anomaliesToRemove.push(anomaly);\r\n                }\r\n            });\r\n            \r\n            // Remove marked anomalies\r\n            if (anomaliesToRemove.length > 0) {\r\n                anomaliesToRemove.forEach(anomaly => {\r\n                    this.despawnAnomaly(anomaly);\r\n                });\r\n                \r\n                // Update HUD with new count\r\n                this.updateAnomalyCountDisplay();\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Spawn a specific type of anomaly\r\n    spawnAnomaly(type) {\r\n        console.log(`Spawning ${type} anomaly`);\r\n        \r\n        switch(type) {\r\n            case 'vortex':\r\n                this.createVortexAnomaly();\r\n                break;\r\n            case 'crystalCluster':\r\n                this.createCrystalClusterAnomaly();\r\n                break;\r\n            case 'nebulaNexus':\r\n                this.createNebulaNexusAnomaly();\r\n                break;\r\n            case 'quantumFlux':\r\n                this.createQuantumFluxAnomaly();\r\n                break;\r\n            case 'darkMatter':\r\n                this.createDarkMatterAnomaly();\r\n                break;\r\n        }\r\n    }\r\n    \r\n    // Despawn and cleanup a specific anomaly\r\n    despawnAnomaly(anomaly) {\r\n        console.log(`Despawning ${anomaly.type} anomaly`);\r\n        \r\n        // Remove from scene\r\n        this._removeFromScene(anomaly.mesh);\r\n        \r\n        // Perform specific cleanup based on anomaly type\r\n        switch (anomaly.type) {\r\n            case 'vortex':\r\n                // Clean up rings\r\n                if (anomaly.rings) {\r\n                    anomaly.rings.forEach(ring => {\r\n                        if (ring.mesh && ring.mesh.geometry) {\r\n                            ring.mesh.geometry.dispose();\r\n                        }\r\n                        if (ring.mesh && ring.mesh.material) {\r\n                            if (Array.isArray(ring.mesh.material)) {\r\n                                ring.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                ring.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                break;\r\n                \r\n            case 'crystalCluster':\r\n                // Clean up crystals\r\n                if (anomaly.crystals) {\r\n                    anomaly.crystals.forEach(crystal => {\r\n                        if (crystal.mesh && crystal.mesh.geometry) {\r\n                            crystal.mesh.geometry.dispose();\r\n                        }\r\n                        if (crystal.mesh && crystal.mesh.material) {\r\n                            if (Array.isArray(crystal.mesh.material)) {\r\n                                crystal.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                crystal.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                break;\r\n                \r\n            case 'nebulaNexus':\r\n                // Clean up rings, core, and arcs\r\n                if (anomaly.rings) {\r\n                    anomaly.rings.forEach(ring => {\r\n                        if (ring.mesh && ring.mesh.geometry) {\r\n                            ring.mesh.geometry.dispose();\r\n                        }\r\n                        if (ring.mesh && ring.mesh.material) {\r\n                            if (Array.isArray(ring.mesh.material)) {\r\n                                ring.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                ring.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                if (anomaly.core && anomaly.core.mesh) {\r\n                    if (anomaly.core.mesh.geometry) anomaly.core.mesh.geometry.dispose();\r\n                    if (anomaly.core.mesh.material) {\r\n                        if (Array.isArray(anomaly.core.mesh.material)) {\r\n                            anomaly.core.mesh.material.forEach(m => m.dispose());\r\n                        } else {\r\n                            anomaly.core.mesh.material.dispose();\r\n                        }\r\n                    }\r\n                }\r\n                if (anomaly.arcs) {\r\n                    anomaly.arcs.forEach(arc => {\r\n                        if (arc.mesh && arc.mesh.geometry) {\r\n                            arc.mesh.geometry.dispose();\r\n                        }\r\n                        if (arc.mesh && arc.mesh.material) {\r\n                            if (Array.isArray(arc.mesh.material)) {\r\n                                arc.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                arc.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                break;\r\n                \r\n            case 'quantumFlux':\r\n                // Clean up frames and particles\r\n                if (anomaly.frames) {\r\n                    anomaly.frames.forEach(frame => {\r\n                        if (frame.mesh && frame.mesh.geometry) {\r\n                            frame.mesh.geometry.dispose();\r\n                        }\r\n                        if (frame.mesh && frame.mesh.material) {\r\n                            if (Array.isArray(frame.mesh.material)) {\r\n                                frame.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                frame.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                        if (frame.innerBox) {\r\n                            if (frame.innerBox.geometry) frame.innerBox.geometry.dispose();\r\n                            if (frame.innerBox.material) {\r\n                                if (Array.isArray(frame.innerBox.material)) {\r\n                                    frame.innerBox.material.forEach(m => m.dispose());\r\n                                } else {\r\n                                    frame.innerBox.material.dispose();\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                if (anomaly.particles && anomaly.particles.mesh) {\r\n                    if (anomaly.particles.mesh.geometry) anomaly.particles.mesh.geometry.dispose();\r\n                    if (anomaly.particles.mesh.material) {\r\n                        if (Array.isArray(anomaly.particles.mesh.material)) {\r\n                            anomaly.particles.mesh.material.forEach(m => m.dispose());\r\n                        } else {\r\n                            anomaly.particles.mesh.material.dispose();\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n                \r\n            case 'darkMatter':\r\n                // Clean up core, rings, and particles\r\n                if (anomaly.core && anomaly.core.mesh) {\r\n                    if (anomaly.core.mesh.geometry) anomaly.core.mesh.geometry.dispose();\r\n                    if (anomaly.core.mesh.material) {\r\n                        if (Array.isArray(anomaly.core.mesh.material)) {\r\n                            anomaly.core.mesh.material.forEach(m => m.dispose());\r\n                        } else {\r\n                            anomaly.core.mesh.material.dispose();\r\n                        }\r\n                    }\r\n                }\r\n                if (anomaly.rings) {\r\n                    anomaly.rings.forEach(ring => {\r\n                        if (ring.mesh && ring.mesh.geometry) {\r\n                            ring.mesh.geometry.dispose();\r\n                        }\r\n                        if (ring.mesh && ring.mesh.material) {\r\n                            if (Array.isArray(ring.mesh.material)) {\r\n                                ring.mesh.material.forEach(m => m.dispose());\r\n                            } else {\r\n                                ring.mesh.material.dispose();\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n                if (anomaly.particles && anomaly.particles.mesh) {\r\n                    if (anomaly.particles.mesh.geometry) anomaly.particles.mesh.geometry.dispose();\r\n                    if (anomaly.particles.mesh.material) {\r\n                        if (Array.isArray(anomaly.particles.mesh.material)) {\r\n                            anomaly.particles.mesh.material.forEach(m => m.dispose());\r\n                        } else {\r\n                            anomaly.particles.mesh.material.dispose();\r\n                        }\r\n                    }\r\n                }\r\n                break;\r\n        }\r\n        \r\n        // Clean up the orb\r\n        if (anomaly.orb && anomaly.orb.mesh) {\r\n            if (anomaly.orb.mesh.geometry) anomaly.orb.mesh.geometry.dispose();\r\n            if (anomaly.orb.mesh.material) {\r\n                if (Array.isArray(anomaly.orb.mesh.material)) {\r\n                    anomaly.orb.mesh.material.forEach(m => m.dispose());\r\n                } else {\r\n                    anomaly.orb.mesh.material.dispose();\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Remove from anomalies array\r\n        const index = this.anomalies.indexOf(anomaly);\r\n        if (index !== -1) {\r\n            this.anomalies.splice(index, 1);\r\n        }\r\n    }\r\n    \r\n    // Update HUD to show active anomaly count\r\n    updateAnomalyCountDisplay() {\r\n        // Find the anomaly count element in the HUD\r\n        const anomalyCountEl = document.getElementById('anomaly-count');\r\n        if (anomalyCountEl) {\r\n            anomalyCountEl.textContent = this.anomalies.length.toString();\r\n        }\r\n    }\r\n    \r\n    // Get the number of active anomalies\r\n    getActiveAnomalyCount() {\r\n        return this.anomalies.length;\r\n    }\r\n    \r\n    // Modified update method to include anomaly spawning/despawning checks\r\n    update(deltaTime) {\r\n        // Check for spawning/despawning anomalies\r\n        this.checkAnomalySpawning(deltaTime);\r\n        \r\n        // Get player position if available (from global reference)\r\n        let playerPosition = null;\r\n        if (window.game && window.game.spaceship && window.game.spaceship.mesh) {\r\n            playerPosition = window.game.spaceship.mesh.position;\r\n        }\r\n        \r\n        // Update existing anomalies\r\n        for (let i = 0; i < this.anomalies.length; i++) {\r\n            const anomaly = this.anomalies[i];\r\n            \r\n            // Skip if orb is already collected\r\n            if (anomaly.orbCollected) {\r\n                // Simple rotation for collected anomalies\r\n                if (anomaly.mesh && anomaly.rotationSpeed) {\r\n                    anomaly.mesh.rotation.x += anomaly.rotationSpeed.x * deltaTime;\r\n                    anomaly.mesh.rotation.y += anomaly.rotationSpeed.y * deltaTime;\r\n                    anomaly.mesh.rotation.z += anomaly.rotationSpeed.z * deltaTime;\r\n                }\r\n                continue;\r\n            }\r\n            \r\n            // Check if player is nearby to enhance effects\r\n            let playerNearby = false;\r\n            if (playerPosition) {\r\n                const distance = playerPosition.distanceTo(anomaly.position);\r\n                playerNearby = distance < (anomaly.orb.size * 3) * this.orbScale; // Only enhance effects based on orb distance\r\n            }\r\n            \r\n            // Rotate the entire anomaly slowly\r\n            if (anomaly.mesh && anomaly.rotationSpeed) {\r\n                anomaly.mesh.rotation.x += anomaly.rotationSpeed.x * deltaTime;\r\n                anomaly.mesh.rotation.y += anomaly.rotationSpeed.y * deltaTime;\r\n                anomaly.mesh.rotation.z += anomaly.rotationSpeed.z * deltaTime;\r\n            }\r\n            \r\n            // Animate specific anomaly types\r\n            switch (anomaly.type) {\r\n                case 'vortex':\r\n                    this.updateVortexAnomaly(anomaly, deltaTime);\r\n                    break;\r\n                case 'crystalCluster':\r\n                    this.updateCrystalClusterAnomaly(anomaly, deltaTime);\r\n                    break;\r\n                case 'nebulaNexus':\r\n                    this.updateNebulaNexusAnomaly(anomaly, deltaTime);\r\n                    break;\r\n                case 'quantumFlux':\r\n                    this.updateQuantumFluxAnomaly(anomaly, deltaTime);\r\n                    break;\r\n                case 'darkMatter':\r\n                    this.updateDarkMatterAnomaly(anomaly, deltaTime);\r\n                    break;\r\n            }\r\n            \r\n            // Update orb effects based on player proximity\r\n            this.updateOrbEffects(anomaly, playerNearby);\r\n        }\r\n    }\r\n    \r\n    createVortexAnomaly() {\r\n        // Create a spiraling vortex structure with central orb\r\n        \r\n        // Determine position outside asteroid belt\r\n        const position = this.getRandomAnomalyPosition();\r\n        const anomalyGroup = new THREE.Group();\r\n        anomalyGroup.position.copy(position);\r\n        \r\n        // Apply scale to make anomaly 4x bigger\r\n        anomalyGroup.scale.set(this.anomalyScale, this.anomalyScale, this.anomalyScale);\r\n        \r\n        // Create the structural elements - spiral rings\r\n        const ringCount = 6;\r\n        const rings = [];\r\n        \r\n        // Create multiple rings with decreasing radius\r\n        for (let i = 0; i < ringCount; i++) {\r\n            const radius = 400 - (i * 50);\r\n            const geometry = new THREE.TorusGeometry(radius, 15, 16, 100); // Increased tube radius from 10 to 15\r\n            \r\n            // Bright blue-cyan color scheme for better visibility\r\n            const hue = 0.5 + (i * 0.05); // Blue to cyan gradient\r\n            const color = new THREE.Color().setHSL(hue, 0.9, 0.6); // Increased saturation and lightness\r\n            \r\n            const material = new THREE.MeshStandardMaterial({\r\n                color: color,\r\n                emissive: color.clone().multiplyScalar(0.5),\r\n                emissiveIntensity: 1.0,\r\n                metalness: 0.8,\r\n                roughness: 0.2,\r\n                transparent: true,\r\n                opacity: 0.95\r\n            });\r\n            \r\n            const ring = new THREE.Mesh(geometry, material);\r\n            \r\n            // Rotate each ring at different angles to create spiral effect\r\n            ring.rotation.x = Math.PI / 2 + (i * 0.2);\r\n            ring.rotation.y = i * 0.3;\r\n            \r\n            anomalyGroup.add(ring);\r\n            rings.push({\r\n                mesh: ring,\r\n                rotationSpeed: {\r\n                    x: 0.005 + (i * 0.002),\r\n                    y: 0.003 + (i * 0.001),\r\n                    z: 0.001 + (i * 0.0005)\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Create energy orb in the center\r\n        const orbRarity = this.getRandomOrbRarity();\r\n        const orb = this.createEnergyOrb(orbRarity);\r\n        anomalyGroup.add(orb.mesh);\r\n        \r\n        // Add to scene\r\n        this._addToScene(anomalyGroup);\r\n        \r\n        // Save anomaly data\r\n        this.anomalies.push({\r\n            type: 'vortex',\r\n            mesh: anomalyGroup,\r\n            position: position.clone(),\r\n            rings: rings,\r\n            orb: orb,\r\n            collisionRadius: 350, // Overall collision size\r\n            orbCollected: false,\r\n            rotationSpeed: new THREE.Vector3(0.001, 0.002, 0.0015)\r\n        });\r\n    }\r\n    \r\n    createCrystalClusterAnomaly() {\r\n        // Create a crystalline structure with floating crystals and central orb\r\n        \r\n        // Determine position outside asteroid belt\r\n        const position = this.getRandomAnomalyPosition();\r\n        const anomalyGroup = new THREE.Group();\r\n        anomalyGroup.position.copy(position);\r\n        \r\n        // Apply scale to make anomaly 4x bigger\r\n        anomalyGroup.scale.set(this.anomalyScale, this.anomalyScale, this.anomalyScale);\r\n        \r\n        // Create main crystal structure using multiple crystal forms\r\n        const crystals = [];\r\n        const crystalCount = 20;\r\n        \r\n        for (let i = 0; i < crystalCount; i++) {\r\n            // Random crystal size\r\n            const size = 50 + Math.random() * 100; // Increased from 30+80 to 50+100\r\n            \r\n            // Create crystal geometry - mix of different polyhedra\r\n            let geometry;\r\n            const crystalType = Math.floor(Math.random() * 3);\r\n            \r\n            if (crystalType === 0) {\r\n                // Octahedron - diamond-like crystal\r\n                geometry = new THREE.OctahedronGeometry(size, 0);\r\n            } else if (crystalType === 1) {\r\n                // Dodecahedron - more complex crystal\r\n                geometry = new THREE.DodecahedronGeometry(size, 0);\r\n            } else {\r\n                // Prism-like crystal using stretched tetrahedron\r\n                geometry = new THREE.TetrahedronGeometry(size, 0);\r\n                \r\n                // Stretch it to make it more crystal-like\r\n                const positions = geometry.attributes.position;\r\n                for (let j = 0; j < positions.count; j++) {\r\n                    const vertex = new THREE.Vector3();\r\n                    vertex.fromBufferAttribute(positions, j);\r\n                    \r\n                    // Stretch along one axis\r\n                    vertex.y *= 2.5;\r\n                    \r\n                    positions.setXYZ(j, vertex.x, vertex.y, vertex.z);\r\n                }\r\n                geometry.computeVertexNormals();\r\n            }\r\n            \r\n            // Create a semi-transparent crystalline material with bright teal colors\r\n            const hue = 0.45 + Math.random() * 0.1; // Teal/aqua/green color palette\r\n            const saturation = 0.9 + Math.random() * 0.1; // Increased saturation\r\n            const lightness = 0.6 + Math.random() * 0.2; // Increased lightness\r\n            \r\n            const color = new THREE.Color().setHSL(hue, saturation, lightness);\r\n            \r\n            const material = new THREE.MeshStandardMaterial({\r\n                color: color,\r\n                metalness: 0.9,\r\n                roughness: 0.1,\r\n                transparent: true,\r\n                opacity: 0.9,\r\n                emissive: color.clone(),\r\n                emissiveIntensity: 0.5\r\n            });\r\n            \r\n            const crystal = new THREE.Mesh(geometry, material);\r\n            \r\n            // Position crystal in a spherical arrangement\r\n            const radius = 200 + Math.random() * 100;\r\n            const theta = Math.random() * Math.PI * 2;\r\n            const phi = Math.random() * Math.PI;\r\n            \r\n            crystal.position.set(\r\n                radius * Math.sin(phi) * Math.cos(theta),\r\n                radius * Math.sin(phi) * Math.sin(theta),\r\n                radius * Math.cos(phi)\r\n            );\r\n            \r\n            // Random rotation\r\n            crystal.rotation.set(\r\n                Math.random() * Math.PI * 2,\r\n                Math.random() * Math.PI * 2,\r\n                Math.random() * Math.PI * 2\r\n            );\r\n            \r\n            anomalyGroup.add(crystal);\r\n            \r\n            // Store crystal data for animation\r\n            crystals.push({\r\n                mesh: crystal,\r\n                initialPosition: crystal.position.clone(),\r\n                floatPhase: Math.random() * Math.PI * 2,\r\n                floatSpeed: 0.3 + Math.random() * 0.3,\r\n                floatAmplitude: 5 + Math.random() * 10,\r\n                rotationSpeed: {\r\n                    x: (Math.random() - 0.5) * 0.01,\r\n                    y: (Math.random() - 0.5) * 0.01,\r\n                    z: (Math.random() - 0.5) * 0.01\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Create energy orb in the center\r\n        const orbRarity = this.getRandomOrbRarity();\r\n        const orb = this.createEnergyOrb(orbRarity);\r\n        anomalyGroup.add(orb.mesh);\r\n        \r\n        // Add to scene\r\n        this._addToScene(anomalyGroup);\r\n        \r\n        // Save anomaly data\r\n        this.anomalies.push({\r\n            type: 'crystalCluster',\r\n            mesh: anomalyGroup,\r\n            position: position.clone(),\r\n            crystals: crystals,\r\n            orb: orb,\r\n            collisionRadius: 300, // Overall collision size\r\n            orbCollected: false,\r\n            rotationSpeed: new THREE.Vector3(0.0005, 0.001, 0.0005)\r\n        });\r\n    }\r\n    \r\n    createNebulaNexusAnomaly() {\r\n        // Create a crystalline ring structure with central orb\r\n        // Completely redesigned from particle-based nebula to solid structure\r\n        \r\n        // Determine position outside asteroid belt\r\n        const position = this.getRandomAnomalyPosition();\r\n        const anomalyGroup = new THREE.Group();\r\n        anomalyGroup.position.copy(position);\r\n        \r\n        // Apply scale to make anomaly 4x bigger\r\n        anomalyGroup.scale.set(this.anomalyScale, this.anomalyScale, this.anomalyScale);\r\n        \r\n        // Create a series of rotating rings with crystal formations\r\n        const ringCount = 3;\r\n        const rings = [];\r\n        \r\n        // Create multiple crystal-studded rings\r\n        for (let i = 0; i < ringCount; i++) {\r\n            // Create a ring\r\n            const ringRadius = 200 + i * 60;\r\n            const ringGeometry = new THREE.TorusGeometry(ringRadius, 8, 16, 50);\r\n            \r\n            // Create a vibrant material for the ring\r\n            const ringHue = 0.6 + i * 0.1; // Blue to purple gradient\r\n            const ringColor = new THREE.Color().setHSL(ringHue, 1.0, 0.6);\r\n            \r\n            const ringMaterial = new THREE.MeshStandardMaterial({\r\n                color: ringColor,\r\n                emissive: ringColor.clone().multiplyScalar(0.5),\r\n                emissiveIntensity: 1.0,\r\n                metalness: 0.9,\r\n                roughness: 0.1,\r\n                transparent: false,\r\n                opacity: 1.0\r\n            });\r\n            \r\n            const ring = new THREE.Mesh(ringGeometry, ringMaterial);\r\n            \r\n            // Position ring with different orientation\r\n            ring.rotation.x = Math.PI/2 + (i * Math.PI/3);\r\n            ring.rotation.y = i * Math.PI/4;\r\n            \r\n            anomalyGroup.add(ring);\r\n            \r\n            // Add crystals along the ring\r\n            const crystalCount = 10 + i * 5;\r\n            const crystals = [];\r\n            \r\n            for (let j = 0; j < crystalCount; j++) {\r\n                // Crystal position along the ring\r\n                const angle = (j / crystalCount) * Math.PI * 2;\r\n                \r\n                // Create crystal geometry\r\n                const crystalSize = 15 + Math.random() * 10;\r\n                const crystalGeometry = new THREE.OctahedronGeometry(crystalSize, 0);\r\n                \r\n                // Create crystal material with complementary color\r\n                const crystalHue = (ringHue + 0.5) % 1.0; // Complementary color\r\n                const crystalColor = new THREE.Color().setHSL(crystalHue, 1.0, 0.7);\r\n                \r\n                const crystalMaterial = new THREE.MeshStandardMaterial({\r\n                    color: crystalColor,\r\n                    emissive: crystalColor.clone(),\r\n                    emissiveIntensity: 0.8,\r\n                    metalness: 0.9,\r\n                    roughness: 0.1,\r\n                    transparent: false,\r\n                    opacity: 1.0\r\n                });\r\n                \r\n                const crystal = new THREE.Mesh(crystalGeometry, crystalMaterial);\r\n                \r\n                // Position crystal on the ring\r\n                crystal.position.x = ringRadius * Math.cos(angle);\r\n                crystal.position.y = 0;\r\n                crystal.position.z = ringRadius * Math.sin(angle);\r\n                \r\n                // Random rotation\r\n                crystal.rotation.x = Math.random() * Math.PI;\r\n                crystal.rotation.y = Math.random() * Math.PI;\r\n                crystal.rotation.z = Math.random() * Math.PI;\r\n                \r\n                ring.add(crystal);\r\n                \r\n                crystals.push({\r\n                    mesh: crystal,\r\n                    initialPosition: crystal.position.clone(),\r\n                    pulsePhase: Math.random() * Math.PI * 2,\r\n                    pulseSpeed: 0.5 + Math.random() * 0.5\r\n                });\r\n            }\r\n            \r\n            rings.push({\r\n                mesh: ring,\r\n                crystals: crystals,\r\n                rotationSpeed: 0.1 - (i * 0.03), // Outer rings rotate slower\r\n                rotationAxis: new THREE.Vector3(\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5\r\n                ).normalize()\r\n            });\r\n        }\r\n        \r\n        // Create an inner sphere with energy effect\r\n        const coreRadius = 80;\r\n        const coreGeometry = new THREE.SphereGeometry(coreRadius, 32, 32);\r\n        const coreColor = new THREE.Color().setHSL(0.15, 1.0, 0.6); // Gold color\r\n        \r\n        const coreMaterial = new THREE.MeshStandardMaterial({\r\n            color: coreColor,\r\n            emissive: coreColor,\r\n            emissiveIntensity: 1.0,\r\n            metalness: 1.0,\r\n            roughness: 0.3,\r\n                transparent: true,\r\n            opacity: 0.9\r\n        });\r\n        \r\n        const core = new THREE.Mesh(coreGeometry, coreMaterial);\r\n        anomalyGroup.add(core);\r\n        \r\n        // Add energy arcs from core to rings\r\n        const arcCount = 8;\r\n        const arcs = [];\r\n        \r\n        for (let i = 0; i < arcCount; i++) {\r\n            const curve = new THREE.CubicBezierCurve3(\r\n                new THREE.Vector3(0, 0, 0),\r\n                new THREE.Vector3(\r\n                    (Math.random() - 0.5) * 200,\r\n                    (Math.random() - 0.5) * 200,\r\n                    (Math.random() - 0.5) * 200\r\n                ),\r\n                new THREE.Vector3(\r\n                    (Math.random() - 0.5) * 300,\r\n                    (Math.random() - 0.5) * 300,\r\n                    (Math.random() - 0.5) * 300\r\n                ),\r\n                new THREE.Vector3(\r\n                    (Math.random() - 0.5) * 400,\r\n                    (Math.random() - 0.5) * 400,\r\n                    (Math.random() - 0.5) * 400\r\n                )\r\n            );\r\n            \r\n            const points = curve.getPoints(20);\r\n            const arcGeometry = new THREE.BufferGeometry().setFromPoints(points);\r\n            \r\n            const arcColor = new THREE.Color().setHSL(0.15, 1.0, 0.6); // Gold color\r\n            const arcMaterial = new THREE.LineBasicMaterial({\r\n                color: arcColor,\r\n                linewidth: 3,\r\n                transparent: true,\r\n                opacity: 0.8\r\n            });\r\n            \r\n            const arc = new THREE.Line(arcGeometry, arcMaterial);\r\n            anomalyGroup.add(arc);\r\n            \r\n            arcs.push({\r\n                mesh: arc,\r\n                curve: curve,\r\n                updatePhase: Math.random() * Math.PI * 2,\r\n                updateSpeed: 0.2 + Math.random() * 0.3\r\n            });\r\n        }\r\n        \r\n        // Create energy orb in the center\r\n        const orbRarity = this.getRandomOrbRarity();\r\n        const orb = this.createEnergyOrb(orbRarity);\r\n        anomalyGroup.add(orb.mesh);\r\n        \r\n        // Add to scene\r\n        this._addToScene(anomalyGroup);\r\n        \r\n        // Save anomaly data\r\n        this.anomalies.push({\r\n            type: 'nebulaNexus',\r\n            mesh: anomalyGroup,\r\n            position: position.clone(),\r\n            rings: rings,\r\n            core: {\r\n                mesh: core,\r\n                pulsePhase: 0,\r\n                pulseSpeed: 0.5\r\n            },\r\n            arcs: arcs,\r\n            orb: orb,\r\n            collisionRadius: 250,\r\n            orbCollected: false,\r\n            rotationSpeed: new THREE.Vector3(0.0003, 0.0004, 0.0002)\r\n        });\r\n    }\r\n    \r\n    createQuantumFluxAnomaly() {\r\n        // Create a quantum flux anomaly with rotating cube frames\r\n        \r\n        // Determine position outside asteroid belt\r\n        const position = this.getRandomAnomalyPosition();\r\n        const anomalyGroup = new THREE.Group();\r\n        anomalyGroup.position.copy(position);\r\n        \r\n        // Apply scale to make anomaly 4x bigger\r\n        anomalyGroup.scale.set(this.anomalyScale, this.anomalyScale, this.anomalyScale);\r\n        \r\n        // Create rotating cubic frames\r\n        const frames = [];\r\n        const frameCount = 5;\r\n        \r\n        for (let i = 0; i < frameCount; i++) {\r\n            // Create cubic wireframe box\r\n            const size = 250 - i * 40;\r\n            const geometry = new THREE.BoxGeometry(size, size, size);\r\n            \r\n            // Add a solid but transparent box inside the wireframe for better visibility\r\n            const innerGeometry = new THREE.BoxGeometry(size * 0.98, size * 0.98, size * 0.98);\r\n            \r\n            // Extract only edges to create wireframe\r\n            const edges = new THREE.EdgesGeometry(geometry);\r\n            \r\n            // Use extremely vibrant electric colors\r\n            const hue = 0.3 + i * 0.1; // Shift from green to blue\r\n            const color = new THREE.Color().setHSL(hue, 1.0, 0.6);\r\n            \r\n            const material = new THREE.LineBasicMaterial({ \r\n                color: color,\r\n                linewidth: 2,\r\n                transparent: false, // Changed to non-transparent for better visibility\r\n                opacity: 1.0\r\n            });\r\n            \r\n            // Inner box with semi-transparent material\r\n            const innerMaterial = new THREE.MeshBasicMaterial({\r\n                color: color,\r\n                transparent: true,\r\n                opacity: 0.1,\r\n                side: THREE.DoubleSide\r\n            });\r\n            \r\n            const frame = new THREE.LineSegments(edges, material);\r\n            const innerBox = new THREE.Mesh(innerGeometry, innerMaterial);\r\n            \r\n            // Add both to group and store for animation\r\n            anomalyGroup.add(frame);\r\n            anomalyGroup.add(innerBox);\r\n            \r\n            frames.push({\r\n                mesh: frame,\r\n                innerBox: innerBox,\r\n                rotationAxis: new THREE.Vector3(\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5\r\n                ).normalize(),\r\n                rotationSpeed: 0.01 + i * 0.005,\r\n                pulsePhase: Math.random() * Math.PI * 2\r\n            });\r\n        }\r\n        \r\n        // Add energy particles inside\r\n        const particleCount = 200;\r\n        const particleGeometry = new THREE.BufferGeometry();\r\n        const particlePositions = new Float32Array(particleCount * 3);\r\n        const particleSizes = new Float32Array(particleCount);\r\n        \r\n        for (let i = 0; i < particleCount; i++) {\r\n            const i3 = i * 3;\r\n            \r\n            // Position particles within the inner cube\r\n            const radius = 100 * Math.random();\r\n            const theta = Math.random() * Math.PI * 2;\r\n            const phi = Math.random() * Math.PI;\r\n            \r\n            particlePositions[i3] = radius * Math.sin(phi) * Math.cos(theta);\r\n            particlePositions[i3 + 1] = radius * Math.sin(phi) * Math.sin(theta);\r\n            particlePositions[i3 + 2] = radius * Math.cos(phi);\r\n            \r\n            // Vary particle sizes\r\n            particleSizes[i] = 2 + Math.random() * 3;\r\n        }\r\n        \r\n        particleGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));\r\n        particleGeometry.setAttribute('size', new THREE.BufferAttribute(particleSizes, 1));\r\n        \r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0xff00ff, // Magenta\r\n            size: 6,\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true,\r\n            opacity: 0.9\r\n        });\r\n        \r\n        const particles = new THREE.Points(particleGeometry, particleMaterial);\r\n        anomalyGroup.add(particles);\r\n        \r\n        // Create energy orb in the center\r\n        const orbRarity = this.getRandomOrbRarity();\r\n        const orb = this.createEnergyOrb(orbRarity);\r\n        anomalyGroup.add(orb.mesh);\r\n        \r\n        // Add to scene\r\n        this._addToScene(anomalyGroup);\r\n        \r\n        // Save anomaly data\r\n        this.anomalies.push({\r\n            type: 'quantumFlux',\r\n            mesh: anomalyGroup,\r\n            position: position.clone(),\r\n            frames: frames,\r\n            particles: {\r\n                mesh: particles,\r\n                positions: particlePositions,\r\n                initialPositions: particlePositions.slice(), // Clone for reference\r\n                velocities: Array(particleCount).fill().map(() => new THREE.Vector3(\r\n                    (Math.random() - 0.5) * 0.5,\r\n                    (Math.random() - 0.5) * 0.5,\r\n                    (Math.random() - 0.5) * 0.5\r\n                ))\r\n            },\r\n            orb: orb,\r\n            collisionRadius: 230, // Overall collision size\r\n            orbCollected: false,\r\n            rotationSpeed: new THREE.Vector3(0.0001, 0.0002, 0.0001)\r\n        });\r\n    }\r\n    \r\n    createDarkMatterAnomaly() {\r\n        // Create a dark matter anomaly with gravitational lensing effects\r\n        \r\n        // Determine position outside asteroid belt\r\n        const position = this.getRandomAnomalyPosition();\r\n        const anomalyGroup = new THREE.Group();\r\n        anomalyGroup.position.copy(position);\r\n        \r\n        // Apply scale to make anomaly 4x bigger\r\n        anomalyGroup.scale.set(this.anomalyScale, this.anomalyScale, this.anomalyScale);\r\n        \r\n        // Create the dark matter core - a sphere with dark, distortion-like material\r\n        const coreRadius = 100;\r\n        const coreGeometry = new THREE.SphereGeometry(coreRadius, 32, 32);\r\n        const coreMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0x330033,\r\n            emissive: 0x880088,\r\n            emissiveIntensity: 1.5,\r\n            metalness: 1.0,\r\n            roughness: 0.0,\r\n            transparent: true,\r\n            opacity: 0.95\r\n        });\r\n        \r\n        const core = new THREE.Mesh(coreGeometry, coreMaterial);\r\n        \r\n        // Add a glow effect around the core\r\n        const glowGeometry = new THREE.SphereGeometry(coreRadius * 1.2, 32, 32);\r\n        const glowMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0x9900ff,\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            side: THREE.BackSide\r\n        });\r\n        \r\n        const glow = new THREE.Mesh(glowGeometry, glowMaterial);\r\n        core.add(glow);\r\n        \r\n        anomalyGroup.add(core);\r\n        \r\n        // Create gravitational distortion rings\r\n        const rings = [];\r\n        const ringCount = 4;\r\n        \r\n        for (let i = 0; i < ringCount; i++) {\r\n            const radius = 150 + i * 60;\r\n            const tubeRadius = 4 + i * 2;\r\n            const geometry = new THREE.TorusGeometry(radius, tubeRadius, 16, 100);\r\n            \r\n            // Use dark/purple color scheme with increasing brightness outward\r\n            const color = new THREE.Color().setHSL(0.75, 0.9, 0.1 + i * 0.15);\r\n            \r\n            const material = new THREE.MeshStandardMaterial({\r\n                color: color,\r\n                emissive: color.clone().multiplyScalar(0.7),\r\n                emissiveIntensity: 0.5 + i * 0.2,\r\n                metalness: 0.8,\r\n                roughness: 0.2,\r\n                transparent: true,\r\n                opacity: 0.85\r\n            });\r\n            \r\n            const ring = new THREE.Mesh(geometry, material);\r\n            \r\n            // Position with random orientation\r\n            ring.rotation.x = Math.random() * Math.PI;\r\n            ring.rotation.y = Math.random() * Math.PI;\r\n            ring.rotation.z = Math.random() * Math.PI;\r\n            \r\n            anomalyGroup.add(ring);\r\n            rings.push({\r\n                mesh: ring,\r\n                rotationAxis: new THREE.Vector3(\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5,\r\n                    Math.random() - 0.5\r\n                ).normalize(),\r\n                rotationSpeed: 0.002 + i * 0.001,\r\n                warpPhase: Math.random() * Math.PI * 2,\r\n                warpSpeed: 0.5 + Math.random() * 0.5\r\n            });\r\n        }\r\n        \r\n        // Create distortion particles\r\n        const particleCount = 300;\r\n        const particleGeometry = new THREE.BufferGeometry();\r\n        const particlePositions = new Float32Array(particleCount * 3);\r\n        const particleSizes = new Float32Array(particleCount);\r\n        \r\n        for (let i = 0; i < particleCount; i++) {\r\n            const i3 = i * 3;\r\n            \r\n            // Distribute particles in a spherical shell\r\n            const radius = 120 + Math.random() * 250;\r\n            const theta = Math.random() * Math.PI * 2;\r\n            const phi = Math.random() * Math.PI;\r\n            \r\n            particlePositions[i3] = radius * Math.sin(phi) * Math.cos(theta);\r\n            particlePositions[i3 + 1] = radius * Math.sin(phi) * Math.sin(theta);\r\n            particlePositions[i3 + 2] = radius * Math.cos(phi);\r\n            \r\n            // Vary particle sizes\r\n            particleSizes[i] = 1 + Math.random() * 3;\r\n        }\r\n        \r\n        particleGeometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));\r\n        particleGeometry.setAttribute('size', new THREE.BufferAttribute(particleSizes, 1));\r\n        \r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0x8800ff,\r\n            size: 5,\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true,\r\n            opacity: 0.8\r\n        });\r\n        \r\n        const particles = new THREE.Points(particleGeometry, particleMaterial);\r\n        anomalyGroup.add(particles);\r\n        \r\n        // Create energy orb in the center\r\n        const orbRarity = this.getRandomOrbRarity();\r\n        const orb = this.createEnergyOrb(orbRarity);\r\n        anomalyGroup.add(orb.mesh);\r\n        \r\n        // Add to scene\r\n        this.scene.add(anomalyGroup);\r\n        \r\n        // Save anomaly data\r\n        this.anomalies.push({\r\n            type: 'darkMatter',\r\n            mesh: anomalyGroup,\r\n            position: position.clone(),\r\n            core: {\r\n                mesh: core,\r\n                pulsePhase: 0\r\n            },\r\n            rings: rings,\r\n            particles: {\r\n                mesh: particles,\r\n                positions: particlePositions,\r\n                initialPositions: particlePositions.slice(),\r\n                phases: Array(particleCount).fill().map(() => Math.random() * Math.PI * 2)\r\n            },\r\n            orb: orb,\r\n            collisionRadius: 200, // Overall collision size\r\n            orbCollected: false,\r\n            rotationSpeed: new THREE.Vector3(0.0002, 0.0003, 0.0001)\r\n        });\r\n    }\r\n    \r\n    createEnergyOrb(rarity) {\r\n        // Create an energy orb with glow effects based on rarity\r\n        \r\n        // Determine orb color and properties based on rarity\r\n        let color, size, intensity, pulseSpeed;\r\n        \r\n        switch(rarity) {\r\n            case 'legendary':\r\n                color = new THREE.Color(0xff0000); // Red\r\n                size = 30 * this.orbScale;  // 4x bigger\r\n                intensity = 0.9;\r\n                pulseSpeed = 2.0;\r\n                break;\r\n            case 'epic':\r\n                color = new THREE.Color(0xff6600); // Orange\r\n                size = 25 * this.orbScale;  // 4x bigger\r\n                intensity = 0.8;\r\n                pulseSpeed = 1.8;\r\n                break;\r\n            case 'rare':\r\n                color = new THREE.Color(0x9900ff); // Purple\r\n                size = 22 * this.orbScale;  // 4x bigger\r\n                intensity = 0.7;\r\n                pulseSpeed = 1.5;\r\n                break;\r\n            case 'uncommon':\r\n                color = new THREE.Color(0x0066ff); // Blue\r\n                size = 20 * this.orbScale;  // 4x bigger\r\n                intensity = 0.6;\r\n                pulseSpeed = 1.2;\r\n                break;\r\n            default: // common\r\n                color = new THREE.Color(0x00ff66); // Green\r\n                size = 18 * this.orbScale;  // 4x bigger\r\n                intensity = 0.5;\r\n                pulseSpeed = 1.0;\r\n                break;\r\n        }\r\n        \r\n        // Create the core orb\r\n        const orbGeometry = new THREE.SphereGeometry(size, 32, 32);\r\n        const orbMaterial = new THREE.MeshStandardMaterial({\r\n            color: color,\r\n            emissive: color,\r\n            emissiveIntensity: intensity,\r\n            metalness: 0.8,\r\n            roughness: 0.2,\r\n            transparent: true,\r\n            opacity: 0.9\r\n        });\r\n        \r\n        const orb = new THREE.Mesh(orbGeometry, orbMaterial);\r\n        \r\n        // Create outer glow\r\n        const glowSize = size * 1.5;\r\n        const glowGeometry = new THREE.SphereGeometry(glowSize, 32, 32);\r\n        const glowMaterial = new THREE.MeshBasicMaterial({\r\n            color: color,\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            side: THREE.BackSide,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        \r\n        const glow = new THREE.Mesh(glowGeometry, glowMaterial);\r\n        orb.add(glow);\r\n        \r\n        // Return orb data\r\n        return {\r\n            mesh: orb,\r\n            rarity: rarity,\r\n            value: this.orbValues[rarity],\r\n            size: size,\r\n            color: color,\r\n            pulsePhase: 0,\r\n            pulseSpeed: pulseSpeed,\r\n            glow: glow\r\n        };\r\n    }\r\n    \r\n    createParticleTexture() {\r\n        // Create a particle texture for better-looking nebula particles\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = 64;\r\n        canvas.height = 64;\r\n        \r\n        const context = canvas.getContext('2d');\r\n        const gradient = context.createRadialGradient(\r\n            32, 32, 0,\r\n            32, 32, 32\r\n        );\r\n        \r\n        gradient.addColorStop(0, 'rgba(255,255,255,1)');\r\n        gradient.addColorStop(0.3, 'rgba(255,255,255,0.8)');\r\n        gradient.addColorStop(0.7, 'rgba(200,200,200,0.3)');\r\n        gradient.addColorStop(1, 'rgba(100,100,100,0)');\r\n        \r\n        context.fillStyle = gradient;\r\n        context.fillRect(0, 0, 64, 64);\r\n        \r\n        const texture = new THREE.Texture(canvas);\r\n        texture.needsUpdate = true;\r\n        return texture;\r\n    }\r\n    \r\n    getRandomAnomalyPosition() {\r\n        // Get random position outside asteroid belt\r\n        const angle = Math.random() * Math.PI * 2;\r\n        const radius = this.minRadius + Math.random() * (this.maxRadius - this.minRadius);\r\n        const heightVariation = (Math.random() - 0.5) * this.width;\r\n        \r\n        return new THREE.Vector3(\r\n            Math.cos(angle) * radius,\r\n            heightVariation,\r\n            Math.sin(angle) * radius\r\n        );\r\n    }\r\n    \r\n    getRandomOrbRarity() {\r\n        // Determine orb rarity based on probabilities\r\n        const roll = Math.random();\r\n        \r\n        if (roll < 0.005) {\r\n            return 'legendary'; // 0.5% chance\r\n        } else if (roll < 0.025) {\r\n            return 'epic'; // 2% chance\r\n        } else if (roll < 0.1) {\r\n            return 'rare'; // 7.5% chance\r\n        } else if (roll < 0.3) {\r\n            return 'uncommon'; // 20% chance\r\n        } else {\r\n            return 'common'; // 70% chance\r\n        }\r\n    }\r\n    \r\n    getRegionInfo() {\r\n        return {\r\n            center: new THREE.Vector3(0, 0, 0),\r\n            innerRadius: this.minRadius,\r\n            outerRadius: this.maxRadius\r\n        };\r\n    }\r\n    \r\n    findClosestAnomaly(position, maxDistance = 8000) {\r\n        let closestAnomaly = null;\r\n        let closestDistance = maxDistance;\r\n        \r\n        this.anomalies.forEach(anomaly => {\r\n            // Calculate distance to this anomaly\r\n            const distance = position.distanceTo(anomaly.position);\r\n            \r\n            if (distance < closestDistance) {\r\n                closestDistance = distance;\r\n                closestAnomaly = anomaly;\r\n            }\r\n        });\r\n        \r\n        return closestAnomaly;\r\n    }\r\n    \r\n    collectOrb(anomaly) {\r\n        if (!anomaly || anomaly.orbCollected) {\r\n            return null; // Already collected or invalid anomaly\r\n        }\r\n        \r\n        // Get orb data before marking as collected\r\n        const orbData = {\r\n            rarity: anomaly.orb.rarity,\r\n            value: this.orbValues[anomaly.orb.rarity] || 100 // Default to 100 if rarity not found\r\n        };\r\n        \r\n        // Mark as collected and update visuals\r\n        anomaly.orbCollected = true;\r\n        \r\n        // Hide the orb\r\n        if (anomaly.orb && anomaly.orb.mesh) {\r\n            anomaly.orb.mesh.visible = false;\r\n            \r\n            // Also hide glow if present\r\n            if (anomaly.orb.glow) {\r\n                anomaly.orb.glow.visible = false;\r\n            }\r\n        }\r\n        \r\n        return orbData; // Return data for player inventory and notification\r\n    }\r\n    \r\n    checkCollision(position, anomaly) {\r\n        if (!position || !anomaly || !anomaly.position) return false;\r\n        \r\n        // Calculate distance from player to anomaly center\r\n        const distance = position.distanceTo(anomaly.position);\r\n        \r\n        // Check if within orb collection radius - we only want orb collisions, not anomaly collision\r\n        // Use the original collision radius for orb collection, scaled by orbScale\r\n        // This ensures we're only checking for the orb and not the anomaly itself\r\n        return distance < (anomaly.orb.size * 2) * this.orbScale;\r\n    }\r\n    \r\n    updateOrbEffects(anomaly, playerNearby) {\r\n        if (!anomaly || !anomaly.orb || anomaly.orbCollected) return;\r\n        \r\n        // Enhance orb effects when player is nearby to make collection more obvious\r\n        if (playerNearby) {\r\n            // If player is nearby, make the orb pulse more dramatically\r\n            const scale = 1.5 + Math.sin(performance.now() * 0.005) * 0.5;\r\n            anomaly.orb.mesh.scale.set(scale, scale, scale);\r\n            \r\n            // Increase emission intensity\r\n            if (anomaly.orb.mesh.material) {\r\n                anomaly.orb.mesh.material.emissiveIntensity = 2.0;\r\n            }\r\n        } else {\r\n            // Reset to normal effects when player is not nearby\r\n            const scale = 1.0 + Math.sin(performance.now() * 0.002) * 0.2;\r\n            anomaly.orb.mesh.scale.set(scale, scale, scale);\r\n            \r\n            // Normal emission intensity\r\n            if (anomaly.orb.mesh.material) {\r\n                anomaly.orb.mesh.material.emissiveIntensity = 0.8;\r\n            }\r\n        }\r\n    }\r\n    \r\n    updateVortexAnomaly(anomaly, deltaTime) {\r\n        // Rotate each ring\r\n        anomaly.rings.forEach(ring => {\r\n            ring.mesh.rotation.x += ring.rotationSpeed.x * deltaTime;\r\n            ring.mesh.rotation.y += ring.rotationSpeed.y * deltaTime;\r\n            ring.mesh.rotation.z += ring.rotationSpeed.z * deltaTime;\r\n        });\r\n    }\r\n    \r\n    updateCrystalClusterAnomaly(anomaly, deltaTime) {\r\n        // Animate floating crystals\r\n        anomaly.crystals.forEach(crystal => {\r\n            // Update float phase\r\n            crystal.floatPhase += deltaTime * crystal.floatSpeed;\r\n            \r\n            // Create floating motion\r\n            const floatOffset = Math.sin(crystal.floatPhase) * crystal.floatAmplitude;\r\n            crystal.mesh.position.y = crystal.initialPosition.y + floatOffset;\r\n            \r\n            // Rotate the crystal\r\n            crystal.mesh.rotation.x += crystal.rotationSpeed.x;\r\n            crystal.mesh.rotation.y += crystal.rotationSpeed.y;\r\n            crystal.mesh.rotation.z += crystal.rotationSpeed.z;\r\n        });\r\n    }\r\n    \r\n    updateNebulaNexusAnomaly(anomaly, deltaTime) {\r\n        // Animate core\r\n        anomaly.core.pulsePhase += deltaTime * anomaly.core.pulseSpeed;\r\n        const scale = 1.0 + 0.2 * Math.sin(anomaly.core.pulsePhase);\r\n        anomaly.core.mesh.scale.set(scale, scale, scale);\r\n        \r\n        // Animate rings and crystals\r\n        anomaly.rings.forEach(ring => {\r\n            // Rotate each ring\r\n            const rotationMatrix = new THREE.Matrix4().makeRotationAxis(\r\n                ring.rotationAxis,\r\n                ring.rotationSpeed * deltaTime\r\n            );\r\n            ring.mesh.applyMatrix4(rotationMatrix);\r\n            \r\n            // Animate crystals on the ring\r\n            ring.crystals.forEach(crystal => {\r\n                crystal.pulsePhase += deltaTime * crystal.pulseSpeed;\r\n                const crystalScale = 1.0 + 0.3 * Math.sin(crystal.pulsePhase);\r\n                crystal.mesh.scale.set(crystalScale, crystalScale, crystalScale);\r\n            });\r\n        });\r\n        \r\n        // Animate energy arcs\r\n        anomaly.arcs.forEach(arc => {\r\n            arc.updatePhase += deltaTime * arc.updateSpeed;\r\n            \r\n            // Update arc control points for dynamic movement\r\n            const controlPoint1 = arc.curve.v1;\r\n            const controlPoint2 = arc.curve.v2;\r\n            \r\n            controlPoint1.x = Math.sin(arc.updatePhase) * 200;\r\n            controlPoint1.y = Math.cos(arc.updatePhase * 0.7) * 200;\r\n            controlPoint1.z = Math.sin(arc.updatePhase * 1.3) * 200;\r\n            \r\n            controlPoint2.x = Math.sin(arc.updatePhase * 0.8 + 1) * 300;\r\n            controlPoint2.y = Math.cos(arc.updatePhase * 1.2 + 2) * 300;\r\n            controlPoint2.z = Math.sin(arc.updatePhase * 0.9 + 3) * 300;\r\n            \r\n            // Update arc geometry\r\n            const points = arc.curve.getPoints(20);\r\n            arc.mesh.geometry.setFromPoints(points);\r\n            arc.mesh.geometry.attributes.position.needsUpdate = true;\r\n        });\r\n    }\r\n    \r\n    updateQuantumFluxAnomaly(anomaly, deltaTime) {\r\n        // Animate rotating frames\r\n        anomaly.frames.forEach(frame => {\r\n            // Rotate around custom axis\r\n            const rotationMatrix = new THREE.Matrix4().makeRotationAxis(\r\n                frame.rotationAxis,\r\n                frame.rotationSpeed * deltaTime\r\n            );\r\n            frame.mesh.applyMatrix4(rotationMatrix);\r\n            \r\n            // Also rotate the inner box if it exists\r\n            if (frame.innerBox) {\r\n                frame.innerBox.applyMatrix4(rotationMatrix);\r\n            }\r\n            \r\n            // Pulse effect\r\n            frame.pulsePhase += deltaTime;\r\n            const pulseScale = 1.0 + 0.05 * Math.sin(frame.pulsePhase);\r\n            frame.mesh.scale.set(pulseScale, pulseScale, pulseScale);\r\n            \r\n            // Also pulse the inner box if it exists\r\n            if (frame.innerBox) {\r\n                frame.innerBox.scale.set(pulseScale, pulseScale, pulseScale);\r\n            }\r\n        });\r\n        \r\n        // Animate particles\r\n        const positions = anomaly.particles.positions;\r\n        const velocities = anomaly.particles.velocities;\r\n        \r\n        for (let i = 0; i < positions.length / 3; i++) {\r\n            const i3 = i * 3;\r\n            \r\n            // Update position based on velocity\r\n            positions[i3] += velocities[i].x;\r\n            positions[i3 + 1] += velocities[i].y;\r\n            positions[i3 + 2] += velocities[i].z;\r\n            \r\n            // Contain particles within the inner cube\r\n            const maxDist = 120;\r\n            const pos = new THREE.Vector3(positions[i3], positions[i3 + 1], positions[i3 + 2]);\r\n            \r\n            if (pos.length() > maxDist) {\r\n                // Reflect particles at boundary\r\n                pos.normalize().multiplyScalar(maxDist);\r\n                positions[i3] = pos.x;\r\n                positions[i3 + 1] = pos.y;\r\n                positions[i3 + 2] = pos.z;\r\n                \r\n                // Reflect velocity\r\n                velocities[i].reflect(pos.normalize());\r\n            }\r\n        }\r\n        \r\n        // Update the geometry\r\n        anomaly.particles.mesh.geometry.attributes.position.needsUpdate = true;\r\n    }\r\n    \r\n    updateDarkMatterAnomaly(anomaly, deltaTime) {\r\n        // Animate core\r\n        anomaly.core.pulsePhase += deltaTime * 0.5;\r\n        const corePulse = 1.0 + 0.1 * Math.sin(anomaly.core.pulsePhase);\r\n        anomaly.core.mesh.scale.set(corePulse, corePulse, corePulse);\r\n        \r\n        // Animate rings\r\n        anomaly.rings.forEach(ring => {\r\n            // Rotate along custom axis\r\n            const rotationMatrix = new THREE.Matrix4().makeRotationAxis(\r\n                ring.rotationAxis,\r\n                ring.rotationSpeed * deltaTime\r\n            );\r\n            ring.mesh.applyMatrix4(rotationMatrix);\r\n            \r\n            // Warp effect\r\n            ring.warpPhase += deltaTime * ring.warpSpeed;\r\n            const warpX = 1.0 + 0.1 * Math.sin(ring.warpPhase);\r\n            const warpY = 1.0 + 0.1 * Math.sin(ring.warpPhase + Math.PI/3);\r\n            const warpZ = 1.0 + 0.1 * Math.sin(ring.warpPhase + Math.PI*2/3);\r\n            ring.mesh.scale.set(warpX, warpY, warpZ);\r\n        });\r\n        \r\n        // Animate particles\r\n        const positions = anomaly.particles.positions;\r\n        const initialPositions = anomaly.particles.initialPositions;\r\n        const phases = anomaly.particles.phases;\r\n        \r\n        for (let i = 0; i < positions.length / 3; i++) {\r\n            const i3 = i * 3;\r\n            \r\n            // Update phase\r\n            phases[i] += deltaTime;\r\n            \r\n            // Create gravitational distortion effect\r\n            const dist = Math.sqrt(\r\n                initialPositions[i3] * initialPositions[i3] +\r\n                initialPositions[i3 + 1] * initialPositions[i3 + 1] +\r\n                initialPositions[i3 + 2] * initialPositions[i3 + 2]\r\n            );\r\n            \r\n            const orbitSpeed = 0.5 + (300 / (dist + 10)); // Faster closer to center\r\n            phases[i] += deltaTime * orbitSpeed;\r\n            \r\n            // Create orbiting motion with radial oscillation\r\n            const radialPulse = 1.0 + 0.2 * Math.sin(phases[i] * 0.5);\r\n            \r\n            // Apply the distortion\r\n            const pos = new THREE.Vector3(\r\n                initialPositions[i3],\r\n                initialPositions[i3 + 1],\r\n                initialPositions[i3 + 2]\r\n            );\r\n            \r\n            // Rotate based on phase\r\n            const rotY = phases[i] * 0.2;\r\n            const rotZ = phases[i] * 0.1;\r\n            \r\n            pos.applyAxisAngle(new THREE.Vector3(0, 1, 0), rotY);\r\n            pos.applyAxisAngle(new THREE.Vector3(0, 0, 1), rotZ);\r\n            \r\n            // Apply radial pulse\r\n            pos.multiplyScalar(radialPulse);\r\n            \r\n            positions[i3] = pos.x;\r\n            positions[i3 + 1] = pos.y;\r\n            positions[i3 + 2] = pos.z;\r\n        }\r\n        \r\n        // Update the geometry\r\n        anomaly.particles.mesh.geometry.attributes.position.needsUpdate = true;\r\n    }\r\n    \r\n    updateForSystem(systemData) {\r\n        console.log(\"Updating space anomalies for new star system\");\r\n        \r\n        // Clear any existing anomalies\r\n        this.clearAllAnomalies();\r\n        \r\n        // Reset the timer to immediately check for spawning in the new system\r\n        this.spawnTimer = this.checkInterval;\r\n        \r\n        // Update HUD\r\n        this.updateAnomalyCountDisplay();\r\n    }\r\n    \r\n    clearAllAnomalies() {\r\n        // Clone the array to avoid modification during iteration\r\n        const anomaliesToRemove = [...this.anomalies];\r\n        \r\n        // Remove each anomaly\r\n        anomaliesToRemove.forEach(anomaly => {\r\n            this.despawnAnomaly(anomaly);\r\n        });\r\n        \r\n        // Ensure the array is empty\r\n        this.anomalies = [];\r\n        \r\n        // Update HUD\r\n        this.updateAnomalyCountDisplay();\r\n    }\r\n} ","// environment.js - Main environment class that integrates all environment components\r\n\r\nimport { Skybox } from './environment/skybox.js';\r\nimport { Sun } from './environment/sun.js';\r\nimport { Planets } from './environment/planets.js';\r\nimport { AsteroidBelt } from './environment/asteroidBelt.js';\r\nimport { Stargate } from './environment/stargate.js';\r\nimport { StarSystemGenerator } from './environment/starSystemGenerator.js';\r\nimport { SystemTransition } from './environment/systemTransition.js';\r\nimport { CustomSystemCreator } from './ui/customSystemCreator.js';\r\nimport { VibeVersePortals } from './environment/vibeVersePortals.js';\r\nimport { SpaceAnomalies } from './environment/spaceAnomalies.js';\r\n\r\nexport class Environment {\r\n    constructor(scene) {\r\n        this.scene = scene;\r\n        this.planetRegions = {};\r\n        this.currentSystemId = 'Solar System'; // Default starting system\r\n        this.componentsLoaded = false;\r\n        \r\n        console.log(\"Initializing essential environment components...\");\r\n        \r\n        // Initialize only essential components first\r\n        this.skybox = new Skybox(scene);\r\n        this.sun = new Sun(scene);\r\n        \r\n        // Initialize star system generator\r\n        this.starSystemGenerator = new StarSystemGenerator(scene);\r\n        \r\n        // Initialize planets with reference to starSystemGenerator - needed for basic gameplay\r\n        this.planets = new Planets(scene, this.starSystemGenerator);\r\n        \r\n        // Initialize stargate - needed for docking UI\r\n        this.stargate = new Stargate(scene);\r\n        \r\n        // Store references for easier access\r\n        this.asteroids = [];\r\n        \r\n        // Setup initial regions for location tracking (minimal setup)\r\n        this.setupInitialRegions();\r\n        \r\n        console.log(\"Essential environment components initialized\");\r\n        \r\n        // Schedule loading of remaining components after a short delay to not block startup\r\n        setTimeout(() => {\r\n            this.loadRemainingComponents();\r\n        }, 500);\r\n    }\r\n    \r\n    // Load remaining non-essential components asynchronously\r\n    loadRemainingComponents() {\r\n        console.log(\"Loading remaining environment components...\");\r\n        \r\n        // Initialize asteroid belt - slightly defer to prioritize UI loading\r\n        this.asteroidBelt = new AsteroidBelt(this.scene);\r\n        this.asteroids = this.asteroidBelt.getAsteroids();\r\n        \r\n        // Initialize space anomalies\r\n        this.spaceAnomalies = new SpaceAnomalies(this.scene);\r\n        \r\n        // Initialize system transition effects\r\n        this.systemTransition = new SystemTransition(this.scene, this.scene.camera);\r\n        \r\n        // Initialize the custom system creator\r\n        this.customSystemCreator = new CustomSystemCreator(this.starSystemGenerator, this);\r\n        console.log(\"Custom system creator initialized:\", this.customSystemCreator);\r\n        \r\n        // Setup complete regions now that all components are loaded\r\n        this.setupRegions();\r\n        \r\n        // Setup event handlers for star system transitions\r\n        this.setupSystemTransitionHandlers();\r\n        \r\n        this.componentsLoaded = true;\r\n        console.log(\"All environment components initialized\");\r\n    }\r\n    \r\n    // Basic region setup for essential components only\r\n    setupInitialRegions() {\r\n        console.log(\"Setting up essential environment regions\");\r\n        \r\n        // Initialize the planetRegions object\r\n        this.planetRegions = {};\r\n        \r\n        // Safely get planet regions if the method exists\r\n        if (this.planets && typeof this.planets.getPlanetRegions === 'function') {\r\n            try {\r\n                this.planetRegions = this.planets.getPlanetRegions();\r\n            } catch (error) {\r\n                console.warn(\"Error getting planet regions:\", error);\r\n            }\r\n        } else {\r\n            console.warn(\"planets.getPlanetRegions is not available, using empty object instead\");\r\n        }\r\n        \r\n        // Add sun region\r\n        this.planetRegions[\"Sun\"] = {\r\n            center: this.sun.getPosition(),\r\n            radius: this.sun.getRadius()\r\n        };\r\n        \r\n        // Add stargate region\r\n        const stargateRegion = this.stargate.getRegionInfo();\r\n        this.planetRegions[\"Stargate\"] = {\r\n            center: stargateRegion.center,\r\n            radius: stargateRegion.radius\r\n        };\r\n    }\r\n    \r\n    // Called after spaceship is created - we need this to initialize portals\r\n    setSpaceship(spaceship) {\r\n        this.spaceship = spaceship;\r\n        \r\n        // Initialize VibeVerse portals\r\n        this.vibeVersePortals = new VibeVersePortals(this.scene, spaceship);\r\n        console.log(\"VibeVerse portals initialized\");\r\n    }\r\n    \r\n    // Set up handlers for star system transitions\r\n    setupSystemTransitionHandlers() {\r\n        // Apply resource multipliers from current system to asteroid belt\r\n        if (this.starSystemGenerator && this.asteroidBelt) {\r\n            const resources = this.starSystemGenerator.getCurrentSystemResources();\r\n            this.asteroidBelt.setResourceMultipliers(resources);\r\n        }\r\n    }\r\n    \r\n    // Travel to a new star system\r\n    travelToSystem(systemId) {\r\n        if (!this.starSystemGenerator || !this.systemTransition) return false;\r\n        \r\n        // Check if the system exists and is connected to the current one\r\n        if (!this.starSystemGenerator.travelToSystem(systemId)) {\r\n            console.error(`Cannot travel to system ${systemId}`);\r\n            return false;\r\n        }\r\n        \r\n        console.log(`Starting transition to system: ${systemId}`);\r\n        \r\n        // Start the transition effect\r\n        this.systemTransition.startTransition(() => {\r\n            // This callback is called when transition is complete\r\n            console.log(`Transition complete, updating environment for: ${systemId}`);\r\n            \r\n            // Update the environment based on the new system\r\n            this.updateEnvironmentForSystem(systemId);\r\n            \r\n            // Display welcome notification\r\n            this.showSystemWelcomeNotification(systemId);\r\n            \r\n            // If player is docked, make sure the stargate interface is correctly displayed\r\n            if (window.game && window.game.spaceship && window.game.spaceship.isDocked) {\r\n                console.log(\"Player is docked after arriving in new system, showing interface\");\r\n                \r\n                // Handle docking system to enforce proper dock state\r\n                if (window.game.controls && window.game.controls.dockingSystem) {\r\n                    setTimeout(() => {\r\n                        // Trigger the docking system's docking method directly\r\n                        window.game.controls.dockingSystem.dockWithStargate();\r\n                    }, 500); // Small delay to ensure everything is ready\r\n                }\r\n            }\r\n        });\r\n        \r\n        return true;\r\n    }\r\n    \r\n    // Update environment visuals and properties for the new system\r\n    updateEnvironmentForSystem(systemId) {\r\n        const systemData = this.starSystemGenerator.getAllSystems()[systemId];\r\n        if (!systemData) {\r\n            console.error(`No system data found for ${systemId}`);\r\n            return;\r\n        }\r\n        \r\n        console.log(`Updating environment for system: ${systemId}`, systemData);\r\n        \r\n        // Update current system ID\r\n        this.currentSystemId = systemId;\r\n        \r\n        // Update skybox based on system properties\r\n        if (this.skybox && this.skybox.updateForSystem) {\r\n            // Special case for Solar System - always enforce white skybox\r\n            if (systemId === 'Solar System') {\r\n                const solarSystemParams = {\r\n                    starDensity: 1.0,\r\n                    nebulaDensity: 0.5,\r\n                    color: 0xFFFFFF,  // Ensure white color for Solar System\r\n                    isSolarSystem: true,  // Flag this as Solar System\r\n                    resetTime: true  // Reset the time for consistent appearance\r\n                };\r\n                console.log(`Updating skybox for Solar System with enforced white color`);\r\n                this.skybox.updateForSystem(solarSystemParams);\r\n            } else {\r\n                console.log(`Updating skybox for ${systemId} with params:`, systemData.skyboxParams);\r\n                this.skybox.updateForSystem(systemData.skyboxParams);\r\n            }\r\n        } else {\r\n            console.warn(\"Skybox or updateForSystem method not available\");\r\n        }\r\n        \r\n        // Update star (sun) color and properties\r\n        if (this.sun) {\r\n            // First check if it's a custom system with an intensity multiplier\r\n            const lightIntensityMultiplier = systemData.lightIntensityMultiplier || 1.0;\r\n            \r\n            // Check which update method to use\r\n            if (this.sun.updateSunType && systemData.starClass) {\r\n                console.log(`Updating sun type for ${systemId} to ${systemData.starClass} with intensity multiplier: ${lightIntensityMultiplier}`);\r\n                this.sun.updateSunType(systemData.starClass, lightIntensityMultiplier);\r\n            } else if (this.sun.updateColor) {\r\n                console.log(`Updating sun color for ${systemId} to:`, systemData.starColor.toString(16));\r\n                this.sun.updateColor(systemData.starColor);\r\n                \r\n                // Store the multiplier for use in the update method\r\n                if (this.sun.sunLight) {\r\n                    this.sun.sunLight._intensityMultiplier = lightIntensityMultiplier;\r\n                }\r\n            } else {\r\n                console.warn(\"Sun update methods not available\");\r\n            }\r\n        } else {\r\n            console.warn(\"Sun not available\");\r\n        }\r\n        \r\n        // Update planets for this system\r\n        if (this.planets && this.planets.updateForSystem) {\r\n            console.log(`Updating planets for ${systemId}`);\r\n            this.planets.updateForSystem(systemId);\r\n            \r\n            // Safely update planet regions if the method exists\r\n            if (typeof this.planets.getPlanetRegions === 'function') {\r\n                try {\r\n                    this.planetRegions = this.planets.getPlanetRegions();\r\n                } catch (error) {\r\n                    console.warn(`Error getting planet regions for system ${systemId}:`, error);\r\n                }\r\n            } else {\r\n                console.warn(`planets.getPlanetRegions is not available for system ${systemId}`);\r\n            }\r\n        } else {\r\n            console.warn(\"Planets or updateForSystem method not available\");\r\n        }\r\n        \r\n        // Update asteroid belt based on system properties\r\n        if (this.asteroidBelt && this.asteroidBelt.setResourceMultipliers) {\r\n            // Apply resource multipliers from system\r\n            console.log(`Updating asteroid resources for ${systemId}:`, systemData.resourceMultipliers);\r\n            this.asteroidBelt.setResourceMultipliers(systemData.resourceMultipliers);\r\n            \r\n            // Update asteroid density if the method exists\r\n            if (this.asteroidBelt.updateDensity) {\r\n                console.log(`Updating asteroid density for ${systemId}:`, systemData.asteroidDensity);\r\n                this.asteroidBelt.updateDensity(systemData.asteroidDensity);\r\n            }\r\n        } else {\r\n            console.warn(\"AsteroidBelt or update methods not available\");\r\n        }\r\n        \r\n        // Update space anomalies for this system\r\n        if (this.spaceAnomalies && this.spaceAnomalies.updateForSystem) {\r\n            console.log(`Updating space anomalies for ${systemId}`);\r\n            this.spaceAnomalies.updateForSystem(systemData);\r\n        } else {\r\n            console.warn(\"SpaceAnomalies or updateForSystem method not available\");\r\n        }\r\n        \r\n        console.log(`Environment updated for ${systemId}`);\r\n    }\r\n    \r\n    // Show welcome notification when arriving at a new system\r\n    showSystemWelcomeNotification(systemId) {\r\n        const system = this.starSystemGenerator.getAllSystems()[systemId];\r\n        if (!system) return;\r\n        \r\n        // Create welcome notification\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = '25%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#fff';\r\n        notification.style.padding = '20px 40px';\r\n        notification.style.borderRadius = '10px';\r\n        notification.style.border = `2px solid #${system.starColor.toString(16).padStart(6, '0')}`;\r\n        notification.style.boxShadow = `0 0 30px #${system.starColor.toString(16).padStart(6, '0')}`;\r\n        notification.style.fontFamily = 'Courier New, monospace';\r\n        notification.style.fontSize = '18px';\r\n        notification.style.zIndex = '9999';\r\n        notification.style.textAlign = 'center';\r\n        \r\n        // Special welcome for Earth/Solar System\r\n        if (systemId === 'Solar System') {\r\n            notification.innerHTML = `\r\n                <h2 style=\"color: #30cfd0; margin-top: 0;\">Welcome to the Solar System</h2>\r\n                <p>Your home system, with Earth as your starting location.</p>\r\n                <p style=\"font-size: 14px; margin-bottom: 0; color: #aaa;\">Safe travels, commander.</p>\r\n            `;\r\n        } else {\r\n            notification.innerHTML = `\r\n                <h2 style=\"color: #${system.starColor.toString(16).padStart(6, '0')}; margin-top: 0;\">Welcome to ${system.name}</h2>\r\n                <p>${system.description}</p>\r\n                <p style=\"font-size: 14px; margin-bottom: 0; color: #aaa;\">Classification: ${system.classification} - Star Class: ${system.starClass}</p>\r\n            `;\r\n        }\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(notification);\r\n        \r\n        // Remove after a few seconds\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 1s';\r\n            \r\n            setTimeout(() => {\r\n                notification.remove();\r\n            }, 1000);\r\n        }, 5000);\r\n    }\r\n    \r\n    setupRegions() {\r\n        console.log(\"Setting up environment regions\");\r\n        \r\n        // Initialize or reset the planetRegions object\r\n        this.planetRegions = {};\r\n        \r\n        // Safely get planet regions if the method exists\r\n        if (this.planets && typeof this.planets.getPlanetRegions === 'function') {\r\n            try {\r\n                this.planetRegions = this.planets.getPlanetRegions();\r\n            } catch (error) {\r\n                console.warn(\"Error getting planet regions in setupRegions:\", error);\r\n            }\r\n        } else {\r\n            console.warn(\"planets.getPlanetRegions is not available in setupRegions, using empty object\");\r\n        }\r\n        \r\n        // Add sun region\r\n        this.planetRegions[\"Sun\"] = {\r\n            center: this.sun.getPosition(),\r\n            radius: this.sun.getRadius()\r\n        };\r\n        \r\n        // Add asteroid belt region\r\n        const asteroidBeltRegion = this.asteroidBelt.getRegionInfo();\r\n        this.planetRegions[\"Asteroid Belt\"] = {\r\n            center: asteroidBeltRegion.center,\r\n            minRadius: asteroidBeltRegion.innerRadius,\r\n            maxRadius: asteroidBeltRegion.outerRadius\r\n        };\r\n        \r\n        // Add stargate region\r\n        const stargateRegion = this.stargate.getRegionInfo();\r\n        this.planetRegions[\"Stargate\"] = {\r\n            center: stargateRegion.center,\r\n            radius: stargateRegion.radius\r\n        };\r\n        \r\n        // Add space anomalies region\r\n        const anomaliesRegion = this.spaceAnomalies.getRegionInfo();\r\n        this.planetRegions[\"Space Anomalies\"] = {\r\n            center: anomaliesRegion.center,\r\n            minRadius: anomaliesRegion.innerRadius,\r\n            maxRadius: anomaliesRegion.outerRadius\r\n        };\r\n    }\r\n    \r\n    // Get the player's current location based on position\r\n    getPlayerLocation(playerPosition) {\r\n        if (!playerPosition) {\r\n            return \"Unknown Location\";\r\n        }\r\n        \r\n        // Check if near stargate\r\n        const stargateRegion = this.planetRegions[\"Stargate\"];\r\n        if (stargateRegion) {\r\n            const distanceToStargate = playerPosition.distanceTo(stargateRegion.center);\r\n            if (distanceToStargate <= stargateRegion.radius) {\r\n                return \"Stargate\";\r\n            }\r\n        }\r\n        \r\n        // Check if near an anomaly - only if spaceAnomalies is loaded\r\n        if (this.componentsLoaded && this.spaceAnomalies) {\r\n            const closestAnomaly = this.spaceAnomalies.findClosestAnomaly(playerPosition, 2000);\r\n            if (closestAnomaly) {\r\n                const distance = playerPosition.distanceTo(closestAnomaly.position);\r\n                if (distance < 800) {\r\n                    let anomalyType = '';\r\n                    switch (closestAnomaly.type) {\r\n                        case 'vortex':\r\n                            anomalyType = 'Vortex';\r\n                            break;\r\n                        case 'crystalCluster':\r\n                            anomalyType = 'Crystal Cluster';\r\n                            break;\r\n                        case 'nebulaNexus':\r\n                            anomalyType = 'Nebula Nexus';\r\n                            break;\r\n                        case 'quantumFlux':\r\n                            anomalyType = 'Quantum Flux';\r\n                            break;\r\n                        case 'darkMatter':\r\n                            anomalyType = 'Dark Matter';\r\n                            break;\r\n                    }\r\n                    \r\n                    // Indicate if orb is still available\r\n                    const orbStatus = closestAnomaly.orbCollected ? 'Depleted' : 'Active';\r\n                    return `${anomalyType} Anomaly (${orbStatus})`;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Check planets\r\n        for (const [name, region] of Object.entries(this.planetRegions)) {\r\n            if (name === \"Asteroid Belt\" && this.componentsLoaded && this.asteroidBelt) {\r\n                // Special case for asteroid belt - only if loaded\r\n                const distance = playerPosition.distanceTo(region.center);\r\n                if (region.minRadius && region.maxRadius && \r\n                    distance >= region.minRadius && \r\n                    distance <= region.maxRadius) {\r\n                    // Count nearby asteroids (useful for mining)\r\n                    const nearbyAsteroids = this.asteroids.filter(asteroid => {\r\n                        return playerPosition.distanceTo(asteroid.mesh.position) < 500;\r\n                    });\r\n                    \r\n                    if (nearbyAsteroids.length > 0) {\r\n                        return `Asteroid Field (${nearbyAsteroids.length} nearby)`;\r\n                    }\r\n                    return \"Asteroid Belt\";\r\n                }\r\n            } else if (name === \"Space Anomalies\" && this.componentsLoaded) {\r\n                // Special case for space anomalies region - only if loaded\r\n                const distance = playerPosition.distanceTo(region.center);\r\n                if (region.minRadius && region.maxRadius && \r\n                    distance >= region.minRadius && \r\n                    distance <= region.maxRadius) {\r\n                    return \"Space Anomaly Field\";\r\n                }\r\n            } else if (name !== \"Sun\" && name !== \"Stargate\" && region.center && region.radius) {\r\n                const distance = playerPosition.distanceTo(region.center);\r\n                if (distance <= region.radius) {\r\n                    return `Near ${name}`;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Check sun\r\n        const sunRegion = this.planetRegions[\"Sun\"];\r\n        if (sunRegion) {\r\n            const distanceToSun = playerPosition.distanceTo(sunRegion.center);\r\n            if (distanceToSun <= sunRegion.radius) {\r\n            return \"Near Sun\";\r\n            }\r\n        }\r\n        \r\n        // Deep space\r\n        return \"Deep Space\";\r\n    }\r\n    \r\n    // Find the closest asteroid to a position\r\n    findClosestAsteroid(position, maxDistance) {\r\n        if (this.componentsLoaded && this.asteroidBelt && this.asteroidBelt.findClosestAsteroid) {\r\n            return this.asteroidBelt.findClosestAsteroid(position, maxDistance);\r\n        }\r\n        return null;\r\n    }\r\n    \r\n    // Find the closest space anomaly\r\n    findClosestAnomaly(position, maxDistance) {\r\n        if (this.componentsLoaded && this.spaceAnomalies && this.spaceAnomalies.findClosestAnomaly) {\r\n            return this.spaceAnomalies.findClosestAnomaly(position, maxDistance);\r\n        }\r\n        return null;\r\n    }\r\n    \r\n    // Check if position collides with any anomaly\r\n    checkAnomalyCollision(position) {\r\n        if (!this.componentsLoaded || !this.spaceAnomalies) return null;\r\n        \r\n        const closestAnomaly = this.spaceAnomalies.findClosestAnomaly(position, 8000);\r\n        if (closestAnomaly && this.spaceAnomalies.checkCollision(position, closestAnomaly)) {\r\n            return closestAnomaly;\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    // Collect energy orb from anomaly\r\n    collectAnomalyOrb(anomaly) {\r\n        if (this.componentsLoaded && this.spaceAnomalies && this.spaceAnomalies.collectOrb) {\r\n            return this.spaceAnomalies.collectOrb(anomaly);\r\n        }\r\n    }\r\n    \r\n    update(deltaTime = 0.016, camera) {\r\n        // Update skybox if it has an update method\r\n        if (this.skybox && typeof this.skybox.update === 'function') {\r\n            this.skybox.update(deltaTime);\r\n        }\r\n        \r\n        // Update sun if it has an update method\r\n        if (this.sun && typeof this.sun.update === 'function') {\r\n            this.sun.update(deltaTime);\r\n        }\r\n        \r\n        // Update planets if they have an update method\r\n        if (this.planets && typeof this.planets.update === 'function') {\r\n            this.planets.update(deltaTime);\r\n        }\r\n        \r\n        // Update system transition effects if active - this needs to run regardless of componentsLoaded\r\n        if (this.systemTransition && typeof this.systemTransition.update === 'function') {\r\n            this.systemTransition.update(deltaTime);\r\n        }\r\n        \r\n        // Only update non-essential components if they're loaded\r\n        if (this.componentsLoaded) {\r\n            // Update asteroids\r\n            if (this.asteroidBelt && typeof this.asteroidBelt.update === 'function') {\r\n                this.asteroidBelt.update(deltaTime);\r\n            }\r\n            \r\n            // Update stargate\r\n            if (this.stargate && typeof this.stargate.update === 'function') {\r\n                this.stargate.update(deltaTime);\r\n            }\r\n            \r\n            // Update space anomalies\r\n            if (this.spaceAnomalies && typeof this.spaceAnomalies.update === 'function') {\r\n                this.spaceAnomalies.update(deltaTime, camera);\r\n            }\r\n            \r\n            // Update vibe verse portals\r\n            if (this.vibeVersePortals && typeof this.vibeVersePortals.update === 'function') {\r\n                this.vibeVersePortals.update(deltaTime);\r\n            }\r\n        }\r\n    }\r\n    \r\n    dispose() {\r\n        // Dispose all environment components\r\n        if (this.skybox) {\r\n            this.skybox.dispose();\r\n        }\r\n        \r\n        if (this.sun) {\r\n            this.sun.dispose();\r\n        }\r\n        \r\n        if (this.planets) {\r\n            this.planets.dispose();\r\n        }\r\n        \r\n        if (this.asteroidBelt) {\r\n            this.asteroidBelt.dispose();\r\n        }\r\n        \r\n        if (this.stargate) {\r\n            this.stargate.dispose();\r\n        }\r\n        \r\n        if (this.spaceAnomalies) {\r\n            this.spaceAnomalies.clearAllAnomalies();\r\n        }\r\n        \r\n        if (this.vibeVersePortals) {\r\n            this.vibeVersePortals.dispose();\r\n        }\r\n    }\r\n} ","// inputHandler.js - Handles keyboard and mouse input\r\n\r\nexport class InputHandler {\r\n    constructor(spaceship, physics) {\r\n        this.spaceship = spaceship;\r\n        this.physics = physics;\r\n        this.isPointerLocked = false;\r\n        this.mouseSensitivity = 0.001; // Lower sensitivity for more precise control\r\n        \r\n        this.setupKeyboardControls();\r\n        this.setupPointerLock();\r\n    }\r\n    \r\n    setupKeyboardControls() {\r\n        // Keyboard controls\r\n        document.addEventListener('keydown', e => {\r\n            // Ignore inputs when docked or intro sequence is active\r\n            if (this.spaceship.isDocked || (window.game && window.game.introSequenceActive)) return;\r\n            \r\n            switch (e.key.toLowerCase()) {\r\n                case 'w': window.inputIntent = (window.inputIntent||0) | 1; break;\r\n                case 's': window.inputIntent = (window.inputIntent||0) | 2; break;\r\n                case 'a': window.inputIntent = (window.inputIntent||0) | 4; break;\r\n                case 'd': window.inputIntent = (window.inputIntent||0) | 8; break;\r\n                case 'shift': window.inputIntent = (window.inputIntent||0) | 16; break;\r\n            }\r\n        });\r\n        \r\n        document.addEventListener('keyup', e => {\r\n            // Still process key up events when intro is active to prevent stuck keys\r\n            if (window.game && window.game.introSequenceActive) {\r\n                // Force reset all thrusters during intro sequence\r\n                this.spaceship.thrust.forward = false;\r\n                this.spaceship.thrust.backward = false;\r\n                this.spaceship.thrust.right = false;\r\n                this.spaceship.thrust.left = false;\r\n                this.spaceship.thrust.boost = false;\r\n                return;\r\n            }\r\n            \r\n            const clearBit = (bit) => { window.inputIntent = (window.inputIntent||0) & ~bit; };\r\n            switch (e.key.toLowerCase()) {\r\n                case 'w': clearBit(1); break;\r\n                case 's': clearBit(2); break;\r\n                case 'a': clearBit(4); break;\r\n                case 'd': clearBit(8); break;\r\n                case 'shift': clearBit(16); break;\r\n            }\r\n        });\r\n    }\r\n    \r\n    setupPointerLock() {\r\n        // Get the canvas element (it's the first canvas in the document)\r\n        const canvas = document.querySelector('canvas');\r\n        \r\n        // Request pointer lock when clicking on the canvas\r\n        canvas.addEventListener('pointerdown', (e) => {\r\n            e.preventDefault(); // Prevent default to avoid unwanted behavior\r\n            if (!this.isPointerLocked && !this.spaceship.isDocked) {\r\n                canvas.requestPointerLock();\r\n            }\r\n        });\r\n        \r\n        // Set up pointer lock change event\r\n        document.addEventListener('pointerlockchange', () => {\r\n            if (document.pointerLockElement === canvas) {\r\n                // Pointer is locked\r\n                this.isPointerLocked = true;\r\n                document.addEventListener('pointermove', this.handlePointerMove.bind(this));\r\n            } else {\r\n                // Pointer is unlocked\r\n                this.isPointerLocked = false;\r\n                document.removeEventListener('pointermove', this.handlePointerMove.bind(this));\r\n            }\r\n        });\r\n        \r\n        // Add instructions for pointer lock\r\n        const instructionsElement = document.createElement('div');\r\n        instructionsElement.id = 'pointer-lock-instructions';\r\n        instructionsElement.innerHTML = `\r\n            Click on the game to enable mouse rotation\r\n        `;\r\n        instructionsElement.style.position = 'absolute';\r\n        instructionsElement.style.top = '60px';\r\n        instructionsElement.style.left = '50%';\r\n        instructionsElement.style.transform = 'translateX(-50%)';\r\n        instructionsElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\r\n        instructionsElement.style.padding = '10px 20px';\r\n        instructionsElement.style.borderRadius = '20px';\r\n        instructionsElement.style.border = '1px solid #30cfd0';\r\n        instructionsElement.style.boxShadow = '0 0 10px #30cfd0';\r\n        instructionsElement.style.color = '#fff';\r\n        instructionsElement.style.fontFamily = 'Courier New, monospace';\r\n        instructionsElement.style.zIndex = '999';\r\n        instructionsElement.style.textAlign = 'center';\r\n        document.body.appendChild(instructionsElement);\r\n        \r\n        // Hide instructions when pointer is locked\r\n        document.addEventListener('pointerlockchange', () => {\r\n            instructionsElement.style.display = document.pointerLockElement ? 'none' : 'block';\r\n        });\r\n    }\r\n    \r\n    handlePointerMove(e) {\r\n        // Skip mouse movement handling during intro sequence\r\n        if (window.game && window.game.introSequenceActive) return;\r\n        \r\n        if (!this.isPointerLocked) return;\r\n        \r\n        // Use movementX and movementY for rotation\r\n        // These values represent the mouse movement since the last event\r\n        const movementX = e.movementX || 0;\r\n        const movementY = e.movementY || 0;\r\n        \r\n        // Update the physics rotation based on these movements\r\n        this.physics.updateRotation(\r\n            movementX * this.mouseSensitivity, \r\n            movementY * this.mouseSensitivity\r\n        );\r\n    }\r\n    \r\n    isLocked() {\r\n        return this.isPointerLocked;\r\n    }\r\n    \r\n    exitPointerLock() {\r\n        if (document.exitPointerLock) {\r\n            document.exitPointerLock();\r\n        }\r\n    }\r\n}","// gamepadHandler.js - Handles gamepad/controller input\r\n// Supports Xbox, PlayStation, and generic controllers\r\n\r\nexport class GamepadHandler {\r\n    constructor(spaceship, physics, controls) {\r\n        this.spaceship = spaceship;\r\n        this.physics = physics;\r\n        this.controls = controls; // Reference to main controls for mining/targeting/etc\r\n        \r\n        // Gamepad state\r\n        this.gamepads = {};\r\n        this.activeGamepadIndex = null;\r\n        this.enabled = true;\r\n        this.vibrationEnabled = true;\r\n        \r\n        // Dead zones for analog sticks (prevents drift)\r\n        this.deadZone = 0.15;\r\n        this.triggerDeadZone = 0.15; // Increased to prevent accidental activation\r\n        \r\n        // Sensitivity settings\r\n        this.lookSensitivity = 1.0;  // Right stick look sensitivity (reduced from 2.0)\r\n        this.movementSensitivity = 1.0;  // Left stick movement sensitivity\r\n        \r\n        // Smoothing for accurate aiming\r\n        this.rotationSmoothing = {\r\n            targetX: 0,\r\n            targetY: 0,\r\n            currentX: 0,\r\n            currentY: 0,\r\n            smoothingFactor: 0.15  // Lower = smoother, higher = more responsive\r\n        }\r\n        \r\n        // Button mapping (Xbox layout as default)\r\n        this.buttonMap = {\r\n            // Face buttons\r\n            A: 0,          // Jump/Accept\r\n            B: 1,          // Cancel/Back\r\n            X: 2,          // Reload/Interact\r\n            Y: 3,          // Switch weapon\r\n            \r\n            // Bumpers and triggers\r\n            LB: 4,         // Previous target\r\n            RB: 5,         // Next target\r\n            LT: 6,         // Mining laser\r\n            RT: 7,         // Fire weapon\r\n            \r\n            // Special buttons\r\n            BACK: 8,       // Menu/Settings\r\n            START: 9,      // Pause\r\n            L3: 10,        // Left stick click - boost\r\n            R3: 11,        // Right stick click - toggle targeting\r\n            \r\n            // D-Pad\r\n            DPAD_UP: 12,   // Deploy turret\r\n            DPAD_DOWN: 13, // Deploy shield\r\n            DPAD_LEFT: 14, // Previous weapon\r\n            DPAD_RIGHT: 15 // Next weapon\r\n        };\r\n        \r\n        // Axis mapping\r\n        this.axisMap = {\r\n            LEFT_STICK_X: 0,   // Strafe left/right\r\n            LEFT_STICK_Y: 1,   // Move forward/backward\r\n            RIGHT_STICK_X: 2,  // Look left/right (yaw)\r\n            RIGHT_STICK_Y: 3,  // Look up/down (pitch)\r\n            LT: 4,             // Left trigger (some controllers)\r\n            RT: 5              // Right trigger (some controllers)\r\n        };\r\n        \r\n        // Button state tracking (for press/release detection)\r\n        this.buttonStates = {};\r\n        this.previousButtonStates = {};\r\n        \r\n        // Trigger states for firing\r\n        this.wasFiring = false;\r\n        \r\n        // Initialize controller support\r\n        this.init();\r\n        \r\n        // Debug mode for testing\r\n        this.debugMode = false; // Disabled now that we found the correct mapping\r\n        this.debugDisplay = null;\r\n    }\r\n    \r\n    init() {\r\n        // Check for gamepad support\r\n        if (!('getGamepads' in navigator)) {\r\n            console.warn('Gamepad API not supported in this browser');\r\n            return;\r\n        }\r\n        \r\n        // Listen for gamepad connections\r\n        window.addEventListener('gamepadconnected', (e) => {\r\n            console.log(`Gamepad connected: ${e.gamepad.id} (index: ${e.gamepad.index})`);\r\n            this.onGamepadConnected(e.gamepad);\r\n        });\r\n        \r\n        // Listen for gamepad disconnections\r\n        window.addEventListener('gamepaddisconnected', (e) => {\r\n            console.log(`Gamepad disconnected: ${e.gamepad.id} (index: ${e.gamepad.index})`);\r\n            this.onGamepadDisconnected(e.gamepad);\r\n        });\r\n        \r\n        // Check for already connected gamepads\r\n        this.scanForGamepads();\r\n        \r\n        console.log('Gamepad handler initialized - ready for controller input');\r\n    }\r\n    \r\n    scanForGamepads() {\r\n        const gamepads = navigator.getGamepads();\r\n        for (let i = 0; i < gamepads.length; i++) {\r\n            if (gamepads[i]) {\r\n                this.onGamepadConnected(gamepads[i]);\r\n            }\r\n        }\r\n    }\r\n    \r\n    onGamepadConnected(gamepad) {\r\n        this.gamepads[gamepad.index] = gamepad;\r\n        \r\n        // Set as active if no active gamepad\r\n        if (this.activeGamepadIndex === null) {\r\n            this.activeGamepadIndex = gamepad.index;\r\n            this.showNotification(`Controller connected: ${this.getGamepadName(gamepad)}`);\r\n            \r\n            // Vibrate to confirm connection\r\n            this.vibrate(0.3, 200);\r\n        }\r\n    }\r\n    \r\n    onGamepadDisconnected(gamepad) {\r\n        delete this.gamepads[gamepad.index];\r\n        \r\n        // If this was the active gamepad, find another\r\n        if (this.activeGamepadIndex === gamepad.index) {\r\n            this.activeGamepadIndex = null;\r\n            this.showNotification('Controller disconnected');\r\n            \r\n            // Try to find another connected gamepad\r\n            for (let index in this.gamepads) {\r\n                this.activeGamepadIndex = parseInt(index);\r\n                this.showNotification(`Switched to controller: ${this.getGamepadName(this.gamepads[index])}`);\r\n                break;\r\n            }\r\n        }\r\n    }\r\n    \r\n    getGamepadName(gamepad) {\r\n        // Simplify gamepad names for display\r\n        const name = gamepad.id.toLowerCase();\r\n        if (name.includes('xbox')) return 'Xbox Controller';\r\n        if (name.includes('playstation') || name.includes('dualshock')) return 'PlayStation Controller';\r\n        if (name.includes('switch') || name.includes('pro controller')) return 'Switch Pro Controller';\r\n        return 'Generic Controller';\r\n    }\r\n    \r\n    update(deltaTime) {\r\n        if (!this.enabled || this.activeGamepadIndex === null) return;\r\n        \r\n        // Get fresh gamepad state (must call this each frame)\r\n        const gamepads = navigator.getGamepads();\r\n        const gamepad = gamepads[this.activeGamepadIndex];\r\n        \r\n        if (!gamepad) return;\r\n        \r\n        // Update debug display if enabled\r\n        if (this.debugMode) {\r\n            this.updateDebugDisplay(gamepad);\r\n        }\r\n        \r\n        // Skip input during intro sequence or when docked\r\n        if ((window.game && window.game.introSequenceActive) || this.spaceship.isDocked) {\r\n            // Reset all controls\r\n            this.resetControls();\r\n            return;\r\n        }\r\n        \r\n        // Store previous button states for edge detection\r\n        this.previousButtonStates = {...this.buttonStates};\r\n        \r\n        // Update current button states\r\n        gamepad.buttons.forEach((button, index) => {\r\n            this.buttonStates[index] = button.pressed;\r\n        });\r\n        \r\n        // Handle movement (left stick)\r\n        this.handleMovement(gamepad);\r\n        \r\n        // Handle camera look (right stick)\r\n        this.handleCameraLook(gamepad, deltaTime);\r\n        \r\n        // Handle buttons\r\n        this.handleButtons(gamepad);\r\n        \r\n        // Handle triggers\r\n        this.handleTriggers(gamepad);\r\n    }\r\n    \r\n    handleMovement(gamepad) {\r\n        // Left stick - movement\r\n        const leftX = this.applyDeadZone(gamepad.axes[this.axisMap.LEFT_STICK_X]);\r\n        const leftY = this.applyDeadZone(gamepad.axes[this.axisMap.LEFT_STICK_Y]);\r\n        \r\n        // Reset movement\r\n        this.spaceship.thrust.forward = false;\r\n        this.spaceship.thrust.backward = false;\r\n        this.spaceship.thrust.left = false;\r\n        this.spaceship.thrust.right = false;\r\n        \r\n        // Apply movement based on stick position\r\n        // Y-axis is inverted (up is negative)\r\n        if (leftY < -0.1) {\r\n            this.spaceship.thrust.forward = true;\r\n            this.spaceship.thrustPower = Math.abs(leftY); // Variable thrust\r\n        } else if (leftY > 0.1) {\r\n            this.spaceship.thrust.backward = true;\r\n            this.spaceship.thrustPower = Math.abs(leftY);\r\n        }\r\n        \r\n        // X-axis strafing\r\n        // FIXED: thrust.left actually moves RIGHT, thrust.right moves LEFT in physics\r\n        // So we need to reverse the mapping\r\n        if (leftX < -0.1) {\r\n            this.spaceship.thrust.right = true; // Left stick left = move left (uses right thrust)\r\n            this.spaceship.strafePower = Math.abs(leftX);\r\n        } else if (leftX > 0.1) {\r\n            this.spaceship.thrust.left = true; // Right stick right = move right (uses left thrust)\r\n            this.spaceship.strafePower = Math.abs(leftX);\r\n        }\r\n        \r\n        // Left stick click - boost\r\n        if (gamepad.buttons[this.buttonMap.L3].pressed) {\r\n            this.spaceship.thrust.boost = true;\r\n        } else {\r\n            this.spaceship.thrust.boost = false;\r\n        }\r\n    }\r\n    \r\n    handleCameraLook(gamepad, deltaTime) {\r\n        // YOUR CONTROLLER: Right stick is on axes 3 (horizontal) and 4 (vertical)\r\n        const rightStickX = this.applyDeadZone(gamepad.axes[3] || 0); // Horizontal movement\r\n        const rightStickY = this.applyDeadZone(gamepad.axes[4] || 0); // Vertical movement\r\n        \r\n        // Apply response curve for finer control\r\n        // This makes small movements even smaller (for precision aiming)\r\n        // and keeps large movements responsive (for quick turns)\r\n        const applyCurve = (value) => {\r\n            const sign = Math.sign(value);\r\n            const abs = Math.abs(value);\r\n            // Quadratic curve for the first 50%, linear for the rest\r\n            if (abs < 0.5) {\r\n                return sign * abs * abs * 2; // Quadratic (slower near center)\r\n            } else {\r\n                return sign * (abs * 0.5 + 0.25); // Linear (faster at edges)\r\n            }\r\n        };\r\n        \r\n        const curvedX = applyCurve(rightStickX);\r\n        const curvedY = applyCurve(rightStickY);\r\n        \r\n        // Update target rotation speeds\r\n        const baseSpeed = 0.0015; // Reduced base speed for better control\r\n        this.rotationSmoothing.targetX = curvedX * baseSpeed * this.lookSensitivity * 60;\r\n        this.rotationSmoothing.targetY = curvedY * baseSpeed * this.lookSensitivity * 60;\r\n        \r\n        // Apply exponential smoothing for smoother rotation\r\n        const smoothing = this.rotationSmoothing.smoothingFactor;\r\n        this.rotationSmoothing.currentX += (this.rotationSmoothing.targetX - this.rotationSmoothing.currentX) * smoothing;\r\n        this.rotationSmoothing.currentY += (this.rotationSmoothing.targetY - this.rotationSmoothing.currentY) * smoothing;\r\n        \r\n        // Only update rotation if there's meaningful input\r\n        if (Math.abs(this.rotationSmoothing.currentX) > 0.0001 || Math.abs(this.rotationSmoothing.currentY) > 0.0001) {\r\n            this.physics.updateRotation(this.rotationSmoothing.currentX, this.rotationSmoothing.currentY);\r\n        } else {\r\n            // Reset smoothing when stick is centered\r\n            this.rotationSmoothing.currentX = 0;\r\n            this.rotationSmoothing.currentY = 0;\r\n        }\r\n    }\r\n    \r\n    handleButtons(gamepad) {\r\n        // A button - Toggle targeting system\r\n        if (this.wasButtonPressed(this.buttonMap.A)) {\r\n            if (this.controls && this.controls.targetingSystem) {\r\n                this.controls.targetingSystem.toggleLockOn();\r\n            }\r\n        }\r\n        \r\n        // B button - Toggle mining (tap to start/stop)\r\n        if (this.wasButtonPressed(this.buttonMap.B)) {\r\n            if (this.controls && this.controls.miningSystem && this.controls.targetingSystem) {\r\n                if (this.controls.miningSystem.isMining) {\r\n                    // Currently mining - stop it\r\n                    this.controls.miningSystem.stopMining();\r\n                } else {\r\n                    // Not mining - try to start\r\n                    const target = this.controls.targetingSystem.getCurrentTarget();\r\n                    if (target) {\r\n                        this.controls.miningSystem.setTargetAsteroid(target);\r\n                        this.controls.miningSystem.startMining();\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        // X button - Dock when near stargate\r\n        if (this.wasButtonPressed(this.buttonMap.X)) {\r\n            if (this.controls && this.controls.dockingSystem && this.controls.dockingSystem.canDock()) {\r\n                this.controls.dockingSystem.initiateDocking();\r\n            }\r\n        }\r\n        \r\n        // Y button - Deploy turret\r\n        if (this.wasButtonPressed(this.buttonMap.Y)) {\r\n            if (window.game && window.game.deployTurret) {\r\n                window.game.deployTurret();\r\n            }\r\n        }\r\n        \r\n        // Bumpers - Cycle targets\r\n        if (this.wasButtonPressed(this.buttonMap.LB)) {\r\n            // Previous target\r\n            if (this.controls && this.controls.targetingSystem) {\r\n                this.controls.targetingSystem.cycleLockOnTarget(-1);\r\n            }\r\n        }\r\n        \r\n        if (this.wasButtonPressed(this.buttonMap.RB)) {\r\n            // Next target\r\n            if (this.controls && this.controls.targetingSystem) {\r\n                const target = this.controls.targetingSystem.cycleLockOnTarget(1);\r\n                if (target && this.controls.miningSystem) {\r\n                    this.controls.miningSystem.setTargetAsteroid(target);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Right stick click - Could be used for something else later\r\n        \r\n        // D-Pad for quick actions\r\n        if (this.wasButtonPressed(this.buttonMap.DPAD_UP)) {\r\n            // Deploy turret\r\n            if (window.game && window.game.deployTurret) {\r\n                window.game.deployTurret();\r\n            }\r\n        }\r\n        \r\n        if (this.wasButtonPressed(this.buttonMap.DPAD_DOWN)) {\r\n            // Deploy shield drone\r\n            if (window.game && window.game.deployShieldDrone) {\r\n                window.game.deployShieldDrone();\r\n            }\r\n        }\r\n        \r\n        // Start button - Pause/Menu\r\n        if (this.wasButtonPressed(this.buttonMap.START)) {\r\n            if (window.game && window.game.togglePause) {\r\n                window.game.togglePause();\r\n            }\r\n        }\r\n    }\r\n    \r\n    handleTriggers(gamepad) {\r\n        // Check triggers - most controllers use buttons 6 and 7\r\n        let rtValue = 0;\r\n        let ltValue = 0;\r\n        \r\n        // Standard button mapping for triggers\r\n        if (gamepad.buttons[7]) {\r\n            rtValue = gamepad.buttons[7].value;\r\n        }\r\n        if (gamepad.buttons[6]) {\r\n            ltValue = gamepad.buttons[6].value;\r\n        }\r\n        \r\n        // Some controllers report triggers as axes 4 and 5\r\n        const axis4 = gamepad.axes[4] || 0;\r\n        const axis5 = gamepad.axes[5] || 0;\r\n        if (rtValue < 0.01 && Math.abs(axis5) > 0.01) {\r\n            rtValue = (axis5 + 1) / 2; // Convert from -1,1 to 0,1\r\n        }\r\n        if (ltValue < 0.01 && Math.abs(axis4) > 0.01) {\r\n            ltValue = (axis4 + 1) / 2; // Convert from -1,1 to 0,1\r\n        }\r\n        \r\n        // RIGHT TRIGGER - Fire weapons\r\n        if (rtValue > this.triggerDeadZone) {\r\n            if (!this.wasFiring) {\r\n                // Start firing\r\n                if (window.game && window.game.combat) {\r\n                    window.game.combat.setFiring(true);\r\n                    this.wasFiring = true;\r\n                }\r\n            }\r\n        } else {\r\n            if (this.wasFiring) {\r\n                // Stop firing\r\n                if (window.game && window.game.combat) {\r\n                    window.game.combat.setFiring(false);\r\n                    this.wasFiring = false;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // LEFT TRIGGER - Alternative mining button (optional)\r\n        // Disabled for now to avoid conflicts - use B button instead\r\n    }\r\n    \r\n    applyDeadZone(value) {\r\n        if (Math.abs(value) < this.deadZone) {\r\n            return 0;\r\n        }\r\n        // Scale the value to use full range after dead zone\r\n        const sign = value > 0 ? 1 : -1;\r\n        return sign * ((Math.abs(value) - this.deadZone) / (1 - this.deadZone));\r\n    }\r\n    \r\n    wasButtonPressed(buttonIndex) {\r\n        // Returns true only on the frame the button was pressed (not held)\r\n        return this.buttonStates[buttonIndex] && !this.previousButtonStates[buttonIndex];\r\n    }\r\n    \r\n    wasButtonReleased(buttonIndex) {\r\n        // Returns true only on the frame the button was released\r\n        return !this.buttonStates[buttonIndex] && this.previousButtonStates[buttonIndex];\r\n    }\r\n    \r\n    vibrate(intensity = 0.5, duration = 100) {\r\n        if (!this.vibrationEnabled || this.activeGamepadIndex === null) return;\r\n        \r\n        const gamepads = navigator.getGamepads();\r\n        const gamepad = gamepads[this.activeGamepadIndex];\r\n        \r\n        if (gamepad && gamepad.vibrationActuator) {\r\n            gamepad.vibrationActuator.playEffect('dual-rumble', {\r\n                startDelay: 0,\r\n                duration: duration,\r\n                weakMagnitude: intensity * 0.5,\r\n                strongMagnitude: intensity\r\n            });\r\n        }\r\n    }\r\n    \r\n    resetControls() {\r\n        // Reset all spaceship controls\r\n        this.spaceship.thrust.forward = false;\r\n        this.spaceship.thrust.backward = false;\r\n        this.spaceship.thrust.left = false;\r\n        this.spaceship.thrust.right = false;\r\n        this.spaceship.thrust.boost = false;\r\n        this.spaceship.thrustPower = 1.0;\r\n        this.spaceship.strafePower = 1.0;\r\n    }\r\n    \r\n    showNotification(message) {\r\n        // Show a temporary notification for gamepad events\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.bottom = '100px';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translateX(-50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#30cfd0';\r\n        notification.style.padding = '10px 20px';\r\n        notification.style.borderRadius = '5px';\r\n        notification.style.border = '1px solid #30cfd0';\r\n        notification.style.fontFamily = 'monospace';\r\n        notification.style.fontSize = '14px';\r\n        notification.style.zIndex = '10000';\r\n        notification.textContent = '🎮 ' + message;\r\n        \r\n        document.body.appendChild(notification);\r\n        \r\n        // Fade out and remove after 3 seconds\r\n        setTimeout(() => {\r\n            notification.style.transition = 'opacity 0.5s';\r\n            notification.style.opacity = '0';\r\n            setTimeout(() => notification.remove(), 500);\r\n        }, 3000);\r\n    }\r\n    \r\n    // Settings methods\r\n    setLookSensitivity(value) {\r\n        this.lookSensitivity = Math.max(0.1, Math.min(5.0, value));\r\n    }\r\n    \r\n    setMovementSensitivity(value) {\r\n        this.movementSensitivity = Math.max(0.1, Math.min(2.0, value));\r\n    }\r\n    \r\n    setDeadZone(value) {\r\n        this.deadZone = Math.max(0.05, Math.min(0.3, value));\r\n    }\r\n    \r\n    setVibration(enabled) {\r\n        this.vibrationEnabled = enabled;\r\n    }\r\n    \r\n    isConnected() {\r\n        return this.activeGamepadIndex !== null;\r\n    }\r\n    \r\n    // Debug methods for testing\r\n    toggleDebug() {\r\n        this.debugMode = !this.debugMode;\r\n        \r\n        if (this.debugMode) {\r\n            this.createDebugDisplay();\r\n        } else {\r\n            this.removeDebugDisplay();\r\n        }\r\n    }\r\n    \r\n    createDebugDisplay() {\r\n        if (this.debugDisplay) return;\r\n        \r\n        this.debugDisplay = document.createElement('div');\r\n        this.debugDisplay.id = 'gamepad-debug';\r\n        this.debugDisplay.style.position = 'fixed';\r\n        this.debugDisplay.style.top = '10px';\r\n        this.debugDisplay.style.right = '10px';\r\n        this.debugDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        this.debugDisplay.style.color = '#0f0';\r\n        this.debugDisplay.style.padding = '10px';\r\n        this.debugDisplay.style.fontFamily = 'monospace';\r\n        this.debugDisplay.style.fontSize = '12px';\r\n        this.debugDisplay.style.borderRadius = '5px';\r\n        this.debugDisplay.style.border = '1px solid #0f0';\r\n        this.debugDisplay.style.zIndex = '10001';\r\n        this.debugDisplay.style.maxWidth = '300px';\r\n        this.debugDisplay.style.pointerEvents = 'none';\r\n        \r\n        document.body.appendChild(this.debugDisplay);\r\n    }\r\n    \r\n    removeDebugDisplay() {\r\n        if (this.debugDisplay) {\r\n            this.debugDisplay.remove();\r\n            this.debugDisplay = null;\r\n        }\r\n    }\r\n    \r\n    updateDebugDisplay(gamepad) {\r\n        if (!this.debugDisplay) {\r\n            this.createDebugDisplay();\r\n        }\r\n        \r\n        // Show ALL axes to debug mapping issues\r\n        let html = `<strong>🎮 Gamepad Debug</strong><br>`;\r\n        html += `Controller: ${gamepad.id}<br>`;\r\n        html += `Mapping: ${gamepad.mapping || 'non-standard'}<br>`;\r\n        html += `<br><strong>All Axes (${gamepad.axes.length}):</strong><br>`;\r\n        \r\n        for (let i = 0; i < gamepad.axes.length; i++) {\r\n            const value = gamepad.axes[i].toFixed(2);\r\n            const isRightX = i === this.rightStickXAxis;\r\n            const isRightY = i === this.rightStickYAxis;\r\n            const label = isRightX ? ' (R-X)' : isRightY ? ' (R-Y)' : '';\r\n            html += `[${i}]: ${value}${label} `;\r\n            if (i % 2 === 1) html += '<br>';\r\n        }\r\n        \r\n        html += `<br><strong>Detected Mapping:</strong><br>`;\r\n        html += `Left Stick: axes[0,1]<br>`;\r\n        html += `Right Stick: axes[${this.rightStickXAxis},${this.rightStickYAxis}]<br>`;\r\n        \r\n        const rightX = gamepad.axes[this.rightStickXAxis]?.toFixed(2) || '0';\r\n        const rightY = gamepad.axes[this.rightStickYAxis]?.toFixed(2) || '0';\r\n        html += `Right Values: X=${rightX} Y=${rightY}<br>`;\r\n        \r\n        const rt = gamepad.buttons[7]?.value.toFixed(2) || '0';\r\n        const lt = gamepad.buttons[6]?.value.toFixed(2) || '0';\r\n        html += `<br><strong>Triggers:</strong><br>`;\r\n        html += `LT: ${lt} | RT: ${rt}<br>`;\r\n        \r\n        html += `<br><strong>Active:</strong><br>`;\r\n        // Show active controls\r\n        if (this.spaceship.thrust.forward) html += '↑ Forward ';\r\n        if (this.spaceship.thrust.backward) html += '↓ Backward ';\r\n        if (this.spaceship.thrust.left) html += '→ Right ';\r\n        if (this.spaceship.thrust.right) html += '← Left ';\r\n        if (this.spaceship.thrust.boost) html += '⚡ Boost ';\r\n        \r\n        html += `<br><small>Press F8 to swap X/Y axes</small>`;\r\n        \r\n        this.debugDisplay.innerHTML = html;\r\n    }\r\n    \r\n    // Method to swap right stick axes if they're incorrect\r\n    swapRightStickAxes() {\r\n        const temp = this.rightStickXAxis;\r\n        this.rightStickXAxis = this.rightStickYAxis;\r\n        this.rightStickYAxis = temp;\r\n        console.log(`Swapped right stick axes: X is now axis ${this.rightStickXAxis}, Y is now axis ${this.rightStickYAxis}`);\r\n        this.axisDetectionMode = false; // Disable auto-detection after manual swap\r\n    }\r\n}","// miningSystem.js - Handles asteroid mining functionality\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class MiningSystem {\r\n    constructor(spaceship, scene) {\r\n        this.spaceship = spaceship;\r\n        this.scene = scene;\r\n        this.isMining = false;\r\n        this.targetAsteroid = null;\r\n        this.miningProgress = 0;\r\n        this.lastDestroyedAsteroid = null;\r\n        \r\n        // Mining speeds for single-action mining that takes 7.5, 22.5, and 45 seconds respectively\r\n        // Values are in progress per second (1 / seconds_required)\r\n        this.miningSpeedByType = {\r\n            iron: 0.133,     // 1/7.5 seconds to complete\r\n            gold: 0.044,     // 1/22.5 seconds to complete\r\n            platinum: 0.022  // 1/45 seconds to complete\r\n        };\r\n        this.miningSpeed = 0.133; // Default speed, will be set based on asteroid type\r\n        this.miningDistance = 6000; // Maximum mining distance (reduced from 24000 to 12000)\r\n        this.miningCooldown = 0;\r\n        \r\n        // Resources collected\r\n        this.resources = {\r\n            iron: 0,\r\n            gold: 0,\r\n            platinum: 0\r\n        };\r\n        \r\n        this.setupMiningLaser();\r\n    }\r\n    \r\n    // Helper method to get the mining efficiency from the spaceship\r\n    getMiningEfficiency() {\r\n        return this.spaceship && this.spaceship.miningEfficiency \r\n            ? this.spaceship.miningEfficiency \r\n            : 1.0; // Default value if spaceship property not available\r\n    }\r\n    \r\n    setupMiningLaser() {\r\n        // Create particle effect for mining impact\r\n        const particleCount = 100;\r\n        const particles = new THREE.BufferGeometry();\r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0xff5500,\r\n            size: 1.5, // Increased for visibility\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true,\r\n            opacity: 0.8\r\n        });\r\n        \r\n        const positions = new Float32Array(particleCount * 3);\r\n        for (let i = 0; i < particleCount; i++) {\r\n            positions[i * 3] = 0;\r\n            positions[i * 3 + 1] = 0;\r\n            positions[i * 3 + 2] = 0;\r\n        }\r\n        \r\n        particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n        this.miningParticles = new THREE.Points(particles, particleMaterial);\r\n        this.miningParticles.visible = false;\r\n        this.scene.add(this.miningParticles);\r\n    }\r\n    \r\n    setTargetAsteroid(asteroid) {\r\n        try {\r\n            console.log(\"MiningSystem: setTargetAsteroid called\", asteroid);\r\n            \r\n            // Validate asteroid before setting it as the target\r\n            if (!asteroid || !asteroid.mesh || !asteroid.mesh.position) {\r\n                console.error(\"MiningSystem: Invalid asteroid provided to setTargetAsteroid\");\r\n                return false;\r\n            }\r\n            \r\n            this.targetAsteroid = asteroid;\r\n            \r\n            // Set mining speed based on asteroid resource type and apply efficiency modifier\r\n            if (asteroid && asteroid.resourceType) {\r\n                const resourceType = asteroid.resourceType.toLowerCase();\r\n                const baseSpeed = this.miningSpeedByType[resourceType] || this.miningSpeedByType.iron;\r\n                const efficiency = this.getMiningEfficiency();\r\n                \r\n                this.miningSpeed = baseSpeed * efficiency;\r\n                console.log(`Mining ${resourceType} asteroid with speed: ${this.miningSpeed} (efficiency: ${efficiency}x)`);\r\n                \r\n                // Update UI to show targeting info\r\n                const targetInfo = document.getElementById('target-info');\r\n                if (targetInfo) {\r\n                    targetInfo.style.display = 'block';\r\n                    \r\n                    // Calculate distance and range status\r\n                    const distance = Math.round(this.spaceship.mesh.position.distanceTo(asteroid.mesh.position));\r\n                    const inRange = distance <= this.miningDistance;\r\n                    \r\n                    // Set color based on range\r\n                    targetInfo.style.color = inRange ? '#30cfd0' : '#ff4400';\r\n                    \r\n                    // Update target name/type\r\n                    const targetName = document.getElementById('target-name');\r\n                    if (targetName) {\r\n                        if (!inRange) {\r\n                            targetName.textContent = `${resourceType.toUpperCase()} Asteroid - OUT OF RANGE`;\r\n                            targetName.style.color = '#ff4400';\r\n                        } else {\r\n                            targetName.textContent = `${resourceType.toUpperCase()} Asteroid`;\r\n                            targetName.style.color = '#30cfd0';\r\n                        }\r\n                    }\r\n                    \r\n                    // Update distance with range status\r\n                    const targetDistance = document.getElementById('target-distance');\r\n                    if (targetDistance) {\r\n                        const rangeStatus = inRange ? ' [IN RANGE]' : ' [OUT OF RANGE]';\r\n                        const rangeColor = inRange ? '#00ff00' : '#ff4400';\r\n                        targetDistance.innerHTML = `Distance: ${distance} units<span style=\"color: ${rangeColor}\">${rangeStatus}</span>`;\r\n                    }\r\n                }\r\n            } else {\r\n                // Default to iron speed if no resource type is specified\r\n                this.miningSpeed = this.miningSpeedByType.iron * this.getMiningEfficiency();\r\n            }\r\n            \r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"MiningSystem: Error in setTargetAsteroid:\", error);\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    startMining() {\r\n        try {\r\n            console.log(\"MiningSystem: startMining called\");\r\n            \r\n            // Don't allow mining if no asteroid is targeted\r\n            if (!this.targetAsteroid) {\r\n                console.error(\"MiningSystem: Cannot start mining - no target asteroid set\");\r\n                return;\r\n            }\r\n\r\n            // Validate asteroid has required properties\r\n            if (!this.targetAsteroid.mesh || !this.targetAsteroid.mesh.position) {\r\n                console.error(\"MiningSystem: Target asteroid is missing mesh or position\", this.targetAsteroid);\r\n                return;\r\n            }\r\n\r\n            // Validate spaceship has required properties\r\n            if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\r\n                console.error(\"MiningSystem: Spaceship is missing mesh or position\");\r\n                return;\r\n            }\r\n            \r\n            // Check if asteroid is in mining range\r\n            const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\r\n            console.log(`MiningSystem: Distance to asteroid: ${distance}, max range: ${this.miningDistance}`);\r\n            \r\n            if (distance > this.miningDistance) {\r\n                // Show a message that target is out of range\r\n                const targetInfo = document.getElementById('target-info');\r\n                if (targetInfo) {\r\n                    targetInfo.textContent = 'TARGET OUT OF RANGE';\r\n                    targetInfo.style.color = '#ff4400';\r\n                    targetInfo.style.display = 'block';\r\n                    \r\n                    // Hide after 2 seconds\r\n                    setTimeout(() => {\r\n                        targetInfo.style.display = 'none';\r\n                    }, 2000);\r\n                }\r\n                console.log(\"MiningSystem: Target out of range\");\r\n                return;\r\n            }\r\n            \r\n            // Set mining state to active\r\n            this.isMining = true;\r\n            this.miningProgress = 0;\r\n            console.log(\"MiningSystem: Mining state activated\");\r\n            \r\n            // Get or create laser beam element\r\n            let laserBeam = document.getElementById('laser-beam');\r\n            \r\n            // If laser beam element doesn't exist, create it\r\n            if (!laserBeam) {\r\n                console.log(\"MiningSystem: Creating laser beam element\");\r\n                laserBeam = document.createElement('div');\r\n                laserBeam.id = 'laser-beam';\r\n                laserBeam.style.position = 'absolute';\r\n                laserBeam.style.height = '2px';\r\n                laserBeam.style.backgroundColor = '#ff3030';\r\n                laserBeam.style.transformOrigin = '0 0';\r\n                laserBeam.style.zIndex = '100';\r\n                laserBeam.style.pointerEvents = 'none';\r\n                document.body.appendChild(laserBeam);\r\n            }\r\n            \r\n            // Show mining laser beam\r\n            if (laserBeam) {\r\n                laserBeam.style.display = 'block';\r\n                \r\n                // Adjust laser color based on resource type and mining level\r\n                if (this.targetAsteroid.resourceType) {\r\n                    const resourceType = this.targetAsteroid.resourceType.toLowerCase();\r\n                    let laserColor = '#ff3030'; // Default red for iron\r\n                    let glowColor = '#ff0000';\r\n                    \r\n                    if (resourceType === 'gold') {\r\n                        laserColor = '#ffcc00'; // Gold color\r\n                        glowColor = '#ffaa00';\r\n                    } else if (resourceType === 'platinum') {\r\n                        laserColor = '#66ffff'; // Cyan color for platinum\r\n                        glowColor = '#00ffff';\r\n                    }\r\n                    \r\n                    // Adjust intensity based on mining efficiency - brighter for higher efficiency\r\n                    const efficiency = this.getMiningEfficiency();\r\n                    if (efficiency > 1.0) {\r\n                        // Make the laser more intense as mining level increases\r\n                        const laserIntensity = Math.min(1.0 + (efficiency - 1.0) * 0.5, 3.0);\r\n                        laserBeam.style.boxShadow = `0 0 ${10 * laserIntensity}px ${glowColor}, 0 0 ${20 * laserIntensity}px ${glowColor}`;\r\n                    } else {\r\n                        laserBeam.style.boxShadow = `0 0 10px ${glowColor}, 0 0 20px ${glowColor}`;\r\n                    }\r\n                    \r\n                    laserBeam.style.backgroundColor = laserColor;\r\n                } else {\r\n                    // Default red laser\r\n                    laserBeam.style.backgroundColor = '#ff3030'; \r\n                    laserBeam.style.boxShadow = '0 0 10px #ff0000, 0 0 20px #ff0000';\r\n                }\r\n            }\r\n            \r\n            // Show mining particles\r\n            if (this.miningParticles) {\r\n                this.miningParticles.visible = true;\r\n                \r\n                // Adjust particle color based on resource type\r\n                if (this.targetAsteroid.resourceType && this.miningParticles.material) {\r\n                    const resourceType = this.targetAsteroid.resourceType.toLowerCase();\r\n                    \r\n                    if (resourceType === 'iron') {\r\n                        this.miningParticles.material.color.set(0xff5500); // Orange\r\n                    } else if (resourceType === 'gold') {\r\n                        this.miningParticles.material.color.set(0xffcc00); // Yellow\r\n                    } else if (resourceType === 'platinum') {\r\n                        this.miningParticles.material.color.set(0x66ffff); // Light blue\r\n                    }\r\n                    \r\n                    // Adjust particle size based on mining efficiency\r\n                    const efficiency = this.getMiningEfficiency();\r\n                    if (efficiency > 1.0) {\r\n                        this.miningParticles.material.size = 1.5 * Math.sqrt(efficiency);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Create or update mining progress bar\r\n            let miningProgressContainer = document.getElementById('mining-progress-container');\r\n            if (!miningProgressContainer) {\r\n                console.log(\"MiningSystem: Creating mining progress container\");\r\n                miningProgressContainer = document.createElement('div');\r\n                miningProgressContainer.id = 'mining-progress-container';\r\n                miningProgressContainer.style.position = 'absolute';\r\n                miningProgressContainer.style.bottom = '20px';\r\n                miningProgressContainer.style.left = '50%';\r\n                miningProgressContainer.style.transform = 'translateX(-50%)';\r\n                miningProgressContainer.style.width = '200px';\r\n                miningProgressContainer.style.height = '10px';\r\n                miningProgressContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\r\n                miningProgressContainer.style.border = '1px solid #30cfd0';\r\n                miningProgressContainer.style.zIndex = '1000';\r\n                document.body.appendChild(miningProgressContainer);\r\n                \r\n                const progressBar = document.createElement('div');\r\n                progressBar.id = 'mining-progress-bar';\r\n                progressBar.style.width = '0%';\r\n                progressBar.style.height = '100%';\r\n                progressBar.style.backgroundColor = '#30cfd0';\r\n                miningProgressContainer.appendChild(progressBar);\r\n            } else {\r\n                miningProgressContainer.style.display = 'block';\r\n                const progressBar = document.getElementById('mining-progress-bar');\r\n                if (progressBar) {\r\n                    progressBar.style.width = '0%';\r\n                }\r\n            }\r\n            \r\n            // Activate the spaceship's laser emitter\r\n            if (this.spaceship && typeof this.spaceship.activateMiningLaser === 'function') {\r\n                this.spaceship.activateMiningLaser();\r\n            }\r\n            \r\n            // Update mining status display with timing info\r\n            this.updateMiningStatusWithTime();\r\n            \r\n            // Trigger laser sound\r\n            if (window.game && window.game.audio) {\r\n                window.game.audio.playSound('mining-laser');\r\n            } else if (window.game && window.game.audio) {\r\n                window.game.audio.playSound('laser');\r\n            }\r\n            \r\n            console.log(\"MiningSystem: Mining successfully started\");\r\n        } catch (error) {\r\n            console.error(\"MiningSystem: Error in startMining:\", error);\r\n            this.isMining = false;\r\n        }\r\n    }\r\n    \r\n    // Update the mining status with time estimate\r\n    updateMiningStatusWithTime() {\r\n        const miningStatusElement = document.getElementById('mining-status');\r\n        if (!miningStatusElement || !this.targetAsteroid || !this.targetAsteroid.resourceType) return;\r\n        \r\n        // Calculate approximate time to mine based on resource type\r\n        const resourceType = this.targetAsteroid.resourceType.toLowerCase();\r\n        const secondsRequired = Math.round(1 / this.miningSpeed);\r\n        const efficiency = this.getMiningEfficiency();\r\n        \r\n        let efficiencyText = \"\";\r\n        if (efficiency > 1.0) {\r\n            efficiencyText = ` [${Math.round(efficiency * 100)}% efficiency]`;\r\n        }\r\n        \r\n        miningStatusElement.textContent = `MINING ${resourceType.toUpperCase()} (${secondsRequired}s)${efficiencyText}`;\r\n        miningStatusElement.style.color = '#ff4400';\r\n    }\r\n    \r\n    stopMining() {\r\n        if (!this.isMining) return;\r\n        \r\n        this.isMining = false;\r\n        this.miningProgress = 0;\r\n        \r\n        // Hide laser beam\r\n        const laserBeam = document.getElementById('laser-beam');\r\n        if (laserBeam) {\r\n            laserBeam.style.display = 'none';\r\n        }\r\n        \r\n        // Hide mining particles\r\n        if (this.miningParticles) {\r\n            this.miningParticles.visible = false;\r\n        }\r\n        \r\n        // Hide mining progress bar\r\n        const miningProgressContainer = document.getElementById('mining-progress-container');\r\n        if (miningProgressContainer) {\r\n            miningProgressContainer.style.display = 'none';\r\n        }\r\n        \r\n        // Deactivate the spaceship's laser emitter\r\n        this.spaceship.deactivateMiningLaser();\r\n        \r\n        // Reset mining status display\r\n        const miningStatusElement = document.getElementById('mining-status');\r\n        if (miningStatusElement) {\r\n            miningStatusElement.textContent = 'INACTIVE';\r\n            miningStatusElement.style.color = '#30cfd0';\r\n        }\r\n        \r\n        // Stop laser sound\r\n        if (window.game && window.game.audio) {\r\n            window.game.audio.stopSound('mining-laser');\r\n        }\r\n    }\r\n    \r\n    update(deltaTime = 1/60) {\r\n        // Update mining cooldown\r\n        if (this.miningCooldown > 0) {\r\n            this.miningCooldown--;\r\n        }\r\n        \r\n        // Update mining if active\r\n        if (this.isMining) {\r\n            this.updateMining(deltaTime);\r\n        }\r\n        \r\n        // Update mining particles if visible\r\n        if (this.miningParticles && this.miningParticles.visible) {\r\n            this.updateMiningParticles();\r\n        }\r\n        \r\n        // Update target info if we have a target but aren't mining\r\n        if (this.targetAsteroid && !this.isMining) {\r\n            this.updateTargetInfo();\r\n        }\r\n    }\r\n    \r\n    updateMining(deltaTime = 1/60) {\r\n        // Make sure we have a target asteroid\r\n        if (!this.targetAsteroid || !this.isMining) {\r\n            this.stopMining();\r\n            return;\r\n        }\r\n        \r\n        // Check if asteroid is in range - if not, stop mining and require new click\r\n        const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\r\n        if (distance > this.miningDistance) {\r\n            this.stopMining();\r\n            return;\r\n        }\r\n        \r\n        // Update mining progress using deltaTime for frame-rate independence\r\n        this.miningProgress += this.miningSpeed * deltaTime;\r\n        \r\n        // Update laser beam position\r\n        this.updateLaserBeam();\r\n        \r\n        // Update mining particles position\r\n        if (this.miningParticles && this.miningParticles.visible) {\r\n            this.miningParticles.position.copy(this.targetAsteroid.mesh.position);\r\n        }\r\n        \r\n        // Complete mining when progress reaches 1.0\r\n        if (this.miningProgress >= 1.0) {\r\n            // Add resources from asteroid in one batch\r\n            this.addAsteroidResources();\r\n            \r\n            // Create asteroid break effect\r\n            this.createAsteroidBreakEffect(this.targetAsteroid.mesh.position);\r\n            \r\n            // Store reference to the destroyed asteroid\r\n            this.lastDestroyedAsteroid = this.targetAsteroid;\r\n            \r\n            // Remove asteroid from scene\r\n            this.scene.remove(this.targetAsteroid.mesh);\r\n            \r\n            // Stop mining\r\n            this.stopMining();\r\n            this.targetAsteroid = null;\r\n        }\r\n        \r\n        // Update the progress bar\r\n        const progressBar = document.getElementById('mining-progress-bar');\r\n        if (progressBar) {\r\n            progressBar.style.width = `${this.miningProgress * 100}%`;\r\n        }\r\n    }\r\n    \r\n    updateLaserBeam() {\r\n        const laserBeam = document.getElementById('laser-beam');\r\n        if (!laserBeam || !this.targetAsteroid || !this.isMining) return;\r\n        \r\n        // Create a vector pointing from the ship to the asteroid\r\n        const shipPosition = this.spaceship.mesh.position.clone();\r\n        const asteroidPosition = this.targetAsteroid.mesh.position.clone();\r\n        \r\n        // Add a small offset to the ship position to start from the FRONT of the mining laser\r\n        // The ship's coordinate system has -Z as the forward direction, so use negative Z\r\n        const shipOffset = new THREE.Vector3(0, 0, -60); // 4x the original offset (-15)\r\n        shipOffset.applyQuaternion(this.spaceship.mesh.quaternion);\r\n        shipPosition.add(shipOffset);\r\n        \r\n        // Convert 3D positions to screen coordinates\r\n        const tempVector = new THREE.Vector3();\r\n        \r\n        // Get the camera\r\n        const camera = this.scene.camera;\r\n        if (!camera) return;\r\n        \r\n        // Convert ship position to screen space\r\n        tempVector.copy(shipPosition);\r\n        tempVector.project(camera);\r\n        const shipX = (tempVector.x * 0.5 + 0.5) * window.innerWidth;\r\n        const shipY = (-(tempVector.y * 0.5) + 0.5) * window.innerHeight;\r\n        \r\n        // Convert asteroid position to screen space\r\n        tempVector.copy(asteroidPosition);\r\n        tempVector.project(camera);\r\n        const asteroidX = (tempVector.x * 0.5 + 0.5) * window.innerWidth;\r\n        const asteroidY = (-(tempVector.y * 0.5) + 0.5) * window.innerHeight;\r\n        \r\n        // Calculate distance and angle\r\n        const dx = asteroidX - shipX;\r\n        const dy = asteroidY - shipY;\r\n        const distance = Math.sqrt(dx * dx + dy * dy);\r\n        const angle = Math.atan2(dy, dx);\r\n        \r\n        // Update laser beam style\r\n        laserBeam.style.width = `${distance}px`;\r\n        laserBeam.style.left = `${shipX}px`;\r\n        laserBeam.style.top = `${shipY}px`;\r\n        laserBeam.style.transform = `rotate(${angle}rad)`;\r\n        \r\n        // Animate the laser beam for a more dynamic effect\r\n        const intensity = 0.8 + Math.sin(Date.now() * 0.01) * 0.2;\r\n        laserBeam.style.opacity = intensity.toString();\r\n        \r\n        // Make laser thickness vary with mining efficiency\r\n        const efficiency = this.getMiningEfficiency();\r\n        const thickness = Math.max(2, Math.ceil(2 * Math.sqrt(efficiency)));\r\n        laserBeam.style.height = `${thickness}px`;\r\n        \r\n        // Create multiple beams for a more powerful effect\r\n        if (!laserBeam.hasChildNodes()) {\r\n            // Create 2 additional beams for a thicker laser effect\r\n            for (let i = 0; i < 2; i++) {\r\n                const additionalBeam = document.createElement('div');\r\n                additionalBeam.style.position = 'absolute';\r\n                additionalBeam.style.left = '0';\r\n                additionalBeam.style.top = `${i === 0 ? -1 : 1}px`;\r\n                additionalBeam.style.width = '100%';\r\n                additionalBeam.style.height = '1px';\r\n                additionalBeam.style.backgroundColor = '#ff6060';\r\n                additionalBeam.style.opacity = '0.7';\r\n                laserBeam.appendChild(additionalBeam);\r\n            }\r\n        }\r\n    }\r\n    \r\n    updateMiningParticles() {\r\n        const positions = this.miningParticles.geometry.attributes.position.array;\r\n        \r\n        // Get mining efficiency to adjust particle behavior\r\n        const efficiency = this.getMiningEfficiency();\r\n        // Particles move faster with higher efficiency\r\n        const particleSpeed = 0.3 * efficiency;\r\n        \r\n        for (let i = 0; i < positions.length; i += 3) {\r\n            // Move particles outward slightly\r\n            const dir = new THREE.Vector3(positions[i], positions[i+1], positions[i+2]);\r\n            dir.normalize().multiplyScalar(particleSpeed);\r\n            \r\n            positions[i] += dir.x;\r\n            positions[i+1] += dir.y;\r\n            positions[i+2] += dir.z;\r\n            \r\n            // Reset particles that move too far\r\n            const dist = Math.sqrt(\r\n                positions[i] * positions[i] + \r\n                positions[i+1] * positions[i+1] + \r\n                positions[i+2] * positions[i+2]\r\n            );\r\n            \r\n            if (dist > 36) { // 4x original reset distance (was 9)\r\n                positions[i] = (Math.random() - 0.5) * 24; // 4x original spread (was 6)\r\n                positions[i+1] = (Math.random() - 0.5) * 24;\r\n                positions[i+2] = (Math.random() - 0.5) * 24;\r\n            }\r\n        }\r\n        this.miningParticles.geometry.attributes.position.needsUpdate = true;\r\n    }\r\n    \r\n    /**\r\n     * Add all resources from the mined asteroid to the player's inventory at once\r\n     */\r\n    addAsteroidResources() {\r\n        if (!this.targetAsteroid) return;\r\n        \r\n        // Get the resource type from the asteroid\r\n        const resourceType = this.targetAsteroid.resourceType || 'iron'; // Default to iron if no type specified\r\n        \r\n        // Get mining efficiency for resource extraction bonus\r\n        const efficiency = this.getMiningEfficiency();\r\n        const bonusChance = (efficiency - 1.0) * 0.5; // Chance for bonus resources based on efficiency\r\n        \r\n        // Calculate base amount based on asteroid type\r\n        let amount = 0;\r\n        switch (resourceType.toLowerCase()) {\r\n            case 'iron':\r\n                amount = Math.floor(Math.random() * 5) + 10; // 10-14 iron\r\n                break;\r\n            case 'gold':\r\n                amount = Math.floor(Math.random() * 3) + 5; // 5-7 gold\r\n                break;\r\n            case 'platinum':\r\n                amount = Math.floor(Math.random() * 2) + 2; // 2-3 platinum\r\n                break;\r\n            default:\r\n                amount = 10; // Default to 10 iron\r\n        }\r\n        \r\n        // Apply bonus resources based on mining efficiency\r\n        if (efficiency > 1.0 && Math.random() < bonusChance) {\r\n            amount = Math.ceil(amount * 1.2); // 20% bonus\r\n        }\r\n        \r\n        // Update resource counts\r\n        switch (resourceType.toLowerCase()) {\r\n            case 'iron':\r\n                this.resources.iron += amount;\r\n                break;\r\n            case 'gold':\r\n                this.resources.gold += amount;\r\n                break;\r\n            case 'platinum':\r\n                this.resources.platinum += amount;\r\n                break;\r\n            default:\r\n                this.resources.iron += amount;\r\n        }\r\n        \r\n        console.log(`MiningSystem: Added ${amount} ${resourceType} from asteroid`);\r\n        \r\n        // Show resource gain notification\r\n        this.showResourceGainNotification(amount, resourceType);\r\n        \r\n        return true;\r\n    }\r\n    \r\n    /**\r\n     * Show a notification for resources gained\r\n     */\r\n    showResourceGainNotification(amount, resourceType) {\r\n        // Get color based on resource type\r\n        let color = '#a0a0a0'; // Default gray for iron\r\n        if (resourceType === 'gold') {\r\n            color = '#ffcc00';\r\n        } else if (resourceType === 'platinum') {\r\n            color = '#66ffff';\r\n        }\r\n        \r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.textContent = `+${amount} ${resourceType.toUpperCase()}`;\r\n        notification.style.position = 'absolute';\r\n        notification.style.top = '40%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.color = color;\r\n        notification.style.fontSize = '24px';\r\n        notification.style.fontWeight = 'bold';\r\n        notification.style.textShadow = '0 0 8px black';\r\n        notification.style.zIndex = '1000';\r\n        notification.style.opacity = '1';\r\n        notification.style.transition = 'all 1.5s ease-out';\r\n        \r\n        document.body.appendChild(notification);\r\n        \r\n        // Animate the notification\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.top = '30%';\r\n            \r\n            // Remove after animation\r\n            setTimeout(() => {\r\n                if (document.body.contains(notification)) {\r\n                    document.body.removeChild(notification);\r\n                }\r\n            }, 1500);\r\n        }, 100);\r\n    }\r\n    \r\n    createAsteroidBreakEffect(position) {\r\n        // Create particle effect for asteroid breaking\r\n        const particleCount = 50;\r\n        const particles = new THREE.BufferGeometry();\r\n        const particleMaterial = new THREE.PointsMaterial({\r\n            color: 0xaaaaaa,\r\n            size: 12, // 4x original size (was 3)\r\n            blending: THREE.AdditiveBlending,\r\n            transparent: true,\r\n            opacity: 0.8\r\n        });\r\n        \r\n        const positions = new Float32Array(particleCount * 3);\r\n        const velocities = [];\r\n        \r\n        for (let i = 0; i < particleCount; i++) {\r\n            // Start at asteroid position\r\n            positions[i * 3] = position.x;\r\n            positions[i * 3 + 1] = position.y;\r\n            positions[i * 3 + 2] = position.z;\r\n            \r\n            // Random velocity in all directions - 4x faster to match scale\r\n            velocities.push({\r\n                x: (Math.random() - 0.5) * 8,  // 4x original speed (was 2)\r\n                y: (Math.random() - 0.5) * 8,  // 4x original speed\r\n                z: (Math.random() - 0.5) * 8   // 4x original speed\r\n            });\r\n        }\r\n        \r\n        particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n        const particleSystem = new THREE.Points(particles, particleMaterial);\r\n        this.scene.add(particleSystem);\r\n        \r\n        // Animate particles\r\n        let frameCount = 0;\r\n        const animateParticles = () => {\r\n            frameCount++;\r\n            \r\n            // Update particle positions\r\n            const positions = particleSystem.geometry.attributes.position.array;\r\n            \r\n            for (let i = 0; i < particleCount; i++) {\r\n                positions[i * 3] += velocities[i].x;\r\n                positions[i * 3 + 1] += velocities[i].y;\r\n                positions[i * 3 + 2] += velocities[i].z;\r\n            }\r\n            \r\n            particleSystem.geometry.attributes.position.needsUpdate = true;\r\n            \r\n            // Fade out over time\r\n            particleSystem.material.opacity = Math.max(0, 0.8 - frameCount * 0.02);\r\n            \r\n            // Remove after 40 frames\r\n            if (frameCount < 40) {\r\n                requestAnimationFrame(animateParticles);\r\n            } else {\r\n                this.scene.remove(particleSystem);\r\n            }\r\n        };\r\n        \r\n        animateParticles();\r\n    }\r\n    \r\n    // New method to retrieve the last destroyed asteroid and reset the property\r\n    getLastDestroyedAsteroid() {\r\n        const destroyedAsteroid = this.lastDestroyedAsteroid;\r\n        this.lastDestroyedAsteroid = null; // Reset after getting it\r\n        return destroyedAsteroid;\r\n    }\r\n    \r\n    // Add a new method to update target info in the UI\r\n    updateTargetInfo() {\r\n        if (!this.targetAsteroid || !this.targetAsteroid.mesh) return;\r\n        \r\n        try {\r\n            // Update distance calculation\r\n            const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\r\n            const inRange = distance <= this.miningDistance;\r\n            \r\n            // Update UI elements if they exist\r\n            const targetDistance = document.getElementById('target-distance');\r\n            if (targetDistance) {\r\n                const rangeStatus = inRange ? ' [IN RANGE]' : ' [OUT OF RANGE]';\r\n                const rangeColor = inRange ? '#00ff00' : '#ff4400';\r\n                targetDistance.innerHTML = `Distance: ${Math.round(distance)} units<span style=\"color: ${rangeColor}\">${rangeStatus}</span>`;\r\n            }\r\n            \r\n            // Update target info color\r\n            const targetInfo = document.getElementById('target-info');\r\n            if (targetInfo) {\r\n                targetInfo.style.color = inRange ? '#30cfd0' : '#ff4400';\r\n            }\r\n            \r\n            // Update target name to show range status\r\n            const targetName = document.getElementById('target-name');\r\n            if (targetName && this.targetAsteroid.resourceType) {\r\n                const resourceType = this.targetAsteroid.resourceType.toUpperCase();\r\n                if (!inRange) {\r\n                    targetName.textContent = `${resourceType} Asteroid - OUT OF RANGE`;\r\n                    targetName.style.color = '#ff4400';\r\n                } else {\r\n                    targetName.textContent = `${resourceType} Asteroid`;\r\n                    targetName.style.color = '#30cfd0';\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"MiningSystem: Error updating target info:\", error);\r\n        }\r\n    }\r\n} ","// targetingSystem.js - Handles asteroid targeting and lock-on\r\n\r\nimport * as THREE from 'three';\r\n\r\nexport class TargetingSystem {\r\n    constructor(spaceship, scene, environment) {\r\n        this.spaceship = spaceship;\r\n        this.scene = scene;\r\n        this.environment = environment;\r\n        \r\n        this.lockOnEnabled = false;\r\n        this.nearbyAsteroids = [];\r\n        this.currentLockOnIndex = -1;\r\n        this.targetAsteroid = null;\r\n        this.scanRadius = this.getScanRadius(); // Get initial scan radius from spaceship\r\n        \r\n        this.createTargetReticle();\r\n        // Create off-screen indicators\r\n        this.createOffScreenIndicators();\r\n    }\r\n    \r\n    createTargetReticle() {\r\n        // Create the target indicator geometry (outer ring)\r\n        const ringGeometry = new THREE.RingGeometry(150, 180, 32);\r\n        const ringMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff3030,\r\n            side: THREE.DoubleSide,\r\n            transparent: true,\r\n            opacity: 0.7\r\n        });\r\n        \r\n        this.targetReticle = new THREE.Mesh(ringGeometry, ringMaterial);\r\n        this.targetReticle.visible = false;\r\n        this.scene.add(this.targetReticle);\r\n        \r\n        // Add inner ring for additional visual interest\r\n        const innerRingGeometry = new THREE.RingGeometry(75, 90, 32);\r\n        const innerRingMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff6060,\r\n            side: THREE.DoubleSide,\r\n            transparent: true,\r\n            opacity: 0.5\r\n        });\r\n        \r\n        const innerRing = new THREE.Mesh(innerRingGeometry, innerRingMaterial);\r\n        this.targetReticle.add(innerRing);\r\n    }\r\n    \r\n    // Helper method to get the current scan radius from the spaceship\r\n    getScanRadius() {\r\n        // Increase default scan radius by 5x (from 1000 to 5000)\r\n        return this.spaceship && this.spaceship.scanRange \r\n            ? this.spaceship.scanRange * 5 \r\n            : 5000; // Default value increased by 5x\r\n    }\r\n    \r\n    toggleLockOn() {\r\n        this.lockOnEnabled = !this.lockOnEnabled;\r\n        \r\n        if (this.lockOnEnabled) {\r\n            // Update scan radius before scanning\r\n            this.scanRadius = this.getScanRadius();\r\n            \r\n            // Scan for nearby asteroids\r\n            this.scanForAsteroids();\r\n            \r\n            // Show targeting UI with proper structure\r\n            const targetInfoElement = document.getElementById('target-info');\r\n            if (targetInfoElement) {\r\n                // Don't overwrite the content, just make it visible\r\n                targetInfoElement.style.display = 'block';\r\n                targetInfoElement.style.color = '#30cfd0';\r\n                \r\n                // Create proper structure if it doesn't exist\r\n                if (!document.getElementById('target-name')) {\r\n                    targetInfoElement.innerHTML = `\r\n                        <div id=\"target-name\">Scanning for targets...</div>\r\n                        <div id=\"target-distance\"></div>\r\n                    `;\r\n                }\r\n            }\r\n            \r\n            // Automatically select the closest target\r\n            if (this.nearbyAsteroids.length > 0) {\r\n                this.findNearestTarget();\r\n            }\r\n        } else {\r\n            // Clear target and hide UI\r\n            this.nearbyAsteroids = [];\r\n            this.currentLockOnIndex = -1;\r\n            this.targetAsteroid = null;\r\n            this.targetReticle.visible = false;\r\n            \r\n            // Hide off-screen indicators\r\n            this.hideOffScreenIndicators();\r\n            \r\n            // Hide targeting UI\r\n            const targetInfoElement = document.getElementById('target-info');\r\n            if (targetInfoElement) {\r\n                targetInfoElement.style.display = 'none';\r\n            }\r\n        }\r\n        \r\n        return this.lockOnEnabled;\r\n    }\r\n    \r\n    scanForAsteroids() {\r\n        this.nearbyAsteroids = [];\r\n        const shipPosition = this.spaceship.mesh.position;\r\n        \r\n        // Find all asteroids within scan radius\r\n        const asteroids = this.environment.asteroids;\r\n        asteroids.forEach(asteroid => {\r\n            // Skip asteroids that aren't minable or visible\r\n            if (!asteroid.minable || !asteroid.mesh.visible) return;\r\n            \r\n            const distance = shipPosition.distanceTo(asteroid.mesh.position);\r\n            if (distance <= this.scanRadius) {\r\n                this.nearbyAsteroids.push({\r\n                    asteroid: asteroid,\r\n                    distance: distance\r\n                });\r\n            }\r\n        });\r\n        \r\n        // Sort by distance\r\n        this.nearbyAsteroids.sort((a, b) => a.distance - b.distance);\r\n        \r\n        // Extract just the asteroid objects after sorting\r\n        this.nearbyAsteroids = this.nearbyAsteroids.map(item => item.asteroid);\r\n        \r\n        // Set current target if we found asteroids\r\n        if (this.nearbyAsteroids.length > 0) {\r\n            this.currentLockOnIndex = 0;\r\n            this.updateLockedOnTarget();\r\n            \r\n            // Update UI to show number of detected asteroids\r\n            const targetNameElement = document.getElementById('target-name');\r\n            if (targetNameElement) {\r\n                targetNameElement.textContent = \r\n                    `Target 1/${this.nearbyAsteroids.length} (${Math.round(this.nearbyAsteroids[0].mesh.position.distanceTo(shipPosition))} units)`;\r\n            }\r\n            \r\n            return true;\r\n        } else {\r\n            // No targets found\r\n            const targetNameElement = document.getElementById('target-name');\r\n            if (targetNameElement) {\r\n                targetNameElement.textContent = 'No targets in range';\r\n            }\r\n            this.targetReticle.visible = false;\r\n            this.targetAsteroid = null;\r\n            \r\n            return false;\r\n        }\r\n    }\r\n    \r\n    cycleLockOnTarget() {\r\n        if (!this.lockOnEnabled || this.nearbyAsteroids.length === 0) return null;\r\n        \r\n        // Move to next target\r\n        this.currentLockOnIndex = (this.currentLockOnIndex + 1) % this.nearbyAsteroids.length;\r\n        return this.updateLockedOnTarget();\r\n    }\r\n    \r\n    updateLockedOnTarget() {\r\n        this.targetAsteroid = this.nearbyAsteroids[this.currentLockOnIndex];\r\n        \r\n        if (this.targetAsteroid) {\r\n            // Don't update UI here - let the mining system handle it\r\n            // This prevents overwriting the mining system's detailed info\r\n            console.log(`Target locked: ${this.targetAsteroid.resourceType} asteroid`);\r\n            \r\n            // Position the targeting indicator\r\n            this.targetReticle.position.copy(this.targetAsteroid.mesh.position);\r\n            this.targetReticle.visible = true;\r\n            \r\n            // Make the indicator look at the camera\r\n            const lookAtPos = new THREE.Vector3().copy(this.scene.camera.position);\r\n            this.targetReticle.lookAt(lookAtPos);\r\n            \r\n            // Ensure proper scale and visibility\r\n            this.targetReticle.scale.set(1, 1, 1);\r\n            this.targetReticle.material.opacity = 0.8;\r\n            if (this.targetReticle.children.length > 0) {\r\n                this.targetReticle.children[0].material.opacity = 0.8;\r\n            }\r\n        }\r\n        \r\n        return this.targetAsteroid;\r\n    }\r\n    \r\n    getCurrentTarget() {\r\n        try {\r\n            console.log(\"TargetingSystem: getCurrentTarget called\");\r\n            \r\n            // Check if we have a valid target\r\n            if (!this.targetAsteroid) {\r\n                console.log(\"TargetingSystem: No current target\");\r\n                return null;\r\n            }\r\n            \r\n            // Validate the target is still valid\r\n            if (!this.targetAsteroid.mesh || !this.targetAsteroid.mesh.position) {\r\n                console.error(\"TargetingSystem: Current target is invalid, clearing target\");\r\n                this.targetAsteroid = null;\r\n                return null;\r\n            }\r\n            \r\n            console.log(\"TargetingSystem: Returning current target:\", this.targetAsteroid);\r\n            return this.targetAsteroid;\r\n        } catch (error) {\r\n            console.error(\"TargetingSystem: Error in getCurrentTarget:\", error);\r\n            return null;\r\n        }\r\n    }\r\n    \r\n    isLockOnEnabled() {\r\n        return this.lockOnEnabled === true;\r\n    }\r\n    \r\n    findNearestTarget() {\r\n        try {\r\n            console.log(\"TargetingSystem: findNearestTarget called\");\r\n            \r\n            if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\r\n                console.error(\"TargetingSystem: Cannot find nearest target - spaceship missing or invalid\");\r\n                return null;\r\n            }\r\n            \r\n            // Get all asteroids\r\n            let asteroids = [];\r\n            \r\n            // Try to get asteroids from the game environment\r\n            const game = window.gameInstance || window.game;\r\n            if (game && game.environment && Array.isArray(game.environment.asteroids)) {\r\n                console.log(`TargetingSystem: Found ${game.environment.asteroids.length} asteroids in environment`);\r\n                asteroids = game.environment.asteroids;\r\n            } else {\r\n                console.error(\"TargetingSystem: Could not access asteroids from game environment\");\r\n                return null;\r\n            }\r\n            \r\n            if (asteroids.length === 0) {\r\n                console.log(\"TargetingSystem: No asteroids found in environment\");\r\n                return null;\r\n            }\r\n            \r\n            // Find the closest asteroid with proper validation\r\n            let closestAsteroid = null;\r\n            let closestDistance = Infinity;\r\n            \r\n            for (const asteroid of asteroids) {\r\n                // Validate asteroid has required properties and is visible\r\n                if (!asteroid || !asteroid.mesh || !asteroid.mesh.position || !asteroid.mesh.visible) {\r\n                    console.log(\"TargetingSystem: Skipping invalid or invisible asteroid\", asteroid);\r\n                    continue;\r\n                }\r\n                \r\n                const distance = this.spaceship.mesh.position.distanceTo(asteroid.mesh.position);\r\n                \r\n                if (distance < closestDistance) {\r\n                    closestDistance = distance;\r\n                    closestAsteroid = asteroid;\r\n                }\r\n            }\r\n            \r\n            if (closestAsteroid) {\r\n                console.log(\"TargetingSystem: Found nearest target:\", closestAsteroid);\r\n                \r\n                // Select this target\r\n                this.setTarget(closestAsteroid);\r\n                \r\n                return closestAsteroid;\r\n            } else {\r\n                console.log(\"TargetingSystem: No valid asteroid found after checking all asteroids\");\r\n                return null;\r\n            }\r\n        } catch (error) {\r\n            console.error(\"TargetingSystem: Error in findNearestTarget:\", error);\r\n            return null;\r\n        }\r\n    }\r\n    \r\n    update() {\r\n        // Only update scan radius every 30 frames for performance\r\n        if (!this.scanRadiusCounter) this.scanRadiusCounter = 0;\r\n        this.scanRadiusCounter++;\r\n        if (this.scanRadiusCounter >= 30) {\r\n            this.scanRadiusCounter = 0;\r\n            this.scanRadius = this.getScanRadius();\r\n        }\r\n        \r\n        // If targeting is enabled, periodically rescan for new asteroids\r\n        if (this.lockOnEnabled) {\r\n            // Rescan every 120 frames (about every 2 seconds at 60fps) for better performance\r\n            if (!this.rescanCounter) this.rescanCounter = 0;\r\n            this.rescanCounter++;\r\n            \r\n            if (this.rescanCounter >= 120) {\r\n                this.rescanCounter = 0;\r\n                const previousCount = this.nearbyAsteroids.length;\r\n                this.scanForAsteroids();\r\n                \r\n                // If we found new asteroids and don't have a target, auto-select one\r\n                if (this.nearbyAsteroids.length > 0 && !this.targetAsteroid) {\r\n                    this.findNearestTarget();\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Update lock-on targeting visuals (optimized)\r\n        if (this.lockOnEnabled && this.targetAsteroid) {\r\n            // Update target indicator position\r\n            this.targetReticle.position.copy(this.targetAsteroid.mesh.position);\r\n            \r\n            // Make indicator face the camera (less frequently)\r\n            if (!this.lookAtCounter) this.lookAtCounter = 0;\r\n            this.lookAtCounter++;\r\n            if (this.lookAtCounter >= 10) {  // Every 10 frames instead of every frame\r\n                this.lookAtCounter = 0;\r\n                this.targetReticle.lookAt(this.scene.camera.position);\r\n            }\r\n            \r\n            // Simple rotation animation (more efficient)\r\n            this.targetReticle.rotation.z += 0.005;  // Reduced rotation speed\r\n            if (this.targetReticle.children.length > 0) {\r\n                this.targetReticle.children[0].rotation.z -= 0.01;\r\n            }\r\n            \r\n            // Simplified pulsing (no Date.now() calls)\r\n            if (!this.pulseTime) this.pulseTime = 0;\r\n            this.pulseTime += 0.02;  // Fixed time step\r\n            const pulseValue = Math.sin(this.pulseTime);\r\n            const opacity = 0.7 + 0.2 * pulseValue;  // Less dramatic pulsing\r\n            this.targetReticle.material.opacity = opacity;\r\n            \r\n            // Update UI less frequently for performance\r\n            if (!this.uiUpdateCounter) this.uiUpdateCounter = 0;\r\n            this.uiUpdateCounter++;\r\n            if (this.uiUpdateCounter >= 30) {  // Update UI every 30 frames (~0.5 seconds)\r\n                this.uiUpdateCounter = 0;\r\n                \r\n                // Update distance in UI\r\n                const targetDistanceElement = document.getElementById('target-distance');\r\n                if (targetDistanceElement) {\r\n                    const distance = Math.round(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position));\r\n                    targetDistanceElement.textContent = `Distance: ${distance} units`;\r\n                }\r\n                \r\n                // Check if target is destroyed or too far away\r\n                if (!this.targetAsteroid.mesh.parent || \r\n                    this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position) > this.scanRadius) {\r\n                    this.scanForAsteroids();\r\n                }\r\n            }\r\n            \r\n            // Always show the reticle when targeting\r\n            this.targetReticle.visible = true;\r\n            \r\n            // Simplified off-screen indicator (check less frequently)\r\n            if (this.uiUpdateCounter === 15) {  // Check half-way through UI update cycle\r\n                const isOnScreen = this.isTargetOnScreen();\r\n                if (!isOnScreen) {\r\n                    const screenPosition = this.getScreenPosition(this.targetAsteroid.mesh.position);\r\n                    const targetDirection = this.getTargetDirection();\r\n                    this.showOffScreenIndicator(screenPosition, targetDirection);\r\n                } else {\r\n                    this.hideOffScreenIndicators();\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    setTarget(target) {\r\n        try {\r\n            console.log(\"TargetingSystem: setTarget called\", target);\r\n            \r\n            // Validate the target\r\n            if (!target) {\r\n                console.error(\"TargetingSystem: Cannot set null target\");\r\n                return;\r\n            }\r\n            \r\n            if (!target.mesh || !target.mesh.position) {\r\n                console.error(\"TargetingSystem: Target is missing mesh or position properties\", target);\r\n                return;\r\n            }\r\n            \r\n            // Set the target\r\n            this.targetAsteroid = target;\r\n            \r\n            // Update UI elements\r\n            if (this.targetDisplay) {\r\n                this.targetDisplay.style.display = 'block';\r\n            }\r\n            \r\n            if (this.targetInfoElement) {\r\n                // Format target info\r\n                const distance = this.calculateDistanceToTarget();\r\n                let resourceType = target.resourceType || 'Unknown';\r\n                \r\n                // Capitalize first letter\r\n                resourceType = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);\r\n                \r\n                // Update target info text\r\n                this.targetInfoElement.textContent = `${resourceType} Asteroid - ${distance.toFixed(0)}m`;\r\n                this.targetInfoElement.style.color = '#30cfd0';\r\n                this.targetInfoElement.style.display = 'block';\r\n            }\r\n            \r\n            console.log(\"TargetingSystem: Target successfully set\", this.targetAsteroid);\r\n            \r\n            // Enable lock-on\r\n            this.lockOnEnabled = true;\r\n            \r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"TargetingSystem: Error in setTarget:\", error);\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    calculateDistanceToTarget() {\r\n        try {\r\n            if (!this.targetAsteroid || !this.targetAsteroid.mesh || !this.targetAsteroid.mesh.position) {\r\n                console.error(\"TargetingSystem: Cannot calculate distance - invalid target asteroid\");\r\n                return Infinity;\r\n            }\r\n            \r\n            if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\r\n                console.error(\"TargetingSystem: Cannot calculate distance - invalid spaceship\");\r\n                return Infinity;\r\n            }\r\n            \r\n            const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\r\n            return distance;\r\n        } catch (error) {\r\n            console.error(\"TargetingSystem: Error calculating distance to target:\", error);\r\n            return Infinity;\r\n        }\r\n    }\r\n    \r\n    // Add methods for off-screen indicators\r\n    createOffScreenIndicators() {\r\n        // Create container for off-screen indicators\r\n        this.offScreenContainer = document.createElement('div');\r\n        this.offScreenContainer.id = 'off-screen-indicators';\r\n        this.offScreenContainer.style.position = 'absolute';\r\n        this.offScreenContainer.style.top = '0';\r\n        this.offScreenContainer.style.left = '0';\r\n        this.offScreenContainer.style.width = '100%';\r\n        this.offScreenContainer.style.height = '100%';\r\n        this.offScreenContainer.style.pointerEvents = 'none';\r\n        this.offScreenContainer.style.display = 'none';\r\n        document.body.appendChild(this.offScreenContainer);\r\n        \r\n        // Create the arrow indicator\r\n        this.offScreenIndicator = document.createElement('div');\r\n        this.offScreenIndicator.style.position = 'absolute';\r\n        this.offScreenIndicator.style.width = '30px';\r\n        this.offScreenIndicator.style.height = '30px';\r\n        this.offScreenIndicator.innerHTML = `\r\n            <svg width=\"30\" height=\"30\" viewBox=\"0 0 30 30\">\r\n                <polygon points=\"15,0 30,30 15,22 0,30\" fill=\"#ff3030\" />\r\n            </svg>\r\n        `;\r\n        this.offScreenIndicator.style.transformOrigin = 'center center';\r\n        this.offScreenIndicator.style.display = 'none';\r\n        this.offScreenContainer.appendChild(this.offScreenIndicator);\r\n    }\r\n    \r\n    hideOffScreenIndicators() {\r\n        if (this.offScreenContainer) {\r\n            this.offScreenContainer.style.display = 'none';\r\n        }\r\n        if (this.offScreenIndicator) {\r\n            this.offScreenIndicator.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    showOffScreenIndicator(screenPosition, targetDirection) {\r\n        if (!this.offScreenContainer || !this.offScreenIndicator) return;\r\n        \r\n        // Show container\r\n        this.offScreenContainer.style.display = 'block';\r\n        this.offScreenIndicator.style.display = 'block';\r\n        \r\n        // Calculate angle for the arrow to point at target\r\n        const angle = Math.atan2(targetDirection.y, targetDirection.x) * (180 / Math.PI);\r\n        \r\n        // Position at the edge of screen\r\n        const margin = 50; // Margin from the screen edge\r\n        const halfWidth = window.innerWidth / 2;\r\n        const halfHeight = window.innerHeight / 2;\r\n        \r\n        // Normalize direction vector\r\n        const normalizedDir = new THREE.Vector2(targetDirection.x, targetDirection.y).normalize();\r\n        \r\n        // Calculate intersection with screen edge\r\n        let edgeX, edgeY;\r\n        \r\n        // Check if we're intersecting with the vertical or horizontal edge\r\n        const slopeRatio = Math.abs(normalizedDir.y / normalizedDir.x);\r\n        const screenRatio = halfHeight / halfWidth;\r\n        \r\n        if (slopeRatio > screenRatio) {\r\n            // Intersect with top/bottom edge\r\n            edgeY = normalizedDir.y > 0 ? halfHeight - margin : -halfHeight + margin;\r\n            edgeX = edgeY / normalizedDir.y * normalizedDir.x;\r\n        } else {\r\n            // Intersect with left/right edge\r\n            edgeX = normalizedDir.x > 0 ? halfWidth - margin : -halfWidth + margin;\r\n            edgeY = edgeX / normalizedDir.x * normalizedDir.y;\r\n        }\r\n        \r\n        // Position the indicator at the edge of the screen\r\n        this.offScreenIndicator.style.left = (halfWidth + edgeX) + 'px';\r\n        this.offScreenIndicator.style.top = (halfHeight + edgeY) + 'px';\r\n        this.offScreenIndicator.style.transform = `rotate(${angle}deg)`;\r\n    }\r\n    \r\n    // Helper methods for screen position calculations\r\n    isTargetOnScreen() {\r\n        if (!this.targetAsteroid || !this.targetAsteroid.mesh) return false;\r\n        \r\n        const screenPosition = this.getScreenPosition(this.targetAsteroid.mesh.position);\r\n        \r\n        // Check if position is within screen bounds with some margin\r\n        const margin = 0.1; // 10% margin\r\n        return screenPosition.x >= -1 + margin && \r\n               screenPosition.x <= 1 - margin && \r\n               screenPosition.y >= -1 + margin && \r\n               screenPosition.y <= 1 - margin;\r\n    }\r\n    \r\n    getScreenPosition(worldPosition) {\r\n        // Create a copy of the position\r\n        const tempVector = new THREE.Vector3().copy(worldPosition);\r\n        \r\n        // Project to screen space\r\n        tempVector.project(this.scene.camera);\r\n        \r\n        return new THREE.Vector2(tempVector.x, tempVector.y);\r\n    }\r\n    \r\n    getTargetDirection() {\r\n        // Get normalized direction vector from screen center to target\r\n        const screenPosition = this.getScreenPosition(this.targetAsteroid.mesh.position);\r\n        \r\n        // Create a direction vector from screen center to target position\r\n        return new THREE.Vector2(screenPosition.x, screenPosition.y);\r\n    }\r\n} ","// dockingSystem.js - Handles stargate docking and trading\r\n\r\nexport class DockingSystem {\r\n    constructor(spaceship, stargate, ui) {\r\n        this.spaceship = spaceship;\r\n        this.stargate = stargate;\r\n        this.ui = ui;\r\n        \r\n        this.nearStargate = false;\r\n        this.isDocked = this.spaceship.isDocked; // Initialize with spaceship's docked state\r\n        \r\n        // Preemptively set a safe undocking position\r\n        if (this.spaceship && this.spaceship.undockLocation && this.stargate) {\r\n            // Position in the middle of the stargate\r\n            this.spaceship.undockLocation.set(0, 10000, 0);\r\n        }\r\n        \r\n        console.log(\"Initializing docking system, ship is \" + (this.isDocked ? \"docked\" : \"undocked\"));\r\n        this.setupDockingControls();\r\n        \r\n        // If we're starting docked, publish the player.docked event immediately\r\n        if (this.isDocked && this.spaceship.world && this.spaceship.world.messageBus) {\r\n            this.spaceship.world.messageBus.publish('player.docked', {\r\n                playerPosition: this.spaceship.mesh ? this.spaceship.mesh.position.clone() : null,\r\n                stargate: this.stargate\r\n            });\r\n            console.log(\"Published initial player.docked event\");\r\n        }\r\n    }\r\n    \r\n    setupDockingControls() {\r\n        // Add docking key handler (Q key)\r\n        document.addEventListener('keydown', e => {\r\n            if (e.key.toLowerCase() === 'q') {\r\n                if (this.nearStargate && !this.spaceship.isDocked) {\r\n                    console.log(\"Q key pressed: Docking with stargate\");\r\n                    this.dockWithStargate();\r\n                } else if (this.spaceship.isDocked) {\r\n                    console.log(\"Q key pressed while docked: No action (use Undock button)\");\r\n                } else if (!this.nearStargate) {\r\n                    console.log(\"Q key pressed but not near stargate\");\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Set up stargate UI button handlers\r\n        this.setupStargateUIControls();\r\n    }\r\n    \r\n    setupStargateUIControls() {\r\n        // Set up refuel button\r\n        const refuelBtn = document.getElementById('refuel-btn');\r\n        if (refuelBtn) {\r\n            refuelBtn.addEventListener('click', () => {\r\n                if (this.spaceship.credits >= 100) {\r\n                    this.spaceship.credits -= this.spaceship.refuel();\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Set up shield repair button\r\n        const repairShieldBtn = document.getElementById('repair-shield-btn');\r\n        if (repairShieldBtn) {\r\n            repairShieldBtn.addEventListener('click', () => {\r\n                if (this.spaceship.credits >= 150) {\r\n                    this.spaceship.credits -= this.spaceship.repairShield();\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Set up hull repair button\r\n        const repairHullBtn = document.getElementById('repair-hull-btn');\r\n        if (repairHullBtn) {\r\n            repairHullBtn.addEventListener('click', () => {\r\n                if (this.spaceship.credits >= 200) {\r\n                    this.spaceship.credits -= this.spaceship.repairHull();\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Set up undock button\r\n        const undockBtn = document.getElementById('undock-btn');\r\n        if (undockBtn) {\r\n            // Use both click and touchend events for better Android compatibility\r\n            const handleUndock = (e) => {\r\n                // Prevent any default action that might interfere\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n                \r\n                // Log which event triggered the undock\r\n                console.log(`Undock button ${e.type} event triggered`);\r\n\r\n                // Add a small delay to ensure the event completes on Android\r\n                if (this.isMobileDevice()) {\r\n                    // For Android, remove the overlay classes immediately\r\n                    document.body.classList.remove('undocking', 'modal-open');\r\n                    // Set a brief timeout to allow touch event to complete\r\n                    setTimeout(() => {\r\n                        this.undockFromStargate();\r\n                    }, 50);\r\n                } else {\r\n                    this.undockFromStargate();\r\n                }\r\n            };\r\n            \r\n            // Add both event listeners for better compatibility\r\n            undockBtn.addEventListener('click', handleUndock);\r\n            undockBtn.addEventListener('touchend', handleUndock);\r\n            \r\n            // Prevent any touch events from being captured or blocked\r\n            undockBtn.addEventListener('touchstart', (e) => {\r\n                console.log(\"Touch started on undock button\");\r\n                e.stopPropagation();\r\n            }, { passive: false });\r\n        }\r\n        \r\n        // Set up resource selling buttons\r\n        this.setupSellingButtons();\r\n        \r\n        // Set up upgrade buttons\r\n        this.setupUpgradeButtons();\r\n    }\r\n    \r\n    setupSellingButtons() {\r\n        const sellIronBtn = document.getElementById('sell-iron');\r\n        if (sellIronBtn) {\r\n            sellIronBtn.addEventListener('click', () => {\r\n                if (this.resources.iron > 0) {\r\n                    this.spaceship.credits += this.resources.iron * 10;\r\n                    this.resources.iron = 0;\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n        \r\n        const sellGoldBtn = document.getElementById('sell-gold');\r\n        if (sellGoldBtn) {\r\n            sellGoldBtn.addEventListener('click', () => {\r\n                if (this.resources.gold > 0) {\r\n                    this.spaceship.credits += this.resources.gold * 50;\r\n                    this.resources.gold = 0;\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n        \r\n        const sellPlatinumBtn = document.getElementById('sell-platinum');\r\n        if (sellPlatinumBtn) {\r\n            sellPlatinumBtn.addEventListener('click', () => {\r\n                if (this.resources.platinum > 0) {\r\n                    this.spaceship.credits += this.resources.platinum * 200;\r\n                    this.resources.platinum = 0;\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n    setupUpgradeButtons() {\r\n        // Fuel tank upgrade button handler\r\n        this.setupUpgradeButton('upgrade-fuel-tank', \r\n            () => this.spaceship.fuelUpgradeCost,\r\n            () => this.spaceship.upgradeFuelTank());\r\n        \r\n        // Engine upgrade button handler\r\n        this.setupUpgradeButton('upgrade-engine', \r\n            () => this.spaceship.engineUpgradeCost,\r\n            () => this.spaceship.upgradeEngine());\r\n        \r\n        // Mining laser upgrade button handler\r\n        this.setupUpgradeButton('upgrade-mining', \r\n            () => this.spaceship.miningUpgradeCost,\r\n            () => this.spaceship.upgradeMiningLaser());\r\n        \r\n        // Hull upgrade button handler\r\n        this.setupUpgradeButton('upgrade-hull', \r\n            () => this.spaceship.hullUpgradeCost,\r\n            () => this.spaceship.upgradeHull());\r\n        \r\n        // Scanner upgrade button handler\r\n        this.setupUpgradeButton('upgrade-scanner', \r\n            () => this.spaceship.scannerUpgradeCost,\r\n            () => this.spaceship.upgradeScanner());\r\n    }\r\n    \r\n    // Helper method to set up an upgrade button with a given cost getter and upgrade function\r\n    setupUpgradeButton(buttonId, costGetter, upgradeFunction) {\r\n        const button = document.getElementById(buttonId);\r\n        if (button) {\r\n            button.addEventListener('click', () => {\r\n                const cost = costGetter();\r\n                if (this.spaceship.credits >= cost) {\r\n                    this.spaceship.credits -= cost;\r\n                    upgradeFunction();\r\n                    \r\n                    // Update the mining system's efficiency if we upgraded the mining laser\r\n                    if (buttonId === 'upgrade-mining' && this.updateMiningSystem) {\r\n                        this.updateMiningSystem();\r\n                    }\r\n                    \r\n                    // Update UI\r\n                    this.updateStargateUI();\r\n                }\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Method to update the mining system when mining efficiency is upgraded\r\n    updateMiningSystem() {\r\n        // Find the mining system through the Controls object to pass the new efficiency\r\n        if (this.ui && this.ui.controls && this.ui.controls.miningSystem) {\r\n            // Apply the mining efficiency to the mining speed\r\n            const miningSystem = this.ui.controls.miningSystem;\r\n            \r\n            // Update mining speeds for each resource type based on the new efficiency\r\n            Object.keys(miningSystem.miningSpeedByType).forEach(resourceType => {\r\n                const baseSpeed = miningSystem.miningSpeedByType[resourceType];\r\n                miningSystem.miningSpeedByType[resourceType] = \r\n                    baseSpeed * this.spaceship.miningEfficiency;\r\n            });\r\n            \r\n            console.log(\"Mining system updated with new efficiency:\", this.spaceship.miningEfficiency);\r\n        }\r\n    }\r\n    \r\n    dockWithStargate() {\r\n        console.log(\"Docking with stargate\");\r\n        \r\n        // Only update ship state if it's not already docked\r\n        if (!this.spaceship.isDocked) {\r\n            // Dock the ship\r\n            this.spaceship.dock();\r\n            this.isDocked = true;\r\n            \r\n            // Publish the player.docked event for enemy system and other systems to respond\r\n            if (this.spaceship.world && this.spaceship.world.messageBus) {\r\n                this.spaceship.world.messageBus.publish('player.docked', {\r\n                    playerPosition: this.spaceship.mesh.position.clone(),\r\n                    stargate: this.stargate\r\n                });\r\n                console.log(\"Published player.docked event\");\r\n            }\r\n        } else {\r\n            console.log(\"Ship is already docked, just showing UI\");\r\n        }\r\n        \r\n        // Mobile-specific preparation - ensure all classes that might block UI visibility are removed\r\n        if (this.isMobileDevice()) {\r\n            console.log(\"Mobile device detected - preparing for stargate UI\");\r\n            document.body.classList.remove('undocking', 'modal-open');\r\n            \r\n            // Reset any problematic styles that might prevent UI from showing\r\n            document.body.style.position = 'static';\r\n            document.body.style.touchAction = 'auto';\r\n            document.body.style.pointerEvents = 'auto';\r\n            document.body.style.overflow = 'auto';\r\n        }\r\n        \r\n        // Show the stargate UI\r\n        if (this.ui && this.ui.stargateInterface) {\r\n            console.log(\"Showing stargate UI...\");\r\n            this.ui.stargateInterface.showStargateUI();\r\n            \r\n            // Double-check visibility on mobile with a small delay\r\n            if (this.isMobileDevice()) {\r\n                setTimeout(() => {\r\n                    const stargateUI = document.getElementById('stargate-ui');\r\n                    if (stargateUI && stargateUI.style.display !== 'block') {\r\n                        console.log(\"Forcing stargate UI display\");\r\n                        stargateUI.style.display = 'block';\r\n                    }\r\n                }, 100);\r\n            }\r\n        }\r\n        \r\n        // Hide game UI elements\r\n        if (this.ui) {\r\n            this.ui.hideUI();\r\n        }\r\n        \r\n        // Exit pointer lock so cursor is visible for UI interactions\r\n        if (document.pointerLockElement) {\r\n            document.exitPointerLock();\r\n            console.log(\"Exited pointer lock for UI interaction\");\r\n        }\r\n        \r\n        // Update the stargate UI with current values\r\n        this.updateStargateUI();\r\n    }\r\n    \r\n    // Helper to wrap steps in requestAnimationFrame for smoother UI updates\r\n    async performStep(stepFunction, stepName) {\r\n        return new Promise(resolve => {\r\n            requestAnimationFrame(() => {\r\n                try {\r\n                    stepFunction();\r\n                    console.log(`Completed step: ${stepName}`);\r\n                } catch (err) {\r\n                    console.error(`Error during step ${stepName}:`, err);\r\n                }\r\n                resolve();\r\n            });\r\n        });\r\n    }\r\n\r\n    // Helper to yield control to the browser\r\n    async yieldToBrowser() {\r\n        return new Promise(resolve => requestAnimationFrame(resolve));\r\n    }\r\n\r\n    // Optimized method to hide UI elements using a single reflow\r\n    hideStargateUI() {\r\n        if (this.ui && this.ui.stargateInterface) {\r\n            // Use CSS class for better performance\r\n            document.body.classList.add('undocking');\r\n            this.ui.stargateInterface.hideStargateUI();\r\n            console.log(\"Hiding stargate interface\");\r\n        }\r\n    }\r\n\r\n    // Optimized method to show game UI elements using a single reflow\r\n    showGameUI() {\r\n        if (this.ui) {\r\n            // Use CSS class for better performance\r\n            document.body.classList.remove('undocking');\r\n            this.ui.showUI();\r\n            console.log(\"Showing game UI\");\r\n        }\r\n    }\r\n\r\n    // Optimized method to reset mobile styles\r\n    resetMobileStyles() {\r\n        // Immediately remove problematic classes for Android\r\n        if (this.isMobileDevice()) {\r\n            document.body.classList.remove('undocking', 'modal-open');\r\n        }\r\n        \r\n        // Batch style changes to minimize reflows\r\n        requestAnimationFrame(() => {\r\n            // FIX: More aggressive style clearing for Android\r\n            document.body.style.cssText = '';\r\n            document.body.style.overflow = 'auto';\r\n            document.body.style.position = 'static';\r\n            document.body.style.height = 'auto';\r\n            document.body.style.width = 'auto';\r\n            document.body.style.touchAction = 'auto';\r\n            document.body.style.pointerEvents = 'auto';\r\n            document.body.style.webkitOverflowScrolling = 'touch';\r\n            \r\n            // FIX: Ensure all restrictive classes are removed to prevent touch event issues\r\n            document.body.classList.remove('modal-open', 'undocking');\r\n            \r\n            // Reset scrollable containers in a single pass\r\n            document.querySelectorAll('.modal-content, #stargate-ui, #star-map').forEach(container => {\r\n                if (container && container.style) {\r\n                    container.style.cssText = 'overflow: auto; -webkit-overflow-scrolling: touch;';\r\n                    container.scrollTop = 0;\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    async undockFromStargate() {\r\n        if (!this.spaceship.isDocked) {\r\n            console.log(\"Not docked, can't undock\");\r\n            return;\r\n        }\r\n\r\n        // FIX: For Android, immediately remove any classes that might block touch events\r\n        if (this.isMobileDevice()) {\r\n            document.body.classList.remove('undocking');\r\n            this.resetMobileStyles();\r\n        }\r\n\r\n        // Show loading indicator\r\n        const loadingIndicator = document.createElement('div');\r\n        loadingIndicator.className = 'undocking-indicator';\r\n        loadingIndicator.textContent = 'Undocking...';\r\n        document.body.appendChild(loadingIndicator);\r\n\r\n        try {\r\n            console.log(\"Starting undock sequence...\");\r\n            \r\n            // Store shield value before any changes\r\n            this.preUndockShieldValue = this.spaceship.shield;\r\n            console.log(`Storing pre-undock shield value: ${this.preUndockShieldValue}`);\r\n\r\n            // Step 1: Close all modals\r\n            await this.performStep(() => this.closeAllModals(), \"Closing modals\");\r\n            await this.yieldToBrowser();\r\n\r\n            // Step 2: Handle mobile-specific cleanup\r\n            if (this.isMobileDevice()) {\r\n                await this.performStep(() => this.resetMobileStyles(), \"Resetting mobile styles\");\r\n                await this.yieldToBrowser();\r\n            }\r\n\r\n            // Step 3: Hide stargate UI and show game UI\r\n            await this.performStep(() => this.hideStargateUI(), \"Hiding stargate UI\");\r\n            await this.yieldToBrowser();\r\n            \r\n            await this.performStep(() => this.showGameUI(), \"Showing game UI\");\r\n            await this.yieldToBrowser();\r\n\r\n            // Step 4: Perform core undock logic\r\n            console.log(\"Performing core undock...\");\r\n            const newPosition = this.spaceship.undock();\r\n            \r\n            // Step 5: Sync health values immediately\r\n            console.log(\"Syncing health values...\");\r\n            \r\n            // Check for shield reset issue\r\n            if (this.spaceship.shield === 0 && this.preUndockShieldValue > 0) {\r\n                console.log(`Fixing shield reset: Restoring to ${this.preUndockShieldValue}`);\r\n                this.spaceship.shield = this.preUndockShieldValue;\r\n            }\r\n\r\n            // Sync values immediately without setTimeout\r\n            this.spaceship.syncValuesToHealthComponent();\r\n\r\n            // Publish undocked event with correct state\r\n            const healthData = {\r\n                shield: this.spaceship.shield,\r\n                maxShield: this.spaceship.maxShield,\r\n                hull: this.spaceship.hull,\r\n                maxHull: this.spaceship.maxHull\r\n            };\r\n\r\n            // Publish to appropriate message bus\r\n            const messageBus = window.game?.messageBus || window.mainMessageBus;\r\n            if (messageBus) {\r\n                messageBus.publish('player.undocked', healthData);\r\n                console.log(\"Published player.undocked event with health values:\", healthData);\r\n            }\r\n\r\n            // Reset docking status\r\n            this.dockingAvailable = false;\r\n\r\n            // Request pointer lock if needed (non-mobile only)\r\n            if (this.autoPointerLockOnUndock && !this.isMobileDevice()) {\r\n                await this.performStep(() => this.requestPointerLock(), \"Requesting pointer lock\");\r\n            }\r\n\r\n            console.log(\"Undock sequence complete\");\r\n            \r\n        } catch (error) {\r\n            console.error(\"Error during undocking:\", error);\r\n        } finally {\r\n            // Clean up loading indicator\r\n            if (document.body.contains(loadingIndicator)) {\r\n                document.body.removeChild(loadingIndicator);\r\n            }\r\n            \r\n            // FIX: More aggressive cleanup for Android devices\r\n            if (this.isMobileDevice()) {\r\n                // Clear all restrictive classes\r\n                document.body.classList.remove('undocking', 'modal-open');\r\n                \r\n                // Force resetMobileStyles again to ensure all touch restrictions are removed\r\n                this.resetMobileStyles();\r\n                \r\n                // Ensure specific problematic styles are cleared\r\n                document.body.style.pointerEvents = '';\r\n                document.body.style.touchAction = '';\r\n                document.body.style.overflowY = '';\r\n                document.body.style.position = '';\r\n            } else {\r\n                document.body.classList.remove('undocking');\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Method to detect mobile devices\r\n    isMobileDevice() {\r\n        return ('ontouchstart' in window) || \r\n               (navigator.maxTouchPoints > 0) || \r\n               (navigator.msMaxTouchPoints > 0) ||\r\n               (window.innerWidth < 900);\r\n    }\r\n    \r\n    // Method to close any open modal UI that might conflict with undocking\r\n    closeAllModals() {\r\n        try {\r\n            // Close custom system creator if it's open\r\n            const customSystemCreator = document.getElementById('custom-system-creator');\r\n            if (customSystemCreator && window.getComputedStyle(customSystemCreator).display !== 'none') {\r\n                console.log(\"Closing custom system creator before undocking\");\r\n                // See if we can find the close button and simulate a click\r\n                const closeBtn = customSystemCreator.querySelector('#close-system-creator');\r\n                if (closeBtn) {\r\n                    closeBtn.click();\r\n                } else {\r\n                    // Otherwise just hide it directly\r\n                    customSystemCreator.style.display = 'none';\r\n                }\r\n                \r\n                // Force game objects to clean up their modal state\r\n                if (window.game && window.game.ui) {\r\n                    // Check for star map\r\n                    if (window.game.ui.starMap && typeof window.game.ui.starMap.hide === 'function') {\r\n                        window.game.ui.starMap.hide();\r\n                    }\r\n                    \r\n                    // Check for custom system creator\r\n                    if (window.game.ui.customSystemCreator && typeof window.game.ui.customSystemCreator.hide === 'function') {\r\n                        window.game.ui.customSystemCreator.hide();\r\n                    }\r\n                    \r\n                    // Cleanup any modal state on the body\r\n                    document.body.classList.remove('modal-open');\r\n                }\r\n            }\r\n            \r\n            // Close star map if open\r\n            const starMap = document.getElementById('star-map');\r\n            if (starMap && window.getComputedStyle(starMap).display !== 'none') {\r\n                console.log(\"Closing star map before undocking\");\r\n                const closeStarMapBtn = starMap.querySelector('#close-star-map');\r\n                if (closeStarMapBtn) {\r\n                    closeStarMapBtn.click();\r\n                } else {\r\n                    starMap.style.display = 'none';\r\n                }\r\n            }\r\n            \r\n            // Close any other modals\r\n            const allModals = document.querySelectorAll('.modal-container');\r\n            allModals.forEach(modal => {\r\n                if (window.getComputedStyle(modal).display !== 'none') {\r\n                    console.log(\"Closing modal before undocking:\", modal.id || 'unnamed modal');\r\n                    modal.style.display = 'none';\r\n                }\r\n            });\r\n        } catch (err) {\r\n            console.warn(\"Error while closing modals:\", err);\r\n        }\r\n    }\r\n    \r\n    // Helper method to request pointer lock\r\n    requestPointerLock() {\r\n        // Find the canvas element (it should be the first one in the document)\r\n        const canvas = document.querySelector('canvas');\r\n        if (canvas && !document.pointerLockElement) {\r\n            // Request pointer lock with a slight delay to ensure UI transitions are complete\r\n            setTimeout(() => {\r\n                canvas.requestPointerLock();\r\n                console.log(\"Requested pointer lock for ship control\");\r\n            }, 200);\r\n        }\r\n    }\r\n    \r\n    updateStargateUI() {\r\n        if (this.ui && this.ui.stargateInterface) {\r\n            this.ui.stargateInterface.updateStargateUI(this.spaceship, this.resources);\r\n        }\r\n    }\r\n    \r\n    checkStargateProximity() {\r\n        if (this.spaceship.isDocked) return;\r\n        \r\n        if (!this.stargate || !this.spaceship || !this.spaceship.mesh) return;\r\n        \r\n        const stargatePosition = this.stargate.getPosition();\r\n        if (!stargatePosition) return;\r\n        \r\n        const distance = this.spaceship.mesh.position.distanceTo(stargatePosition);\r\n        \r\n        if (distance < 2000) { // Within docking range (4x the original 500)\r\n            this.nearStargate = true;\r\n            if (this.ui && this.ui.stargateInterface) {\r\n                this.ui.stargateInterface.showDockingPrompt();\r\n            }\r\n            // Also show the dock button in touch controls for mobile\r\n            if (this.ui && this.ui.controls && this.ui.controls.isMobile && \r\n                this.ui.controls.touchControls) {\r\n                this.ui.controls.touchControls.showDockButton();\r\n            }\r\n        } else {\r\n            this.nearStargate = false;\r\n            if (this.ui && this.ui.stargateInterface) {\r\n                this.ui.stargateInterface.hideDockingPrompt();\r\n            }\r\n            // Also hide the dock button in touch controls for mobile\r\n            if (this.ui && this.ui.controls && this.ui.controls.isMobile && \r\n                this.ui.controls.touchControls) {\r\n                this.ui.controls.touchControls.hideDockButton();\r\n            }\r\n        }\r\n    }\r\n    \r\n    update() {\r\n        // Check if near stargate for docking\r\n        this.checkStargateProximity();\r\n    }\r\n    \r\n    // Setter for resources to allow dependency injection\r\n    setResources(resources) {\r\n        this.resources = resources;\r\n    }\r\n}","// touchControls.js - Touch controls for mobile devices using nipple.js\r\n\r\nexport class TouchControls {\r\n    constructor(spaceship, physics) {\r\n        this.spaceship = spaceship;\r\n        this.physics = physics;\r\n        this.leftJoystick = null;\r\n        this.rightJoystick = null;\r\n        this.dockButton = null;\r\n        this.mineButton = null;\r\n        this.fireButton = null;\r\n        this.targetButton = null;\r\n        this.isInitialized = false;\r\n        \r\n        // Store references to systems we need to interact with\r\n        this.miningSystem = null;\r\n        this.targetingSystem = null;\r\n        this.dockingSystem = null;\r\n        this.weaponSystem = null;\r\n        \r\n        // Thresholds for joystick input\r\n        this.threshold = 0.1;\r\n        \r\n        // Add crosshair\r\n        this.createCrosshair();\r\n        \r\n        // Load nipple.js script\r\n        this.loadNippleJS().then(() => {\r\n            this.setupTouchControls();\r\n        }).catch(err => {\r\n            console.error('Failed to load nipple.js:', err);\r\n        });\r\n    }\r\n    \r\n    // Method to set the systems we need to interact with\r\n    setControlSystems(controls) {\r\n        console.log(\"TouchControls: Setting control systems\");\r\n        \r\n        if (!controls) {\r\n            console.error(\"TouchControls: Controls object is null or undefined\");\r\n            return;\r\n        }\r\n        \r\n        // Store references to systems\r\n        this.miningSystem = controls.miningSystem;\r\n        this.targetingSystem = controls.targetingSystem;\r\n        this.dockingSystem = controls.dockingSystem;\r\n        this.weaponSystem = controls.weaponSystem;\r\n        \r\n        // Extra check for weapon system that might be Combat instance\r\n        if (this.weaponSystem && !this.weaponSystem.setFiring && this.weaponSystem.isFiring !== undefined) {\r\n            console.log(\"TouchControls: weaponSystem is likely a Combat instance, adapting interface\");\r\n            // Create adapter functions if needed\r\n        }\r\n        \r\n        // Log all connections with details\r\n        const systemStatus = {\r\n            hasMiningSystem: !!this.miningSystem,\r\n            miningSystemType: this.miningSystem ? this.miningSystem.constructor.name : \"Not set\",\r\n            hasTargetingSystem: !!this.targetingSystem,\r\n            targetingSystemType: this.targetingSystem ? this.targetingSystem.constructor.name : \"Not set\",\r\n            hasDockingSystem: !!this.dockingSystem,\r\n            dockingSystemType: this.dockingSystem ? this.dockingSystem.constructor.name : \"Not set\",\r\n            hasWeaponSystem: !!this.weaponSystem,\r\n            weaponSystemType: this.weaponSystem ? this.weaponSystem.constructor.name : \"Not set\"\r\n        };\r\n        \r\n        console.log(\"TouchControls: Systems connected\", systemStatus);\r\n        \r\n        if (!this.miningSystem) {\r\n            console.error(\"TouchControls: Mining system is not connected - mining won't work!\");\r\n        }\r\n        \r\n        if (!this.targetingSystem) {\r\n            console.error(\"TouchControls: Targeting system is not connected - targeting won't work!\");\r\n        }\r\n        \r\n        // Store reference to spaceship from controls if not already set\r\n        if (!this.spaceship && controls.spaceship) {\r\n            this.spaceship = controls.spaceship;\r\n            console.log(\"TouchControls: Spaceship reference set from controls\");\r\n        }\r\n        \r\n        return this; // For method chaining\r\n    }\r\n    \r\n    createCrosshair() {\r\n        // Create a small crosshair in the center of the screen\r\n        const crosshair = document.createElement('div');\r\n        crosshair.id = 'mobile-crosshair';\r\n        crosshair.style.position = 'absolute';\r\n        crosshair.style.top = '50%';\r\n        crosshair.style.left = '50%';\r\n        crosshair.style.transform = 'translate(-50%, -50%)';\r\n        crosshair.style.width = '10px';\r\n        crosshair.style.height = '10px';\r\n        crosshair.style.pointerEvents = 'none';\r\n        crosshair.style.zIndex = '999';\r\n        \r\n        // Create crosshair shape with a plus sign\r\n        crosshair.innerHTML = `\r\n            <div style=\"position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background-color: rgba(120, 220, 232, 0.8);\"></div>\r\n            <div style=\"position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background-color: rgba(120, 220, 232, 0.8);\"></div>\r\n            <div style=\"position: absolute; top: 50%; left: 50%; width: 3px; height: 3px; background-color: rgba(120, 220, 232, 0.8); border-radius: 50%; transform: translate(-50%, -50%);\"></div>\r\n        `;\r\n        \r\n        document.body.appendChild(crosshair);\r\n    }\r\n    \r\n    loadNippleJS() {\r\n        return new Promise((resolve, reject) => {\r\n            // Check if nipple.js is already loaded\r\n            if (window.nipplejs) {\r\n                resolve();\r\n                return;\r\n            }\r\n            \r\n            // Create script element\r\n            const script = document.createElement('script');\r\n            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js';\r\n            script.async = true;\r\n            \r\n            // Set up event handlers\r\n            script.onload = () => resolve();\r\n            script.onerror = () => reject(new Error('Failed to load nipple.js'));\r\n            \r\n            // Add script to document\r\n            document.head.appendChild(script);\r\n        });\r\n    }\r\n    \r\n    setupTouchControls() {\r\n        // Create container elements for joysticks\r\n        this.createJoystickZones();\r\n        \r\n        // Create action buttons\r\n        this.createActionButtons();\r\n        \r\n        // Initialize joysticks after a short delay to ensure DOM is ready\r\n        setTimeout(() => {\r\n            this.initializeJoysticks();\r\n            this.isInitialized = true;\r\n        }, 100);\r\n    }\r\n    \r\n    createJoystickZones() {\r\n        // Create left joystick zone (thrust control)\r\n        const leftJoystickZone = document.createElement('div');\r\n        leftJoystickZone.id = 'leftJoystickZone';\r\n        leftJoystickZone.style.position = 'absolute';\r\n        leftJoystickZone.style.bottom = '50px';\r\n        leftJoystickZone.style.left = '50px';\r\n        leftJoystickZone.style.width = '100px';\r\n        leftJoystickZone.style.height = '100px';\r\n        leftJoystickZone.style.zIndex = '1000';\r\n        \r\n        // Prevent default browser behavior to avoid scrolling when using joysticks\r\n        leftJoystickZone.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n        leftJoystickZone.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });\r\n        leftJoystickZone.addEventListener('touchend', (e) => e.preventDefault(), { passive: false });\r\n        \r\n        document.body.appendChild(leftJoystickZone);\r\n        \r\n        // Create right joystick zone (rotation control)\r\n        const rightJoystickZone = document.createElement('div');\r\n        rightJoystickZone.id = 'rightJoystickZone';\r\n        rightJoystickZone.style.position = 'absolute';\r\n        rightJoystickZone.style.bottom = '50px';\r\n        rightJoystickZone.style.right = '50px';\r\n        rightJoystickZone.style.width = '100px';\r\n        rightJoystickZone.style.height = '100px';\r\n        rightJoystickZone.style.zIndex = '1000';\r\n        \r\n        // Prevent default browser behavior to avoid scrolling when using joysticks\r\n        rightJoystickZone.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n        rightJoystickZone.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });\r\n        rightJoystickZone.addEventListener('touchend', (e) => e.preventDefault(), { passive: false });\r\n        \r\n        document.body.appendChild(rightJoystickZone);\r\n    }\r\n    \r\n    createActionButtons() {\r\n        // Create a container for left side action buttons\r\n        const leftActionButtonsContainer = document.createElement('div');\r\n        leftActionButtonsContainer.id = 'mobile-action-buttons-left';\r\n        leftActionButtonsContainer.style.position = 'absolute';\r\n        leftActionButtonsContainer.style.bottom = '170px';\r\n        leftActionButtonsContainer.style.left = '20px';\r\n        leftActionButtonsContainer.style.display = 'flex';\r\n        leftActionButtonsContainer.style.flexDirection = 'column';\r\n        leftActionButtonsContainer.style.gap = '15px';\r\n        leftActionButtonsContainer.style.zIndex = '1000';\r\n        document.body.appendChild(leftActionButtonsContainer);\r\n        \r\n        // Create a container for right side action buttons\r\n        const rightActionButtonsContainer = document.createElement('div');\r\n        rightActionButtonsContainer.id = 'mobile-action-buttons-right';\r\n        rightActionButtonsContainer.style.position = 'absolute';\r\n        rightActionButtonsContainer.style.bottom = '170px';\r\n        rightActionButtonsContainer.style.right = '20px';\r\n        rightActionButtonsContainer.style.display = 'flex';\r\n        rightActionButtonsContainer.style.flexDirection = 'column';\r\n        rightActionButtonsContainer.style.gap = '15px';\r\n        rightActionButtonsContainer.style.zIndex = '1000';\r\n        document.body.appendChild(rightActionButtonsContainer);\r\n        \r\n        // Create fire button (on left side)\r\n        this.fireButton = this.createActionButton(leftActionButtonsContainer, 'FIRE', 'rgba(255, 80, 80, 0.8)');\r\n        this.addButtonEvents(this.fireButton, this.handleFiringStart.bind(this), this.handleFiringEnd.bind(this));\r\n        \r\n        // Create mine button (on left side)\r\n        this.mineButton = this.createActionButton(leftActionButtonsContainer, 'MINE', 'rgba(120, 220, 232, 0.8)');\r\n        this.addButtonEvents(this.mineButton, this.handleMiningStart.bind(this), this.handleMiningEnd.bind(this));\r\n        \r\n        // Create target button (on right side)\r\n        this.targetButton = this.createActionButton(rightActionButtonsContainer, 'TARGET', 'rgba(255, 215, 0, 0.8)');\r\n        this.addButtonEvents(this.targetButton, this.handleTargeting.bind(this));\r\n        \r\n        // Create dock button (only shown when near stargate)\r\n        this.dockButton = this.createActionButton(null, 'DOCK', 'rgba(51, 153, 255, 0.8)');\r\n        this.dockButton.style.position = 'absolute';\r\n        this.dockButton.style.top = '50%';\r\n        this.dockButton.style.left = '50%';\r\n        this.dockButton.style.transform = 'translate(-50%, -50%)';\r\n        this.dockButton.style.width = '100px';  // Make dock button larger\r\n        this.dockButton.style.height = '100px'; // Make dock button larger\r\n        this.dockButton.style.fontSize = '20px'; // Larger text\r\n        this.dockButton.style.boxShadow = '0 0 25px rgba(51, 153, 255, 0.8)'; // Stronger glow\r\n        this.dockButton.style.zIndex = '10000'; \r\n        this.dockButton.style.display = 'none';\r\n        this.addButtonEvents(this.dockButton, this.handleDocking.bind(this));\r\n        document.body.appendChild(this.dockButton);\r\n        \r\n        // Create deploy laser button (on right side)\r\n        this.deployLaserButton = this.createActionButton(rightActionButtonsContainer, 'DEPLOY', 'rgba(255, 100, 100, 0.8)');\r\n        this.addButtonEvents(this.deployLaserButton, this.handleDeployLaser.bind(this));\r\n    }\r\n    \r\n    createActionButton(parent, text, color) {\r\n        const button = document.createElement('div');\r\n        button.className = 'mobile-action-button';\r\n        button.textContent = text;\r\n        button.style.width = '60px';\r\n        button.style.height = '60px'; \r\n        button.style.borderRadius = '50%';\r\n        button.style.backgroundColor = 'rgba(10, 20, 30, 0.7)';\r\n        button.style.border = `2px solid ${color}`;\r\n        button.style.color = color;\r\n        button.style.display = 'flex';\r\n        button.style.justifyContent = 'center';\r\n        button.style.alignItems = 'center';\r\n        button.style.fontFamily = '\"Rajdhani\", sans-serif';\r\n        button.style.fontSize = '16px';\r\n        button.style.fontWeight = 'bold';\r\n        button.style.boxShadow = `0 0 10px ${color}`;\r\n        button.style.userSelect = 'none';\r\n        button.style.touchAction = 'manipulation';\r\n        button.style.cursor = 'pointer';\r\n        \r\n        // Add hardware acceleration for better performance on mobile\r\n        button.style.transform = 'translateZ(0)';\r\n        button.style.webkitTapHighlightColor = 'transparent';\r\n        button.style.backfaceVisibility = 'hidden';\r\n        \r\n        if (parent) {\r\n            parent.appendChild(button);\r\n        }\r\n        \r\n        return button;\r\n    }\r\n    \r\n    initializeJoysticks() {\r\n        if (!window.nipplejs) {\r\n            console.error('nipplejs is not loaded');\r\n            return;\r\n        }\r\n        \r\n        // Initialize left joystick (thrust control)\r\n        this.leftJoystick = window.nipplejs.create({\r\n            zone: document.getElementById('leftJoystickZone'),\r\n            mode: 'static',\r\n            position: { left: '50%', top: '50%' },\r\n            color: 'rgba(120, 220, 232, 0.8)',\r\n            size: 100,\r\n            threshold: this.threshold,\r\n            dynamicPage: true, // Better performance for scrolling\r\n            fadeTime: 100, // Faster fade for better performance\r\n            lockX: false, // Allow X-axis movement\r\n            lockY: false  // Allow Y-axis movement\r\n        });\r\n        \r\n        // Initialize right joystick (rotation control)\r\n        this.rightJoystick = window.nipplejs.create({\r\n            zone: document.getElementById('rightJoystickZone'),\r\n            mode: 'static',\r\n            position: { left: '50%', top: '50%' },\r\n            color: 'rgba(120, 220, 232, 0.8)',\r\n            size: 100,\r\n            threshold: this.threshold,\r\n            dynamicPage: true, // Better performance for scrolling\r\n            fadeTime: 100, // Faster fade for better performance\r\n            lockX: false, // Allow X-axis movement\r\n            lockY: false  // Allow Y-axis movement\r\n        });\r\n        \r\n        // Set up event handlers for joysticks\r\n        this.setupJoystickEvents();\r\n    }\r\n    \r\n    setupJoystickEvents() {\r\n        // Left joystick events (thrust)\r\n        this.leftJoystick.on('move', (evt, data) => {\r\n            this.handleThrustJoystick(data);\r\n        }).on('end', () => {\r\n            this.resetThrust();\r\n        });\r\n        \r\n        // Right joystick events (rotation)\r\n        this.rightJoystick.on('move', (evt, data) => {\r\n            this.handleRotationJoystick(data);\r\n        }).on('end', () => {\r\n            // Do nothing on end - rotation is not continuous\r\n        });\r\n    }\r\n    \r\n    handleThrustJoystick(data) {\r\n        if (this.spaceship.isDocked) return;\r\n        \r\n        // Reset thrust directions\r\n        this.resetThrust();\r\n        \r\n        const force = data.force > 2 ? 2 : data.force; // Normalize force between 0-2\r\n        const angle = data.angle.radian;\r\n        \r\n        // Correct direction mapping based on standard joystick angles:\r\n        // In nipple.js, 0 radians = right, π/2 = up, π = left, 3π/2 = down\r\n        \r\n        // Up/North - Forward (around π/2 or 1.57 radians)\r\n        if (angle > 1.0 && angle < 2.0) {\r\n            this.spaceship.thrust.forward = true;\r\n        }\r\n        // Down/South - Backward (around 3π/2 or 4.71 radians)\r\n        else if (angle > 4.0 && angle < 5.5) {\r\n            this.spaceship.thrust.backward = true;\r\n        }\r\n        \r\n        // Left/West - Left (around π or 3.14 radians)\r\n        if (angle > 2.5 && angle < 4.0) {\r\n            this.spaceship.thrust.right = true;\r\n        }\r\n        // Right/East - Right (around 0 or 2π radians)\r\n        else if ((angle >= 0 && angle < 1.0) || angle > 5.5) {\r\n            this.spaceship.thrust.left = true;\r\n        }\r\n        \r\n        // Enable boost if force is high\r\n        this.spaceship.thrust.boost = force > 1.5;\r\n    }\r\n    \r\n    handleRotationJoystick(data) {\r\n        if (this.spaceship.isDocked) return;\r\n        \r\n        // Extract the X and Y components of the joystick vector\r\n        // Reduce sensitivity by lowering the multiplier from 0.05 to 0.015\r\n        const xMove = data.vector.x * data.force * 0.015;\r\n        // Invert the Y value to fix up/down control direction\r\n        const yMove = -data.vector.y * data.force * 0.015;\r\n        \r\n        // Update rotation via physics\r\n        this.physics.updateRotation(xMove, yMove);\r\n    }\r\n    \r\n    resetThrust() {\r\n        if (!this.spaceship) return;\r\n        \r\n        this.spaceship.thrust.forward = false;\r\n        this.spaceship.thrust.backward = false;\r\n        this.spaceship.thrust.left = false;\r\n        this.spaceship.thrust.right = false;\r\n        this.spaceship.thrust.boost = false;\r\n    }\r\n    \r\n    handleMiningStart() {\r\n        try {\r\n            console.log(\"TouchControls: handleMiningStart called\");\r\n            \r\n            // First ensure we have targeting and mining systems\r\n            if (!this.targetingSystem) {\r\n                console.error(\"TouchControls: Targeting system not available\");\r\n                return;\r\n            }\r\n            \r\n            if (!this.miningSystem) {\r\n                console.error(\"TouchControls: Mining system not available\");\r\n                return;\r\n            }\r\n            \r\n            // First, get the current target\r\n            let targetAsteroid = this.targetingSystem.getCurrentTarget();\r\n            console.log(\"TouchControls: Initial target:\", targetAsteroid);\r\n            \r\n            // If no target is selected, enable targeting and find nearest\r\n            if (!targetAsteroid) {\r\n                console.log(\"TouchControls: No target selected, enabling targeting and finding nearest target\");\r\n                \r\n                // Enable targeting if not already enabled\r\n                if (!this.targetingSystem.isLockOnEnabled()) {\r\n                    this.targetingSystem.toggleLockOn();\r\n                }\r\n                \r\n                // Find nearest target\r\n                targetAsteroid = this.targetingSystem.findNearestTarget();\r\n                console.log(\"TouchControls: Found nearest target:\", targetAsteroid);\r\n                \r\n                if (!targetAsteroid) {\r\n                    console.log(\"TouchControls: No targets in range after scan\");\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            // Essential validation: make sure we have a valid target asteroid with required properties\r\n            if (!targetAsteroid || !targetAsteroid.mesh || !targetAsteroid.mesh.position) {\r\n                console.error(\"TouchControls: Target asteroid is missing required properties\", targetAsteroid);\r\n                \r\n                // Try a different approach - get all asteroids from environment\r\n                const game = window.gameInstance || window.game;\r\n                if (game && game.environment && game.environment.asteroids && game.environment.asteroids.length > 0) {\r\n                    console.log(\"TouchControls: Attempting to get asteroid directly from environment\");\r\n                    // Find closest asteroid\r\n                    let closestDist = Infinity;\r\n                    let closestAsteroid = null;\r\n                    \r\n                    for (const asteroid of game.environment.asteroids) {\r\n                        if (asteroid && asteroid.mesh && asteroid.mesh.position && this.spaceship && this.spaceship.mesh) {\r\n                            const dist = asteroid.mesh.position.distanceTo(this.spaceship.mesh.position);\r\n                            if (dist < closestDist) {\r\n                                closestDist = dist;\r\n                                closestAsteroid = asteroid;\r\n                            }\r\n                        }\r\n                    }\r\n                    \r\n                    if (closestAsteroid) {\r\n                        console.log(\"TouchControls: Found closest asteroid from environment:\", closestAsteroid);\r\n                        targetAsteroid = closestAsteroid;\r\n                    } else {\r\n                        console.error(\"TouchControls: Could not find any valid asteroids in environment\");\r\n                        return;\r\n                    }\r\n                } else {\r\n                    console.error(\"TouchControls: Could not access environment to find asteroids\");\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            console.log(\"TouchControls: Target asteroid found:\", targetAsteroid);\r\n            \r\n            // Extra validation to make absolutely sure we have a valid targetAsteroid\r\n            if (!targetAsteroid || !targetAsteroid.mesh || !targetAsteroid.mesh.position) {\r\n                console.error(\"TouchControls: Target asteroid is still invalid after fallback attempts\");\r\n                return;\r\n            }\r\n            \r\n            // Explicitly set the target asteroid for mining\r\n            this.miningSystem.setTargetAsteroid(targetAsteroid);\r\n            \r\n            // Log asteroid details\r\n            console.log(\"TouchControls: Target set for mining:\", {\r\n                resourceType: targetAsteroid.resourceType || \"unknown\",\r\n                position: targetAsteroid.mesh ? targetAsteroid.mesh.position.toArray() : \"no mesh\",\r\n                distance: targetAsteroid.mesh && this.spaceship && this.spaceship.mesh ? \r\n                    targetAsteroid.mesh.position.distanceTo(this.spaceship.mesh.position) : \"unknown\"\r\n            });\r\n            \r\n            // Start mining\r\n            console.log(\"TouchControls: Starting mining operation\");\r\n            this.miningSystem.startMining();\r\n            \r\n            // Check if mining actually started\r\n            console.log(\"TouchControls: Mining started:\", this.miningSystem.isMining);\r\n            \r\n        } catch (error) {\r\n            console.error(\"TouchControls: Error in handleMiningStart:\", error);\r\n        }\r\n    }\r\n    \r\n    handleMiningEnd() {\r\n        try {\r\n            console.log(\"TouchControls: handleMiningEnd called\");\r\n            \r\n            // Make sure we have the mining system\r\n            if (!this.miningSystem) {\r\n                console.error(\"TouchControls: Mining system not available for stopping\");\r\n                return;\r\n            }\r\n            \r\n            // Stop mining\r\n            this.miningSystem.stopMining();\r\n            console.log(\"TouchControls: Mining stopped\");\r\n            \r\n        } catch (e) {\r\n            console.error(\"TouchControls: Error stopping mining:\", e);\r\n        }\r\n    }\r\n    \r\n    handleFiringStart() {\r\n        try {\r\n            // First try local reference to weapon system (which is actually the Combat class)\r\n            if (this.weaponSystem) {\r\n                // Attempt to use the setFiring method from the Combat class\r\n                if (typeof this.weaponSystem.setFiring === 'function') {\r\n                    this.weaponSystem.setFiring(true);\r\n                } else {\r\n                    // Fallback to the older isWeaponActive property\r\n                    this.weaponSystem.isWeaponActive = true;\r\n                }\r\n                \r\n                // Try to play sound if available\r\n                const game = window.gameInstance || window.game;\r\n                if (game && game.audio) {\r\n                    game.audio.playSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Fallback to global game reference\r\n            const game = window.gameInstance || window.game;\r\n            if (!game) {\r\n                console.error(\"No game reference found\");\r\n                return;\r\n            }\r\n            \r\n            // Try direct combat object on game first (preferred)\r\n            if (game.combat) {\r\n                game.combat.setFiring(true);\r\n                \r\n                // Play laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.playSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Legacy fallbacks\r\n            if (game.weaponSystem) {\r\n                if (typeof game.weaponSystem.setFiring === 'function') {\r\n                    game.weaponSystem.setFiring(true);\r\n                } else {\r\n                    game.weaponSystem.isWeaponActive = true;\r\n                }\r\n                \r\n                // Play laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.playSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Try through controls\r\n            if (game.controls && game.controls.weaponSystem) {\r\n                if (typeof game.controls.weaponSystem.setFiring === 'function') {\r\n                    game.controls.weaponSystem.setFiring(true);\r\n                } else {\r\n                    game.controls.weaponSystem.isWeaponActive = true;\r\n                }\r\n                \r\n                // Play laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.playSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            console.error(\"No weapon system or combat system found\");\r\n        } catch (e) {\r\n            console.error(\"Error in handleFiringStart:\", e);\r\n        }\r\n    }\r\n    \r\n    handleFiringEnd() {\r\n        try {\r\n            // First try local reference to weapon system (which is actually the Combat class)\r\n            if (this.weaponSystem) {\r\n                // Attempt to use the setFiring method from the Combat class\r\n                if (typeof this.weaponSystem.setFiring === 'function') {\r\n                    this.weaponSystem.setFiring(false);\r\n                } else {\r\n                    // Fallback to the older isWeaponActive property\r\n                    this.weaponSystem.isWeaponActive = false;\r\n                }\r\n                \r\n                // Try to stop sound if available\r\n                const game = window.gameInstance || window.game;\r\n                if (game && game.audio) {\r\n                    game.audio.stopSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Fallback to global game reference\r\n            const game = window.gameInstance || window.game;\r\n            if (!game) {\r\n                console.error(\"No game reference found\");\r\n                return;\r\n            }\r\n            \r\n            // Try direct combat object on game first (preferred)\r\n            if (game.combat) {\r\n                game.combat.setFiring(false);\r\n                \r\n                // Stop laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.stopSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Legacy fallbacks\r\n            if (game.weaponSystem) {\r\n                if (typeof game.weaponSystem.setFiring === 'function') {\r\n                    game.weaponSystem.setFiring(false);\r\n                } else {\r\n                    game.weaponSystem.isWeaponActive = false;\r\n                }\r\n                \r\n                // Stop laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.stopSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            // Try through controls\r\n            if (game.controls && game.controls.weaponSystem) {\r\n                if (typeof game.controls.weaponSystem.setFiring === 'function') {\r\n                    game.controls.weaponSystem.setFiring(false);\r\n                } else {\r\n                    game.controls.weaponSystem.isWeaponActive = false;\r\n                }\r\n                \r\n                // Stop laser sound if available\r\n                if (game.audio) {\r\n                    game.audio.stopSound('laser');\r\n                }\r\n                return;\r\n            }\r\n            \r\n            console.error(\"No weapon system or combat system found\");\r\n        } catch (e) {\r\n            console.error(\"Error in handleFiringEnd:\", e);\r\n        }\r\n    }\r\n    \r\n    handleDocking() {\r\n        if (!this.dockingSystem) {\r\n            console.error(\"Docking system not available\");\r\n            return;\r\n        }\r\n        \r\n        console.log(\"TouchControls: Dock button pressed, attempting to dock with stargate\");\r\n        \r\n        // Call docking method\r\n        this.dockingSystem.dockWithStargate();\r\n        \r\n        // Hide the dock button after pressing it\r\n        this.hideDockButton();\r\n    }\r\n    \r\n    handleTargeting() {\r\n        if (!this.targetingSystem) {\r\n            console.error(\"Targeting system not available\");\r\n            return;\r\n        }\r\n        \r\n        // Toggle targeting system\r\n        this.targetingSystem.toggleLockOn();\r\n    }\r\n    \r\n    showDockButton() {\r\n        if (this.dockButton) {\r\n            // FIX: Make sure display is set before other properties\r\n            this.dockButton.style.display = 'flex';\r\n            \r\n            // FIX: Ensure critical styles are explicitly set\r\n            this.dockButton.style.zIndex = '10000'; // Very high z-index\r\n            this.dockButton.style.position = 'absolute';\r\n            this.dockButton.style.top = '50%';\r\n            this.dockButton.style.left = '50%';\r\n            \r\n            console.log(\"Showing dock button - near stargate\");\r\n            \r\n            // Add pulsing animation to make it more noticeable\r\n            if (!this.dockButton.style.animation) {\r\n                this.dockButton.style.animation = 'pulse 1.5s infinite';\r\n                \r\n                // Add the pulse keyframes if they don't exist\r\n                if (!document.getElementById('mobile-pulse-animation')) {\r\n                    const style = document.createElement('style');\r\n                    style.id = 'mobile-pulse-animation';\r\n                    style.textContent = `\r\n                        @keyframes pulse {\r\n                            0% { transform: translate(-50%, -50%) scale(1); }\r\n                            50% { transform: translate(-50%, -50%) scale(1.1); }\r\n                            100% { transform: translate(-50%, -50%) scale(1); }\r\n                        }\r\n                    `;\r\n                    document.head.appendChild(style);\r\n                }\r\n            }\r\n            \r\n            // FIX: Log dock button visibility for debugging\r\n            console.log(\"Dock button shown with styles:\", {\r\n                display: this.dockButton.style.display,\r\n                zIndex: this.dockButton.style.zIndex,\r\n                position: this.dockButton.style.position,\r\n                width: this.dockButton.style.width,\r\n                height: this.dockButton.style.height\r\n            });\r\n        }\r\n    }\r\n    \r\n    hideDockButton() {\r\n        if (this.dockButton) {\r\n            this.dockButton.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        // Hide joystick zones\r\n        const leftZone = document.getElementById('leftJoystickZone');\r\n        const rightZone = document.getElementById('rightJoystickZone');\r\n        if (leftZone) leftZone.style.display = 'none';\r\n        if (rightZone) rightZone.style.display = 'none';\r\n        \r\n        // Hide action buttons\r\n        const leftActionButtons = document.getElementById('mobile-action-buttons-left');\r\n        const rightActionButtons = document.getElementById('mobile-action-buttons-right');\r\n        if (leftActionButtons) leftActionButtons.style.display = 'none';\r\n        if (rightActionButtons) rightActionButtons.style.display = 'none';\r\n        \r\n        // Hide dock button\r\n        this.hideDockButton();\r\n        \r\n        // Keep crosshair visible\r\n    }\r\n    \r\n    show() {\r\n        // Only show controls when not docked and not in intro sequence\r\n        if ((this.spaceship && this.spaceship.isDocked) || \r\n            (window.game && window.game.introSequenceActive)) {\r\n            console.log(\"TouchControls: Not showing controls during docked state or intro sequence\");\r\n            return;\r\n        }\r\n        \r\n        // Show joystick zones\r\n        const leftZone = document.getElementById('leftJoystickZone');\r\n        const rightZone = document.getElementById('rightJoystickZone');\r\n        if (leftZone) leftZone.style.display = 'block';\r\n        if (rightZone) rightZone.style.display = 'block';\r\n        \r\n        // Show action buttons\r\n        const leftActionButtons = document.getElementById('mobile-action-buttons-left');\r\n        const rightActionButtons = document.getElementById('mobile-action-buttons-right');\r\n        if (leftActionButtons) leftActionButtons.style.display = 'flex';\r\n        if (rightActionButtons) rightActionButtons.style.display = 'flex';\r\n    }\r\n    \r\n    update() {\r\n        // Update dock button visibility based on proximity to stargate\r\n        if (this.dockingSystem && this.spaceship) {\r\n            if (this.dockingSystem.nearStargate && !this.spaceship.isDocked) {\r\n                this.showDockButton();\r\n            } else {\r\n                this.hideDockButton();\r\n            }\r\n        } else {\r\n            // Fallback to window.game if the direct reference isn't set yet\r\n            const game = window.gameInstance || window.game;\r\n            if (game && game.controls && game.controls.dockingSystem) {\r\n                const dockingSystem = game.controls.dockingSystem;\r\n                \r\n                if (dockingSystem.nearStargate && !this.spaceship.isDocked) {\r\n                    this.showDockButton();\r\n                } else {\r\n                    this.hideDockButton();\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Helper method to add events to buttons\r\n    addButtonEvents(button, startHandler, endHandler = null) {\r\n        if (!button) {\r\n            console.error(\"TouchControls: Cannot add events to null button\");\r\n            return;\r\n        }\r\n        \r\n        // For continuous actions (like firing and mining)\r\n        if (endHandler) {\r\n            // Touch events with passive: false to allow preventDefault\r\n            button.addEventListener('touchstart', (e) => {\r\n                e.preventDefault();\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n                startHandler();\r\n            }, { passive: false });\r\n            \r\n            button.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                endHandler();\r\n            }, { passive: false });\r\n            \r\n            // Add pointer events\r\n            button.addEventListener('pointerdown', (e) => {\r\n                e.preventDefault();\r\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n                startHandler();\r\n            });\r\n            \r\n            button.addEventListener('pointerup', (e) => {\r\n                e.preventDefault();\r\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                endHandler();\r\n            });\r\n            \r\n            // Keep mouse events for backward compatibility\r\n            button.addEventListener('mousedown', (e) => {\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n                startHandler();\r\n            });\r\n            \r\n            button.addEventListener('mouseup', (e) => {\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                endHandler();\r\n            });\r\n        }\r\n        // For single actions (like targeting and docking)\r\n        else {\r\n            // Touch events\r\n            button.addEventListener('touchstart', (e) => {\r\n                e.preventDefault();\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n                \r\n                // For dock button specifically, add debug logging\r\n                if (button === this.dockButton) {\r\n                    console.log(\"Dock button touchstart event fired\");\r\n                }\r\n            }, { passive: false });\r\n            \r\n            button.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                \r\n                // For dock button specifically, add debug logging\r\n                if (button === this.dockButton) {\r\n                    console.log(\"Dock button touchend event fired, calling handler\");\r\n                }\r\n                \r\n                startHandler();\r\n            }, { passive: false });\r\n            \r\n            // Add pointer events\r\n            button.addEventListener('pointerdown', (e) => {\r\n                e.preventDefault();\r\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n                \r\n                // For dock button specifically, add debug logging\r\n                if (button === this.dockButton) {\r\n                    console.log(\"Dock button pointerdown event fired\");\r\n                }\r\n            });\r\n            \r\n            button.addEventListener('pointerup', (e) => {\r\n                e.preventDefault();\r\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                \r\n                // For dock button specifically, add debug logging\r\n                if (button === this.dockButton) {\r\n                    console.log(\"Dock button pointerup event fired, calling handler\");\r\n                }\r\n                \r\n                startHandler();\r\n            });\r\n            \r\n            // Keep mouse events for backward compatibility\r\n            button.addEventListener('mousedown', (e) => {\r\n                button.style.transform = 'scale(0.95) translateZ(0)';\r\n            });\r\n            \r\n            button.addEventListener('mouseup', (e) => {\r\n                button.style.transform = 'scale(1) translateZ(0)';\r\n                startHandler();\r\n            });\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle deploying a laser turret\r\n     */\r\n    handleDeployLaser() {\r\n        console.log(\"TouchControls: Deploying laser turret\");\r\n        \r\n        // Publish deploy laser event\r\n        if (window.mainMessageBus) {\r\n            window.mainMessageBus.publish('input.deployLaser', {});\r\n        }\r\n    }\r\n} ","/**\r\n * mobileDetector.js - Utility for detecting mobile devices and touch capabilities\r\n */\r\n\r\nexport class MobileDetector {\r\n    /**\r\n     * Check if the current device is a mobile device\r\n     * @returns {boolean} True if the device is mobile\r\n     */\r\n    static isMobile() {\r\n        // Store result in cache to avoid recalculation\r\n        if (this._isMobileCache !== undefined) {\r\n            return this._isMobileCache;\r\n        }\r\n        \r\n        // Check for mobile user agent\r\n        const userAgentCheck = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Android|iP(ad|hone|od)/i.test(navigator.userAgent);\r\n        \r\n        // Check for touch capabilities - more comprehensive check\r\n        const touchCheck = (\r\n            'ontouchstart' in window || \r\n            navigator.maxTouchPoints > 0 || \r\n            navigator.msMaxTouchPoints > 0 ||\r\n            (window.DocumentTouch && document instanceof DocumentTouch)\r\n        );\r\n        \r\n        // Check screen width and orientation\r\n        const screenCheck = window.innerWidth < 900; // More generous width threshold\r\n        \r\n        // Check if viewport meta tag has mobile-optimized settings\r\n        const viewportCheck = (() => {\r\n            const viewport = document.querySelector('meta[name=viewport]');\r\n            if (viewport) {\r\n                return viewport.content.includes('width=device-width');\r\n            }\r\n            return false;\r\n        })();\r\n        \r\n        // Check for specific mobile browser features\r\n        const mobileFeatureCheck = 'orientation' in window || 'onorientationchange' in window;\r\n        \r\n        // Check if device motion/orientation events are supported (typically mobile)\r\n        const motionCheck = 'DeviceMotionEvent' in window || 'DeviceOrientationEvent' in window;\r\n        \r\n        // Improve detection of tablets - they are also considered mobile for our purposes\r\n        const isTablet = (() => {\r\n            // iPads now report as desktop in newer iOS, so we need specific checks\r\n            const isIpad = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;\r\n            // Android tablets often have larger screens\r\n            const isAndroidTablet = /android/i.test(navigator.userAgent) && !/mobile/i.test(navigator.userAgent);\r\n            \r\n            return isIpad || isAndroidTablet;\r\n        })();\r\n        \r\n        // More comprehensive detection logic - a device is mobile if:\r\n        // 1. It matches mobile user agent patterns, OR\r\n        // 2. It has touch capabilities AND either:\r\n        //    a. Has a small-to-medium screen size, OR\r\n        //    b. Has mobile browser features, OR\r\n        //    c. Supports device motion/orientation, OR\r\n        //    d. Is detected as a tablet\r\n        this._isMobileCache = userAgentCheck || \r\n            (touchCheck && (screenCheck || mobileFeatureCheck || motionCheck || viewportCheck || isTablet));\r\n        \r\n        console.log(`MobileDetector: Device detected as ${this._isMobileCache ? 'mobile' : 'desktop'}`);\r\n        console.log(`- UA: ${userAgentCheck}, touch: ${touchCheck}, screen: ${screenCheck}`);\r\n        console.log(`- features: ${mobileFeatureCheck}, motion: ${motionCheck}, tablet: ${isTablet}`);\r\n        \r\n        return this._isMobileCache;\r\n    }\r\n    \r\n    /**\r\n     * Reset the mobile detection cache (useful after device orientation changes)\r\n     */\r\n    static resetCache() {\r\n        this._isMobileCache = undefined;\r\n    }\r\n    \r\n    /**\r\n     * Check if the device supports touch events\r\n     * @returns {boolean} True if touch is supported\r\n     */\r\n    static hasTouch() {\r\n        return ('ontouchstart' in window) || \r\n               (navigator.maxTouchPoints > 0) || \r\n               (navigator.msMaxTouchPoints > 0) ||\r\n               (window.DocumentTouch && document instanceof DocumentTouch);\r\n    }\r\n    \r\n    /**\r\n     * Get device orientation\r\n     * @returns {string} 'portrait' or 'landscape'\r\n     */\r\n    static getOrientation() {\r\n        return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';\r\n    }\r\n    \r\n    /**\r\n     * Add handler for orientation changes\r\n     * @param {Function} handler Function to call when orientation changes\r\n     */\r\n    static addOrientationChangeHandler(handler) {\r\n        // Track previous orientation\r\n        let prevOrientation = this.getOrientation();\r\n        \r\n        // Use both resize and orientationchange for better compatibility\r\n        const checkOrientation = () => {\r\n            const currentOrientation = this.getOrientation();\r\n            if (currentOrientation !== prevOrientation) {\r\n                prevOrientation = currentOrientation;\r\n                // Reset mobile detection cache\r\n                this.resetCache();\r\n                // Call handler with new orientation\r\n                handler(currentOrientation);\r\n            }\r\n        };\r\n        \r\n        window.addEventListener('resize', checkOrientation);\r\n        \r\n        // Add orientationchange listener if available\r\n        if ('onorientationchange' in window) {\r\n            window.addEventListener('orientationchange', checkOrientation);\r\n        }\r\n    }\r\n} ","// controls.js - Main controls module that integrates all control components\r\n\r\nimport { InputHandler } from './controls/inputHandler.js';\r\nimport { GamepadHandler } from './controls/gamepadHandler.js';\r\nimport { MiningSystem } from './controls/miningSystem.js';\r\nimport { TargetingSystem } from './controls/targetingSystem.js';\r\nimport { DockingSystem } from './controls/dockingSystem.js';\r\nimport { TouchControls } from './controls/touchControls.js';\r\nimport { MobileDetector } from '../utils/mobileDetector.js';\r\n\r\nexport class Controls {\r\n    constructor(spaceship, physics, environment, ui) {\r\n        console.log(\"Initializing controls systems...\");\r\n        \r\n        this.spaceship = spaceship;\r\n        this.physics = physics;\r\n        this.environment = environment;\r\n        this.ui = ui;\r\n        this.isMobile = MobileDetector.isMobile();\r\n        this._wasDocked = spaceship ? spaceship.isDocked : false;\r\n        this.weaponSystem = null; // Initialize weaponSystem reference\r\n        \r\n        // Set scene reference for components that need it\r\n        this.scene = physics.scene;\r\n        \r\n        // Initialize controls components\r\n        if (!this.isMobile) {\r\n            console.log(\"Initializing keyboard/mouse controls\");\r\n            this.inputHandler = new InputHandler(spaceship, physics);\r\n            \r\n            // Initialize gamepad support for desktop\r\n            console.log(\"Initializing gamepad support\");\r\n            this.gamepadHandler = new GamepadHandler(spaceship, physics, this);\r\n        } else {\r\n            console.log(\"Initializing touch controls for mobile\");\r\n            this.touchControls = new TouchControls(spaceship, physics);\r\n            // Create a placeholder input handler with minimal functionality\r\n            // This prevents errors where other systems expect inputHandler to exist\r\n            this.inputHandler = {\r\n                isLocked: () => false,\r\n                exitPointerLock: () => {}\r\n            };\r\n        }\r\n        \r\n        this.miningSystem = new MiningSystem(spaceship, this.scene);\r\n        this.targetingSystem = new TargetingSystem(spaceship, this.scene, environment);\r\n        \r\n        // Initialize docking system with all needed references\r\n        this.dockingSystem = new DockingSystem(spaceship, environment.stargate, ui);\r\n        \r\n        // Share the resources reference between components\r\n        this.resources = this.miningSystem.resources;\r\n        this.dockingSystem.setResources(this.resources);\r\n        \r\n        // Initialize orb inventory\r\n        if (!this.resources.orbs) {\r\n            this.resources.orbs = {\r\n                common: 0,\r\n                uncommon: 0,\r\n                rare: 0,\r\n                epic: 0,\r\n                legendary: 0\r\n            };\r\n        }\r\n        \r\n        // Pass control systems to touch controls if on mobile\r\n        if (this.isMobile && this.touchControls) {\r\n            this.touchControls.setControlSystems(this);\r\n        }\r\n        \r\n        // Connect upgrade systems - share references for easier updates\r\n        this.connectUpgradeEffects();\r\n        \r\n        // Set up event handlers - different for mobile vs desktop\r\n        this.setupEventHandlers();\r\n        \r\n        // Initialize anomaly orb collection state\r\n        this.lastAnomalyCheck = 0;\r\n        this.currentAnomaly = null;\r\n        this.showingAnomalyNotification = false;\r\n        \r\n        console.log(\"Control systems initialized\");\r\n    }\r\n    \r\n    // New method to connect upgrade effects between systems\r\n    connectUpgradeEffects() {\r\n        // Give the docking system a way to update the mining system\r\n        this.dockingSystem.updateMiningSystem = () => {\r\n            // Update mining speeds based on spaceship's mining efficiency\r\n            if (this.miningSystem && this.spaceship) {\r\n                const efficiency = this.spaceship.miningEfficiency;\r\n                \r\n                // Update base mining speeds for each resource type\r\n                Object.keys(this.miningSystem.miningSpeedByType).forEach(resourceType => {\r\n                    // Store original base speeds if not already stored\r\n                    if (!this.miningSystem._originalMiningSpeedByType) {\r\n                        this.miningSystem._originalMiningSpeedByType = { ...this.miningSystem.miningSpeedByType };\r\n                    }\r\n                    \r\n                    // Apply efficiency to the original base speed\r\n                    const originalSpeed = this.miningSystem._originalMiningSpeedByType[resourceType];\r\n                    this.miningSystem.miningSpeedByType[resourceType] = originalSpeed * efficiency;\r\n                });\r\n                \r\n                console.log(\"Mining speeds updated with efficiency:\", efficiency);\r\n                \r\n                // Update current mining speed if mining is in progress\r\n                if (this.miningSystem.targetAsteroid) {\r\n                    this.miningSystem.setTargetAsteroid(this.miningSystem.targetAsteroid);\r\n                }\r\n            }\r\n        };\r\n    }\r\n    \r\n    setupEventHandlers() {\r\n        // Skip adding keyboard controls if on mobile\r\n        if (this.isMobile) {\r\n            console.log(\"Mobile device detected, touch handlers are set in TouchControls class\");\r\n            return;\r\n        }\r\n        \r\n        // Add key event handlers for targeting and mining\r\n        document.addEventListener('keydown', e => {\r\n            switch (e.key.toLowerCase()) {\r\n                case 'e': \r\n                    // Toggle targeting system (changed from 't' to 'e')\r\n                    this.targetingSystem.toggleLockOn();\r\n                    break;\r\n                case 'f7':\r\n                    // Decrease gamepad sensitivity\r\n                    if (this.gamepadHandler) {\r\n                        this.gamepadHandler.lookSensitivity = Math.max(0.2, this.gamepadHandler.lookSensitivity - 0.2);\r\n                        console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`);\r\n                        this.showSensitivityNotification(this.gamepadHandler.lookSensitivity);\r\n                    }\r\n                    e.preventDefault();\r\n                    break;\r\n                case 'f8':\r\n                    // Increase gamepad sensitivity\r\n                    if (this.gamepadHandler) {\r\n                        this.gamepadHandler.lookSensitivity = Math.min(3.0, this.gamepadHandler.lookSensitivity + 0.2);\r\n                        console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`);\r\n                        this.showSensitivityNotification(this.gamepadHandler.lookSensitivity);\r\n                    }\r\n                    e.preventDefault();\r\n                    break;\r\n                case 'f9':\r\n                    // Toggle gamepad debug display\r\n                    if (this.gamepadHandler) {\r\n                        this.gamepadHandler.toggleDebug();\r\n                        console.log('Gamepad debug display toggled');\r\n                    }\r\n                    e.preventDefault();\r\n                    break;\r\n                case 'tab': \r\n                    // Cycle through targets if targeting is enabled\r\n                    if (this.targetingSystem.isLockOnEnabled()) {\r\n                        const target = this.targetingSystem.cycleLockOnTarget();\r\n                        if (target) {\r\n                            this.miningSystem.setTargetAsteroid(target);\r\n                        }\r\n                    }\r\n                    e.preventDefault(); // Prevent tab from changing focus\r\n                    break;\r\n                case 'r': // Changed from 'e' to 'r' (an unused key)\r\n                    // Toggle mining if targeting is enabled and we have a target\r\n                    if (this.targetingSystem.isLockOnEnabled()) {\r\n                        const target = this.targetingSystem.getCurrentTarget();\r\n                        if (target) {\r\n                            this.miningSystem.setTargetAsteroid(target);\r\n                            if (this.miningSystem.isMining) {\r\n                                this.miningSystem.stopMining();\r\n                            } else {\r\n                                this.miningSystem.startMining();\r\n                            }\r\n                        }\r\n                    }\r\n                    break;\r\n                case 't': \r\n                    // Deploy a laser turret\r\n                    console.log(\"Deploying laser turret\");\r\n                    if (window.mainMessageBus) {\r\n                        window.mainMessageBus.publish('input.deployLaser', {});\r\n                    }\r\n                    break;\r\n                case 'g': \r\n                    // Pick up an item\r\n                    console.log(\"Attempting to pick up an item\");\r\n                    if (window.mainMessageBus) {\r\n                        window.mainMessageBus.publish('input.pickupInteract', {});\r\n                    }\r\n                    break;\r\n            }\r\n        });\r\n        \r\n        // Add mouse click for mining\r\n        document.addEventListener('mousedown', e => {\r\n            if (e.button === 0 && this.inputHandler.isLocked()) { // Left mouse button\r\n                // Fire particle cannon\r\n                if (window.game && window.game.combat) {\r\n                    window.game.combat.setFiring(true);\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Add mouseup to stop mining when button is released\r\n        document.addEventListener('mouseup', e => {\r\n            if (e.button === 0) { // Left mouse button\r\n                // Stop firing\r\n                if (window.game && window.game.combat) {\r\n                    window.game.combat.setFiring(false);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    \r\n    setupStargateUIControls() {\r\n        if (this.dockingSystem) {\r\n            this.dockingSystem.setupStargateUIControls();\r\n        }\r\n    }\r\n    \r\n    // Method to dock with stargate (called from main.js on game start)\r\n    dockWithStargate() {\r\n        if (this.dockingSystem) {\r\n            this.dockingSystem.dockWithStargate();\r\n            \r\n            // Hide touch controls when docked\r\n            if (this.isMobile && this.touchControls) {\r\n                this.touchControls.hide();\r\n            }\r\n        } else {\r\n            console.error(\"Docking system not initialized\");\r\n        }\r\n    }\r\n    \r\n    // Collect energy orb from space anomaly\r\n    collectEnergyOrb() {\r\n        if (!this.environment || !this.spaceship) return;\r\n        \r\n        // Check if player is near an anomaly with an active orb\r\n        const anomaly = this.environment.checkAnomalyCollision(this.spaceship.mesh.position);\r\n        if (!anomaly) {\r\n            return; // No anomaly in range, silently return\r\n        }\r\n        \r\n        // Try to collect the orb\r\n        const orbData = this.environment.collectAnomalyOrb(anomaly);\r\n        if (!orbData) {\r\n            // Orb already collected, notification handled in checkForAnomalyOrbs\r\n            return;\r\n        }\r\n        \r\n        // Initialize orbs inventory if needed\r\n        if (!this.resources.orbs) {\r\n            this.resources.orbs = {\r\n                common: 0,\r\n                uncommon: 0,\r\n                rare: 0,\r\n                epic: 0,\r\n                legendary: 0\r\n            };\r\n        }\r\n        \r\n        // Add orb to inventory\r\n        this.resources.orbs[orbData.rarity]++;\r\n        \r\n        // Show notification with value and rarity\r\n        let rarityColor;\r\n        switch(orbData.rarity) {\r\n            case 'legendary':\r\n                rarityColor = \"#ff0000\"; // Red\r\n                break;\r\n            case 'epic':\r\n                rarityColor = \"#ff6600\"; // Orange\r\n                break;\r\n            case 'rare':\r\n                rarityColor = \"#9900ff\"; // Purple\r\n                break;\r\n            case 'uncommon':\r\n                rarityColor = \"#0066ff\"; // Blue\r\n                break;\r\n            default: // common\r\n                rarityColor = \"#00ff66\"; // Green\r\n                break;\r\n        }\r\n        \r\n        const capitalizedRarity = orbData.rarity.charAt(0).toUpperCase() + orbData.rarity.slice(1);\r\n        \r\n        // Show message with appropriate styling\r\n        this.showAnomalyMessage(\r\n            `Collected ${capitalizedRarity} Energy Orb (${orbData.value} CR)`,\r\n            rarityColor\r\n        );\r\n        \r\n        // Trigger collection effect\r\n        this.triggerOrbCollectionEffect(anomaly);\r\n        \r\n        // Play sound if audio manager is available\r\n        if (window.game && window.game.audio) {\r\n            // Play different sounds based on rarity\r\n            switch(orbData.rarity) {\r\n                case 'legendary':\r\n                    window.game.audio.playSoundEffect('powerup_legendary', 0.8);\r\n                    break;\r\n                case 'epic':\r\n                    window.game.audio.playSoundEffect('powerup_epic', 0.7);\r\n                    break;\r\n                case 'rare':\r\n                    window.game.audio.playSoundEffect('powerup_rare', 0.6);\r\n                    break;\r\n                case 'uncommon':\r\n                    window.game.audio.playSoundEffect('powerup_uncommon', 0.5);\r\n                    break;\r\n                default: // common\r\n                    window.game.audio.playSoundEffect('powerup_common', 0.4);\r\n                    break;\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Create a visual effect when collecting an orb\r\n    triggerOrbCollectionEffect(anomaly) {\r\n        // Check if we have access to the scene and visual effects\r\n        if (!this.scene || !anomaly) return;\r\n        \r\n        // Create an explosion effect at the anomaly orb position\r\n        if (window.game && window.game.combat) {\r\n            const position = anomaly.position.clone();\r\n            \r\n            // Use explosion effect from combat system\r\n            window.game.combat.createExplosionEffect(position, 2000, true);\r\n            \r\n            // Also publish an event for additional effects\r\n            if (window.mainMessageBus) {\r\n                window.mainMessageBus.publish('vfx.explosion', {\r\n                    position: position,\r\n                    color: anomaly.orb.color,\r\n                    size: anomaly.orb.size * 2,\r\n                    duration: 2000\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Show a notification when anomaly is found or orb is collected\r\n    showAnomalyMessage(message, color) {\r\n        if (this.showingAnomalyNotification) return; // Don't stack notifications\r\n        \r\n        this.showingAnomalyNotification = true;\r\n        \r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = '30%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = color || '#ffffff';\r\n        notification.style.padding = '15px 30px';\r\n        notification.style.borderRadius = '10px';\r\n        notification.style.border = `2px solid ${color || '#ffffff'}`;\r\n        notification.style.boxShadow = `0 0 15px ${color || '#ffffff'}`;\r\n        notification.style.fontFamily = 'Courier New, monospace';\r\n        notification.style.fontSize = '18px';\r\n        notification.style.zIndex = '1000';\r\n        notification.style.textAlign = 'center';\r\n        notification.style.pointerEvents = 'none'; // Don't block mouse events\r\n        \r\n        // Set notification text\r\n        notification.textContent = message;\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(notification);\r\n        \r\n        // Remove after a few seconds\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 0.8s';\r\n            \r\n            setTimeout(() => {\r\n                notification.remove();\r\n                this.showingAnomalyNotification = false;\r\n            }, 800);\r\n        }, 3000);\r\n    }\r\n    \r\n    showSensitivityNotification(sensitivity) {\r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.textContent = `Gamepad Sensitivity: ${sensitivity.toFixed(1)}`;\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = '100px';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translateX(-50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#30cfd0';\r\n        notification.style.padding = '10px 20px';\r\n        notification.style.borderRadius = '5px';\r\n        notification.style.border = '1px solid #30cfd0';\r\n        notification.style.fontFamily = 'monospace';\r\n        notification.style.fontSize = '16px';\r\n        notification.style.zIndex = '10000';\r\n        notification.style.pointerEvents = 'none';\r\n        \r\n        document.body.appendChild(notification);\r\n        \r\n        // Fade out and remove after 2 seconds\r\n        setTimeout(() => {\r\n            notification.style.transition = 'opacity 0.5s';\r\n            notification.style.opacity = '0';\r\n            setTimeout(() => notification.remove(), 500);\r\n        }, 2000);\r\n    }\r\n    \r\n    /**\r\n     * Update control systems\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime = 1/60) {\r\n        // Skip ALL updates if intro sequence is active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            return;\r\n        }\r\n        \r\n        // Check if docking status changed\r\n        if (this.spaceship) {\r\n            const wasDocked = this._wasDocked;\r\n            const isDocked = this.spaceship.isDocked;\r\n            \r\n            // If docking status changed, update touch controls visibility\r\n            if (this.isMobile && this.touchControls && wasDocked !== isDocked) {\r\n                if (isDocked) {\r\n                    this.touchControls.hide();\r\n                } else {\r\n                    this.touchControls.show();\r\n                }\r\n                this._wasDocked = isDocked;\r\n            }\r\n        }\r\n        \r\n        // Skip updates if docked\r\n        if (this.spaceship && this.spaceship.isDocked) {\r\n            // Only update the docking system when docked\r\n            if (this.dockingSystem) {\r\n                this.dockingSystem.update();\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Update gamepad input if available\r\n        if (this.gamepadHandler) {\r\n            this.gamepadHandler.update(deltaTime);\r\n        }\r\n        \r\n        // Update all control systems\r\n        if (this.targetingSystem) {\r\n            this.targetingSystem.update();\r\n        }\r\n        \r\n        if (this.miningSystem) {\r\n            // Pass deltaTime to ensure frame-rate independent mining\r\n            this.miningSystem.update(deltaTime);\r\n            \r\n            // Check if mining has destroyed an asteroid\r\n            const destroyedAsteroid = this.miningSystem.getLastDestroyedAsteroid();\r\n            if (destroyedAsteroid && this.environment && this.environment.asteroidBelt) {\r\n                // Remove the asteroid from the environment\r\n                this.environment.asteroidBelt.removeAsteroid(destroyedAsteroid);\r\n            }\r\n        }\r\n        \r\n        if (this.dockingSystem) {\r\n            this.dockingSystem.update();\r\n        }\r\n        \r\n        // Update touch controls if on mobile\r\n        if (this.isMobile && this.touchControls) {\r\n            this.touchControls.update();\r\n        }\r\n        \r\n        if (this.deploymentSystem) {\r\n            this.deploymentSystem.update();\r\n        }\r\n        \r\n        // Check for and automatically collect anomaly orbs\r\n        this.checkForAnomalyOrbs();\r\n    }\r\n    \r\n    // Check if the player is near an anomaly orb and collect it if close enough\r\n    checkForAnomalyOrbs() {\r\n        if (!this.environment || !this.spaceship) return;\r\n        \r\n        // Limit check frequency to avoid performance impact\r\n        const now = performance.now();\r\n        if (now - this.lastAnomalyCheck < 500) return; // Check every 500ms\r\n        this.lastAnomalyCheck = now;\r\n        \r\n        // Check if player is within an anomaly's orb collection radius\r\n        const anomaly = this.environment.checkAnomalyCollision(this.spaceship.mesh.position);\r\n        \r\n        // If player is within collection radius of an anomaly with an uncollected orb\r\n        if (anomaly && !anomaly.orbCollected) {\r\n            // Automatically collect the orb\r\n            this.collectEnergyOrb();\r\n            \r\n            // Reset current anomaly when orb is collected\r\n            this.currentAnomaly = null;\r\n        } else if (anomaly && anomaly !== this.currentAnomaly && anomaly.orbCollected) {\r\n            // If player enters a depleted anomaly, show notification\r\n            this.currentAnomaly = anomaly;\r\n            this.showAnomalyMessage(\"Energy orb already collected\", \"#ff3333\");\r\n        } else if (!anomaly) {\r\n            // Reset current anomaly when player leaves the collection radius\r\n            this.currentAnomaly = null;\r\n        }\r\n    }\r\n    \r\n    // Getter for isMining status (used by UI)\r\n    get isMining() {\r\n        return this.miningSystem ? this.miningSystem.isMining : false;\r\n    }\r\n    \r\n    // Getter for mining progress (used by UI)\r\n    get miningProgress() {\r\n        return this.miningSystem ? this.miningSystem.miningProgress : 0;\r\n    }\r\n} ","// hud.js - Handles the game's advanced holographic heads-up display\r\n\r\nexport class HUD {\r\n    constructor(spaceship) {\r\n        this.spaceship = spaceship;\r\n        this.setupHUD();\r\n        this.animationFrames = [];\r\n        this.glitchInterval = null;\r\n        this.scanline = null;\r\n        this.hudOpacity = 0;\r\n        this.animateHudIn();\r\n    }\r\n    \r\n    setupHUD() {\r\n        // Create main HUD container with holographic glass effect\r\n        const hudContainer = document.createElement('div');\r\n        hudContainer.id = 'hud-container';\r\n        hudContainer.style.position = 'absolute';\r\n        hudContainer.style.top = '0';\r\n        hudContainer.style.left = '0';\r\n        hudContainer.style.width = '100%';\r\n        hudContainer.style.height = '100%';\r\n        hudContainer.style.pointerEvents = 'none';\r\n        hudContainer.style.fontFamily = '\"Rajdhani\", \"Electrolize\", sans-serif';\r\n        hudContainer.style.fontWeight = '400';\r\n        hudContainer.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        hudContainer.style.textShadow = '0 0 10px rgba(120, 220, 232, 0.5)';\r\n        hudContainer.style.opacity = '0';\r\n        hudContainer.style.transition = 'opacity 0.5s ease';\r\n        document.body.appendChild(hudContainer);\r\n        \r\n        // Add Google Font for futuristic UI\r\n        const fontLink = document.createElement('link');\r\n        fontLink.href = 'https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600&family=Electrolize&display=swap';\r\n        fontLink.rel = 'stylesheet';\r\n        document.head.appendChild(fontLink);\r\n        \r\n        // Add holographic scanline effect\r\n        this.createScanlineEffect(hudContainer);\r\n        \r\n        // Create flight data panel - bottom left\r\n        this.createFlightPanel(hudContainer);\r\n        \r\n        // Create ship status panel - bottom right \r\n        this.createStatusPanel(hudContainer);\r\n        \r\n        // Create crosshair with targeting system\r\n        this.createTargetingSystem(hudContainer);\r\n        \r\n        // Create location info - top left\r\n        this.createLocationPanel(hudContainer);\r\n        \r\n        // Create resource panel - top right\r\n        this.createResourcePanel(hudContainer);\r\n        \r\n        // Radar removed as per user request\r\n        \r\n        // Add notifications area - top center\r\n        this.createNotificationsArea(hudContainer);\r\n    }\r\n    \r\n    createScanlineEffect(parent) {\r\n        // Scanline effect overlay\r\n        const scanlineEffect = document.createElement('div');\r\n        scanlineEffect.id = 'scanline-effect';\r\n        scanlineEffect.style.position = 'absolute';\r\n        scanlineEffect.style.top = '0';\r\n        scanlineEffect.style.left = '0';\r\n        scanlineEffect.style.width = '100%';\r\n        scanlineEffect.style.height = '100%';\r\n        scanlineEffect.style.background = 'linear-gradient(transparent 50%, rgba(120, 220, 232, 0.03) 50%)';\r\n        scanlineEffect.style.backgroundSize = '100% 4px';\r\n        scanlineEffect.style.zIndex = '1000';\r\n        scanlineEffect.style.pointerEvents = 'none';\r\n        scanlineEffect.style.opacity = '0.5';\r\n        parent.appendChild(scanlineEffect);\r\n        \r\n        // Add subtle scan line that moves\r\n        const activeScanline = document.createElement('div');\r\n        activeScanline.id = 'active-scanline';\r\n        activeScanline.style.position = 'absolute';\r\n        activeScanline.style.left = '0';\r\n        activeScanline.style.width = '100%';\r\n        activeScanline.style.height = '3px';\r\n        activeScanline.style.background = 'linear-gradient(90deg, transparent 0%, rgba(120, 220, 232, 0.1) 50%, transparent 100%)';\r\n        activeScanline.style.boxShadow = '0 0 10px rgba(120, 220, 232, 0.3)';\r\n        activeScanline.style.zIndex = '1001';\r\n        activeScanline.style.top = '0';\r\n        activeScanline.style.opacity = '0.7';\r\n        activeScanline.style.pointerEvents = 'none';\r\n        parent.appendChild(activeScanline);\r\n        \r\n        this.scanline = activeScanline;\r\n    }\r\n    \r\n    createFlightPanel(parent) {\r\n        const flightPanel = document.createElement('div');\r\n        flightPanel.id = 'flight-panel';\r\n        flightPanel.className = 'hud-panel';\r\n        flightPanel.style.position = 'absolute';\r\n        flightPanel.style.bottom = '20px';\r\n        flightPanel.style.left = '20px';\r\n        flightPanel.style.width = '260px';\r\n        flightPanel.style.padding = '15px';\r\n        flightPanel.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';\r\n        flightPanel.style.backdropFilter = 'blur(5px)';\r\n        flightPanel.style.borderRadius = '10px';\r\n        flightPanel.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        flightPanel.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.2), inset 0 0 10px rgba(120, 220, 232, 0.1)';\r\n        flightPanel.style.overflow = 'hidden';\r\n        parent.appendChild(flightPanel);\r\n        \r\n        // Panel header\r\n        const panelHeader = document.createElement('div');\r\n        panelHeader.className = 'panel-header';\r\n        panelHeader.innerHTML = '<span>FLIGHT SYSTEMS</span>';\r\n        panelHeader.style.fontWeight = '600';\r\n        panelHeader.style.fontSize = '14px';\r\n        panelHeader.style.textTransform = 'uppercase';\r\n        panelHeader.style.letterSpacing = '2px';\r\n        panelHeader.style.marginBottom = '15px';\r\n        panelHeader.style.paddingBottom = '8px';\r\n        panelHeader.style.borderBottom = '1px solid rgba(120, 220, 232, 0.3)';\r\n        panelHeader.style.display = 'flex';\r\n        panelHeader.style.justifyContent = 'space-between';\r\n        panelHeader.style.alignItems = 'center';\r\n        flightPanel.appendChild(panelHeader);\r\n        \r\n        // Add a small blinking indicator\r\n        const statusIndicator = document.createElement('div');\r\n        statusIndicator.className = 'status-indicator';\r\n        statusIndicator.style.width = '8px';\r\n        statusIndicator.style.height = '8px';\r\n        statusIndicator.style.borderRadius = '50%';\r\n        statusIndicator.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        statusIndicator.style.boxShadow = '0 0 5px rgba(120, 220, 232, 0.8)';\r\n        statusIndicator.style.animation = 'pulse 2s infinite';\r\n        panelHeader.appendChild(statusIndicator);\r\n        \r\n        // Create flight data items\r\n        \r\n        // Add fuel gauge with visual indicator\r\n        const fuelRow = document.createElement('div');\r\n        fuelRow.className = 'panel-row';\r\n        fuelRow.style.display = 'flex';\r\n        fuelRow.style.justifyContent = 'space-between';\r\n        fuelRow.style.alignItems = 'center';\r\n        fuelRow.style.margin = '10px 0';\r\n        flightPanel.appendChild(fuelRow);\r\n        \r\n        const fuelLabel = document.createElement('span');\r\n        fuelLabel.className = 'row-label';\r\n        fuelLabel.textContent = 'FUEL';\r\n        fuelLabel.style.width = '40%';\r\n        fuelRow.appendChild(fuelLabel);\r\n        \r\n        // Add fuel value display\r\n        const fuelValue = document.createElement('span');\r\n        fuelValue.id = 'fuel-value';\r\n        fuelValue.className = 'row-value';\r\n        fuelValue.textContent = '100 / 100';\r\n        fuelValue.style.position = 'absolute';\r\n        fuelValue.style.right = '15px';\r\n        fuelValue.style.top = '-18px';\r\n        fuelValue.style.fontSize = '12px';\r\n        fuelValue.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        \r\n        const fuelBarContainer = document.createElement('div');\r\n        fuelBarContainer.style.width = '60%';\r\n        fuelBarContainer.style.height = '10px';\r\n        fuelBarContainer.style.backgroundColor = 'rgba(10, 30, 40, 0.5)';\r\n        fuelBarContainer.style.borderRadius = '5px';\r\n        fuelBarContainer.style.overflow = 'hidden';\r\n        fuelBarContainer.style.position = 'relative';\r\n        fuelBarContainer.appendChild(fuelValue);\r\n        fuelRow.appendChild(fuelBarContainer);\r\n        \r\n        const fuelBar = document.createElement('div');\r\n        fuelBar.id = 'fuel-bar';\r\n        fuelBar.style.width = '100%';\r\n        fuelBar.style.height = '100%';\r\n        fuelBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        fuelBar.style.boxShadow = 'inset 0 0 5px rgba(255, 255, 255, 0.5)';\r\n        fuelBar.style.transition = 'width 0.3s ease';\r\n        fuelBarContainer.appendChild(fuelBar);\r\n        \r\n        // Credits display\r\n        this.createPanelRow(flightPanel, 'CREDITS', 'credits', '1000 CR');\r\n        \r\n        // Controls button\r\n        const controlsButton = document.createElement('button');\r\n        controlsButton.id = 'show-controls';\r\n        controlsButton.textContent = 'SYSTEM CONTROLS';\r\n        controlsButton.style.width = '100%';\r\n        controlsButton.style.marginTop = '15px';\r\n        controlsButton.style.padding = '8px';\r\n        controlsButton.style.backgroundColor = 'rgba(120, 220, 232, 0.15)';\r\n        controlsButton.style.border = '1px solid rgba(120, 220, 232, 0.5)';\r\n        controlsButton.style.borderRadius = '5px';\r\n        controlsButton.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        controlsButton.style.fontSize = '12px';\r\n        controlsButton.style.fontFamily = '\"Rajdhani\", sans-serif';\r\n        controlsButton.style.cursor = 'pointer';\r\n        controlsButton.style.transition = 'all 0.2s ease';\r\n        controlsButton.style.textTransform = 'uppercase';\r\n        controlsButton.style.letterSpacing = '1px';\r\n        controlsButton.style.fontWeight = '600';\r\n        controlsButton.style.outline = 'none';\r\n        controlsButton.style.pointerEvents = 'auto';\r\n        \r\n        controlsButton.addEventListener('mouseover', () => {\r\n            controlsButton.style.backgroundColor = 'rgba(120, 220, 232, 0.3)';\r\n            controlsButton.style.boxShadow = '0 0 10px rgba(120, 220, 232, 0.5)';\r\n        });\r\n        \r\n        controlsButton.addEventListener('mouseout', () => {\r\n            controlsButton.style.backgroundColor = 'rgba(120, 220, 232, 0.15)';\r\n            controlsButton.style.boxShadow = 'none';\r\n        });\r\n        \r\n        flightPanel.appendChild(controlsButton);\r\n        \r\n        // Add holographic decorative elements\r\n        this.addHolographicElements(flightPanel);\r\n    }\r\n    \r\n    createStatusPanel(parent) {\r\n        const statusPanel = document.createElement('div');\r\n        statusPanel.id = 'status-panel';\r\n        statusPanel.className = 'hud-panel';\r\n        statusPanel.style.position = 'absolute';\r\n        statusPanel.style.bottom = '20px';\r\n        statusPanel.style.right = '20px';\r\n        statusPanel.style.width = '260px';\r\n        statusPanel.style.padding = '15px';\r\n        statusPanel.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';\r\n        statusPanel.style.backdropFilter = 'blur(5px)';\r\n        statusPanel.style.borderRadius = '10px';\r\n        statusPanel.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        statusPanel.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.2), inset 0 0 10px rgba(120, 220, 232, 0.1)';\r\n        parent.appendChild(statusPanel);\r\n        \r\n        // Panel header\r\n        const panelHeader = document.createElement('div');\r\n        panelHeader.className = 'panel-header';\r\n        panelHeader.innerHTML = '<span>SHIP STATUS</span>';\r\n        panelHeader.style.fontWeight = '600';\r\n        panelHeader.style.fontSize = '14px';\r\n        panelHeader.style.textTransform = 'uppercase';\r\n        panelHeader.style.letterSpacing = '2px';\r\n        panelHeader.style.marginBottom = '15px';\r\n        panelHeader.style.paddingBottom = '8px';\r\n        panelHeader.style.borderBottom = '1px solid rgba(120, 220, 232, 0.3)';\r\n        panelHeader.style.display = 'flex';\r\n        panelHeader.style.justifyContent = 'space-between';\r\n        panelHeader.style.alignItems = 'center';\r\n        statusPanel.appendChild(panelHeader);\r\n        \r\n        // Add a small blinking indicator\r\n        const statusIndicator = document.createElement('div');\r\n        statusIndicator.className = 'status-indicator';\r\n        statusIndicator.style.width = '8px';\r\n        statusIndicator.style.height = '8px';\r\n        statusIndicator.style.borderRadius = '50%';\r\n        statusIndicator.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        statusIndicator.style.boxShadow = '0 0 5px rgba(120, 220, 232, 0.8)';\r\n        statusIndicator.style.animation = 'pulse 2s infinite';\r\n        panelHeader.appendChild(statusIndicator);\r\n        \r\n        // Ship shield bar\r\n        const shieldRow = document.createElement('div');\r\n        shieldRow.className = 'panel-row';\r\n        shieldRow.style.display = 'flex';\r\n        shieldRow.style.justifyContent = 'space-between';\r\n        shieldRow.style.alignItems = 'center';\r\n        shieldRow.style.margin = '10px 0';\r\n        statusPanel.appendChild(shieldRow);\r\n        \r\n        const shieldLabel = document.createElement('span');\r\n        shieldLabel.className = 'row-label';\r\n        shieldLabel.textContent = 'SHIELD';\r\n        shieldLabel.style.width = '50%';\r\n        shieldRow.appendChild(shieldLabel);\r\n        \r\n        const shieldBarContainer = document.createElement('div');\r\n        shieldBarContainer.style.width = '50%';\r\n        shieldBarContainer.style.height = '10px';\r\n        shieldBarContainer.style.backgroundColor = 'rgba(10, 30, 40, 0.5)';\r\n        shieldBarContainer.style.borderRadius = '5px';\r\n        shieldBarContainer.style.overflow = 'hidden';\r\n        shieldRow.appendChild(shieldBarContainer);\r\n        \r\n        const shieldBar = document.createElement('div');\r\n        shieldBar.id = 'shield-bar';\r\n        shieldBar.style.width = '100%';\r\n        shieldBar.style.height = '100%';\r\n        shieldBar.style.backgroundColor = 'rgba(51, 153, 255, 0.8)'; // Blue color for shield\r\n        shieldBar.style.boxShadow = 'inset 0 0 5px rgba(255, 255, 255, 0.5)';\r\n        shieldBar.style.transition = 'width 0.3s ease';\r\n        shieldBarContainer.appendChild(shieldBar);\r\n        \r\n        // Ship hull integrity bar\r\n        const hullRow = document.createElement('div');\r\n        hullRow.className = 'panel-row';\r\n        hullRow.style.display = 'flex';\r\n        hullRow.style.justifyContent = 'space-between';\r\n        hullRow.style.alignItems = 'center';\r\n        hullRow.style.margin = '10px 0';\r\n        statusPanel.appendChild(hullRow);\r\n        \r\n        const hullLabel = document.createElement('span');\r\n        hullLabel.className = 'row-label';\r\n        hullLabel.textContent = 'HULL INTEGRITY';\r\n        hullLabel.style.width = '50%';\r\n        hullRow.appendChild(hullLabel);\r\n        \r\n        const hullBarContainer = document.createElement('div');\r\n        hullBarContainer.style.width = '50%';\r\n        hullBarContainer.style.height = '10px';\r\n        hullBarContainer.style.backgroundColor = 'rgba(10, 30, 40, 0.5)';\r\n        hullBarContainer.style.borderRadius = '5px';\r\n        hullBarContainer.style.overflow = 'hidden';\r\n        hullRow.appendChild(hullBarContainer);\r\n        \r\n        const hullBar = document.createElement('div');\r\n        hullBar.id = 'hull-bar';\r\n        hullBar.style.width = '100%';\r\n        hullBar.style.height = '100%';\r\n        hullBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        hullBar.style.boxShadow = 'inset 0 0 5px rgba(255, 255, 255, 0.5)';\r\n        hullBar.style.transition = 'width 0.3s ease';\r\n        hullBarContainer.appendChild(hullBar);\r\n        \r\n        // Add holographic decorative elements\r\n        this.addHolographicElements(statusPanel);\r\n        \r\n        // Add sound control button\r\n        const soundToggleBtn = document.createElement('button');\r\n        soundToggleBtn.id = 'sound-toggle';\r\n        soundToggleBtn.textContent = 'SOUND: ON';\r\n        soundToggleBtn.style.background = 'none';\r\n        soundToggleBtn.style.border = '1px solid rgba(120, 220, 232, 0.5)';\r\n        soundToggleBtn.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        soundToggleBtn.style.padding = '5px 10px';\r\n        soundToggleBtn.style.borderRadius = '5px';\r\n        soundToggleBtn.style.cursor = 'pointer';\r\n        soundToggleBtn.style.fontFamily = '\"Rajdhani\", sans-serif';\r\n        soundToggleBtn.style.fontSize = '12px';\r\n        soundToggleBtn.style.marginLeft = '10px';\r\n        soundToggleBtn.style.marginTop = '10px';\r\n        soundToggleBtn.style.outline = 'none';\r\n        soundToggleBtn.style.pointerEvents = 'auto';\r\n        \r\n        // Add click handler for sound toggle\r\n        soundToggleBtn.addEventListener('click', () => {\r\n            if (window.game && window.game.audio) {\r\n                const isMuted = window.game.audio.toggleMute();\r\n                soundToggleBtn.textContent = isMuted ? 'SOUND: OFF' : 'SOUND: ON';\r\n            }\r\n        });\r\n        \r\n        statusPanel.appendChild(soundToggleBtn);\r\n    }\r\n    \r\n    createTargetingSystem(parent) {\r\n        // Main crosshair container\r\n        const targetingSystem = document.createElement('div');\r\n        targetingSystem.id = 'targeting-system';\r\n        targetingSystem.style.position = 'absolute';\r\n        targetingSystem.style.top = '50%';\r\n        targetingSystem.style.left = '50%';\r\n        targetingSystem.style.transform = 'translate(-50%, -50%)';\r\n        targetingSystem.style.width = '100px';\r\n        targetingSystem.style.height = '100px';\r\n        targetingSystem.style.zIndex = '100';\r\n        parent.appendChild(targetingSystem);\r\n        \r\n        // Crosshair - create using SVG for more precise styling\r\n        const crosshair = document.createElement('div');\r\n        crosshair.id = 'crosshair';\r\n        crosshair.style.position = 'absolute';\r\n        crosshair.style.top = '50%';\r\n        crosshair.style.left = '50%';\r\n        crosshair.style.transform = 'translate(-50%, -50%)';\r\n        crosshair.style.width = '50px';\r\n        crosshair.style.height = '50px';\r\n        \r\n        // SVG crosshair\r\n        crosshair.innerHTML = `\r\n            <svg width=\"50\" height=\"50\" viewBox=\"0 0 50 50\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <circle cx=\"25\" cy=\"25\" r=\"20\" stroke=\"rgba(120, 220, 232, 0.5)\" stroke-width=\"1\" stroke-dasharray=\"8 4\"/>\r\n                <circle cx=\"25\" cy=\"25\" r=\"3\" stroke=\"rgba(120, 220, 232, 0.8)\" stroke-width=\"1\"/>\r\n                <circle cx=\"25\" cy=\"25\" r=\"1\" fill=\"rgba(120, 220, 232, 0.8)\"/>\r\n                <line x1=\"25\" y1=\"10\" x2=\"25\" y2=\"18\" stroke=\"rgba(120, 220, 232, 0.8)\" stroke-width=\"1\"/>\r\n                <line x1=\"25\" y1=\"32\" x2=\"25\" y2=\"40\" stroke=\"rgba(120, 220, 232, 0.8)\" stroke-width=\"1\"/>\r\n                <line x1=\"10\" y1=\"25\" x2=\"18\" y2=\"25\" stroke=\"rgba(120, 220, 232, 0.8)\" stroke-width=\"1\"/>\r\n                <line x1=\"32\" y1=\"25\" x2=\"40\" y2=\"25\" stroke=\"rgba(120, 220, 232, 0.8)\" stroke-width=\"1\"/>\r\n                <!-- Add a pulsing animation to the outer circle -->\r\n                <circle cx=\"25\" cy=\"25\" r=\"24\" stroke=\"rgba(120, 220, 232, 0.3)\" stroke-width=\"1\">\r\n                    <animate attributeName=\"r\" values=\"24;28;24\" dur=\"3s\" repeatCount=\"indefinite\"/>\r\n                    <animate attributeName=\"opacity\" values=\"0.3;0.1;0.3\" dur=\"3s\" repeatCount=\"indefinite\"/>\r\n                </circle>\r\n            </svg>\r\n        `;\r\n        \r\n        targetingSystem.appendChild(crosshair);\r\n        \r\n        // Target info display that appears when targeting something\r\n        const targetInfo = document.createElement('div');\r\n        targetInfo.id = 'target-info';\r\n        targetInfo.className = 'hud-panel';  // Use consistent HUD panel class\r\n        targetInfo.style.position = 'fixed';\r\n        \r\n        // Detect mobile device and position accordingly\r\n        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||\r\n                          (navigator.maxTouchPoints && navigator.maxTouchPoints > 2) ||\r\n                          window.innerWidth <= 768;\r\n        \r\n        if (isMobile) {\r\n            // Position at bottom on mobile\r\n            targetInfo.style.bottom = '15px';\r\n            targetInfo.style.top = 'auto';\r\n        } else {\r\n            // Position at top on desktop\r\n            targetInfo.style.top = '15px';\r\n            targetInfo.style.bottom = 'auto';\r\n        }\r\n        \r\n        targetInfo.style.left = '50%';\r\n        targetInfo.style.transform = 'translateX(-50%)';\r\n        targetInfo.style.width = '280px';  // Slightly wider to match other panels\r\n        targetInfo.style.padding = '10px 15px';  // Match other panel padding\r\n        targetInfo.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';  // Match other panels\r\n        targetInfo.style.backdropFilter = 'blur(5px)';  // Match other panels\r\n        targetInfo.style.borderRadius = '8px';  // Match other panel border radius\r\n        targetInfo.style.fontSize = '14px';  // Match other panel font size\r\n        targetInfo.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        targetInfo.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        targetInfo.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.2)';  // Match other panels\r\n        targetInfo.style.textAlign = 'center';\r\n        targetInfo.style.display = 'none';\r\n        targetInfo.style.zIndex = '999';  // Below notifications but above other HUD elements\r\n        targetInfo.style.fontFamily = '\"Rajdhani\", \"Electrolize\", sans-serif';  // Match HUD font\r\n        parent.appendChild(targetInfo);  // Append to main HUD parent, not targetingSystem\r\n        \r\n        // Add decorative corner elements to match other HUD panels\r\n        this.addCornerElements(targetInfo);\r\n        \r\n        // Target info content - simplified for less clutter\r\n        targetInfo.innerHTML = `\r\n            <div id=\"target-name\" style=\"font-weight:600; margin-bottom:5px;\">NO TARGET</div>\r\n            <div id=\"target-distance\" style=\"margin-bottom:0;\">DISTANCE: ---</div>\r\n        `;\r\n        \r\n        // Laser beam\r\n        const laserBeam = document.createElement('div');\r\n        laserBeam.id = 'laser-beam';\r\n        laserBeam.style.position = 'absolute';\r\n        laserBeam.style.top = '50%';\r\n        laserBeam.style.left = '50%';\r\n        laserBeam.style.width = '0px';\r\n        laserBeam.style.height = '2px';\r\n        laserBeam.style.backgroundColor = 'rgba(255, 50, 50, 0.8)';\r\n        laserBeam.style.boxShadow = '0 0 10px rgba(255, 50, 50, 0.8)';\r\n        laserBeam.style.transformOrigin = 'left';\r\n        laserBeam.style.transform = 'rotate(var(--angle, 0deg))';\r\n        laserBeam.style.zIndex = '90';\r\n        laserBeam.style.display = 'none';\r\n        parent.appendChild(laserBeam);\r\n    }\r\n    \r\n    createLocationPanel(parent) {\r\n        // Location info panel - top left\r\n        const locationPanel = document.createElement('div');\r\n        locationPanel.id = 'location-panel';\r\n        locationPanel.className = 'hud-panel';\r\n        locationPanel.style.position = 'absolute';\r\n        locationPanel.style.top = '20px';\r\n        locationPanel.style.left = '20px';\r\n        locationPanel.style.padding = '10px 20px';\r\n        locationPanel.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';\r\n        locationPanel.style.backdropFilter = 'blur(5px)';\r\n        locationPanel.style.borderRadius = '8px';\r\n        locationPanel.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        locationPanel.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.2)';\r\n        locationPanel.style.fontSize = '14px';\r\n        parent.appendChild(locationPanel);\r\n        \r\n        // Location name with icon\r\n        locationPanel.innerHTML = `\r\n            <div style=\"display:flex; align-items:center; gap:10px;\">\r\n                <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z\" \r\n                          fill=\"rgba(120, 220, 232, 0.8)\"/>\r\n                </svg>\r\n                <span id=\"current-system\" style=\"font-weight:600; letter-spacing:1px;\">SOLAR SYSTEM</span>\r\n            </div>\r\n            <div id=\"location-coordinates\" style=\"margin-top:5px; font-size:12px; opacity:0.8;\">X: 0 Y: 0 Z: 0</div>\r\n            <div id=\"fps-display\" style=\"margin-top:5px; font-size:12px; opacity:0.8;\">FPS: 0</div>\r\n            <div style=\"margin-top:5px; display:flex; align-items:center; gap:10px; font-size:12px; opacity:0.8;\">\r\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                    <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z\" \r\n                          fill=\"rgba(120, 220, 232, 0.8)\"/>\r\n                    <path d=\"M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z\" \r\n                          fill=\"rgba(120, 220, 232, 0.5)\"/>\r\n                </svg>\r\n                <span>ANOMALIES: <span id=\"anomaly-count\" style=\"font-weight:600;\">0</span></span>\r\n            </div>\r\n        `;\r\n        \r\n        // Add decorative corner effects\r\n        this.addCornerElements(locationPanel);\r\n    }\r\n    \r\n    createResourcePanel(parent) {\r\n        // Resource monitoring panel - top right\r\n        const resourcePanel = document.createElement('div');\r\n        resourcePanel.id = 'resource-panel';\r\n        resourcePanel.className = 'hud-panel';\r\n        resourcePanel.style.position = 'absolute';\r\n        resourcePanel.style.top = '20px';\r\n        resourcePanel.style.right = '20px';\r\n        resourcePanel.style.width = '180px';\r\n        resourcePanel.style.padding = '10px 15px';\r\n        resourcePanel.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';\r\n        resourcePanel.style.backdropFilter = 'blur(5px)';\r\n        resourcePanel.style.borderRadius = '8px';\r\n        resourcePanel.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        resourcePanel.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.2)';\r\n        resourcePanel.style.fontSize = '14px';\r\n        parent.appendChild(resourcePanel);\r\n        \r\n        // Panel header\r\n        const resourceHeader = document.createElement('div');\r\n        resourceHeader.className = 'panel-header';\r\n        resourceHeader.innerHTML = '<span>CARGO BAY</span>';\r\n        resourceHeader.style.fontWeight = '600';\r\n        resourceHeader.style.fontSize = '12px';\r\n        resourceHeader.style.textTransform = 'uppercase';\r\n        resourceHeader.style.letterSpacing = '1px';\r\n        resourceHeader.style.marginBottom = '8px';\r\n        resourceHeader.style.paddingBottom = '5px';\r\n        resourceHeader.style.borderBottom = '1px solid rgba(120, 220, 232, 0.3)';\r\n        resourceHeader.style.display = 'flex';\r\n        resourceHeader.style.justifyContent = 'space-between';\r\n        resourceHeader.style.alignItems = 'center';\r\n        resourcePanel.appendChild(resourceHeader);\r\n        \r\n        // Add resources with hex icon prefixes\r\n        const createResourceRow = (name, id, hexColor) => {\r\n            const row = document.createElement('div');\r\n            row.style.display = 'flex';\r\n            row.style.alignItems = 'center';\r\n            row.style.justifyContent = 'space-between';\r\n            row.style.margin = '5px 0';\r\n            \r\n            // Hex icon with resource color\r\n            const hexIcon = document.createElement('div');\r\n            hexIcon.style.width = '12px';\r\n            hexIcon.style.height = '14px';\r\n            hexIcon.style.clipPath = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)';\r\n            hexIcon.style.backgroundColor = hexColor;\r\n            hexIcon.style.marginRight = '8px';\r\n            \r\n            const label = document.createElement('div');\r\n            label.style.display = 'flex';\r\n            label.style.alignItems = 'center';\r\n            label.style.width = '50%';\r\n            label.style.fontSize = '12px';\r\n            label.appendChild(hexIcon);\r\n            label.appendChild(document.createTextNode(name));\r\n            \r\n            const value = document.createElement('div');\r\n            value.id = id;\r\n            value.style.width = '50%';\r\n            value.style.textAlign = 'right';\r\n            value.style.fontWeight = '600';\r\n            value.style.fontSize = '12px';\r\n            value.textContent = '0';\r\n            \r\n            row.appendChild(label);\r\n            row.appendChild(value);\r\n            resourcePanel.appendChild(row);\r\n        };\r\n        \r\n        createResourceRow('IRON', 'iron-amount', 'rgba(180, 180, 180, 0.8)');\r\n        createResourceRow('GOLD', 'gold-amount', 'rgba(255, 215, 0, 0.8)');\r\n        createResourceRow('PLATINUM', 'platinum-amount', 'rgba(229, 228, 226, 0.8)');\r\n        \r\n        // Add capacity meter\r\n        const capacityRow = document.createElement('div');\r\n        capacityRow.style.marginTop = '8px';\r\n        capacityRow.style.display = 'flex';\r\n        capacityRow.style.justifyContent = 'space-between';\r\n        capacityRow.style.alignItems = 'center';\r\n        capacityRow.style.borderTop = '1px solid rgba(120, 220, 232, 0.3)';\r\n        capacityRow.style.paddingTop = '8px';\r\n        resourcePanel.appendChild(capacityRow);\r\n        \r\n        const capacityLabel = document.createElement('div');\r\n        capacityLabel.textContent = 'CAPACITY';\r\n        capacityLabel.style.fontSize = '12px';\r\n        capacityRow.appendChild(capacityLabel);\r\n        \r\n        const capacityValue = document.createElement('div');\r\n        capacityValue.id = 'cargo-capacity';\r\n        capacityValue.textContent = '0 / 1000';\r\n        capacityValue.style.fontSize = '12px';\r\n        capacityValue.style.fontWeight = '600';\r\n        capacityRow.appendChild(capacityValue);\r\n        \r\n        // Add capacity bar\r\n        const capacityBarContainer = document.createElement('div');\r\n        capacityBarContainer.style.width = '100%';\r\n        capacityBarContainer.style.height = '5px';\r\n        capacityBarContainer.style.backgroundColor = 'rgba(10, 30, 40, 0.5)';\r\n        capacityBarContainer.style.borderRadius = '3px';\r\n        capacityBarContainer.style.overflow = 'hidden';\r\n        capacityBarContainer.style.marginTop = '5px';\r\n        resourcePanel.appendChild(capacityBarContainer);\r\n        \r\n        const capacityBar = document.createElement('div');\r\n        capacityBar.id = 'capacity-bar';\r\n        capacityBar.style.width = '0%';\r\n        capacityBar.style.height = '100%';\r\n        capacityBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        capacityBar.style.transition = 'width 0.3s ease';\r\n        capacityBarContainer.appendChild(capacityBar);\r\n        \r\n        // Add decorative corner elements\r\n        this.addCornerElements(resourcePanel);\r\n    }\r\n    \r\n    // Radar panel removed as per user request\r\n    \r\n    createNotificationsArea(parent) {\r\n        // Create notifications area in the top middle of the screen\r\n        const notificationsArea = document.createElement('div');\r\n        notificationsArea.id = 'notifications-area';\r\n        notificationsArea.style.position = 'absolute';\r\n        notificationsArea.style.top = '20px';\r\n        notificationsArea.style.left = '50%';\r\n        notificationsArea.style.transform = 'translateX(-50%)';\r\n        notificationsArea.style.display = 'flex';\r\n        notificationsArea.style.flexDirection = 'column';\r\n        notificationsArea.style.alignItems = 'center';\r\n        notificationsArea.style.gap = '10px';\r\n        parent.appendChild(notificationsArea);\r\n        \r\n        // Note: Survival timer has been removed - only horde mode timer will be used\r\n        \r\n        // Add horde mode indicator (hidden by default)\r\n        const hordeIndicator = document.createElement('div');\r\n        hordeIndicator.id = 'horde-mode-indicator';\r\n        hordeIndicator.className = 'hud-panel';\r\n        hordeIndicator.style.display = 'none'; // Hidden by default, will be changed to 'flex' when active\r\n        hordeIndicator.style.padding = '8px 12px';\r\n        hordeIndicator.style.backgroundColor = 'rgba(51, 10, 10, 0.8)';\r\n        hordeIndicator.style.backdropFilter = 'blur(5px)';\r\n        hordeIndicator.style.borderRadius = '8px';\r\n        hordeIndicator.style.border = '1px solid #ff3030';\r\n        hordeIndicator.style.boxShadow = '0 0 15px rgba(255, 48, 48, 0.5)';\r\n        hordeIndicator.style.animation = 'pulse-horde 2s infinite';\r\n        hordeIndicator.style.marginBottom = '10px';\r\n        hordeIndicator.style.fontSize = '18px';\r\n        hordeIndicator.style.fontWeight = '600';\r\n        hordeIndicator.style.letterSpacing = '1px';\r\n        \r\n        // Create a flex container for the horde mode indicator content\r\n        const hordeContent = document.createElement('div');\r\n        hordeContent.style.display = 'flex';\r\n        hordeContent.style.alignItems = 'center';\r\n        hordeContent.style.justifyContent = 'center';\r\n        hordeContent.style.gap = '10px';\r\n        \r\n        // Add the text and timer elements\r\n        const hordeLabel = document.createElement('span');\r\n        hordeLabel.style.color = '#ff3030';\r\n        hordeLabel.style.textShadow = '0 0 5px rgba(255,48,48,0.5)';\r\n        hordeLabel.textContent = 'HORDE MODE';\r\n        \r\n        const survivalTime = document.createElement('span');\r\n        survivalTime.id = 'horde-survival-time';\r\n        survivalTime.style.color = '#ff9999';\r\n        survivalTime.style.fontWeight = 'bold';\r\n        survivalTime.textContent = '00:00';\r\n        \r\n        // Add the elements to the container\r\n        hordeContent.appendChild(hordeLabel);\r\n        hordeContent.appendChild(survivalTime);\r\n        hordeIndicator.appendChild(hordeContent);\r\n        \r\n        // Add decorative corner elements\r\n        this.addCornerElements(hordeIndicator);\r\n        \r\n        notificationsArea.appendChild(hordeIndicator);\r\n        \r\n        // Add CSS for horde mode pulsing\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            @keyframes pulse-horde {\r\n                0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }\r\n                50% { box-shadow: 0 0 10px rgba(255, 30, 30, 0.8); }\r\n                100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n    }\r\n    \r\n    // Helper methods for UI elements\r\n    createPanelRow(panel, label, id, defaultValue, isIndicator = false) {\r\n        const row = document.createElement('div');\r\n        row.className = 'panel-row';\r\n        row.style.display = 'flex';\r\n        row.style.justifyContent = 'space-between';\r\n        row.style.alignItems = 'center';\r\n        row.style.margin = '8px 0';\r\n        panel.appendChild(row);\r\n        \r\n        const labelEl = document.createElement('span');\r\n        labelEl.className = 'row-label';\r\n        labelEl.textContent = label;\r\n        row.appendChild(labelEl);\r\n        \r\n        const valueEl = document.createElement('span');\r\n        valueEl.id = id;\r\n        valueEl.className = 'row-value';\r\n        valueEl.textContent = defaultValue;\r\n        \r\n        if (isIndicator && defaultValue === 'ON') {\r\n            valueEl.style.color = '#5fff8f';\r\n        } else if (isIndicator && defaultValue === 'OFF') {\r\n            valueEl.style.color = '#ff7f7f';\r\n        }\r\n        \r\n        row.appendChild(valueEl);\r\n    }\r\n    \r\n    createStatusRow(panel, label, id, status) {\r\n        const row = document.createElement('div');\r\n        row.className = 'status-row';\r\n        row.style.display = 'flex';\r\n        row.style.justifyContent = 'space-between';\r\n        row.style.alignItems = 'center';\r\n        row.style.margin = '8px 0';\r\n        panel.appendChild(row);\r\n        \r\n        const labelEl = document.createElement('span');\r\n        labelEl.className = 'row-label';\r\n        labelEl.textContent = label;\r\n        labelEl.style.fontSize = '12px';\r\n        row.appendChild(labelEl);\r\n        \r\n        const valueEl = document.createElement('span');\r\n        valueEl.id = id;\r\n        valueEl.className = 'row-value';\r\n        valueEl.textContent = status;\r\n        valueEl.style.fontSize = '12px';\r\n        valueEl.style.fontWeight = '600';\r\n        \r\n        // Color based on status\r\n        if (status === 'NOMINAL') {\r\n            valueEl.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        } else if (status === 'WARNING') {\r\n            valueEl.style.color = '#ffcc00';\r\n        } else if (status === 'CRITICAL') {\r\n            valueEl.style.color = '#ff3030';\r\n        }\r\n        \r\n        row.appendChild(valueEl);\r\n    }\r\n    \r\n    addHolographicElements(panel) {\r\n        // Add corner decorative elements only\r\n        this.addCornerElements(panel);\r\n    }\r\n    \r\n    addCornerElements(panel) {\r\n        // Top left corner\r\n        const topLeft = document.createElement('div');\r\n        topLeft.style.position = 'absolute';\r\n        topLeft.style.top = '0';\r\n        topLeft.style.left = '0';\r\n        topLeft.style.width = '10px';\r\n        topLeft.style.height = '10px';\r\n        topLeft.style.borderTop = '2px solid rgba(120, 220, 232, 0.8)';\r\n        topLeft.style.borderLeft = '2px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(topLeft);\r\n        \r\n        // Top right corner\r\n        const topRight = document.createElement('div');\r\n        topRight.style.position = 'absolute';\r\n        topRight.style.top = '0';\r\n        topRight.style.right = '0';\r\n        topRight.style.width = '10px';\r\n        topRight.style.height = '10px';\r\n        topRight.style.borderTop = '2px solid rgba(120, 220, 232, 0.8)';\r\n        topRight.style.borderRight = '2px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(topRight);\r\n        \r\n        // Bottom left corner\r\n        const bottomLeft = document.createElement('div');\r\n        bottomLeft.style.position = 'absolute';\r\n        bottomLeft.style.bottom = '0';\r\n        bottomLeft.style.left = '0';\r\n        bottomLeft.style.width = '10px';\r\n        bottomLeft.style.height = '10px';\r\n        bottomLeft.style.borderBottom = '2px solid rgba(120, 220, 232, 0.8)';\r\n        bottomLeft.style.borderLeft = '2px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(bottomLeft);\r\n        \r\n        // Bottom right corner\r\n        const bottomRight = document.createElement('div');\r\n        bottomRight.style.position = 'absolute';\r\n        bottomRight.style.bottom = '0';\r\n        bottomRight.style.right = '0';\r\n        bottomRight.style.width = '10px';\r\n        bottomRight.style.height = '10px';\r\n        bottomRight.style.borderBottom = '2px solid rgba(120, 220, 232, 0.8)';\r\n        bottomRight.style.borderRight = '2px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(bottomRight);\r\n    }\r\n    \r\n    // Animation for HUD appearance\r\n    animateHudIn() {\r\n        // Add styling for animations\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            @keyframes pulse {\r\n                0% { opacity: 0.7; }\r\n                50% { opacity: 1; }\r\n                100% { opacity: 0.7; }\r\n            }\r\n            \r\n            @keyframes radar-ping {\r\n                0% { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }\r\n                100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }\r\n            }\r\n            \r\n            @keyframes text-flicker {\r\n                0% { opacity: 1; }\r\n                3% { opacity: 0.4; }\r\n                6% { opacity: 1; }\r\n                9% { opacity: 0.4; }\r\n                12% { opacity: 1; }\r\n                35% { opacity: 1; }\r\n                38% { opacity: 0.4; }\r\n                41% { opacity: 1; }\r\n                100% { opacity: 1; }\r\n            }\r\n            \r\n            @keyframes blink {\r\n                0% { opacity: 1; }\r\n                49% { opacity: 1; }\r\n                50% { opacity: 0; }\r\n                100% { opacity: 0; }\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n        \r\n        // Add glitch effect for initialization\r\n        this.addStartupGlitchEffect();\r\n        \r\n        // Animate scanlines\r\n        setTimeout(() => {\r\n            if (this.scanline) {\r\n                this.animateScanline();\r\n            }\r\n        }, 1500);\r\n    }\r\n    \r\n    addStartupGlitchEffect() {\r\n        // Add glitch animation to show HUD is starting up\r\n        const hudContainer = document.getElementById('hud-container');\r\n        if (!hudContainer) return;\r\n        \r\n        // Incremental fade-in with glitches\r\n        setTimeout(() => {\r\n            hudContainer.style.opacity = '0.3';\r\n            this.addGlitch(hudContainer);\r\n        }, 300);\r\n        \r\n        setTimeout(() => {\r\n            hudContainer.style.opacity = '0.7';\r\n            this.addGlitch(hudContainer);\r\n        }, 800);\r\n        \r\n        setTimeout(() => {\r\n            hudContainer.style.opacity = '1';\r\n            this.addGlitch(hudContainer);\r\n        }, 1200);\r\n        \r\n        // Start random glitch effects at intervals\r\n        this.glitchInterval = setInterval(() => {\r\n            if (Math.random() > 0.7) {\r\n                this.addGlitch(hudContainer);\r\n            }\r\n        }, 5000);\r\n    }\r\n    \r\n    addGlitch(element) {\r\n        // Create a temporary animation\r\n        const glitchAnimation = `\r\n            @keyframes glitch-${Date.now()} {\r\n                0% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }\r\n                1% { transform: translate(2px, 2px) skew(1deg); filter: hue-rotate(90deg); }\r\n                2% { transform: translate(-2px, -3px) skew(-1deg); filter: hue-rotate(180deg); }\r\n                3% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }\r\n                12% { clip-path: inset(0 0 0 0); }\r\n                13% { clip-path: inset(10% 0 0 0); }\r\n                14% { clip-path: inset(0 0 0 0); }\r\n                15% { clip-path: inset(0 0 10% 0); }\r\n                16% { clip-path: inset(0 0 0 0); }\r\n                100% { transform: translate(0, 0) skew(0deg); filter: hue-rotate(0deg); }\r\n            }\r\n        `;\r\n        \r\n        // Add animation to document\r\n        const style = document.createElement('style');\r\n        style.textContent = glitchAnimation;\r\n        document.head.appendChild(style);\r\n        \r\n        // Apply animation\r\n        const animationName = `glitch-${Date.now()}`;\r\n        element.style.animation = `${animationName} 1s forwards`;\r\n        \r\n        // Remove animation after it's complete\r\n        setTimeout(() => {\r\n            element.style.animation = '';\r\n            style.remove();\r\n        }, 1000);\r\n    }\r\n    \r\n    animateScanline() {\r\n        // Animate the scanline moving down the screen\r\n        let position = 0;\r\n        const height = window.innerHeight;\r\n        \r\n        const moveScanline = () => {\r\n            if (!this.scanline) return;\r\n            position = (position + 2) % height;\r\n            this.scanline.style.top = `${position}px`;\r\n            \r\n            // Add random flicker\r\n            if (Math.random() > 0.97) {\r\n                this.scanline.style.opacity = '0';\r\n                setTimeout(() => {\r\n                    if (this.scanline) {\r\n                        this.scanline.style.opacity = '0.7';\r\n                    }\r\n                }, 50);\r\n            }\r\n            \r\n            this.animationFrames.push(requestAnimationFrame(moveScanline));\r\n        };\r\n        \r\n        moveScanline();\r\n    }\r\n    \r\n    update() {\r\n        if (!this.spaceship) return;\r\n        \r\n        // Update shield display\r\n        this.updateShieldDisplay();\r\n        \r\n        // Update hull display\r\n        this.updateHullDisplay();\r\n        \r\n        // Update fuel display\r\n        const fuelBar = document.getElementById('fuel-bar');\r\n        const fuelValue = document.getElementById('fuel-value');\r\n        if (fuelBar) {\r\n            // Correctly calculate fuel percentage based on maxFuel\r\n            const fuelPercent = this.spaceship.maxFuel > 0 ? \r\n                (this.spaceship.fuel / this.spaceship.maxFuel) * 100 : 0;\r\n            \r\n            fuelBar.style.width = `${fuelPercent}%`;\r\n            \r\n            // Change color based on fuel level\r\n            if (fuelPercent < 20) {\r\n                fuelBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)';\r\n            } else if (fuelPercent < 40) {\r\n                fuelBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)';\r\n            } else {\r\n                fuelBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n            }\r\n            \r\n            // Update text display if it exists\r\n            if (fuelValue) {\r\n                fuelValue.textContent = `${Math.round(this.spaceship.fuel)} / ${Math.round(this.spaceship.maxFuel)}`;\r\n            }\r\n        }\r\n        \r\n        // Update credits display\r\n        const creditsDisplay = document.getElementById('credits-value');\r\n        if (creditsDisplay) {\r\n            creditsDisplay.textContent = `${this.spaceship.credits} CR`;\r\n        }\r\n        \r\n        // Update horde mode indicator and timer\r\n        this.updateHordeModeDisplay();\r\n    }\r\n    \r\n    /**\r\n     * Update the horde mode indicator and survival timer\r\n     */\r\n    updateHordeModeDisplay() {\r\n        const hordeIndicator = document.getElementById('horde-mode-indicator');\r\n        const survivalTime = document.getElementById('horde-survival-time');\r\n        \r\n        if (!hordeIndicator || !survivalTime) return;\r\n        \r\n        // Check if horde mode is active in the game\r\n        if (window.game && window.game.isHordeActive) {\r\n            // Show the indicator if not already visible\r\n            if (hordeIndicator.style.display === 'none') {\r\n                hordeIndicator.style.display = 'flex';\r\n            }\r\n            \r\n            // Update the survival time display\r\n            if (window.game.getFormattedHordeSurvivalTime) {\r\n                survivalTime.textContent = window.game.getFormattedHordeSurvivalTime();\r\n            } else {\r\n                // Fallback calculation if method not available\r\n                const totalSeconds = Math.floor(window.game.hordeSurvivalTime / 1000);\r\n                const minutes = Math.floor(totalSeconds / 60);\r\n                const seconds = totalSeconds % 60;\r\n                survivalTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\r\n            }\r\n            \r\n            // Increase pulsing intensity based on survival time\r\n            // After 3 minutes, make the pulsing more urgent\r\n            if (window.game.hordeSurvivalTime > 3 * 60 * 1000) {\r\n                const styleEl = document.createElement('style');\r\n                styleEl.textContent = `\r\n                    @keyframes pulse-horde {\r\n                        0% { box-shadow: 0 0 8px rgba(255, 30, 30, 0.7); }\r\n                        50% { box-shadow: 0 0 15px rgba(255, 30, 30, 1); }\r\n                        100% { box-shadow: 0 0 8px rgba(255, 30, 30, 0.7); }\r\n                    }\r\n                `;\r\n                document.head.appendChild(styleEl);\r\n                \r\n                // Make animation faster\r\n                hordeIndicator.style.animation = 'pulse-horde 1s infinite';\r\n            }\r\n        } else {\r\n            // Hide the indicator if horde mode is not active\r\n            hordeIndicator.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    // Add a new method to update shield display directly from HealthComponent\r\n    updateShieldDisplay() {\r\n        const shieldBar = document.getElementById('shield-bar');\r\n        if (!shieldBar) return;\r\n        \r\n        let shieldPercentage = 100;\r\n        let shieldFound = false;\r\n        \r\n        // Try to directly access player's health component\r\n        try {\r\n            if (window.game && window.game.world) {\r\n                const players = window.game.world.getEntitiesByTag('player');\r\n                if (players && players.length > 0) {\r\n                    const player = players[0];\r\n                    const health = player.getComponent('HealthComponent');\r\n                    \r\n                    if (health) {\r\n                        shieldPercentage = health.getShieldPercentage();\r\n                        \r\n                        // Ensure spaceship object is in sync with the HealthComponent\r\n                        if (this.spaceship) {\r\n                            // If HealthComponent shield is higher, use that value\r\n                            if (health.shield > this.spaceship.shield) {\r\n                                this.spaceship.shield = health.shield;\r\n                                this.spaceship.maxShield = health.maxShield;\r\n                            } \r\n                            // If spaceship shield is higher (e.g., after repair), update health component\r\n                            else if (this.spaceship.shield > health.shield) {\r\n                                health.shield = this.spaceship.shield;\r\n                                console.log(`Updated HealthComponent shield from spaceship: ${health.shield}`);\r\n                                // Recalculate shield percentage\r\n                                shieldPercentage = health.getShieldPercentage();\r\n                            }\r\n                        }\r\n                        \r\n                        shieldFound = true;\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error accessing player shield component:\", e);\r\n        }\r\n        \r\n        // Fallback to spaceship object if health component not found\r\n        if (!shieldFound && this.spaceship && this.spaceship.shield !== undefined) {\r\n            shieldPercentage = (this.spaceship.shield / this.spaceship.maxShield) * 100;\r\n        }\r\n        \r\n        // Update the shield bar\r\n        shieldBar.style.width = `${shieldPercentage}%`;\r\n        \r\n        // Change color based on shield status\r\n        if (shieldPercentage < 25) {\r\n            shieldBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)'; // Red for low shields\r\n        } else if (shieldPercentage < 50) {\r\n            shieldBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)'; // Yellow for medium shields\r\n        } else {\r\n            shieldBar.style.backgroundColor = 'rgba(51, 153, 255, 0.8)'; // Blue for healthy shields\r\n        }\r\n    }\r\n    \r\n    // New method to update hull display directly from HealthComponent if possible\r\n    updateHullDisplay() {\r\n        const hullBar = document.getElementById('hull-bar');\r\n        if (!hullBar) return;\r\n        \r\n        let hullPercentage = 100;\r\n        let healthFound = false;\r\n        \r\n        // Try to directly access player's health component\r\n        try {\r\n            if (window.game && window.game.world) {\r\n                const players = window.game.world.getEntitiesByTag('player');\r\n                if (players && players.length > 0) {\r\n                    const player = players[0];\r\n                    const health = player.getComponent('HealthComponent');\r\n                    \r\n                    if (health) {\r\n                        hullPercentage = health.getHealthPercentage();\r\n                        \r\n                        // Ensure spaceship object is in sync with the HealthComponent\r\n                        if (this.spaceship) {\r\n                            // If HealthComponent health is higher, use that value\r\n                            if (health.health > this.spaceship.hull) {\r\n                                this.spaceship.hull = health.health;\r\n                                this.spaceship.maxHull = health.maxHealth;\r\n                            }\r\n                            // If spaceship hull is higher (e.g., after repair), update health component\r\n                            else if (this.spaceship.hull > health.health) {\r\n                                health.health = this.spaceship.hull;\r\n                                console.log(`Updated HealthComponent health from spaceship: ${health.health}`);\r\n                                // Recalculate hull percentage\r\n                                hullPercentage = health.getHealthPercentage();\r\n                            }\r\n                        }\r\n                        \r\n                        healthFound = true;\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.error(\"Error accessing player health component:\", e);\r\n        }\r\n        \r\n        // Fallback to spaceship object if health component not found\r\n        if (!healthFound && this.spaceship && this.spaceship.hull !== undefined) {\r\n            hullPercentage = (this.spaceship.hull / this.spaceship.maxHull) * 100;\r\n        }\r\n        \r\n        // Update the hull bar\r\n        hullBar.style.width = `${hullPercentage}%`;\r\n        \r\n        // Change color based on hull status\r\n        if (hullPercentage < 30) {\r\n            hullBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)';\r\n        } else if (hullPercentage < 60) {\r\n            hullBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)';\r\n        } else {\r\n            hullBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        }\r\n    }\r\n    \r\n    updateLocation(locationName, systemName = 'Unknown System') {\r\n        // Update system name in location panel\r\n        const currentSystem = document.getElementById('current-system');\r\n        \r\n        if (currentSystem) {\r\n            currentSystem.textContent = systemName.toUpperCase();\r\n            \r\n            // Add glitch effect during location change\r\n            const locationPanel = document.getElementById('location-panel');\r\n            if (locationPanel) {\r\n                this.addGlitch(locationPanel);\r\n            }\r\n        }\r\n    }\r\n    \r\n    updateCoordinates(x, y, z) {\r\n        const coordsElement = document.getElementById('location-coordinates');\r\n        if (coordsElement) {\r\n            coordsElement.textContent = `X: ${Math.round(x)} Y: ${Math.round(y)} Z: ${Math.round(z)}`;\r\n        }\r\n    }\r\n    \r\n    updateFPS(fps, cap) {\r\n        const fpsElement = document.getElementById('fps-display');\r\n        if (fpsElement) {\r\n            if (cap) {\r\n                // Show actual FPS and the cap\r\n                fpsElement.textContent = `FPS: ${Math.round(fps)}/${cap}`;\r\n                \r\n                // Color code based on performance relative to cap\r\n                if (fps < cap * 0.9) {\r\n                    // Below 90% of target - indicate performance issues\r\n                    fpsElement.style.color = \"rgba(255, 120, 120, 0.9)\";\r\n                } else {\r\n                    // Normal performance - standard color\r\n                    fpsElement.style.color = \"rgba(120, 220, 232, 0.8)\";\r\n                }\r\n            } else {\r\n                // Just show FPS for uncapped mode\r\n                fpsElement.textContent = `FPS: ${Math.round(fps)}`;\r\n                fpsElement.style.color = \"rgba(120, 220, 232, 0.8)\";\r\n            }\r\n            \r\n            // Add auto indicator if using monitor refresh rate\r\n            if (window.game && \r\n                window.game.ui && \r\n                window.game.ui.settings && \r\n                window.game.ui.settings.settings.frameRateCap === 'auto') {\r\n                \r\n                const refreshRate = window.game.ui.settings.monitorRefreshRate || 60;\r\n                \r\n                if (cap > 0) {\r\n                    // Show it's using auto mode with the detected refresh rate\r\n                    fpsElement.textContent = `FPS: ${Math.round(fps)}/${cap} (Auto)`;\r\n                } else {\r\n                    // Using unlimited because refresh rate is high\r\n                    fpsElement.textContent = `FPS: ${Math.round(fps)} (Auto: Unlimited)`;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        // Hide HUD container\r\n        const hudContainer = document.getElementById('hud-container');\r\n        if (hudContainer) {\r\n            hudContainer.style.opacity = '0';\r\n        }\r\n        \r\n        // Clear animation frames\r\n        this.animationFrames.forEach(frame => cancelAnimationFrame(frame));\r\n        this.animationFrames = [];\r\n        \r\n        // Clear glitch interval\r\n        if (this.glitchInterval) {\r\n            clearInterval(this.glitchInterval);\r\n        }\r\n    }\r\n    \r\n    show() {\r\n        // Show HUD container\r\n        const hudContainer = document.getElementById('hud-container');\r\n        if (hudContainer) {\r\n            hudContainer.style.opacity = '1';\r\n        }\r\n        \r\n        // Restart scanline animation\r\n        if (this.scanline) {\r\n            this.animateScanline();\r\n        }\r\n        \r\n        // Restart glitch interval\r\n        if (!this.glitchInterval) {\r\n            this.glitchInterval = setInterval(() => {\r\n                if (Math.random() > 0.7) {\r\n                    this.addGlitch(hudContainer);\r\n                }\r\n            }, 5000);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clean up resources and event listeners\r\n     */\r\n    destroy() {\r\n        // Cancel any active animation frames\r\n        this.animationFrames.forEach(frameId => {\r\n            cancelAnimationFrame(frameId);\r\n        });\r\n        this.animationFrames = [];\r\n        \r\n        // Clear intervals\r\n        if (this.glitchInterval) {\r\n            clearInterval(this.glitchInterval);\r\n            this.glitchInterval = null;\r\n        }\r\n        \r\n        // Remove DOM event listeners\r\n        const controls = document.getElementById('show-controls');\r\n        if (controls) {\r\n            controls.removeEventListener('click', controls.clickHandler);\r\n            controls.removeEventListener('mouseover', controls.mouseoverHandler);\r\n            controls.removeEventListener('mouseout', controls.mouseoutHandler);\r\n        }\r\n        \r\n        // Remove DOM elements\r\n        const hudContainer = document.getElementById('hud-container');\r\n        if (hudContainer && hudContainer.parentNode) {\r\n            hudContainer.parentNode.removeChild(hudContainer);\r\n        }\r\n        \r\n        // Clear references\r\n        this.spaceship = null;\r\n        this.scanline = null;\r\n    }\r\n}","// mobileHUD.js - Simplified HUD for mobile devices\r\n\r\nexport class MobileHUD {\r\n    constructor(spaceship) {\r\n        this.spaceship = spaceship;\r\n        this.controls = null; // Will be set from UI class\r\n        this.setupMobileHUD();\r\n    }\r\n    \r\n    setupMobileHUD() {\r\n        // Add CSS for animations\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            @keyframes pulse-horde-mobile {\r\n                0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }\r\n                50% { box-shadow: 0 0 10px rgba(255, 30, 30, 0.8); }\r\n                100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.5); }\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n        \r\n        // Create main container for mobile HUD\r\n        const hudContainer = document.createElement('div');\r\n        hudContainer.id = 'mobile-hud-container';\r\n        hudContainer.style.position = 'absolute';\r\n        hudContainer.style.top = '10px';\r\n        hudContainer.style.right = '10px';\r\n        hudContainer.style.width = 'min(140px, 25vw)'; // Responsive width with minimum\r\n        hudContainer.style.backgroundColor = 'rgba(6, 22, 31, 0.8)';\r\n        hudContainer.style.backdropFilter = 'blur(5px)';\r\n        hudContainer.style.webkitBackdropFilter = 'blur(5px)'; // For Safari\r\n        hudContainer.style.borderRadius = '8px';\r\n        hudContainer.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        hudContainer.style.padding = '10px';\r\n        hudContainer.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        hudContainer.style.fontFamily = '\"Rajdhani\", \"Electrolize\", sans-serif';\r\n        hudContainer.style.fontSize = '14px';\r\n        hudContainer.style.boxShadow = '0 0 10px rgba(120, 220, 232, 0.2)';\r\n        hudContainer.style.zIndex = '1000';\r\n        // Add hardware acceleration to improve performance\r\n        hudContainer.style.transform = 'translateZ(0)';\r\n        hudContainer.style.backfaceVisibility = 'hidden';\r\n        document.body.appendChild(hudContainer);\r\n\r\n        // Create status bars with labels\r\n        this.createStatusBar(hudContainer, 'S', 'shield-bar-mobile', 'rgba(51, 153, 255, 0.8)');\r\n        this.createStatusBar(hudContainer, 'H', 'hull-bar-mobile', 'rgba(120, 220, 232, 0.8)');\r\n        this.createStatusBar(hudContainer, 'F', 'fuel-bar-mobile', 'rgba(120, 220, 232, 0.8)');\r\n        \r\n        // Add anomaly count display\r\n        this.createAnomalyDisplay(hudContainer);\r\n        \r\n        // Create cargo display\r\n        const cargoContainer = document.createElement('div');\r\n        cargoContainer.style.display = 'flex';\r\n        cargoContainer.style.justifyContent = 'space-between';\r\n        cargoContainer.style.alignItems = 'center';\r\n        cargoContainer.style.marginTop = '10px';\r\n        \r\n        const cargoLabel = document.createElement('div');\r\n        cargoLabel.textContent = 'C';\r\n        cargoLabel.style.marginRight = '10px';\r\n        cargoLabel.style.fontSize = '14px';\r\n        \r\n        const cargoValue = document.createElement('div');\r\n        cargoValue.id = 'cargo-value-mobile';\r\n        cargoValue.textContent = '0 / 1000';\r\n        cargoValue.style.textAlign = 'right';\r\n        cargoValue.style.flexGrow = '1';\r\n        cargoValue.style.fontSize = '14px';\r\n        \r\n        cargoContainer.appendChild(cargoLabel);\r\n        cargoContainer.appendChild(cargoValue);\r\n        hudContainer.appendChild(cargoContainer);\r\n        \r\n        // Add horde mode indicator (hidden by default)\r\n        const hordeContainer = document.createElement('div');\r\n        hordeContainer.id = 'mobile-horde-indicator';\r\n        hordeContainer.style.display = 'none';\r\n        hordeContainer.style.marginTop = '10px';\r\n        hordeContainer.style.padding = '5px';\r\n        hordeContainer.style.backgroundColor = 'rgba(255, 30, 30, 0.2)';\r\n        hordeContainer.style.borderRadius = '4px';\r\n        hordeContainer.style.border = '1px solid #ff3030';\r\n        hordeContainer.style.animation = 'pulse-horde-mobile 2s infinite';\r\n        hordeContainer.style.fontSize = '12px';\r\n        \r\n        const hordeTimer = document.createElement('div');\r\n        hordeTimer.id = 'mobile-horde-timer';\r\n        hordeTimer.textContent = '00:00';\r\n        hordeTimer.style.textAlign = 'center';\r\n        hordeTimer.style.fontWeight = 'bold';\r\n        hordeTimer.style.color = '#ff3030';\r\n        \r\n        hordeContainer.appendChild(hordeTimer);\r\n        hudContainer.appendChild(hordeContainer);\r\n        \r\n        // Add decorative corner elements\r\n        this.addCornerElements(hudContainer);\r\n    }\r\n    \r\n    createStatusBar(parent, label, id, color) {\r\n        const container = document.createElement('div');\r\n        container.style.display = 'flex';\r\n        container.style.alignItems = 'center';\r\n        container.style.marginBottom = '8px';\r\n        \r\n        const labelElement = document.createElement('div');\r\n        labelElement.textContent = label;\r\n        labelElement.style.marginRight = '8px';\r\n        labelElement.style.width = '16px';\r\n        labelElement.style.textAlign = 'center';\r\n        labelElement.style.fontSize = '14px';\r\n        \r\n        const barContainer = document.createElement('div');\r\n        barContainer.style.flexGrow = '1';\r\n        barContainer.style.height = '8px';\r\n        barContainer.style.backgroundColor = 'rgba(10, 30, 40, 0.5)';\r\n        barContainer.style.borderRadius = '4px';\r\n        barContainer.style.overflow = 'hidden';\r\n        barContainer.style.position = 'relative';\r\n        \r\n        // Add fuel value text if this is the fuel bar\r\n        if (id === 'fuel-bar-mobile') {\r\n            const fuelValue = document.createElement('div');\r\n            fuelValue.id = 'fuel-value-mobile';\r\n            fuelValue.style.position = 'absolute';\r\n            fuelValue.style.right = '0';\r\n            fuelValue.style.top = '-14px';\r\n            fuelValue.style.fontSize = '10px';\r\n            fuelValue.style.color = 'rgba(120, 220, 232, 0.9)';\r\n            fuelValue.textContent = '100 / 100';\r\n            barContainer.appendChild(fuelValue);\r\n        }\r\n        \r\n        const bar = document.createElement('div');\r\n        bar.id = id;\r\n        bar.style.width = '100%';\r\n        bar.style.height = '100%';\r\n        bar.style.backgroundColor = color;\r\n        bar.style.transition = 'width 0.2s ease';\r\n        \r\n        barContainer.appendChild(bar);\r\n        container.appendChild(labelElement);\r\n        container.appendChild(barContainer);\r\n        parent.appendChild(container);\r\n    }\r\n    \r\n    createAnomalyDisplay(parent) {\r\n        const anomalyContainer = document.createElement('div');\r\n        anomalyContainer.style.display = 'flex';\r\n        anomalyContainer.style.justifyContent = 'space-between';\r\n        anomalyContainer.style.alignItems = 'center';\r\n        anomalyContainer.style.marginBottom = '8px';\r\n        \r\n        const anomalyLabel = document.createElement('div');\r\n        anomalyLabel.textContent = 'A';\r\n        anomalyLabel.style.marginRight = '8px';\r\n        anomalyLabel.style.width = '16px';\r\n        anomalyLabel.style.textAlign = 'center';\r\n        anomalyLabel.style.fontSize = '14px';\r\n        \r\n        const anomalyCount = document.createElement('div');\r\n        anomalyCount.id = 'anomaly-count-mobile';\r\n        anomalyCount.textContent = '0';\r\n        anomalyCount.style.textAlign = 'right';\r\n        anomalyCount.style.flexGrow = '1';\r\n        anomalyCount.style.fontSize = '14px';\r\n        anomalyCount.style.fontWeight = 'bold';\r\n        anomalyCount.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        \r\n        anomalyContainer.appendChild(anomalyLabel);\r\n        anomalyContainer.appendChild(anomalyCount);\r\n        parent.appendChild(anomalyContainer);\r\n    }\r\n    \r\n    addCornerElements(panel) {\r\n        // Top left corner\r\n        const topLeft = document.createElement('div');\r\n        topLeft.style.position = 'absolute';\r\n        topLeft.style.top = '0';\r\n        topLeft.style.left = '0';\r\n        topLeft.style.width = '6px';\r\n        topLeft.style.height = '6px';\r\n        topLeft.style.borderTop = '1px solid rgba(120, 220, 232, 0.8)';\r\n        topLeft.style.borderLeft = '1px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(topLeft);\r\n        \r\n        // Top right corner\r\n        const topRight = document.createElement('div');\r\n        topRight.style.position = 'absolute';\r\n        topRight.style.top = '0';\r\n        topRight.style.right = '0';\r\n        topRight.style.width = '6px';\r\n        topRight.style.height = '6px';\r\n        topRight.style.borderTop = '1px solid rgba(120, 220, 232, 0.8)';\r\n        topRight.style.borderRight = '1px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(topRight);\r\n        \r\n        // Bottom left corner\r\n        const bottomLeft = document.createElement('div');\r\n        bottomLeft.style.position = 'absolute';\r\n        bottomLeft.style.bottom = '0';\r\n        bottomLeft.style.left = '0';\r\n        bottomLeft.style.width = '6px';\r\n        bottomLeft.style.height = '6px';\r\n        bottomLeft.style.borderBottom = '1px solid rgba(120, 220, 232, 0.8)';\r\n        bottomLeft.style.borderLeft = '1px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(bottomLeft);\r\n        \r\n        // Bottom right corner\r\n        const bottomRight = document.createElement('div');\r\n        bottomRight.style.position = 'absolute';\r\n        bottomRight.style.bottom = '0';\r\n        bottomRight.style.right = '0';\r\n        bottomRight.style.width = '6px';\r\n        bottomRight.style.height = '6px';\r\n        bottomRight.style.borderBottom = '1px solid rgba(120, 220, 232, 0.8)';\r\n        bottomRight.style.borderRight = '1px solid rgba(120, 220, 232, 0.8)';\r\n        panel.appendChild(bottomRight);\r\n    }\r\n    \r\n    update() {\r\n        // Update shield display\r\n        this.updateShieldDisplay();\r\n        \r\n        // Update hull display\r\n        this.updateHullDisplay();\r\n        \r\n        // Update fuel display\r\n        this.updateFuelDisplay();\r\n        \r\n        // Update cargo display\r\n        this.updateCargoDisplay();\r\n        \r\n        // Update anomaly count\r\n        this.updateAnomalyCount();\r\n        \r\n        // Update horde mode display\r\n        this.updateHordeModeDisplay();\r\n    }\r\n    \r\n    updateShieldDisplay() {\r\n        const shieldBar = document.getElementById('shield-bar-mobile');\r\n        if (!shieldBar) return;\r\n        \r\n        let shieldPercentage = 100;\r\n        \r\n        // Get shield data from spaceship\r\n        if (this.spaceship && typeof this.spaceship.shield !== 'undefined') {\r\n            shieldPercentage = (this.spaceship.shield / this.spaceship.maxShield) * 100;\r\n        }\r\n        \r\n        // Update the shield bar\r\n        shieldBar.style.width = `${shieldPercentage}%`;\r\n        \r\n        // Change color based on shield status\r\n        if (shieldPercentage < 25) {\r\n            shieldBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)'; // Red for low shields\r\n        } else if (shieldPercentage < 50) {\r\n            shieldBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)'; // Yellow for medium shields\r\n        } else {\r\n            shieldBar.style.backgroundColor = 'rgba(51, 153, 255, 0.8)'; // Blue for healthy shields\r\n        }\r\n    }\r\n    \r\n    updateHullDisplay() {\r\n        const hullBar = document.getElementById('hull-bar-mobile');\r\n        if (!hullBar) return;\r\n        \r\n        let hullPercentage = 100;\r\n        \r\n        // Get hull data from spaceship\r\n        if (this.spaceship && typeof this.spaceship.hull !== 'undefined') {\r\n            hullPercentage = (this.spaceship.hull / this.spaceship.maxHull) * 100;\r\n        }\r\n        \r\n        // Update the hull bar\r\n        hullBar.style.width = `${hullPercentage}%`;\r\n        \r\n        // Change color based on hull status\r\n        if (hullPercentage < 30) {\r\n            hullBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)';\r\n        } else if (hullPercentage < 60) {\r\n            hullBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)';\r\n        } else {\r\n            hullBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        }\r\n    }\r\n    \r\n    updateFuelDisplay() {\r\n        const fuelBar = document.getElementById('fuel-bar-mobile');\r\n        const fuelValue = document.getElementById('fuel-value-mobile');\r\n        if (!fuelBar || !this.spaceship) return;\r\n        \r\n        // Correctly calculate fuel percentage based on maxFuel\r\n        const fuelPercent = this.spaceship.maxFuel > 0 ? \r\n            (this.spaceship.fuel / this.spaceship.maxFuel) * 100 : 0;\r\n        \r\n        fuelBar.style.width = `${fuelPercent}%`;\r\n        \r\n        // Change color when low based on percentage, not absolute value\r\n        if (fuelPercent < 20) {\r\n            fuelBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)';\r\n        } else if (fuelPercent < 40) {\r\n            fuelBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)';\r\n        } else {\r\n            fuelBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n        }\r\n        \r\n        // Update the fuel value text display\r\n        if (fuelValue) {\r\n            fuelValue.textContent = `${Math.round(this.spaceship.fuel)} / ${Math.round(this.spaceship.maxFuel)}`;\r\n        }\r\n    }\r\n    \r\n    updateCargoDisplay() {\r\n        const cargoValue = document.getElementById('cargo-value-mobile');\r\n        if (!cargoValue) return;\r\n        \r\n        // Try to get resources from different possible sources\r\n        let resources = null;\r\n        let maxCargo = 1000; // Default max\r\n        \r\n        // First try to get from controls\r\n        if (this.controls && this.controls.resources) {\r\n            resources = this.controls.resources;\r\n            // Get max capacity from spaceship if available\r\n            if (this.spaceship && typeof this.spaceship.maxCargoCapacity !== 'undefined') {\r\n                maxCargo = this.spaceship.maxCargoCapacity;\r\n            }\r\n        } \r\n        // Fall back to cargo component if available\r\n        else if (this.spaceship && this.spaceship.cargoComponent && this.spaceship.cargoComponent.resources) {\r\n            resources = this.spaceship.cargoComponent.resources;\r\n            maxCargo = this.spaceship.cargoComponent.maxCapacity;\r\n        }\r\n        // Last resort - use previously defined resources structure\r\n        else if (this.spaceship && this.spaceship.resources) {\r\n            resources = this.spaceship.resources;\r\n        }\r\n        \r\n        // If no resources found, exit\r\n        if (!resources) return;\r\n        \r\n        // Calculate total cargo - ensure we're dealing with numbers\r\n        let totalCargo = 0;\r\n        \r\n        // Properly iterate through the resources object and sum numeric values\r\n        for (const key in resources) {\r\n            if (resources.hasOwnProperty(key)) {\r\n                // Get the resource amount, ensure it's a number\r\n                const amount = parseFloat(resources[key]) || 0;\r\n                totalCargo += amount;\r\n            }\r\n        }\r\n        \r\n        // Format to integer for display\r\n        totalCargo = Math.round(totalCargo);\r\n        \r\n        cargoValue.textContent = `${totalCargo} / ${maxCargo}`;\r\n        \r\n        // Change color when cargo is almost full\r\n        if (totalCargo >= maxCargo * 0.9) {\r\n            cargoValue.style.color = 'rgba(255, 80, 80, 0.9)';\r\n        } else if (totalCargo >= maxCargo * 0.7) {\r\n            cargoValue.style.color = 'rgba(255, 204, 0, 0.9)';\r\n        } else {\r\n            cargoValue.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        }\r\n    }\r\n    \r\n    updateAnomalyCount() {\r\n        const anomalyCount = document.getElementById('anomaly-count-mobile');\r\n        if (!anomalyCount) return;\r\n        \r\n        // Get anomaly count from game object if available\r\n        let count = 0;\r\n        if (window.game && window.game.environment && window.game.environment.anomalyCount) {\r\n            count = window.game.environment.anomalyCount;\r\n        }\r\n        \r\n        // Update the anomaly counter\r\n        anomalyCount.textContent = count.toString();\r\n        \r\n        // Highlight if anomalies are present\r\n        if (count > 0) {\r\n            anomalyCount.style.color = 'rgba(255, 204, 0, 0.9)';\r\n            anomalyCount.style.textShadow = '0 0 5px rgba(255, 204, 0, 0.5)';\r\n        } else {\r\n            anomalyCount.style.color = 'rgba(120, 220, 232, 0.9)';\r\n            anomalyCount.style.textShadow = 'none';\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update the horde mode indicator and timer in the mobile HUD\r\n     */\r\n    updateHordeModeDisplay() {\r\n        const hordeIndicator = document.getElementById('mobile-horde-indicator');\r\n        const hordeTimer = document.getElementById('mobile-horde-timer');\r\n        \r\n        if (!hordeIndicator || !hordeTimer) return;\r\n        \r\n        // Check if horde mode is active\r\n        if (window.game && window.game.isHordeActive) {\r\n            // Show the indicator if not already visible\r\n            if (hordeIndicator.style.display === 'none') {\r\n                hordeIndicator.style.display = 'block';\r\n                hordeIndicator.innerHTML = '<div style=\"text-align:center; color:#ff3030; font-weight:bold; margin-bottom:2px;\">HORDE MODE</div>';\r\n                hordeIndicator.appendChild(hordeTimer);\r\n            }\r\n            \r\n            // Update the timer\r\n            if (window.game.getFormattedHordeSurvivalTime) {\r\n                hordeTimer.textContent = window.game.getFormattedHordeSurvivalTime();\r\n            } else {\r\n                // Fallback calculation\r\n                const totalSeconds = Math.floor(window.game.hordeSurvivalTime / 1000);\r\n                const minutes = Math.floor(totalSeconds / 60);\r\n                const seconds = totalSeconds % 60;\r\n                hordeTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\r\n            }\r\n            \r\n            // Increase pulsing intensity after 3 minutes\r\n            if (window.game.hordeSurvivalTime > 3 * 60 * 1000) {\r\n                const styleEl = document.createElement('style');\r\n                styleEl.textContent = `\r\n                    @keyframes pulse-horde-mobile {\r\n                        0% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.7); }\r\n                        50% { box-shadow: 0 0 10px rgba(255, 30, 30, 1); }\r\n                        100% { box-shadow: 0 0 5px rgba(255, 30, 30, 0.7); }\r\n                    }\r\n                `;\r\n                document.head.appendChild(styleEl);\r\n                \r\n                // Make animation faster\r\n                hordeIndicator.style.animation = 'pulse-horde-mobile 0.8s infinite';\r\n                hordeIndicator.style.backgroundColor = 'rgba(255, 30, 30, 0.3)';\r\n            }\r\n        } else {\r\n            // Hide the indicator\r\n            hordeIndicator.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        const container = document.getElementById('mobile-hud-container');\r\n        if (container) {\r\n            container.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    show() {\r\n        // Check if intro sequence is active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            console.log(\"MobileHUD: Not showing HUD during intro sequence\");\r\n            return; // Don't show during intro\r\n        }\r\n        \r\n        const container = document.getElementById('mobile-hud-container');\r\n        if (container) {\r\n            container.style.display = 'block';\r\n        }\r\n    }\r\n    \r\n    // Add method to set controls reference\r\n    setControls(controls) {\r\n        console.log(\"MobileHUD: Setting controls reference\");\r\n        this.controls = controls;\r\n    }\r\n\r\n    // Update to handle system name and anomaly count in a simpler way\r\n    updateLocation(locationName, systemName = 'Unknown System') {\r\n        // Since we no longer show system name, we just need to update anomaly count\r\n        this.updateAnomalyCount();\r\n    }\r\n} ","// miningDisplay.js - Handles the mining UI and resource display\r\n\r\nexport class MiningDisplay {\r\n    constructor() {\r\n        this.controls = null; // Will be set later\r\n        this.setupMiningDisplay();\r\n    }\r\n    \r\n    setControls(controls) {\r\n        this.controls = controls;\r\n    }\r\n    \r\n    setupMiningDisplay() {\r\n        // Create only the target info display for when targeting asteroids\r\n        const targetInfo = document.createElement('div');\r\n        targetInfo.id = 'target-info';\r\n        targetInfo.style.position = 'absolute';\r\n        targetInfo.style.bottom = '120px';\r\n        targetInfo.style.left = '50%';\r\n        targetInfo.style.transform = 'translateX(-50%)';\r\n        targetInfo.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\r\n        targetInfo.style.padding = '10px 20px';\r\n        targetInfo.style.borderRadius = '20px';\r\n        targetInfo.style.border = '1px solid #30cfd0';\r\n        targetInfo.style.boxShadow = '0 0 10px #30cfd0';\r\n        targetInfo.style.display = 'none';\r\n        targetInfo.style.textAlign = 'center';\r\n        document.body.appendChild(targetInfo);\r\n        \r\n        // Target name\r\n        const targetName = document.createElement('div');\r\n        targetName.id = 'target-name';\r\n        targetName.textContent = 'Asteroid';\r\n        targetInfo.appendChild(targetName);\r\n        \r\n        // Target distance\r\n        const targetDistance = document.createElement('div');\r\n        targetDistance.id = 'target-distance';\r\n        targetDistance.textContent = 'Distance: 0 units';\r\n        targetInfo.appendChild(targetDistance);\r\n        \r\n        // Add estimated mining time display\r\n        const miningTime = document.createElement('div');\r\n        miningTime.id = 'mining-time';\r\n        miningTime.textContent = 'Mining time: calculating...';\r\n        miningTime.style.color = '#ffcc00';\r\n        targetInfo.appendChild(miningTime);\r\n    }\r\n    \r\n    update() {\r\n        // Update the HUD resource counters in the top right with our resource values\r\n        if (this.controls && this.controls.resources) {\r\n            const ironAmount = document.getElementById('iron-amount');\r\n            const goldAmount = document.getElementById('gold-amount');\r\n            const platinumAmount = document.getElementById('platinum-amount');\r\n            const cargoCapacity = document.getElementById('cargo-capacity');\r\n            const capacityBar = document.getElementById('capacity-bar');\r\n            \r\n            if (ironAmount) ironAmount.textContent = this.controls.resources.iron || 0;\r\n            if (goldAmount) goldAmount.textContent = this.controls.resources.gold || 0;\r\n            if (platinumAmount) platinumAmount.textContent = this.controls.resources.platinum || 0;\r\n            \r\n            // Update cargo capacity\r\n            if (cargoCapacity && capacityBar && this.controls.spaceship) {\r\n                const totalResources = \r\n                    (this.controls.resources.iron || 0) + \r\n                    (this.controls.resources.gold || 0) + \r\n                    (this.controls.resources.platinum || 0);\r\n                const maxCapacity = this.controls.spaceship.maxCargoCapacity || 1000;\r\n                const capacityPercentage = (totalResources / maxCapacity) * 100;\r\n                \r\n                cargoCapacity.textContent = `${totalResources} / ${maxCapacity}`;\r\n                capacityBar.style.width = `${capacityPercentage}%`;\r\n                \r\n                // Change color when near capacity\r\n                if (capacityPercentage > 90) {\r\n                    capacityBar.style.backgroundColor = 'rgba(255, 80, 80, 0.8)';\r\n                } else if (capacityPercentage > 75) {\r\n                    capacityBar.style.backgroundColor = 'rgba(255, 204, 0, 0.8)';\r\n                } else {\r\n                    capacityBar.style.backgroundColor = 'rgba(120, 220, 232, 0.8)';\r\n                }\r\n            }\r\n            \r\n            // Update mining time estimate if targeting an asteroid\r\n            this.updateMiningTimeEstimate();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update the mining time estimate based on the targeted asteroid type and mining efficiency\r\n     */\r\n    updateMiningTimeEstimate() {\r\n        const miningTimeElement = document.getElementById('mining-time');\r\n        if (!miningTimeElement || !this.controls || !this.controls.miningSystem) return;\r\n        \r\n        const miningSystem = this.controls.miningSystem;\r\n        if (miningSystem.targetAsteroid && miningSystem.targetAsteroid.resourceType) {\r\n            const resourceType = miningSystem.targetAsteroid.resourceType.toLowerCase();\r\n            const efficiency = miningSystem.getMiningEfficiency();\r\n            const secondsRequired = Math.round(1 / (miningSystem.miningSpeedByType[resourceType] * efficiency));\r\n            \r\n            miningTimeElement.textContent = `Mining time: ${secondsRequired} seconds`;\r\n            miningTimeElement.style.display = 'block';\r\n            \r\n            // Color based on resource value\r\n            if (resourceType === 'platinum') {\r\n                miningTimeElement.style.color = '#66ffff';\r\n            } else if (resourceType === 'gold') {\r\n                miningTimeElement.style.color = '#ffcc00';\r\n            } else {\r\n                miningTimeElement.style.color = '#a0a0a0';\r\n            }\r\n        } else {\r\n            miningTimeElement.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        // Hide target info\r\n        const targetInfo = document.getElementById('target-info');\r\n        if (targetInfo) {\r\n            targetInfo.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    show() {\r\n        // Show target info if needed\r\n        // In this implementation, the target info is shown directly by the targeting system\r\n    }\r\n}","// targetingUI.js - Handles the targeting UI components\r\n\r\nexport class TargetingUI {\r\n    constructor() {\r\n        this.setupTargetingUI();\r\n    }\r\n    \r\n    setupTargetingUI() {\r\n        // Create lock-on display\r\n        const lockOnDisplay = document.createElement('div');\r\n        lockOnDisplay.id = 'lock-on-display';\r\n        lockOnDisplay.style.position = 'absolute';\r\n        lockOnDisplay.style.top = '50%';\r\n        lockOnDisplay.style.left = '50%';\r\n        lockOnDisplay.style.width = '150px';\r\n        lockOnDisplay.style.height = '150px';\r\n        lockOnDisplay.style.transform = 'translate(-50%, -50%)';\r\n        lockOnDisplay.style.border = '2px dashed #ff0000';\r\n        lockOnDisplay.style.borderRadius = '50%';\r\n        lockOnDisplay.style.boxSizing = 'border-box';\r\n        lockOnDisplay.style.display = 'none';\r\n        lockOnDisplay.style.zIndex = '997';\r\n        lockOnDisplay.style.pointerEvents = 'none';\r\n        document.body.appendChild(lockOnDisplay);\r\n        \r\n        // Add diagonal lines for better targeting visual\r\n        const diagonalLines = document.createElement('div');\r\n        diagonalLines.style.position = 'absolute';\r\n        diagonalLines.style.width = '100%';\r\n        diagonalLines.style.height = '100%';\r\n        diagonalLines.style.top = '0';\r\n        diagonalLines.style.left = '0';\r\n        diagonalLines.innerHTML = `\r\n            <div style=\"position: absolute; width: 2px; height: 30px; background-color: #ff0000; top: 0; left: 50%; transform: translateX(-50%);\"></div>\r\n            <div style=\"position: absolute; width: 2px; height: 30px; background-color: #ff0000; bottom: 0; left: 50%; transform: translateX(-50%);\"></div>\r\n            <div style=\"position: absolute; width: 30px; height: 2px; background-color: #ff0000; left: 0; top: 50%; transform: translateY(-50%);\"></div>\r\n            <div style=\"position: absolute; width: 30px; height: 2px; background-color: #ff0000; right: 0; top: 50%; transform: translateY(-50%);\"></div>\r\n        `;\r\n        lockOnDisplay.appendChild(diagonalLines);\r\n        \r\n        // Create target indicator for lock-on \r\n        const targetIndicator = document.createElement('div');\r\n        targetIndicator.id = 'target-indicator';\r\n        targetIndicator.style.position = 'absolute';\r\n        targetIndicator.style.bottom = '120px';\r\n        targetIndicator.style.left = '50%';\r\n        targetIndicator.style.transform = 'translateX(-50%)';\r\n        targetIndicator.style.width = '200px';\r\n        targetIndicator.style.textAlign = 'center';\r\n        targetIndicator.style.backgroundColor = 'rgba(255, 50, 50, 0.4)';\r\n        targetIndicator.style.border = '1px solid #ff3030';\r\n        targetIndicator.style.borderRadius = '10px';\r\n        targetIndicator.style.padding = '8px';\r\n        targetIndicator.style.color = '#ffffff';\r\n        targetIndicator.style.fontFamily = 'monospace';\r\n        targetIndicator.style.zIndex = '100';\r\n        targetIndicator.style.display = 'none';\r\n        targetIndicator.style.boxShadow = '0 0 10px #ff3030';\r\n        \r\n        // Add targeting information\r\n        targetIndicator.innerHTML = `\r\n            <div style=\"font-weight: bold; margin-bottom: 5px;\">◎ TARGET LOCKED ◎</div>\r\n            <div id=\"target-type\">Asteroid</div>\r\n            <div id=\"target-distance\">Distance: 0 units</div>\r\n            <div id=\"target-resource\" style=\"color: #ffcc00;\">Resource: Unknown</div>\r\n        `;\r\n        \r\n        document.body.appendChild(targetIndicator);\r\n    }\r\n    \r\n    showLockOn() {\r\n        const lockOnDisplay = document.getElementById('lock-on-display');\r\n        if (lockOnDisplay) {\r\n            lockOnDisplay.style.display = 'block';\r\n        }\r\n    }\r\n    \r\n    hideLockOn() {\r\n        const lockOnDisplay = document.getElementById('lock-on-display');\r\n        if (lockOnDisplay) {\r\n            lockOnDisplay.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    updateTargetInfo(targetType, distance, resourceType) {\r\n        const targetIndicator = document.getElementById('target-indicator');\r\n        const targetTypeElement = document.getElementById('target-type');\r\n        const targetDistanceElement = document.getElementById('target-distance');\r\n        const targetResourceElement = document.getElementById('target-resource');\r\n        \r\n        if (targetIndicator && targetTypeElement && targetDistanceElement) {\r\n            // Show the target indicator\r\n            targetIndicator.style.display = 'block';\r\n            \r\n            // Update the target information\r\n            targetTypeElement.textContent = `${targetType}`;\r\n            targetDistanceElement.textContent = `Distance: ${Math.round(distance)} units`;\r\n            \r\n            // Set resource info with proper coloring based on type\r\n            if (targetResourceElement && resourceType) {\r\n                let resourceColor = '#cccccc'; // Default color\r\n                \r\n                // Set color based on resource type\r\n                if (resourceType.toLowerCase() === 'iron') {\r\n                    resourceColor = '#cccccc';\r\n                } else if (resourceType.toLowerCase() === 'gold') {\r\n                    resourceColor = '#ffcc00';\r\n                } else if (resourceType.toLowerCase() === 'platinum') {\r\n                    resourceColor = '#66ffff';\r\n                }\r\n                \r\n                targetResourceElement.textContent = `Resource: ${resourceType}`;\r\n                targetResourceElement.style.color = resourceColor;\r\n            }\r\n            \r\n            // Add pulse animation effect\r\n            this.addPulseEffect(targetIndicator);\r\n        }\r\n    }\r\n    \r\n    // Add a subtle pulse animation to the target indicator\r\n    addPulseEffect(element) {\r\n        // Remove any existing animation\r\n        element.style.animation = 'none';\r\n        \r\n        // Force reflow\r\n        void element.offsetWidth;\r\n        \r\n        // Add pulse animation\r\n        element.style.animation = 'targetPulse 2s infinite';\r\n        \r\n        // Add CSS keyframes if not already present\r\n        if (!document.getElementById('targeting-keyframes')) {\r\n            const style = document.createElement('style');\r\n            style.id = 'targeting-keyframes';\r\n            style.textContent = `\r\n                @keyframes targetPulse {\r\n                    0% { box-shadow: 0 0 10px #ff3030; }\r\n                    50% { box-shadow: 0 0 20px #ff3030; }\r\n                    100% { box-shadow: 0 0 10px #ff3030; }\r\n                }\r\n            `;\r\n            document.head.appendChild(style);\r\n        }\r\n    }\r\n    \r\n    hideTargetInfo() {\r\n        const targetIndicator = document.getElementById('target-indicator');\r\n        if (targetIndicator) {\r\n            targetIndicator.style.display = 'none';\r\n        }\r\n    }\r\n} ","// stargateInterface.js - Handles the stargate docking and trading UI\r\n\r\nimport { MobileDetector } from '../../utils/mobileDetector.js';\r\n\r\nexport class StargateInterface {\r\n    constructor() {\r\n        this.starMap = null;\r\n        this.blackjackGame = null;\r\n        this.settings = null;\r\n        this.isMobile = MobileDetector.isMobile();\r\n        this.setupStargateUI();\r\n        this.setupEventHandlers();\r\n    }\r\n    \r\n    setStarMap(starMap) {\r\n        this.starMap = starMap;\r\n    }\r\n    \r\n    setBlackjackGame(blackjackGame) {\r\n        this.blackjackGame = blackjackGame;\r\n    }\r\n    \r\n    setSettings(settings) {\r\n        this.settings = settings;\r\n        \r\n        // Pass the stargate interface reference to settings\r\n        if (this.settings) {\r\n            this.settings.setStargateInterface(this);\r\n        }\r\n        \r\n        // Setup settings button handler now that we have settings\r\n        this.setupSettingsButton();\r\n    }\r\n    \r\n    setupStargateUI() {\r\n        // Add CSS for animations\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            @keyframes pulse-warning {\r\n                0% { box-shadow: 0 0 15px rgba(255, 48, 48, 0.5); }\r\n                50% { box-shadow: 0 0 25px rgba(255, 48, 48, 0.8); }\r\n                100% { box-shadow: 0 0 15px rgba(255, 48, 48, 0.5); }\r\n            }\r\n            \r\n            /* Stargate Terminal Styles */\r\n            #stargate-ui {\r\n                --primary-bg: rgba(20, 30, 50, 0.9);\r\n                --primary-border: #33aaff;\r\n                --section-bg: rgba(10, 20, 35, 0.8);\r\n                --accent-blue: #33aaff;\r\n                --accent-green: #00cc33;\r\n                --accent-orange: #ff9900;\r\n                --accent-red: #ff3030;\r\n                --accent-purple: #9933cc;\r\n                --accent-cyan: #30cfd0;\r\n                \r\n                position: absolute;\r\n                top: 50%;\r\n                left: 50%;\r\n                transform: translate(-50%, -50%);\r\n                width: 80%;\r\n                max-width: 1000px;\r\n                max-height: 90vh;\r\n                background-color: var(--primary-bg);\r\n                color: #fff;\r\n                border-radius: 15px;\r\n                border: 2px solid var(--primary-border);\r\n                box-shadow: 0 0 30px var(--primary-border);\r\n                font-family: 'Courier New', monospace;\r\n                z-index: 1000;\r\n                display: none;\r\n                overflow-y: auto;\r\n                overflow-x: hidden;\r\n                padding: 0;\r\n            }\r\n            \r\n            #stargate-header {\r\n                background-color: rgba(30, 40, 60, 0.9);\r\n                padding: 15px 20px;\r\n                border-bottom: 1px solid var(--primary-border);\r\n                position: sticky;\r\n                top: 0;\r\n                z-index: 10;\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n            }\r\n            \r\n            #stargate-content {\r\n                display: grid;\r\n                grid-template-columns: 1fr 1fr 1fr;\r\n                gap: 20px;\r\n                padding: 20px;\r\n            }\r\n            \r\n            .stargate-section {\r\n                background-color: var(--section-bg);\r\n                border-radius: 10px;\r\n                padding: 15px;\r\n                border: 1px solid rgba(51, 170, 255, 0.3);\r\n            }\r\n            \r\n            .stargate-section h3 {\r\n                color: var(--accent-blue);\r\n                margin-top: 0;\r\n                margin-bottom: 15px;\r\n                padding-bottom: 8px;\r\n                border-bottom: 1px solid rgba(51, 170, 255, 0.3);\r\n                font-size: 1.2em;\r\n            }\r\n            \r\n            /* Ship Status Section */\r\n            #ship-status-section {\r\n                grid-column: 1;\r\n                display: flex;\r\n                flex-direction: column;\r\n                gap: 15px;\r\n            }\r\n            \r\n            .resources-container {\r\n                display: flex;\r\n                gap: 5px;\r\n                margin-bottom: 10px;\r\n            }\r\n            \r\n            .resource-display {\r\n                flex: 1;\r\n                padding: 8px;\r\n                background-color: rgba(15, 40, 55, 0.8);\r\n                border-radius: 5px;\r\n                text-align: center;\r\n            }\r\n            \r\n            .status-bar-container {\r\n                width: 100%;\r\n                height: 15px;\r\n                background-color: #222;\r\n                border-radius: 10px;\r\n                overflow: hidden;\r\n                margin-bottom: 5px;\r\n            }\r\n            \r\n            .status-bar {\r\n                height: 100%;\r\n                border-radius: 10px;\r\n            }\r\n            \r\n            .status-label {\r\n                display: flex;\r\n                justify-content: space-between;\r\n                margin-bottom: 5px;\r\n                font-size: 0.9em;\r\n            }\r\n            \r\n            /* Market Section */\r\n            #market-section {\r\n                grid-column: 2;\r\n                grid-row: 1 ;\r\n            }\r\n            \r\n            .sell-buttons {\r\n                display: grid;\r\n                grid-template-columns: 1fr 1fr 1fr;\r\n                gap: 5px;\r\n                margin-bottom: 15px;\r\n            }\r\n            \r\n            .sell-btn {\r\n                padding: 10px;\r\n                background-color: rgba(15, 40, 55, 0.8);\r\n                color: #fff;\r\n                border-radius: 5px;\r\n                cursor: pointer;\r\n                text-align: center;\r\n                transition: all 0.2s;\r\n                border: none;\r\n                font-family: 'Courier New', monospace;\r\n            }\r\n            \r\n            .orb-buttons {\r\n                display: grid;\r\n                grid-template-columns: 1fr 1fr;\r\n                gap: 8px;\r\n            }\r\n            \r\n            /* Upgrades Section */\r\n            #upgrades-section {\r\n                grid-column: 3;\r\n                grid-row: 1;\r\n            }\r\n            \r\n            .upgrade-item {\r\n                margin-bottom: 15px;\r\n                border: 1px solid rgba(85, 85, 85, 0.5);\r\n                border-radius: 8px;\r\n                padding: 12px;\r\n                background-color: rgba(0, 0, 0, 0.3);\r\n            }\r\n            \r\n            .upgrade-header {\r\n                display: flex;\r\n                justify-content: space-between;\r\n                align-items: center;\r\n                margin-bottom: 10px;\r\n            }\r\n            \r\n            .upgrade-progress {\r\n                position: relative;\r\n                height: 8px;\r\n                background-color: #333;\r\n                border-radius: 4px;\r\n                margin-bottom: 12px;\r\n            }\r\n            \r\n            .upgrade-progress-bar {\r\n                position: absolute;\r\n                top: 0;\r\n                left: 0;\r\n                height: 100%;\r\n                width: 20%;\r\n                border-radius: 4px;\r\n            }\r\n            \r\n            .upgrade-footer {\r\n                display: flex;\r\n                justify-content: space-between;\r\n                align-items: center;\r\n            }\r\n            \r\n            .upgrade-description {\r\n                flex: 2;\r\n                padding-right: 10px;\r\n                font-size: 0.85em;\r\n                opacity: 0.8;\r\n            }\r\n            \r\n            /* Features Section */\r\n            #features-section {\r\n                grid-column: 1 / span 2;\r\n                grid-row: 2;\r\n            }\r\n            \r\n            .feature-buttons {\r\n                display: grid;\r\n                grid-template-columns: 1fr 1fr;\r\n                gap: 15px;\r\n            }\r\n            \r\n            .feature-btn {\r\n                padding: 15px;\r\n                border: none;\r\n                border-radius: 5px;\r\n                cursor: pointer;\r\n                font-family: 'Courier New', monospace;\r\n                font-weight: bold;\r\n                font-size: 16px;\r\n                color: #fff;\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                justify-content: center;\r\n                min-height: 80px;\r\n            }\r\n            \r\n            .feature-btn small {\r\n                font-size: 0.8em;\r\n                opacity: 0.8;\r\n                margin-top: 5px;\r\n            }\r\n            \r\n            /* Challenge Section */\r\n            #challenge-section {\r\n                border-color: rgba(255, 48, 48, 0.5);\r\n            }\r\n            \r\n            #challenge-section h3 {\r\n                color: var(--accent-red);\r\n                border-color: rgba(255, 48, 48, 0.3);\r\n            }\r\n            \r\n            /* Footer */\r\n            #stargate-footer {\r\n                padding: 20px;\r\n                border-top: 1px solid rgba(51, 170, 255, 0.3);\r\n                text-align: center;\r\n            }\r\n            \r\n            /* Common Button Styles */\r\n            .action-btn {\r\n                width: 100%;\r\n                padding: 10px;\r\n                border: none;\r\n                border-radius: 5px;\r\n                cursor: pointer;\r\n                font-family: 'Courier New', monospace;\r\n                font-weight: bold;\r\n                color: #000;\r\n                margin-top: 5px;\r\n            }\r\n            \r\n            /* Custom colors for buttons */\r\n            .btn-fuel { background-color: var(--accent-green); }\r\n            .btn-shield { background-color: var(--accent-blue); }\r\n            .btn-hull { background-color: var(--accent-orange); }\r\n            .btn-starmap { background-color: var(--accent-cyan); }\r\n            .btn-blackjack { background-color: var(--accent-purple); }\r\n            .btn-settings { background-color: var(--accent-blue); }\r\n            .btn-horde { \r\n                background: linear-gradient(135deg, #990000 0%, var(--accent-red) 100%);\r\n                color: #fff;\r\n                border: 2px solid var(--accent-red);\r\n                box-shadow: 0 0 15px rgba(255, 48, 48, 0.5);\r\n                animation: pulse-warning 2s infinite;\r\n            }\r\n            .btn-undock {\r\n                background: linear-gradient(135deg, #00a8ff 0%, #0066cc 100%);\r\n                font-size: 1.4em;\r\n                font-weight: bold;\r\n                letter-spacing: 3px;\r\n                padding: 16px 40px;\r\n                width: auto;\r\n                min-width: 200px;\r\n                margin-bottom: 15px;\r\n                border: 2px solid #00d4ff;\r\n                box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), inset 0 0 20px rgba(0, 168, 255, 0.2);\r\n                text-transform: uppercase;\r\n                position: relative;\r\n                overflow: hidden;\r\n                transition: all 0.3s ease;\r\n            }\r\n            \r\n            .btn-undock:hover {\r\n                background: linear-gradient(135deg, #00d4ff 0%, #0088ff 100%);\r\n                box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), inset 0 0 20px rgba(0, 212, 255, 0.3);\r\n                transform: translateY(-2px);\r\n            }\r\n            \r\n            .btn-undock:active {\r\n                transform: translateY(0);\r\n            }\r\n            \r\n            .btn-undock::before {\r\n                content: '';\r\n                position: absolute;\r\n                top: -2px;\r\n                left: -2px;\r\n                right: -2px;\r\n                bottom: -2px;\r\n                background: linear-gradient(45deg, transparent, #00d4ff, transparent);\r\n                z-index: -1;\r\n                opacity: 0;\r\n                transition: opacity 0.3s;\r\n                animation: pulse-glow 2s infinite;\r\n            }\r\n            \r\n            .btn-undock:hover::before {\r\n                opacity: 1;\r\n            }\r\n            \r\n            @keyframes pulse-glow {\r\n                0%, 100% { opacity: 0.5; }\r\n                50% { opacity: 1; }\r\n            }\r\n            \r\n            .iron-border { border: 1px solid #cc6633; box-shadow: 0 0 10px rgba(204, 102, 51, 0.3); }\r\n            .gold-border { border: 1px solid #ffcc33; box-shadow: 0 0 10px rgba(255, 204, 51, 0.3); }\r\n            .platinum-border { border: 1px solid #33ccff; box-shadow: 0 0 10px rgba(51, 204, 255, 0.3); }\r\n            .common-border { border: 1px solid #00ff66; box-shadow: 0 0 10px rgba(0, 255, 102, 0.3); }\r\n            .uncommon-border { border: 1px solid #0066ff; box-shadow: 0 0 10px rgba(0, 102, 255, 0.3); }\r\n            .rare-border { border: 1px solid #9900ff; box-shadow: 0 0 10px rgba(153, 0, 255, 0.3); }\r\n            .epic-border { border: 1px solid #ff6600; box-shadow: 0 0 10px rgba(255, 102, 0, 0.3); }\r\n            .legendary-border { border: 1px solid #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); }\r\n            \r\n            /* Mobile Responsiveness */\r\n            @media (max-width: 900px) {\r\n                #stargate-ui {\r\n                    width: 95%;\r\n                    max-width: 95vw;\r\n                    max-height: 85vh;\r\n                    border-radius: 10px;\r\n                }\r\n                \r\n                #stargate-content {\r\n                    grid-template-columns: 1fr;\r\n                    gap: 15px;\r\n                    padding: 15px;\r\n                }\r\n                \r\n                #ship-status-section,\r\n                #market-section,\r\n                #upgrades-section,\r\n                #features-section {\r\n                    grid-column: 1;\r\n                }\r\n                \r\n                .feature-buttons {\r\n                    grid-template-columns: 1fr;\r\n                }\r\n                \r\n                .sell-buttons {\r\n                    grid-template-columns: 1fr 1fr;\r\n                }\r\n                \r\n                .action-btn {\r\n                    padding: 12px;\r\n                    min-height: 44px;\r\n                }\r\n                \r\n                .upgrade-footer {\r\n                    flex-direction: column;\r\n                    align-items: stretch;\r\n                }\r\n                \r\n                .upgrade-description {\r\n                    margin-bottom: 10px;\r\n                }\r\n            }\r\n            \r\n            #horde-confirm-modal {\r\n                position: fixed;\r\n                top: 0;\r\n                left: 0;\r\n                width: 100%;\r\n                height: 100%;\r\n                background-color: rgba(0, 0, 0, 0.8);\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                z-index: 2000;\r\n            }\r\n            \r\n            #horde-confirm-content {\r\n                background-color: rgba(30, 30, 35, 0.95);\r\n                border: 2px solid #ff3030;\r\n                border-radius: 10px;\r\n                padding: 30px;\r\n                max-width: 500px;\r\n                width: 80%;\r\n                color: #fff;\r\n                box-shadow: 0 0 30px rgba(255, 48, 48, 0.7);\r\n                text-align: center;\r\n            }\r\n            \r\n            .horde-confirm-title {\r\n                color: #ff3030;\r\n                font-size: 24px;\r\n                margin-bottom: 20px;\r\n                font-weight: bold;\r\n                text-shadow: 0 0 10px rgba(255, 48, 48, 0.5);\r\n            }\r\n            \r\n            .horde-confirm-text {\r\n                margin-bottom: 25px;\r\n                line-height: 1.5;\r\n            }\r\n            \r\n            .horde-confirm-buttons {\r\n                display: flex;\r\n                justify-content: space-between;\r\n            }\r\n            \r\n            .horde-confirm-btn {\r\n                padding: 12px 25px;\r\n                border-radius: 5px;\r\n                border: none;\r\n                font-family: 'Courier New', monospace;\r\n                font-weight: bold;\r\n                cursor: pointer;\r\n                width: 45%;\r\n            }\r\n            \r\n            .horde-confirm-yes {\r\n                background-color: #ff3030;\r\n                color: #fff;\r\n            }\r\n            \r\n            .horde-confirm-no {\r\n                background-color: #333;\r\n                color: #fff;\r\n            }\r\n        `;\r\n        document.head.appendChild(style);\r\n        \r\n        // Add docking prompt\r\n        const dockingPrompt = document.createElement('div');\r\n        dockingPrompt.id = 'docking-prompt';\r\n        dockingPrompt.style.position = 'absolute';\r\n        dockingPrompt.style.top = '50%';\r\n        dockingPrompt.style.left = '50%';\r\n        dockingPrompt.style.transform = 'translate(-50%, -50%)';\r\n        dockingPrompt.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';\r\n        dockingPrompt.style.color = '#33aaff';\r\n        dockingPrompt.style.padding = '20px';\r\n        dockingPrompt.style.borderRadius = '10px';\r\n        dockingPrompt.style.border = '2px solid #33aaff';\r\n        dockingPrompt.style.boxShadow = '0 0 20px #33aaff';\r\n        dockingPrompt.style.fontFamily = 'Courier New, monospace';\r\n        dockingPrompt.style.fontSize = '18px';\r\n        dockingPrompt.style.textAlign = 'center';\r\n        dockingPrompt.style.zIndex = '1000';\r\n        dockingPrompt.style.display = 'none';\r\n        \r\n        // Update prompt text based on device - on mobile, we don't need this prompt\r\n        // since we have an actual interactive DOCK button\r\n        if (this.isMobile) {\r\n            // On mobile, we'll hide this text prompt completely since we have a dedicated dock button\r\n            dockingPrompt.style.display = 'none';\r\n            dockingPrompt.dataset.alwaysHide = 'true'; // Mark to keep it hidden\r\n        } else {\r\n            dockingPrompt.textContent = 'Press Q to dock with Stargate';\r\n        }\r\n        \r\n        document.body.appendChild(dockingPrompt);\r\n        \r\n        // Create stargate interface (hidden by default)\r\n        const stargateUI = document.createElement('div');\r\n        stargateUI.id = 'stargate-ui';\r\n        \r\n        // Use responsive width based on device type\r\n        if (this.isMobile) {\r\n            stargateUI.style.width = '95%';\r\n            stargateUI.style.maxWidth = '95vw';\r\n            \r\n            // Add touch scrolling properties for mobile\r\n            stargateUI.style.webkitOverflowScrolling = 'touch';\r\n            stargateUI.style.touchAction = 'pan-y';\r\n            stargateUI.style.overscrollBehavior = 'contain';\r\n        }\r\n        \r\n        // Create the improved stargate UI structure\r\n        stargateUI.innerHTML = `\r\n            <!-- Header -->\r\n            <div id=\"stargate-header\">\r\n                <button id=\"undock-btn\" class=\"action-btn btn-undock\" data-no-touch-overlay=\"true\">\r\n                    <span class=\"undock-text\">◆ UNDOCK ◆</span>\r\n                </button>\r\n                <h2 style=\"text-align: center; color: #33aaff; margin: 0;\">STARGATE TERMINAL</h2>\r\n            </div>\r\n            \r\n            <!-- Main Content Grid -->\r\n            <div id=\"stargate-content\">\r\n                <!-- Ship Status Section -->\r\n                <div id=\"ship-status-section\" class=\"stargate-section\">\r\n                    <h3>SHIP STATUS</h3>\r\n                    \r\n                    <!-- Resources section -->\r\n                    <div>\r\n                        <h4 style=\"color: #33aaff; margin-top: 0; margin-bottom: 10px;\">RESOURCES</h4>\r\n                        <div class=\"resources-container\">\r\n                            <div class=\"resource-display iron-border\">\r\n                                <div style=\"font-weight: bold; font-size: 14px;\">IRON</div>\r\n                                <div id=\"ms-iron\" style=\"font-size: 18px; margin-top: 5px;\">0</div>\r\n                                <div style=\"font-size: 10px; opacity: 0.7;\">UNITS</div>\r\n                            </div>\r\n                            <div class=\"resource-display gold-border\">\r\n                                <div style=\"font-weight: bold; font-size: 14px;\">GOLD</div>\r\n                                <div id=\"ms-gold\" style=\"font-size: 18px; margin-top: 5px;\">0</div>\r\n                                <div style=\"font-size: 10px; opacity: 0.7;\">UNITS</div>\r\n                            </div>\r\n                            <div class=\"resource-display platinum-border\">\r\n                                <div style=\"font-weight: bold; font-size: 14px;\">PLATINUM</div>\r\n                                <div id=\"ms-platinum\" style=\"font-size: 18px; margin-top: 5px;\">0</div>\r\n                                <div style=\"font-size: 10px; opacity: 0.7;\">UNITS</div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <div style=\"margin-top: 15px;\">\r\n                            <h4 style=\"color: #33aaff; margin-top: 0; margin-bottom: 10px;\">CREDITS</h4>\r\n                            <div id=\"ms-credits\" style=\"font-size: 18px; font-weight: bold; color: #ffcc33; text-shadow: 0 0 5px rgba(255, 204, 51, 0.5);\">0 CR</div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Fuel section -->\r\n                    <div>\r\n                        <div class=\"status-label\">\r\n                            <h4 style=\"color: #00cc33; margin: 0;\">FUEL</h4>\r\n                            <span><span id=\"fuel-level\">100</span>%</span>\r\n                        </div>\r\n                        <div class=\"status-bar-container\" id=\"fuel-gauge-container\">\r\n                            <div class=\"status-bar\" id=\"fuel-gauge\" style=\"background-color: #00cc33; width: 100%;\"></div>\r\n                        </div>\r\n                        <button id=\"refuel-btn\" class=\"action-btn btn-fuel\">REFUEL (100 CR)</button>\r\n                    </div>\r\n                    \r\n                    <!-- Shield section -->\r\n                    <div>\r\n                        <div class=\"status-label\">\r\n                            <h4 style=\"color: #3399ff; margin: 0;\">SHIELD</h4>\r\n                            <span><span id=\"shield-level\">100</span>%</span>\r\n                        </div>\r\n                        <div class=\"status-bar-container\" id=\"shield-gauge-container\">\r\n                            <div class=\"status-bar\" id=\"shield-gauge\" style=\"background-color: #3399ff; width: 100%;\"></div>\r\n                        </div>\r\n                        <button id=\"repair-shield-btn\" class=\"action-btn btn-shield\">REPAIR SHIELD (150 CR)</button>\r\n                    </div>\r\n                    \r\n                    <!-- Hull section -->\r\n                    <div>\r\n                        <div class=\"status-label\">\r\n                            <h4 style=\"color: #ff9900; margin: 0;\">HULL INTEGRITY</h4>\r\n                            <span><span id=\"hull-level\">100</span>%</span>\r\n                        </div>\r\n                        <div class=\"status-bar-container\" id=\"hull-gauge-container\">\r\n                            <div class=\"status-bar\" id=\"hull-gauge\" style=\"background-color: #ff9900; width: 100%;\"></div>\r\n                        </div>\r\n                        <button id=\"repair-hull-btn\" class=\"action-btn btn-hull\">REPAIR HULL (200 CR)</button>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Market Section (Now spans 2 rows) -->\r\n                <div id=\"market-section\" class=\"stargate-section\">\r\n                    <h3>MARKET</h3>\r\n                    \r\n                    <!-- Resources Market -->\r\n                    <h4 style=\"color: #33aaff; margin-top: 0; margin-bottom: 10px;\">MATERIALS</h4>\r\n                    <div class=\"sell-buttons\">\r\n                        <button id=\"sell-iron\" class=\"sell-btn iron-border\">\r\n                            <div style=\"font-weight: bold;\">SELL IRON</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(10 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-gold\" class=\"sell-btn gold-border\">\r\n                            <div style=\"font-weight: bold;\">SELL GOLD</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(50 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-platinum\" class=\"sell-btn platinum-border\">\r\n                            <div style=\"font-weight: bold;\">SELL PLATINUM</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(200 CR each)</div>\r\n                        </button>\r\n                    </div>\r\n                    \r\n                    <!-- Energy Orbs Market -->\r\n                    <h4 style=\"color: #33aaff; margin-top: 20px; margin-bottom: 10px;\">ENERGY ORBS</h4>\r\n                    <div style=\"font-size: 14px; color: #aaa; margin-bottom: 10px;\">\r\n                        Valuable artifacts collected from space anomalies. Increasing rarity yields higher value.\r\n                    </div>\r\n                    \r\n                    <div class=\"orb-buttons\">\r\n                        <button id=\"sell-orb-common\" class=\"sell-btn common-border\">\r\n                            <div style=\"font-weight: bold;\">COMMON ORB</div>\r\n                            <div id=\"orb-common-count\" style=\"font-size: 12px;\">0 in inventory</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(100 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-orb-uncommon\" class=\"sell-btn uncommon-border\">\r\n                            <div style=\"font-weight: bold;\">UNCOMMON ORB</div>\r\n                            <div id=\"orb-uncommon-count\" style=\"font-size: 12px;\">0 in inventory</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(500 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-orb-rare\" class=\"sell-btn rare-border\">\r\n                            <div style=\"font-weight: bold;\">RARE ORB</div>\r\n                            <div id=\"orb-rare-count\" style=\"font-size: 12px;\">0 in inventory</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(1,500 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-orb-epic\" class=\"sell-btn epic-border\">\r\n                            <div style=\"font-weight: bold;\">EPIC ORB</div>\r\n                            <div id=\"orb-epic-count\" style=\"font-size: 12px;\">0 in inventory</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(5,000 CR each)</div>\r\n                        </button>\r\n                        <button id=\"sell-orb-legendary\" class=\"sell-btn legendary-border\">\r\n                            <div style=\"font-weight: bold;\">LEGENDARY ORB</div>\r\n                            <div id=\"orb-legendary-count\" style=\"font-size: 12px;\">0 in inventory</div>\r\n                            <div style=\"font-size: 12px; margin-top: 3px;\">(15,000 CR each)</div>\r\n                        </button>\r\n                    </div>\r\n                    \r\n                    <!-- Deployable Weapons Section -->\r\n                    <h4 style=\"color: #33aaff; margin-top: 20px; margin-bottom: 10px;\">DEPLOYABLE WEAPONS</h4>\r\n                    <div class=\"upgrade-item\">\r\n                        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\r\n                            <div>\r\n                                <strong style=\"color: #FF3333;\">Laser Turrets:</strong> <span id=\"current-laser-count\">0</span>\r\n                            </div>\r\n                        </div>\r\n                        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n                            <div style=\"flex: 2; padding-right: 10px;\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Deployable laser turrets automatically target and fire at enemies within 1000m range.</p>\r\n                            </div>\r\n                            <button id=\"purchase-laser\" style=\"flex: 1; padding: 10px; background-color: #FF3333; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                PURCHASE (1000 CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Upgrades Section (Now in first row) -->\r\n                <div id=\"upgrades-section\" class=\"stargate-section\">\r\n                    <h3>SHIP UPGRADES</h3>\r\n                    \r\n                    <!-- Fuel Tank Upgrade -->\r\n                    <div class=\"upgrade-item\">\r\n                        <div class=\"upgrade-header\">\r\n                            <div>\r\n                                <strong style=\"color: #00cc33;\">Fuel Tank Level:</strong> <span id=\"current-fuel-level\">1</span>\r\n                            </div>\r\n                            <div style=\"text-align: right;\">\r\n                                <strong>Capacity:</strong> <span id=\"current-fuel-capacity\">100</span> units\r\n                                <br>\r\n                                <small style=\"opacity: 0.8;\">Next: <span id=\"next-fuel-capacity\">200</span> units</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"upgrade-progress\">\r\n                            <div id=\"fuel-upgrade-progress\" class=\"upgrade-progress-bar\" style=\"background-color: #00cc33; width: 20%;\"></div>\r\n                        </div>\r\n                        <div class=\"upgrade-footer\">\r\n                            <div class=\"upgrade-description\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Increases maximum fuel capacity, allowing for longer journeys.</p>\r\n                            </div>\r\n                            <button id=\"upgrade-fuel-tank\" style=\"flex: 1; padding: 10px; background-color: #00cc33; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                UPGRADE (<span id=\"fuel-upgrade-cost\">1000</span> CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Engine Upgrade -->\r\n                    <div class=\"upgrade-item\">\r\n                        <div class=\"upgrade-header\">\r\n                            <div>\r\n                                <strong style=\"color: #ff9900;\">Engine Level:</strong> <span id=\"current-engine-level\">1</span>\r\n                            </div>\r\n                            <div style=\"text-align: right;\">\r\n                                <strong>Max Speed:</strong> <span id=\"current-max-velocity\">25</span> units/s\r\n                                <br>\r\n                                <small style=\"opacity: 0.8;\">Next: <span id=\"next-max-velocity\">31.25</span> units/s</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"upgrade-progress\">\r\n                            <div id=\"engine-upgrade-progress\" class=\"upgrade-progress-bar\" style=\"background-color: #ff9900; width: 20%;\"></div>\r\n                        </div>\r\n                        <div class=\"upgrade-footer\">\r\n                            <div class=\"upgrade-description\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Enhances thruster power, increasing maximum velocity and maneuverability.</p>\r\n                            </div>\r\n                            <button id=\"upgrade-engine\" style=\"flex: 1; padding: 10px; background-color: #ff9900; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                UPGRADE (<span id=\"engine-upgrade-cost\">800</span> CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Mining Laser Upgrade -->\r\n                    <div class=\"upgrade-item\">\r\n                        <div class=\"upgrade-header\">\r\n                            <div>\r\n                                <strong style=\"color: #ff3030;\">Mining Laser Level:</strong> <span id=\"current-mining-level\">1</span>\r\n                            </div>\r\n                            <div style=\"text-align: right;\">\r\n                                <strong>Efficiency:</strong> <span id=\"current-mining-efficiency\">100</span>%\r\n                                <br>\r\n                                <small style=\"opacity: 0.8;\">Next: <span id=\"next-mining-efficiency\">130</span>%</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"upgrade-progress\">\r\n                            <div id=\"mining-upgrade-progress\" class=\"upgrade-progress-bar\" style=\"background-color: #ff3030; width: 20%;\"></div>\r\n                        </div>\r\n                        <div class=\"upgrade-footer\">\r\n                            <div class=\"upgrade-description\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Increases mining speed and extraction efficiency, allowing faster resource collection.</p>\r\n                            </div>\r\n                            <button id=\"upgrade-mining\" style=\"flex: 1; padding: 10px; background-color: #ff3030; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                UPGRADE (<span id=\"mining-upgrade-cost\">1200</span> CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Hull Upgrade -->\r\n                    <div class=\"upgrade-item\">\r\n                        <div class=\"upgrade-header\">\r\n                            <div>\r\n                                <strong style=\"color: #30cfd0;\">Hull Level:</strong> <span id=\"current-hull-level\">1</span>\r\n                            </div>\r\n                            <div style=\"text-align: right;\">\r\n                                <strong>Resistance:</strong> <span id=\"current-hull-resistance\">100</span>%\r\n                                <br>\r\n                                <small style=\"opacity: 0.8;\">Next: <span id=\"next-hull-resistance\">125</span>%</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"upgrade-progress\">\r\n                            <div id=\"hull-upgrade-progress\" class=\"upgrade-progress-bar\" style=\"background-color: #30cfd0; width: 20%;\"></div>\r\n                        </div>\r\n                        <div class=\"upgrade-footer\">\r\n                            <div class=\"upgrade-description\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Reinforces ship structure, improving collision resistance and reducing damage.</p>\r\n                            </div>\r\n                            <button id=\"upgrade-hull\" style=\"flex: 1; padding: 10px; background-color: #30cfd0; color: #000; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                UPGRADE (<span id=\"hull-upgrade-cost\">1500</span> CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <!-- Scanner Upgrade -->\r\n                    <div class=\"upgrade-item\">\r\n                        <div class=\"upgrade-header\">\r\n                            <div>\r\n                                <strong style=\"color: #9933cc;\">Scanner Level:</strong> <span id=\"current-scanner-level\">1</span>\r\n                            </div>\r\n                            <div style=\"text-align: right;\">\r\n                                <strong>Range:</strong> <span id=\"current-scanner-range\">1000</span> units\r\n                                <br>\r\n                                <small style=\"opacity: 0.8;\">Next: <span id=\"next-scanner-range\">1200</span> units</small>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"upgrade-progress\">\r\n                            <div id=\"scanner-upgrade-progress\" class=\"upgrade-progress-bar\" style=\"background-color: #9933cc; width: 20%;\"></div>\r\n                        </div>\r\n                        <div class=\"upgrade-footer\">\r\n                            <div class=\"upgrade-description\">\r\n                                <p style=\"margin: 0; font-size: 12px;\">Extends scanner range for detecting asteroids and other objects at greater distances.</p>\r\n                            </div>\r\n                            <button id=\"upgrade-scanner\" style=\"flex: 1; padding: 10px; background-color: #9933cc; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;\">\r\n                                UPGRADE (<span id=\"scanner-upgrade-cost\">600</span> CR)\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Features Section -->\r\n                <div id=\"features-section\" class=\"stargate-section\">\r\n                    <h3>SERVICES</h3>\r\n                    \r\n                    <div class=\"feature-buttons\">\r\n                        <button id=\"open-star-map\" class=\"feature-btn\" style=\"background-color: #30cfd0;\">\r\n                            STAR MAP\r\n                            <small>Access star systems navigation</small>\r\n                        </button>\r\n                        <button id=\"create-custom-system\" class=\"feature-btn\" style=\"background: linear-gradient(135deg, #2c5a8c 0%, #4a76a8 100%); border: 1px solid #4a9dff; box-shadow: 0 0 10px rgba(74, 157, 255, 0.3);\">\r\n                            CREATE NEW SYSTEM\r\n                            <small>Generate custom AI star systems</small>\r\n                        </button>\r\n                        <button id=\"open-blackjack\" class=\"feature-btn\" style=\"background-color: #9933cc;\">\r\n                            STELLAR BLACKJACK\r\n                            <small>Wager resources in card games</small>\r\n                        </button>\r\n                        <button id=\"open-settings\" class=\"feature-btn\" style=\"background-color: #33aaff;\">\r\n                            SETTINGS\r\n                            <small>Adjust graphics and audio options</small>\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Challenge Section -->\r\n                <div id=\"challenge-section\" class=\"stargate-section\">\r\n                    <h3>EXTREME CHALLENGE</h3>\r\n                    <button id=\"unleash-horde\" class=\"action-btn btn-horde\">\r\n                        UNLEASH THE HORDE\r\n                    </button>\r\n                    <p style=\"font-size: 12px; color: #ff9999; margin: 10px 0 0 0;\">WARNING: Activate extreme survival mode with infinitely scaling difficulty</p>\r\n                </div>\r\n            </div>\r\n            \r\n            <!-- Footer -->\r\n            <div id=\"stargate-footer\">\r\n                <!-- Footer now empty, undock button moved to header -->\r\n            </div>\r\n        `;\r\n        \r\n        document.body.appendChild(stargateUI);\r\n    }\r\n    \r\n    setupSettingsButton() {\r\n        if (!this.settings) return;\r\n        \r\n        const settingsButton = document.getElementById('open-settings');\r\n        if (settingsButton) {\r\n            settingsButton.addEventListener('click', () => {\r\n                console.log(\"Opening settings\");\r\n                this.hideStargateUI();\r\n                this.settings.show();\r\n            });\r\n        }\r\n    }\r\n    \r\n    showDockingPrompt() {\r\n        const dockingPrompt = document.getElementById('docking-prompt');\r\n        if (dockingPrompt) {\r\n            // Only show if not flagged to always hide (on mobile devices)\r\n            if (dockingPrompt.dataset.alwaysHide !== 'true') {\r\n                dockingPrompt.style.display = 'block';\r\n            }\r\n        }\r\n    }\r\n    \r\n    hideDockingPrompt() {\r\n        const dockingPrompt = document.getElementById('docking-prompt');\r\n        if (dockingPrompt) {\r\n            dockingPrompt.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    showStargateUI() {\r\n        // Show the stargate UI\r\n        const stargateUI = document.getElementById('stargate-ui');\r\n        if (stargateUI) {\r\n            console.log(\"Showing stargate UI on \" + (this.isMobile ? \"mobile\" : \"desktop\"));\r\n            stargateUI.style.display = 'block';\r\n            \r\n            // Ensure background color is explicitly set\r\n            stargateUI.style.backgroundColor = 'rgba(20, 30, 50, 0.9)';\r\n            \r\n            // Mobile-specific adjustments\r\n            if (this.isMobile) {\r\n                // Ensure proper mobile styling\r\n                stargateUI.style.width = '92%';\r\n                stargateUI.style.maxWidth = '92vw';\r\n                stargateUI.style.maxHeight = '85vh';\r\n                stargateUI.style.webkitOverflowScrolling = 'touch';\r\n                stargateUI.style.touchAction = 'pan-y';\r\n                stargateUI.style.overscrollBehavior = 'auto'; // Changed from 'contain' to 'auto'\r\n                \r\n                // Ensure proper positioning\r\n                stargateUI.style.position = 'absolute';\r\n                stargateUI.style.top = '50%';\r\n                stargateUI.style.left = '50%';\r\n                stargateUI.style.transform = 'translate(-50%, -50%)';\r\n                stargateUI.style.zIndex = '1000';\r\n                \r\n                // Ensure body is in a state that allows the UI to be visible\r\n                document.body.classList.remove('undocking', 'modal-open');\r\n            }\r\n        }\r\n        \r\n        // Hide the docking prompt\r\n        const dockingPrompt = document.getElementById('docking-prompt');\r\n        if (dockingPrompt) {\r\n            dockingPrompt.style.display = 'none';\r\n        }\r\n        \r\n        // Setup star map button handler\r\n        this.setupStarMapButton();\r\n        \r\n        // Setup blackjack game button handler\r\n        this.setupBlackjackButton();\r\n        \r\n        // Setup settings button handler\r\n        this.setupSettingsButton();\r\n        \r\n        // Set up touch events for mobile scrolling\r\n        if (this.isMobile) {\r\n            this.setupTouchEvents();\r\n        }\r\n        \r\n        // Sync resources with game if available (similar to BlackjackGame)\r\n        if (window.game && window.game.controls) {\r\n            // Get reference to spaceship and resources\r\n            const spaceship = window.game.spaceship;\r\n            const resources = window.game.controls.resources;\r\n            \r\n            // Update the stargate UI with current values\r\n            if (spaceship && resources) {\r\n                console.log(\"Syncing stargate UI with game resources:\", resources);\r\n                this.updateStargateUI(spaceship, resources);\r\n            }\r\n        }\r\n    }\r\n    \r\n    setupStarMapButton() {\r\n        const starMapButton = document.getElementById('open-star-map');\r\n        if (starMapButton && this.starMap) {\r\n            starMapButton.addEventListener('click', () => {\r\n                console.log(\"Opening star map\");\r\n                this.hideStargateUI();\r\n                this.starMap.show();\r\n            });\r\n        } else if (starMapButton) {\r\n            // If star map not available, disable the button\r\n            starMapButton.disabled = true;\r\n            starMapButton.style.backgroundColor = '#555';\r\n            starMapButton.style.cursor = 'not-allowed';\r\n            starMapButton.title = 'Star map not available';\r\n        }\r\n    }\r\n    \r\n    setupBlackjackButton() {\r\n        const blackjackButton = document.getElementById('open-blackjack');\r\n        if (blackjackButton && this.blackjackGame) {\r\n            blackjackButton.addEventListener('click', () => {\r\n                console.log(\"Opening blackjack game\");\r\n                this.hideStargateUI();\r\n                this.blackjackGame.show();\r\n            });\r\n        } else if (blackjackButton) {\r\n            // If blackjack game not available, disable the button\r\n            blackjackButton.disabled = true;\r\n            blackjackButton.style.backgroundColor = '#555';\r\n            blackjackButton.style.cursor = 'not-allowed';\r\n            blackjackButton.title = 'Blackjack game not available';\r\n        }\r\n    }\r\n    \r\n    hideStargateUI() {\r\n        const stargateUI = document.getElementById('stargate-ui');\r\n        if (stargateUI) {\r\n            stargateUI.style.display = 'none';\r\n        }\r\n    }\r\n\r\n    // Add alias for compatibility\r\n    hide() {\r\n        this.hideStargateUI();\r\n    }\r\n    \r\n    updateStargateUI(spaceship, resources) {\r\n        // Update resource display with visual elements\r\n        document.getElementById('ms-iron').textContent = resources.iron;\r\n        document.getElementById('ms-gold').textContent = resources.gold;\r\n        document.getElementById('ms-platinum').textContent = resources.platinum;\r\n        \r\n        // Update credits with styling\r\n        document.getElementById('ms-credits').textContent = `${spaceship.credits} CR`;\r\n        \r\n        // Update fuel gauge\r\n        document.getElementById('fuel-gauge').style.width = `${(spaceship.fuel / spaceship.maxFuel) * 100}%`;\r\n        document.getElementById('fuel-level').textContent = Math.round((spaceship.fuel / spaceship.maxFuel) * 100);\r\n        \r\n        // Update shield gauge\r\n        document.getElementById('shield-gauge').style.width = `${(spaceship.shield / spaceship.maxShield) * 100}%`;\r\n        document.getElementById('shield-level').textContent = Math.round((spaceship.shield / spaceship.maxShield) * 100);\r\n        \r\n        // Update hull gauge\r\n        document.getElementById('hull-gauge').style.width = `${(spaceship.hull / spaceship.maxHull) * 100}%`;\r\n        document.getElementById('hull-level').textContent = Math.round((spaceship.hull / spaceship.maxHull) * 100);\r\n        \r\n        // Disable refuel button if not enough credits or fuel is full\r\n        const refuelBtn = document.getElementById('refuel-btn');\r\n        if (spaceship.credits < 100 || spaceship.fuel >= spaceship.maxFuel * 0.999) {\r\n            refuelBtn.disabled = true;\r\n            refuelBtn.style.backgroundColor = '#555';\r\n            refuelBtn.style.cursor = 'not-allowed';\r\n        } else {\r\n            refuelBtn.disabled = false;\r\n            refuelBtn.style.backgroundColor = '#00cc33';\r\n            refuelBtn.style.cursor = 'pointer';\r\n        }\r\n        \r\n        // Disable shield repair button if not enough credits or shield is full\r\n        const repairShieldBtn = document.getElementById('repair-shield-btn');\r\n        if (spaceship.credits < 150 || spaceship.shield >= spaceship.maxShield * 0.999) {\r\n            repairShieldBtn.disabled = true;\r\n            repairShieldBtn.style.backgroundColor = '#555';\r\n            repairShieldBtn.style.cursor = 'not-allowed';\r\n        } else {\r\n            repairShieldBtn.disabled = false;\r\n            repairShieldBtn.style.backgroundColor = '#3399ff';\r\n            repairShieldBtn.style.cursor = 'pointer';\r\n        }\r\n        \r\n        // Disable hull repair button if not enough credits or hull is full\r\n        const repairHullBtn = document.getElementById('repair-hull-btn');\r\n        if (spaceship.credits < 200 || spaceship.hull >= spaceship.maxHull * 0.999) {\r\n            repairHullBtn.disabled = true;\r\n            repairHullBtn.style.backgroundColor = '#555';\r\n            repairHullBtn.style.cursor = 'not-allowed';\r\n        } else {\r\n            repairHullBtn.disabled = false;\r\n            repairHullBtn.style.backgroundColor = '#ff9900';\r\n            repairHullBtn.style.cursor = 'pointer';\r\n        }\r\n        \r\n        // Update Fuel Tank upgrade information\r\n        document.getElementById('current-fuel-level').textContent = spaceship.fuelTankLevel;\r\n        document.getElementById('current-fuel-capacity').textContent = spaceship.maxFuel;\r\n        document.getElementById('next-fuel-capacity').textContent = spaceship.maxFuel * 2;\r\n        document.getElementById('fuel-upgrade-cost').textContent = spaceship.fuelUpgradeCost;\r\n        document.getElementById('fuel-upgrade-progress').style.width = `${Math.min(spaceship.fuelTankLevel * 20, 100)}%`;\r\n        \r\n        // Update Engine upgrade information\r\n        document.getElementById('current-engine-level').textContent = spaceship.engineLevel;\r\n        document.getElementById('current-max-velocity').textContent = spaceship.maxVelocity.toFixed(2);\r\n        document.getElementById('next-max-velocity').textContent = (spaceship.maxVelocity * 1.25).toFixed(2);\r\n        document.getElementById('engine-upgrade-cost').textContent = spaceship.engineUpgradeCost;\r\n        document.getElementById('engine-upgrade-progress').style.width = `${Math.min(spaceship.engineLevel * 20, 100)}%`;\r\n        \r\n        // Update Mining Laser upgrade information\r\n        document.getElementById('current-mining-level').textContent = spaceship.miningLevel;\r\n        document.getElementById('current-mining-efficiency').textContent = Math.round(spaceship.miningEfficiency * 100);\r\n        document.getElementById('next-mining-efficiency').textContent = Math.round(spaceship.miningEfficiency * 130);\r\n        document.getElementById('mining-upgrade-cost').textContent = spaceship.miningUpgradeCost;\r\n        document.getElementById('mining-upgrade-progress').style.width = `${Math.min(spaceship.miningLevel * 20, 100)}%`;\r\n        \r\n        // Update Hull upgrade information\r\n        document.getElementById('current-hull-level').textContent = spaceship.hullLevel;\r\n        document.getElementById('current-hull-resistance').textContent = Math.round(spaceship.collisionResistance * 100);\r\n        document.getElementById('next-hull-resistance').textContent = Math.round(spaceship.collisionResistance * 125);\r\n        document.getElementById('hull-upgrade-cost').textContent = spaceship.hullUpgradeCost;\r\n        document.getElementById('hull-upgrade-progress').style.width = `${Math.min(spaceship.hullLevel * 20, 100)}%`;\r\n        \r\n        // Update Scanner upgrade information\r\n        document.getElementById('current-scanner-level').textContent = spaceship.scannerLevel;\r\n        document.getElementById('current-scanner-range').textContent = Math.round(spaceship.scanRange);\r\n        document.getElementById('next-scanner-range').textContent = Math.round(spaceship.scanRange * 1.2);\r\n        document.getElementById('scanner-upgrade-cost').textContent = spaceship.scannerUpgradeCost;\r\n        document.getElementById('scanner-upgrade-progress').style.width = `${Math.min(spaceship.scannerLevel * 20, 100)}%`;\r\n        \r\n        // Disable upgrade buttons if not enough credits\r\n        this.updateUpgradeButtonStatus('upgrade-fuel-tank', spaceship.credits, spaceship.fuelUpgradeCost, '#00cc33');\r\n        this.updateUpgradeButtonStatus('upgrade-engine', spaceship.credits, spaceship.engineUpgradeCost, '#ff9900');\r\n        this.updateUpgradeButtonStatus('upgrade-mining', spaceship.credits, spaceship.miningUpgradeCost, '#ff3030');\r\n        this.updateUpgradeButtonStatus('upgrade-hull', spaceship.credits, spaceship.hullUpgradeCost, '#30cfd0');\r\n        this.updateUpgradeButtonStatus('upgrade-scanner', spaceship.credits, spaceship.scannerUpgradeCost, '#9933cc');\r\n        \r\n        // Disable sell buttons if no resources\r\n        document.getElementById('sell-iron').disabled = resources.iron === 0;\r\n        document.getElementById('sell-gold').disabled = resources.gold === 0;\r\n        document.getElementById('sell-platinum').disabled = resources.platinum === 0;\r\n        \r\n        // Update sell button styles based on resource availability\r\n        this.updateSellButtonStatus('sell-iron', resources.iron, '#cc6633');\r\n        this.updateSellButtonStatus('sell-gold', resources.gold, '#ffcc33');\r\n        this.updateSellButtonStatus('sell-platinum', resources.platinum, '#33ccff');\r\n        \r\n        // Update button styles based on disabled state\r\n        document.querySelectorAll('.sell-btn').forEach(btn => {\r\n            if (btn.disabled) {\r\n                btn.style.backgroundColor = 'rgba(40, 40, 40, 0.8)';\r\n                btn.style.color = '#777';\r\n                btn.style.cursor = 'not-allowed';\r\n                btn.style.boxShadow = 'none';\r\n            }\r\n        });\r\n        \r\n        // Update the laser turret count\r\n        const laserCountElement = document.getElementById('current-laser-count');\r\n        if (laserCountElement) {\r\n            laserCountElement.textContent = spaceship.deployableLaserCount || 0;\r\n        }\r\n        \r\n        // Update the purchase laser button status\r\n        const purchaseLaserBtn = document.getElementById('purchase-laser');\r\n        if (purchaseLaserBtn) {\r\n            if (spaceship.credits < 1000) {\r\n                purchaseLaserBtn.disabled = true;\r\n                purchaseLaserBtn.style.backgroundColor = '#555';\r\n                purchaseLaserBtn.style.cursor = 'not-allowed';\r\n            } else {\r\n                purchaseLaserBtn.disabled = false;\r\n                purchaseLaserBtn.style.backgroundColor = '#FF3333';\r\n                purchaseLaserBtn.style.cursor = 'pointer';\r\n            }\r\n        }\r\n        \r\n        // Update orb counts and button states\r\n        if (!resources.orbs) {\r\n            resources.orbs = {\r\n                common: 0,\r\n                uncommon: 0,\r\n                rare: 0,\r\n                epic: 0,\r\n                legendary: 0\r\n            };\r\n        }\r\n        \r\n        // Update orb counts\r\n        document.getElementById('orb-common-count').textContent = resources.orbs.common > 0 ? \r\n            `${resources.orbs.common} in inventory` : \"0 in inventory\";\r\n        document.getElementById('orb-uncommon-count').textContent = resources.orbs.uncommon > 0 ? \r\n            `${resources.orbs.uncommon} in inventory` : \"0 in inventory\";\r\n        document.getElementById('orb-rare-count').textContent = resources.orbs.rare > 0 ? \r\n            `${resources.orbs.rare} in inventory` : \"0 in inventory\";\r\n        document.getElementById('orb-epic-count').textContent = resources.orbs.epic > 0 ? \r\n            `${resources.orbs.epic} in inventory` : \"0 in inventory\";\r\n        document.getElementById('orb-legendary-count').textContent = resources.orbs.legendary > 0 ? \r\n            `${resources.orbs.legendary} in inventory` : \"0 in inventory\";\r\n        \r\n        // Disable sell buttons if no orbs available\r\n        const updateOrbSellButton = (buttonId, orbCount, borderColor) => {\r\n            const button = document.getElementById(buttonId);\r\n            if (!button) return;\r\n            \r\n            if (orbCount === 0) {\r\n                button.disabled = true;\r\n                button.style.backgroundColor = 'rgba(40, 40, 40, 0.8)';\r\n                button.style.color = '#777';\r\n                button.style.cursor = 'not-allowed';\r\n                button.style.boxShadow = 'none';\r\n            } else {\r\n                button.disabled = false;\r\n                button.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n                button.style.color = '#fff';\r\n                button.style.cursor = 'pointer';\r\n                button.style.boxShadow = `0 0 10px ${borderColor}`;\r\n            }\r\n        };\r\n        \r\n        updateOrbSellButton('sell-orb-common', resources.orbs.common, 'rgba(0, 255, 102, 0.3)');\r\n        updateOrbSellButton('sell-orb-uncommon', resources.orbs.uncommon, 'rgba(0, 102, 255, 0.3)');\r\n        updateOrbSellButton('sell-orb-rare', resources.orbs.rare, 'rgba(153, 0, 255, 0.3)');\r\n        updateOrbSellButton('sell-orb-epic', resources.orbs.epic, 'rgba(255, 102, 0, 0.3)');\r\n        updateOrbSellButton('sell-orb-legendary', resources.orbs.legendary, 'rgba(255, 0, 0, 0.3)');\r\n    }\r\n    \r\n    // Helper method to update upgrade button status\r\n    updateUpgradeButtonStatus(buttonId, currentCredits, cost, activeColor) {\r\n        const button = document.getElementById(buttonId);\r\n        if (!button) return;\r\n        \r\n        if (currentCredits < cost) {\r\n            button.disabled = true;\r\n            button.style.backgroundColor = '#555';\r\n            button.style.color = '#777';\r\n            button.style.cursor = 'not-allowed';\r\n        } else {\r\n            button.disabled = false;\r\n            button.style.backgroundColor = activeColor;\r\n            button.style.color = activeColor === '#ff9900' || activeColor === '#30cfd0' ? '#000' : '#fff';\r\n            button.style.cursor = 'pointer';\r\n        }\r\n    }\r\n    \r\n    // Update sell button styles based on available resources\r\n    updateSellButtonStatus(buttonId, resourceAmount, borderColor) {\r\n        const button = document.getElementById(buttonId);\r\n        if (!button) return;\r\n        \r\n        if (resourceAmount === 0) {\r\n            button.disabled = true;\r\n            button.style.backgroundColor = 'rgba(40, 40, 40, 0.8)';\r\n            button.style.borderColor = '#555';\r\n            button.style.color = '#777';\r\n            button.style.boxShadow = 'none';\r\n            button.style.cursor = 'not-allowed';\r\n        } else {\r\n            button.disabled = false;\r\n            button.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n            button.style.borderColor = borderColor;\r\n            button.style.color = '#fff';\r\n            button.style.boxShadow = `0 0 10px rgba(${parseInt(borderColor.slice(1, 3), 16)}, ${parseInt(borderColor.slice(3, 5), 16)}, ${parseInt(borderColor.slice(5, 7), 16)}, 0.3)`;\r\n            button.style.cursor = 'pointer';\r\n        }\r\n    }\r\n    \r\n    // Add a new method for setting up touch events\r\n    setupTouchEvents() {\r\n        if (!this.isMobile) return;\r\n        \r\n        const stargateUI = document.getElementById('stargate-ui');\r\n        if (!stargateUI) return;\r\n        \r\n        console.log(\"Setting up touch events for stargate UI\");\r\n        \r\n        // Make sure the undock button has proper touch handling\r\n        const undockBtn = document.getElementById('undock-btn');\r\n        if (undockBtn) {\r\n            undockBtn.style.touchAction = 'manipulation';\r\n            undockBtn.style.webkitTapHighlightColor = 'transparent';\r\n            undockBtn.style.position = 'relative';\r\n            undockBtn.style.zIndex = '9999';\r\n            \r\n            // Ensure proper touch handling\r\n            undockBtn.addEventListener('touchstart', (e) => {\r\n                console.log(\"Touch start on undock button\");\r\n                // Change appearance to show it's being touched\r\n                undockBtn.style.backgroundColor = '#1b88db';\r\n                undockBtn.style.transform = 'scale(0.98)';\r\n                // Prevent any default behavior that might interfere\r\n                e.stopPropagation();\r\n            }, { passive: false });\r\n            \r\n            undockBtn.addEventListener('touchend', (e) => {\r\n                console.log(\"Touch end on undock button\");\r\n                // Reset appearance\r\n                undockBtn.style.backgroundColor = '#33aaff';\r\n                undockBtn.style.transform = 'scale(1)';\r\n                // Prevent any default behavior that might interfere\r\n                e.stopPropagation();\r\n            }, { passive: false });\r\n        }\r\n        \r\n        // Prevent default touchmove on body but allow scrolling within the stargate UI\r\n        stargateUI.addEventListener('touchmove', (e) => {\r\n            // Allow the default scroll behavior within the stargate UI\r\n            e.stopPropagation();\r\n        }, { passive: true });\r\n        \r\n        // Fix for iOS scrolling issues - only prevent at the top, not at the bottom\r\n        stargateUI.addEventListener('touchstart', (e) => {\r\n            // Only prevent pull-to-refresh at the top, don't interfere with bottom scrolling\r\n            const scrollTop = stargateUI.scrollTop;\r\n            \r\n            if (scrollTop <= 0 && e.touches[0].screenY < e.touches[0].clientY) {\r\n                e.preventDefault();\r\n            }\r\n            // Removed condition that was preventing scrolling at the bottom\r\n        }, { passive: false });\r\n        \r\n        // Handle tabbed content for better touch experience\r\n        const tabButtons = stargateUI.querySelectorAll('.tablinks');\r\n        if (tabButtons.length > 0) {\r\n            tabButtons.forEach(button => {\r\n                button.addEventListener('touchend', (e) => {\r\n                    // Prevent rapid multiple touches\r\n                    e.preventDefault();\r\n                    \r\n                    // Simulate a click event\r\n                    button.click();\r\n                });\r\n            });\r\n        }\r\n        \r\n        // Improve touch experience for all buttons in the stargate UI\r\n        const allButtons = stargateUI.querySelectorAll('button');\r\n        allButtons.forEach(button => {\r\n            if (button !== undockBtn) { // We already handled the undock button specially\r\n                button.style.touchAction = 'manipulation';\r\n                button.style.webkitTapHighlightColor = 'transparent';\r\n                \r\n                // Provide visual feedback on touch\r\n                button.addEventListener('touchstart', () => {\r\n                    button.style.transform = 'scale(0.98)';\r\n                }, { passive: true });\r\n                \r\n                button.addEventListener('touchend', () => {\r\n                    button.style.transform = 'scale(1)';\r\n                }, { passive: true });\r\n            }\r\n        });\r\n    }\r\n    \r\n    setupEventHandlers() {\r\n        // Add event handler for custom system button\r\n        const customSystemBtn = document.getElementById('create-custom-system');\r\n        if (customSystemBtn) {\r\n            customSystemBtn.addEventListener('click', () => {\r\n                // Check if custom system creator is available on environment\r\n                if (window.game && window.game.environment && window.game.environment.customSystemCreator) {\r\n                    // Close stargate interface\r\n                    this.hide();\r\n                    \r\n                    // Show custom system creator\r\n                    window.game.environment.customSystemCreator.show();\r\n                } else {\r\n                    console.error('Custom system creator not available');\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Add event handler for UNLEASH THE HORDE button\r\n        const hordeButton = document.getElementById('unleash-horde');\r\n        if (hordeButton) {\r\n            hordeButton.addEventListener('click', () => {\r\n                // Check if spectral drones have started spawning\r\n                const dronesHaveSpawned = window.game && \r\n                                         window.game.ecsWorld && \r\n                                         window.game.ecsWorld.enemySystem && \r\n                                         window.game.ecsWorld.enemySystem.initialSpawnComplete;\r\n                \r\n                if (dronesHaveSpawned) {\r\n                    console.log(\"HORDE MODE: Button clicked, showing confirmation\");\r\n                    this.showHordeConfirmation();\r\n                } else {\r\n                    console.log(\"HORDE MODE: Button clicked but spectral drones haven't appeared yet\");\r\n                    // Show notification that horde mode is not available yet\r\n                    this.showNotification(\"Horde mode is only available after spectral drones appear in the sector.\", 0xff3030);\r\n                }\r\n            });\r\n        }\r\n        \r\n        // Add handler for purchasing laser turrets\r\n        const purchaseLaserBtn = document.getElementById('purchase-laser');\r\n        if (purchaseLaserBtn) {\r\n            purchaseLaserBtn.addEventListener('click', this.purchaseLaserTurret.bind(this));\r\n        }\r\n        \r\n        // Energy orb sell handlers\r\n        document.getElementById('sell-orb-common').addEventListener('click', () => {\r\n            if (this.sellEnergyOrb('common')) {\r\n                // Update UI after selling\r\n                this.updateStargateUI(window.game.spaceship, window.game.controls.resources);\r\n            }\r\n        });\r\n        \r\n        document.getElementById('sell-orb-uncommon').addEventListener('click', () => {\r\n            if (this.sellEnergyOrb('uncommon')) {\r\n                // Update UI after selling\r\n                this.updateStargateUI(window.game.spaceship, window.game.controls.resources);\r\n            }\r\n        });\r\n        \r\n        document.getElementById('sell-orb-rare').addEventListener('click', () => {\r\n            if (this.sellEnergyOrb('rare')) {\r\n                // Update UI after selling\r\n                this.updateStargateUI(window.game.spaceship, window.game.controls.resources);\r\n            }\r\n        });\r\n        \r\n        document.getElementById('sell-orb-epic').addEventListener('click', () => {\r\n            if (this.sellEnergyOrb('epic')) {\r\n                // Update UI after selling\r\n                this.updateStargateUI(window.game.spaceship, window.game.controls.resources);\r\n            }\r\n        });\r\n        \r\n        document.getElementById('sell-orb-legendary').addEventListener('click', () => {\r\n            if (this.sellEnergyOrb('legendary')) {\r\n                // Update UI after selling\r\n                this.updateStargateUI(window.game.spaceship, window.game.controls.resources);\r\n            }\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Show confirmation dialog for activating horde mode\r\n     */\r\n    showHordeConfirmation() {\r\n        // Create modal overlay\r\n        const modal = document.createElement('div');\r\n        modal.id = 'horde-confirm-modal';\r\n        \r\n        // Create content container\r\n        const content = document.createElement('div');\r\n        content.id = 'horde-confirm-content';\r\n        \r\n        // Add title\r\n        const title = document.createElement('div');\r\n        title.className = 'horde-confirm-title';\r\n        title.textContent = 'UNLEASH THE HORDE?';\r\n        content.appendChild(title);\r\n        \r\n        // Add warning text\r\n        const text = document.createElement('div');\r\n        text.className = 'horde-confirm-text';\r\n        text.innerHTML = `\r\n            <p>You are about to activate EXTREME SURVIVAL MODE.</p>\r\n            <p>Enemies will continuously spawn with increasing:</p>\r\n            <ul style=\"text-align: left; padding-left: 30px; margin: 15px 0;\">\r\n                <li>Numbers (starting at 50, scaling upward)</li>\r\n                <li>Speed (progressively faster movement)</li>\r\n                <li>Health (gradually becoming tougher)</li>\r\n                <li>Damage (increasingly lethal hits)</li>\r\n            </ul>\r\n            <p>Difficulty will scale <strong>infinitely</strong> until you are overwhelmed.</p>\r\n            <p style=\"color: #ff9999;\">This is a test of survival. How long can you last?</p>\r\n        `;\r\n        content.appendChild(text);\r\n        \r\n        // Add buttons container\r\n        const buttons = document.createElement('div');\r\n        buttons.className = 'horde-confirm-buttons';\r\n        \r\n        // Add YES button\r\n        const yesBtn = document.createElement('button');\r\n        yesBtn.className = 'horde-confirm-btn horde-confirm-yes';\r\n        yesBtn.textContent = 'UNLEASH THEM';\r\n        yesBtn.addEventListener('click', () => {\r\n            // Remove the confirmation dialog\r\n            document.body.removeChild(modal);\r\n            \r\n            // Hide the stargate UI\r\n            this.hideStargateUI();\r\n            \r\n            // Activate horde mode in the game\r\n            if (window.game && typeof window.game.activateHordeMode === 'function') {\r\n                window.game.activateHordeMode();\r\n                console.log(\"HORDE MODE: Activated via stargateInterface\");\r\n            } else {\r\n                console.error(\"HORDE MODE: Failed to activate - game.activateHordeMode not available\");\r\n            }\r\n        });\r\n        \r\n        // Add NO button\r\n        const noBtn = document.createElement('button');\r\n        noBtn.className = 'horde-confirm-btn horde-confirm-no';\r\n        noBtn.textContent = 'CANCEL';\r\n        noBtn.addEventListener('click', () => {\r\n            // Just remove the confirmation dialog\r\n            document.body.removeChild(modal);\r\n        });\r\n        \r\n        // Add buttons to container\r\n        buttons.appendChild(noBtn);  // Cancel on left\r\n        buttons.appendChild(yesBtn); // Confirm on right\r\n        \r\n        // Add buttons to content\r\n        content.appendChild(buttons);\r\n        \r\n        // Add content to modal\r\n        modal.appendChild(content);\r\n        \r\n        // Add modal to body\r\n        document.body.appendChild(modal);\r\n    }\r\n\r\n    /**\r\n     * Purchase a deployable laser turret\r\n     */\r\n    purchaseLaserTurret() {\r\n        console.log(\"Attempting to purchase laser turret\");\r\n        \r\n        // Check if game and spaceship are available\r\n        if (!window.game || !window.game.spaceship) {\r\n            console.error(\"Cannot purchase laser turret: game or spaceship not found\");\r\n            return;\r\n        }\r\n        \r\n        const spaceship = window.game.spaceship;\r\n        \r\n        // Check if player has enough credits\r\n        if (spaceship.credits < 1000) {\r\n            console.log(\"Not enough credits to purchase laser turret\");\r\n            // Show notification to the player\r\n            if (window.mainMessageBus) {\r\n                window.mainMessageBus.publish('ui.notification', {\r\n                    message: \"Not enough credits to purchase laser turret\",\r\n                    type: \"error\",\r\n                    duration: 2\r\n                });\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Purchase the laser turret\r\n        spaceship.credits -= 1000;\r\n        \r\n        // Initialize deployableLaserCount if it doesn't exist\r\n        if (typeof spaceship.deployableLaserCount === 'undefined') {\r\n            spaceship.deployableLaserCount = 0;\r\n        }\r\n        \r\n        // Add a laser turret to the player's inventory\r\n        spaceship.deployableLaserCount++;\r\n        \r\n        // Play purchase sound\r\n        if (window.game.audio && window.game.audio.playSound) {\r\n            window.game.audio.playSound('purchase');\r\n        }\r\n        \r\n        // Update the UI\r\n        this.updateStargateUI(spaceship, window.game.controls.resources);\r\n        \r\n        // Show notification to the player\r\n        if (window.mainMessageBus) {\r\n            window.mainMessageBus.publish('ui.notification', {\r\n                message: \"Laser turret purchased\",\r\n                type: \"success\",\r\n                duration: 2\r\n            });\r\n        }\r\n        \r\n        console.log(\"Laser turret purchased successfully\");\r\n    }\r\n\r\n    // Sell an energy orb of the specified rarity\r\n    sellEnergyOrb(rarity) {\r\n        // Make sure we have spaceship and resources references\r\n        if (!window.game || !window.game.spaceship || !window.game.controls || !window.game.controls.resources) {\r\n            console.error(\"Required game objects not available\");\r\n            return false;\r\n        }\r\n        \r\n        const spaceship = window.game.spaceship;\r\n        const resources = window.game.controls.resources;\r\n        \r\n        // Check if orbs property exists, initialize if needed\r\n        if (!resources.orbs) {\r\n            resources.orbs = {\r\n                common: 0,\r\n                uncommon: 0,\r\n                rare: 0,\r\n                epic: 0,\r\n                legendary: 0\r\n            };\r\n            return false; // No orbs available yet\r\n        }\r\n        \r\n        // Check if player has any orbs of the specified rarity\r\n        if (!resources.orbs[rarity] || resources.orbs[rarity] <= 0) {\r\n            console.log(`No ${rarity} orbs available to sell`);\r\n            return false;\r\n        }\r\n        \r\n        // Calculate value based on rarity\r\n        let value = 0;\r\n        switch (rarity) {\r\n            case 'common':\r\n                value = 100;\r\n                break;\r\n            case 'uncommon':\r\n                value = 500;\r\n                break;\r\n            case 'rare':\r\n                value = 1500;\r\n                break;\r\n            case 'epic':\r\n                value = 5000;\r\n                break;\r\n            case 'legendary':\r\n                value = 15000;\r\n                break;\r\n            default:\r\n                console.error(`Unknown orb rarity: ${rarity}`);\r\n                return false;\r\n        }\r\n        \r\n        // Sell the orb - update inventory and credits\r\n        resources.orbs[rarity]--;\r\n        spaceship.credits += value;\r\n        \r\n        // Show message\r\n        const capitalizedRarity = rarity.charAt(0).toUpperCase() + rarity.slice(1);\r\n        this.showNotification(`Sold ${capitalizedRarity} Energy Orb for ${value} credits`, 0x33aaff);\r\n        \r\n        // Play sound if audio manager is available\r\n        if (window.game.audio) {\r\n            window.game.audio.playSoundEffect('sell', 0.5);\r\n        }\r\n        \r\n        return true;\r\n    }\r\n    \r\n    // Helper method to show notifications\r\n    showNotification(message, color = 0x33aaff) {\r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = '35%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#fff';\r\n        notification.style.padding = '15px 30px';\r\n        notification.style.borderRadius = '10px';\r\n        notification.style.border = `2px solid #${color.toString(16).padStart(6, '0')}`;\r\n        notification.style.boxShadow = `0 0 15px #${color.toString(16).padStart(6, '0')}`;\r\n        notification.style.fontFamily = 'Courier New, monospace';\r\n        notification.style.fontSize = '16px';\r\n        notification.style.zIndex = '1001'; // Above the stargate UI\r\n        notification.style.textAlign = 'center';\r\n        \r\n        // Set notification text\r\n        notification.textContent = message;\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(notification);\r\n        \r\n        // Remove after a few seconds\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 0.8s';\r\n            \r\n            setTimeout(() => {\r\n                notification.remove();\r\n            }, 800);\r\n        }, 2000);\r\n    }\r\n}","/**\r\n * Utility functions for handling file paths, especially for GitHub Pages deployment\r\n */\r\n\r\n/**\r\n * Converts a relative path to an absolute path that works both locally and on GitHub Pages\r\n * @param {string} relativePath - The relative path to convert\r\n * @returns {string} - The absolute path adjusted for the current environment\r\n */\r\nexport function getAbsolutePath(relativePath) {\r\n    // Log for debugging\r\n    console.log(`Original path: ${relativePath}`);\r\n    \r\n    // For GitHub Pages or any hosted environment\r\n    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {\r\n        // Get the base path from the current URL\r\n        const basePath = window.location.pathname.split('/').slice(0, -1).join('/');\r\n        \r\n        // Remove leading slash from relative path if it exists\r\n        const cleanPath = relativePath.startsWith('/') ? relativePath.substring(1) : relativePath;\r\n        \r\n        // Construct the full path\r\n        const fullPath = `${basePath}/${cleanPath}`;\r\n        \r\n        console.log(`Adjusted path for hosted environment: ${fullPath}`);\r\n        return fullPath;\r\n    }\r\n    \r\n    // For local development\r\n    console.log(`Using original path for local environment: ${relativePath}`);\r\n    return relativePath;\r\n} ","// gameOverScreen.js - Handles the game over UI\r\n\r\nimport { getAbsolutePath } from '../../utils/pathUtils.js';\r\n\r\nexport class GameOverScreen {\r\n    constructor() {\r\n        this.isVisible = false;\r\n        this.setupGameOverScreen();\r\n    }\r\n    \r\n    // Helper method to handle paths for GitHub Pages and local development\r\n    getPath(relativePath) {\r\n        return getAbsolutePath(relativePath);\r\n    }\r\n    \r\n    setupGameOverScreen() {\r\n        // Add game over container (hidden initially)\r\n        const gameOverContainer = document.createElement('div');\r\n        gameOverContainer.id = 'game-over-container';\r\n        gameOverContainer.style.position = 'absolute';\r\n        gameOverContainer.style.top = '0';\r\n        gameOverContainer.style.left = '0';\r\n        gameOverContainer.style.width = '100%';\r\n        gameOverContainer.style.height = '100%';\r\n        gameOverContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        gameOverContainer.style.display = 'flex';\r\n        gameOverContainer.style.flexDirection = 'column';\r\n        gameOverContainer.style.alignItems = 'center';\r\n        gameOverContainer.style.justifyContent = 'center';\r\n        gameOverContainer.style.color = '#fff';\r\n        gameOverContainer.style.fontFamily = 'Courier New, monospace';\r\n        gameOverContainer.style.zIndex = '1000';\r\n        gameOverContainer.style.display = 'none';\r\n        document.body.appendChild(gameOverContainer);\r\n        \r\n        // Game over title\r\n        const gameOverTitle = document.createElement('h1');\r\n        gameOverTitle.textContent = 'GAME OVER';\r\n        gameOverTitle.style.fontSize = '50px';\r\n        gameOverTitle.style.color = '#ff0000';\r\n        gameOverTitle.style.textShadow = '0 0 10px #ff0000';\r\n        gameOverTitle.style.marginBottom = '20px';\r\n        gameOverContainer.appendChild(gameOverTitle);\r\n        \r\n        // Game over message\r\n        const gameOverMessage = document.createElement('p');\r\n        gameOverMessage.id = 'game-over-message';\r\n        gameOverMessage.textContent = 'Your ship was destroyed by asteroid collision';\r\n        gameOverMessage.style.fontSize = '18px';\r\n        gameOverMessage.style.marginBottom = '40px';\r\n        gameOverContainer.appendChild(gameOverMessage);\r\n        \r\n        // Restart button\r\n        this.setupRestartButton(gameOverContainer);\r\n        \r\n        // Resources collected summary (for game over screen)\r\n        const resourcesSummary = document.createElement('div');\r\n        resourcesSummary.id = 'resources-summary';\r\n        resourcesSummary.style.marginTop = '30px';\r\n        resourcesSummary.style.fontSize = '16px';\r\n        resourcesSummary.style.textAlign = 'center';\r\n        gameOverContainer.appendChild(resourcesSummary);\r\n    }\r\n    \r\n    setupRestartButton(container) {\r\n        const restartButton = document.createElement('button');\r\n        restartButton.id = 'restart-game-button';\r\n        restartButton.textContent = 'RESTART MISSION';\r\n        restartButton.style.backgroundColor = 'rgba(120, 220, 232, 0.2)';\r\n        restartButton.style.color = '#fff';\r\n        restartButton.style.border = '1px solid rgba(120, 220, 232, 0.5)';\r\n        restartButton.style.borderRadius = '5px';\r\n        restartButton.style.padding = '15px 30px';\r\n        restartButton.style.fontSize = '20px';\r\n        restartButton.style.fontFamily = '\"Rajdhani\", sans-serif';\r\n        restartButton.style.cursor = 'pointer';\r\n        restartButton.style.marginTop = '30px';\r\n        restartButton.style.transition = 'all 0.2s ease';\r\n        \r\n        restartButton.addEventListener('mouseover', () => {\r\n            restartButton.style.backgroundColor = 'rgba(120, 220, 232, 0.4)';\r\n            restartButton.style.boxShadow = '0 0 15px rgba(120, 220, 232, 0.5)';\r\n        });\r\n        \r\n        restartButton.addEventListener('mouseout', () => {\r\n            restartButton.style.backgroundColor = 'rgba(120, 220, 232, 0.2)';\r\n            restartButton.style.boxShadow = 'none';\r\n        });\r\n        \r\n        restartButton.addEventListener('click', () => {\r\n            // Play the click sound\r\n            if (this.audio) {\r\n                this.audio.playSound('uiClick');\r\n            }\r\n            \r\n            // Show loading status\r\n            const loadingStatus = document.createElement('div');\r\n            loadingStatus.textContent = 'Restarting mission...';\r\n            loadingStatus.style.color = 'rgba(120, 220, 232, 0.9)';\r\n            loadingStatus.style.marginTop = '10px';\r\n            container.appendChild(loadingStatus);\r\n            \r\n            // Disable the button during reload\r\n            restartButton.disabled = true;\r\n            restartButton.style.opacity = '0.5';\r\n            restartButton.style.cursor = 'default';\r\n            \r\n            // Reset game state before reloading\r\n            // This is critical to ensure difficulty level resets properly\r\n            if (window.game) {\r\n                // Reset time-based difficulty scaling\r\n                if (window.game.difficultyManager) {\r\n                    window.game.difficultyManager.gameTime = 0;\r\n                    window.game.difficultyManager.currentLevel = 1;\r\n                    console.log(\"Reset difficulty level to 1\");\r\n                }\r\n                \r\n                // Reset game time counter\r\n                window.game.gameTime = 0;\r\n            }\r\n            \r\n            // Reload the page with a small delay to allow the UI update to be seen\r\n            setTimeout(() => {\r\n                location.reload();\r\n            }, 500);\r\n        });\r\n        \r\n        container.appendChild(restartButton);\r\n    }\r\n    \r\n    show(resources, message) {\r\n        console.log(\"GameOverScreen: Showing game over screen\");\r\n        \r\n        // Show game over screen\r\n        const gameOverContainer = document.getElementById('game-over-container');\r\n        gameOverContainer.style.display = 'flex';\r\n        \r\n        // Set message based on reason\r\n        const gameOverMessage = document.getElementById('game-over-message');\r\n        if (gameOverMessage) {\r\n            // Default message\r\n            let displayMessage = 'Your journey has ended.';\r\n            \r\n            // Check if we received a reason type or just a string message\r\n            if (typeof message === 'object' && message.data && message.data.type) {\r\n                // Use the type field for more reliable message categorization\r\n                const reasonType = message.data.type;\r\n                \r\n                switch (reasonType) {\r\n                    case 'FUEL_DEPLETED':\r\n                        displayMessage = 'Your ship drifted into the void after running out of fuel.';\r\n                        break;\r\n                    case 'COLLISION_ASTEROID':\r\n                        displayMessage = 'Your ship was destroyed by an asteroid collision.';\r\n                        break;\r\n                    case 'COLLISION_PLANET':\r\n                        displayMessage = 'Your ship crashed into a planet!';\r\n                        break;\r\n                    case 'COMBAT_DEATH':\r\n                        displayMessage = 'Your ship was destroyed in combat.';\r\n                        break;\r\n                    case 'SUN_DEATH':\r\n                        displayMessage = \"Your ship was incinerated by the sun's heat!\";\r\n                        break;\r\n                    default:\r\n                        // If we have a reason string but don't recognize the type\r\n                        if (message.data.reason) {\r\n                            displayMessage = message.data.reason;\r\n                        }\r\n                }\r\n            } else if (message) {\r\n                // Fallback to string content checking for backward compatibility\r\n                if (message.includes(\"fuel\")) {\r\n                    displayMessage = 'Your ship drifted into the void after running out of fuel.';\r\n                } else if (message.includes(\"asteroid\")) {\r\n                    displayMessage = 'Your ship was destroyed by an asteroid collision.';\r\n                } else if (message.includes(\"combat\")) {\r\n                    displayMessage = 'Your ship was destroyed in combat.';\r\n                } else if (message.includes(\"sun\")) {\r\n                    displayMessage = \"Your ship was incinerated by the sun's heat!\";\r\n                } else if (message.includes(\"planet\")) {\r\n                    displayMessage = \"Your ship crashed into a planet!\";\r\n                } else {\r\n                    // Use the provided message if none of our standardized reasons match\r\n                    displayMessage = message;\r\n                }\r\n            }\r\n            \r\n            gameOverMessage.textContent = displayMessage;\r\n        }\r\n        \r\n        // Check if game was in horde mode\r\n        let wasHordeMode = false;\r\n        let hordeSurvivalTime = \"00:00\";\r\n        let rawSurvivalTime = 0;\r\n        \r\n        if (resources && resources.hordeMode) {\r\n            wasHordeMode = resources.hordeMode.active;\r\n            hordeSurvivalTime = resources.hordeMode.survivalTime || \"00:00\";\r\n            rawSurvivalTime = resources.hordeMode.rawSurvivalTime || 0;\r\n        }\r\n        \r\n        // Handle different resource data formats\r\n        // It might be wrapped in a gameStats structure or come directly\r\n        let resourceData = resources;\r\n        \r\n        // Check if resources has a nested resources property (from gameOver method in game.js)\r\n        if (resources && resources.resources) {\r\n            console.log(\"GameOverScreen: Using nested resources data structure\");\r\n            resourceData = resources.resources;\r\n        }\r\n        \r\n        // Ensure we have valid resource values with defaults\r\n        const iron = resourceData && resourceData.iron ? resourceData.iron : 0;\r\n        const gold = resourceData && resourceData.gold ? resourceData.gold : 0;\r\n        const platinum = resourceData && resourceData.platinum ? resourceData.platinum : 0;\r\n        \r\n        // Update resources summary with guaranteed safe values\r\n        const resourcesSummary = document.getElementById('resources-summary');\r\n        if (resourcesSummary) {\r\n            // Create horde mode section if applicable\r\n            if (wasHordeMode) {\r\n                // Get minutes for special messages\r\n                const minutes = Math.floor(rawSurvivalTime / 1000 / 60);\r\n                \r\n                // Determine message based on survival time\r\n                let hordeMessage = \"You fought valiantly against overwhelming odds.\";\r\n                if (minutes >= 10) {\r\n                    hordeMessage = \"LEGENDARY! Few have survived the horde this long!\";\r\n                } else if (minutes >= 5) {\r\n                    hordeMessage = \"IMPRESSIVE! You showed exceptional combat skills!\";\r\n                } else if (minutes >= 3) {\r\n                    hordeMessage = \"Well done! You held back the horde longer than most!\";\r\n                }\r\n                \r\n                resourcesSummary.innerHTML = `\r\n                    <div style=\"margin-bottom:20px; padding:15px; background-color:rgba(255,48,48,0.2); border:1px solid #ff3030; border-radius:5px;\">\r\n                        <h3 style=\"color:#ff3030; margin-top:0; text-shadow:0 0 5px rgba(255,48,48,0.5);\">HORDE MODE</h3>\r\n                        <p style=\"font-size:18px; font-weight:bold;\">SURVIVED: <span style=\"color:#ff9999; text-shadow:0 0 5px rgba(255,48,48,0.3);\">${hordeSurvivalTime}</span></p>\r\n                        <p>${hordeMessage}</p>\r\n                    </div>\r\n                    <p>Resources collected:</p>\r\n                    <p>IRON: ${iron} | GOLD: ${gold} | PLATINUM: ${platinum}</p>\r\n                `;\r\n            } else {\r\n                resourcesSummary.innerHTML = `\r\n                    <p>Resources collected:</p>\r\n                    <p>IRON: ${iron} | GOLD: ${gold} | PLATINUM: ${platinum}</p>\r\n                `;\r\n            }\r\n        }\r\n        \r\n        // Simpler approach to play explosion sound as a backup\r\n        try {\r\n            console.log(\"GameOverScreen: Attempting simple audio playback\");\r\n            \r\n            // Create a direct audio element without attaching to DOM\r\n            const boinkSound = new Audio(this.getPath('sounds/effects/boink.wav'));\r\n            boinkSound.volume = 0.8;\r\n            \r\n            // Play with a slight delay to avoid conflict with other sounds\r\n            setTimeout(() => {\r\n                boinkSound.play().catch(err => {\r\n                    console.warn(\"GameOverScreen: Simple sound failed:\", err);\r\n                });\r\n            }, 100);\r\n            \r\n        } catch (err) {\r\n            console.error(\"GameOverScreen: Error with simple sound approach:\", err);\r\n        }\r\n        \r\n        // Lock pointer to prevent camera movement after game over\r\n        if (document.exitPointerLock) {\r\n            document.exitPointerLock();\r\n        }\r\n    }\r\n} ","// controlsMenu.js - Handles the controls menu UI\r\n\r\nexport class ControlsMenu {\r\n    constructor() {\r\n        this.setupControlsMenu();\r\n    }\r\n    \r\n    setupControlsMenu() {\r\n        // Create controls menu\r\n        const controlsMenu = document.createElement('div');\r\n        controlsMenu.id = 'controls-menu';\r\n        controlsMenu.style.position = 'absolute';\r\n        controlsMenu.style.top = '50%';\r\n        controlsMenu.style.left = '50%';\r\n        controlsMenu.style.transform = 'translate(-50%, -50%)';\r\n        controlsMenu.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        controlsMenu.style.padding = '15px';\r\n        controlsMenu.style.borderRadius = '10px';\r\n        controlsMenu.style.border = '1px solid #30cfd0';\r\n        controlsMenu.style.boxShadow = '0 0 10px #30cfd0';\r\n        controlsMenu.style.zIndex = '1000';\r\n        controlsMenu.style.display = 'none';\r\n        document.body.appendChild(controlsMenu);\r\n        \r\n        // Controls menu header\r\n        const controlsTitle = document.createElement('div');\r\n        controlsTitle.className = 'help-title';\r\n        controlsTitle.innerHTML = 'CONTROLS <span id=\"close-controls\" style=\"float: right; cursor: pointer; font-weight: bold;\">X</span>';\r\n        controlsMenu.appendChild(controlsTitle);\r\n        \r\n        // Control rows\r\n        const createControlRow = (keyText, actionText) => {\r\n            const row = document.createElement('div');\r\n            row.className = 'control-row';\r\n            row.style.display = 'flex';\r\n            row.style.justifyContent = 'space-between';\r\n            row.style.marginBottom = '5px';\r\n            \r\n            const keySpan = document.createElement('span');\r\n            if (keyText !== 'Mouse') {\r\n                keySpan.className = 'key';\r\n                keySpan.style.backgroundColor = 'rgba(48, 207, 208, 0.2)';\r\n                keySpan.style.border = '1px solid #30cfd0';\r\n                keySpan.style.borderRadius = '4px';\r\n                keySpan.style.padding = '0 5px';\r\n                keySpan.style.minWidth = '20px';\r\n                keySpan.style.textAlign = 'center';\r\n            }\r\n            keySpan.textContent = keyText;\r\n            row.appendChild(keySpan);\r\n            \r\n            const actionSpan = document.createElement('span');\r\n            actionSpan.textContent = actionText;\r\n            row.appendChild(actionSpan);\r\n            \r\n            return row;\r\n        };\r\n        \r\n        // Add all control rows\r\n        controlsMenu.appendChild(createControlRow('W', 'Forward Thrust'));\r\n        controlsMenu.appendChild(createControlRow('S', 'Backward Thrust'));\r\n        controlsMenu.appendChild(createControlRow('A', 'Left Thrust'));\r\n        controlsMenu.appendChild(createControlRow('D', 'Right Thrust'));\r\n        controlsMenu.appendChild(createControlRow('SHIFT', 'Boost'));\r\n        controlsMenu.appendChild(createControlRow('Mouse', 'Ship Rotation'));\r\n        controlsMenu.appendChild(createControlRow('Click', 'Fire Particle Cannon'));\r\n        controlsMenu.appendChild(createControlRow('E', 'Target Lock-On'));\r\n        controlsMenu.appendChild(createControlRow('TAB', 'Cycle Targets'));\r\n        controlsMenu.appendChild(createControlRow('R', 'Toggle Mining'));\r\n        controlsMenu.appendChild(createControlRow('T', 'Deploy Laser Turret'));\r\n        controlsMenu.appendChild(createControlRow('Q', 'Dock with Stargate'));\r\n        \r\n        // Set up event listeners for the controls menu\r\n        document.getElementById('close-controls').addEventListener('click', () => {\r\n            this.hide();\r\n        });\r\n\r\n        // Close menu when clicking outside of it\r\n        document.addEventListener('click', (e) => {\r\n            const controlsMenu = document.getElementById('controls-menu');\r\n            const showControlsButton = document.getElementById('show-controls');\r\n            \r\n            if (controlsMenu.style.display === 'block' && \r\n                !controlsMenu.contains(e.target) && \r\n                e.target !== showControlsButton) {\r\n                this.hide();\r\n            }\r\n        });\r\n    }\r\n    \r\n    show() {\r\n        const controlsMenu = document.getElementById('controls-menu');\r\n        if (controlsMenu) {\r\n            controlsMenu.style.display = 'block';\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        const controlsMenu = document.getElementById('controls-menu');\r\n        if (controlsMenu) {\r\n            controlsMenu.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    setupButtonHandler() {\r\n        // Add click handler for the show controls button\r\n        const showControlsButton = document.getElementById('show-controls');\r\n        if (showControlsButton) {\r\n            showControlsButton.addEventListener('click', (e) => {\r\n                this.show();\r\n                e.stopPropagation(); // Prevent click from passing through\r\n            });\r\n        }\r\n    }\r\n} ","// starMap.js - Handles the star map UI for interstellar travel\r\n\r\nimport { MobileDetector } from '../../utils/mobileDetector.js';\r\n\r\nexport class StarMap {\r\n    constructor(starSystemGenerator, dockingSystem, stargateInterface) {\r\n        this.starSystemGenerator = starSystemGenerator;\r\n        this.dockingSystem = dockingSystem;\r\n        this.stargateInterface = stargateInterface;\r\n        this.isVisible = false;\r\n        this.selectedSystem = null;\r\n        this.isTraveling = false;\r\n        this.isMobile = MobileDetector.isMobile();\r\n        \r\n        console.log(\"StarMap constructor - isMobile:\", this.isMobile);\r\n        \r\n        // Create star map UI\r\n        this.setupStarMapUI();\r\n        \r\n        // Set event handlers\r\n        this.setupEventHandlers();\r\n    }\r\n    \r\n    setupStarMapUI() {\r\n        // Create starmap container\r\n        const starMap = document.createElement('div');\r\n        starMap.id = 'star-map';\r\n        starMap.style.position = 'absolute';\r\n        starMap.style.top = '50%';\r\n        starMap.style.left = '50%';\r\n        starMap.style.transform = 'translate(-50%, -50%)';\r\n        \r\n        // Adjust size for mobile devices\r\n        if (this.isMobile) {\r\n            starMap.style.width = '95%';\r\n            starMap.style.height = '85vh'; // Reduced to ensure the button is visible\r\n            starMap.style.maxHeight = '700px';\r\n        } else {\r\n            starMap.style.width = '900px';\r\n            starMap.style.height = '700px';\r\n        }\r\n        \r\n        starMap.style.backgroundColor = 'rgba(10, 15, 30, 0.95)';\r\n        starMap.style.color = '#fff';\r\n        starMap.style.padding = this.isMobile ? '15px' : '30px';\r\n        starMap.style.borderRadius = '10px';\r\n        starMap.style.border = '2px solid #30cfd0';\r\n        starMap.style.boxShadow = '0 0 30px #30cfd0';\r\n        starMap.style.fontFamily = 'Courier New, monospace';\r\n        starMap.style.zIndex = '1500';\r\n        starMap.style.display = 'none';\r\n        starMap.style.overflow = 'hidden';\r\n        \r\n        // Create title\r\n        const title = document.createElement('h2');\r\n        title.textContent = 'STAR MAP';\r\n        title.style.textAlign = 'center';\r\n        title.style.color = '#30cfd0';\r\n        title.style.margin = '0 0 20px 0';\r\n        title.style.fontSize = this.isMobile ? '24px' : '28px';\r\n        starMap.appendChild(title);\r\n        \r\n        // Create map content container with flexible layout\r\n        const content = document.createElement('div');\r\n        content.style.display = 'flex';\r\n        content.style.flexDirection = this.isMobile ? 'column' : 'row';\r\n        content.style.height = this.isMobile ? 'calc(100% - 120px)' : 'calc(100% - 100px)';\r\n        content.style.gap = this.isMobile ? '15px' : '0';\r\n        \r\n        // Left column - System Map (stars and connections)\r\n        const mapContainer = document.createElement('div');\r\n        mapContainer.id = 'star-map-visual';\r\n        mapContainer.style.flex = '1';\r\n        mapContainer.style.background = 'rgba(0, 0, 0, 0.7)';\r\n        mapContainer.style.borderRadius = '10px';\r\n        mapContainer.style.border = '1px solid #30cfd0';\r\n        mapContainer.style.position = 'relative';\r\n        mapContainer.style.overflow = 'hidden';\r\n        mapContainer.style.height = this.isMobile ? '40%' : '100%';\r\n        mapContainer.style.minHeight = this.isMobile ? '250px' : 'auto';\r\n        \r\n        // Create canvas for map visualization\r\n        const canvas = document.createElement('canvas');\r\n        canvas.id = 'star-map-canvas';\r\n        canvas.width = 500;\r\n        canvas.height = 500;\r\n        canvas.style.width = '100%';\r\n        canvas.style.height = '100%';\r\n        mapContainer.appendChild(canvas);\r\n        \r\n        // Right column - System Information\r\n        const infoPanel = document.createElement('div');\r\n        infoPanel.id = 'system-info-panel';\r\n        infoPanel.style.width = this.isMobile ? '100%' : '350px';\r\n        infoPanel.style.marginLeft = this.isMobile ? '0' : '20px';\r\n        infoPanel.style.overflowY = 'auto';\r\n        infoPanel.style.height = this.isMobile ? '60%' : '100%';\r\n        infoPanel.style.webkitOverflowScrolling = 'touch'; // For smooth scrolling on iOS\r\n        \r\n        // Current system section\r\n        const currentSystem = document.createElement('div');\r\n        currentSystem.id = 'current-system-info';\r\n        currentSystem.innerHTML = `\r\n            <h3 style=\"color: #30cfd0; margin-top: 0; font-size: ${this.isMobile ? '16px' : '18px'};\">CURRENT SYSTEM</h3>\r\n            <div class=\"system-card\" style=\"background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 5px; border: 1px solid #30cfd0; margin-bottom: 20px;\">\r\n                <div id=\"current-system-name\" style=\"font-size: ${this.isMobile ? '16px' : '18px'}; font-weight: bold; color: #fff; margin-bottom: 5px;\">Solar System</div>\r\n                <div id=\"current-system-class\" style=\"font-size: ${this.isMobile ? '12px' : '14px'}; color: #aaa; margin-bottom: 10px;\">Class G - Home System</div>\r\n                <div id=\"current-system-resources\" style=\"margin-bottom: 10px;\">\r\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\r\n                        <span>Iron:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div id=\"current-iron-indicator\" style=\"height: 100%; width: 50%; background: #aaa;\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\r\n                        <span>Gold:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div id=\"current-gold-indicator\" style=\"height: 100%; width: 50%; background: #FFD700;\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div style=\"display: flex; justify-content: space-between;\">\r\n                        <span>Platinum:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div id=\"current-platinum-indicator\" style=\"height: 100%; width: 50%; background: #E5E4E2;\"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div id=\"current-system-description\" style=\"font-size: ${this.isMobile ? '11px' : '12px'}; color: #ccc; margin-bottom: 10px;\">\r\n                    Our home system, with Earth as the starting location.\r\n                </div>\r\n                <div id=\"current-system-features\" style=\"font-size: ${this.isMobile ? '11px' : '12px'}; color: #30cfd0;\">\r\n                    Special Features: Earth\r\n                </div>\r\n            </div>\r\n        `;\r\n        infoPanel.appendChild(currentSystem);\r\n        \r\n        // Selected system section\r\n        const selectedSystem = document.createElement('div');\r\n        selectedSystem.id = 'selected-system-info';\r\n        selectedSystem.innerHTML = `\r\n            <h3 style=\"color: #30cfd0; font-size: ${this.isMobile ? '16px' : '18px'};\">SELECTED SYSTEM</h3>\r\n            <div id=\"selected-system-card\" class=\"system-card\" style=\"background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 5px; border: 1px solid #555; margin-bottom: 20px;\">\r\n                <div class=\"empty-selection\" style=\"color: #777; text-align: center; padding: 20px;\">\r\n                    No system selected.<br>\r\n                    ${this.isMobile ? 'Tap' : 'Click'} on a star system in the map to select it.\r\n                </div>\r\n            </div>\r\n            <button id=\"travel-button\" disabled style=\"width: 100%; padding: ${this.isMobile ? '15px' : '12px'}; background-color: #30cfd0; color: #000; border: none; border-radius: 5px; cursor: not-allowed; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile ? '18px' : '16px'}; opacity: 0.5;\">\r\n                TRAVEL TO SYSTEM\r\n            </button>\r\n        `;\r\n        infoPanel.appendChild(selectedSystem);\r\n        \r\n        // Add all elements to the map\r\n        content.appendChild(mapContainer);\r\n        content.appendChild(infoPanel);\r\n        starMap.appendChild(content);\r\n        \r\n        // Close button\r\n        const closeButton = document.createElement('button');\r\n        closeButton.id = 'close-star-map';\r\n        closeButton.textContent = 'RETURN TO STARGATE';\r\n        closeButton.style.width = '100%';\r\n        closeButton.style.padding = this.isMobile ? '15px' : '12px';\r\n        closeButton.style.marginTop = '20px';\r\n        closeButton.style.backgroundColor = '#555';\r\n        closeButton.style.color = '#fff';\r\n        closeButton.style.border = 'none';\r\n        closeButton.style.borderRadius = '5px';\r\n        closeButton.style.cursor = 'pointer';\r\n        closeButton.style.fontFamily = 'Courier New, monospace';\r\n        closeButton.style.fontWeight = 'bold';\r\n        closeButton.style.fontSize = this.isMobile ? '18px' : '16px';\r\n        \r\n        // Make the button more prominent on mobile\r\n        if (this.isMobile) {\r\n            closeButton.style.backgroundColor = '#30cfd0';\r\n            closeButton.style.color = '#000';\r\n            closeButton.style.boxShadow = '0 0 15px rgba(48, 207, 208, 0.7)';\r\n        }\r\n        \r\n        starMap.appendChild(closeButton);\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(starMap);\r\n    }\r\n    \r\n    setupEventHandlers() {\r\n        // Close button\r\n        const closeButton = document.getElementById('close-star-map');\r\n        if (closeButton) {\r\n            closeButton.addEventListener('click', () => {\r\n                if (window.game && window.game.audio) {\r\n                    window.game.audio.playSound('boink');\r\n                }\r\n                this.hide();\r\n            });\r\n            \r\n            // Add touch event for mobile\r\n            if (this.isMobile) {\r\n                closeButton.addEventListener('touchend', (e) => {\r\n                    e.preventDefault();\r\n                    if (window.game && window.game.audio) {\r\n                        console.log(\"Mobile: Playing sound on star map close button\");\r\n                        window.game.audio.playSound('boink');\r\n                        // Give time for the sound to start before hiding\r\n                        setTimeout(() => this.hide(), 50);\r\n                    } else {\r\n                        this.hide();\r\n                    }\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Canvas click/touch handler for selecting systems\r\n        const canvas = document.getElementById('star-map-canvas');\r\n        if (canvas) {\r\n            // Mouse events\r\n            canvas.addEventListener('click', (e) => {\r\n                this.handleMapInteraction(e);\r\n            });\r\n            \r\n            // Touch events for mobile\r\n            if (this.isMobile) {\r\n                canvas.addEventListener('touchend', (e) => {\r\n                    e.preventDefault();\r\n                    this.handleMapInteraction(e.changedTouches[0]);\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Travel button\r\n        const travelButton = document.getElementById('travel-button');\r\n        if (travelButton) {\r\n            const travelHandler = () => {\r\n                if (this.selectedSystem && this.selectedSystem !== this.starSystemGenerator.currentSystem) {\r\n                    console.log(`Initiating travel to system: ${this.selectedSystem}`);\r\n                    \r\n                    // Set traveling flag before hiding the star map\r\n                    this.isTraveling = true;\r\n                    \r\n                    // Close the star map first\r\n                    this.hide();\r\n                    \r\n                    // Find the environment object to properly handle transition\r\n                    const environment = window.game.environment;\r\n                    if (environment && environment.travelToSystem) {\r\n                        const success = environment.travelToSystem(this.selectedSystem);\r\n                        console.log(`Travel to ${this.selectedSystem} initiated: ${success}`);\r\n                        \r\n                        // Reset traveling flag after travel is complete\r\n                        setTimeout(() => {\r\n                            this.isTraveling = false;\r\n                        }, 5000); // Wait for transition to complete\r\n                    } else {\r\n                        // Fallback to direct use of starSystemGenerator\r\n                        const success = this.starSystemGenerator.travelToSystem(this.selectedSystem);\r\n                        \r\n                        if (success) {\r\n                            // Update UI\r\n                            this.updateCurrentSystemInfo();\r\n                            this.updateCanvas();\r\n                            \r\n                            // Reset selection\r\n                            this.selectSystem(null);\r\n                            \r\n                            // Notify the user\r\n                            this.showTravelNotification(this.starSystemGenerator.getCurrentSystemData().name);\r\n                            \r\n                            // Reset traveling flag\r\n                            this.isTraveling = false;\r\n                        }\r\n                    }\r\n                }\r\n            };\r\n            \r\n            // Click event\r\n            travelButton.addEventListener('click', travelHandler);\r\n            \r\n            // Touch event for mobile\r\n            if (this.isMobile) {\r\n                travelButton.addEventListener('touchend', (e) => {\r\n                    e.preventDefault();\r\n                    travelHandler();\r\n                });\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Handler for map interactions (click or touch)\r\n    handleMapInteraction(event) {\r\n        // Convert click/touch position to canvas coordinates\r\n        const canvas = document.getElementById('star-map-canvas');\r\n        const rect = canvas.getBoundingClientRect();\r\n        const x = (event.clientX - rect.left) * (canvas.width / rect.width);\r\n        const y = (event.clientY - rect.top) * (canvas.height / rect.height);\r\n        \r\n        // Check if a star system was clicked/tapped\r\n        const clickedSystem = this.findSystemAtPosition(x, y);\r\n        if (clickedSystem) {\r\n            this.selectSystem(clickedSystem);\r\n            this.updateCanvas(); // Redraw to show selection\r\n        }\r\n    }\r\n    \r\n    // Find which system was clicked (if any)\r\n    findSystemAtPosition(x, y) {\r\n        const systems = this.starSystemGenerator.getAllSystems();\r\n        const currentSystem = this.starSystemGenerator.currentSystem;\r\n        \r\n        // Define the center of the canvas\r\n        const centerX = 250;\r\n        const centerY = 250;\r\n        \r\n        // Check each system\r\n        for (const [systemId, system] of Object.entries(systems)) {\r\n            // Convert system position to canvas position\r\n            const canvasX = centerX + system.position.x;\r\n            const canvasY = centerY + system.position.y;\r\n            \r\n            // Calculate distance from click to star\r\n            const dx = x - canvasX;\r\n            const dy = y - canvasY;\r\n            const distance = Math.sqrt(dx * dx + dy * dy);\r\n            \r\n            // If click is within the star's radius (make current system bigger)\r\n            // Use larger tap area for mobile\r\n            const radius = systemId === currentSystem ? \r\n                          (this.isMobile ? 20 : 15) : \r\n                          (this.isMobile ? 15 : 10);\r\n            if (distance <= radius) {\r\n                return systemId;\r\n            }\r\n        }\r\n        \r\n        return null;\r\n    }\r\n    \r\n    // Select a system and update the UI\r\n    selectSystem(systemId) {\r\n        console.log(`Selecting system: ${systemId}`);\r\n        this.selectedSystem = systemId;\r\n        \r\n        if (!systemId) {\r\n            // Clear selection\r\n            const selectedCard = document.getElementById('selected-system-card');\r\n            if (selectedCard) {\r\n                selectedCard.innerHTML = `\r\n                    <div class=\"empty-selection\" style=\"color: #777; text-align: center; padding: 20px;\">\r\n                        No system selected.<br>${this.isMobile ? 'Tap' : 'Click'} on a star system in the map to select it.\r\n                    </div>\r\n                `;\r\n            }\r\n            \r\n            // Disable travel button\r\n            const travelButton = document.getElementById('travel-button');\r\n            if (travelButton) {\r\n                travelButton.disabled = true;\r\n                travelButton.style.cursor = 'not-allowed';\r\n                travelButton.style.opacity = '0.5';\r\n            }\r\n            \r\n            return;\r\n        }\r\n        \r\n        // Get system data\r\n        const system = this.starSystemGenerator.getAllSystems()[systemId];\r\n        const currentSystem = this.starSystemGenerator.currentSystem;\r\n        \r\n        // Update selected system info card\r\n        const selectedCard = document.getElementById('selected-system-card');\r\n        if (selectedCard && system) {\r\n            selectedCard.innerHTML = `\r\n                <div id=\"selected-system-name\" style=\"font-size: ${this.isMobile ? '16px' : '18px'}; font-weight: bold; color: #fff; margin-bottom: 5px;\">${system.name}</div>\r\n                <div id=\"selected-system-class\" style=\"font-size: ${this.isMobile ? '12px' : '14px'}; color: #aaa; margin-bottom: 10px;\">Class ${system.starClass} - ${system.classification}</div>\r\n                <div id=\"selected-system-resources\" style=\"margin-bottom: 10px;\">\r\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\r\n                        <span>Iron:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div style=\"height: 100%; width: ${system.resourceMultipliers.iron * 50}%; background: #aaa;\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 5px;\">\r\n                        <span>Gold:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div style=\"height: 100%; width: ${system.resourceMultipliers.gold * 50}%; background: #FFD700;\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <div style=\"display: flex; justify-content: space-between;\">\r\n                        <span>Platinum:</span>\r\n                        <div class=\"resource-indicator\" style=\"width: 100px; height: 8px; background: #333; border-radius: 4px; overflow: hidden;\">\r\n                            <div style=\"height: 100%; width: ${system.resourceMultipliers.platinum * 50}%; background: #E5E4E2;\"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div style=\"font-size: ${this.isMobile ? '11px' : '12px'}; color: #ccc; margin-bottom: 10px;\">\r\n                    ${system.description}\r\n                </div>\r\n                <div style=\"font-size: ${this.isMobile ? '11px' : '12px'}; color: #30cfd0;\">\r\n                    Special Features: ${system.specialFeatures.join(', ')}\r\n                </div>\r\n            `;\r\n            \r\n            // Scroll to make selected system info visible on mobile\r\n            if (this.isMobile) {\r\n                const infoPanel = document.getElementById('system-info-panel');\r\n                if (infoPanel) {\r\n                    infoPanel.scrollTop = selectedCard.offsetTop - infoPanel.offsetTop;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Enable/disable travel button\r\n        const travelButton = document.getElementById('travel-button');\r\n        if (travelButton) {\r\n            // Only enable if not current system and is connected to current\r\n            const isConnected = this.starSystemGenerator.getCurrentSystemConnections().includes(systemId);\r\n            const isCurrentSystem = systemId === currentSystem;\r\n            \r\n            travelButton.disabled = isCurrentSystem || !isConnected;\r\n            travelButton.style.cursor = isCurrentSystem || !isConnected ? 'not-allowed' : 'pointer';\r\n            travelButton.style.opacity = isCurrentSystem || !isConnected ? '0.5' : '1';\r\n            \r\n            // Update button text\r\n            travelButton.textContent = isCurrentSystem ? 'CURRENT LOCATION' : \r\n                                      !isConnected ? 'NO DIRECT ROUTE' : 'TRAVEL TO SYSTEM';\r\n        }\r\n    }\r\n    \r\n    // Draw the star map on the canvas\r\n    updateCanvas() {\r\n        const canvas = document.getElementById('star-map-canvas');\r\n        if (!canvas) return;\r\n        \r\n        const ctx = canvas.getContext('2d');\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        \r\n        // Define the center of the canvas\r\n        const centerX = canvas.width / 2;\r\n        const centerY = canvas.height / 2;\r\n        \r\n        // Get systems data\r\n        const systems = this.starSystemGenerator.getAllSystems();\r\n        const currentSystem = this.starSystemGenerator.currentSystem;\r\n        const connections = this.starSystemGenerator.warpGates;\r\n        \r\n        // First draw connections\r\n        ctx.lineWidth = 1;\r\n        ctx.strokeStyle = 'rgba(48, 207, 208, 0.4)';\r\n        \r\n        for (const [systemId, connectedSystems] of Object.entries(connections)) {\r\n            const system = systems[systemId];\r\n            if (!system) continue;\r\n            \r\n            // Convert system position to canvas position\r\n            const x1 = centerX + system.position.x;\r\n            const y1 = centerY + system.position.y;\r\n            \r\n            for (const connectedId of connectedSystems) {\r\n                const connectedSystem = systems[connectedId];\r\n                if (!connectedSystem) continue;\r\n                \r\n                // Convert connected system position to canvas position\r\n                const x2 = centerX + connectedSystem.position.x;\r\n                const y2 = centerY + connectedSystem.position.y;\r\n                \r\n                // Draw the connection\r\n                ctx.beginPath();\r\n                ctx.moveTo(x1, y1);\r\n                ctx.lineTo(x2, y2);\r\n                ctx.stroke();\r\n            }\r\n        }\r\n        \r\n        // Highlight connections from current system\r\n        if (currentSystem && systems[currentSystem]) {\r\n            const currentSystemData = systems[currentSystem];\r\n            const x1 = centerX + currentSystemData.position.x;\r\n            const y1 = centerY + currentSystemData.position.y;\r\n            \r\n            ctx.lineWidth = this.isMobile ? 3 : 2;\r\n            ctx.strokeStyle = 'rgba(48, 207, 208, 0.8)';\r\n            \r\n            for (const connectedId of currentSystemData.connections) {\r\n                const connectedSystem = systems[connectedId];\r\n                if (!connectedSystem) continue;\r\n                \r\n                // Convert connected system position to canvas position\r\n                const x2 = centerX + connectedSystem.position.x;\r\n                const y2 = centerY + connectedSystem.position.y;\r\n                \r\n                // Draw the connection\r\n                ctx.beginPath();\r\n                ctx.moveTo(x1, y1);\r\n                ctx.lineTo(x2, y2);\r\n                ctx.stroke();\r\n            }\r\n        }\r\n        \r\n        // Now draw systems\r\n        for (const [systemId, system] of Object.entries(systems)) {\r\n            // Convert system position to canvas position\r\n            const x = centerX + system.position.x;\r\n            const y = centerY + system.position.y;\r\n            \r\n            // Determine if it's the current system, selected system, or regular\r\n            const isCurrent = systemId === currentSystem;\r\n            const isSelected = systemId === this.selectedSystem;\r\n            const isConnected = currentSystem && systems[currentSystem] && \r\n                                systems[currentSystem].connections.includes(systemId);\r\n            \r\n            // Draw a circle for the system\r\n            ctx.beginPath();\r\n            \r\n            // Size based on status and device\r\n            let radius;\r\n            if (this.isMobile) {\r\n                radius = isCurrent ? 18 : isSelected ? 15 : 10;\r\n            } else {\r\n                radius = isCurrent ? 15 : isSelected ? 12 : 8;\r\n            }\r\n            \r\n            // Fill color based on star class\r\n            ctx.fillStyle = system.starColor ? `#${system.starColor.toString(16).padStart(6, '0')}` : '#ffffff';\r\n            \r\n            // Add glow for current and selected\r\n            if (isCurrent || isSelected) {\r\n                ctx.shadowBlur = this.isMobile ? 20 : 15;\r\n                ctx.shadowColor = isCurrent ? '#30cfd0' : '#ffffff';\r\n            } else {\r\n                ctx.shadowBlur = 0;\r\n            }\r\n            \r\n            // Draw the star\r\n            ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n            ctx.fill();\r\n            \r\n            // Reset shadow\r\n            ctx.shadowBlur = 0;\r\n            \r\n            // Draw border for connected systems\r\n            if (isConnected && !isCurrent) {\r\n                ctx.strokeStyle = '#30cfd0';\r\n                ctx.lineWidth = this.isMobile ? 3 : 2;\r\n                ctx.beginPath();\r\n                ctx.arc(x, y, radius + 3, 0, Math.PI * 2);\r\n                ctx.stroke();\r\n            }\r\n            \r\n            // Draw name label\r\n            ctx.fillStyle = isCurrent ? '#30cfd0' : isSelected ? '#ffffff' : '#aaaaaa';\r\n            ctx.font = isCurrent ? \r\n                      (this.isMobile ? 'bold 14px Courier New' : 'bold 12px Courier New') : \r\n                      (this.isMobile ? '12px Courier New' : '10px Courier New');\r\n            ctx.textAlign = 'center';\r\n            ctx.fillText(system.name, x, y + radius + (this.isMobile ? 18 : 15));\r\n        }\r\n    }\r\n    \r\n    // Show travel notification\r\n    showTravelNotification(systemName) {\r\n        // Create notification element\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = this.isMobile ? '30%' : '20%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#30cfd0';\r\n        notification.style.padding = this.isMobile ? '15px 30px' : '20px 40px';\r\n        notification.style.borderRadius = '10px';\r\n        notification.style.border = '2px solid #30cfd0';\r\n        notification.style.boxShadow = '0 0 30px #30cfd0';\r\n        notification.style.fontFamily = 'Courier New, monospace';\r\n        notification.style.fontSize = this.isMobile ? '18px' : '20px';\r\n        notification.style.fontWeight = 'bold';\r\n        notification.style.zIndex = '9999';\r\n        notification.style.textAlign = 'center';\r\n        notification.textContent = `ARRIVED AT ${systemName}`;\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(notification);\r\n        \r\n        // Remove after a few seconds\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 1s';\r\n            \r\n            setTimeout(() => {\r\n                notification.remove();\r\n            }, 1000);\r\n        }, 3000);\r\n    }\r\n    \r\n    // Update the current system information\r\n    updateCurrentSystemInfo() {\r\n        const system = this.starSystemGenerator.getCurrentSystemData();\r\n        if (!system) return;\r\n        \r\n        // Update system name and class\r\n        document.getElementById('current-system-name').textContent = system.name;\r\n        document.getElementById('current-system-class').textContent = `Class ${system.starClass} - ${system.classification}`;\r\n        \r\n        // Update resource indicators\r\n        document.getElementById('current-iron-indicator').style.width = `${system.resourceMultipliers.iron * 50}%`;\r\n        document.getElementById('current-gold-indicator').style.width = `${system.resourceMultipliers.gold * 50}%`;\r\n        document.getElementById('current-platinum-indicator').style.width = `${system.resourceMultipliers.platinum * 50}%`;\r\n        \r\n        // Update description and features\r\n        document.getElementById('current-system-description').textContent = system.description;\r\n        document.getElementById('current-system-features').textContent = `Special Features: ${system.specialFeatures.join(', ')}`;\r\n    }\r\n    \r\n    // Show the star map\r\n    show() {\r\n        // Update the map with current data\r\n        this.updateCurrentSystemInfo();\r\n        this.updateCanvas();\r\n        \r\n        // Reset selection\r\n        this.selectSystem(null);\r\n        \r\n        // Force audio context resumption for mobile\r\n        if (this.isMobile && window.game && window.game.audio) {\r\n            // Play a sound to kickstart the audio context\r\n            setTimeout(() => {\r\n                console.log(\"Mobile: Attempting to play initial sound in StarMap\");\r\n                window.game.audio.playSound('boink');\r\n            }, 100);\r\n        }\r\n        \r\n        // Show the map\r\n        const starMap = document.getElementById('star-map');\r\n        if (starMap) {\r\n            starMap.style.display = 'block';\r\n            this.isVisible = true;\r\n        }\r\n    }\r\n    \r\n    // Hide the star map\r\n    hide() {\r\n        const starMap = document.getElementById('star-map');\r\n        if (starMap) {\r\n            starMap.style.display = 'none';\r\n            this.isVisible = false;\r\n            \r\n            // Show the stargate UI when returning from star map\r\n            if (this.stargateInterface) {\r\n                this.stargateInterface.showStargateUI();\r\n            } else if (window.game && window.game.ui && window.game.ui.stargateInterface) {\r\n                // Try to find stargate UI via game instance if direct reference fails\r\n                window.game.ui.stargateInterface.showStargateUI();\r\n            } else {\r\n                // Direct DOM access as last resort\r\n                const stargateUI = document.getElementById('stargate-ui');\r\n                if (stargateUI) {\r\n                    stargateUI.style.display = 'block';\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Toggle map visibility\r\n    toggle() {\r\n        if (this.isVisible) {\r\n            this.hide();\r\n        } else {\r\n            this.show();\r\n        }\r\n    }\r\n}","/**\r\n * Blackjack Minigame - A futuristic card game for the stargate terminal\r\n * \r\n * Features:\r\n * - Space-themed card designs with futuristic symbols\r\n * - Wager ship resources (Iron, Gold, Platinum)\r\n * - Play against an AI dealer with pirate personality\r\n * - Holographic UI with neon effects\r\n */\r\n\r\nimport { MobileDetector } from '../../utils/mobileDetector.js';\r\n\r\nexport class BlackjackGame {\r\n    constructor(scene, spaceship, audio) {\r\n        this.scene = scene;\r\n        this.spaceship = spaceship;\r\n        this.audio = audio;\r\n        this.isMobile = MobileDetector.isMobile();\r\n\r\n        console.log(\"BlackjackGame constructor - spaceship:\", this.spaceship);\r\n        console.log(\"BlackjackGame constructor - cargo:\", this.spaceship ? this.spaceship.cargo : null);\r\n        console.log(\"BlackjackGame constructor - isMobile:\", this.isMobile);\r\n        \r\n        // Game state\r\n        this.gameActive = false;\r\n        this.currentBet = {\r\n            resource: null,\r\n            amount: 0\r\n        };\r\n        this.playerHand = [];\r\n        this.dealerHand = [];\r\n        this.deck = [];\r\n        this.gameResult = null;\r\n        \r\n        // Card symbols\r\n        this.cardSymbols = {\r\n            spades: '♠', // Asteroid symbol\r\n            hearts: '♥', // Planet symbol\r\n            clubs: '♣', // Star symbol\r\n            diamonds: '♦' // Nebula symbol\r\n        };\r\n        \r\n        // Dealer personality phrases\r\n        this.dealerPhrases = {\r\n            win: [\r\n                \"Yarr! The cosmos favors ye today!\",\r\n                \"By the stars! Ye've bested me!\",\r\n                \"Void take me! Ye've got luck in yer tanks!\",\r\n                \"Stellar victory, spacer!\",\r\n                \"Blast me thrusters! Ye win this round!\"\r\n            ],\r\n            lose: [\r\n                \"The black hole claims another victim!\",\r\n                \"Better luck in the next galaxy, rookie!\",\r\n                \"Space is cold, and so is defeat!\",\r\n                \"Yarr! The dealer always wins, spacer!\",\r\n                \"Back to the asteroid mines with ye!\"\r\n            ],\r\n            blackjack: [\r\n                \"SUPERNOVA! A cosmic blackjack!\",\r\n                \"By the void! A perfect 21!\",\r\n                \"The stars aligned for ye today!\",\r\n                \"Quantum perfection! A blackjack!\"\r\n            ],\r\n            push: [\r\n                \"A cosmic stalemate, eh?\",\r\n                \"The universe remains in balance.\",\r\n                \"Neither winner nor loser in the void.\",\r\n                \"We split the cosmic dust this time.\"\r\n            ]\r\n        };\r\n        \r\n        // UI elements\r\n        this.gameUI = null;\r\n    }\r\n    \r\n    /**\r\n     * Initialize the game UI\r\n     */\r\n    init() {\r\n        // Create game UI if it doesn't exist\r\n        if (!this.gameUI) {\r\n            this.createGameUI();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Create the game UI elements\r\n     */\r\n    createGameUI() {\r\n        // Create main container\r\n        this.gameUI = document.createElement('div');\r\n        this.gameUI.id = 'blackjack-game';\r\n        this.gameUI.style.position = 'absolute';\r\n        this.gameUI.style.top = '50%';\r\n        this.gameUI.style.left = '50%';\r\n        this.gameUI.style.transform = 'translate(-50%, -50%)';\r\n        \r\n        // Adjust width for mobile\r\n        if (this.isMobile) {\r\n            this.gameUI.style.width = '95%';\r\n            this.gameUI.style.maxWidth = '600px';\r\n            this.gameUI.style.height = 'auto';\r\n            this.gameUI.style.maxHeight = '85vh'; // Slightly reduced to ensure buttons are visible\r\n        } else {\r\n            this.gameUI.style.width = '900px';\r\n            this.gameUI.style.height = '650px';\r\n        }\r\n        \r\n        this.gameUI.style.backgroundColor = 'rgba(6, 22, 31, 0.85)';\r\n        this.gameUI.style.backdropFilter = 'blur(10px)';\r\n        this.gameUI.style.border = '2px solid #33aaff';\r\n        this.gameUI.style.borderRadius = '15px';\r\n        this.gameUI.style.boxShadow = '0 0 30px rgba(51, 170, 255, 0.5)';\r\n        this.gameUI.style.padding = this.isMobile ? '15px' : '25px';\r\n        this.gameUI.style.zIndex = '1000';\r\n        this.gameUI.style.display = 'none';\r\n        this.gameUI.style.fontFamily = 'Courier New, monospace';\r\n        this.gameUI.style.color = '#fff';\r\n        this.gameUI.style.userSelect = 'none';\r\n        this.gameUI.style.overflowY = this.isMobile ? 'auto' : 'hidden';\r\n        \r\n        // Add mobile scroll handling\r\n        if (this.isMobile) {\r\n            this.gameUI.style.webkitOverflowScrolling = 'touch';\r\n            this.gameUI.style.touchAction = 'pan-y';\r\n            this.gameUI.style.overscrollBehavior = 'contain';\r\n        }\r\n        \r\n        // Add scanline effect\r\n        const scanlines = document.createElement('div');\r\n        scanlines.style.position = 'absolute';\r\n        scanlines.style.top = '0';\r\n        scanlines.style.left = '0';\r\n        scanlines.style.width = '100%';\r\n        scanlines.style.height = '100%';\r\n        scanlines.style.backgroundImage = 'linear-gradient(transparent 50%, rgba(0, 0, 0, 0.1) 50%)';\r\n        scanlines.style.backgroundSize = '100% 4px';\r\n        scanlines.style.pointerEvents = 'none';\r\n        scanlines.style.zIndex = '1001';\r\n        scanlines.style.opacity = '0.15';\r\n        this.gameUI.appendChild(scanlines);\r\n        \r\n        // Header\r\n        const header = document.createElement('div');\r\n        header.style.textAlign = 'center';\r\n        header.style.marginBottom = '20px';\r\n        header.style.position = 'relative';\r\n        \r\n        const title = document.createElement('h2');\r\n        title.textContent = 'STELLAR BLACKJACK';\r\n        title.style.color = '#30cfd0';\r\n        title.style.textShadow = '0 0 10px rgba(48, 207, 208, 0.7)';\r\n        title.style.margin = '0 0 5px 0';\r\n        title.style.fontSize = this.isMobile ? '24px' : '32px';\r\n        header.appendChild(title);\r\n        \r\n        const subtitle = document.createElement('div');\r\n        subtitle.textContent = 'WAGER RESOURCES • WIN BIG • BEAT THE DEALER';\r\n        subtitle.style.color = 'rgba(255, 255, 255, 0.6)';\r\n        subtitle.style.fontSize = this.isMobile ? '12px' : '14px';\r\n        subtitle.style.letterSpacing = '2px';\r\n        header.appendChild(subtitle);\r\n        \r\n        // Close button\r\n        const closeBtn = document.createElement('button');\r\n        closeBtn.textContent = '×';\r\n        closeBtn.style.position = 'absolute';\r\n        closeBtn.style.top = '0';\r\n        closeBtn.style.right = '0';\r\n        closeBtn.style.backgroundColor = 'transparent';\r\n        closeBtn.style.border = 'none';\r\n        closeBtn.style.color = '#33aaff';\r\n        closeBtn.style.fontSize = '32px';\r\n        closeBtn.style.cursor = 'pointer';\r\n        closeBtn.style.outline = 'none';\r\n        closeBtn.style.padding = '0 10px';\r\n        closeBtn.style.lineHeight = '1';\r\n        closeBtn.onclick = () => this.hide();\r\n        \r\n        // Make close button larger and more visible for touch on mobile\r\n        if (this.isMobile) {\r\n            closeBtn.style.fontSize = '42px';\r\n            closeBtn.style.padding = '5px 15px';\r\n            closeBtn.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';\r\n            closeBtn.style.borderRadius = '50%';\r\n            closeBtn.style.width = '50px';\r\n            closeBtn.style.height = '50px';\r\n            closeBtn.style.display = 'flex';\r\n            closeBtn.style.justifyContent = 'center';\r\n            closeBtn.style.alignItems = 'center';\r\n            closeBtn.style.boxShadow = '0 0 10px rgba(51, 170, 255, 0.5)';\r\n            closeBtn.style.right = '5px';\r\n            closeBtn.style.top = '5px';\r\n        }\r\n        \r\n        header.appendChild(closeBtn);\r\n        \r\n        this.gameUI.appendChild(header);\r\n        \r\n        // Game area container\r\n        const gameArea = document.createElement('div');\r\n        gameArea.style.display = 'flex';\r\n        gameArea.style.flexDirection = 'column';\r\n        gameArea.style.height = this.isMobile ? 'auto' : 'calc(100% - 80px)';\r\n        \r\n        // Dealer area\r\n        const dealerArea = document.createElement('div');\r\n        dealerArea.style.flex = '1';\r\n        dealerArea.style.border = '1px solid rgba(51, 170, 255, 0.3)';\r\n        dealerArea.style.borderRadius = '8px';\r\n        dealerArea.style.padding = '15px';\r\n        dealerArea.style.marginBottom = '15px';\r\n        dealerArea.style.position = 'relative';\r\n        dealerArea.style.background = 'linear-gradient(to bottom, rgba(9, 30, 42, 0.6), rgba(9, 30, 42, 0.4))';\r\n        \r\n        // Dealer header\r\n        const dealerHeader = document.createElement('div');\r\n        dealerHeader.className = 'dealer-header';\r\n        dealerHeader.style.display = 'flex';\r\n        dealerHeader.style.justifyContent = 'space-between';\r\n        dealerHeader.style.marginBottom = '10px';\r\n        \r\n        const dealerTitle = document.createElement('div');\r\n        dealerTitle.textContent = 'DEALER';\r\n        dealerTitle.style.color = '#33aaff';\r\n        dealerTitle.style.fontWeight = 'bold';\r\n        dealerHeader.appendChild(dealerTitle);\r\n        \r\n        const dealerScore = document.createElement('div');\r\n        dealerScore.id = 'dealer-score';\r\n        dealerScore.textContent = '0';\r\n        dealerScore.style.color = '#fff';\r\n        dealerScore.style.fontWeight = 'bold';\r\n        dealerScore.style.backgroundColor = 'rgba(51, 170, 255, 0.2)';\r\n        dealerScore.style.padding = '0 10px';\r\n        dealerScore.style.borderRadius = '4px';\r\n        dealerHeader.appendChild(dealerScore);\r\n        \r\n        dealerArea.appendChild(dealerHeader);\r\n        \r\n        // Dealer cards container\r\n        const dealerCards = document.createElement('div');\r\n        dealerCards.id = 'dealer-cards';\r\n        dealerCards.style.display = 'flex';\r\n        dealerCards.style.gap = '15px';\r\n        dealerCards.style.flexWrap = 'wrap';\r\n        dealerCards.style.height = this.isMobile ? 'auto' : '130px';\r\n        dealerCards.style.minHeight = this.isMobile ? '120px' : '130px';\r\n        dealerArea.appendChild(dealerCards);\r\n        \r\n        // Dealer speech bubble\r\n        const speechBubble = document.createElement('div');\r\n        speechBubble.id = 'dealer-speech';\r\n        speechBubble.style.position = this.isMobile ? 'relative' : 'absolute';\r\n        speechBubble.style.bottom = this.isMobile ? 'auto' : '15px';\r\n        speechBubble.style.right = this.isMobile ? 'auto' : '15px';\r\n        speechBubble.style.marginTop = this.isMobile ? '10px' : '0';\r\n        speechBubble.style.backgroundColor = 'rgba(15, 40, 55, 0.9)';\r\n        speechBubble.style.border = '1px solid #33aaff';\r\n        speechBubble.style.borderRadius = '8px';\r\n        speechBubble.style.padding = '10px 15px';\r\n        speechBubble.style.maxWidth = this.isMobile ? '100%' : '300px';\r\n        speechBubble.style.fontStyle = 'italic';\r\n        speechBubble.style.color = '#fff';\r\n        speechBubble.style.boxShadow = '0 0 10px rgba(51, 170, 255, 0.3)';\r\n        speechBubble.style.display = 'none';\r\n        dealerArea.appendChild(speechBubble);\r\n        \r\n        gameArea.appendChild(dealerArea);\r\n        \r\n        // Middle area - Game status\r\n        const statusArea = document.createElement('div');\r\n        statusArea.style.height = '60px';\r\n        statusArea.style.display = 'flex';\r\n        statusArea.style.justifyContent = 'center';\r\n        statusArea.style.alignItems = 'center';\r\n        statusArea.style.marginBottom = '15px';\r\n        \r\n        const gameStatus = document.createElement('div');\r\n        gameStatus.id = 'game-status';\r\n        gameStatus.style.padding = '8px 20px';\r\n        gameStatus.style.borderRadius = '20px';\r\n        gameStatus.style.backgroundColor = 'rgba(51, 170, 255, 0.2)';\r\n        gameStatus.style.border = '1px solid rgba(51, 170, 255, 0.4)';\r\n        gameStatus.style.color = '#fff';\r\n        gameStatus.style.textAlign = 'center';\r\n        gameStatus.style.fontWeight = 'bold';\r\n        gameStatus.style.letterSpacing = '1px';\r\n        gameStatus.style.fontSize = this.isMobile ? '12px' : '14px';\r\n        gameStatus.style.width = this.isMobile ? '100%' : 'auto';\r\n        gameStatus.textContent = 'PLACE YOUR BET TO BEGIN';\r\n        statusArea.appendChild(gameStatus);\r\n        \r\n        gameArea.appendChild(statusArea);\r\n        \r\n        // Player area\r\n        const playerArea = document.createElement('div');\r\n        playerArea.style.flex = '1';\r\n        playerArea.style.border = '1px solid rgba(51, 170, 255, 0.3)';\r\n        playerArea.style.borderRadius = '8px';\r\n        playerArea.style.padding = '15px';\r\n        playerArea.style.marginBottom = '15px';\r\n        playerArea.style.background = 'linear-gradient(to bottom, rgba(9, 30, 42, 0.4), rgba(9, 30, 42, 0.6))';\r\n        \r\n        // Player header\r\n        const playerHeader = document.createElement('div');\r\n        playerHeader.className = 'player-header';\r\n        playerHeader.style.display = 'flex';\r\n        playerHeader.style.justifyContent = 'space-between';\r\n        playerHeader.style.marginBottom = '10px';\r\n        \r\n        const playerTitle = document.createElement('div');\r\n        playerTitle.textContent = 'YOUR HAND';\r\n        playerTitle.style.color = '#30cfd0';\r\n        playerTitle.style.fontWeight = 'bold';\r\n        playerHeader.appendChild(playerTitle);\r\n        \r\n        const playerScore = document.createElement('div');\r\n        playerScore.id = 'player-score';\r\n        playerScore.textContent = '0';\r\n        playerScore.style.color = '#fff';\r\n        playerScore.style.fontWeight = 'bold';\r\n        playerScore.style.backgroundColor = 'rgba(48, 207, 208, 0.2)';\r\n        playerScore.style.padding = '0 10px';\r\n        playerScore.style.borderRadius = '4px';\r\n        playerHeader.appendChild(playerScore);\r\n        \r\n        playerArea.appendChild(playerHeader);\r\n        \r\n        // Player cards container\r\n        const playerCards = document.createElement('div');\r\n        playerCards.id = 'player-cards';\r\n        playerCards.style.display = 'flex';\r\n        playerCards.style.gap = '15px';\r\n        playerCards.style.flexWrap = 'wrap';\r\n        playerCards.style.height = this.isMobile ? 'auto' : '130px';\r\n        playerCards.style.minHeight = this.isMobile ? '120px' : '130px';\r\n        playerArea.appendChild(playerCards);\r\n        \r\n        gameArea.appendChild(playerArea);\r\n        \r\n        // Controls area\r\n        const controlsArea = document.createElement('div');\r\n        controlsArea.style.display = 'flex';\r\n        controlsArea.style.justifyContent = 'space-between';\r\n        controlsArea.style.alignItems = 'center';\r\n        controlsArea.style.height = 'auto';\r\n        controlsArea.style.flexDirection = this.isMobile ? 'column' : 'row';\r\n        controlsArea.style.gap = this.isMobile ? '15px' : '0';\r\n        \r\n        // Betting controls\r\n        const bettingControls = document.createElement('div');\r\n        bettingControls.id = 'betting-controls';\r\n        bettingControls.style.display = 'flex';\r\n        bettingControls.style.flexDirection = 'column';\r\n        bettingControls.style.width = this.isMobile ? '100%' : '250px';\r\n        \r\n        const bettingTitle = document.createElement('div');\r\n        bettingTitle.textContent = 'PLACE YOUR BET';\r\n        bettingTitle.style.marginBottom = '10px';\r\n        bettingTitle.style.color = 'rgba(255, 255, 255, 0.8)';\r\n        bettingTitle.style.fontWeight = 'bold';\r\n        bettingControls.appendChild(bettingTitle);\r\n        \r\n        const resourceOptions = document.createElement('div');\r\n        resourceOptions.style.display = 'flex';\r\n        resourceOptions.style.gap = '10px';\r\n        \r\n        const createResourceButton = (resource, color) => {\r\n            const btn = document.createElement('button');\r\n            btn.className = 'resource-btn';\r\n            btn.dataset.resource = resource;\r\n            btn.style.flex = '1';\r\n            btn.style.padding = this.isMobile ? '10px 5px' : '8px 5px';\r\n            btn.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n            btn.style.border = `1px solid ${color}`;\r\n            btn.style.borderRadius = '5px';\r\n            btn.style.color = '#fff';\r\n            btn.style.boxShadow = `0 0 10px rgba(${color.split('(')[1].split(')')[0]}, 0.3)`;\r\n            btn.style.cursor = 'pointer';\r\n            btn.style.display = 'flex';\r\n            btn.style.flexDirection = 'column';\r\n            btn.style.alignItems = 'center';\r\n            btn.style.transition = 'background-color 0.2s, box-shadow 0.2s';\r\n            \r\n            const resourceName = document.createElement('span');\r\n            resourceName.textContent = resource.toUpperCase();\r\n            resourceName.style.fontWeight = 'bold';\r\n            resourceName.style.fontSize = '12px';\r\n            btn.appendChild(resourceName);\r\n            \r\n            const resourceAmount = document.createElement('span');\r\n            resourceAmount.className = `${resource}-amount`;\r\n            resourceAmount.textContent = `0 UNITS`;\r\n            resourceAmount.style.fontSize = '10px';\r\n            resourceAmount.style.marginTop = '3px';\r\n            resourceAmount.style.opacity = '0.7';\r\n            btn.appendChild(resourceAmount);\r\n            \r\n            // Add event handlers for both mouse and touch\r\n            const addHoverEffect = () => {\r\n                btn.style.backgroundColor = 'rgba(25, 60, 80, 0.8)';\r\n                btn.style.boxShadow = `0 0 15px ${color}`;\r\n            };\r\n            \r\n            const removeHoverEffect = () => {\r\n                btn.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n                btn.style.boxShadow = `0 0 10px rgba(${color.split('(')[1].split(')')[0]}, 0.3)`;\r\n            };\r\n            \r\n            // Mouse events\r\n            btn.addEventListener('mouseover', addHoverEffect);\r\n            btn.addEventListener('mouseout', removeHoverEffect);\r\n            \r\n            // Touch events\r\n            btn.addEventListener('touchstart', addHoverEffect, {passive: true});\r\n            btn.addEventListener('touchend', removeHoverEffect, {passive: true});\r\n            \r\n            // Click/tap handler\r\n            const clickHandler = () => {\r\n                if (!this.gameActive) {\r\n                    this.selectBetResource(resource);\r\n                    this.audio.playSound('boink');\r\n                    \r\n                    // Update button styling\r\n                    document.querySelectorAll('.resource-btn').forEach(button => {\r\n                        button.style.borderWidth = '1px';\r\n                        button.style.transform = 'scale(1)';\r\n                    });\r\n                    \r\n                    btn.style.borderWidth = '2px';\r\n                    btn.style.transform = 'scale(1.05)';\r\n                }\r\n            };\r\n            \r\n            btn.addEventListener('click', clickHandler);\r\n            btn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                clickHandler();\r\n            });\r\n            \r\n            return btn;\r\n        };\r\n        \r\n        resourceOptions.appendChild(createResourceButton('iron', 'rgba(150, 150, 150, 1)'));\r\n        resourceOptions.appendChild(createResourceButton('gold', 'rgba(255, 215, 0, 1)'));\r\n        resourceOptions.appendChild(createResourceButton('platinum', 'rgba(229, 228, 226, 1)'));\r\n        \r\n        bettingControls.appendChild(resourceOptions);\r\n        \r\n        // Bet amount controls\r\n        const betAmountControls = document.createElement('div');\r\n        betAmountControls.style.display = 'flex';\r\n        betAmountControls.style.marginTop = '10px';\r\n        betAmountControls.style.gap = '10px';\r\n        \r\n        const betAmountDisplay = document.createElement('div');\r\n        betAmountDisplay.id = 'bet-amount';\r\n        betAmountDisplay.textContent = '0';\r\n        betAmountDisplay.style.flex = '1';\r\n        betAmountDisplay.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n        betAmountDisplay.style.border = '1px solid rgba(51, 170, 255, 0.5)';\r\n        betAmountDisplay.style.borderRadius = '5px';\r\n        betAmountDisplay.style.padding = '8px 10px';\r\n        betAmountDisplay.style.textAlign = 'center';\r\n        betAmountDisplay.style.fontWeight = 'bold';\r\n        betAmountControls.appendChild(betAmountDisplay);\r\n        \r\n        // Create a button with both mouse and touch support\r\n        const createControlButton = (text, handler) => {\r\n            const btn = document.createElement('button');\r\n            btn.textContent = text;\r\n            btn.style.width = this.isMobile ? '50px' : '40px';\r\n            btn.style.height = this.isMobile ? '40px' : 'auto';\r\n            btn.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n            btn.style.border = '1px solid rgba(51, 170, 255, 0.5)';\r\n            btn.style.borderRadius = '5px';\r\n            btn.style.color = '#fff';\r\n            btn.style.cursor = 'pointer';\r\n            btn.style.fontSize = this.isMobile ? '20px' : '16px';\r\n            \r\n            // Hover effects\r\n            const addHoverEffect = () => {\r\n                btn.style.backgroundColor = 'rgba(25, 60, 80, 0.8)';\r\n                btn.style.boxShadow = '0 0 10px rgba(51, 170, 255, 0.3)';\r\n            };\r\n            \r\n            const removeHoverEffect = () => {\r\n                btn.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n                btn.style.boxShadow = 'none';\r\n            };\r\n            \r\n            // Mouse events\r\n            btn.addEventListener('mouseover', addHoverEffect);\r\n            btn.addEventListener('mouseout', removeHoverEffect);\r\n            \r\n            // Touch events\r\n            btn.addEventListener('touchstart', addHoverEffect, {passive: true});\r\n            btn.addEventListener('touchend', removeHoverEffect, {passive: true});\r\n            \r\n            // Click handler\r\n            btn.addEventListener('click', handler);\r\n            \r\n            // Separate touch handler to prevent click delay\r\n            btn.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                handler();\r\n            });\r\n            \r\n            return btn;\r\n        };\r\n        \r\n        const decreaseBtn = createControlButton('-', () => {\r\n            if (!this.gameActive && this.currentBet.resource) {\r\n                this.decreaseBet();\r\n                this.audio.playSound('boink');\r\n            }\r\n        });\r\n        betAmountControls.appendChild(decreaseBtn);\r\n        \r\n        const increaseBtn = createControlButton('+', () => {\r\n            if (!this.gameActive && this.currentBet.resource) {\r\n                this.increaseBet();\r\n                this.audio.playSound('boink');\r\n            }\r\n        });\r\n        betAmountControls.appendChild(increaseBtn);\r\n        \r\n        bettingControls.appendChild(betAmountControls);\r\n        controlsArea.appendChild(bettingControls);\r\n        \r\n        // Game actions\r\n        const gameActions = document.createElement('div');\r\n        gameActions.style.display = 'flex';\r\n        gameActions.style.gap = '15px';\r\n        gameActions.style.flexWrap = this.isMobile ? 'wrap' : 'nowrap';\r\n        gameActions.style.justifyContent = this.isMobile ? 'center' : 'flex-end';\r\n        gameActions.style.width = this.isMobile ? '100%' : 'auto';\r\n        \r\n        const actionButtons = [\r\n            { id: 'deal-btn', text: 'DEAL', color: '#30cfd0', handler: () => this.startGame() },\r\n            { id: 'hit-btn', text: 'HIT', color: '#ff9e3d', handler: () => this.hit() },\r\n            { id: 'stand-btn', text: 'STAND', color: '#e55c8a', handler: () => this.stand() },\r\n            { id: 'double-btn', text: 'DOUBLE', color: '#a281ff', handler: () => this.doubleDown() }\r\n        ];\r\n        \r\n        actionButtons.forEach(btn => {\r\n            const button = document.createElement('button');\r\n            button.id = btn.id;\r\n            button.textContent = btn.text;\r\n            button.style.padding = this.isMobile ? '15px 20px' : '12px 18px';\r\n            button.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n            button.style.border = `2px solid ${btn.color}`;\r\n            button.style.borderRadius = '5px';\r\n            button.style.color = '#fff';\r\n            button.style.fontWeight = 'bold';\r\n            button.style.cursor = 'pointer';\r\n            button.style.boxShadow = `0 0 10px ${btn.color}`;\r\n            button.style.transition = 'all 0.2s';\r\n            button.style.minWidth = this.isMobile ? '80px' : 'auto';\r\n            button.style.flex = this.isMobile ? '1' : 'none';\r\n            button.disabled = true;\r\n            button.style.opacity = '0.5';\r\n            \r\n            // Hover/touch effects\r\n            const enableHoverEffects = () => {\r\n                if (!button.disabled) {\r\n                    button.style.backgroundColor = 'rgba(25, 60, 80, 0.8)';\r\n                    button.style.boxShadow = `0 0 15px ${btn.color}`;\r\n                }\r\n            };\r\n            \r\n            const disableHoverEffects = () => {\r\n                if (!button.disabled) {\r\n                    button.style.backgroundColor = 'rgba(15, 40, 55, 0.8)';\r\n                    button.style.boxShadow = `0 0 10px ${btn.color}`;\r\n                }\r\n            };\r\n            \r\n            // Mouse events\r\n            button.addEventListener('mouseover', enableHoverEffects);\r\n            button.addEventListener('mouseout', disableHoverEffects);\r\n            \r\n            // Touch events\r\n            button.addEventListener('touchstart', enableHoverEffects, {passive: true});\r\n            button.addEventListener('touchend', disableHoverEffects, {passive: true});\r\n            \r\n            // Click handler\r\n            button.addEventListener('click', () => {\r\n                if (!button.disabled) {\r\n                    btn.handler();\r\n                    this.audio.playSound('boink');\r\n                }\r\n            });\r\n            \r\n            // Touch handler to prevent delay\r\n            button.addEventListener('touchend', (e) => {\r\n                if (!button.disabled) {\r\n                    e.preventDefault();\r\n                    btn.handler();\r\n                    this.audio.playSound('boink');\r\n                }\r\n            });\r\n            \r\n            gameActions.appendChild(button);\r\n        });\r\n        \r\n        controlsArea.appendChild(gameActions);\r\n        gameArea.appendChild(controlsArea);\r\n        \r\n        this.gameUI.appendChild(gameArea);\r\n        \r\n        document.body.appendChild(this.gameUI);\r\n        \r\n        // Set initial button states\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Show the game UI and sync with current game resources\r\n     */\r\n    show() {\r\n        // Don't show during intro sequence\r\n        if (window.game && window.game.introSequenceActive) {\r\n            console.log(\"BlackjackGame: Not showing game UI during intro sequence\");\r\n            return;\r\n        }\r\n        \r\n        if (this.gameUI) {\r\n            this.gameUI.style.display = 'block';\r\n            this.reset();\r\n            \r\n            // Force audio context resumption for mobile\r\n            if (this.audio && this.isMobile) {\r\n                // Play a sound to kickstart the audio context\r\n                setTimeout(() => {\r\n                    console.log(\"Mobile: Attempting to play initial sound in BlackjackGame\");\r\n                    this.audio.playSound('boink');\r\n                }, 100);\r\n            }\r\n            \r\n            // Check if we need to synchronize with the game's resource system\r\n            if (window.game && window.game.controls && window.game.controls.resources) {\r\n                // Sync with the real game resources\r\n                console.log(\"Syncing blackjack with game resources\");\r\n                const gameResources = window.game.controls.resources;\r\n                \r\n                if (!this.spaceship.cargo) {\r\n                    this.spaceship.cargo = {};\r\n                }\r\n                \r\n                // Update cargo with current game resources\r\n                this.spaceship.cargo.iron = gameResources.iron || 0;\r\n                this.spaceship.cargo.gold = gameResources.gold || 0;\r\n                this.spaceship.cargo.platinum = gameResources.platinum || 0;\r\n                \r\n                console.log(\"Synced resources:\", this.spaceship.cargo);\r\n            } else {\r\n                console.log(\"Game resources not available, using stored values\");\r\n            }\r\n            \r\n            // Update display with current resources\r\n            this.updateResourceDisplay();\r\n            this.audio.playSound('boink');\r\n        } else {\r\n            this.init();\r\n            this.show();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Hide the game UI and return to the stargate interface\r\n     */\r\n    hide() {\r\n        if (this.gameUI) {\r\n            this.gameUI.style.display = 'none';\r\n            this.audio.playSound('boink');\r\n            // Show the stargate interface when exiting blackjack\r\n            const stargateUI = document.getElementById('stargate-ui');\r\n            if (stargateUI) {\r\n                stargateUI.style.display = 'block';\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Reset the game state\r\n     */\r\n    reset() {\r\n        this.gameActive = false;\r\n        this.playerHand = [];\r\n        this.dealerHand = [];\r\n        this.currentBet = {\r\n            resource: null,\r\n            amount: 0\r\n        };\r\n        this.gameResult = null;\r\n        \r\n        // Reset UI elements\r\n        document.getElementById('player-cards').innerHTML = '';\r\n        document.getElementById('dealer-cards').innerHTML = '';\r\n        document.getElementById('player-score').textContent = '0';\r\n        document.getElementById('dealer-score').textContent = '0';\r\n        document.getElementById('game-status').textContent = 'PLACE YOUR BET TO BEGIN';\r\n        document.getElementById('dealer-speech').style.display = 'none';\r\n        document.getElementById('bet-amount').textContent = '0';\r\n        \r\n        // Reset resource selection\r\n        document.querySelectorAll('.resource-btn').forEach(btn => {\r\n            btn.style.borderWidth = '1px';\r\n            btn.style.transform = 'scale(1)';\r\n        });\r\n        \r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Create a fresh deck of cards\r\n     */\r\n    createDeck() {\r\n        const suits = ['hearts', 'diamonds', 'clubs', 'spades'];\r\n        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];\r\n        \r\n        this.deck = [];\r\n        \r\n        for (let suit of suits) {\r\n            for (let value of values) {\r\n                this.deck.push({\r\n                    suit: suit,\r\n                    value: value\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Shuffle deck\r\n        for (let i = this.deck.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get the value of a card\r\n     * @param {Object} card - The card object\r\n     * @returns {number} The value of the card in Blackjack\r\n     */\r\n    getCardValue(card) {\r\n        if (card.value === 'A') {\r\n            return 11;\r\n        } else if (['J', 'Q', 'K'].includes(card.value)) {\r\n            return 10;\r\n        } else {\r\n            return parseInt(card.value);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Calculate the score of a hand, adjusting for aces\r\n     * @param {Array} hand - Array of card objects\r\n     * @returns {number} The total score of the hand\r\n     */\r\n    calculateScore(hand) {\r\n        let score = 0;\r\n        let aces = 0;\r\n        \r\n        for (let card of hand) {\r\n            if (card.value === 'A') {\r\n                aces++;\r\n                score += 11;\r\n            } else if (['J', 'Q', 'K'].includes(card.value)) {\r\n                score += 10;\r\n            } else {\r\n                score += parseInt(card.value);\r\n            }\r\n        }\r\n        \r\n        // Adjust for aces if over 21\r\n        while (score > 21 && aces > 0) {\r\n            score -= 10;\r\n            aces--;\r\n        }\r\n        \r\n        return score;\r\n    }\r\n    \r\n    /**\r\n     * Draw a card from the deck\r\n     * @returns {Object} A card object\r\n     */\r\n    drawCard() {\r\n        if (this.deck.length === 0) {\r\n            this.createDeck();\r\n        }\r\n        return this.deck.pop();\r\n    }\r\n    \r\n    /**\r\n     * Create a visual card element\r\n     * @param {Object} card - The card object\r\n     * @param {boolean} faceDown - Whether the card is face down\r\n     * @returns {HTMLElement} The card element\r\n     */\r\n    createCardElement(card, faceDown = false) {\r\n        const cardEl = document.createElement('div');\r\n        cardEl.className = 'card';\r\n        \r\n        // Adjust card size for mobile\r\n        if (this.isMobile) {\r\n            cardEl.style.width = '70px';\r\n            cardEl.style.height = '105px';\r\n            cardEl.style.fontSize = '80%';\r\n        } else {\r\n            cardEl.style.width = '100px';\r\n            cardEl.style.height = '150px';\r\n        }\r\n        \r\n        cardEl.style.backgroundColor = faceDown ? 'rgba(9, 30, 42, 0.8)' : 'rgba(15, 35, 50, 0.9)';\r\n        cardEl.style.border = faceDown ? \r\n            '2px solid rgba(51, 170, 255, 0.3)' : \r\n            '2px solid rgba(51, 170, 255, 0.7)';\r\n        cardEl.style.borderRadius = '10px';\r\n        cardEl.style.boxShadow = faceDown ?\r\n            '0 0 5px rgba(51, 170, 255, 0.3)' :\r\n            '0 0 10px rgba(51, 170, 255, 0.5)';\r\n        cardEl.style.position = 'relative';\r\n        cardEl.style.display = 'flex';\r\n        cardEl.style.justifyContent = 'center';\r\n        cardEl.style.alignItems = 'center';\r\n        cardEl.style.overflow = 'hidden';\r\n        cardEl.style.transition = 'transform 0.3s ease';\r\n        \r\n        if (!faceDown) {\r\n            // Card value at top-left\r\n            const topValue = document.createElement('div');\r\n            topValue.style.position = 'absolute';\r\n            topValue.style.top = '8px';\r\n            topValue.style.left = '8px';\r\n            topValue.style.fontSize = this.isMobile ? '14px' : '20px';\r\n            topValue.style.fontWeight = 'bold';\r\n            topValue.textContent = card.value;\r\n            topValue.style.color = ['hearts', 'diamonds'].includes(card.suit) ? '#e55c8a' : '#30cfd0';\r\n            cardEl.appendChild(topValue);\r\n            \r\n            // Suit at top-right\r\n            const topSuit = document.createElement('div');\r\n            topSuit.style.position = 'absolute';\r\n            topSuit.style.top = '8px';\r\n            topSuit.style.right = '8px';\r\n            topSuit.style.fontSize = this.isMobile ? '12px' : '16px';\r\n            topSuit.textContent = this.cardSymbols[card.suit];\r\n            topSuit.style.color = ['hearts', 'diamonds'].includes(card.suit) ? '#e55c8a' : '#30cfd0';\r\n            cardEl.appendChild(topSuit);\r\n            \r\n            // Center symbol\r\n            const centerSymbol = document.createElement('div');\r\n            centerSymbol.style.fontSize = this.isMobile ? '28px' : '40px';\r\n            centerSymbol.style.lineHeight = '1';\r\n            centerSymbol.style.opacity = '0.9';\r\n            centerSymbol.textContent = this.cardSymbols[card.suit];\r\n            centerSymbol.style.color = ['hearts', 'diamonds'].includes(card.suit) ? '#e55c8a' : '#30cfd0';\r\n            cardEl.appendChild(centerSymbol);\r\n            \r\n            // Value at bottom-right (rotated)\r\n            const bottomValue = document.createElement('div');\r\n            bottomValue.style.position = 'absolute';\r\n            bottomValue.style.bottom = '8px';\r\n            bottomValue.style.right = '8px';\r\n            bottomValue.style.fontSize = this.isMobile ? '14px' : '20px';\r\n            bottomValue.style.fontWeight = 'bold';\r\n            bottomValue.style.transform = 'rotate(180deg)';\r\n            bottomValue.textContent = card.value;\r\n            bottomValue.style.color = ['hearts', 'diamonds'].includes(card.suit) ? '#e55c8a' : '#30cfd0';\r\n            cardEl.appendChild(bottomValue);\r\n            \r\n            // Suit at bottom-left (rotated)\r\n            const bottomSuit = document.createElement('div');\r\n            bottomSuit.style.position = 'absolute';\r\n            bottomSuit.style.bottom = '8px';\r\n            bottomSuit.style.left = '8px';\r\n            bottomSuit.style.fontSize = this.isMobile ? '12px' : '16px';\r\n            bottomSuit.style.transform = 'rotate(180deg)';\r\n            bottomSuit.textContent = this.cardSymbols[card.suit];\r\n            bottomSuit.style.color = ['hearts', 'diamonds'].includes(card.suit) ? '#e55c8a' : '#30cfd0';\r\n            cardEl.appendChild(bottomSuit);\r\n            \r\n            // Card background pattern\r\n            const pattern = document.createElement('div');\r\n            pattern.style.position = 'absolute';\r\n            pattern.style.inset = '0';\r\n            pattern.style.opacity = '0.05';\r\n            pattern.style.backgroundImage = 'radial-gradient(circle, #fff 1px, transparent 1px)';\r\n            pattern.style.backgroundSize = '10px 10px';\r\n            pattern.style.pointerEvents = 'none';\r\n            cardEl.appendChild(pattern);\r\n            \r\n            // Holographic effect\r\n            const holoEffect = document.createElement('div');\r\n            holoEffect.style.position = 'absolute';\r\n            holoEffect.style.inset = '0';\r\n            holoEffect.style.background = 'linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%)';\r\n            holoEffect.style.pointerEvents = 'none';\r\n            cardEl.appendChild(holoEffect);\r\n        } else {\r\n            // Back design for face-down card\r\n            const backDesign = document.createElement('div');\r\n            backDesign.style.width = '80%';\r\n            backDesign.style.height = '80%';\r\n            backDesign.style.border = '2px solid rgba(51, 170, 255, 0.4)';\r\n            backDesign.style.borderRadius = '5px';\r\n            backDesign.style.backgroundImage = 'radial-gradient(circle, rgba(51, 170, 255, 0.2) 10%, transparent 10%)';\r\n            backDesign.style.backgroundSize = '10px 10px';\r\n            cardEl.appendChild(backDesign);\r\n            \r\n            // Logo in center of back\r\n            const logo = document.createElement('div');\r\n            logo.style.position = 'absolute';\r\n            logo.style.fontWeight = 'bold';\r\n            logo.style.fontSize = this.isMobile ? '12px' : '14px';\r\n            logo.style.color = 'rgba(51, 170, 255, 0.7)';\r\n            logo.textContent = 'BJ';\r\n            cardEl.appendChild(logo);\r\n        }\r\n        \r\n        return cardEl;\r\n    }\r\n    \r\n    /**\r\n     * Select a resource for betting\r\n     * @param {string} resource - The resource type\r\n     */\r\n    selectBetResource(resource) {\r\n        this.currentBet.resource = resource;\r\n        this.currentBet.amount = 1;\r\n        document.getElementById('bet-amount').textContent = this.currentBet.amount;\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Increase the bet amount\r\n     */\r\n    increaseBet() {\r\n        const maxAmount = this.getMaxBet();\r\n        if (this.currentBet.amount < maxAmount) {\r\n            this.currentBet.amount++;\r\n            document.getElementById('bet-amount').textContent = this.currentBet.amount;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Decrease the bet amount\r\n     */\r\n    decreaseBet() {\r\n        if (this.currentBet.amount > 1) {\r\n            this.currentBet.amount--;\r\n            document.getElementById('bet-amount').textContent = this.currentBet.amount;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get the maximum possible bet amount for the selected resource\r\n     * @returns {number} The maximum bet amount\r\n     */\r\n    getMaxBet() {\r\n        if (!this.currentBet.resource || !this.spaceship.cargo) {\r\n            return 0;\r\n        }\r\n        \r\n        return this.spaceship.cargo[this.currentBet.resource] || 0;\r\n    }\r\n    \r\n    /**\r\n     * Update the game controls based on the current state\r\n     */\r\n    updateControls() {\r\n        const dealBtn = document.getElementById('deal-btn');\r\n        const hitBtn = document.getElementById('hit-btn');\r\n        const standBtn = document.getElementById('stand-btn');\r\n        const doubleBtn = document.getElementById('double-btn');\r\n        \r\n        // Reset all buttons to disabled state\r\n        [dealBtn, hitBtn, standBtn, doubleBtn].forEach(btn => {\r\n            btn.disabled = true;\r\n            btn.style.opacity = '0.5';\r\n            btn.style.cursor = 'default';\r\n        });\r\n        \r\n        if (!this.gameActive) {\r\n            // Before game starts, only deal button may be active\r\n            const canDeal = this.currentBet.resource && this.currentBet.amount > 0;\r\n            dealBtn.disabled = !canDeal;\r\n            dealBtn.style.opacity = canDeal ? '1' : '0.5';\r\n            dealBtn.style.cursor = canDeal ? 'pointer' : 'default';\r\n        } else {\r\n            // During game, hit/stand buttons are active\r\n            hitBtn.disabled = false;\r\n            hitBtn.style.opacity = '1';\r\n            hitBtn.style.cursor = 'pointer';\r\n            \r\n            standBtn.disabled = false;\r\n            standBtn.style.opacity = '1';\r\n            standBtn.style.cursor = 'pointer';\r\n            \r\n            // Double down only available on first move with 2 cards\r\n            const canDouble = this.playerHand.length === 2 && \r\n                            this.currentBet.amount * 2 <= this.getMaxBet();\r\n            doubleBtn.disabled = !canDouble;\r\n            doubleBtn.style.opacity = canDouble ? '1' : '0.5';\r\n            doubleBtn.style.cursor = canDouble ? 'pointer' : 'default';\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update the resource display\r\n     */\r\n    updateResourceDisplay() {\r\n        console.log(\"Updating resource display, spaceship:\", this.spaceship);\r\n        console.log(\"Cargo:\", this.spaceship ? this.spaceship.cargo : null);\r\n        \r\n        if (this.spaceship && this.spaceship.cargo) {\r\n            // Ensure cargo has all resources initialized\r\n            if (this.spaceship.cargo.iron === undefined) this.spaceship.cargo.iron = 0;\r\n            if (this.spaceship.cargo.gold === undefined) this.spaceship.cargo.gold = 0;\r\n            if (this.spaceship.cargo.platinum === undefined) this.spaceship.cargo.platinum = 0;\r\n            \r\n            // Update resource amounts\r\n            const ironElement = document.querySelector('.iron-amount');\r\n            if (ironElement) {\r\n                ironElement.textContent = `${this.spaceship.cargo.iron} UNITS`;\r\n            }\r\n            \r\n            const goldElement = document.querySelector('.gold-amount');\r\n            if (goldElement) {\r\n                goldElement.textContent = `${this.spaceship.cargo.gold} UNITS`;\r\n            }\r\n            \r\n            const platinumElement = document.querySelector('.platinum-amount');\r\n            if (platinumElement) {\r\n                platinumElement.textContent = `${this.spaceship.cargo.platinum} UNITS`;\r\n            }\r\n        } else {\r\n            console.error(\"Cannot update resource display: spaceship or cargo is undefined\");\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Start a new game\r\n     */\r\n    startGame() {\r\n        console.log(\"Starting game with bet:\", this.currentBet);\r\n        console.log(\"Spaceship:\", this.spaceship);\r\n        console.log(\"Cargo:\", this.spaceship ? this.spaceship.cargo : null);\r\n        \r\n        if (!this.currentBet.resource || this.currentBet.amount <= 0) {\r\n            console.log(\"No bet resource or amount selected\");\r\n            return;\r\n        }\r\n        \r\n        // Initialize cargo if needed\r\n        if (!this.spaceship) {\r\n            console.error(\"No spaceship object available\");\r\n            document.getElementById('game-status').textContent = 'ERROR: GAME DATA MISSING';\r\n            return;\r\n        }\r\n        \r\n        if (!this.spaceship.cargo) {\r\n            console.warn(\"Creating cargo object for spaceship\");\r\n            this.spaceship.cargo = { iron: 0, gold: 0, platinum: 0 };\r\n        }\r\n        \r\n        // Make sure the resource exists in cargo\r\n        if (this.spaceship.cargo[this.currentBet.resource] === undefined) {\r\n            this.spaceship.cargo[this.currentBet.resource] = 0;\r\n        }\r\n        \r\n        // Check if player has enough resources\r\n        if (this.spaceship.cargo[this.currentBet.resource] < this.currentBet.amount) {\r\n            document.getElementById('game-status').textContent = 'NOT ENOUGH RESOURCES';\r\n            return;\r\n        }\r\n        \r\n        // Deduct bet from player's resources\r\n        this.spaceship.cargo[this.currentBet.resource] -= this.currentBet.amount;\r\n        this.updateResourceDisplay();\r\n        \r\n        // Sync with the game's resource system if available\r\n        if (window.game && window.game.controls && window.game.controls.resources) {\r\n            window.game.controls.resources[this.currentBet.resource] = this.spaceship.cargo[this.currentBet.resource];\r\n            console.log(\"Updated game resources after bet:\", window.game.controls.resources);\r\n        }\r\n        \r\n        // Create and shuffle deck\r\n        this.createDeck();\r\n        \r\n        // Clear previous hands\r\n        this.playerHand = [];\r\n        this.dealerHand = [];\r\n        document.getElementById('player-cards').innerHTML = '';\r\n        document.getElementById('dealer-cards').innerHTML = '';\r\n        \r\n        // Deal initial cards\r\n        this.gameActive = true;\r\n        \r\n        // Deal two cards to player\r\n        this.dealCardToPlayer();\r\n        this.dealCardToPlayer();\r\n        \r\n        // Deal one face up card to dealer\r\n        this.dealCardToDealer();\r\n        \r\n        // Deal one face down card to dealer\r\n        this.dealCardToDealer(true);\r\n        \r\n        // Check for natural blackjack\r\n        this.checkForNaturalBlackjack();\r\n        \r\n        // Update game state\r\n        document.getElementById('game-status').textContent = 'YOUR MOVE';\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n        \r\n        // Play deal sound\r\n        this.playCardSound('deal');\r\n    }\r\n    \r\n    /**\r\n     * Deal a card to the player\r\n     */\r\n    dealCardToPlayer() {\r\n        const card = this.drawCard();\r\n        this.playerHand.push(card);\r\n        \r\n        // Create and add card element\r\n        const cardEl = this.createCardElement(card);\r\n        document.getElementById('player-cards').appendChild(cardEl);\r\n        \r\n        // Add a slight animation delay\r\n        setTimeout(() => {\r\n            cardEl.style.transform = 'translateY(-5px)';\r\n        }, 50);\r\n        \r\n        // Update score\r\n        const score = this.calculateScore(this.playerHand);\r\n        document.getElementById('player-score').textContent = score;\r\n        \r\n        // Check for bust\r\n        if (score > 21) {\r\n            this.playerBust();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Deal a card to the dealer\r\n     * @param {boolean} faceDown - Whether the card should be face down\r\n     */\r\n    dealCardToDealer(faceDown = false) {\r\n        const card = this.drawCard();\r\n        this.dealerHand.push(card);\r\n        \r\n        // Create and add card element\r\n        const cardEl = this.createCardElement(card, faceDown);\r\n        cardEl.id = faceDown ? 'face-down-card' : '';\r\n        document.getElementById('dealer-cards').appendChild(cardEl);\r\n        \r\n        // Add a slight animation delay\r\n        setTimeout(() => {\r\n            cardEl.style.transform = 'translateY(-5px)';\r\n        }, 50);\r\n        \r\n        // Update score (only counting face-up cards)\r\n        if (!faceDown) {\r\n            const visibleScore = this.calculateVisibleDealerScore();\r\n            document.getElementById('dealer-score').textContent = visibleScore;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Calculate the dealer's visible score (excluding face-down card)\r\n     * @returns {number} The visible score\r\n     */\r\n    calculateVisibleDealerScore() {\r\n        if (this.dealerHand.length <= 1) {\r\n            return this.dealerHand.length ? this.getCardValue(this.dealerHand[0]) : 0;\r\n        }\r\n        \r\n        // Calculate score excluding the last card (which is face down)\r\n        return this.calculateScore(this.dealerHand.slice(0, -1));\r\n    }\r\n    \r\n    /**\r\n     * Check for natural blackjack\r\n     */\r\n    checkForNaturalBlackjack() {\r\n        const playerScore = this.calculateScore(this.playerHand);\r\n        const dealerScore = this.calculateScore(this.dealerHand);\r\n        \r\n        if (playerScore === 21 || dealerScore === 21) {\r\n            // Reveal dealer's face-down card\r\n            this.revealDealerCard();\r\n            \r\n            if (playerScore === 21 && dealerScore === 21) {\r\n                // Both have blackjack - push\r\n                this.push();\r\n            } else if (playerScore === 21) {\r\n                // Player has blackjack - win with 3:2 payout\r\n                this.blackjackWin();\r\n            } else {\r\n                // Dealer has blackjack - player loses\r\n                this.playerLose();\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Player action: Hit (take another card)\r\n     */\r\n    hit() {\r\n        if (this.gameActive) {\r\n            this.dealCardToPlayer();\r\n            this.playCardSound('hit');\r\n            this.updateControls();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Player action: Stand (end turn)\r\n     */\r\n    stand() {\r\n        if (this.gameActive) {\r\n            this.playCardSound('stand');\r\n            this.dealerPlay();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Player action: Double Down (double bet, take one card, then stand)\r\n     */\r\n    doubleDown() {\r\n        if (this.gameActive && this.playerHand.length === 2) {\r\n            // Check if player has enough resources\r\n            if (this.spaceship.cargo[this.currentBet.resource] < this.currentBet.amount) {\r\n                document.getElementById('game-status').textContent = 'NOT ENOUGH RESOURCES FOR DOUBLE DOWN';\r\n                return;\r\n            }\r\n            \r\n            // Double the bet\r\n            this.spaceship.cargo[this.currentBet.resource] -= this.currentBet.amount;\r\n            this.currentBet.amount *= 2;\r\n            this.updateResourceDisplay();\r\n            \r\n            // Sync with the game's resource system if available\r\n            if (window.game && window.game.controls && window.game.controls.resources) {\r\n                window.game.controls.resources[this.currentBet.resource] = this.spaceship.cargo[this.currentBet.resource];\r\n                console.log(\"Updated game resources after double down:\", window.game.controls.resources);\r\n            }\r\n            \r\n            // Deal one more card\r\n            this.dealCardToPlayer();\r\n            \r\n            // If not bust, dealer plays\r\n            if (this.calculateScore(this.playerHand) <= 21) {\r\n                this.dealerPlay();\r\n            }\r\n            \r\n            this.playCardSound('double');\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Dealer's turn to play\r\n     */\r\n    dealerPlay() {\r\n        // Reveal dealer's face-down card\r\n        this.revealDealerCard();\r\n        \r\n        // Dealer hits until score is 17 or higher\r\n        let dealerScore = this.calculateScore(this.dealerHand);\r\n        \r\n        const dealerPlayNextCard = () => {\r\n            if (dealerScore < 17) {\r\n                // Deal a new card to dealer\r\n                this.dealCardToDealer();\r\n                \r\n                // Update dealer score\r\n                dealerScore = this.calculateScore(this.dealerHand);\r\n                \r\n                // Play sound\r\n                this.playCardSound('hit');\r\n                \r\n                // Continue with a small delay\r\n                setTimeout(() => {\r\n                    dealerPlayNextCard();\r\n                }, 800);\r\n            } else {\r\n                // Dealer is done - determine outcome\r\n                this.determineOutcome();\r\n            }\r\n        };\r\n        \r\n        // Start dealer's play with a delay\r\n        setTimeout(dealerPlayNextCard, 800);\r\n    }\r\n    \r\n    /**\r\n     * Reveal the dealer's face-down card\r\n     */\r\n    revealDealerCard() {\r\n        // Remove the face-down card element\r\n        const faceDownEl = document.getElementById('face-down-card');\r\n        if (faceDownEl) {\r\n            faceDownEl.remove();\r\n            \r\n            // Create and add the face-up version of the last card\r\n            const lastCard = this.dealerHand[this.dealerHand.length - 1];\r\n            const cardEl = this.createCardElement(lastCard);\r\n            document.getElementById('dealer-cards').appendChild(cardEl);\r\n            \r\n            // Add a slight animation delay\r\n            setTimeout(() => {\r\n                cardEl.style.transform = 'translateY(-5px)';\r\n            }, 50);\r\n            \r\n            // Update dealer score\r\n            const dealerScore = this.calculateScore(this.dealerHand);\r\n            document.getElementById('dealer-score').textContent = dealerScore;\r\n            \r\n            // Play flip sound\r\n            this.playCardSound('flip');\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Determine the outcome of the game\r\n     */\r\n    determineOutcome() {\r\n        const playerScore = this.calculateScore(this.playerHand);\r\n        const dealerScore = this.calculateScore(this.dealerHand);\r\n        \r\n        if (dealerScore > 21) {\r\n            // Dealer busts - player wins\r\n            this.playerWin();\r\n        } else if (playerScore > dealerScore) {\r\n            // Player score higher - player wins\r\n            this.playerWin();\r\n        } else if (dealerScore > playerScore) {\r\n            // Dealer score higher - player loses\r\n            this.playerLose();\r\n        } else {\r\n            // Scores are equal - push\r\n            this.push();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Player busts (score over 21)\r\n     */\r\n    playerBust() {\r\n        this.gameActive = false;\r\n        this.gameResult = 'bust';\r\n        \r\n        document.getElementById('game-status').textContent = 'BUST! YOU LOSE';\r\n        this.showDealerSpeech('lose');\r\n        \r\n        // Play bust sound\r\n        this.playCardSound('bust');\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Player wins\r\n     */\r\n    playerWin() {\r\n        this.gameActive = false;\r\n        this.gameResult = 'win';\r\n        \r\n        document.getElementById('game-status').textContent = 'YOU WIN!';\r\n        this.showDealerSpeech('win');\r\n        \r\n        // Calculate winnings (2x bet)\r\n        const winAmount = this.currentBet.amount * 2;\r\n        this.spaceship.cargo[this.currentBet.resource] += winAmount;\r\n        this.updateResourceDisplay();\r\n        \r\n        // Sync with the game's resource system if available\r\n        if (window.game && window.game.controls && window.game.controls.resources) {\r\n            window.game.controls.resources[this.currentBet.resource] = this.spaceship.cargo[this.currentBet.resource];\r\n            console.log(\"Updated game resources after win:\", window.game.controls.resources);\r\n        }\r\n        \r\n        // Play win sound\r\n        this.playCardSound('win');\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Player gets a blackjack (natural 21)\r\n     */\r\n    blackjackWin() {\r\n        this.gameActive = false;\r\n        this.gameResult = 'blackjack';\r\n        \r\n        document.getElementById('game-status').textContent = 'BLACKJACK! TRIPLE PAYOUT!';\r\n        this.showDealerSpeech('blackjack');\r\n        \r\n        // Calculate winnings (3x bet)\r\n        const winAmount = this.currentBet.amount * 3;\r\n        this.spaceship.cargo[this.currentBet.resource] += winAmount;\r\n        this.updateResourceDisplay();\r\n        \r\n        // Sync with the game's resource system if available\r\n        if (window.game && window.game.controls && window.game.controls.resources) {\r\n            window.game.controls.resources[this.currentBet.resource] = this.spaceship.cargo[this.currentBet.resource];\r\n            console.log(\"Updated game resources after blackjack:\", window.game.controls.resources);\r\n        }\r\n        \r\n        // Play win sound\r\n        this.playCardSound('blackjack');\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Player loses\r\n     */\r\n    playerLose() {\r\n        this.gameActive = false;\r\n        this.gameResult = 'lose';\r\n        \r\n        document.getElementById('game-status').textContent = 'DEALER WINS';\r\n        this.showDealerSpeech('lose');\r\n        \r\n        // Play lose sound\r\n        this.playCardSound('lose');\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Push (tie)\r\n     */\r\n    push() {\r\n        this.gameActive = false;\r\n        this.gameResult = 'push';\r\n        \r\n        document.getElementById('game-status').textContent = 'PUSH - BETS RETURNED';\r\n        this.showDealerSpeech('push');\r\n        \r\n        // Return bet to player\r\n        this.spaceship.cargo[this.currentBet.resource] += this.currentBet.amount;\r\n        this.updateResourceDisplay();\r\n        \r\n        // Sync with the game's resource system if available\r\n        if (window.game && window.game.controls && window.game.controls.resources) {\r\n            window.game.controls.resources[this.currentBet.resource] = this.spaceship.cargo[this.currentBet.resource];\r\n            console.log(\"Updated game resources after push:\", window.game.controls.resources);\r\n        }\r\n        \r\n        // Play push sound\r\n        this.playCardSound('push');\r\n        \r\n        // Update controls\r\n        this.updateControls();\r\n    }\r\n    \r\n    /**\r\n     * Show dealer speech bubble with a random phrase\r\n     * @param {string} type - The type of phrase to show\r\n     */\r\n    showDealerSpeech(type) {\r\n        const speechBubble = document.getElementById('dealer-speech');\r\n        const phrases = this.dealerPhrases[type];\r\n        \r\n        if (phrases && phrases.length > 0) {\r\n            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];\r\n            speechBubble.textContent = randomPhrase;\r\n            speechBubble.style.display = 'block';\r\n            \r\n            // Remove after a few seconds\r\n            setTimeout(() => {\r\n                speechBubble.style.display = 'none';\r\n            }, 4000);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Play a card game sound\r\n     * @param {string} type - The type of sound to play\r\n     */\r\n    playCardSound(type) {\r\n        if (!this.audio) return;\r\n        \r\n        switch (type) {\r\n            case 'deal':\r\n                this.audio.playSound('boink');\r\n                break;\r\n            case 'hit':\r\n                this.audio.playSound('boink');\r\n                break;\r\n            case 'stand':\r\n                this.audio.playSound('boink');\r\n                break;\r\n            case 'double':\r\n                // Play two sounds in quick succession\r\n                this.audio.playSound('boink');\r\n                setTimeout(() => this.audio.playSound('boink'), 150);\r\n                break;\r\n            case 'flip':\r\n                this.audio.playSound('boink');\r\n                break;\r\n            case 'win':\r\n                this.audio.playSound('phaserUp');\r\n                break;\r\n            case 'blackjack':\r\n                // Play multiple sounds for celebration\r\n                this.audio.playSound('phaserUp');\r\n                setTimeout(() => this.audio.playSound('phaserUp'), 300);\r\n                break;\r\n            case 'lose':\r\n                this.audio.playSound('phaserDown');\r\n                break;\r\n            case 'bust':\r\n                this.audio.playSound('phaserDown');\r\n                break;\r\n            case 'push':\r\n                this.audio.playSound('boink');\r\n                break;\r\n        }\r\n    }\r\n}","// settings.js - Handles game settings and performance options\r\n\r\nimport { MobileDetector } from '../../utils/mobileDetector.js';\r\nimport * as THREE from 'three';\r\n\r\nexport class Settings {\r\n    constructor(game) {\r\n        this.game = game;\r\n        this.stargateInterface = null;\r\n        this.isVisible = false;\r\n        this.isMobile = MobileDetector.isMobile();\r\n        \r\n        console.log(\"Settings constructor - isMobile:\", this.isMobile);\r\n        \r\n        // Detect monitor refresh rate\r\n        this.detectMonitorRefreshRate();\r\n        \r\n        // Default settings\r\n        this.settings = {\r\n            graphicalQuality: 'medium',    // low, medium, high\r\n            postProcessing: true,          // true, false\r\n            asteroidDetail: 'medium',      // low, medium, high\r\n            lightingQuality: 'medium',     // low, medium, high\r\n            particleEffects: 'medium',     // low, medium, high\r\n            resolutionScale: 'medium',     // low, medium, high\r\n            frameRateCap: 'auto',          // 30, 60, auto (monitor refresh rate), 0 (unlimited)\r\n            showFPS: false,                // Show FPS counter\r\n            spatialAudio: true,            // Enable spatial audio\r\n            autoQuality: true,             // Automatically adjust quality based on performance\r\n            godRaysEnabled: false,          // Enable/disable volumetric lighting effects\r\n            godRaysType: 'standard'        // 'standard' (new god rays) or 'claude' (Claude Rays)\r\n        };\r\n        \r\n        // Load settings from localStorage if available\r\n        this.loadSettings();\r\n        \r\n        // Create settings UI\r\n        this.setupSettingsUI();\r\n        \r\n        // Apply initial settings\r\n        this.applyAllSettings();\r\n        \r\n        // Apply initial FPS display visibility\r\n        setTimeout(() => this.applyUISettings(), 100);\r\n    }\r\n    \r\n    setStargateInterface(stargateInterface) {\r\n        this.stargateInterface = stargateInterface;\r\n    }\r\n    \r\n    loadSettings() {\r\n        try {\r\n            const savedSettings = localStorage.getItem('asteroidMinerSettings');\r\n            if (savedSettings) {\r\n                const parsedSettings = JSON.parse(savedSettings);\r\n                // Merge saved settings with defaults\r\n                this.settings = {...this.settings, ...parsedSettings};\r\n                console.log(\"Settings loaded from localStorage:\", this.settings);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error loading settings:\", error);\r\n        }\r\n    }\r\n    \r\n    saveSettings() {\r\n        try {\r\n            localStorage.setItem('asteroidMinerSettings', JSON.stringify(this.settings));\r\n            console.log(\"Settings saved to localStorage\");\r\n        } catch (error) {\r\n            console.error(\"Error saving settings:\", error);\r\n        }\r\n    }\r\n    \r\n    setupSettingsUI() {\r\n        // Create settings container\r\n        const settingsContainer = document.createElement('div');\r\n        settingsContainer.id = 'settings-container';\r\n        settingsContainer.style.position = 'absolute';\r\n        settingsContainer.style.top = '50%';\r\n        settingsContainer.style.left = '50%';\r\n        settingsContainer.style.transform = 'translate(-50%, -50%)';\r\n        \r\n        // Adjust size for mobile\r\n        if (this.isMobile) {\r\n            settingsContainer.style.width = '95%';\r\n            settingsContainer.style.maxWidth = '600px';\r\n            settingsContainer.style.height = '90vh';\r\n        } else {\r\n            settingsContainer.style.width = '700px';\r\n            settingsContainer.style.maxHeight = '90vh';\r\n        }\r\n        \r\n        settingsContainer.style.overflowY = 'auto';\r\n        settingsContainer.style.backgroundColor = 'rgba(20, 30, 50, 0.9)';\r\n        settingsContainer.style.color = '#fff';\r\n        settingsContainer.style.padding = this.isMobile ? '20px' : '30px';\r\n        settingsContainer.style.borderRadius = '15px';\r\n        settingsContainer.style.border = '2px solid #33aaff';\r\n        settingsContainer.style.boxShadow = '0 0 30px #33aaff';\r\n        settingsContainer.style.fontFamily = 'Courier New, monospace';\r\n        settingsContainer.style.zIndex = '1000';\r\n        settingsContainer.style.display = 'none';\r\n        \r\n        // Add mobile-specific scroll support\r\n        if (this.isMobile) {\r\n            settingsContainer.style.webkitOverflowScrolling = 'touch';\r\n            settingsContainer.style.touchAction = 'pan-y';\r\n            settingsContainer.style.overscrollBehavior = 'contain';\r\n        }\r\n        \r\n        // Create settings content\r\n        settingsContainer.innerHTML = `\r\n            <h2 style=\"text-align: center; color: #33aaff; margin-top: 0; font-size: ${this.isMobile ? '24px' : '28px'};\">GAME SETTINGS</h2>\r\n            \r\n            <div style=\"margin-bottom: 20px;\">\r\n                <h3 style=\"color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile ? '18px' : '20px'};\">GRAPHICS SETTINGS</h3>\r\n                \r\n                <!-- Graphical Quality Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Graphical Quality</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Affects overall visual fidelity and performance</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"graphical-quality\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"low\">Low</option>\r\n                            <option value=\"medium\">Medium</option>\r\n                            <option value=\"high\">High</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Post-processing Effects Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Post-processing Effects</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Bloom, anti-aliasing, and visual effects</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%; display: flex; justify-content: flex-end;' : ''}\">\r\n                        <label class=\"toggle\" style=\"display: inline-block; position: relative; width: ${this.isMobile ? '70px' : '60px'}; height: ${this.isMobile ? '34px' : '30px'};\">\r\n                            <input type=\"checkbox\" id=\"post-processing\" style=\"opacity: 0; width: 0; height: 0;\">\r\n                            <span class=\"slider\" style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile ? '17px' : '15px'}; transition: .4s;\"></span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Volumetric Light Rays (God Rays) Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Volumetric Light Rays</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Enable sunlight rays effect</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%; display: flex; justify-content: flex-end;' : ''}\">\r\n                        <label class=\"toggle\" style=\"display: inline-block; position: relative; width: ${this.isMobile ? '70px' : '60px'}; height: ${this.isMobile ? '34px' : '30px'};\">\r\n                            <input type=\"checkbox\" id=\"god-rays-enabled\" style=\"opacity: 0; width: 0; height: 0;\">\r\n                            <span class=\"slider\" style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile ? '17px' : '15px'}; transition: .4s;\"></span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- God Ray Type Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Light Ray Type</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Choose light ray effect style</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"god-rays-type\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"standard\">Standard God Rays</option>\r\n                            <option value=\"claude\">Claude Rays</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Asteroid Detail Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Asteroid Detail</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Affects asteroid count and model complexity</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"asteroid-detail\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"low\">Low</option>\r\n                            <option value=\"medium\">Medium</option>\r\n                            <option value=\"high\">High</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Lighting Quality Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Lighting Quality</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Affects light sources and shadows</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"lighting-quality\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"low\">Low</option>\r\n                            <option value=\"medium\">Medium</option>\r\n                            <option value=\"high\">High</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Particle Effects Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Particle Effects</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Affects thruster, explosion, and other particle effects</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"particle-effects\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"low\">Low</option>\r\n                            <option value=\"medium\">Medium</option>\r\n                            <option value=\"high\">High</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Resolution Scale Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Resolution Scale</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Adjusts rendering resolution</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"resolution-scale\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"low\">Low (75%)</option>\r\n                            <option value=\"medium\">Medium (100%)</option>\r\n                            <option value=\"high\">High (125%)</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 20px;\">\r\n                <h3 style=\"color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile ? '18px' : '20px'};\">PERFORMANCE SETTINGS</h3>\r\n                \r\n                <!-- Frame Rate Cap Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Frame Rate Cap</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Limits maximum frame rate</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <select id=\"frame-rate-cap\" style=\"background-color: #2a3a5a; color: white; border: 1px solid #33aaff; padding: ${this.isMobile ? '10px' : '8px'}; border-radius: 5px; width: ${this.isMobile ? '100%' : 'auto'}; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                            <option value=\"30\">30 FPS</option>\r\n                            <option value=\"60\">60 FPS</option>\r\n                            <option value=\"auto\">Monitor Refresh Rate (${this.monitorRefreshRate}Hz)</option>\r\n                            <option value=\"0\">Unlimited</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Show FPS Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Show FPS Counter</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Display current frame rate</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%; display: flex; justify-content: flex-end;' : ''}\">\r\n                        <label class=\"toggle\" style=\"display: inline-block; position: relative; width: ${this.isMobile ? '70px' : '60px'}; height: ${this.isMobile ? '34px' : '30px'};\">\r\n                            <input type=\"checkbox\" id=\"show-fps\" style=\"opacity: 0; width: 0; height: 0;\">\r\n                            <span class=\"slider\" style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile ? '17px' : '15px'}; transition: .4s;\"></span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Auto Quality Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Auto-Adjust Quality</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">Automatically adjusts settings based on performance</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%; display: flex; justify-content: flex-end;' : ''}\">\r\n                        <label class=\"toggle\" style=\"display: inline-block; position: relative; width: ${this.isMobile ? '70px' : '60px'}; height: ${this.isMobile ? '34px' : '30px'};\">\r\n                            <input type=\"checkbox\" id=\"auto-quality\" style=\"opacity: 0; width: 0; height: 0;\">\r\n                            <span class=\"slider\" style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile ? '17px' : '15px'}; transition: .4s;\"></span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 20px;\">\r\n                <h3 style=\"color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile ? '18px' : '20px'};\">AUDIO SETTINGS</h3>\r\n                \r\n                <!-- Spatial Audio Setting -->\r\n                <div class=\"settings-row\" style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-direction: ${this.isMobile ? 'column' : 'row'}; align-items: ${this.isMobile ? 'flex-start' : 'center'};\">\r\n                    <div style=\"margin-bottom: ${this.isMobile ? '8px' : '0'}; ${this.isMobile ? 'width: 100%' : ''}\">\r\n                        <label style=\"font-weight: bold; font-size: ${this.isMobile ? '15px' : 'inherit'};\">Spatial Audio</label>\r\n                        <p style=\"margin: 5px 0 0 0; font-size: ${this.isMobile ? '11px' : '12px'}; color: #aaa;\">3D positional sound effects</p>\r\n                    </div>\r\n                    <div style=\"${this.isMobile ? 'width: 100%; display: flex; justify-content: flex-end;' : ''}\">\r\n                        <label class=\"toggle\" style=\"display: inline-block; position: relative; width: ${this.isMobile ? '70px' : '60px'}; height: ${this.isMobile ? '34px' : '30px'};\">\r\n                            <input type=\"checkbox\" id=\"spatial-audio\" style=\"opacity: 0; width: 0; height: 0;\">\r\n                            <span class=\"slider\" style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; border-radius: ${this.isMobile ? '17px' : '15px'}; transition: .4s;\"></span>\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div style=\"margin-bottom: 20px;\">\r\n                <h3 style=\"color: #33aaff; border-bottom: 1px solid #33aaff; padding-bottom: 10px; font-size: ${this.isMobile ? '18px' : '20px'};\">PRESETS</h3>\r\n                \r\n                <div style=\"display: flex; justify-content: space-between; margin-bottom: 20px; flex-direction: ${this.isMobile ? 'column' : 'row'}; gap: ${this.isMobile ? '10px' : '0'};\">\r\n                    <button id=\"preset-performance\" style=\"flex: 1; margin-right: ${this.isMobile ? '0' : '10px'}; padding: ${this.isMobile ? '15px' : '10px'}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                        PERFORMANCE\r\n                    </button>\r\n                    <button id=\"preset-balanced\" style=\"flex: 1; margin-right: ${this.isMobile ? '0' : '10px'}; padding: ${this.isMobile ? '15px' : '10px'}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                        BALANCED\r\n                    </button>\r\n                    <button id=\"preset-quality\" style=\"flex: 1; padding: ${this.isMobile ? '15px' : '10px'}; background-color: #2a3a5a; color: white; border: 1px solid #33aaff; border-radius: 5px; cursor: pointer; font-size: ${this.isMobile ? '16px' : 'inherit'};\">\r\n                        QUALITY\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            \r\n            <div style=\"display: flex; justify-content: space-between; flex-direction: ${this.isMobile ? 'column' : 'row'}; gap: ${this.isMobile ? '15px' : '0'};\">\r\n                <button id=\"apply-settings\" style=\"flex: 1; margin-right: ${this.isMobile ? '0' : '10px'}; padding: ${this.isMobile ? '20px' : '15px'}; background-color: #33aaff; color: black; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile ? '18px' : '16px'};\">\r\n                    APPLY\r\n                </button>\r\n                <button id=\"settings-back\" style=\"flex: 1; padding: ${this.isMobile ? '20px' : '15px'}; background-color: #555; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold; font-size: ${this.isMobile ? '18px' : '16px'};\">\r\n                    BACK\r\n                </button>\r\n            </div>\r\n        `;\r\n        \r\n        // Add slider style\r\n        const style = document.createElement('style');\r\n        style.textContent = `\r\n            .slider:before {\r\n                position: absolute;\r\n                content: \"\";\r\n                height: ${this.isMobile ? '26px' : '22px'};\r\n                width: ${this.isMobile ? '26px' : '22px'};\r\n                left: 4px;\r\n                bottom: 4px;\r\n                background-color: white;\r\n                border-radius: 50%;\r\n                transition: .4s;\r\n            }\r\n            \r\n            input:checked + .slider {\r\n                background-color: #33aaff;\r\n            }\r\n            \r\n            input:checked + .slider:before {\r\n                transform: translateX(${this.isMobile ? '36px' : '30px'});\r\n            }\r\n        `;\r\n        \r\n        document.head.appendChild(style);\r\n        document.body.appendChild(settingsContainer);\r\n        \r\n        // Add event listeners\r\n        this.setupEventListeners();\r\n    }\r\n    \r\n    setupEventListeners() {\r\n        // Back button\r\n        const backButton = document.getElementById('settings-back');\r\n        if (backButton) {\r\n            // Mouse event\r\n            backButton.addEventListener('click', () => {\r\n                this.hide();\r\n            });\r\n            \r\n            // Touch event for mobile\r\n            if (this.isMobile) {\r\n                backButton.addEventListener('touchend', (e) => {\r\n                    e.preventDefault();\r\n                    this.hide();\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Apply button\r\n        const applyButton = document.getElementById('apply-settings');\r\n        if (applyButton) {\r\n            const applyHandler = () => {\r\n                this.updateSettings();\r\n                this.saveSettings();\r\n                this.applyAllSettings();\r\n                \r\n                // Show confirmation message\r\n                this.showSettingsApplied();\r\n            };\r\n            \r\n            // Mouse event\r\n            applyButton.addEventListener('click', applyHandler);\r\n            \r\n            // Touch event for mobile\r\n            if (this.isMobile) {\r\n                applyButton.addEventListener('touchend', (e) => {\r\n                    e.preventDefault();\r\n                    applyHandler();\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Preset buttons with both mouse and touch events\r\n        this.setupPresetButton('preset-performance', 'performance');\r\n        this.setupPresetButton('preset-balanced', 'balanced');\r\n        this.setupPresetButton('preset-quality', 'quality');\r\n    }\r\n    \r\n    setupPresetButton(buttonId, presetName) {\r\n        const button = document.getElementById(buttonId);\r\n        if (!button) return;\r\n        \r\n        const presetHandler = () => {\r\n            this.applyPreset(presetName);\r\n        };\r\n        \r\n        // Mouse event\r\n        button.addEventListener('click', presetHandler);\r\n        \r\n        // Touch event for mobile\r\n        if (this.isMobile) {\r\n            button.addEventListener('touchend', (e) => {\r\n                e.preventDefault();\r\n                presetHandler();\r\n            });\r\n        }\r\n        \r\n        // Add hover/touch effects\r\n        if (this.isMobile) {\r\n            button.addEventListener('touchstart', () => {\r\n                button.style.backgroundColor = '#3a4b6a';\r\n                button.style.boxShadow = '0 0 10px #33aaff';\r\n            }, { passive: true });\r\n            \r\n            button.addEventListener('touchend', () => {\r\n                button.style.backgroundColor = '#2a3a5a';\r\n                button.style.boxShadow = 'none';\r\n            }, { passive: true });\r\n        } else {\r\n            button.addEventListener('mouseover', () => {\r\n                button.style.backgroundColor = '#3a4b6a';\r\n                button.style.boxShadow = '0 0 10px #33aaff';\r\n            });\r\n            \r\n            button.addEventListener('mouseout', () => {\r\n                button.style.backgroundColor = '#2a3a5a';\r\n                button.style.boxShadow = 'none';\r\n            });\r\n        }\r\n    }\r\n    \r\n    updateSettings() {\r\n        // Update settings object from UI values\r\n        this.settings.graphicalQuality = document.getElementById('graphical-quality').value;\r\n        this.settings.postProcessing = document.getElementById('post-processing').checked;\r\n        this.settings.asteroidDetail = document.getElementById('asteroid-detail').value;\r\n        this.settings.lightingQuality = document.getElementById('lighting-quality').value;\r\n        this.settings.particleEffects = document.getElementById('particle-effects').value;\r\n        this.settings.resolutionScale = document.getElementById('resolution-scale').value;\r\n        this.settings.frameRateCap = document.getElementById('frame-rate-cap').value;\r\n        this.settings.showFPS = document.getElementById('show-fps').checked;\r\n        this.settings.spatialAudio = document.getElementById('spatial-audio').checked;\r\n        this.settings.autoQuality = document.getElementById('auto-quality').checked;\r\n        this.settings.godRaysEnabled = document.getElementById('god-rays-enabled').checked;\r\n        this.settings.godRaysType = document.getElementById('god-rays-type').value;\r\n    }\r\n    \r\n    updateUI() {\r\n        // Set form values from current settings\r\n        document.getElementById('graphical-quality').value = this.settings.graphicalQuality;\r\n        document.getElementById('post-processing').checked = this.settings.postProcessing;\r\n        document.getElementById('asteroid-detail').value = this.settings.asteroidDetail;\r\n        document.getElementById('lighting-quality').value = this.settings.lightingQuality;\r\n        document.getElementById('particle-effects').value = this.settings.particleEffects;\r\n        document.getElementById('resolution-scale').value = this.settings.resolutionScale;\r\n        document.getElementById('frame-rate-cap').value = this.settings.frameRateCap;\r\n        document.getElementById('show-fps').checked = this.settings.showFPS;\r\n        document.getElementById('spatial-audio').checked = this.settings.spatialAudio;\r\n        document.getElementById('auto-quality').checked = this.settings.autoQuality;\r\n        document.getElementById('god-rays-enabled').checked = this.settings.godRaysEnabled;\r\n        document.getElementById('god-rays-type').value = this.settings.godRaysType;\r\n    }\r\n    \r\n    applyPreset(preset) {\r\n        console.log(`Applying ${preset} preset`);\r\n        \r\n        switch (preset) {\r\n            case 'performance':\r\n                // Performance preset - prioritizes frame rate\r\n                this.settings.graphicalQuality = 'low';\r\n                this.settings.postProcessing = false;\r\n                this.settings.asteroidDetail = 'low';\r\n                this.settings.lightingQuality = 'low';\r\n                this.settings.particleEffects = 'low';\r\n                this.settings.resolutionScale = 'low';\r\n                this.settings.frameRateCap = 60; // Cap at 60 FPS for better consistency\r\n                this.settings.spatialAudio = false;\r\n                this.settings.godRaysEnabled = false; // Disable god rays for performance\r\n                break;\r\n                \r\n            case 'balanced':\r\n                // Balanced preset - moderate settings\r\n                this.settings.graphicalQuality = 'medium';\r\n                this.settings.postProcessing = true;\r\n                this.settings.asteroidDetail = 'medium';\r\n                this.settings.lightingQuality = 'medium';\r\n                this.settings.particleEffects = 'medium';\r\n                this.settings.resolutionScale = 'medium';\r\n                this.settings.frameRateCap = 'auto'; // Use monitor refresh rate\r\n                this.settings.spatialAudio = true;\r\n                this.settings.godRaysEnabled = true; // Enable god rays\r\n                this.settings.godRaysType = 'standard'; // Use standard rays\r\n                break;\r\n                \r\n            case 'quality':\r\n                // Quality preset - prioritizes visuals\r\n                this.settings.graphicalQuality = 'high';\r\n                this.settings.postProcessing = true;\r\n                this.settings.asteroidDetail = 'high';\r\n                this.settings.lightingQuality = 'high';\r\n                this.settings.particleEffects = 'high';\r\n                this.settings.resolutionScale = 'high';\r\n                this.settings.frameRateCap = 0; // Unlimited\r\n                this.settings.spatialAudio = true;\r\n                this.settings.godRaysEnabled = true; // Enable god rays\r\n                this.settings.godRaysType = 'claude'; // Use Claude rays for dramatic effect\r\n                break;\r\n                \r\n            default:\r\n                console.error(`Unknown preset: ${preset}`);\r\n                return;\r\n        }\r\n        \r\n        // Don't change auto quality and FPS display settings\r\n        \r\n        // Update the UI to reflect new settings\r\n        this.updateUI();\r\n        \r\n        // Show confirmation message\r\n        this.showSettingsApplied();\r\n    }\r\n    \r\n    applyAllSettings() {\r\n        if (!this.game) return;\r\n        \r\n        // Apply renderer settings\r\n        this.applyRendererSettings();\r\n        \r\n        // Apply physics settings\r\n        this.applyPhysicsSettings();\r\n        \r\n        // Apply environment settings\r\n        this.applyEnvironmentSettings();\r\n        \r\n        // Apply audio settings\r\n        this.applyAudioSettings();\r\n        \r\n        // Apply UI settings\r\n        this.applyUISettings();\r\n        \r\n        console.log('All settings applied successfully');\r\n    }\r\n    \r\n    applyGraphicsSettings() {\r\n        if (!this.game) return;\r\n        \r\n        // Apply renderer settings (graphics-related)\r\n        this.applyRendererSettings();\r\n        \r\n        // Apply environment settings (affects visual quality)\r\n        this.applyEnvironmentSettings();\r\n        \r\n        console.log('Graphics settings applied successfully');\r\n    }\r\n    \r\n    applyRendererSettings() {\r\n        if (!this.game.renderer) return;\r\n        \r\n        const renderer = this.game.renderer;\r\n        \r\n        // Apply graphical quality\r\n        switch (this.settings.graphicalQuality) {\r\n            case 'low':\r\n                // Disable antialiasing\r\n                if (renderer.renderer) {\r\n                    renderer.renderer.antialias = false;\r\n                }\r\n                \r\n                // Set low shadow map size\r\n                if (renderer.renderer && renderer.renderer.shadowMap) {\r\n                    renderer.renderer.shadowMap.enabled = false;\r\n                }\r\n                break;\r\n                \r\n            case 'medium':\r\n                // Enable antialiasing\r\n                if (renderer.renderer) {\r\n                    renderer.renderer.antialias = true;\r\n                }\r\n                \r\n                // Set medium shadow map size\r\n                if (renderer.renderer && renderer.renderer.shadowMap) {\r\n                    renderer.renderer.shadowMap.enabled = true;\r\n                    renderer.renderer.shadowMap.type = THREE.PCFShadowMap;\r\n                }\r\n                break;\r\n                \r\n            case 'high':\r\n                // Enable antialiasing\r\n                if (renderer.renderer) {\r\n                    renderer.renderer.antialias = true;\r\n                }\r\n                \r\n                // Set high shadow map size\r\n                if (renderer.renderer && renderer.renderer.shadowMap) {\r\n                    renderer.renderer.shadowMap.enabled = true;\r\n                    renderer.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\r\n                }\r\n                break;\r\n        }\r\n        \r\n        // Apply post-processing setting\r\n        if (renderer.composer) {\r\n            renderer.useBasicRendering = !this.settings.postProcessing;\r\n        }\r\n        \r\n        // Apply god ray type setting first (this affects ambient light)\r\n        if (renderer.setRayType) {\r\n            const useClaudeRays = this.settings.godRaysType === 'claude';\r\n            renderer.setRayType(useClaudeRays);\r\n        }\r\n        \r\n        // Apply volumetric lighting (god rays) settings\r\n        if (renderer.setVolumetricLightEnabled) {\r\n            renderer.setVolumetricLightEnabled(this.settings.godRaysEnabled);\r\n            \r\n            // Ensure lighting is adjusted even when disabling god rays\r\n            if (renderer.adjustLightingForRayType) {\r\n                renderer.adjustLightingForRayType();\r\n            }\r\n        }\r\n        \r\n        // Apply volumetric light intensity based on quality setting\r\n        if (renderer.setVolumetricLightIntensity) {\r\n            let intensity;\r\n            switch (this.settings.graphicalQuality) {\r\n                case 'low':\r\n                    intensity = 0.4; // Increased from 0.3\r\n                    break;\r\n                case 'medium':\r\n                    intensity = 0.65; // Increased from 0.5\r\n                    break;\r\n                case 'high':\r\n                    intensity = 0.85; // Increased from 0.7\r\n                    break;\r\n                default:\r\n                    intensity = 0.65;\r\n            }\r\n            renderer.setVolumetricLightIntensity(intensity);\r\n        }\r\n        \r\n        // Apply bloom settings based on quality\r\n        if (renderer.bloomPass) {\r\n            switch (this.settings.graphicalQuality) {\r\n                case 'low':\r\n                    renderer.adjustBloom(0.4, 0.3, 0.9);\r\n                    break;\r\n                case 'medium':\r\n                    renderer.adjustBloom(0.6, 0.4, 0.85);\r\n                    break;\r\n                case 'high':\r\n                    renderer.adjustBloom(0.8, 0.5, 0.8);\r\n                    break;\r\n            }\r\n        }\r\n        \r\n        // Apply resolution scaling\r\n        if (renderer.renderer) {\r\n            let pixelRatio = window.devicePixelRatio || 1;\r\n            \r\n            switch (this.settings.resolutionScale) {\r\n                case 'low':\r\n                    pixelRatio *= 0.75;\r\n                    break;\r\n                case 'medium':\r\n                    // Use default pixel ratio\r\n                    break;\r\n                case 'high':\r\n                    pixelRatio *= 1.25;\r\n                    break;\r\n            }\r\n            \r\n            renderer.renderer.setPixelRatio(pixelRatio);\r\n            \r\n            // Update size to apply new pixel ratio\r\n            renderer.handleResize();\r\n        }\r\n    }\r\n    \r\n    applyPhysicsSettings() {\r\n        // Physics settings don't need much adjustment, but we can optimize collision detection\r\n        // based on asteroid detail setting\r\n        if (this.game.physics) {\r\n            const physics = this.game.physics;\r\n            \r\n            switch (this.settings.asteroidDetail) {\r\n                case 'low':\r\n                    physics.collisionDistance = 10; // Reduced collision distance\r\n                    break;\r\n                case 'medium':\r\n                    physics.collisionDistance = 15; // Default\r\n                    break;\r\n                case 'high':\r\n                    physics.collisionDistance = 20; // More precise collision\r\n                    break;\r\n            }\r\n        }\r\n    }\r\n    \r\n    applyEnvironmentSettings() {\r\n        if (!this.game.environment) return;\r\n        \r\n        const environment = this.game.environment;\r\n        \r\n        // Apply asteroid detail settings\r\n        if (environment.asteroidBelt && environment.asteroidBelt.updateDensity) {\r\n            switch (this.settings.asteroidDetail) {\r\n                case 'low':\r\n                    environment.asteroidBelt.updateDensity(0.5); // 50% density\r\n                    break;\r\n                case 'medium':\r\n                    environment.asteroidBelt.updateDensity(1.0); // 100% density\r\n                    break;\r\n                case 'high':\r\n                    environment.asteroidBelt.updateDensity(1.5); // 150% density\r\n                    break;\r\n            }\r\n        }\r\n    }\r\n    \r\n    applyAudioSettings() {\r\n        if (!this.game.audio) return;\r\n        \r\n        const audio = this.game.audio;\r\n        \r\n        // Apply spatial audio setting\r\n        if (audio.spatialAudio !== undefined) {\r\n            audio.spatialAudio = this.settings.spatialAudio;\r\n        }\r\n    }\r\n    \r\n    applyUISettings() {\r\n        // Apply FPS counter setting - we'll use the existing HUD FPS display\r\n        const fpsElement = document.getElementById('fps-display');\r\n        if (fpsElement) {\r\n            if (this.settings.showFPS) {\r\n                // Show FPS display in HUD\r\n                fpsElement.style.display = 'block';\r\n                \r\n                // Update FPS immediately if we have a current value\r\n                if (this.game && this.game.currentFPS) {\r\n                    fpsElement.textContent = `FPS: ${Math.round(this.game.currentFPS)}`;\r\n                }\r\n            } else {\r\n                // Hide FPS display in HUD\r\n                fpsElement.style.display = 'none';\r\n            }\r\n        } else {\r\n            console.warn(\"FPS display element not found in HUD. It should have ID 'fps-display'\");\r\n        }\r\n        \r\n        // Update frame rate cap in game\r\n        if (this.game) {\r\n            const oldCap = this.game.frameRateCap;\r\n            \r\n            // Handle auto (monitor refresh rate) setting\r\n            if (this.settings.frameRateCap === 'auto') {\r\n                // If refresh rate is over 65Hz, set to unlimited (0)\r\n                if (this.monitorRefreshRate > 65) {\r\n                    this.game.frameRateCap = 0;\r\n                    console.log(`Using unlimited frame rate (refresh rate ${this.monitorRefreshRate}Hz > 65Hz)`);\r\n                } else {\r\n                    this.game.frameRateCap = this.monitorRefreshRate;\r\n                    console.log(`Setting frame rate cap to monitor refresh rate: ${this.monitorRefreshRate}Hz`);\r\n                }\r\n            } else {\r\n                // Use the selected numeric value\r\n                this.game.frameRateCap = parseInt(this.settings.frameRateCap) || 0;\r\n            }\r\n            \r\n            // Only reset timing when changing from unlimited to limited or vice versa\r\n            // This prevents disrupting the animation loop when just changing cap values\r\n            if ((oldCap === 0 && this.game.frameRateCap > 0) || \r\n                (oldCap > 0 && this.game.frameRateCap === 0)) {\r\n                this.game.lastFrameTime = 0;\r\n            }\r\n            \r\n            console.log(`Frame rate cap changed from ${oldCap} to ${this.game.frameRateCap}`);\r\n        }\r\n    }\r\n    \r\n    showSettingsApplied() {\r\n        // Create notification\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = this.isMobile ? '25%' : '20%';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translate(-50%, -50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n        notification.style.color = '#33aaff';\r\n        notification.style.padding = this.isMobile ? '20px 40px' : '15px 30px';\r\n        notification.style.borderRadius = '10px';\r\n        notification.style.fontFamily = 'Courier New, monospace';\r\n        notification.style.fontSize = this.isMobile ? '18px' : '16px';\r\n        notification.style.zIndex = '9999';\r\n        notification.style.textAlign = 'center';\r\n        notification.textContent = 'Settings applied and saved';\r\n        \r\n        document.body.appendChild(notification);\r\n        \r\n        // Remove after a few seconds\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 0.5s';\r\n            \r\n            setTimeout(() => {\r\n                notification.remove();\r\n            }, 500);\r\n        }, 1500);\r\n    }\r\n    \r\n    show() {\r\n        const settingsContainer = document.getElementById('settings-container');\r\n        if (settingsContainer) {\r\n            // Update UI to reflect current settings\r\n            this.updateUI();\r\n            \r\n            // Show settings\r\n            settingsContainer.style.display = 'block';\r\n            this.isVisible = true;\r\n        }\r\n    }\r\n    \r\n    hide() {\r\n        const settingsContainer = document.getElementById('settings-container');\r\n        if (settingsContainer) {\r\n            settingsContainer.style.display = 'none';\r\n            this.isVisible = false;\r\n            \r\n            // Show the stargate UI when returning from settings\r\n            if (this.stargateInterface) {\r\n                this.stargateInterface.showStargateUI();\r\n            }\r\n        }\r\n    }\r\n    \r\n    toggle() {\r\n        if (this.isVisible) {\r\n            this.hide();\r\n        } else {\r\n            this.show();\r\n        }\r\n    }\r\n    \r\n    // Helper method to check if system can run high quality settings\r\n    detectSystemCapabilities() {\r\n        const performance = {};\r\n        \r\n        // Check device pixel ratio (higher on high-end devices)\r\n        performance.highDPI = window.devicePixelRatio > 1;\r\n        \r\n        // Check if WebGL2 is available\r\n        const canvas = document.createElement('canvas');\r\n        const gl = canvas.getContext('webgl2');\r\n        performance.webgl2 = !!gl;\r\n        \r\n        // Get GPU info if available\r\n        if (gl) {\r\n            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');\r\n            if (debugInfo) {\r\n                performance.gpu = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);\r\n            }\r\n        }\r\n        \r\n        // Check for recent browser features that suggest a modern device\r\n        performance.modernBrowser = \r\n            'IntersectionObserver' in window && \r\n            'requestAnimationFrame' in window &&\r\n            'localStorage' in window;\r\n            \r\n        // Make a recommendation based on the detected capabilities\r\n        if (performance.webgl2 && performance.highDPI && performance.modernBrowser) {\r\n            return 'high';\r\n        } else if (performance.webgl2 && performance.modernBrowser) {\r\n            return 'medium';\r\n        } else {\r\n            return 'low';\r\n        }\r\n    }\r\n    \r\n    detectMonitorRefreshRate() {\r\n        // Start with intelligent default based on common scenarios\r\n        this.monitorRefreshRate = 60;\r\n        \r\n        try {\r\n            // Method 1: Try screen.refresh first (most reliable when available)\r\n            if (window.screen && typeof window.screen.refresh === 'number' && window.screen.refresh > 0) {\r\n                this.monitorRefreshRate = Math.round(window.screen.refresh);\r\n                console.log(`Using screen.refresh value: ${this.monitorRefreshRate}Hz`);\r\n                return; // Use this value immediately if available\r\n            }\r\n            \r\n            // Method 2: Quick synchronous measurement (first few frames)\r\n            // This provides an immediate estimate for game initialization\r\n            const quickMeasure = this.quickRefreshRateMeasure();\r\n            if (quickMeasure > 0) {\r\n                this.monitorRefreshRate = quickMeasure;\r\n                console.log(`Quick measure refresh rate: ${this.monitorRefreshRate}Hz`);\r\n            }\r\n            \r\n            // Method 3: Start accurate async measurement for refinement\r\n            // This will update the rate after more samples\r\n            this.startAccurateRefreshDetection();\r\n            \r\n        } catch (error) {\r\n            console.warn(\"Error detecting refresh rate:\", error);\r\n        }\r\n    }\r\n    \r\n    quickRefreshRateMeasure() {\r\n        // Quick estimate based on common monitor configurations\r\n        // Avoid busy-wait which can cause initial lag\r\n        \r\n        // Check if we have screen refresh rate available\r\n        if (window.screen && typeof window.screen.refresh === 'number' && window.screen.refresh > 0) {\r\n            return Math.round(window.screen.refresh);\r\n        }\r\n        \r\n        // Check common indicators for high refresh displays\r\n        const userAgent = navigator.userAgent.toLowerCase();\r\n        const isGaming = userAgent.includes('gaming') || userAgent.includes('rog');\r\n        const isHighEnd = window.screen && window.screen.width > 2560;\r\n        \r\n        // Make educated guess based on device\r\n        if (this.isMobile) {\r\n            return 60; // Most mobile devices are 60Hz\r\n        } else if (isGaming || isHighEnd) {\r\n            return 144; // Assume high refresh for gaming systems\r\n        }\r\n        \r\n        // Default to 60Hz for standard displays\r\n        return 60;\r\n    }\r\n    \r\n    startAccurateRefreshDetection() {\r\n        // Accurate async detection over longer period\r\n        let warmupFrames = 5; // Skip initial irregular frames\r\n        let frameCount = 0;\r\n        const timestamps = [];\r\n        const startTime = performance.now();\r\n        \r\n        const detectFrame = (timestamp) => {\r\n            frameCount++;\r\n            \r\n            // Skip warmup frames\r\n            if (frameCount <= warmupFrames) {\r\n                requestAnimationFrame(detectFrame);\r\n                return;\r\n            }\r\n            \r\n            timestamps.push(timestamp);\r\n            \r\n            // Collect for 1 second or 120 frames\r\n            if (timestamps.length < 120 && performance.now() - startTime < 1000) {\r\n                requestAnimationFrame(detectFrame);\r\n            } else {\r\n                this.processRefreshRateSamples(timestamps);\r\n            }\r\n        };\r\n        \r\n        requestAnimationFrame(detectFrame);\r\n    }\r\n    \r\n    processRefreshRateSamples(timestamps) {\r\n        if (timestamps.length < 2) return;\r\n        \r\n        const intervals = [];\r\n        for (let i = 1; i < timestamps.length; i++) {\r\n            const delta = timestamps[i] - timestamps[i-1];\r\n            if (delta > 0) {\r\n                intervals.push(1000 / delta);\r\n            }\r\n        }\r\n        \r\n        if (intervals.length === 0) return;\r\n        \r\n        // Remove outliers using IQR method\r\n        intervals.sort((a, b) => a - b);\r\n        const q1 = intervals[Math.floor(intervals.length * 0.25)];\r\n        const q3 = intervals[Math.floor(intervals.length * 0.75)];\r\n        const iqr = q3 - q1;\r\n        \r\n        const validRates = intervals.filter(rate => \r\n            rate >= q1 - 1.5 * iqr && rate <= q3 + 1.5 * iqr\r\n        );\r\n        \r\n        if (validRates.length > 0) {\r\n            const avg = validRates.reduce((a, b) => a + b, 0) / validRates.length;\r\n            const newRate = this.roundToCommonRefreshRate(avg);\r\n            \r\n            // Only update if significantly different\r\n            if (Math.abs(newRate - this.monitorRefreshRate) >= 5) {\r\n                console.log(`Refined refresh rate: ${this.monitorRefreshRate}Hz -> ${newRate}Hz`);\r\n                this.monitorRefreshRate = newRate;\r\n                \r\n                // Update game settings if using auto mode\r\n                if (this.settings.frameRateCap === 'auto' && this.game) {\r\n                    this.applyUISettings();\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    roundToCommonRefreshRate(rate) {\r\n        // Common refresh rates in 2024\r\n        const commonRates = [24, 30, 48, 50, 60, 72, 75, 90, 100, 120, 144, 165, 180, 240, 360, 480];\r\n        \r\n        let closest = 60;\r\n        let minDiff = Math.abs(rate - 60);\r\n        \r\n        for (const commonRate of commonRates) {\r\n            const diff = Math.abs(rate - commonRate);\r\n            if (diff < minDiff) {\r\n                minDiff = diff;\r\n                closest = commonRate;\r\n            }\r\n        }\r\n        \r\n        // Only accept if within 10% of a common rate\r\n        if (minDiff / closest < 0.1) {\r\n            return closest;\r\n        }\r\n        \r\n        return Math.round(rate); // Return raw rate if no close match\r\n    }\r\n} ","// startScreen.js - Manages the game's start screen UI\r\n\r\nexport class StartScreen {\r\n    constructor(game, ui) {\r\n        this.game = game;\r\n        this.ui = ui;\r\n        this.isVisible = false;\r\n        this.setupStartScreen();\r\n    }\r\n\r\n    setupStartScreen() {\r\n        // Create start screen container\r\n        const startScreen = document.createElement('div');\r\n        startScreen.id = 'start-screen';\r\n        startScreen.className = 'start-screen';\r\n        startScreen.style.display = 'none';\r\n\r\n        // Add content to start screen\r\n        startScreen.innerHTML = `\r\n            <div class=\"start-screen-inner\">\r\n                <h1 class=\"game-title\">Solar System Asteroid Miner</h1>\r\n                <div class=\"button-container\">\r\n                    <button id=\"play-button\" class=\"start-button\">Play</button>\r\n                    <button id=\"how-to-play-button\" class=\"start-button\">How to Play</button>\r\n                </div>\r\n                <div class=\"version\">v0.5.8</div>\r\n            </div>\r\n            \r\n            <div id=\"how-to-play-modal\" class=\"modal\">\r\n                <div class=\"modal-content\">\r\n                    <h2>How to Play</h2>\r\n                    \r\n                    <div class=\"gameplay-section\">\r\n                        <h3>Game Overview</h3>\r\n                        <p>Welcome to Solar System Asteroid Miner! Your mission is to mine asteroids, collect resources, and upgrade your ship.</p>\r\n                        \r\n                        <h4>Core Objectives:</h4>\r\n                        <ul>\r\n                            <li><strong>Mining:</strong> Target asteroids (E key), then use your mining laser (R key) to extract resources.</li>\r\n                            <li><strong>Trading:</strong> Dock at stargates (Q key) to sell resources and purchase ship upgrades.</li>\r\n                            <li><strong>Combat:</strong> Defend yourself against enemy ships using your weapons.</li>\r\n                            <li><strong>Exploration:</strong> Travel between star systems through stargates to discover new resources.</li>\r\n                            <li><strong>Anomalies:</strong> Find and collect energy orbs from space anomalies for credits.</li>\r\n                            <li><strong>Defense:</strong> Deploy autonomous laser turrets (T key) to protect mining operations.</li>\r\n                        </ul>\r\n                        \r\n                        <h4>Horde Mode:</h4>\r\n                        <p>Work toward activating the ultimate challenge - Horde Mode:</p>\r\n                        <ul>\r\n                            <li><strong>Endless Survival:</strong> Face waves of increasingly difficult enemies that never stop coming.</li>\r\n                            <li><strong>Escalating Difficulty:</strong> Enemy health, damage, speed, and spawn rates increase over time.</li>\r\n                            <li><strong>Preparation:</strong> Upgrade your ship's weapons, shields, and hull before activating.</li>\r\n                            <li><strong>Strategy:</strong> Deploy multiple laser turrets (T key) around your position to create defensive perimeters.</li>\r\n                            <li><strong>High Score:</strong> How long can you survive as difficulty scales to infinity?</li>\r\n                        </ul>\r\n                    </div>\r\n                    \r\n                    <div class=\"control-section\">\r\n                        <h3>Movement</h3>\r\n                        <div class=\"control-row\"><span class=\"key\">W</span> <span>Forward</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">S</span> <span>Backward</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">A</span> <span>Left</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">D</span> <span>Right</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">SHIFT</span> <span>Boost</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">Mouse</span> <span>Ship Rotation</span></div>\r\n                    </div>\r\n                    \r\n                    <div class=\"control-section\">\r\n                        <h3>Combat & Mining</h3>\r\n                        <div class=\"control-row\"><span class=\"key\">LMB</span> <span>Fire Weapons</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">E</span> <span>Toggle Target Lock-On</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">R</span> <span>Toggle Mining Laser</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">TAB</span> <span>Cycle Targets</span></div>\r\n                    </div>\r\n                    \r\n                    <div class=\"control-section\">\r\n                        <h3>Special</h3>\r\n                        <div class=\"control-row\"><span class=\"key\">T</span> <span>Deploy Laser Turret</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">Q</span> <span>Dock/Undock at Stargate</span></div>\r\n                        <div class=\"control-row\"><span class=\"key\">ESC</span> <span>Pause Game</span></div>\r\n                    </div>\r\n                    \r\n                    <button id=\"close-how-to-play\" class=\"modal-close-button\">Close</button>\r\n                </div>\r\n            </div>\r\n        `;\r\n\r\n        // Add to document body\r\n        document.body.appendChild(startScreen);\r\n\r\n        // Set up event listeners\r\n        this.setupEventListeners();\r\n    }\r\n\r\n    setupEventListeners() {\r\n        // Play button\r\n        const playButton = document.getElementById('play-button');\r\n        if (playButton) {\r\n            playButton.addEventListener('click', () => {\r\n                this.hide();\r\n                // Check if intro has been played before\r\n                const introPlayed = localStorage.getItem('introPlayed') === 'true';\r\n                if (introPlayed) {\r\n                    // Returning player - go directly to docked state\r\n                    if (this.game.startDocked) {\r\n                        this.game.startDocked();\r\n                    } else {\r\n                        console.error(\"Game.startDocked not found\");\r\n                    }\r\n                } else {\r\n                    // New player - start intro sequence\r\n                    if (this.game.startIntroSequence) {\r\n                        this.game.startIntroSequence();\r\n                    } else {\r\n                        console.error(\"Game.startIntroSequence not found\");\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        // How to Play button\r\n        const howToPlayButton = document.getElementById('how-to-play-button');\r\n        const howToPlayModal = document.getElementById('how-to-play-modal');\r\n        const closeHowToPlayButton = document.getElementById('close-how-to-play');\r\n\r\n        if (howToPlayButton && howToPlayModal) {\r\n            howToPlayButton.addEventListener('click', () => {\r\n                howToPlayModal.style.display = 'flex';\r\n            });\r\n        }\r\n\r\n        if (closeHowToPlayButton && howToPlayModal) {\r\n            closeHowToPlayButton.addEventListener('click', () => {\r\n                howToPlayModal.style.display = 'none';\r\n            });\r\n\r\n            // Also close when clicking outside the modal content\r\n            howToPlayModal.addEventListener('click', (e) => {\r\n                if (e.target === howToPlayModal) {\r\n                    howToPlayModal.style.display = 'none';\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    show() {\r\n        const startScreen = document.getElementById('start-screen');\r\n        if (startScreen) {\r\n            startScreen.style.display = 'flex';\r\n            this.isVisible = true;\r\n            \r\n            // End timing for initialization when start screen becomes visible\r\n            if (window.initialTimestamp) {\r\n                const timeToStartScreen = performance.now() - window.initialTimestamp;\r\n                console.log(`Time to start screen visible: ${timeToStartScreen.toFixed(2)}ms`);\r\n                console.timeEnd(\"init\");\r\n            }\r\n        }\r\n    }\r\n\r\n    hide() {\r\n        const startScreen = document.getElementById('start-screen');\r\n        if (startScreen) {\r\n            startScreen.style.display = 'none';\r\n            this.isVisible = false;\r\n        }\r\n\r\n        // Also hide How to Play modal if it's open\r\n        const howToPlayModal = document.getElementById('how-to-play-modal');\r\n        if (howToPlayModal) {\r\n            howToPlayModal.style.display = 'none';\r\n        }\r\n    }\r\n} ","/**\r\n * Memory Management Utilities\r\n * Provides tools for optimizing memory usage and reducing garbage collection\r\n */\r\n\r\nimport * as THREE from 'three';\r\n\r\n// Typed Array Pools\r\nconst typedArrayPools = {\r\n    float32: [],\r\n    int32: [],\r\n    uint32: [],\r\n    uint16: [],\r\n    uint8: []\r\n};\r\n\r\n// Maximum pool sizes to prevent memory leaks\r\nconst MAX_POOL_SIZE = 100;\r\n\r\n/**\r\n * Get a Float32Array from the pool or create a new one\r\n * @param {number} size - Length of the array\r\n * @returns {Float32Array} - A Float32Array of the specified size\r\n */\r\nexport function getFloat32Array(size) {\r\n    const pool = typedArrayPools.float32;\r\n    \r\n    // Find an array of appropriate size in the pool\r\n    for (let i = 0; i < pool.length; i++) {\r\n        if (pool[i].length >= size) {\r\n            const array = pool.splice(i, 1)[0];\r\n            return array;\r\n        }\r\n    }\r\n    \r\n    // Create a new array if none found in pool\r\n    return new Float32Array(size);\r\n}\r\n\r\n/**\r\n * Release a Float32Array back to the pool\r\n * @param {Float32Array} array - The array to release\r\n */\r\nexport function releaseFloat32Array(array) {\r\n    if (typedArrayPools.float32.length < MAX_POOL_SIZE) {\r\n        // Zero out the array to prevent data leaks\r\n        array.fill(0);\r\n        typedArrayPools.float32.push(array);\r\n    }\r\n}\r\n\r\n/**\r\n * Get an Int32Array from the pool or create a new one\r\n * @param {number} size - Length of the array\r\n * @returns {Int32Array} - An Int32Array of the specified size\r\n */\r\nexport function getInt32Array(size) {\r\n    const pool = typedArrayPools.int32;\r\n    \r\n    for (let i = 0; i < pool.length; i++) {\r\n        if (pool[i].length >= size) {\r\n            const array = pool.splice(i, 1)[0];\r\n            return array;\r\n        }\r\n    }\r\n    \r\n    return new Int32Array(size);\r\n}\r\n\r\n/**\r\n * Release an Int32Array back to the pool\r\n * @param {Int32Array} array - The array to release\r\n */\r\nexport function releaseInt32Array(array) {\r\n    if (typedArrayPools.int32.length < MAX_POOL_SIZE) {\r\n        array.fill(0);\r\n        typedArrayPools.int32.push(array);\r\n    }\r\n}\r\n\r\n/**\r\n * Get a Uint32Array from the pool or create a new one\r\n * @param {number} size - Length of the array\r\n * @returns {Uint32Array} - A Uint32Array of the specified size\r\n */\r\nexport function getUint32Array(size) {\r\n    const pool = typedArrayPools.uint32;\r\n    \r\n    for (let i = 0; i < pool.length; i++) {\r\n        if (pool[i].length >= size) {\r\n            const array = pool.splice(i, 1)[0];\r\n            return array;\r\n        }\r\n    }\r\n    \r\n    return new Uint32Array(size);\r\n}\r\n\r\n/**\r\n * Release a Uint32Array back to the pool\r\n * @param {Uint32Array} array - The array to release\r\n */\r\nexport function releaseUint32Array(array) {\r\n    if (typedArrayPools.uint32.length < MAX_POOL_SIZE) {\r\n        array.fill(0);\r\n        typedArrayPools.uint32.push(array);\r\n    }\r\n}\r\n\r\n/**\r\n * Get a Uint16Array from the pool or create a new one\r\n * @param {number} size - Length of the array\r\n * @returns {Uint16Array} - A Uint16Array of the specified size\r\n */\r\nexport function getUint16Array(size) {\r\n    const pool = typedArrayPools.uint16;\r\n    \r\n    for (let i = 0; i < pool.length; i++) {\r\n        if (pool[i].length >= size) {\r\n            const array = pool.splice(i, 1)[0];\r\n            return array;\r\n        }\r\n    }\r\n    \r\n    return new Uint16Array(size);\r\n}\r\n\r\n/**\r\n * Release a Uint16Array back to the pool\r\n * @param {Uint16Array} array - The array to release\r\n */\r\nexport function releaseUint16Array(array) {\r\n    if (typedArrayPools.uint16.length < MAX_POOL_SIZE) {\r\n        array.fill(0);\r\n        typedArrayPools.uint16.push(array);\r\n    }\r\n}\r\n\r\n/**\r\n * Get a Uint8Array from the pool or create a new one\r\n * @param {number} size - Length of the array\r\n * @returns {Uint8Array} - A Uint8Array of the specified size\r\n */\r\nexport function getUint8Array(size) {\r\n    const pool = typedArrayPools.uint8;\r\n    \r\n    for (let i = 0; i < pool.length; i++) {\r\n        if (pool[i].length >= size) {\r\n            const array = pool.splice(i, 1)[0];\r\n            return array;\r\n        }\r\n    }\r\n    \r\n    return new Uint8Array(size);\r\n}\r\n\r\n/**\r\n * Release a Uint8Array back to the pool\r\n * @param {Uint8Array} array - The array to release\r\n */\r\nexport function releaseUint8Array(array) {\r\n    if (typedArrayPools.uint8.length < MAX_POOL_SIZE) {\r\n        array.fill(0);\r\n        typedArrayPools.uint8.push(array);\r\n    }\r\n}\r\n\r\n/**\r\n * Creates a pooled THREE.js BufferAttribute\r\n * @param {number} size - Number of vertices\r\n * @param {number} itemSize - Number of values per vertex (e.g. 3 for position, 2 for UV)\r\n * @returns {THREE.BufferAttribute} - A buffer attribute backed by a pooled typed array\r\n */\r\nexport function createPooledBufferAttribute(size, itemSize) {\r\n    const array = getFloat32Array(size * itemSize);\r\n    return new THREE.BufferAttribute(array, itemSize);\r\n}\r\n\r\n/**\r\n * Releases a pooled buffer attribute back to the pool\r\n * @param {THREE.BufferAttribute} attribute - The buffer attribute to release\r\n */\r\nexport function releasePooledBufferAttribute(attribute) {\r\n    if (attribute && attribute.array instanceof Float32Array) {\r\n        releaseFloat32Array(attribute.array);\r\n        attribute.array = null;\r\n    }\r\n}\r\n\r\n/**\r\n * Fixed-size array implementation to avoid dynamic array resizing\r\n */\r\nexport class FixedArray {\r\n    /**\r\n     * @param {number} size - Maximum size of the array\r\n     */\r\n    constructor(size) {\r\n        this.data = new Array(size);\r\n        this.length = 0;\r\n        this.capacity = size;\r\n    }\r\n    \r\n    /**\r\n     * Add an item to the array\r\n     * @param {*} item - Item to add\r\n     * @returns {boolean} - True if item was added, false if array is full\r\n     */\r\n    push(item) {\r\n        if (this.length < this.capacity) {\r\n            this.data[this.length++] = item;\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    \r\n    /**\r\n     * Remove and return the last item\r\n     * @returns {*} - The last item or undefined if empty\r\n     */\r\n    pop() {\r\n        if (this.length === 0) return undefined;\r\n        const item = this.data[--this.length];\r\n        this.data[this.length] = undefined; // Avoid memory leaks\r\n        return item;\r\n    }\r\n    \r\n    /**\r\n     * Get item at index\r\n     * @param {number} index - Index to retrieve\r\n     * @returns {*} - Item at that index\r\n     */\r\n    get(index) {\r\n        if (index < 0 || index >= this.length) return undefined;\r\n        return this.data[index];\r\n    }\r\n    \r\n    /**\r\n     * Set item at index\r\n     * @param {number} index - Index to set\r\n     * @param {*} value - Value to set\r\n     */\r\n    set(index, value) {\r\n        if (index < 0 || index >= this.capacity) return;\r\n        if (index >= this.length) this.length = index + 1;\r\n        this.data[index] = value;\r\n    }\r\n    \r\n    /**\r\n     * Remove item at index\r\n     * @param {number} index - Index to remove\r\n     * @returns {boolean} - True if removal was successful\r\n     */\r\n    removeAt(index) {\r\n        if (index < 0 || index >= this.length) return false;\r\n        \r\n        // Shift all elements after index\r\n        for (let i = index; i < this.length - 1; i++) {\r\n            this.data[i] = this.data[i + 1];\r\n        }\r\n        \r\n        // Clear the last element to avoid memory leaks\r\n        this.data[--this.length] = undefined;\r\n        return true;\r\n    }\r\n    \r\n    /**\r\n     * Clear the array\r\n     */\r\n    clear() {\r\n        for (let i = 0; i < this.length; i++) {\r\n            this.data[i] = undefined;\r\n        }\r\n        this.length = 0;\r\n    }\r\n    \r\n    /**\r\n     * Iterate over each item\r\n     * @param {Function} callback - Function to call for each item\r\n     */\r\n    forEach(callback) {\r\n        for (let i = 0; i < this.length; i++) {\r\n            callback(this.data[i], i, this);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Map array items to a new array\r\n     * @param {Function} callback - Function to transform each item\r\n     * @returns {Array} - New array with transformed items\r\n     */\r\n    map(callback) {\r\n        const result = new Array(this.length);\r\n        for (let i = 0; i < this.length; i++) {\r\n            result[i] = callback(this.data[i], i, this);\r\n        }\r\n        return result;\r\n    }\r\n    \r\n    /**\r\n     * Filter items into a new array\r\n     * @param {Function} callback - Predicate function to test each item\r\n     * @returns {Array} - New array with items that passed the test\r\n     */\r\n    filter(callback) {\r\n        const result = [];\r\n        for (let i = 0; i < this.length; i++) {\r\n            if (callback(this.data[i], i, this)) {\r\n                result.push(this.data[i]);\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n}\r\n\r\n/**\r\n * Memory usage statistics tracking\r\n */\r\nexport const MemoryStats = {\r\n    vectorPoolSize: 0,\r\n    objectPoolSizes: {},\r\n    typedArrayPoolSizes: {},\r\n    \r\n    /**\r\n     * Update memory statistics\r\n     */\r\n    update() {\r\n        // Vector pool stats\r\n        if (window.vectorPool) {\r\n            this.vectorPoolSize = window.vectorPool.pool.length;\r\n        }\r\n        \r\n        // Object pool stats\r\n        if (window.objectPool) {\r\n            for (const type in window.objectPool.pools) {\r\n                this.objectPoolSizes[type] = window.objectPool.pools[type].objects.length;\r\n            }\r\n        }\r\n        \r\n        // Typed array pool stats\r\n        for (const type in typedArrayPools) {\r\n            this.typedArrayPoolSizes[type] = typedArrayPools[type].length;\r\n        }\r\n    },\r\n    \r\n    /**\r\n     * Get a formatted report of memory usage\r\n     * @returns {string} - Formatted memory stats\r\n     */\r\n    getReport() {\r\n        this.update();\r\n        \r\n        let report = \"Memory Pool Stats:\\n\";\r\n        \r\n        // Vector pool\r\n        report += `Vector Pool: ${this.vectorPoolSize} vectors\\n`;\r\n        \r\n        // Object pools\r\n        report += \"Object Pools:\\n\";\r\n        for (const type in this.objectPoolSizes) {\r\n            report += `  ${type}: ${this.objectPoolSizes[type]} objects\\n`;\r\n        }\r\n        \r\n        // Typed array pools\r\n        report += \"Typed Array Pools:\\n\";\r\n        for (const type in this.typedArrayPoolSizes) {\r\n            report += `  ${type}: ${this.typedArrayPoolSizes[type]} arrays\\n`;\r\n        }\r\n        \r\n        return report;\r\n    },\r\n    \r\n    /**\r\n     * Print memory stats to console\r\n     */\r\n    logReport() {\r\n        console.log(this.getReport());\r\n    }\r\n};\r\n\r\n// Make MemoryStats globally available for debug purposes\r\nwindow.MemoryStats = MemoryStats;\r\n\r\n// Export a no-op function that can replace often-created objects\r\n// to help identify memory hot spots\r\nexport function createNoOpVector() {\r\n    if (window.DEBUG_MODE) {\r\n        console.trace(\"Vector created at:\");\r\n    }\r\n    return window.vectorPool ? window.vectorPool.get() : { x: 0, y: 0, z: 0 };\r\n} ","// ui.js - Main UI class that integrates all UI components\r\n\r\nimport { HUD } from './ui/hud.js';\r\nimport { MobileHUD } from './ui/mobileHUD.js';\r\nimport { MiningDisplay } from './ui/miningDisplay.js';\r\nimport { TargetingUI } from './ui/targetingUI.js';\r\nimport { StargateInterface } from './ui/stargateInterface.js';\r\nimport { GameOverScreen } from './ui/gameOverScreen.js';\r\nimport { ControlsMenu } from './ui/controlsMenu.js';\r\nimport { StarMap } from './ui/starMap.js';\r\nimport { BlackjackGame } from './ui/blackjackGame.js';\r\nimport { Settings } from './ui/settings.js';\r\nimport { StartScreen } from './ui/startScreen.js';\r\nimport { MemoryStats } from '../utils/memoryManager.js';\r\nimport { MobileDetector } from '../utils/mobileDetector.js';\r\n\r\nexport class UI {\r\n    constructor(spaceship, environment) {\r\n        this.spaceship = spaceship;\r\n        this.environment = environment;\r\n        this.controls = null; // Will be set via setControls\r\n        this.audio = null; // Will be set via setAudio\r\n        this.isMobile = MobileDetector.isMobile();\r\n        \r\n        console.log(`Initializing UI components for ${this.isMobile ? 'mobile' : 'desktop'} device...`);\r\n        \r\n        // Load mobile CSS if on mobile device\r\n        if (this.isMobile) {\r\n            this.loadMobileCSS();\r\n        }\r\n        \r\n        // Initialize UI components\r\n        if (this.isMobile) {\r\n            this.hud = new MobileHUD(spaceship);\r\n        } else {\r\n            this.hud = new HUD(spaceship);\r\n        }\r\n        \r\n        this.miningDisplay = new MiningDisplay();\r\n        this.targetingUI = new TargetingUI();\r\n        this.stargateInterface = new StargateInterface();\r\n        this.gameOverScreen = new GameOverScreen();\r\n        this.controlsMenu = new ControlsMenu();\r\n        \r\n        // Initialize star map (requires environment, docking system, and stargate interface)\r\n        this.starMap = new StarMap(this.environment.starSystemGenerator, null, this.stargateInterface);\r\n        \r\n        // Initialize Blackjack game (will be fully initialized after audio is set)\r\n        this.blackjackGame = null;\r\n        \r\n        // Initialize settings (requires game instance)\r\n        this.settings = null;\r\n        \r\n        // Link starMap to stargateInterface\r\n        this.stargateInterface.setStarMap(this.starMap);\r\n        \r\n        // StartScreen will be initialized after game instance is available\r\n        this.startScreen = null;\r\n        \r\n        // Initialize performance monitoring if in debug mode\r\n        if (window.DEBUG_MODE) {\r\n            this.initializePerformanceMonitor();\r\n        }\r\n        \r\n        console.log(\"UI components initialized\");\r\n    }\r\n    \r\n    loadMobileCSS() {\r\n        // Create link element for mobile CSS\r\n        const mobileCSS = document.createElement('link');\r\n        mobileCSS.rel = 'stylesheet';\r\n        mobileCSS.href = 'css/mobile.css';\r\n        mobileCSS.type = 'text/css';\r\n        \r\n        // Add to document head\r\n        document.head.appendChild(mobileCSS);\r\n        \r\n        console.log(\"Mobile CSS loaded\");\r\n    }\r\n    \r\n    setAudio(audio) {\r\n        console.log(\"Setting audio reference in UI\");\r\n        this.audio = audio;\r\n        \r\n        // Now that we have audio, initialize BlackjackGame\r\n        if (this.audio) {\r\n            // Make sure spaceship has cargo property\r\n            if (this.spaceship && !this.spaceship.cargo) {\r\n                this.spaceship.cargo = { iron: 0, gold: 0, platinum: 0 };\r\n                console.warn(\"UI: Created empty cargo object for spaceship\");\r\n            }\r\n            \r\n            this.blackjackGame = new BlackjackGame(null, this.spaceship, this.audio);\r\n            console.log(\"UI: Created BlackjackGame with spaceship:\", this.spaceship);\r\n            \r\n            // Link blackjackGame to stargateInterface\r\n            this.stargateInterface.setBlackjackGame(this.blackjackGame);\r\n        }\r\n    }\r\n    \r\n    setControls(controls) {\r\n        console.log(\"Setting controls reference in UI\");\r\n        this.controls = controls;\r\n        \r\n        // Now that we have controls, we can set it in components that need it\r\n        if (this.miningDisplay.setControls) {\r\n            this.miningDisplay.setControls(this.controls);\r\n        }\r\n        \r\n        // Set controls in the mobile HUD if we're on mobile\r\n        if (this.isMobile && this.hud && this.hud.setControls) {\r\n            this.hud.setControls(this.controls);\r\n        }\r\n        \r\n        // Update star map with docking system\r\n        if (this.starMap && this.controls.dockingSystem) {\r\n            this.starMap.dockingSystem = this.controls.dockingSystem;\r\n        }\r\n        \r\n        // Set up button handlers\r\n        this.setupEventHandlers();\r\n    }\r\n    \r\n    // Initialize settings with the game instance\r\n    initializeSettings(game) {\r\n        if (!game) {\r\n            console.error(\"Cannot initialize settings without game instance\");\r\n            return;\r\n        }\r\n        \r\n        // Create settings\r\n        this.settings = new Settings(game);\r\n        \r\n        // Link settings to stargateInterface\r\n        this.stargateInterface.setSettings(this.settings);\r\n        \r\n        // Initialize start screen now that we have game instance\r\n        this.startScreen = new StartScreen(game, this);\r\n        \r\n        console.log(\"Settings and StartScreen initialized with game instance\");\r\n    }\r\n    \r\n    /**\r\n     * Set up event handlers\r\n     */\r\n    setupEventHandlers() {\r\n        console.log(\"Setting up UI event handlers\");\r\n        \r\n        // Set up controls menu button handler\r\n        if (this.controlsMenu && this.controlsMenu.setupButtonHandler) {\r\n            this.controlsMenu.setupButtonHandler();\r\n        }\r\n        \r\n        // Set up stargate UI control handlers if controls are available\r\n        if (this.controls && this.controls.setupStargateUIControls) {\r\n            this.controls.setupStargateUIControls();\r\n        }\r\n        \r\n        // Listen for UI notification events\r\n        window.mainMessageBus.subscribe('ui.notification', this.handleNotification.bind(this));\r\n        \r\n        // Add resize handler to update mobile detection\r\n        window.addEventListener('resize', () => {\r\n            const wasMobile = this.isMobile;\r\n            this.isMobile = MobileDetector.isMobile();\r\n            \r\n            // If device type changed, reload the page to apply correct UI\r\n            if (wasMobile !== this.isMobile) {\r\n                console.log(`Device type changed from ${wasMobile ? 'mobile' : 'desktop'} to ${this.isMobile ? 'mobile' : 'desktop'}`);\r\n                location.reload();\r\n            }\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Handle UI notification events\r\n     * @param {Object} message The notification message\r\n     */\r\n    handleNotification(message) {\r\n        if (message && message.data) {\r\n            const content = message.data.message || 'System notification';\r\n            const duration = message.data.duration || 3000;\r\n            this.showNotification(content, duration);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle game over event\r\n     * @param {Object} message Event data\r\n     */\r\n    handleGameOver(message) {\r\n        // ... existing code ...\r\n    }\r\n    \r\n    update() {\r\n        // Update appropriate HUD based on device type\r\n        if (this.hud && this.hud.update) {\r\n            this.hud.update();\r\n        }\r\n        \r\n        if (this.miningDisplay && this.miningDisplay.update) {\r\n            this.miningDisplay.update();\r\n        }\r\n        \r\n        // Update touch controls if on mobile\r\n        if (this.isMobile && this.controls && this.controls.touchControls) {\r\n            this.controls.touchControls.update();\r\n        }\r\n    }\r\n    \r\n    updateLocation(locationName) {\r\n        // Get the current star system name from the environment\r\n        let systemName = 'Unknown System';\r\n        if (this.environment && this.environment.starSystemGenerator) {\r\n            const systemData = this.environment.starSystemGenerator.getCurrentSystemData();\r\n            systemName = systemData ? systemData.name : 'Unknown System';\r\n        }\r\n        \r\n        if (this.hud && this.hud.updateLocation) {\r\n            // Only pass the system name since we removed the location display\r\n            this.hud.updateLocation(null, systemName);\r\n        }\r\n    }\r\n    \r\n    updateCoordinates(x, y, z) {\r\n        if (this.hud && this.hud.updateCoordinates) {\r\n            this.hud.updateCoordinates(x, y, z);\r\n        }\r\n    }\r\n    \r\n    updateFPS(fps, cap) {\r\n        if (this.hud && this.hud.updateFPS) {\r\n            // Pass both actual FPS and cap to HUD\r\n            this.hud.updateFPS(fps, cap);\r\n            \r\n            // Control visibility of FPS display based on settings\r\n            if (this.settings && this.settings.settings) {\r\n                const fpsDisplay = document.getElementById('fps-display');\r\n                if (fpsDisplay) {\r\n                    fpsDisplay.style.display = this.settings.settings.showFPS ? 'block' : 'none';\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Show a notification message to the user\r\n     * @param {string} message - The message to display\r\n     * @param {number} duration - Time in milliseconds to show the notification\r\n     */\r\n    showNotification(message, duration = 3000) {\r\n        const notificationsArea = document.getElementById('notifications-area');\r\n        if (!notificationsArea) return;\r\n        \r\n        const notification = document.createElement('div');\r\n        notification.className = 'notification';\r\n        notification.textContent = message;\r\n        notification.style.backgroundColor = 'rgba(6, 22, 31, 0.7)';\r\n        notification.style.backdropFilter = 'blur(5px)';\r\n        notification.style.color = 'rgba(120, 220, 232, 0.9)';\r\n        notification.style.padding = '8px 15px';\r\n        notification.style.borderRadius = '5px';\r\n        notification.style.marginBottom = '10px';\r\n        notification.style.border = '1px solid rgba(120, 220, 232, 0.3)';\r\n        notification.style.boxShadow = '0 0 10px rgba(120, 220, 232, 0.2)';\r\n        notification.style.textAlign = 'center';\r\n        notification.style.opacity = '0';\r\n        notification.style.transition = 'opacity 0.3s';\r\n        \r\n        notificationsArea.appendChild(notification);\r\n        \r\n        // Fade in\r\n        setTimeout(() => {\r\n            notification.style.opacity = '1';\r\n        }, 10);\r\n        \r\n        // Fade out and remove after duration\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            setTimeout(() => {\r\n                if (notification.parentNode) {\r\n                    notification.parentNode.removeChild(notification);\r\n                }\r\n            }, 300);\r\n        }, duration);\r\n    }\r\n    \r\n    showGameOver(resources, message) {\r\n        console.log(\"Showing game over screen\");\r\n        console.log(\"Resources data:\", resources); // Add logging to see structure\r\n        \r\n        // Show game over screen\r\n        if (this.gameOverScreen && this.gameOverScreen.show) {\r\n            // Make sure element exists in DOM first\r\n            if (!document.getElementById('game-over-container')) {\r\n                console.warn(\"Game over container not found in DOM, recreating\");\r\n                this.gameOverScreen.setupGameOverScreen();\r\n            }\r\n            \r\n            // Pass the audio reference to the game over screen\r\n            if (this.audio) {\r\n                this.gameOverScreen.audio = this.audio;\r\n            }\r\n            \r\n            // Pass the message object through directly - gameOverScreen will handle the parsing\r\n            this.gameOverScreen.show(resources, message);\r\n            \r\n            // Remove all direct sound playback from here\r\n            // The GameOverScreen will handle playing the sound\r\n        } else {\r\n            console.error(\"Game over screen not properly initialized\");\r\n            // Create a very simple fallback\r\n            const fallbackOverlay = document.createElement('div');\r\n            fallbackOverlay.id = 'fallback-overlay';\r\n            fallbackOverlay.style.position = 'fixed';\r\n            fallbackOverlay.style.top = '0';\r\n            fallbackOverlay.style.left = '0';\r\n            fallbackOverlay.style.width = '100%';\r\n            fallbackOverlay.style.height = '100%';\r\n            fallbackOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\r\n            fallbackOverlay.style.display = 'flex';\r\n            fallbackOverlay.style.justifyContent = 'center';\r\n            fallbackOverlay.style.alignItems = 'center';\r\n            fallbackOverlay.style.zIndex = '9999';\r\n            \r\n            // Extract message text if it's an object\r\n            const messageText = typeof message === 'string' ? message : \r\n                               (message && message.data && message.data.reason ? message.data.reason : \r\n                                'Your ship was destroyed!');\r\n            \r\n            const content = document.createElement('div');\r\n            content.innerHTML = `\r\n                <h1 style=\"color: #ff3030; font-size: 48px; margin-bottom: 20px;\">GAME OVER</h1>\r\n                <p style=\"color: #fff; font-size: 24px; margin-bottom: 30px;\">${messageText}</p>\r\n                <button id=\"restart-btn\" style=\"padding: 15px 30px; background-color: #ff3030; color: #fff; border: none; \r\n                    font-size: 24px; cursor: pointer; border-radius: 5px;\">RESTART GAME</button>\r\n            `;\r\n            fallbackOverlay.appendChild(content);\r\n            document.body.appendChild(fallbackOverlay);\r\n            \r\n            // Add restart button handler\r\n            document.getElementById('restart-btn').addEventListener('click', () => {\r\n                location.reload();\r\n            });\r\n        }\r\n        \r\n        // Hide other UI elements\r\n        this.hideUI();\r\n    }\r\n    \r\n    hideUI() {\r\n        console.log(\"Hiding UI elements\");\r\n        \r\n        // Force hide ALL UI elements during intro sequence\r\n        if (window.game && window.game.introSequenceActive) {\r\n            console.log(\"Intro sequence active - forcing ALL UI elements to be hidden\");\r\n            \r\n            // Get references to each UI element we need to hide\r\n            const elements = [\r\n                document.getElementById('hud-container'),\r\n                document.getElementById('mobile-hud-container'),\r\n                document.getElementById('pointer-lock-instructions'),\r\n                document.getElementById('notifications-area')\r\n            ];\r\n            \r\n            // Hide each found element (being careful to check if it exists)\r\n            elements.forEach(element => {\r\n                if (element) {\r\n                    element.style.display = 'none';\r\n                }\r\n            });\r\n            \r\n            // Hide any additional UI panels that might be visible\r\n            const allPanels = document.querySelectorAll('.ui-panel, .panel, .hud-panel, .status-panel');\r\n            allPanels.forEach(panel => {\r\n                panel.style.display = 'none';\r\n            });\r\n            \r\n            return; // Skip standard hiding - we've handled everything\r\n        }\r\n        \r\n        // Standard UI hiding for non-intro cases\r\n        // Hide main UI elements but not game over screen\r\n        if (this.hud && this.hud.hide) {\r\n            this.hud.hide();\r\n        }\r\n        \r\n        if (this.miningDisplay && this.miningDisplay.hide) {\r\n            this.miningDisplay.hide();\r\n        }\r\n        \r\n        if (this.targetingUI && this.targetingUI.hideLockOn) {\r\n            this.targetingUI.hideLockOn();\r\n        }\r\n        \r\n        if (this.targetingUI && this.targetingUI.hideTargetInfo) {\r\n            this.targetingUI.hideTargetInfo();\r\n        }\r\n        \r\n        if (this.stargateInterface && this.stargateInterface.hideDockingPrompt) {\r\n            this.stargateInterface.hideDockingPrompt();\r\n        }\r\n        \r\n        // Hide touch controls if on mobile\r\n        if (this.isMobile && this.controls && this.controls.touchControls) {\r\n            this.controls.touchControls.hide();\r\n        }\r\n    }\r\n    \r\n    showUI() {\r\n        console.log(\"Showing UI elements\");\r\n        \r\n        // Don't show UI if intro sequence is active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            console.warn(\"showUI called while intro is still active - not showing UI elements\");\r\n            return; // Exit early - don't show any UI during intro\r\n        }\r\n        \r\n        // Don't show UI if start screen is visible\r\n        if (this.startScreen && this.startScreen.isVisible) {\r\n            console.warn(\"showUI called while start screen is visible - not showing UI elements\");\r\n            return;\r\n        }\r\n        \r\n        // First, show UI components through their interfaces\r\n        if (this.hud && this.hud.show) {\r\n            console.log(\"Calling hud.show()\");\r\n            this.hud.show();\r\n        }\r\n        \r\n        if (this.miningDisplay && this.miningDisplay.show) {\r\n            this.miningDisplay.show();\r\n        }\r\n        \r\n        // Show touch controls if on mobile\r\n        if (this.isMobile && this.controls && this.controls.touchControls) {\r\n            this.controls.touchControls.show();\r\n        }\r\n        \r\n        // FORCE restore elements that might have been forcibly hidden\r\n        // But only if intro is not active\r\n        if (window.game && window.game.introSequenceActive) {\r\n            return; // Double-check intro is not active before forcing visibility\r\n        }\r\n        \r\n        console.log(\"Forcing all UI elements to be displayed\");\r\n        \r\n        // Ensure HUD container is visible\r\n        const hudContainer = document.getElementById('hud-container');\r\n        if (hudContainer) {\r\n            console.log(\"Setting hudContainer to display:block\");\r\n            hudContainer.style.display = 'block';\r\n            hudContainer.style.visibility = 'visible'; // Double ensure visibility\r\n        } else {\r\n            console.warn(\"HUD container not found - could not make visible\");\r\n        }\r\n        \r\n        // Ensure mobile HUD is visible if on mobile\r\n        const mobileHudContainer = document.getElementById('mobile-hud-container');\r\n        if (mobileHudContainer) {\r\n            mobileHudContainer.style.display = 'block';\r\n            mobileHudContainer.style.visibility = 'visible';\r\n        }\r\n        \r\n        // Show pointer lock instructions only if not locked\r\n        const pointerLockInstructions = document.getElementById('pointer-lock-instructions');\r\n        if (pointerLockInstructions && !document.pointerLockElement) {\r\n            pointerLockInstructions.style.display = 'block';\r\n            pointerLockInstructions.style.visibility = 'visible';\r\n        }\r\n        \r\n        // Show notifications area\r\n        const notificationsArea = document.getElementById('notifications-area');\r\n        if (notificationsArea) {\r\n            notificationsArea.style.display = 'block';\r\n            notificationsArea.style.visibility = 'visible';\r\n        }\r\n\r\n        // Also show any panels that might have been hidden\r\n        const allPanels = document.querySelectorAll('.ui-panel, .panel, .hud-panel, .status-panel');\r\n        allPanels.forEach(panel => {\r\n            panel.style.display = 'block';\r\n            panel.style.visibility = 'visible';\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Initialize performance monitor for debugging\r\n     */\r\n    initializePerformanceMonitor() {\r\n        // Create container for performance stats\r\n        const statsContainer = document.createElement('div');\r\n        statsContainer.id = 'performance-stats';\r\n        statsContainer.style.position = 'fixed';\r\n        statsContainer.style.bottom = '10px';\r\n        statsContainer.style.right = '10px';\r\n        statsContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';\r\n        statsContainer.style.color = '#0ff';\r\n        statsContainer.style.padding = '10px';\r\n        statsContainer.style.fontFamily = 'monospace';\r\n        statsContainer.style.fontSize = '12px';\r\n        statsContainer.style.borderRadius = '4px';\r\n        statsContainer.style.zIndex = '1000';\r\n        statsContainer.style.maxWidth = '300px';\r\n        statsContainer.style.maxHeight = '200px';\r\n        statsContainer.style.overflow = 'auto';\r\n        \r\n        // Memory stats container\r\n        const memoryStats = document.createElement('div');\r\n        memoryStats.id = 'memory-stats';\r\n        statsContainer.appendChild(memoryStats);\r\n        \r\n        // FPS counter\r\n        const fpsCounter = document.createElement('div');\r\n        fpsCounter.id = 'fps-counter';\r\n        statsContainer.appendChild(fpsCounter);\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(statsContainer);\r\n        \r\n        // Update stats every second\r\n        this.statsInterval = setInterval(() => {\r\n            // Update memory stats display\r\n            memoryStats.innerHTML = MemoryStats.getReport().replace(/\\n/g, '<br>');\r\n            \r\n            // Display current FPS if available\r\n            if (window.game && window.game.currentFPS) {\r\n                fpsCounter.innerHTML = `FPS: ${Math.round(window.game.currentFPS)}`;\r\n            }\r\n        }, 1000);\r\n    }\r\n    \r\n    // Make sure to clean up stats interval when necessary\r\n    onDisabled() {\r\n        // Clear stats interval if it exists\r\n        if (this.statsInterval) {\r\n            clearInterval(this.statsInterval);\r\n            this.statsInterval = null;\r\n        }\r\n    }\r\n} ","// audio.js - Handles game audio, both music and sound effects with improved resource management\r\n\r\nimport { getAbsolutePath } from '../utils/pathUtils.js';\r\n\r\nexport class AudioManager {\r\n    constructor() {\r\n        // Initialize Web Audio API context\r\n        this.audioContext = null;\r\n        try {\r\n            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();\r\n            console.log(\"Web Audio API context created successfully\");\r\n        } catch (error) {\r\n            console.error(\"Failed to create Web Audio API context:\", error);\r\n        }\r\n        \r\n        this.sounds = {}; // Stores decoded AudioBuffers\r\n        this.soundSources = {}; // Tracks currently playing sound sources\r\n        this.backgroundMusic = [];\r\n        this.currentMusicIndex = 0;\r\n        this.currentMusic = null;\r\n        this.isMuted = false;\r\n        this.thrustSound = null;\r\n        this.music = []; // Store all background music tracks\r\n        this.musicVolume = 0.21; // Reduced by 30% from 0.3\r\n        this.sfxVolume = 0.5; // Default sound effects volume\r\n        \r\n        // Store active audio nodes\r\n        this.activeNodes = new Set();\r\n        \r\n        // Track active continuous sounds\r\n        this.activeSounds = {\r\n            laser: null,\r\n            thrust: null,\r\n            \"mining-laser\": null\r\n        };\r\n        \r\n        // Track if the user has interacted with the page (for autoplay policies)\r\n        this.userHasInteracted = false;\r\n        \r\n        console.log(\"Initializing audio manager with Web Audio API...\");\r\n        \r\n        // Set up compatibility layer for intro sequence\r\n        this.initializeToneCompatibility();\r\n        \r\n        // Listen for user interaction to enable audio\r\n        this.setupUserInteractionListener();\r\n        \r\n        // Set up garbage collection interval\r\n        this.setupGarbageCollection();\r\n    }\r\n    \r\n    // Set up regular garbage collection for unused audio nodes\r\n    setupGarbageCollection() {\r\n        // Clean up inactive nodes every 30 seconds\r\n        this.gcInterval = setInterval(() => this.cleanupInactiveNodes(), 30000);\r\n        console.log(\"Audio garbage collection scheduled\");\r\n    }\r\n    \r\n    // Clean up inactive audio nodes to prevent memory leaks\r\n    cleanupInactiveNodes() {\r\n        let count = 0;\r\n        this.activeNodes.forEach(node => {\r\n            // Check if node is inactive\r\n            if (node._inactive || (node.disposed === true)) {\r\n                this.activeNodes.delete(node);\r\n                count++;\r\n            }\r\n        });\r\n        \r\n        if (count > 0) {\r\n            console.log(`Audio manager: cleaned up ${count} inactive audio objects`);\r\n        }\r\n    }\r\n    \r\n    // Track an audio node for garbage collection\r\n    trackNode(node) {\r\n        if (node) {\r\n            this.activeNodes.add(node);\r\n        }\r\n        return node;\r\n    }\r\n    \r\n    // Initialize a minimal Tone.js compatibility layer for the intro sequence\r\n    initializeToneCompatibility() {\r\n        // Create a dummy masterEQ object that the intro sequence can connect to\r\n        // This allows the intro sequence code to remain unchanged\r\n        this.masterEQ = {\r\n            // Dummy connect method that returns the input\r\n            connect: function(node) {\r\n                return node;\r\n            }\r\n        };\r\n        \r\n        console.log(\"Audio compatibility layer initialized for intro sequence\");\r\n    }\r\n    \r\n    // Initialize audio - load all sounds and music\r\n    async initialize() {\r\n        try {\r\n            console.log(\"Loading audio files...\");\r\n            \r\n            // Ensure audio context is resumed on first user interaction\r\n            if (this.audioContext && this.audioContext.state === 'suspended') {\r\n                this.resumeAudioContext();\r\n            }\r\n            \r\n            // Check if the sound directories exist for music\r\n            await this.checkSoundDirectories();\r\n            \r\n            // Load only the essential UI sounds first for faster startup\r\n            await this.preDecodeEssentialSounds();\r\n            \r\n            // Load music in the background (non-blocking)\r\n            this.loadBackgroundMusic().catch(error => {\r\n                console.error(\"Error loading background music:\", error);\r\n            });\r\n            \r\n            console.log(\"Essential audio initialization complete\");\r\n            \r\n            // Music will play automatically once the user interacts with the page\r\n            // If the user has already interacted, we can play immediately\r\n            if (this.userHasInteracted) {\r\n                this.playBackgroundMusic();\r\n            } else {\r\n                console.log(\"Music playback waiting for user interaction.\");\r\n            }\r\n            \r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"Error initializing audio:\", error);\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    // Pre-decode only essential UI sounds for quick startup\r\n    async preDecodeEssentialSounds() {\r\n        try {\r\n            console.log(\"Pre-decoding essential UI sounds...\");\r\n            \r\n            // List of essential sounds needed for UI interaction\r\n            const essentialSounds = [\r\n                { name: 'boink', path: 'sounds/effects/boink.wav' },\r\n                { name: 'phaserUp', path: 'sounds/effects/phaserUp.wav' },\r\n                { name: 'phaserDown', path: 'sounds/effects/phaserDown.wav' },\r\n            ];\r\n            \r\n            // Create a promise for each sound to load\r\n            const loadPromises = essentialSounds.map(sound => \r\n                this.loadAndDecodeSound(sound.name, this.getPath(sound.path))\r\n            );\r\n            \r\n            // Wait for all essential sounds to be loaded and decoded\r\n            await Promise.all(loadPromises);\r\n            \r\n            console.log(\"Essential UI sounds pre-decoded successfully\");\r\n            \r\n            // Schedule loading of remaining gameplay sounds in the background \r\n            // after a short delay to let the UI fully initialize\r\n            setTimeout(() => {\r\n                this.loadGameplaySounds();\r\n            }, 1000);\r\n            \r\n        } catch (error) {\r\n            console.error(\"Error pre-decoding essential sounds:\", error);\r\n            this.createDummySounds();\r\n        }\r\n    }\r\n    \r\n    // Load remaining gameplay sounds in the background\r\n    async loadGameplaySounds() {\r\n        try {\r\n            console.log(\"Loading gameplay sounds in background...\");\r\n            \r\n            // List of gameplay sounds to load\r\n            const gameplaySounds = [\r\n                { name: 'thrust', path: 'sounds/effects/thrust.wav' },\r\n                { name: 'laser', path: 'sounds/effects/laser.wav' },\r\n                { name: 'mining-laser', path: 'sounds/effects/mining-laser.wav' },\r\n                { name: 'explosion', path: 'sounds/effects/explosion.wav' },\r\n            ];\r\n            \r\n            // Load sounds sequentially to avoid overwhelming the audio decoder\r\n            for (const sound of gameplaySounds) {\r\n                try {\r\n                    await this.loadAndDecodeSound(sound.name, this.getPath(sound.path));\r\n                } catch (err) {\r\n                    console.warn(`Could not load gameplay sound ${sound.name}:`, err);\r\n                }\r\n            }\r\n            \r\n            // Explicitly set up projectile sound using the laser sound\r\n            // This is needed for weapon firing\r\n            if (this.sounds.laser && !this.sounds.projectile) {\r\n                console.log(\"Setting up projectile sound using laser sound buffer\");\r\n                this.sounds.projectile = this.sounds.laser;\r\n            }\r\n            \r\n            console.log(\"All gameplay sounds loaded successfully\");\r\n        } catch (error) {\r\n            console.error(\"Error loading gameplay sounds:\", error);\r\n        }\r\n    }\r\n    \r\n    // Pre-decode all sound effects using Web Audio API (legacy method, kept for compatibility)\r\n    async preDecodeAllSoundEffects() {\r\n        try {\r\n            console.log(\"Using optimized sound loading path instead of preDecodeAllSoundEffects\");\r\n            // Load essential sounds first\r\n            await this.preDecodeEssentialSounds();\r\n            // Then load gameplay sounds\r\n            await this.loadGameplaySounds();\r\n        } catch (error) {\r\n            console.error(\"Error pre-decoding sound effects:\", error);\r\n            this.createDummySounds();\r\n        }\r\n    }\r\n    \r\n    // Load and decode a sound file using Web Audio API\r\n    async loadAndDecodeSound(name, url) {\r\n        try {\r\n            console.log(`Loading and decoding sound: ${name} from ${url}`);\r\n            \r\n            // Fetch the audio file\r\n            const response = await fetch(url);\r\n            if (!response.ok) {\r\n                throw new Error(`Failed to fetch sound ${name}: ${response.status} ${response.statusText}`);\r\n            }\r\n            \r\n            // Get the audio data as an ArrayBuffer\r\n            const audioData = await response.arrayBuffer();\r\n            \r\n            // Decode the audio data\r\n            const audioBuffer = await this.audioContext.decodeAudioData(audioData);\r\n            \r\n            // Store the decoded buffer\r\n            this.sounds[name] = audioBuffer;\r\n            \r\n            console.log(`Sound ${name} loaded and decoded successfully`);\r\n            return audioBuffer;\r\n        } catch (error) {\r\n            console.error(`Error loading and decoding sound ${name}:`, error);\r\n            \r\n            // Create a dummy buffer for this sound to prevent errors\r\n            this.sounds[name] = null;\r\n            throw error;\r\n        }\r\n    }\r\n    \r\n    // Resume audio context on user interaction\r\n    resumeAudioContext() {\r\n        if (this.audioContext && this.audioContext.state === 'suspended') {\r\n            this.audioContext.resume().then(() => {\r\n                console.log(\"AudioContext resumed successfully\");\r\n            }).catch(error => {\r\n                console.error(\"Failed to resume AudioContext:\", error);\r\n            });\r\n        }\r\n    }\r\n    \r\n    // Check if the required sound directories exist and notify user if they don't\r\n    async checkSoundDirectories() {\r\n        // Check for sounds directory\r\n        const soundsDirExists = await this.checkFileExists(this.getPath('sounds'));\r\n        if (!soundsDirExists.exists) {\r\n            console.warn(\"Sounds directory not found, but will attempt to load files directly anyway.\");\r\n        }\r\n        \r\n        // Check for soundtrack directory\r\n        const soundtrackDirExists = await this.checkFileExists(this.getPath('sounds/soundtrack'));\r\n        if (!soundtrackDirExists.exists) {\r\n            console.warn(\"Soundtrack directory not found, but will attempt to load files directly anyway.\");\r\n        }\r\n        \r\n        // Check for sound effects directory\r\n        const effectsDirExists = await this.checkFileExists(this.getPath('sounds/effects'));\r\n        if (!effectsDirExists.exists) {\r\n            console.warn(\"Sound effects directory not found. Some sounds may not play correctly.\");\r\n        }\r\n        \r\n        // Always return true to continue loading process\r\n        return true;\r\n    }\r\n    \r\n    // Show a notification to the user when a directory is missing\r\n    showDirectoryMissingNotification(directory) {\r\n        console.warn(`Directory not found: ${directory}`);\r\n        \r\n        // Create a notification element\r\n        const notification = document.createElement('div');\r\n        notification.style.position = 'fixed';\r\n        notification.style.top = '20px';\r\n        notification.style.left = '50%';\r\n        notification.style.transform = 'translateX(-50%)';\r\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';\r\n        notification.style.color = '#ff4400';\r\n        notification.style.padding = '10px 15px';\r\n        notification.style.borderRadius = '5px';\r\n        notification.style.zIndex = '9999';\r\n        notification.style.fontSize = '14px';\r\n        notification.style.maxWidth = '80%';\r\n        notification.style.textAlign = 'center';\r\n        \r\n        // Add message\r\n        notification.innerHTML = `\r\n            <div style=\"margin-bottom: 5px;\">\r\n                <strong>Note:</strong> ${directory} directory not found.\r\n            </div>\r\n            <div style=\"font-size: 12px; color: #aaa;\">\r\n                Game will continue with limited audio. This is normal when running on GitHub Pages.\r\n            </div>\r\n        `;\r\n        \r\n        // Add close button\r\n        const closeButton = document.createElement('div');\r\n        closeButton.style.position = 'absolute';\r\n        closeButton.style.top = '5px';\r\n        closeButton.style.right = '10px';\r\n        closeButton.style.cursor = 'pointer';\r\n        closeButton.style.color = '#aaa';\r\n        closeButton.textContent = '✕';\r\n        closeButton.addEventListener('click', () => notification.remove());\r\n        notification.appendChild(closeButton);\r\n        \r\n        // Add to document\r\n        document.body.appendChild(notification);\r\n        \r\n        // Auto-remove after 5 seconds\r\n        setTimeout(() => {\r\n            if (document.body.contains(notification)) {\r\n                notification.style.opacity = '0';\r\n                notification.style.transition = 'opacity 0.5s ease';\r\n                setTimeout(() => {\r\n                    if (document.body.contains(notification)) {\r\n                        notification.remove();\r\n                    }\r\n                }, 500);\r\n            }\r\n        }, 5000);\r\n    }\r\n    \r\n    // Set up a listener to detect the first user interaction\r\n    setupUserInteractionListener() {\r\n        const handleInteraction = () => {\r\n            if (!this.userHasInteracted) {\r\n                this.userHasInteracted = true;\r\n                console.log(\"User interaction detected, enabling audio playback\");\r\n                \r\n                // Resume AudioContext if it's suspended\r\n                this.resumeAudioContext();\r\n                \r\n                // Start playing background music once the user interacts\r\n                this.playBackgroundMusic();\r\n                \r\n                // Clean up the event listeners\r\n                document.removeEventListener('click', handleInteraction);\r\n                document.removeEventListener('keydown', handleInteraction);\r\n                document.removeEventListener('touchstart', handleInteraction);\r\n            }\r\n        };\r\n        \r\n        // Add event listeners for user interactions\r\n        document.addEventListener('click', handleInteraction);\r\n        document.addEventListener('keydown', handleInteraction);\r\n        document.addEventListener('touchstart', handleInteraction);\r\n        \r\n        // Additional handling specifically for mobile devices\r\n        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {\r\n            console.log(\"Mobile device detected - adding additional audio handlers\");\r\n            \r\n            // Force audio context resumption on specific UI interactions for mobile\r\n            const forceAudioResume = () => {\r\n                this.userHasInteracted = true;\r\n                \r\n                // Resume AudioContext if it's suspended\r\n                this.resumeAudioContext();\r\n                \r\n                // Ensure background music is playing\r\n                if (this.music.length > 0 && !this.muted) {\r\n                    const currentTrack = this.music[0];\r\n                    if (currentTrack.paused) {\r\n                        console.log(\"Mobile: Forcing background music playback\");\r\n                        this.playBackgroundMusic();\r\n                    }\r\n                }\r\n            };\r\n            \r\n            // Add these handlers to common UI interaction points\r\n            document.addEventListener('touchend', forceAudioResume, {passive: true});\r\n            \r\n            // Attach to specific game buttons when they're created\r\n            const attachToButtons = () => {\r\n                // Check for UI elements every 500ms for 5 seconds after page load\r\n                let attempts = 0;\r\n                const interval = setInterval(() => {\r\n                    attempts++;\r\n                    \r\n                    // Find and attach to important action buttons\r\n                    const actionButtons = document.querySelectorAll('button');\r\n                    if (actionButtons.length > 0) {\r\n                        console.log(`Mobile: Found ${actionButtons.length} buttons to attach audio handlers`);\r\n                        actionButtons.forEach(button => {\r\n                            if (!button.hasAudioHandler) {\r\n                                button.addEventListener('touchend', forceAudioResume, {passive: true});\r\n                                button.hasAudioHandler = true;\r\n                            }\r\n                        });\r\n                    }\r\n                    \r\n                    // Stop checking after 10 attempts (5 seconds)\r\n                    if (attempts >= 10) {\r\n                        clearInterval(interval);\r\n                    }\r\n                }, 500);\r\n            };\r\n            \r\n            // Run initially and also after document is fully loaded\r\n            attachToButtons();\r\n            if (document.readyState === 'complete') {\r\n                attachToButtons();\r\n            } else {\r\n                window.addEventListener('load', attachToButtons);\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Load all music files from the soundtrack folder\r\n    async loadBackgroundMusic() {\r\n        try {\r\n            console.log(\"Loading soundtrack files...\");\r\n            \r\n            // Directly use the exact soundtrack files from the user's folder\r\n            const soundtrackFiles = [\r\n                this.getPath('sounds/soundtrack/The Sound of Lightyears.wav'),\r\n                this.getPath('sounds/soundtrack/Aurora Drifts.wav'),\r\n                this.getPath('sounds/soundtrack/Tidal Lock.wav'),\r\n                this.getPath('sounds/soundtrack/Solar Drift.wav'),\r\n                this.getPath('sounds/soundtrack/Orbital Resonance.wav'),\r\n                this.getPath('sounds/soundtrack/Starlight Trails.wav'),\r\n                this.getPath('sounds/soundtrack/Orbit Bloom.wav')\r\n            ];\r\n            \r\n            console.log(`Loading ${soundtrackFiles.length} soundtrack files...`);\r\n            \r\n            // Load the music files\r\n            await this.loadMusicFiles(soundtrackFiles);\r\n            \r\n        } catch (error) {\r\n            console.error(\"Error loading background music:\", error);\r\n            \r\n            // Create a dummy audio element if loading fails\r\n            console.warn(\"Falling back to a dummy silent track\");\r\n            const dummyAudio = new Audio();\r\n            dummyAudio.loop = true;\r\n            this.music.push(dummyAudio);\r\n        }\r\n    }\r\n    \r\n    // Helper method to check if a file exists\r\n    async checkFileExists(path) {\r\n        console.log(`Checking if file/directory exists: ${path}`);\r\n        try {\r\n            // Try to fetch the resource\r\n            const response = await fetch(path, { \r\n                method: 'HEAD',\r\n                cache: 'no-cache' // Avoid caching issues\r\n            });\r\n            \r\n            console.log(`Fetch response for ${path}: status=${response.status}, ok=${response.ok}`);\r\n            \r\n            return { \r\n                path, \r\n                exists: response.ok \r\n            };\r\n        } catch (err) {\r\n            console.error(`Error checking if file exists (${path}):`, err);\r\n            return { path, exists: false };\r\n        }\r\n    }\r\n    \r\n    // Helper method to handle paths correctly for both local and GitHub Pages deployment\r\n    getPath(relativePath) {\r\n        return getAbsolutePath(relativePath);\r\n    }\r\n    \r\n    // Fisher-Yates shuffle algorithm for arrays\r\n    shuffleArray(array) {\r\n        let currentIndex = array.length, randomIndex;\r\n        \r\n        // While there remain elements to shuffle\r\n        while (currentIndex > 0) {\r\n            // Pick a remaining element\r\n            randomIndex = Math.floor(Math.random() * currentIndex);\r\n            currentIndex--;\r\n            \r\n            // Swap it with the current element\r\n            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];\r\n        }\r\n        \r\n        return array;\r\n    }\r\n    \r\n    // Helper method to load music files\r\n    async loadMusicFiles(files) {\r\n        // Note: Currently keeping music as HTML5 Audio for compatibility\r\n        // Could be updated to Web Audio API in the future\r\n        console.log(`Found ${files.length} music files:`, files);\r\n        \r\n        // Create a copy of the files array and shuffle it to randomize the order\r\n        const shuffledFiles = [...files];\r\n        this.shuffleArray(shuffledFiles);\r\n        \r\n        console.log(`Randomized playlist order:`, shuffledFiles.map(file => file.split('/').pop()));\r\n        \r\n        // Check if any files exist before trying to load them\r\n        let anyFilesExist = false;\r\n        for (const file of shuffledFiles) {\r\n            const fileExists = await this.checkFileExists(file);\r\n            if (fileExists.exists) {\r\n                anyFilesExist = true;\r\n                break;\r\n            }\r\n        }\r\n        \r\n        if (!anyFilesExist) {\r\n            console.warn(\"None of the music files could be found. Using fallback audio.\");\r\n            this.createDummySounds();\r\n            return;\r\n        }\r\n        \r\n        // Load each music track in the randomized order\r\n        for (const file of shuffledFiles) {\r\n            try {\r\n                console.log(`Attempting to load audio file: ${file}`);\r\n                const audio = new Audio(file);\r\n                audio.loop = false; // We'll handle looping manually for playlist functionality\r\n                audio.volume = this.musicVolume;\r\n                \r\n                // Add ended event to play the next track\r\n                audio.addEventListener('ended', () => this.playNextTrack());\r\n                \r\n                // Add error handler\r\n                audio.addEventListener('error', (e) => {\r\n                    console.error(`Error loading music file ${file}:`, e);\r\n                });\r\n                \r\n                // Add a load event to confirm successful loading\r\n                audio.addEventListener('canplaythrough', () => {\r\n                    console.log(`Successfully loaded music file: ${file}`);\r\n                });\r\n                \r\n                this.music.push(audio);\r\n                console.log(`Added music track to playlist: ${file}`);\r\n            } catch (err) {\r\n                console.error(`Failed to load music file ${file}:`, err);\r\n            }\r\n        }\r\n        \r\n        console.log(`Loaded ${this.music.length} music tracks in randomized order`);\r\n        \r\n        // If we haven't found any music, create a dummy audio element\r\n        // so that the music system doesn't break\r\n        if (this.music.length === 0) {\r\n            console.warn(\"No music files could be loaded, creating a dummy track\");\r\n            const dummyAudio = new Audio();\r\n            dummyAudio.loop = true;\r\n            this.music.push(dummyAudio);\r\n        }\r\n    }\r\n    \r\n    // Create dummy sounds if loading fails\r\n    createDummySounds() {\r\n        console.warn(\"Creating dummy silent AudioBuffers as fallback\");\r\n        \r\n        const soundEffects = ['laser', 'thrust', 'explosion', 'boink', 'phaserUp', 'phaserDown', 'mining-laser', 'projectile'];\r\n        \r\n        for (const name of soundEffects) {\r\n            // Create a silent buffer (0.1 seconds of silence)\r\n            if (this.audioContext) {\r\n                try {\r\n                    const buffer = this.audioContext.createBuffer(\r\n                        2, // stereo\r\n                        this.audioContext.sampleRate * 0.1, // 0.1 seconds\r\n                        this.audioContext.sampleRate\r\n                    );\r\n                    this.sounds[name] = buffer;\r\n                } catch (error) {\r\n                    console.error(`Failed to create dummy buffer for ${name}:`, error);\r\n                    this.sounds[name] = null;\r\n                }\r\n            } else {\r\n                this.sounds[name] = null;\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Play the next music track in the playlist\r\n    playNextTrack() {\r\n        if (this.music.length === 0) return;\r\n        \r\n        // Move current track to the end of the playlist\r\n        const currentTrack = this.music.shift();\r\n        this.music.push(currentTrack);\r\n        \r\n        // Play the next track\r\n        this.playBackgroundMusic();\r\n    }\r\n    \r\n    // Start playing background music\r\n    playBackgroundMusic() {\r\n        if (this.music.length === 0 || this.muted) return;\r\n        \r\n        // Only attempt to play if the user has interacted with the page\r\n        if (!this.userHasInteracted) {\r\n            console.log(\"Deferring music playback until user interaction\");\r\n            return;\r\n        }\r\n        \r\n        // Get the track at the front of the queue\r\n        const track = this.music[0];\r\n        console.log(`Starting to play track: ${track.src.split('/').pop()}`);\r\n        \r\n        // Reset the track to the beginning\r\n        track.currentTime = 0;\r\n        \r\n        // Attempt to play the track\r\n        const playPromise = track.play();\r\n        \r\n        // Handle play promise (modern browsers return a promise from play())\r\n        if (playPromise !== undefined) {\r\n            playPromise\r\n                .then(() => {\r\n                    console.log(\"Started playing background music\");\r\n                })\r\n                .catch(err => {\r\n                    if (err.name === 'NotAllowedError') {\r\n                        console.log(\"Autoplay prevented by browser. Music will play after user interaction.\");\r\n                    } else {\r\n                        console.error(\"Error playing background music:\", err);\r\n                    }\r\n                });\r\n        }\r\n    }\r\n    \r\n    // Play a sound effect using Web Audio API\r\n    playSound(name) {\r\n        console.log(`Attempting to play sound: ${name}`);\r\n        \r\n        if (this.muted) {\r\n            console.log(`Sound ${name} not played: audio is muted`);\r\n            return;\r\n        }\r\n        \r\n        if (!this.userHasInteracted) {\r\n            console.log(`Sound ${name} not played: waiting for user interaction`);\r\n            return;\r\n        }\r\n        \r\n        // Make sure AudioContext is running\r\n        if (this.audioContext && this.audioContext.state === 'suspended') {\r\n            this.resumeAudioContext();\r\n        }\r\n        \r\n        // Handle the case where the name is 'weapon' or similar, map to projectile sound\r\n        if (name === 'weapon' || name === 'fire' || name === 'shoot') {\r\n            console.log(`Mapping ${name} sound to projectile sound`);\r\n            name = 'projectile';\r\n            // Use 'laser' sound for projectile if projectile sound is not available\r\n            if (!this.sounds.projectile && this.sounds.laser) {\r\n                console.log(\"Using laser sound for projectile\");\r\n                this.sounds.projectile = this.sounds.laser;\r\n            }\r\n        }\r\n        \r\n        if (!this.sounds[name]) {\r\n            console.warn(`Sound \"${name}\" not found in loaded sounds`);\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            // Handle looped sounds vs one-shot sounds\r\n            if (name === 'laser' || name === 'thrust' || name === 'mining-laser') {\r\n                // For continuous sounds, create and track the sound source node\r\n                if (!this.activeSounds[name]) {\r\n                    // Create source node for looping sound\r\n                    const sourceNode = this.audioContext.createBufferSource();\r\n                    sourceNode.buffer = this.sounds[name];\r\n                    sourceNode.loop = true;\r\n                    \r\n                    // Create gain node for volume control\r\n                    const gainNode = this.audioContext.createGain();\r\n                    gainNode.gain.value = this.sfxVolume * (name === 'thrust' ? 1.5 : 1.0);\r\n                    \r\n                    // Connect nodes: source -> gain -> destination\r\n                    sourceNode.connect(gainNode);\r\n                    gainNode.connect(this.audioContext.destination);\r\n                    \r\n                    // Start playing\r\n                    sourceNode.start(0);\r\n                    \r\n                    // Store references to these nodes for later control\r\n                    this.activeSounds[name] = {\r\n                        source: sourceNode,\r\n                        gain: gainNode\r\n                    };\r\n                    \r\n                    // Track nodes for garbage collection\r\n                    this.trackNode(sourceNode);\r\n                    this.trackNode(gainNode);\r\n                }\r\n            } else {\r\n                // For one-shot sounds\r\n                // Create source node\r\n                const sourceNode = this.audioContext.createBufferSource();\r\n                sourceNode.buffer = this.sounds[name];\r\n                \r\n                // Create gain node for volume control\r\n                const gainNode = this.audioContext.createGain();\r\n                // Increase volume slightly for projectile sounds to make them more noticeable\r\n                const volumeMultiplier = name === 'projectile' ? 0.7 : 0.5;\r\n                gainNode.gain.value = this.sfxVolume * volumeMultiplier;\r\n                \r\n                // Connect nodes: source -> gain -> destination\r\n                sourceNode.connect(gainNode);\r\n                gainNode.connect(this.audioContext.destination);\r\n                \r\n                // Start playing (one-shot)\r\n                sourceNode.start(0);\r\n                \r\n                // Set ended callback for cleanup\r\n                sourceNode.onended = () => {\r\n                    sourceNode._inactive = true;\r\n                    gainNode._inactive = true;\r\n                };\r\n                \r\n                // Track nodes for garbage collection\r\n                this.trackNode(sourceNode);\r\n                this.trackNode(gainNode);\r\n                \r\n                // Log successful playback\r\n                console.log(`Started playback of one-shot sound: ${name}`);\r\n            }\r\n        } catch (err) {\r\n            console.error(`Error playing sound ${name}:`, err);\r\n        }\r\n    }\r\n    \r\n    // Stop a continuous sound effect\r\n    stopSound(name) {\r\n        if (!this.activeSounds[name]) return;\r\n        \r\n        try {\r\n            if (name === 'laser' || name === 'thrust' || name === 'mining-laser') {\r\n                // For looping sounds\r\n                if (this.activeSounds[name]) {\r\n                    const nodes = this.activeSounds[name];\r\n                    \r\n                    // Stop the source node\r\n                    if (nodes.source) {\r\n                        try {\r\n                            nodes.source.stop();\r\n                        } catch (e) {\r\n                            // Ignore errors if already stopped\r\n                        }\r\n                        nodes.source._inactive = true;\r\n                    }\r\n                    \r\n                    // Mark gain node as inactive\r\n                    if (nodes.gain) {\r\n                        nodes.gain._inactive = true;\r\n                    }\r\n                    \r\n                    // Clear reference\r\n                    this.activeSounds[name] = null;\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error(`Error stopping sound ${name}:`, err);\r\n        }\r\n    }\r\n    \r\n    // Set the volume for thrust sound based on thrust level\r\n    setThrustVolume(thrustLevel) {\r\n        if (!this.activeSounds.thrust || !this.activeSounds.thrust.gain) return;\r\n        \r\n        // Scale the volume based on thrust level\r\n        const volume = Math.min(1.0, Math.max(0.1, thrustLevel)) * this.sfxVolume * 1.5;\r\n        \r\n        // Apply volume to gain node\r\n        try {\r\n            this.activeSounds.thrust.gain.gain.value = volume;\r\n        } catch (err) {\r\n            console.error(\"Error setting thrust volume:\", err);\r\n        }\r\n    }\r\n    \r\n    // Toggle mute for all audio\r\n    toggleMute() {\r\n        this.muted = !this.muted;\r\n        \r\n        // Adjust music volume\r\n        for (const track of this.music) {\r\n            track.volume = this.muted ? 0 : this.musicVolume;\r\n        }\r\n        \r\n        // Stop any active sound effects\r\n        if (this.muted) {\r\n            this.stopSound('laser');\r\n            this.stopSound('thrust');\r\n            this.stopSound('mining-laser');\r\n        }\r\n        \r\n        console.log(`Audio ${this.muted ? 'muted' : 'unmuted'}`);\r\n        return this.muted;\r\n    }\r\n    \r\n    // Clean up resources when destroying the audio manager\r\n    cleanup() {\r\n        console.log(\"Cleaning up AudioManager resources...\");\r\n        \r\n        // Stop all active sounds\r\n        this.stopSound('laser');\r\n        this.stopSound('thrust');\r\n        this.stopSound('mining-laser');\r\n        \r\n        // Pause all music\r\n        for (const track of this.music) {\r\n            track.pause();\r\n        }\r\n        \r\n        // Clear intervals\r\n        if (this.gcInterval) {\r\n            clearInterval(this.gcInterval);\r\n            this.gcInterval = null;\r\n        }\r\n        \r\n        // Close audio context\r\n        if (this.audioContext) {\r\n            this.audioContext.close().then(() => {\r\n                console.log(\"AudioContext closed successfully\");\r\n            }).catch(error => {\r\n                console.error(\"Error closing AudioContext:\", error);\r\n            });\r\n        }\r\n        \r\n        // Remove event listeners\r\n        document.removeEventListener('click', this.handleInteraction);\r\n        document.removeEventListener('keydown', this.handleInteraction);\r\n        document.removeEventListener('touchstart', this.handleInteraction);\r\n        \r\n        console.log(\"AudioManager cleanup complete\");\r\n    }\r\n    \r\n    // Play weapon firing sound - dedicated method for weapon sounds\r\n    playWeaponSound() {\r\n        console.log(\"Playing weapon firing sound\");\r\n        \r\n        // Check usual conditions\r\n        if (this.muted || !this.userHasInteracted) {\r\n            return;\r\n        }\r\n        \r\n        // Make sure AudioContext is running\r\n        if (this.audioContext && this.audioContext.state === 'suspended') {\r\n            this.resumeAudioContext();\r\n        }\r\n        \r\n        // Make sure we have a projectile sound (use laser as fallback)\r\n        if (!this.sounds.projectile && this.sounds.laser) {\r\n            console.log(\"Using laser sound for projectile in playWeaponSound\");\r\n            this.sounds.projectile = this.sounds.laser;\r\n        }\r\n        \r\n        if (!this.sounds.projectile) {\r\n            console.warn(\"Projectile sound not found\");\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            // Create source node\r\n            const sourceNode = this.audioContext.createBufferSource();\r\n            sourceNode.buffer = this.sounds.projectile;\r\n            \r\n            // Create gain node with higher volume for weapon sound\r\n            const gainNode = this.audioContext.createGain();\r\n            gainNode.gain.value = this.sfxVolume * 0.8; // Higher volume for weapon sounds\r\n            \r\n            // Connect nodes: source -> gain -> destination\r\n            sourceNode.connect(gainNode);\r\n            gainNode.connect(this.audioContext.destination);\r\n            \r\n            // Start playing\r\n            sourceNode.start(0);\r\n            \r\n            // Set ended callback for cleanup\r\n            sourceNode.onended = () => {\r\n                sourceNode._inactive = true;\r\n                gainNode._inactive = true;\r\n            };\r\n            \r\n            // Track nodes for garbage collection\r\n            this.trackNode(sourceNode);\r\n            this.trackNode(gainNode);\r\n            \r\n            console.log(\"Weapon sound started playing\");\r\n        } catch (err) {\r\n            console.error(\"Error playing weapon sound:\", err);\r\n        }\r\n    }\r\n} ","/**\r\n * Entity Class - Base entity class for ECS architecture\r\n * \r\n * The core building block of the Entity-Component-System pattern.\r\n * Each entity is essentially just an ID with a collection of components\r\n * that define its behavior and properties.\r\n */\r\n\r\nexport class Entity {\r\n    constructor(id, world) {\r\n        this.id = id;\r\n        this.world = world;\r\n        this.components = new Map();\r\n        this.tags = new Set();\r\n        \r\n        // Cache flags for commonly checked tags (initialize as undefined)\r\n        this._isEnemy = undefined;\r\n        this._isPlayer = undefined;\r\n        this._isProjectile = undefined;\r\n        this._isPooled = undefined;\r\n    }\r\n    \r\n    /**\r\n     * Add a component to this entity\r\n     * @param {Component} component The component to add\r\n     * @returns {Entity} This entity for chaining\r\n     */\r\n    addComponent(component) {\r\n        component.entity = this;\r\n        this.components.set(component.constructor.name, component);\r\n        \r\n        // Call onAttached\r\n        if (component.onAttached) {\r\n            component.onAttached();\r\n        }\r\n        \r\n        // Notify the world that a component was added\r\n        if (this.world && this.world.messageBus) {\r\n            this.world.messageBus.publish('component.added', {\r\n                entity: this,\r\n                componentType: component.constructor.name,\r\n                component: component\r\n            });\r\n        }\r\n        \r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Remove a component from this entity\r\n     * @param {Function} componentType The component class to remove\r\n     * @returns {Entity} This entity for chaining\r\n     */\r\n    removeComponent(componentType) {\r\n        const component = this.getComponent(componentType);\r\n        if (component) {\r\n            if (component.onDetached) {\r\n                component.onDetached();\r\n            }\r\n            component.entity = null;\r\n            \r\n            // Get the component type name before deleting\r\n            const componentTypeName = componentType.name;\r\n            this.components.delete(componentTypeName);\r\n            \r\n            // Notify the world that a component was removed\r\n            if (this.world && this.world.messageBus) {\r\n                this.world.messageBus.publish('component.removed', {\r\n                    entity: this,\r\n                    componentType: componentTypeName,\r\n                    component: component\r\n                });\r\n            }\r\n        }\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Get a component of the specified type\r\n     * @param {Function|string} componentType The component class or name to get\r\n     * @returns {Component|null} The component or null if not found\r\n     */\r\n    getComponent(componentType) {\r\n        if (typeof componentType === 'string') {\r\n            return this.components.get(componentType);\r\n        }\r\n        return this.components.get(componentType.name);\r\n    }\r\n    \r\n    /**\r\n     * Check if this entity has a component of the specified type\r\n     * @param {Function|string} componentType The component class or name to check for\r\n     * @returns {boolean} True if the entity has the component\r\n     */\r\n    hasComponent(componentType) {\r\n        if (typeof componentType === 'string') {\r\n            return this.components.has(componentType);\r\n        }\r\n        return this.components.has(componentType.name);\r\n    }\r\n    \r\n    /**\r\n     * Sync internal tag cache with actual tags\r\n     * @private\r\n     */\r\n    _syncTagCache() {\r\n        // Reset all cached flags to match actual tag state\r\n        this._isEnemy = this.tags.has('enemy');\r\n        this._isPlayer = this.tags.has('player');\r\n        this._isProjectile = this.tags.has('projectile');\r\n        this._isPooled = this.tags.has('pooled');\r\n    }\r\n    \r\n    /**\r\n     * Add a tag to this entity\r\n     * @param {string} tag The tag to add\r\n     * @returns {Entity} This entity for chaining\r\n     */\r\n    addTag(tag) {\r\n        if (!this.tags.has(tag)) {\r\n            // Add tag to local Set\r\n            this.tags.add(tag);\r\n            \r\n            // Update cached flags immediately\r\n            if (tag === 'enemy') this._isEnemy = true;\r\n            else if (tag === 'player') this._isPlayer = true;\r\n            else if (tag === 'projectile') this._isProjectile = true;\r\n            else if (tag === 'pooled') this._isPooled = true;\r\n            \r\n            // Update the entity manager's tag index\r\n            if (this.world && this.world.entityManager) {\r\n                this.world.entityManager.onTagAdded(this, tag);\r\n                \r\n                // Verify tag was added to tag index map\r\n                if (!this.world.entityManager.entitiesByTag.has(tag) || \r\n                    !this.world.entityManager.entitiesByTag.get(tag).includes(this)) {\r\n                    console.error(`Failed to register entity ${this.id} with tag '${tag}' in entity manager!`);\r\n                    \r\n                    // Force add entity to tag map as fallback\r\n                    if (!this.world.entityManager.entitiesByTag.has(tag)) {\r\n                        this.world.entityManager.entitiesByTag.set(tag, []);\r\n                    }\r\n                    this.world.entityManager.entitiesByTag.get(tag).push(this);\r\n                    console.log(`Manually fixed tag registration for entity ${this.id} with tag '${tag}'`);\r\n                }\r\n            }\r\n        }\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Remove a tag from this entity\r\n     * @param {string} tag The tag to remove\r\n     * @returns {Entity} This entity for chaining\r\n     */\r\n    removeTag(tag) {\r\n        if (this.tags.has(tag)) {\r\n            // Remove tag from local Set\r\n            this.tags.delete(tag);\r\n            \r\n            // Update cached flags immediately\r\n            if (tag === 'enemy') this._isEnemy = false;\r\n            else if (tag === 'player') this._isPlayer = false;\r\n            else if (tag === 'projectile') this._isProjectile = false;\r\n            else if (tag === 'pooled') this._isPooled = false;\r\n            \r\n            // Update the entity manager's tag index\r\n            if (this.world && this.world.entityManager) {\r\n                this.world.entityManager.onTagRemoved(this, tag);\r\n            }\r\n        }\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Clear all tags from this entity\r\n     * @returns {Entity} This entity for chaining\r\n     */\r\n    clearTags() {\r\n        // Make a copy of the tags to iterate over\r\n        const allTags = [...this.tags];\r\n        \r\n        // Remove each tag properly\r\n        for (const tag of allTags) {\r\n            this.removeTag(tag);\r\n        }\r\n        \r\n        // Reset ALL tag caches to ensure consistency\r\n        this._isEnemy = false;\r\n        this._isPlayer = false;\r\n        this._isProjectile = false;\r\n        this._isPooled = false;\r\n        \r\n        // Verify the local Set is empty\r\n        this.tags.clear();\r\n        \r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Check if this entity has the specified tag\r\n     * @param {string} tag The tag to check for\r\n     * @returns {boolean} True if the entity has the tag\r\n     */\r\n    hasTag(tag) {\r\n        // Use direct Set lookup instead of potentially stale cached values\r\n        const hasTag = this.tags.has(tag);\r\n        \r\n        // Check for inconsistency between cache and actual tags\r\n        // This helps detect and fix cache issues\r\n        let cacheInconsistent = false;\r\n        \r\n        if (tag === 'enemy' && this._isEnemy !== hasTag) {\r\n            console.warn(`Tag cache inconsistency for entity ${this.id}: _isEnemy=${this._isEnemy}, actual=Set{${Array.from(this.tags)}}`);\r\n            this._isEnemy = hasTag; // Fix the cache\r\n            cacheInconsistent = true;\r\n        } \r\n        else if (tag === 'player' && this._isPlayer !== hasTag) {\r\n            console.warn(`Tag cache inconsistency for entity ${this.id}: _isPlayer=${this._isPlayer}, actual=Set{${Array.from(this.tags)}}`);\r\n            this._isPlayer = hasTag; // Fix the cache\r\n            cacheInconsistent = true;\r\n        } \r\n        else if (tag === 'projectile' && this._isProjectile !== hasTag) {\r\n            console.warn(`Tag cache inconsistency for entity ${this.id}: _isProjectile=${this._isProjectile}, actual=Set{${Array.from(this.tags)}}`);\r\n            this._isProjectile = hasTag; // Fix the cache\r\n            cacheInconsistent = true;\r\n        }\r\n        else if (tag === 'pooled' && this._isPooled !== hasTag) {\r\n            console.warn(`Tag cache inconsistency for entity ${this.id}: _isPooled=${this._isPooled}, actual=Set{${Array.from(this.tags)}}`);\r\n            this._isPooled = hasTag; // Fix the cache\r\n            cacheInconsistent = true;\r\n        }\r\n        \r\n        // If we detected an inconsistency, sync the entire cache\r\n        if (cacheInconsistent) {\r\n            this._syncTagCache();\r\n        }\r\n        \r\n        return hasTag;\r\n    }\r\n}","/**\r\n * EntityManager - Manages entity creation, tracking and destruction\r\n * \r\n * Handles entity lifecycle and provides methods to query entities\r\n * based on components or tags.\r\n */\r\n\r\nimport { Entity } from './entity.js';\r\n\r\nexport class EntityManager {\r\n    constructor(world) {\r\n        this.world = world;\r\n        this.entities = new Map();\r\n        // Use WeakMap for entity tracking to allow garbage collection\r\n        this.entitiesByComponent = new Map();\r\n        this.entitiesByTag = new Map();\r\n        this.lastEntityId = 0;\r\n        \r\n        // Entity recycle pool for faster instantiation\r\n        this.recycledEntities = [];\r\n        this.maxRecycledEntities = 100;\r\n    }\r\n    \r\n    /**\r\n     * Create a new entity\r\n     * @param {string} name Optional name for the entity\r\n     * @returns {Entity} The created entity\r\n     */\r\n    createEntity(name = '') {\r\n        // Try to reuse a recycled entity first\r\n        let entity;\r\n        \r\n        if (this.recycledEntities.length > 0) {\r\n            entity = this.recycledEntities.pop();\r\n            entity.components.clear();\r\n            entity.tags.clear();\r\n            entity._isEnemy = undefined;\r\n            entity._isPlayer = undefined;\r\n            entity._isProjectile = undefined;\r\n        } else {\r\n            const id = this._generateEntityId();\r\n            entity = new Entity(id, this.world);\r\n        }\r\n        \r\n        // Add to entities map first\r\n        this.entities.set(entity.id.toString(), entity);\r\n        \r\n        // Add name as tag using the fixed addTag method which will register with entityManager\r\n        if (name) {\r\n            entity.addTag(name);\r\n        }\r\n        \r\n        // Notify systems that an entity was created\r\n        this.world.messageBus.publish('entity.created', { entity });\r\n        \r\n        return entity;\r\n    }\r\n    \r\n    /**\r\n     * Destroy an entity and remove all its components\r\n     * @param {Entity|string} entityOrId The entity or entity ID to destroy\r\n     */\r\n    destroyEntity(entityOrId) {\r\n        const id = typeof entityOrId === 'string' ? entityOrId : entityOrId.id;\r\n        const entity = this.entities.get(id.toString());\r\n        \r\n        if (!entity) return;\r\n        \r\n        // Notify systems that this entity will be destroyed\r\n        this.world.messageBus.publish('entity.destroyed', { entity });\r\n        \r\n        // Remove from tag maps\r\n        entity.tags.forEach(tag => {\r\n            if (this.entitiesByTag.has(tag)) {\r\n                const entities = this.entitiesByTag.get(tag);\r\n                const index = entities.indexOf(entity);\r\n                if (index !== -1) {\r\n                    entities.splice(index, 1);\r\n                }\r\n                \r\n                if (entities.length === 0) {\r\n                    this.entitiesByTag.delete(tag);\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Remove all components\r\n        for (const [componentType, component] of entity.components.entries()) {\r\n            entity.removeComponent(component.constructor);\r\n        }\r\n        \r\n        // Remove from entities map\r\n        this.entities.delete(id.toString());\r\n        \r\n        // Add to recycled entities pool if not full\r\n        if (this.recycledEntities.length < this.maxRecycledEntities) {\r\n            this.recycledEntities.push(entity);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get an entity by ID\r\n     * @param {string} id The entity ID\r\n     * @returns {Entity|undefined} The entity or undefined if not found\r\n     */\r\n    getEntity(id) {\r\n        return this.entities.get(id.toString());\r\n    }\r\n    \r\n    /**\r\n     * Get all entities with the specified tag\r\n     * @param {string} tag The tag to filter by\r\n     * @returns {Entity[]} Array of entities with the tag\r\n     */\r\n    getEntitiesByTag(tag) {\r\n        return this.entitiesByTag.get(tag) || [];\r\n    }\r\n    \r\n    /**\r\n     * Get all entities that have all the specified components\r\n     * @param {Function[]} componentTypes Array of component types\r\n     * @returns {Entity[]} Array of entities with all components\r\n     */\r\n    getEntitiesWithComponents(componentTypes) {\r\n        if (!componentTypes || componentTypes.length === 0) {\r\n            return Array.from(this.entities.values());\r\n        }\r\n        \r\n        return Array.from(this.entities.values()).filter(entity => {\r\n            return componentTypes.every(type => entity.hasComponent(type));\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Get all entities in the manager\r\n     * @returns {Entity[]} Array of all entities\r\n     */\r\n    getEntities() {\r\n        return Array.from(this.entities.values());\r\n    }\r\n    \r\n    /**\r\n     * Update entity tag index when a tag is added\r\n     * @param {Entity} entity The entity\r\n     * @param {string} tag The tag\r\n     */\r\n    onTagAdded(entity, tag) {\r\n        if (!this.entitiesByTag.has(tag)) {\r\n            this.entitiesByTag.set(tag, []);\r\n        }\r\n        \r\n        this.entitiesByTag.get(tag).push(entity);\r\n    }\r\n    \r\n    /**\r\n     * Update entity tag index when a tag is removed\r\n     * @param {Entity} entity The entity\r\n     * @param {string} tag The tag\r\n     */\r\n    onTagRemoved(entity, tag) {\r\n        if (this.entitiesByTag.has(tag)) {\r\n            const entities = this.entitiesByTag.get(tag);\r\n            const index = entities.indexOf(entity);\r\n            \r\n            if (index !== -1) {\r\n                entities.splice(index, 1);\r\n            }\r\n            \r\n            if (entities.length === 0) {\r\n                this.entitiesByTag.delete(tag);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Generate a unique entity ID\r\n     * @returns {string} A unique entity ID\r\n     * @private\r\n     */\r\n    _generateEntityId() {\r\n        return (++this.lastEntityId).toString();\r\n    }\r\n}","/**\r\n * SystemManager - Manages the registration and execution of systems\r\n * \r\n * Handles system priority, updates, and lifecycle.\r\n */\r\n\r\nexport class SystemManager {\r\n    constructor(world) {\r\n        this.world = world;\r\n        this.systems = [];\r\n        this.systemsByType = new Map();\r\n    // perf timings bucket\r\n    if (!window.__perf) window.__perf = { systems: {} };\r\n    this._tick = 0;\r\n    }\r\n    \r\n    /**\r\n     * Register a system with the manager\r\n     * @param {System} system The system to register\r\n     * @returns {System} The registered system\r\n     */\r\n    registerSystem(system) {\r\n        if (this.systemsByType.has(system.constructor.name)) {\r\n            console.warn(`System of type ${system.constructor.name} already registered`);\r\n            return system;\r\n        }\r\n        \r\n        this.systems.push(system);\r\n        this.systemsByType.set(system.constructor.name, system);\r\n        \r\n        // Sort systems by priority (lower = earlier)\r\n        this.systems.sort((a, b) => a.priority - b.priority);\r\n        \r\n        return system;\r\n    }\r\n    \r\n    /**\r\n     * Get a system by type\r\n     * @param {Function} systemType The system class type\r\n     * @returns {System|undefined} The system instance or undefined if not found\r\n     */\r\n    getSystem(systemType) {\r\n        return this.systemsByType.get(systemType.name);\r\n    }\r\n    \r\n    /**\r\n     * Update all enabled systems\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n    this._tick = (this._tick + 1) >>> 0;\r\n    for (const system of this.systems) {\r\n      if (!system.enabled) continue;\r\n      // Stagger heavy systems every 2 ticks (example heuristic)\r\n      const name = system.constructor.name;\r\n      const isHeavy = name === 'EnemySystem' || name === 'CollisionSystem' || name === 'TargetingSystem';\r\n      if (isHeavy && (this._tick & 1) === 1) {\r\n        continue;\r\n      }\r\n      const t0 = performance.now();\r\n      system.update(deltaTime);\r\n      const t1 = performance.now();\r\n      if (window.__perf) {\r\n        if (!window.__perf.systems) window.__perf.systems = {};\r\n        window.__perf.systems[name] = Number(t1 - t0);\r\n      }\r\n    }\r\n    }\r\n    \r\n    /**\r\n     * Initialize all systems\r\n     * Called once before the first update\r\n     */\r\n    initialize() {\r\n        for (const system of this.systems) {\r\n            if (typeof system.initialize === 'function') {\r\n                system.initialize();\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Enable a system by type\r\n     * @param {Function} systemType The system class type\r\n     */\r\n    enableSystem(systemType) {\r\n        const system = this.getSystem(systemType);\r\n        if (system) {\r\n            system.enable();\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Disable a system by type\r\n     * @param {Function} systemType The system class type\r\n     */\r\n    disableSystem(systemType) {\r\n        const system = this.getSystem(systemType);\r\n        if (system) {\r\n            system.disable();\r\n        }\r\n    }\r\n}","// SpatialHash.js - simple 3D spatial hash grid for proximity queries\r\n\r\nexport class SpatialHash {\r\n  constructor(cellSize = 200) {\r\n    this.cellSize = cellSize;\r\n    this.map = new Map(); // key -> Set(entityId)\r\n    this.entityToCells = new Map(); // entityId -> array of keys\r\n  }\r\n\r\n  _key(ix, iy, iz) { return `${ix}|${iy}|${iz}`; }\r\n  _cellIndex(v) { return Math.floor(v / this.cellSize) | 0; }\r\n\r\n  _computeKeysForAABB(min, max) {\r\n    const ix0 = this._cellIndex(min.x), iy0 = this._cellIndex(min.y), iz0 = this._cellIndex(min.z);\r\n    const ix1 = this._cellIndex(max.x), iy1 = this._cellIndex(max.y), iz1 = this._cellIndex(max.z);\r\n    const keys = [];\r\n    for (let ix = ix0; ix <= ix1; ix++)\r\n      for (let iy = iy0; iy <= iy1; iy++)\r\n        for (let iz = iz0; iz <= iz1; iz++)\r\n          keys.push(this._key(ix, iy, iz));\r\n    return keys;\r\n  }\r\n\r\n  insert(entityId, position, radius = 1) {\r\n    const min = { x: position.x - radius, y: position.y - radius, z: position.z - radius };\r\n    const max = { x: position.x + radius, y: position.y + radius, z: position.z + radius };\r\n    const keys = this._computeKeysForAABB(min, max);\r\n    this.entityToCells.set(entityId, keys);\r\n    for (const k of keys) {\r\n      let set = this.map.get(k);\r\n      if (!set) { set = new Set(); this.map.set(k, set); }\r\n      set.add(entityId);\r\n    }\r\n  }\r\n\r\n  update(entityId, position, radius = 1) {\r\n    this.remove(entityId);\r\n    this.insert(entityId, position, radius);\r\n  }\r\n\r\n  remove(entityId) {\r\n    const keys = this.entityToCells.get(entityId);\r\n    if (!keys) return;\r\n    for (const k of keys) {\r\n      const set = this.map.get(k);\r\n      if (set) {\r\n        set.delete(entityId);\r\n        if (set.size === 0) this.map.delete(k);\r\n      }\r\n    }\r\n    this.entityToCells.delete(entityId);\r\n  }\r\n\r\n  querySphere(center, radius) {\r\n    const min = { x: center.x - radius, y: center.y - radius, z: center.z - radius };\r\n    const max = { x: center.x + radius, y: center.y + radius, z: center.z + radius };\r\n    const keys = this._computeKeysForAABB(min, max);\r\n    const result = new Set();\r\n    for (const k of keys) {\r\n      const set = this.map.get(k);\r\n      if (set) for (const id of set) result.add(id);\r\n    }\r\n    return Array.from(result);\r\n  }\r\n}\r\n\r\n\r\n","// EntityIndex.js - track entity lookups and mesh/instance mapping\r\n\r\nexport class EntityIndex {\r\n  constructor() {\r\n    this.entityToView = new Map(); // entityId -> { meshRef, instanceKey, instanceId }\r\n    this.tagToEntities = new Map(); // tag -> Set(entityId)\r\n  }\r\n\r\n  setView(entityId, view) {\r\n    this.entityToView.set(entityId, view);\r\n  }\r\n  getView(entityId) { return this.entityToView.get(entityId); }\r\n  clearView(entityId) { this.entityToView.delete(entityId); }\r\n\r\n  addTag(entityId, tag) {\r\n    let set = this.tagToEntities.get(tag);\r\n    if (!set) { set = new Set(); this.tagToEntities.set(tag, set); }\r\n    set.add(entityId);\r\n  }\r\n  removeTag(entityId, tag) {\r\n    const set = this.tagToEntities.get(tag);\r\n    if (set) { set.delete(entityId); if (set.size === 0) this.tagToEntities.delete(tag); }\r\n  }\r\n  getByTag(tag) {\r\n    const set = this.tagToEntities.get(tag);\r\n    return set ? Array.from(set) : [];\r\n  }\r\n}\r\n\r\n\r\n","/**\r\n * World - Main container class for the ECS architecture\r\n * \r\n * The World manages the entire ECS setup, including entities,\r\n * components, systems, and messaging.\r\n */\r\n\r\nimport { EntityManager } from './entityManager.js';\r\nimport { SystemManager } from './systemManager.js';\r\nimport { MessageBus } from './messageBus.js';\r\nimport { SpatialHash } from './spatial/SpatialHash.js';\r\nimport { EntityIndex } from './EntityIndex.js';\r\n\r\nexport class World {\r\n    constructor(messageBus = null) {\r\n        // Use provided message bus or create a new one\r\n        // This allows sharing the message bus between World and Game\r\n        this.messageBus = messageBus || new MessageBus();\r\n        \r\n        // If we created a new message bus, make it accessible globally\r\n        if (!messageBus && !window.mainMessageBus) {\r\n            window.mainMessageBus = this.messageBus;\r\n            console.log(\"World: Set this.messageBus as window.mainMessageBus\");\r\n        }\r\n        \r\n        // Create managers\r\n        this.entityManager = new EntityManager(this);\r\n        this.systemManager = new SystemManager(this);\r\n        this.spatial = new SpatialHash(400); // cell size tuned later\r\n        this.index = new EntityIndex();\r\n        \r\n        // Time tracking\r\n        this.deltaTime = 0;\r\n        this.time = 0;\r\n        this.lastUpdateTime = 0;\r\n    }\r\n    \r\n    /**\r\n     * Initialize the world and all systems\r\n     */\r\n    initialize() {\r\n        this.lastUpdateTime = performance.now();\r\n        this.systemManager.initialize();\r\n        this.messageBus.publish('world.initialized', {});\r\n    }\r\n\r\n    // Hook for systems to notify when entity moved\r\n    onEntityTransformUpdated(entity) {\r\n        const t = entity.getComponent && entity.getComponent('TransformComponent');\r\n        if (t) this.spatial.update(entity.id, t.position, entity.collisionRadius || 1);\r\n    }\r\n    \r\n    /**\r\n     * Update all systems\r\n     */\r\n    update() {\r\n        // Calculate delta time\r\n        const now = performance.now();\r\n        this.deltaTime = Math.min((now - this.lastUpdateTime) / 1000, 0.1); // Cap at 100ms\r\n        this.lastUpdateTime = now;\r\n        this.time += this.deltaTime;\r\n        \r\n        // Publish pre-update message\r\n        this.messageBus.publish('world.preUpdate', { deltaTime: this.deltaTime, time: this.time });\r\n        \r\n        // Update all systems\r\n        this.systemManager.update(this.deltaTime);\r\n        \r\n        // Publish post-update message\r\n        this.messageBus.publish('world.postUpdate', { deltaTime: this.deltaTime, time: this.time });\r\n        \r\n        // For debugging - log active entities in dev console\r\n        if (window.DEBUG_MODE && this.time % 5 < this.deltaTime) {\r\n            // Get all entities from entity manager using values from the map\r\n            const entities = Array.from(this.entityManager.entities.values());\r\n            console.log(`World update - ${entities.length} entities active`);\r\n            const entitiesWithMesh = this.getEntitiesWithComponents(['MeshComponent']);\r\n            console.log(`Entities with mesh: ${entitiesWithMesh.length}`);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Create a new entity\r\n     * @param {string} name Optional name for the entity\r\n     * @returns {Entity} The created entity\r\n     */\r\n    createEntity(name = '') {\r\n        return this.entityManager.createEntity(name);\r\n    }\r\n    \r\n    /**\r\n     * Destroy an entity\r\n     * @param {Entity|string} entityOrId The entity or entity ID to destroy\r\n     */\r\n    destroyEntity(entityOrId) {\r\n        this.entityManager.destroyEntity(entityOrId);\r\n    }\r\n    \r\n    /**\r\n     * Register a system\r\n     * @param {System} system The system to register\r\n     * @returns {System} The registered system\r\n     */\r\n    registerSystem(system) {\r\n        return this.systemManager.registerSystem(system);\r\n    }\r\n    \r\n    /**\r\n     * Get entities with specific components\r\n     * @param {Function[]} componentTypes Array of component types\r\n     * @returns {Entity[]} Array of entities with all components\r\n     */\r\n    getEntitiesWithComponents(componentTypes) {\r\n        return this.entityManager.getEntitiesWithComponents(componentTypes);\r\n    }\r\n    \r\n    /**\r\n     * Get entities with a specific tag\r\n     * @param {string} tag The tag to filter by\r\n     * @returns {Entity[]} Array of entities with the tag\r\n     */\r\n    getEntitiesByTag(tag) {\r\n        return this.entityManager.getEntitiesByTag(tag);\r\n    }\r\n    \r\n    /**\r\n     * Get a specific entity by ID\r\n     * @param {string} id The entity ID\r\n     * @returns {Entity|undefined} The entity or undefined if not found\r\n     */\r\n    getEntity(id) {\r\n        return this.entityManager.getEntity(id);\r\n    }\r\n    \r\n    /**\r\n     * Get a system by type\r\n     * @param {Function} systemType The system class type\r\n     * @returns {System|undefined} The system instance or undefined if not found\r\n     */\r\n    getSystem(systemType) {\r\n        return this.systemManager.getSystem(systemType);\r\n    }\r\n}","/**\r\n * System Base Class - Base class for all ECS systems\r\n * \r\n * Systems operate on entities that have specific components.\r\n * They contain the logic that processes entity data.\r\n */\r\n\r\nexport class System {\r\n    constructor(world) {\r\n        this.world = world;\r\n        this.enabled = true;\r\n        this.requiredComponents = []; // Component types required for processing\r\n        this.priority = 0; // Execution order (lower = earlier)\r\n    }\r\n    \r\n    /**\r\n     * Check if entity has all required components for this system\r\n     * @param {Entity} entity The entity to check\r\n     * @returns {boolean} True if entity can be processed by this system\r\n     */\r\n    checkEntity(entity) {\r\n        return this.requiredComponents.every(componentType => \r\n            entity.hasComponent(componentType));\r\n    }\r\n    \r\n    /**\r\n     * Get all entities that match this system's requirements\r\n     * @returns {Entity[]} Array of compatible entities\r\n     */\r\n    getEntities() {\r\n        return this.world.getEntitiesWithComponents(this.requiredComponents);\r\n    }\r\n    \r\n    /**\r\n     * Update method called each frame\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        if (!this.enabled) return;\r\n        \r\n        const entities = this.getEntities();\r\n        entities.forEach(entity => {\r\n            this.processEntity(entity, deltaTime);\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Process a single entity\r\n     * @param {Entity} entity The entity to process\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    processEntity(entity, deltaTime) {\r\n        // Override in derived systems\r\n    }\r\n    \r\n    /**\r\n     * Initialize the system\r\n     * Called once when the system is first registered\r\n     */\r\n    initialize() {\r\n        // Base implementation does nothing\r\n        // Override in derived systems for initialization logic\r\n    }\r\n    \r\n    /**\r\n     * Enable this system\r\n     */\r\n    enable() {\r\n        this.enabled = true;\r\n    }\r\n    \r\n    /**\r\n     * Disable this system\r\n     */\r\n    disable() {\r\n        this.enabled = false;\r\n    }\r\n}","/**\r\n * Component Base Class - Foundation for all ECS components\r\n * \r\n * Components hold data and state but typically have no logic.\r\n * They can define lifecycle methods that are called by the entity system.\r\n */\r\n\r\nexport class Component {\r\n    constructor() {\r\n        this.entity = null;\r\n        this.enabled = true;\r\n    }\r\n    \r\n    /**\r\n     * Called when the component is attached to an entity\r\n     * Override in derived components if needed\r\n     */\r\n    onAttached() {}\r\n    \r\n    /**\r\n     * Called when the component is detached from an entity\r\n     * Override in derived components if needed\r\n     */\r\n    onDetached() {}\r\n    \r\n    /**\r\n     * Called when the component is enabled\r\n     * Override in derived components if needed\r\n     */\r\n    onEnabled() {}\r\n    \r\n    /**\r\n     * Called when the component is disabled\r\n     * Override in derived components if needed\r\n     */\r\n    onDisabled() {}\r\n    \r\n    /**\r\n     * Enable this component\r\n     * @returns {Component} This component for chaining\r\n     */\r\n    enable() {\r\n        if (!this.enabled) {\r\n            this.enabled = true;\r\n            this.onEnabled();\r\n        }\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Disable this component\r\n     * @returns {Component} This component for chaining\r\n     */\r\n    disable() {\r\n        if (this.enabled) {\r\n            this.enabled = false;\r\n            this.onDisabled();\r\n        }\r\n        return this;\r\n    }\r\n}","/**\r\n * HealthComponent - Handles health, shield, and damage for entities\r\n * \r\n * Manages health, shields, and damage application for both players and enemies\r\n */\r\n\r\nimport { Component } from '../../core/component.js';\r\n\r\nexport class HealthComponent extends Component {\r\n    constructor(maxHealth = 100, maxShield = 0) {\r\n        super();\r\n        \r\n        // Health properties\r\n        this.maxHealth = maxHealth;\r\n        this.health = maxHealth;\r\n        \r\n        // Shield properties\r\n        this.maxShield = maxShield;\r\n        this.shield = maxShield;\r\n        this.shieldRegenRate = 5; // Shield points per second\r\n        this.shieldRegenDelay = 3; // Seconds after damage before regeneration starts\r\n        this.timeSinceLastDamage = this.shieldRegenDelay; // Start regenerating immediately\r\n        \r\n        // Resistance properties (damage reduction percentage)\r\n        this.damageResistance = 0; // 0-1 range, 0.5 = 50% damage reduction\r\n        \r\n        // Status\r\n        this.isDestroyed = false;\r\n        this.isInvulnerable = false;\r\n        \r\n        console.log(`Created health component with ${maxHealth} max health and ${maxShield} max shield`);\r\n    }\r\n    \r\n    // Add an onAttached method to subscribe to health sync events\r\n    onAttached() {\r\n        // Only subscribe for player entities\r\n        if (this.entity && this.entity.hasTag && this.entity.hasTag('player')) {\r\n            console.log(\"HealthComponent attached to player entity - subscribing to sync events\");\r\n            \r\n            // Subscribe to health sync events on the message bus\r\n            if (this.entity.world && this.entity.world.messageBus) {\r\n                this.entity.world.messageBus.subscribe('player.syncHealth', this.handleSyncHealth.bind(this));\r\n                this.entity.world.messageBus.subscribe('player.undocked', this.handleSyncHealth.bind(this));\r\n                console.log(\"Subscribed to player.syncHealth and player.undocked events\");\r\n            } else if (window.mainMessageBus) {\r\n                window.mainMessageBus.subscribe('player.syncHealth', this.handleSyncHealth.bind(this));\r\n                window.mainMessageBus.subscribe('player.undocked', this.handleSyncHealth.bind(this));\r\n                console.log(\"Subscribed to player.syncHealth and player.undocked events via mainMessageBus\");\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Handle the sync health event\r\n    handleSyncHealth(message) {\r\n        // Only apply if this component is attached to a player entity\r\n        if (!this.entity || !this.entity.hasTag || !this.entity.hasTag('player')) {\r\n            return;\r\n        }\r\n        \r\n        console.log(\"HealthComponent received syncHealth event:\", message);\r\n        \r\n        // CRITICAL FIX: The message from MessageBus has a nested data property\r\n        // Extract the actual sync data from the message\r\n        const data = message.data || message;\r\n        \r\n        console.log(\"Extracted sync data:\", data);\r\n        \r\n        // Update shield values if provided\r\n        if (data.shield !== undefined) {\r\n            const oldShield = this.shield;\r\n            \r\n            // SHIELD SYNC: Add additional logging to debug shield sync issues\r\n            console.log(`SHIELD SYNC: HealthComponent shield was ${oldShield}, spaceship shield is ${data.shield}`);\r\n            \r\n            // Set shield value from spaceship\r\n            this.shield = data.shield;\r\n            \r\n            console.log(`Updated shield: ${oldShield} → ${this.shield}`);\r\n        } else {\r\n            console.warn(\"Shield value not provided in sync data\");\r\n        }\r\n        \r\n        if (data.maxShield !== undefined) {\r\n            const oldMaxShield = this.maxShield;\r\n            this.maxShield = data.maxShield;\r\n            console.log(`Updated maxShield: ${oldMaxShield} → ${this.maxShield}`);\r\n        } else {\r\n            console.warn(\"MaxShield value not provided in sync data\");\r\n        }\r\n        \r\n        // Update health values if provided\r\n        if (data.hull !== undefined) {\r\n            const oldHealth = this.health;\r\n            this.health = data.hull;\r\n            console.log(`Updated health: ${oldHealth} → ${this.health}`);\r\n        } else {\r\n            console.warn(\"Hull value not provided in sync data\");\r\n        }\r\n        \r\n        if (data.maxHull !== undefined) {\r\n            const oldMaxHealth = this.maxHealth;\r\n            this.maxHealth = data.maxHull;\r\n            console.log(`Updated maxHealth: ${oldMaxHealth} → ${this.maxHealth}`);\r\n        } else {\r\n            console.warn(\"MaxHull value not provided in sync data\");\r\n        }\r\n        \r\n        console.log(`HealthComponent synced: Health ${this.health}/${this.maxHealth}, Shield ${this.shield}/${this.maxShield}`);\r\n    }\r\n    \r\n    /**\r\n     * Apply damage to this entity\r\n     * @param {number} amount Amount of damage to apply\r\n     * @param {string} type Type of damage (e.g., 'projectile', 'collision', 'emp')\r\n     * @param {object} source Source entity of the damage\r\n     * @returns {object} Damage result with actual damage dealt\r\n     */\r\n    applyDamage(amount, type = 'projectile', source = null) {\r\n        // Debug logging\r\n        console.log(`HealthComponent: Applying ${amount} damage of type ${type} to entity ${this.entity ? this.entity.id : 'unknown'}`);\r\n        console.log(`Current health: ${this.health}/${this.maxHealth}, Shield: ${this.shield}/${this.maxShield}`);\r\n        \r\n        // Check if entity can be damaged\r\n        if (this.isDestroyed || this.isInvulnerable) {\r\n            console.log(\"Entity is destroyed or invulnerable, damage not applied\");\r\n            return { damageApplied: 0, shieldDamage: 0, healthDamage: 0, destroyed: false };\r\n        }\r\n        \r\n        // Apply damage resistance\r\n        const resistedAmount = amount * (1 - this.damageResistance);\r\n        \r\n        // Track how much damage was applied to shields vs health\r\n        let shieldDamage = 0;\r\n        let healthDamage = 0;\r\n        \r\n        // Reset shield regeneration timer\r\n        this.timeSinceLastDamage = 0;\r\n        \r\n        // Apply damage to shield first if available\r\n        if (this.shield > 0) {\r\n            if (resistedAmount <= this.shield) {\r\n                // Shield absorbs all damage\r\n                this.shield -= resistedAmount;\r\n                shieldDamage = resistedAmount;\r\n            } else {\r\n                // Damage breaks through shield\r\n                shieldDamage = this.shield;\r\n                healthDamage = resistedAmount - this.shield;\r\n                this.shield = 0;\r\n                this.health -= healthDamage;\r\n            }\r\n        } else {\r\n            // No shield, apply damage directly to health\r\n            this.health -= resistedAmount;\r\n            healthDamage = resistedAmount;\r\n        }\r\n        \r\n        // Ensure health doesn't go below 0\r\n        if (this.health < 0) {\r\n            this.health = 0;\r\n        }\r\n        \r\n        // Check if entity is destroyed\r\n        if (this.health <= 0 && !this.isDestroyed) {\r\n            this.isDestroyed = true;\r\n            \r\n            // Notify entity destruction\r\n            if (this.entity && this.entity.world) {\r\n                this.entity.world.messageBus.publish('entity.destroyed', {\r\n                    entity: this.entity,\r\n                    source: source,\r\n                    damageType: type\r\n                });\r\n                \r\n                // Additional check for player entity - publish game over event\r\n                if (this.entity.hasTag && this.entity.hasTag('player')) {\r\n                    console.log(\"PLAYER HEALTH COMPONENT DESTROYED - TRIGGERING GAME OVER\");\r\n                    \r\n                    console.log(\"HealthComponent: Initiating game over sequence\");\r\n                    \r\n                    // Use direct world message bus\r\n                    if (this.entity && this.entity.world && this.entity.world.messageBus) {\r\n                        console.log(\"HealthComponent: Publishing game.over via world.messageBus\");\r\n                        this.entity.world.messageBus.publish('game.over', {\r\n                            reason: \"You were pwned by a space alien!\",\r\n                            source: \"health\"\r\n                        });\r\n                    } else {\r\n                        // Import MessageBus to use the static method if needed\r\n                        import('../../core/messageBus.js').then(module => {\r\n                            const MessageBus = module.MessageBus;\r\n                            console.log(\"HealthComponent: Using MessageBus.triggerGameOver\");\r\n                            \r\n                            // Use the static method for handling\r\n                            MessageBus.triggerGameOver(\"You were pwned by a space alien!\", \"health\");\r\n                        }).catch(err => {\r\n                            console.error(\"Error importing MessageBus:\", err);\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Notify about damage\r\n        if (this.entity && this.entity.world) {\r\n            this.entity.world.messageBus.publish('entity.damaged', {\r\n                entity: this.entity,\r\n                source: source,\r\n                damageType: type,\r\n                amount: resistedAmount,\r\n                shieldDamage: shieldDamage,\r\n                healthDamage: healthDamage\r\n            });\r\n        }\r\n        \r\n        // More debug logging \r\n        console.log(`After damage: Health: ${this.health}/${this.maxHealth}, Shield: ${this.shield}/${this.maxShield}`);\r\n        console.log(`Entity destroyed: ${this.isDestroyed}`);\r\n        \r\n        return {\r\n            damageApplied: resistedAmount,\r\n            shieldDamage: shieldDamage,\r\n            healthDamage: healthDamage,\r\n            destroyed: this.isDestroyed\r\n        };\r\n    }\r\n    \r\n    /**\r\n     * Heal the entity\r\n     * @param {number} amount Amount to heal\r\n     * @returns {number} Actual amount healed\r\n     */\r\n    heal(amount) {\r\n        if (this.isDestroyed) return 0;\r\n        \r\n        const startHealth = this.health;\r\n        this.health = Math.min(this.health + amount, this.maxHealth);\r\n        \r\n        const healedAmount = this.health - startHealth;\r\n        \r\n        if (healedAmount > 0 && this.entity && this.entity.world) {\r\n            this.entity.world.messageBus.publish('entity.healed', {\r\n                entity: this.entity,\r\n                amount: healedAmount\r\n            });\r\n        }\r\n        \r\n        return healedAmount;\r\n    }\r\n    \r\n    /**\r\n     * Recharge the shield\r\n     * @param {number} amount Amount to recharge\r\n     * @returns {number} Actual amount recharged\r\n     */\r\n    rechargeShield(amount) {\r\n        if (this.isDestroyed) return 0;\r\n        \r\n        const startShield = this.shield;\r\n        this.shield = Math.min(this.shield + amount, this.maxShield);\r\n        \r\n        const rechargedAmount = this.shield - startShield;\r\n        \r\n        if (rechargedAmount > 0 && this.entity && this.entity.world) {\r\n            this.entity.world.messageBus.publish('entity.shieldRecharged', {\r\n                entity: this.entity,\r\n                amount: rechargedAmount\r\n            });\r\n        }\r\n        \r\n        return rechargedAmount;\r\n    }\r\n    \r\n    /**\r\n     * Update shield and health regeneration\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        if (this.isDestroyed) return;\r\n        \r\n        // Update timer since last damage\r\n        this.timeSinceLastDamage += deltaTime;\r\n        \r\n        // Regenerate shields if enough time has passed since last damage\r\n        if (this.timeSinceLastDamage >= this.shieldRegenDelay && this.shield < this.maxShield) {\r\n            const regenAmount = this.shieldRegenRate * deltaTime;\r\n            this.rechargeShield(regenAmount);\r\n        }\r\n        \r\n        // Regenerate hull health slowly (only for player)\r\n        if (this.entity && this.entity.hasTag('player') && this.health < this.maxHealth) {\r\n            // Regenerate 5% of max health per second\r\n            const healthRegenRate = this.maxHealth * 0.05;\r\n            const healthRegenAmount = healthRegenRate * deltaTime;\r\n            this.heal(healthRegenAmount);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get health as a percentage (0-100)\r\n     * @returns {number} Health percentage\r\n     */\r\n    getHealthPercentage() {\r\n        return (this.health / this.maxHealth) * 100;\r\n    }\r\n    \r\n    /**\r\n     * Get shield as a percentage (0-100)\r\n     * @returns {number} Shield percentage\r\n     */\r\n    getShieldPercentage() {\r\n        return this.maxShield > 0 ? (this.shield / this.maxShield) * 100 : 0;\r\n    }\r\n    \r\n    /**\r\n     * Upgrade health capacity and fully heal\r\n     * @param {number} multiplier Multiplier for health increase\r\n     * @returns {object} New health stats\r\n     */\r\n    upgradeHealth(multiplier = 1.25) {\r\n        const oldMax = this.maxHealth;\r\n        this.maxHealth *= multiplier;\r\n        this.health = this.maxHealth; // Full heal on upgrade\r\n        \r\n        console.log(`Upgraded health from ${oldMax.toFixed(1)} to ${this.maxHealth.toFixed(1)}`);\r\n        \r\n        // Notify upgrade\r\n        if (this.entity && this.entity.world) {\r\n            this.entity.world.messageBus.publish('health.upgraded', {\r\n                entity: this.entity,\r\n                oldMax: oldMax,\r\n                newMax: this.maxHealth\r\n            });\r\n        }\r\n        \r\n        return {\r\n            maxHealth: this.maxHealth,\r\n            healthBoost: this.maxHealth - oldMax\r\n        };\r\n    }\r\n    \r\n    /**\r\n     * Upgrade shield capacity\r\n     * @param {number} multiplier Multiplier for shield increase\r\n     * @returns {object} New shield stats\r\n     */\r\n    upgradeShield(multiplier = 1.5) {\r\n        console.log(`===== SHIELD UPGRADE INITIATED =====`);\r\n        console.log(`Current shield values - Max: ${this.maxShield}, Current: ${this.shield}`);\r\n        \r\n        const oldMax = this.maxShield;\r\n        const oldShield = this.shield;\r\n        \r\n        // Increase max shield\r\n        this.maxShield = Math.ceil(this.maxShield * multiplier);\r\n        \r\n        // Full recharge on upgrade - this is the original behavior\r\n        this.shield = this.maxShield;\r\n        \r\n        console.log(`Upgraded shield from ${oldMax.toFixed(1)} to ${this.maxShield.toFixed(1)}`);\r\n        console.log(`Current shield value changed from ${oldShield.toFixed(1)} to ${this.shield.toFixed(1)}`);\r\n        console.log(`===== SHIELD UPGRADE COMPLETED =====`);\r\n        \r\n        // Notify upgrade\r\n        if (this.entity && this.entity.world) {\r\n            this.entity.world.messageBus.publish('shield.upgraded', {\r\n                entity: this.entity,\r\n                oldMax: oldMax,\r\n                newMax: this.maxShield\r\n            });\r\n        }\r\n        \r\n        return {\r\n            maxShield: this.maxShield,\r\n            shieldBoost: this.maxShield - oldMax\r\n        };\r\n    }\r\n}","/**\r\n * TransformComponent - Position, rotation, scale component\r\n * \r\n * Handles spatial transformation of entities in the 3D world.\r\n */\r\n\r\nimport { Component } from '../core/component.js';\r\nimport * as THREE from 'three';\r\n\r\nexport class TransformComponent extends Component {\r\n    constructor(position = new THREE.Vector3(), rotation = new THREE.Euler(), scale = new THREE.Vector3(1, 1, 1)) {\r\n        super();\r\n        this.position = position.clone();\r\n        this.rotation = rotation.clone();\r\n        this.scale = scale.clone();\r\n        this.quaternion = new THREE.Quaternion().setFromEuler(this.rotation);\r\n        this.matrix = new THREE.Matrix4();\r\n        this.needsUpdate = true;\r\n        // Previous state for interpolation\r\n        this.prevPosition = this.position.clone();\r\n        this.prevQuaternion = this.quaternion.clone();\r\n    }\r\n    \r\n    /**\r\n     * Set the position\r\n     * @param {number} x X coordinate\r\n     * @param {number} y Y coordinate\r\n     * @param {number} z Z coordinate\r\n     * @returns {TransformComponent} This component for chaining\r\n     */\r\n    setPosition(x, y, z) {\r\n        this.position.set(x, y, z);\r\n        this.needsUpdate = true;\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Set the rotation in Euler angles\r\n     * @param {number} x X rotation in radians\r\n     * @param {number} y Y rotation in radians\r\n     * @param {number} z Z rotation in radians\r\n     * @returns {TransformComponent} This component for chaining\r\n     */\r\n    setRotation(x, y, z) {\r\n        this.rotation.set(x, y, z);\r\n        this.quaternion.setFromEuler(this.rotation);\r\n        this.needsUpdate = true;\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Set the rotation from a quaternion\r\n     * @param {THREE.Quaternion} quaternion The quaternion\r\n     * @returns {TransformComponent} This component for chaining\r\n     */\r\n    setQuaternion(quaternion) {\r\n        this.quaternion.copy(quaternion);\r\n        this.rotation.setFromQuaternion(this.quaternion);\r\n        this.needsUpdate = true;\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Set the scale\r\n     * @param {number} x X scale\r\n     * @param {number} y Y scale\r\n     * @param {number} z Z scale\r\n     * @returns {TransformComponent} This component for chaining\r\n     */\r\n    setScale(x, y, z) {\r\n        this.scale.set(x, y, z);\r\n        this.needsUpdate = true;\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Look at a point\r\n     * @param {THREE.Vector3} target The point to look at\r\n     * @returns {TransformComponent} This component for chaining\r\n     */\r\n    lookAt(target) {\r\n        // Create a temporary matrix to derive the rotation\r\n        const tempMatrix = new THREE.Matrix4();\r\n        tempMatrix.lookAt(this.position, target, new THREE.Vector3(0, 1, 0));\r\n        \r\n        // Extract the quaternion from the matrix\r\n        this.quaternion.setFromRotationMatrix(tempMatrix);\r\n        this.rotation.setFromQuaternion(this.quaternion);\r\n        \r\n        this.needsUpdate = true;\r\n        return this;\r\n    }\r\n    \r\n    /**\r\n     * Update the matrix from position, quaternion, and scale\r\n     * @returns {THREE.Matrix4} The updated matrix\r\n     */\r\n    updateMatrix() {\r\n        if (this.needsUpdate) {\r\n            this.matrix.compose(this.position, this.quaternion, this.scale);\r\n            this.needsUpdate = false;\r\n        }\r\n        return this.matrix;\r\n    }\r\n\r\n    /**\r\n     * Snapshot the current transform to previous for interpolation\r\n     */\r\n    snapshotPrevious() {\r\n        this.prevPosition.copy(this.position);\r\n        this.prevQuaternion.copy(this.quaternion);\r\n    }\r\n    \r\n    /**\r\n     * Get world position\r\n     * @returns {THREE.Vector3} A new vector representing the world position\r\n     */\r\n    getWorldPosition() {\r\n        return this.position.clone();\r\n    }\r\n    \r\n    /**\r\n     * Get forward direction vector\r\n     * @returns {THREE.Vector3} A normalized vector pointing forward\r\n     */\r\n    getForwardVector() {\r\n        const forward = new THREE.Vector3(0, 0, -1);\r\n        forward.applyQuaternion(this.quaternion);\r\n        return forward;\r\n    }\r\n    \r\n    /**\r\n     * Get right direction vector\r\n     * @returns {THREE.Vector3} A normalized vector pointing right\r\n     */\r\n    getRightVector() {\r\n        const right = new THREE.Vector3(1, 0, 0);\r\n        right.applyQuaternion(this.quaternion);\r\n        return right;\r\n    }\r\n    \r\n    /**\r\n     * Get up direction vector\r\n     * @returns {THREE.Vector3} A normalized vector pointing up\r\n     */\r\n    getUpVector() {\r\n        const up = new THREE.Vector3(0, 1, 0);\r\n        up.applyQuaternion(this.quaternion);\r\n        return up;\r\n    }\r\n}","/**\r\n * RigidbodyComponent - Physics properties for entities\r\n * \r\n * Handles velocity, forces, and other physics-related properties.\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { Component } from '../../core/component.js';\r\n\r\nexport class RigidbodyComponent extends Component {\r\n    constructor(mass = 1.0) {\r\n        super();\r\n        \r\n        // Basic physics properties\r\n        this.velocity = new THREE.Vector3();\r\n        this.angularVelocity = new THREE.Vector3();\r\n        this.mass = mass;\r\n        this.drag = 0.01;\r\n        this.angularDrag = 0.01;\r\n        \r\n        // Movement constraints\r\n        this.useGravity = false;\r\n        this.isKinematic = false;\r\n        this.freezeRotation = false;\r\n        \r\n        // Force properties\r\n        this.forces = new THREE.Vector3();\r\n        this.torque = new THREE.Vector3();\r\n        \r\n        // Collision properties\r\n        this.collisionRadius = 1.0;\r\n        this.isTrigger = false;\r\n    }\r\n    \r\n    /**\r\n     * Reset forces applied this frame\r\n     */\r\n    resetForces() {\r\n        this.forces.set(0, 0, 0);\r\n        this.torque.set(0, 0, 0);\r\n    }\r\n    \r\n    /**\r\n     * Apply a force to the rigidbody\r\n     * @param {THREE.Vector3} force Force vector to apply\r\n     * @param {THREE.Vector3} point Point where force is applied (for torque)\r\n     */\r\n    applyForce(force, point = null) {\r\n        if (this.isKinematic) return;\r\n        \r\n        // Add to force accumulator\r\n        this.forces.add(force);\r\n        \r\n        // Calculate torque if point is specified\r\n        if (point) {\r\n            const transformComponent = this.entity.getComponent('TransformComponent');\r\n            if (transformComponent) {\r\n                const relativePoint = point.clone().sub(transformComponent.position);\r\n                const torque = relativePoint.cross(force);\r\n                this.applyTorque(torque);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Apply an impulse (immediate velocity change)\r\n     * @param {THREE.Vector3} impulse Impulse vector\r\n     */\r\n    applyImpulse(impulse) {\r\n        if (this.isKinematic) return;\r\n        \r\n        // Calculate velocity change based on mass\r\n        const velocityChange = impulse.clone().divideScalar(this.mass);\r\n        this.velocity.add(velocityChange);\r\n    }\r\n    \r\n    /**\r\n     * Apply torque (rotational force)\r\n     * @param {THREE.Vector3} torque Torque vector\r\n     */\r\n    applyTorque(torque) {\r\n        if (this.isKinematic || this.freezeRotation) return;\r\n        \r\n        this.torque.add(torque);\r\n    }\r\n    \r\n    /**\r\n     * Set velocity directly\r\n     * @param {THREE.Vector3} velocity New velocity vector\r\n     */\r\n    setVelocity(velocity) {\r\n        this.velocity.copy(velocity);\r\n    }\r\n    \r\n    /**\r\n     * Set angular velocity directly\r\n     * @param {THREE.Vector3} angularVelocity New angular velocity vector\r\n     */\r\n    setAngularVelocity(angularVelocity) {\r\n        if (this.freezeRotation) return;\r\n        \r\n        this.angularVelocity.copy(angularVelocity);\r\n    }\r\n}","/**\r\n * CombatSystem - Manages combat interactions between entities\r\n * \r\n * Handles projectile collisions, damage application, and combat effects\r\n */\r\n\r\nimport { System } from '../../core/system.js';\r\nimport { HealthComponent } from '../../components/combat/healthComponent.js';\r\nimport { TransformComponent } from '../../components/transform.js';\r\nimport { RigidbodyComponent } from '../../components/physics/rigidbody.js';\r\nimport { FixedArray } from '../../utils/memoryManager.js';\r\nimport * as THREE from 'three';\r\n\r\nexport class CombatSystem extends System {\r\n    constructor(world) {\r\n        super(world);\r\n        this.requiredComponents = ['TransformComponent', 'RigidbodyComponent'];\r\n        this.priority = 50; // Run after enemy AI and player input\r\n        \r\n        // Projectile tracking\r\n        this.projectiles = new Set();\r\n        \r\n        // Combat statistics\r\n        this.damageDealt = 0;\r\n        this.damageReceived = 0;\r\n        \r\n        // Pre-allocated arrays for entity filtering\r\n        this.cachedProjectiles = new FixedArray(100);\r\n        this.cachedEnemies = new FixedArray(50);\r\n        this.cachedPlayers = new FixedArray(5);\r\n        \r\n        // Reusable vectors for calculations\r\n        this.hitPosition = new THREE.Vector3();\r\n        this.effectPosition = new THREE.Vector3();\r\n        \r\n        // Setup event listeners\r\n        this.setupEventListeners();\r\n    }\r\n    \r\n    /**\r\n     * Set up event listeners for combat-related events\r\n     */\r\n    setupEventListeners() {\r\n        // Listen for projectile creation events\r\n        this.world.messageBus.subscribe('weapon.fired', this.handleProjectileCreated.bind(this));\r\n        this.world.messageBus.subscribe('turret.fire', this.handleProjectileCreated.bind(this));\r\n        this.world.messageBus.subscribe('missile.fired', this.handleProjectileCreated.bind(this));\r\n        \r\n        // Listen for entity damaged events to track stats\r\n        this.world.messageBus.subscribe('entity.damaged', this.handleEntityDamaged.bind(this));\r\n    }\r\n    \r\n    /**\r\n     * Update all entities relevant to combat\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Advance optimized projectile store if present\r\n        if (this.world && this.world.optimizedProjectiles && typeof this.world.optimizedProjectiles.update === 'function') {\r\n            this.world.optimizedProjectiles.update(deltaTime);\r\n        }\r\n        // Get all entities with transforms (potential targets)\r\n        // Use the correct method to get entities - entityManager.getEntities()\r\n        const entities = this.world.entityManager.getEntities();\r\n        \r\n        // Check for projectile collisions\r\n        this.checkProjectileCollisions(entities);\r\n        \r\n        // Remove any tracked projectiles that no longer exist\r\n        this.cleanupInvalidProjectiles();\r\n    }\r\n    \r\n    /**\r\n     * Remove projectiles that are no longer valid (missing components or destroyed)\r\n     */\r\n    cleanupInvalidProjectiles() {\r\n        // Get all current projectile entities\r\n        const validProjectileIds = new Set();\r\n        const projectiles = this.world.entityManager.getEntitiesByTag('projectile');\r\n        const enemyProjectiles = this.world.entityManager.getEntitiesByTag('enemyProjectile');\r\n        \r\n        // Add all valid projectile IDs to the set\r\n        [...projectiles, ...enemyProjectiles].forEach(p => {\r\n            if (p && p.id) { // Add null check for safety\r\n                validProjectileIds.add(p.id);\r\n            }\r\n        });\r\n        \r\n        // Remove any tracked projectiles that aren't in the valid set\r\n        for (const projectileId of this.projectiles) {\r\n            if (!validProjectileIds.has(projectileId)) {\r\n                console.log(`Removing invalid projectile ${projectileId} from tracking`);\r\n                this.projectiles.delete(projectileId);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check projectiles for collision with entities\r\n     * @param {Array} entities All entities in the world\r\n     */\r\n    checkProjectileCollisions(entities) {\r\n        const projectiles = this.world.entityManager.getEntitiesByTag('projectile');\r\n        const enemyProjectiles = this.world.entityManager.getEntitiesByTag('enemyProjectile');\r\n        \r\n        // Clear our cached arrays\r\n        this.cachedProjectiles.clear();\r\n        this.cachedEnemies.clear();\r\n        this.cachedPlayers.clear();\r\n        \r\n        // Filter entities only once and store in cached arrays\r\n        for (let i = 0; i < entities.length; i++) {\r\n            const entity = entities[i];\r\n            if (entity.hasTag('enemy') || entity.hasComponent('EnemyAIComponent')) {\r\n                this.cachedEnemies.push(entity);\r\n            } else if (entity.hasTag('player')) {\r\n                this.cachedPlayers.push(entity);\r\n            }\r\n        }\r\n        \r\n        // Combine projectiles into our cached array\r\n        for (let i = 0; i < projectiles.length; i++) {\r\n            this.cachedProjectiles.push(projectiles[i]);\r\n        }\r\n        \r\n        for (let i = 0; i < enemyProjectiles.length; i++) {\r\n            this.cachedProjectiles.push(enemyProjectiles[i]);\r\n        }\r\n        \r\n        // Log number of projectiles if any are found\r\n        if (this.cachedProjectiles.length > 0) {\r\n            console.log(`CombatSystem: Checking ${this.cachedProjectiles.length} projectiles for collisions`);\r\n        }\r\n        \r\n        // Check each projectile against potential targets\r\n        for (let i = 0; i < this.cachedProjectiles.length; i++) {\r\n            const projectile = this.cachedProjectiles.get(i);\r\n            \r\n            try {\r\n                // Track this projectile if not already tracked\r\n                if (!this.projectiles.has(projectile.id)) {\r\n                    this.projectiles.add(projectile.id);\r\n                }\r\n                \r\n                const projectileTransform = projectile.getComponent('TransformComponent');\r\n                const projectileRigidbody = projectile.getComponent('RigidbodyComponent');\r\n                \r\n                if (!projectileTransform || !projectileRigidbody) {\r\n                    console.log(`Projectile ${projectile.id} missing transform or rigidbody component`);\r\n                    continue;\r\n                }\r\n                \r\n                // Determine if this is a player projectile or enemy projectile\r\n                const isPlayerProjectile = projectile._isPlayerProjectile || \r\n                                          projectile.hasTag('projectile') || \r\n                                          projectile.hasTag('playerProjectile');\r\n                                          \r\n                const isEnemyProjectile = projectile._isEnemyProjectile || \r\n                                         projectile.hasTag('enemyProjectile');\r\n                \r\n                // Skip projectile if it has no velocity (inactive)\r\n                if (projectileRigidbody.velocity.lengthSq() < 0.1) continue;\r\n                \r\n                // Use our cached arrays for better performance\r\n                const targets = isPlayerProjectile ? this.cachedEnemies : \r\n                               (isEnemyProjectile ? this.cachedPlayers : entities);\r\n                \r\n                // Set up raycaster for mesh-based collision detection\r\n                const raycaster = new THREE.Raycaster();\r\n                \r\n                // Use current projectile position and velocity direction\r\n                const projectilePosition = projectileTransform.position.clone();\r\n                const projectileDirection = projectileRigidbody.velocity.clone().normalize();\r\n                \r\n                // Set origin point for ray slightly behind projectile to catch collisions even at high speeds\r\n                const rayOffset = projectileDirection.clone().multiplyScalar(-10);\r\n                const rayOrigin = projectilePosition.clone().add(rayOffset);\r\n                \r\n                // Configure raycaster with proper near and far clipping\r\n                raycaster.set(rayOrigin, projectileDirection);\r\n                raycaster.near = 0;\r\n                raycaster.far = 50; // Detect collisions up to 50 units ahead\r\n                \r\n                // Debug info\r\n                console.log(`Raycaster for projectile ${projectile.id} - Origin: (${rayOrigin.x.toFixed(1)}, ${rayOrigin.y.toFixed(1)}, ${rayOrigin.z.toFixed(1)}), Direction: (${projectileDirection.x.toFixed(2)}, ${projectileDirection.y.toFixed(2)}, ${projectileDirection.z.toFixed(2)})`);\r\n                \r\n                let targetHit = false;\r\n                \r\n                // Check for collisions with all potential targets\r\n                for (let j = 0; j < targets.length; j++) {\r\n                    const target = targets.get ? targets.get(j) : targets[j];\r\n                    \r\n                    // Skip if target is destroyed\r\n                    if (target.destroyed) continue;\r\n                    \r\n                    // Skip self-collision\r\n                    if (target.id === projectile.id) continue;\r\n                    \r\n                    // Get the mesh component for collision testing\r\n                    const meshComponent = target.getComponent('MeshComponent');\r\n                    \r\n                    // Skip if no mesh component or mesh\r\n                    if (!meshComponent || !meshComponent.mesh) {\r\n                        console.log(`Target ${target.id} has no mesh component or mesh`);\r\n                        continue;\r\n                    }\r\n                    \r\n                    // Debug the mesh properties\r\n                    console.log(`Testing collision with target ${target.id}, mesh visible: ${meshComponent.mesh.visible}, mesh children: ${meshComponent.mesh.children ? meshComponent.mesh.children.length : 0}`);\r\n                    \r\n                    // Ensure mesh is visible and has geometry\r\n                    if (!meshComponent.mesh.visible) {\r\n                        console.log(`Mesh for ${target.id} is not visible, skipping`);\r\n                        continue;\r\n                    }\r\n                    \r\n                    // Perform the intersection test with entire mesh hierarchy (true for recursive)\r\n                    const intersections = raycaster.intersectObject(meshComponent.mesh, true);\r\n                    \r\n                    if (intersections.length > 0) {\r\n                        // We have a mesh intersection!\r\n                        const intersection = intersections[0]; // closest intersection\r\n                        \r\n                        // Debug information\r\n                        console.log(`MESH HIT! Projectile ${projectile.id} hit ${target.id} at distance ${intersection.distance.toFixed(2)}`);\r\n                        console.log(`Hit point: (${intersection.point.x.toFixed(1)}, ${intersection.point.y.toFixed(1)}, ${intersection.point.z.toFixed(1)})`);\r\n                        \r\n                        if (intersection.object) {\r\n                            console.log(`Hit specific mesh: ${intersection.object.name || 'unnamed'}`);\r\n                        }\r\n                        \r\n                        // Use the hit point for effects\r\n                        this.hitPosition.copy(intersection.point);\r\n                        \r\n                        // Handle the collision\r\n                        this.handleProjectileCollision(projectile, target);\r\n                        \r\n                        // Destroy projectile after hit\r\n                        try {\r\n                            this.world.destroyEntity(projectile.id);\r\n                            this.projectiles.delete(projectile.id);\r\n                            targetHit = true;\r\n                        } catch (e) {\r\n                            console.error(\"Failed to destroy projectile after hit:\", e);\r\n                        }\r\n                        \r\n                        // Break out of target loop - projectile hits only one target\r\n                        break;\r\n                    } else {\r\n                        // Debug when no intersection is found\r\n                        const targetTransform = target.getComponent('TransformComponent');\r\n                        if (targetTransform) {\r\n                            const distance = projectilePosition.distanceTo(targetTransform.position);\r\n                            console.log(`No intersection with ${target.id} at distance ${distance.toFixed(1)}`);\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // If we hit a target, skip to the next projectile\r\n                if (targetHit) continue;\r\n                \r\n            } catch (error) {\r\n                console.error(`Error processing projectile ${projectile.id}:`, error);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle a projectile collision with a target\r\n     * @param {Entity} projectile Projectile entity\r\n     * @param {Entity} target Target entity\r\n     */\r\n    handleProjectileCollision(projectile, target) {\r\n        // Determine damage amount\r\n        let damage = 10; // Default damage\r\n        const source = projectile.userData?.source;\r\n        \r\n        // Get damage from userData if available\r\n        if (projectile.userData && projectile.userData.damage) {\r\n            damage = projectile.userData.damage;\r\n        } else if (projectile.sourceComponent) {\r\n            // Alternative: get damage from source component\r\n            damage = projectile.sourceComponent.damage;\r\n        }\r\n        \r\n        // Apply damage to target\r\n        const targetHealth = target.getComponent('HealthComponent');\r\n        if (targetHealth) {\r\n            const damageType = projectile.userData?.attackType || 'projectile';\r\n            const damageResult = targetHealth.applyDamage(damage, damageType, source);\r\n            \r\n            // Create hit effect\r\n            this.createHitEffect(projectile, target, damageResult);\r\n            \r\n            // Track statistics based on hit entity type\r\n            if (target.hasTag('player')) {\r\n                this.damageReceived += damageResult.damageApplied;\r\n            } else if (target.hasTag('enemy')) {\r\n                this.damageDealt += damageResult.damageApplied;\r\n            }\r\n            \r\n            // Get position using our reusable vector\r\n            const projectileTransform = projectile.getComponent('TransformComponent');\r\n            if (projectileTransform) {\r\n                this.hitPosition.copy(projectileTransform.position);\r\n            } else {\r\n                this.hitPosition.set(0, 0, 0);\r\n            }\r\n            \r\n            // Publish hit event\r\n            this.world.messageBus.publish('combat.hit', {\r\n                projectile: projectile,\r\n                target: target,\r\n                damage: damageResult.damageApplied,\r\n                shieldDamage: damageResult.shieldDamage,\r\n                healthDamage: damageResult.healthDamage,\r\n                destroyed: damageResult.destroyed,\r\n                position: this.hitPosition // Pass direct reference for better performance\r\n            });\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Create a visual effect for a projectile hit\r\n     * @param {Entity} projectile Projectile entity\r\n     * @param {Entity} target Target entity\r\n     * @param {object} damageResult Result of damage application\r\n     */\r\n    createHitEffect(projectile, target, damageResult) {\r\n        // Get projectile information\r\n        const projectileTransform = projectile.getComponent('TransformComponent');\r\n        if (!projectileTransform) return;\r\n        \r\n        // Determine hit effect based on damage type and result\r\n        let effectColor = 0xff5500; // Default orange hit\r\n        let effectSize = 1;\r\n        \r\n        // Shield hit has blue color\r\n        if (damageResult.shieldDamage > 0) {\r\n            effectColor = 0x3399ff; // Blue for shield hit\r\n            effectSize = 1.5;\r\n        }\r\n        \r\n        // Critical hit has red color and larger size\r\n        if (damageResult.healthDamage > 20) {\r\n            effectColor = 0xff0000; // Red for critical hit\r\n            effectSize = 2;\r\n        }\r\n        \r\n        // Use our cached effect position\r\n        this.effectPosition.copy(projectileTransform.position);\r\n        \r\n        // Create hit effect using object pool\r\n        // Check for hit effect pool availability\r\n        let hitEffect;\r\n        const objectPoolAvailable = window.objectPool && \r\n                                    window.objectPool.pools && \r\n                                    window.objectPool.pools['hitEffect'];\r\n                                    \r\n        if (objectPoolAvailable) {\r\n            // Get hit effect from pool\r\n            hitEffect = window.objectPool.get('hitEffect', effectColor, effectSize);\r\n        } else {\r\n            // Fallback to creating a new effect if pool unavailable\r\n            hitEffect = this.createNewHitEffect(effectColor, effectSize);\r\n        }\r\n        \r\n        if (hitEffect && hitEffect.mesh) {\r\n            // Position the effect\r\n            hitEffect.mesh.position.copy(this.effectPosition);\r\n            \r\n            // Add to scene if not already added\r\n            if (!hitEffect.mesh.parent) {\r\n                this.world.scene.add(hitEffect.mesh);\r\n            }\r\n            \r\n            // Start the animation\r\n            this.animateHitEffect(hitEffect, hitEffect.mesh, objectPoolAvailable);\r\n        }\r\n    }\r\n    \r\n    // Helper method to create a new hit effect - only used as fallback when object pool is unavailable\r\n    createNewHitEffect(effectColor, effectSize) {\r\n        // Use precomputed geometry if available\r\n        let geometry;\r\n        if (window.game && window.game.hitEffectGeometry) {\r\n            geometry = window.game.hitEffectGeometry;\r\n        } else if (!this.hitEffectGeometry) {\r\n            // Create and cache geometry if not available\r\n            this.hitEffectGeometry = new THREE.SphereGeometry(1, 8, 8);\r\n            geometry = this.hitEffectGeometry;\r\n        } else {\r\n            // Use cached geometry\r\n            geometry = this.hitEffectGeometry;\r\n        }\r\n        \r\n        // Create the hit effect mesh\r\n        const material = new THREE.MeshBasicMaterial({\r\n            color: effectColor,\r\n            transparent: true,\r\n            opacity: 0.8\r\n        });\r\n        \r\n        const mesh = new THREE.Mesh(geometry, material);\r\n        mesh.scale.set(effectSize, effectSize, effectSize);\r\n        \r\n        return { mesh, material };\r\n    }\r\n    \r\n    /**\r\n     * Animate a hit effect\r\n     * @param {object} hitEffect The hit effect object\r\n     * @param {THREE.Mesh} effectMesh The effect mesh\r\n     * @param {boolean} useObjectPool Whether to return the object to pool after animation\r\n     */\r\n    animateHitEffect(hitEffect, effectMesh, useObjectPool = true) {\r\n        let scale = 1.0;\r\n        let opacity = 0.8;\r\n        \r\n        const animate = () => {\r\n            // Increase scale\r\n            scale += 0.1;\r\n            opacity -= 0.05;\r\n            \r\n            // Update mesh\r\n            if (effectMesh && effectMesh.scale) {\r\n                effectMesh.scale.set(scale, scale, scale);\r\n                \r\n                if (hitEffect.material) {\r\n                    hitEffect.material.opacity = opacity;\r\n                }\r\n                \r\n                // Continue animation until opacity reaches 0\r\n                if (opacity > 0) {\r\n                    requestAnimationFrame(animate);\r\n                } else {\r\n                    // Clean up effect when animation is done\r\n                    if (effectMesh.parent) {\r\n                        effectMesh.parent.remove(effectMesh);\r\n                    }\r\n                    \r\n                    // Return to pool if using object pooling\r\n                    if (useObjectPool && window.objectPool && window.objectPool.pools['hitEffect']) {\r\n                        window.objectPool.release('hitEffect', hitEffect);\r\n                    } else if (!useObjectPool) {\r\n                        // Dispose of material if not using object pooling\r\n                        if (hitEffect.material) {\r\n                            hitEffect.material.dispose();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        };\r\n        \r\n        // Start animation\r\n        animate();\r\n    }\r\n    \r\n    /**\r\n     * Handle projectile creation event\r\n     * @param {object} message Event message\r\n     */\r\n    handleProjectileCreated(message) {\r\n        // Track the projectile if it has a valid entity\r\n        if (message.entity && message.entity.id) {\r\n            this.projectiles.add(message.entity.id);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle entity damaged event\r\n     * @param {object} message Event message\r\n     */\r\n    handleEntityDamaged(message) {\r\n        // Update damage statistics\r\n        if (message.target) {\r\n            if (message.target.hasTag('player')) {\r\n                this.damageReceived += message.damage || 0;\r\n            } else if (message.target.hasTag('enemy')) {\r\n                this.damageDealt += message.damage || 0;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clean up when system is disabled\r\n     */\r\n    onDisabled() {\r\n        // Remove all event listeners\r\n        this.world.messageBus.unsubscribe('weapon.fired', this.handleProjectileCreated);\r\n        this.world.messageBus.unsubscribe('turret.fire', this.handleProjectileCreated);\r\n        this.world.messageBus.unsubscribe('missile.fired', this.handleProjectileCreated);\r\n        this.world.messageBus.unsubscribe('entity.damaged', this.handleEntityDamaged);\r\n    }\r\n}","/**\r\n * EnemyAIComponent - Handles enemy behavior and AI\r\n * \r\n * Controls enemy behavior with simplified kamikaze attack pattern\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { Component } from '../../core/component.js';\r\n\r\nexport class EnemyAIComponent extends Component {\r\n    constructor(config = {}) {\r\n        super();\r\n        \r\n        // Store the type of enemy\r\n        this.faction = config.faction || 'spectrals';\r\n        this.type = config.type || 'drone';\r\n        \r\n        // Detection and engagement ranges\r\n        this.detectionRange = config.detectionRange || 2500;\r\n        \r\n        // Combat properties\r\n        this.damage = config.damage || 25;\r\n        \r\n        // Movement properties\r\n        this.speed = config.speed || 1000;\r\n        \r\n        // State tracking\r\n        this.playerFound = false;\r\n        \r\n        // Special movement parameters for spiraling pattern\r\n        this.spiralAmplitude = config.spiralAmplitude || 150; // Radius of spiral\r\n        this.spiralFrequency = config.spiralFrequency || 2.0; // How tight the spiral is\r\n        this.spiralPhase = Math.random() * Math.PI * 2; // Random starting phase\r\n        this.timeAlive = 0; // Track time for movement calculation\r\n        \r\n        // Direction vector caching\r\n        this.lastDirection = new THREE.Vector3(0, 0, 1);\r\n        \r\n        // New flag for drone-like movement\r\n        this.isDroneLike = config.isDroneLike || false;\r\n        \r\n        // Separation force response\r\n        this.separationInfluence = config.separationInfluence || 0.3; // How much separation affects movement (0-1)\r\n        this.separationForce = new THREE.Vector3(); // Store the last calculated separation force\r\n        \r\n        console.log(`Created ${this.faction} ${this.type} enemy AI with detection range ${this.detectionRange}`);\r\n    }\r\n    \r\n    /**\r\n     * Sets the separation force to influence movement behavior\r\n     * @param {THREE.Vector3} force The separation force vector\r\n     */\r\n    setSeparationForce(force) {\r\n        // Store the separation force for use in movement calculations\r\n        this.separationForce.copy(force);\r\n    }\r\n    \r\n    /**\r\n     * Update AI behavior - implements kamikaze attack pattern\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        if (!this.entity || !this.entity.world) return;\r\n        \r\n        // Track how long this enemy has been alive\r\n        this.timeAlive += deltaTime;\r\n        \r\n        // ===== ENHANCED PLAYER DETECTION =====\r\n        let player = null;\r\n        \r\n        // METHOD 1: Check direct reference in world\r\n        try {\r\n            if (this.entity.world.playerEntity) {\r\n                player = this.entity.world.playerEntity;\r\n                //console.log(\"Found player via direct world.playerEntity reference\");\r\n            }\r\n        } catch (error) {}\r\n        \r\n        // METHOD 2: Try global window reference\r\n        if (!player && window.game && window.game.combat && window.game.combat.playerEntity) {\r\n            player = window.game.combat.playerEntity;\r\n            //console.log(\"Found player via window.game.combat.playerEntity\");\r\n        }\r\n        \r\n        // METHOD 3: Use getEntitiesByTag\r\n        if (!player) {\r\n            try {\r\n                const playerEntities = this.entity.world.getEntitiesByTag('player');\r\n                if (playerEntities && playerEntities.length > 0) {\r\n                    player = playerEntities[0];\r\n                    //console.log(\"Found player via world.getEntitiesByTag\");\r\n                }\r\n            } catch (error) {}\r\n        }\r\n        \r\n        // METHOD 4: Check entitiesByTag map\r\n        if (!player && this.entity.world.entityManager && this.entity.world.entityManager.entitiesByTag) {\r\n            try {\r\n                const playerEntities = this.entity.world.entityManager.entitiesByTag.get('player');\r\n                if (playerEntities && (playerEntities.size > 0 || playerEntities.length > 0)) {\r\n                    player = Array.from(playerEntities)[0];\r\n                    //console.log(\"Found player via entityManager.entitiesByTag map\");\r\n                }\r\n            } catch (error) {}\r\n        }\r\n        \r\n        // METHOD 5: Bruteforce search all entities\r\n        if (!player && this.entity.world.entityManager && this.entity.world.entityManager.entities) {\r\n            try {\r\n                const allEntities = Array.from(this.entity.world.entityManager.entities.values());\r\n                for (const entity of allEntities) {\r\n                    if ((entity.hasTag && entity.hasTag('player')) || \r\n                        entity.name === 'player' || \r\n                        (entity.id && entity.id.includes('player'))) {\r\n                        player = entity;\r\n                        //console.log(\"Found player via brute force entity search\");\r\n                        break;\r\n                    }\r\n                }\r\n            } catch (error) {}\r\n        }\r\n        \r\n        // METHOD 6: Check for spaceship in scene\r\n        if (!player && window.game && window.game.spaceship && window.game.spaceship.mesh) {\r\n            // Create a temporary entity if needed\r\n            console.log(\"No player entity found, but found spaceship - will use position directly\");\r\n            \r\n            // Use the spaceship as the target without an actual entity\r\n            // We'll create a minimal object with the necessary properties\r\n            player = {\r\n                getComponent: (type) => {\r\n                    if (type === 'TransformComponent') {\r\n                        return {\r\n                            position: window.game.spaceship.mesh.position,\r\n                            rotation: window.game.spaceship.mesh.rotation,\r\n                            quaternion: window.game.spaceship.mesh.quaternion\r\n                        };\r\n                    }\r\n                    return null;\r\n                }\r\n            };\r\n        }\r\n        \r\n        // If still no player, we can't proceed\r\n        if (!player) {\r\n            // Only show error message occasionally to avoid console spam\r\n            if (Math.random() < 0.01) { // Show error roughly once per 100 frames\r\n                console.error(\"No player entity found by any method! Enemy cannot move.\");\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Get required components\r\n        const transform = this.entity.getComponent('TransformComponent');\r\n        if (!transform) {\r\n            return;\r\n        }\r\n        \r\n        // Get health component to check status\r\n        const health = this.entity.getComponent('HealthComponent');\r\n        if (health && health.isDestroyed) {\r\n            return;\r\n        }\r\n        \r\n        // Get player transform\r\n        let playerTransform = player.getComponent ? player.getComponent('TransformComponent') : null;\r\n        if (!playerTransform) {\r\n            // If using spaceship directly, playerTransform is already correctly set up\r\n            if (player.position) {\r\n                playerTransform = player;\r\n            } else {\r\n                console.warn(\"Player found but missing transform component!\");\r\n                return;\r\n            }\r\n        }\r\n        \r\n        // Log that we found the player (only once)\r\n        if (!this.playerFound) {\r\n            console.log(`ENEMY FOUND PLAYER TARGET! Player position: ${playerTransform.position.x.toFixed(1)}, ${playerTransform.position.y.toFixed(1)}, ${playerTransform.position.z.toFixed(1)}`);\r\n            this.playerFound = true;\r\n        }\r\n        \r\n        // Calculate distance to player for decision-making\r\n        const distanceToPlayer = transform.position.distanceTo(playerTransform.position);\r\n        \r\n        // Calculate base direction to player\r\n        const baseDirection = new THREE.Vector3().subVectors(\r\n            playerTransform.position,\r\n            transform.position\r\n        ).normalize();\r\n        \r\n        // Cache this direction for calculations\r\n        this.lastDirection.copy(baseDirection);\r\n        \r\n        // DIFFERENT MOVEMENT PATTERNS BASED ON FACTION/TYPE\r\n        \r\n        // Special movement for spectral drones - spiral pattern\r\n        if (this.faction === 'spectrals' && this.type === 'drone') {\r\n            // Check if we should use drone-like movement\r\n            if (this.isDroneLike) {\r\n                this.applyDroneLikeMovement(transform, playerTransform, baseDirection, distanceToPlayer, deltaTime);\r\n            } else {\r\n                this.applySpectralDroneMovement(transform, playerTransform, baseDirection, distanceToPlayer, deltaTime);\r\n            }\r\n        } else {\r\n            // Standard kamikaze movement for other enemies\r\n            transform.position.add(baseDirection.multiplyScalar(this.speed * deltaTime));\r\n            transform.lookAt(playerTransform.position);\r\n        }\r\n        \r\n        // Check for kamikaze attack condition (same for all enemies)\r\n        if (distanceToPlayer < 75) { // Collision distance\r\n            console.log(\"ENEMY KAMIKAZE ATTACK!\");\r\n            \r\n            // Get player health component\r\n            const playerHealth = player.getComponent('HealthComponent');\r\n            if (playerHealth) {\r\n                // Use the configured damage value instead of calculating from player's health\r\n                playerHealth.applyDamage(this.damage, 'collision', this.entity);\r\n                console.log(`Enemy collided with player! Applied ${this.damage} damage to player entity health component`);\r\n                \r\n                // CRITICAL FIX: Also update the spaceship object directly to ensure damage is reflected\r\n                if (window.game && window.game.spaceship) {\r\n                    const spaceship = window.game.spaceship;\r\n                    \r\n                    // Apply damage to shields first, then hull\r\n                    if (spaceship.shield > 0) {\r\n                        if (spaceship.shield >= this.damage) {\r\n                            spaceship.shield -= this.damage;\r\n                        } else {\r\n                            const remainingDamage = this.damage - spaceship.shield;\r\n                            spaceship.shield = 0;\r\n                            spaceship.hull -= remainingDamage;\r\n                        }\r\n                    } else {\r\n                        spaceship.hull -= this.damage;\r\n                    }\r\n                    \r\n                    console.log(`Applied ${this.damage} damage directly to spaceship: Hull=${spaceship.hull}, Shield=${spaceship.shield}`);\r\n                    \r\n                    // Check for game over condition\r\n                    if (spaceship.hull <= 0 && !spaceship.isDestroyed) {\r\n                        spaceship.hull = 0;\r\n                        spaceship.isDestroyed = true;\r\n                        \r\n                        // Force game over\r\n                        if (window.game && window.game.gameOver) {\r\n                            window.game.gameOver(\"Your ship was destroyed by a kamikaze attack!\");\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // Create explosion effect using the visual effects system\r\n                if (this.entity.world && this.entity.world.messageBus) {\r\n                    this.entity.world.messageBus.publish('vfx.explosion', {\r\n                        position: transform.position.clone(),\r\n                        scale: 1.5, // Larger explosion for impact\r\n                        duration: 2.0\r\n                    });\r\n                    \r\n                    // Also create damage flash for player\r\n                    this.entity.world.messageBus.publish('vfx.damageFlash', {\r\n                        intensity: 0.3\r\n                    });\r\n                }\r\n                \r\n                // Play explosion sound if available\r\n                if (window.game && window.game.audio) {\r\n                    window.game.audio.playSound('boink');\r\n                }\r\n                \r\n                // Properly destroy this enemy entity\r\n                // Don't manually set health.isDestroyed, just let the entity system handle it\r\n                if (this.entity && this.entity.world) {\r\n                    // IMPORTANT FIX: Store entity ID locally before destruction\r\n                    const entityId = this.entity.id;\r\n                    const entityWorld = this.entity.world;\r\n                    \r\n                    // Publish a destroy event before actually destroying\r\n                    entityWorld.messageBus.publish('entity.aboutToBeDestroyed', {\r\n                        entity: this.entity,\r\n                        reason: 'kamikaze'\r\n                    });\r\n                    \r\n                    // Actually destroy the entity via world\r\n                    entityWorld.destroyEntity(entityId);\r\n                    console.log(`Enemy entity ${entityId} self-destructed after kamikaze attack`);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Apply drone-like movement pattern - more realistic drone behavior\r\n     * @param {TransformComponent} transform This entity's transform\r\n     * @param {TransformComponent} playerTransform Player's transform\r\n     * @param {THREE.Vector3} baseDirection Base direction to player\r\n     * @param {number} distanceToPlayer Distance to player\r\n     * @param {number} deltaTime Delta time for frame\r\n     */\r\n    applyDroneLikeMovement(transform, playerTransform, baseDirection, distanceToPlayer, deltaTime) {\r\n        // Create an orthogonal basis for movement\r\n        const up = new THREE.Vector3(0, 1, 0);\r\n        const right = new THREE.Vector3().crossVectors(baseDirection, up).normalize();\r\n        \r\n        // In case the direction is parallel to up, we need a fallback\r\n        if (right.lengthSq() < 0.1) {\r\n            right.set(1, 0, 0); // Fallback right vector\r\n        }\r\n        \r\n        // Now get a proper up vector that's perpendicular to both\r\n        const properUp = new THREE.Vector3().crossVectors(right, baseDirection).normalize();\r\n        \r\n        // Calculate movement based on distance to player\r\n        let moveSpeed = this.speed;\r\n        let finalDirection = new THREE.Vector3();\r\n        \r\n        // Different behavior based on distance from player\r\n        if (distanceToPlayer > 1000) {\r\n            // Far away - approach rapidly with slight variations\r\n            moveSpeed = this.speed * 1.2; // Move faster when far away\r\n            \r\n            // Add slight zigzag for interesting approach\r\n            const zigzag = Math.sin(this.timeAlive * 1.5) * 30;\r\n            finalDirection.copy(baseDirection)\r\n                .multiplyScalar(moveSpeed)\r\n                .add(right.clone().multiplyScalar(zigzag));\r\n                \r\n        } else if (distanceToPlayer > 400) {\r\n            // Medium distance - circle and approach\r\n            const approachWeight = 0.6; // 60% approach, 40% circling\r\n            const circleSpeed = this.speed * (1 - approachWeight);\r\n            \r\n            // Determine circling direction (clockwise or counterclockwise)\r\n            // Use entity ID to make it consistent for this drone\r\n            const entityIdSum = this.entity.id.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);\r\n            const circleDir = (entityIdSum % 2 === 0) ? 1 : -1;\r\n            \r\n            // Calculate strafing component (perpendicular to player direction)\r\n            const strafeDir = right.clone().multiplyScalar(circleDir * circleSpeed);\r\n            \r\n            // Calculate approach component\r\n            const approachDir = baseDirection.clone().multiplyScalar(this.speed * approachWeight);\r\n            \r\n            // Combine for final movement\r\n            finalDirection.copy(approachDir).add(strafeDir);\r\n            \r\n            // Add slight up/down bobbing\r\n            const bobAmount = Math.sin(this.timeAlive * 2.0) * 15;\r\n            finalDirection.add(properUp.clone().multiplyScalar(bobAmount));\r\n            \r\n        } else {\r\n            // Close range - erratic evasive movements with approach\r\n            \r\n            // Generate pseudo-random evasive pattern\r\n            const evasiveTime = this.timeAlive * 3.0; // Faster pattern changes\r\n            \r\n            // Horizontal evasion\r\n            const horizontalEvasion = Math.sin(evasiveTime) * Math.cos(evasiveTime * 1.3) * 80;\r\n            \r\n            // Vertical evasion\r\n            const verticalEvasion = Math.cos(evasiveTime * 0.7) * Math.sin(evasiveTime * 1.1) * 60;\r\n            \r\n            // Forward thrust varies with a pulsing pattern (0.5 to 1.0 of base speed)\r\n            const thrustPulse = 0.5 + (0.5 * (0.5 + 0.5 * Math.sin(evasiveTime * 0.5)));\r\n            \r\n            // Combine all movements\r\n            finalDirection.copy(baseDirection)\r\n                .multiplyScalar(this.speed * thrustPulse)\r\n                .add(right.clone().multiplyScalar(horizontalEvasion))\r\n                .add(properUp.clone().multiplyScalar(verticalEvasion));\r\n        }\r\n        \r\n        // Apply separation force influence to final direction\r\n        if (this.separationForce && this.separationForce.lengthSq() > 0) {\r\n            // Scale the separation force by influence factor\r\n            const separationDirection = this.separationForce.clone().normalize();\r\n            const separationStrength = this.separationForce.length();\r\n            \r\n            // Add scaled separation force to final direction\r\n            // Use higher influence when separation force is stronger\r\n            const dynamicInfluence = this.separationInfluence * \r\n                (0.5 + 0.5 * Math.min(1.0, separationStrength / 100));\r\n                \r\n            finalDirection.lerp(\r\n                separationDirection.multiplyScalar(this.speed), \r\n                dynamicInfluence\r\n            );\r\n        }\r\n        \r\n        // Apply the final movement\r\n        transform.position.add(finalDirection.multiplyScalar(deltaTime));\r\n        \r\n        // Create a look target that leads slightly in the direction of movement\r\n        // This creates a more natural flight pattern where the drone looks ahead of its movement\r\n        const lookAheadTime = 0.1; // Look 0.1 seconds ahead\r\n        const lookTarget = new THREE.Vector3()\r\n            .copy(transform.position)\r\n            .add(finalDirection.clone().normalize().multiplyScalar(100)); // Look 100 units ahead\r\n            \r\n        // Look at the calculated target point\r\n        transform.lookAt(lookTarget);\r\n        \r\n        // Add realistic banking effect based on lateral movement\r\n        // Extract the lateral (right) component of our movement\r\n        const lateralMovement = new THREE.Vector3();\r\n        lateralMovement.copy(finalDirection).projectOnVector(right);\r\n        \r\n        // Calculate bank angle based on lateral movement (max ±25 degrees)\r\n        const lateralSpeed = lateralMovement.length() * (lateralMovement.dot(right) > 0 ? -1 : 1);\r\n        const bankAngle = (lateralSpeed / this.speed) * 0.4; // Max ~25 degrees\r\n        \r\n        // Apply banking rotation around the forward axis\r\n        const forward = transform.getForwardVector();\r\n        const bankQuaternion = new THREE.Quaternion().setFromAxisAngle(forward, bankAngle);\r\n        transform.quaternion.multiply(bankQuaternion);\r\n        \r\n        // Update Euler angles to match quaternion\r\n        transform.rotation.setFromQuaternion(transform.quaternion);\r\n    }\r\n    \r\n    /**\r\n     * Apply spectral drone movement pattern - spiral toward player\r\n     * @param {TransformComponent} transform This entity's transform\r\n     * @param {TransformComponent} playerTransform Player's transform\r\n     * @param {THREE.Vector3} baseDirection Base direction to player\r\n     * @param {number} distanceToPlayer Distance to player\r\n     * @param {number} deltaTime Delta time for frame\r\n     */\r\n    applySpectralDroneMovement(transform, playerTransform, baseDirection, distanceToPlayer, deltaTime) {\r\n        // Create an orthogonal basis for spiral movement\r\n        // We need a right vector that's perpendicular to the direction to the player\r\n        const up = new THREE.Vector3(0, 1, 0);\r\n        const right = new THREE.Vector3().crossVectors(baseDirection, up).normalize();\r\n        \r\n        // In case the direction is parallel to up, we need a fallback\r\n        if (right.lengthSq() < 0.1) {\r\n            right.set(1, 0, 0); // Fallback right vector\r\n        }\r\n        \r\n        // Now get a proper up vector that's perpendicular to both\r\n        const properUp = new THREE.Vector3().crossVectors(right, baseDirection).normalize();\r\n        \r\n        // Calculate spiral movement\r\n        // We use sine and cosine to create a circular pattern around the direct path\r\n        const time = this.timeAlive * this.spiralFrequency;\r\n        \r\n        // Adjust spiral amplitude based on distance to player (tighter spirals when closer)\r\n        let amplitude = this.spiralAmplitude;\r\n        if (distanceToPlayer < 500) {\r\n            // Gradually reduce spiral size as we get closer to the player\r\n            amplitude = this.spiralAmplitude * (distanceToPlayer / 500);\r\n        }\r\n        \r\n        // Calculate offsets using sine and cosine for a circular pattern\r\n        const offsetX = Math.sin(time) * amplitude;\r\n        const offsetY = Math.cos(time) * amplitude;\r\n        \r\n        // Apply the offsets to the base direction\r\n        const finalDirection = new THREE.Vector3()\r\n            .copy(baseDirection)\r\n            .multiplyScalar(this.speed) // Base forward speed\r\n            .add(right.multiplyScalar(offsetX)) // Add right/left offset\r\n            .add(properUp.multiplyScalar(offsetY)); // Add up/down offset\r\n        \r\n        // Apply separation force influence to final direction\r\n        if (this.separationForce && this.separationForce.lengthSq() > 0) {\r\n            // Scale the separation force by influence factor\r\n            const separationDirection = this.separationForce.clone().normalize();\r\n            const separationStrength = this.separationForce.length();\r\n            \r\n            // Calculate dynamic influence - more influence when separation force is stronger\r\n            const dynamicInfluence = this.separationInfluence * \r\n                (0.5 + 0.5 * Math.min(1.0, separationStrength / 100));\r\n            \r\n            // Blend the final direction with the separation direction\r\n            finalDirection.lerp(\r\n                separationDirection.multiplyScalar(this.speed),\r\n                dynamicInfluence\r\n            );\r\n        }\r\n        \r\n        // Apply the final movement\r\n        transform.position.add(finalDirection.multiplyScalar(deltaTime));\r\n        \r\n        // Create a look target that's ahead of us in the spiral path\r\n        // This makes the drone look in the direction it's moving, not just at the player\r\n        const lookAheadTime = 0.2; // Look 0.2 seconds ahead\r\n        const nextSpiral = time + (this.spiralFrequency * lookAheadTime);\r\n        \r\n        const lookAheadOffsetX = Math.sin(nextSpiral) * amplitude;\r\n        const lookAheadOffsetY = Math.cos(nextSpiral) * amplitude;\r\n        \r\n        // Calculate look target position\r\n        const lookTarget = new THREE.Vector3()\r\n            .copy(transform.position)\r\n            .add(baseDirection.multiplyScalar(100)) // Look ahead along base path\r\n            .add(right.multiplyScalar(lookAheadOffsetX)) // Add spiral offset X\r\n            .add(properUp.multiplyScalar(lookAheadOffsetY)); // Add spiral offset Y\r\n        \r\n        // Look at the calculated target point\r\n        transform.lookAt(lookTarget);\r\n        \r\n        // Optional: Add a slight tilt to the drone to make it look like it's banking in the turns\r\n        const tiltAngle = Math.atan2(offsetX, this.speed) * 0.5; // Scale down the bank angle\r\n        \r\n        // Apply tilt by modifying the quaternion directly\r\n        // We need to apply a rotation around the local forward axis\r\n        // Since we've already looked at the target, we're working in local space\r\n        \r\n        // Get the forward vector (from the lookAt we just did)\r\n        const forward = transform.getForwardVector();\r\n        \r\n        // Create quaternion for the tilt rotation around the forward vector (local Z)\r\n        const tiltQuaternion = new THREE.Quaternion().setFromAxisAngle(forward, tiltAngle);\r\n        \r\n        // Apply the tilt rotation to the current rotation\r\n        transform.quaternion.multiply(tiltQuaternion);\r\n        \r\n        // Update the Euler angles to match the quaternion\r\n        transform.rotation.setFromQuaternion(transform.quaternion);\r\n    }\r\n}","/**\r\n * MeshComponent - Visual representation of an entity\r\n * \r\n * Handles the Three.js mesh and its properties.\r\n */\r\n\r\nimport { Component } from '../../core/component.js';\r\nimport * as THREE from 'three';\r\n\r\nexport class MeshComponent extends Component {\r\n    constructor(geometry, material) {\r\n        super();\r\n        \r\n        // Handle case where geometry is already a mesh or group\r\n        if (geometry && geometry.isMesh || geometry && geometry.isGroup) {\r\n            this.mesh = geometry;\r\n        } else if (geometry && material) {\r\n            this.mesh = new THREE.Mesh(geometry, material);\r\n            \r\n            // Ensure geometry has computed boundingSphere\r\n            if (geometry && typeof geometry.computeBoundingSphere === 'function' && !geometry.boundingSphere) {\r\n                geometry.computeBoundingSphere();\r\n            }\r\n        } else {\r\n            // Fallback to simple cube if no valid geometry, but make it invisible\r\n            console.warn('MeshComponent created with invalid geometry, using invisible default cube');\r\n            const defaultGeom = new THREE.BoxGeometry(10, 10, 10);\r\n            defaultGeom.computeBoundingSphere();\r\n            const defaultMat = new THREE.MeshBasicMaterial({ \r\n                color: 0xff0000, \r\n                transparent: true, \r\n                opacity: 0.0,\r\n                visible: false \r\n            });\r\n            this.mesh = new THREE.Mesh(defaultGeom, defaultMat);\r\n            this.mesh.visible = false; // Ensure the mesh is invisible\r\n        }\r\n        \r\n        this.visible = true;\r\n        this.castShadow = false;\r\n        this.receiveShadow = false;\r\n    }\r\n    \r\n    /**\r\n     * Called when component is attached to an entity\r\n     */\r\n    onAttached() {\r\n        // Link mesh to transform if available\r\n        const transform = this.entity.getComponent('TransformComponent');\r\n        if (transform) {\r\n            // Initial setup of mesh position, rotation, and scale\r\n            this.mesh.position.copy(transform.position);\r\n            this.mesh.quaternion.copy(transform.quaternion);\r\n            this.mesh.scale.copy(transform.scale);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Called when component is detached from an entity\r\n     */\r\n    onDetached() {\r\n        // Remove from scene if present\r\n        if (this.mesh.parent) {\r\n            this.mesh.parent.remove(this.mesh);\r\n        }\r\n        \r\n        // Dispose of geometry and material to prevent memory leaks\r\n        if (this.mesh.geometry) {\r\n            this.mesh.geometry.dispose();\r\n        }\r\n        \r\n        if (this.mesh.material) {\r\n            // Check if material is an array\r\n            if (Array.isArray(this.mesh.material)) {\r\n                this.mesh.material.forEach(material => {\r\n                    if (material.map) material.map.dispose();\r\n                    if (material.lightMap) material.lightMap.dispose();\r\n                    if (material.bumpMap) material.bumpMap.dispose();\r\n                    if (material.normalMap) material.normalMap.dispose();\r\n                    if (material.specularMap) material.specularMap.dispose();\r\n                    if (material.envMap) material.envMap.dispose();\r\n                    material.dispose();\r\n                });\r\n            } else {\r\n                // Single material case\r\n                if (this.mesh.material.map) this.mesh.material.map.dispose();\r\n                if (this.mesh.material.lightMap) this.mesh.material.lightMap.dispose();\r\n                if (this.mesh.material.bumpMap) this.mesh.material.bumpMap.dispose();\r\n                if (this.mesh.material.normalMap) this.mesh.material.normalMap.dispose();\r\n                if (this.mesh.material.specularMap) this.mesh.material.specularMap.dispose();\r\n                if (this.mesh.material.envMap) this.mesh.material.envMap.dispose();\r\n                this.mesh.material.dispose();\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Set mesh visibility\r\n     * @param {boolean} visible Whether the mesh is visible\r\n     */\r\n    setVisible(visible) {\r\n        this.visible = visible;\r\n        this.mesh.visible = visible;\r\n    }\r\n    \r\n    /**\r\n     * Set whether the mesh casts shadows\r\n     * @param {boolean} castShadow Whether the mesh casts shadows\r\n     */\r\n    setCastShadow(castShadow) {\r\n        this.castShadow = castShadow;\r\n        this.mesh.castShadow = castShadow;\r\n    }\r\n    \r\n    /**\r\n     * Set whether the mesh receives shadows\r\n     * @param {boolean} receiveShadow Whether the mesh receives shadows\r\n     */\r\n    setReceiveShadow(receiveShadow) {\r\n        this.receiveShadow = receiveShadow;\r\n        this.mesh.receiveShadow = receiveShadow;\r\n    }\r\n    \r\n    /**\r\n     * Change the mesh's material\r\n     * @param {THREE.Material} material New material\r\n     */\r\n    setMaterial(material) {\r\n        this.mesh.material = material;\r\n    }\r\n    \r\n    /**\r\n     * Change the mesh's geometry\r\n     * @param {THREE.BufferGeometry} geometry New geometry\r\n     */\r\n    setGeometry(geometry) {\r\n        this.mesh.geometry = geometry;\r\n    }\r\n    \r\n    /**\r\n     * Add the mesh to a scene\r\n     * @param {THREE.Scene} scene Scene to add the mesh to\r\n     */\r\n    addToScene(scene) {\r\n        scene.add(this.mesh);\r\n    }\r\n    \r\n    /**\r\n     * Update mesh transform from entity transform\r\n     */\r\n    updateFromTransform() {\r\n        const transform = this.entity.getComponent('TransformComponent');\r\n        if (transform) {\r\n            this.mesh.position.copy(transform.position);\r\n            this.mesh.quaternion.copy(transform.quaternion);\r\n            this.mesh.scale.copy(transform.scale);\r\n        }\r\n    }\r\n}","/**\r\n * Enemy Pool Manager - Handles the object pooling system for enemy entities\r\n */\r\n\r\nimport { TransformComponent } from '../../components/transform.js';\r\nimport { EnemyAIComponent } from '../../components/combat/enemyAI.js';\r\nimport { HealthComponent } from '../../components/combat/healthComponent.js';\r\nimport { MeshComponent } from '../../components/rendering/mesh.js';\r\nimport { RigidbodyComponent } from '../../components/physics/rigidbody.js';\r\n\r\nexport class EnemyPoolManager {\r\n    constructor(world, maxPoolSize = 20) {\r\n        this.world = world;\r\n        this.maxPoolSize = maxPoolSize;\r\n        this.enemyPool = [];\r\n        \r\n        // Pre-allocate the pool\r\n        this.preallocateEnemyPool();\r\n    }\r\n    \r\n    /**\r\n     * Pre-allocate enemy pool to avoid runtime allocations\r\n     */\r\n    preallocateEnemyPool() {\r\n        // Pre-allocate spectral drones\r\n        for (let i = 0; i < 10; i++) {\r\n            const spectralEntity = this.createEnemyEntity();\r\n            // IMPORTANT: Don't add pooled entities to tracking\r\n            // The entity will be tracked only when spawned\r\n            this.enemyPool.push(spectralEntity);\r\n        }\r\n        \r\n        console.log(`Pre-allocated enemy pool with ${this.enemyPool.length} spectral drones`);\r\n    }\r\n    \r\n    /**\r\n     * Create a basic enemy entity (for pooling)\r\n     * @returns {Entity} The created enemy entity\r\n     */\r\n    createEnemyEntity() {\r\n        const entity = this.world.createEntity('enemy_spectral');\r\n        // Add tags but ensure they aren't tracked until spawned\r\n        entity.addTag('pooled'); // Add 'pooled' tag to mark as inactive\r\n        \r\n        // Add basic components\r\n        entity.addComponent(new TransformComponent());\r\n        entity.addComponent(new MeshComponent());\r\n        \r\n        return entity;\r\n    }\r\n    \r\n    /**\r\n     * Get an enemy from the pool or create a new one if the pool is empty\r\n     * @returns {Entity} An enemy entity\r\n     */\r\n    getEnemyFromPool() {\r\n        // Get from pool if available\r\n        if (this.enemyPool.length > 0) {\r\n            // Get entity from pool\r\n            const entity = this.enemyPool.pop();\r\n            \r\n            // Double-check this entity isn't already in the active enemies list\r\n            // (This should never happen, but let's be defensive)\r\n            if (this.enemies && this.enemies.has(entity.id)) {\r\n                console.warn(`CRITICAL ERROR: Entity ${entity.id} is in both the pool and active enemies!`);\r\n                \r\n                // Remove from active enemies to avoid duplicates\r\n                this.enemies.delete(entity.id);\r\n                console.log(`Fixed inconsistency: Removed entity ${entity.id} from active enemies`);\r\n            }\r\n            \r\n            // Verify all pooled entities in enemyPool don't include this entity\r\n            // This ensures no duplicate references exist in the pool\r\n            for (let i = 0; i < this.enemyPool.length; i++) {\r\n                if (this.enemyPool[i].id === entity.id) {\r\n                    console.warn(`CRITICAL ERROR: Duplicate of entity ${entity.id} found in enemy pool!`);\r\n                    this.enemyPool.splice(i, 1);\r\n                    console.log(`Fixed inconsistency: Removed duplicate entity ${entity.id} from enemy pool`);\r\n                    i--; // Adjust index since we removed an element\r\n                }\r\n            }\r\n            \r\n            console.log(`Getting entity ${entity.id} from pool. Current tags: [${entity.tags ? [...entity.tags] : 'undefined'}]`);\r\n            \r\n            // CRITICAL FIX: Use the proper clearTags method first to completely reset tag state\r\n            if (entity.clearTags && typeof entity.clearTags === 'function') {\r\n                entity.clearTags();\r\n                console.log(`Cleared all tags from entity ${entity.id}`);\r\n            } else {\r\n                console.warn(`Entity ${entity.id} missing clearTags method`);\r\n                // Remove the pooled tag manually at minimum\r\n                if (entity.hasTag && entity.removeTag) {\r\n                    if (entity.hasTag('pooled')) {\r\n                        entity.removeTag('pooled');\r\n                    }\r\n                    // Clear any other possible tags\r\n                    if (entity.hasTag('enemy')) entity.removeTag('enemy');\r\n                    if (entity.hasTag('spectrals')) entity.removeTag('spectrals');\r\n                }\r\n            }\r\n            \r\n            // Explicitly reset the tag cache flags\r\n            if (entity._syncTagCache && typeof entity._syncTagCache === 'function') {\r\n                entity._syncTagCache();\r\n                console.log(`Reset tag cache for entity ${entity.id}`);\r\n            } else {\r\n                // Direct reset of cache variables\r\n                if (entity._isEnemy !== undefined) entity._isEnemy = false;\r\n                if (entity._isPooled !== undefined) entity._isPooled = false;\r\n            }\r\n            \r\n            // Reset any component states that might be problematic\r\n            const enemyAI = entity.getComponent('EnemyAIComponent');\r\n            if (enemyAI) {\r\n                // Reset internal state\r\n                enemyAI.playerFound = false;\r\n                enemyAI.timeAlive = 0;\r\n                enemyAI.spiralPhase = Math.random() * Math.PI * 2; // New random starting phase\r\n                enemyAI.enabled = true; // Ensure it's enabled\r\n            }\r\n            \r\n            // Verify the entity is clean\r\n            console.log(`Entity ${entity.id} prepared for reuse. Current tags: [${entity.tags ? [...entity.tags] : 'undefined'}]`);\r\n            \r\n            return entity;\r\n        }\r\n        \r\n        // Otherwise create a new one\r\n        const newEntity = this.createEnemyEntity();\r\n        console.log(`Created new entity ${newEntity.id} because pool was empty`);\r\n        return newEntity;\r\n    }\r\n    \r\n    /**\r\n     * Return an enemy to the pool\r\n     * @param {Entity} entity Enemy entity\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    returnEnemyToPool(entity, enemies) {\r\n        // Safeguard against null/undefined entities\r\n        if (!entity) {\r\n            console.warn(\"Attempt to return null/undefined entity to pool\");\r\n            return;\r\n        }\r\n        \r\n        // Get entity ID for consistent logging\r\n        const entityId = entity.id;\r\n        \r\n        // Log entity state for debugging\r\n        console.log(`Returning entity ${entityId} to pool. Has tags: [${entity.tags ? [...entity.tags] : 'undefined'}]`);\r\n        \r\n        // ENHANCED CLEANUP: Multiple checks to ensure entity is removed from enemies tracking\r\n        // 1. Direct check and remove from tracking Set\r\n        if (enemies && enemies.has(entityId)) {\r\n            enemies.delete(entityId);\r\n            console.log(`Removed entity ${entityId} from enemies tracking`);\r\n        }\r\n        \r\n        // 2. FIRST: Clear ALL tags using the improved clearTags method\r\n        // This will properly update both the tags Set and the cached flags\r\n        if (entity.clearTags && typeof entity.clearTags === 'function') {\r\n            entity.clearTags();\r\n            console.log(`Cleared all tags from entity ${entityId}`);\r\n        } else {\r\n            // Fallback if clearTags is not available\r\n            console.warn(`No clearTags method on entity ${entityId}, using manual tag removal`);\r\n            \r\n            // Manually remove known tags\r\n            if (entity.hasTag && entity.removeTag) {\r\n                if (entity.hasTag('enemy')) entity.removeTag('enemy');\r\n                if (entity.hasTag('spectrals')) entity.removeTag('spectrals');\r\n                if (entity.hasTag('drone')) entity.removeTag('drone');\r\n                if (entity.hasTag('frozen')) entity.removeTag('frozen');\r\n            }\r\n        }\r\n        \r\n        // Only return to pool if it's not full\r\n        if (this.enemyPool.length < this.maxPoolSize) {\r\n            // TRAIL CLEANUP: Remove trail component and its visual elements first\r\n            // This is critical to prevent the trail from persisting after enemy destruction\r\n            const trailComponent = entity.getComponent('TrailComponent');\r\n            if (trailComponent) {\r\n                try {\r\n                    // Call the onDetached method if it exists to clean up resources\r\n                    if (typeof trailComponent.onDetached === 'function') {\r\n                        trailComponent.onDetached();\r\n                    }\r\n                    \r\n                    // Remove from trail system tracking if it exists\r\n                    if (window.game && window.game.trailSystem) {\r\n                        window.game.trailSystem.unregisterTrail && \r\n                        window.game.trailSystem.unregisterTrail(entityId);\r\n                    }\r\n                    \r\n                    // If the trail has a mesh or points object, remove it from scene\r\n                    if (trailComponent.trailMesh && trailComponent.trailMesh.parent) {\r\n                        trailComponent.trailMesh.parent.remove(trailComponent.trailMesh);\r\n                    }\r\n                    \r\n                    // Dispose of geometry and material\r\n                    if (trailComponent.trailMesh) {\r\n                        if (trailComponent.trailMesh.geometry) {\r\n                            trailComponent.trailMesh.geometry.dispose();\r\n                        }\r\n                        if (trailComponent.trailMesh.material) {\r\n                            trailComponent.trailMesh.material.dispose();\r\n                        }\r\n                    }\r\n                    \r\n                    // Remove the component from the entity\r\n                    entity.removeComponent('TrailComponent');\r\n                    console.log(`Removed and cleaned up TrailComponent from entity ${entityId}`);\r\n                } catch (error) {\r\n                    console.error(`Error cleaning up trail for entity ${entityId}:`, error);\r\n                }\r\n            }\r\n            \r\n            // Reset the entity's transform\r\n            const transform = entity.getComponent('TransformComponent');\r\n            if (transform) {\r\n                transform.position.set(0, 0, 0);\r\n                transform.rotation.set(0, 0, 0);\r\n                transform.scale.set(1, 1, 1);\r\n            }\r\n            \r\n            // Reset health if present\r\n            const health = entity.getComponent('HealthComponent');\r\n            if (health) {\r\n                health.health = 0;\r\n                health.isDestroyed = true;\r\n            }\r\n            \r\n            // Disable AI component if present\r\n            const enemyAI = entity.getComponent('EnemyAIComponent');\r\n            if (enemyAI) {\r\n                enemyAI.enabled = false;\r\n                // Reset internal state variables to prevent stale behavior\r\n                enemyAI.playerFound = false;\r\n                enemyAI.timeAlive = 0;\r\n                enemyAI.spiralPhase = Math.random() * Math.PI * 2; // New random starting phase\r\n            }\r\n            \r\n            // Clean up and hide mesh\r\n            const meshComponent = entity.getComponent('MeshComponent');\r\n            if (meshComponent && meshComponent.mesh) {\r\n                try {\r\n                    // Remove from scene if it has a parent\r\n                    if (meshComponent.mesh.parent) {\r\n                        meshComponent.mesh.parent.remove(meshComponent.mesh);\r\n                    }\r\n                    \r\n                    // Make the mesh invisible\r\n                    meshComponent.mesh.visible = false;\r\n                } catch (error) {\r\n                    console.error(`Error cleaning up mesh for entity ${entityId}:`, error);\r\n                }\r\n            }\r\n            \r\n            // Disable rigidbody physics\r\n            const rigidbody = entity.getComponent('RigidbodyComponent');\r\n            if (rigidbody) {\r\n                rigidbody.isFrozen = true;\r\n                if (rigidbody.velocity) {\r\n                    rigidbody.velocity.set(0, 0, 0);\r\n                }\r\n            }\r\n\r\n            // Now, add the pooled tag after all cleanup is done\r\n            entity.addTag('pooled');\r\n            console.log(`Entity ${entityId} marked as pooled`);\r\n            \r\n            // Verify entity state after pooling\r\n            console.log(`Final entity ${entityId} state - Tags: [${entity.tags ? [...entity.tags] : 'none'}]`);\r\n            \r\n            // Add to pool\r\n            this.enemyPool.push(entity);\r\n            \r\n            console.log(`Entity ${entityId} returned to pool. Pool size now ${this.enemyPool.length}`);\r\n        } else {\r\n            // If pool is full, destroy the entity\r\n            console.log(`Pool is full (${this.maxPoolSize}), destroying entity ${entityId} instead of pooling`);\r\n            \r\n            // CRITICAL FIX: Ensure entity is completely destroyed\r\n            if (this.world && this.world.destroyEntity) {\r\n                this.world.destroyEntity(entityId);\r\n                console.log(`Entity ${entityId} fully destroyed`);\r\n            } else {\r\n                console.error(`Failed to destroy entity ${entityId} - world or destroyEntity method not available`);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Run diagnostics on the enemy pool system to detect and fix inconsistencies\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    runPoolDiagnostics(enemies) {\r\n        console.log(\"=== RUNNING ENEMY POOL DIAGNOSTICS ===\");\r\n        console.log(`Active enemies: ${enemies.size}, Pool size: ${this.enemyPool.length}`);\r\n        \r\n        // Track number of fixes made\r\n        let inconsistenciesFixed = 0;\r\n        \r\n        // POOL INTEGRITY CHECK: Check for duplicate entities in the pool\r\n        const poolEntityIds = new Set();\r\n        const duplicateIndices = [];\r\n        \r\n        for (let i = 0; i < this.enemyPool.length; i++) {\r\n            const entity = this.enemyPool[i];\r\n            \r\n            // Skip invalid entities\r\n            if (!entity || !entity.id) {\r\n                console.warn(`Invalid entity at index ${i} in enemy pool - removing`);\r\n                duplicateIndices.push(i);\r\n                inconsistenciesFixed++;\r\n                continue;\r\n            }\r\n            \r\n            // Check if this entity ID is already in the pool\r\n            if (poolEntityIds.has(entity.id)) {\r\n                console.warn(`Duplicate entity ${entity.id} found in enemy pool at index ${i} - removing`);\r\n                duplicateIndices.push(i);\r\n                inconsistenciesFixed++;\r\n            } else {\r\n                poolEntityIds.add(entity.id);\r\n            }\r\n        }\r\n        \r\n        // Remove duplicates from the pool (in reverse order to avoid index issues)\r\n        for (let i = duplicateIndices.length - 1; i >= 0; i--) {\r\n            this.enemyPool.splice(duplicateIndices[i], 1);\r\n        }\r\n        \r\n        // ACTIVE-POOLED CHECK: No entity should be both active and in the pool\r\n        const activePooledEntities = [];\r\n        \r\n        for (let i = 0; i < this.enemyPool.length; i++) {\r\n            const entity = this.enemyPool[i];\r\n            \r\n            // If entity is also in active enemies, that's a critical error\r\n            if (enemies.has(entity.id)) {\r\n                console.error(`CRITICAL ERROR: Entity ${entity.id} is both active and in the pool!`);\r\n                activePooledEntities.push(i);\r\n                inconsistenciesFixed++;\r\n            }\r\n        }\r\n        \r\n        // Remove entities that are both active and pooled from the pool\r\n        for (let i = activePooledEntities.length - 1; i >= 0; i--) {\r\n            const index = activePooledEntities[i];\r\n            const entityId = this.enemyPool[index].id;\r\n            this.enemyPool.splice(index, 1);\r\n            console.log(`Fixed critical inconsistency: Removed entity ${entityId} from pool since it's active`);\r\n        }\r\n        \r\n        // Check the enemy tag map\r\n        let enemyTaggedCount = 0;\r\n        let pooledTaggedCount = 0;\r\n        let inconsistentEntities = 0;\r\n        \r\n        if (this.world && this.world.entityManager && this.world.entityManager.entitiesByTag) {\r\n            // Count entities with enemy tag\r\n            const enemyTaggedEntities = this.world.entityManager.entitiesByTag.get('enemy') || [];\r\n            enemyTaggedCount = enemyTaggedEntities.length;\r\n            \r\n            // Count entities with pooled tag\r\n            const pooledTaggedEntities = this.world.entityManager.entitiesByTag.get('pooled') || [];\r\n            pooledTaggedCount = pooledTaggedEntities.length;\r\n            \r\n            // Check for inconsistent state: entities with both 'enemy' and 'pooled' tags\r\n            for (const entity of enemyTaggedEntities) {\r\n                if (entity.hasTag('pooled')) {\r\n                    console.warn(`INCONSISTENT ENTITY ${entity.id}: Has both 'enemy' and 'pooled' tags`);\r\n                    inconsistentEntities++;\r\n                    \r\n                    // POOL STATUS CHECK: If entity has pooled tag, it MUST be in the pool\r\n                    const isInPool = this.enemyPool.some(e => e.id === entity.id);\r\n                    \r\n                    if (isInPool) {\r\n                        // Entity is in pool with enemy tag - remove enemy tag\r\n                        entity.removeTag('enemy');\r\n                        console.log(`Fixed entity ${entity.id} by removing 'enemy' tag since it's in the pool`);\r\n                    } else {\r\n                        // Entity has pooled tag but not in pool - remove pooled tag\r\n                        entity.removeTag('pooled');\r\n                        console.log(`Fixed entity ${entity.id} by removing 'pooled' tag since it's not in the pool`);\r\n                    }\r\n                    \r\n                    inconsistenciesFixed++;\r\n                }\r\n            }\r\n            \r\n            // Check for inconsistent state: pooled entities in active enemies set\r\n            for (const entityId of enemies) {\r\n                const entity = this.world.getEntity(entityId);\r\n                if (entity && entity.hasTag('pooled')) {\r\n                    console.warn(`INCONSISTENT TRACKING: Entity ${entityId} is in active enemies but has 'pooled' tag`);\r\n                    \r\n                    // Check if entity is actually in the pool\r\n                    const isInPool = this.enemyPool.some(e => e.id === entityId);\r\n                    \r\n                    if (isInPool) {\r\n                        // Entity is in pool and active list - remove from active list\r\n                        enemies.delete(entityId);\r\n                        console.log(`Fixed by removing entity ${entityId} from active enemies set since it's in the pool`);\r\n                    } else {\r\n                        // Entity has pooled tag but not in pool - remove pooled tag\r\n                        entity.removeTag('pooled');\r\n                        console.log(`Fixed entity ${entityId} by removing 'pooled' tag since it's not in the pool`);\r\n                    }\r\n                    \r\n                    inconsistentEntities++;\r\n                    inconsistenciesFixed++;\r\n                }\r\n            }\r\n            \r\n            // Check enemy pool for tag issues\r\n            for (let i = 0; i < this.enemyPool.length; i++) {\r\n                const entity = this.enemyPool[i];\r\n                \r\n                if (!entity) continue;\r\n                \r\n                let entityFixed = false;\r\n                \r\n                // Entities in the pool MUST have the pooled tag\r\n                if (!entity.hasTag('pooled')) {\r\n                    console.warn(`INCONSISTENT POOL: Entity ${entity.id} in enemy pool but missing 'pooled' tag`);\r\n                    entity.addTag('pooled');\r\n                    console.log(`Fixed by adding 'pooled' tag to entity ${entity.id}`);\r\n                    entityFixed = true;\r\n                    inconsistenciesFixed++;\r\n                }\r\n                \r\n                // Entities in the pool MUST NOT have the enemy tag\r\n                if (entity.hasTag('enemy')) {\r\n                    console.warn(`INCONSISTENT POOL: Entity ${entity.id} in enemy pool but has 'enemy' tag`);\r\n                    entity.removeTag('enemy');\r\n                    console.log(`Fixed by removing 'enemy' tag from entity ${entity.id}`);\r\n                    entityFixed = true;\r\n                    inconsistenciesFixed++;\r\n                }\r\n                \r\n                if (entityFixed) {\r\n                    inconsistentEntities++;\r\n                }\r\n            }\r\n        }\r\n        \r\n        console.log(`Diagnostic results: ${enemyTaggedCount} entities with 'enemy' tag, ${pooledTaggedCount} entities with 'pooled' tag`);\r\n        console.log(`Fixed ${inconsistenciesFixed} inconsistencies across ${inconsistentEntities} entities`);\r\n        console.log(\"=== DIAGNOSTICS COMPLETE ===\");\r\n    }\r\n} ","/**\r\n * Enemy Spawner - Handles the generation of spawn points and enemy spawning\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';\r\nimport { EnemyAIComponent } from '../../components/combat/enemyAI.js';\r\nimport { TransformComponent } from '../../components/transform.js';\r\nimport { HealthComponent } from '../../components/combat/healthComponent.js';\r\nimport { RigidbodyComponent } from '../../components/physics/rigidbody.js';\r\nimport { MeshComponent } from '../../components/rendering/mesh.js';\r\n// import { TrailComponent } from '../../components/rendering/trail.js';\r\n\r\nexport class EnemySpawner {\r\n    constructor(world) {\r\n        this.world = world;\r\n        this.spawnPoints = [];\r\n        this.spawnTimer = 0;\r\n        this.spawnInterval = 3; // Seconds between spawns\r\n        this.lastSpawnTime = Date.now();\r\n        this.modelCache = {};\r\n        \r\n        // Base enemy config (will be modified by difficulty scaling)\r\n        this.baseEnemyConfig = {\r\n            health: 20,\r\n            damage: 15,\r\n            speed: 700,\r\n            spiralAmplitude: 150,\r\n            spiralFrequency: 2.0\r\n        };\r\n        \r\n        // Current enemy config (copy of base config initially)\r\n        this.enemyConfig = { ...this.baseEnemyConfig };\r\n        \r\n        // Pre-load models\r\n        this.loadModels();\r\n        \r\n        // Generate initial spawn points\r\n        this.generateSpawnPoints();\r\n    }\r\n    \r\n    /**\r\n     * Pre-load all enemy models\r\n     */\r\n    loadModels() {\r\n        const loader = new GLTFLoader();\r\n        \r\n        // Try multiple paths for the GLB file\r\n        const modelPaths = [\r\n            '/assets/enemy.glb',\r\n            './assets/enemy.glb',\r\n            'assets/enemy.glb',\r\n            '/Asteroid-Miner/assets/enemy.glb'  // GitHub Pages path\r\n        ];\r\n        \r\n        let loadAttempts = 0;\r\n        const tryLoadModel = (index) => {\r\n            if (index >= modelPaths.length) {\r\n                console.warn('Could not load enemy model from any path, will use fallback meshes');\r\n                // Don't set modelCache.enemyDrone so fallback will be used\r\n                return;\r\n            }\r\n            \r\n            const path = modelPaths[index];\r\n            console.log(`Attempting to load enemy model from: ${path}`);\r\n            \r\n            loader.load(\r\n                path,\r\n                (gltf) => {\r\n                    console.log(`Enemy model loaded successfully from ${path}`);\r\n                    this.modelCache.enemyDrone = gltf.scene;\r\n                    \r\n                    // Apply any global transformations or material adjustments\r\n                    this.modelCache.enemyDrone.traverse((child) => {\r\n                        if (child.isMesh) {\r\n                            // Make materials glow with emissive\r\n                            if (child.material) {\r\n                                child.material.emissive = new THREE.Color(0x0088ff);\r\n                                child.material.emissiveIntensity = 2.0;\r\n                            }\r\n                        }\r\n                    });\r\n                },\r\n                (xhr) => {\r\n                    // Progress callback\r\n                },\r\n                (error) => {\r\n                    console.log(`Failed to load from ${path}, trying next...`);\r\n                    tryLoadModel(index + 1);\r\n                }\r\n            );\r\n        };\r\n        \r\n        tryLoadModel(0);\r\n    }\r\n    \r\n    /**\r\n     * Generate spawn points for enemies based on player position\r\n     */\r\n    generateSpawnPoints() {\r\n        // Clear existing spawn points\r\n        this.spawnPoints = [];\r\n        \r\n        // Try multiple methods to find the player\r\n        let players = [];\r\n        let playerPosition = null;\r\n        \r\n        // Method 1: Try using entityManager\r\n        try {\r\n            if (this.world.entityManager && this.world.entityManager.getEntitiesByTag) {\r\n                players = this.world.entityManager.getEntitiesByTag('player');\r\n                if (players.length > 0) {\r\n                    const transform = players[0].getComponent('TransformComponent');\r\n                    if (transform && transform.position) {\r\n                        playerPosition = transform.position;\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            console.log(\"Could not get player via entityManager:\", e.message);\r\n        }\r\n        \r\n        // Method 2: Try direct world method\r\n        if (!playerPosition) {\r\n            try {\r\n                if (this.world.getEntitiesByTag) {\r\n                    players = this.world.getEntitiesByTag('player');\r\n                    if (players.length > 0) {\r\n                        const transform = players[0].getComponent('TransformComponent');\r\n                        if (transform && transform.position) {\r\n                            playerPosition = transform.position;\r\n                        }\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.log(\"Could not get player via world.getEntitiesByTag:\", e.message);\r\n            }\r\n        }\r\n        \r\n        // Method 3: Check window.game for spaceship position\r\n        if (!playerPosition && window.game) {\r\n            try {\r\n                if (window.game.spaceship && window.game.spaceship.mesh && window.game.spaceship.mesh.position) {\r\n                    playerPosition = window.game.spaceship.mesh.position;\r\n                    console.log(\"Using spaceship mesh position for spawn points\");\r\n                }\r\n            } catch (e) {\r\n                console.log(\"Could not get player via window.game.spaceship:\", e.message);\r\n            }\r\n        }\r\n        \r\n        // If still no player position found, use default spawn points\r\n        if (!playerPosition) {\r\n            // Default spawn points in a circle around origin if no player found\r\n            const radius = 3000;\r\n            const count = 10;\r\n            \r\n            for (let i = 0; i < count; i++) {\r\n                const angle = (i / count) * Math.PI * 2;\r\n                const x = Math.cos(angle) * radius;\r\n                const y = (Math.random() - 0.5) * 1000;\r\n                const z = Math.sin(angle) * radius;\r\n                this.spawnPoints.push(new THREE.Vector3(x, y, z));\r\n            }\r\n            \r\n            console.log(`No player position found - generated ${this.spawnPoints.length} default spawn points around origin`);\r\n            return;\r\n        }\r\n        \r\n        // Generate spawn points in a sphere around player\r\n        const center = playerPosition.clone ? playerPosition.clone() : new THREE.Vector3(playerPosition.x, playerPosition.y, playerPosition.z);\r\n        const radius = 2500; // Spawn at a reasonable distance\r\n        const count = 12;\r\n        \r\n        for (let i = 0; i < count; i++) {\r\n            // Generate random points on a sphere\r\n            const phi = Math.acos(2 * Math.random() - 1);\r\n            const theta = Math.random() * Math.PI * 2;\r\n            \r\n            const x = center.x + radius * Math.sin(phi) * Math.cos(theta);\r\n            const y = center.y + radius * Math.sin(phi) * Math.sin(theta);\r\n            const z = center.z + radius * Math.cos(phi);\r\n            \r\n            this.spawnPoints.push(new THREE.Vector3(x, y, z));\r\n        }\r\n        \r\n        console.log(`Generated ${this.spawnPoints.length} spawn points around player at position ${center.x.toFixed(0)}, ${center.y.toFixed(0)}, ${center.z.toFixed(0)}`);\r\n    }\r\n    \r\n    /**\r\n     * Get a random spawn point for enemies\r\n     * @returns {THREE.Vector3} Spawn position\r\n     */\r\n    getRandomSpawnPoint() {\r\n        // Make sure spawn points are available\r\n        if (this.spawnPoints.length === 0) {\r\n            this.generateSpawnPoints();\r\n        }\r\n        \r\n        // Choose a random spawn point\r\n        if (this.spawnPoints.length > 0) {\r\n            const index = Math.floor(Math.random() * this.spawnPoints.length);\r\n            return this.spawnPoints[index].clone();\r\n        } else {\r\n            // Fallback - spawn at a fixed distance from origin\r\n            console.warn(\"No spawn points available, using fallback position\");\r\n            const angle = Math.random() * Math.PI * 2;\r\n            const distance = 2000;\r\n            return new THREE.Vector3(\r\n                Math.cos(angle) * distance,\r\n                (Math.random() - 0.5) * 500,\r\n                Math.sin(angle) * distance\r\n            );\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check the spawn timer and spawn enemies if needed\r\n     * @param {number} deltaTime The time since the last update\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     * @param {number} maxEnemies Maximum number of enemies allowed\r\n     * @param {function} spawnFunction The function to call to spawn an enemy\r\n     * @returns {boolean} Whether an enemy was spawned\r\n     */\r\n    update(deltaTime, enemies, maxEnemies, spawnFunction) {\r\n        // Update spawn timer\r\n        this.spawnTimer += deltaTime;\r\n        \r\n        // Get difficulty-adjusted spawn interval if available\r\n        let currentSpawnInterval = this.spawnInterval;\r\n        \r\n        // Apply difficulty scaling if available through parent system or game object\r\n        this.updateDifficultyParameters();\r\n        \r\n        // Check if we should spawn new enemies\r\n        if (this.spawnTimer >= currentSpawnInterval && enemies.size < maxEnemies) {\r\n            // Get a spawn point\r\n            const spawnPoint = this.getRandomSpawnPoint();\r\n            if (!spawnPoint) {\r\n                console.error(\"Failed to get spawn point! Generating new spawn points.\");\r\n                this.generateSpawnPoints();\r\n                return false;\r\n            }\r\n            \r\n            // Call the provided spawn function\r\n            const result = spawnFunction(spawnPoint);\r\n            \r\n            // Reset spawn timer if successful\r\n            if (result) {\r\n                this.spawnTimer = 0;\r\n                this.lastSpawnTime = Date.now();\r\n                return true;\r\n            }\r\n        }\r\n        \r\n        return false;\r\n    }\r\n    \r\n    /**\r\n     * Update enemy parameters based on difficulty scaling\r\n     */\r\n    updateDifficultyParameters() {\r\n        // Try to get difficulty parameters from parent or game\r\n        \r\n        // Check if there's a global difficulty manager\r\n        if (window.game && window.game.difficultyManager && window.game.difficultyManager.params) {\r\n            const diffParams = window.game.difficultyManager.params;\r\n            \r\n            // Update our parameters if they exist in the difficulty manager\r\n            if (diffParams.enemyHealth !== undefined) {\r\n                this.enemyConfig.health = diffParams.enemyHealth;\r\n            }\r\n            \r\n            if (diffParams.enemyDamage !== undefined) {\r\n                this.enemyConfig.damage = diffParams.enemyDamage;\r\n            }\r\n            \r\n            if (diffParams.enemySpeed !== undefined) {\r\n                this.enemyConfig.speed = diffParams.enemySpeed;\r\n            }\r\n            \r\n            if (diffParams.spawnInterval !== undefined) {\r\n                this.spawnInterval = diffParams.spawnInterval;\r\n            }\r\n            \r\n            // Log current parameters occasionally for debugging\r\n            if (Math.random() < 0.005) { // ~0.5% chance each frame to avoid spam\r\n                console.log(`Current enemy parameters: Health=${this.enemyConfig.health}, Damage=${this.enemyConfig.damage}, Speed=${this.enemyConfig.speed}, SpawnInterval=${this.spawnInterval}`);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Spawns a spectral drone at the given position\r\n     * @param {THREE.Vector3} position The position to spawn at\r\n     * @param {Object} poolManager The enemy pool manager\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     * @param {number} maxEnemies Maximum number of enemies allowed\r\n     * @returns {Entity} The created entity\r\n     */\r\n    spawnSpectralDrone(position, poolManager, enemies, maxEnemies) {\r\n        console.log(\"Setting up spectral drone config...\");\r\n        \r\n        // STRICT LIMIT CHECK: Do not spawn if already at or over capacity\r\n        if (enemies.size >= maxEnemies) {\r\n            console.warn(`SPAWN BLOCKED: Already at maximum enemies (${enemies.size}/${maxEnemies})`);\r\n            return null;\r\n        }\r\n        \r\n        // Update difficulty parameters before spawning\r\n        this.updateDifficultyParameters();\r\n        \r\n        // Get a spectral drone from the pool\r\n        const entity = poolManager.getEnemyFromPool();\r\n        \r\n        // Extra safety check - verify entity exists and isn't already tracked\r\n        if (!entity) {\r\n            console.error(\"Failed to get entity from pool or create new one\");\r\n            return null;\r\n        }\r\n        \r\n        // VERIFY ENTITY STATE: Ensure entity isn't already in use\r\n        if (enemies.has(entity.id)) {\r\n            console.error(`Entity ${entity.id} is already in the active enemies list!`);\r\n            return null;\r\n        }\r\n        \r\n        // VERIFICATION: Double-check that entity is in a clean state before setting up\r\n        // It should have no tags at this point\r\n        if (entity.tags && entity.tags.size > 0) {\r\n            console.warn(`Entity ${entity.id} from pool still has tags: [${[...entity.tags]}]. Clearing all tags.`);\r\n            if (entity.clearTags && typeof entity.clearTags === 'function') {\r\n                entity.clearTags();\r\n            } else {\r\n                entity.tags.clear();\r\n                entity._isEnemy = false;\r\n                entity._isPooled = false;\r\n                entity._isPlayer = false;\r\n                entity._isProjectile = false;\r\n            }\r\n        }\r\n        \r\n        // Add enemy tags that were not added during pooling\r\n        entity.addTag('enemy');\r\n        entity.addTag('spectrals');\r\n        \r\n        // Add some randomness to the drone properties for visual variety,\r\n        // but now BASED ON THE DIFFICULTY-ADJUSTED VALUES\r\n        const amplitude = this.enemyConfig.spiralAmplitude * (0.8 + Math.random() * 0.4); // 80-120% of base\r\n        const frequency = this.enemyConfig.spiralFrequency * (0.9 + Math.random() * 0.2); // 90-110% of base\r\n        const speed = this.enemyConfig.speed * (0.7 + Math.random() * 0.6); // 70-130% of base\r\n        \r\n        // Generate visual variation parameters\r\n        const sizeVariation = 0.8 + Math.random() * 0.8; // 80% to 160% size variation\r\n        const baseSize = 80; // Increased base size from 50 to 80\r\n        const finalSize = baseSize * sizeVariation;\r\n        \r\n        // Add slight rotation offset for more natural appearance\r\n        const rotationOffset = {\r\n            x: (Math.random() - 0.5) * 0.2, // ±0.1 radians (~±5.7 degrees)\r\n            y: (Math.random() - 0.5) * 0.2,\r\n            z: (Math.random() - 0.5) * 0.2\r\n        };\r\n        \r\n        // Choose a visual effect variant (0-3)\r\n        // 0: Normal, 1: Damaged, 2: Elite, 3: Shielded\r\n        const visualVariant = Math.floor(Math.random() * 4);\r\n        entity.visualVariant = visualVariant;\r\n        \r\n        // Configure transform - ALWAYS ensure we have a valid transform\r\n        let transform = entity.getComponent('TransformComponent');\r\n        \r\n        // Remove old transform if it exists to ensure clean state\r\n        if (transform) {\r\n            entity.removeComponent('TransformComponent');\r\n        }\r\n        \r\n        // Always create a fresh transform component\r\n        transform = new TransformComponent(position.clone());\r\n        transform.scale.set(finalSize, finalSize, finalSize);\r\n        \r\n        // Apply rotation offset\r\n        transform.rotation.x = rotationOffset.x;\r\n        transform.rotation.y = rotationOffset.y;\r\n        transform.rotation.z = rotationOffset.z;\r\n        \r\n        transform.needsUpdate = true;\r\n        \r\n        // Add the new transform component\r\n        entity.addComponent(transform);\r\n        console.log(`Added TransformComponent to entity ${entity.id} at position (${position.x.toFixed(0)}, ${position.y.toFixed(0)}, ${position.z.toFixed(0)})`);\r\n        \r\n        // Add or update health component with difficulty-scaled health\r\n        let health = entity.getComponent('HealthComponent');\r\n        if (!health) {\r\n            health = new HealthComponent(this.enemyConfig.health, 0);\r\n            entity.addComponent(health);\r\n        } else {\r\n            health.maxHealth = this.enemyConfig.health;\r\n            health.health = this.enemyConfig.health;\r\n            health.isDestroyed = false;\r\n        }\r\n        \r\n        // Configure AI component\r\n        let enemyAI = entity.getComponent('EnemyAIComponent');\r\n        if (!enemyAI) {\r\n            const config = {\r\n                faction: 'spectrals',\r\n                type: 'drone',\r\n                health: this.enemyConfig.health,\r\n                damage: this.enemyConfig.damage,\r\n                speed: speed,\r\n                spiralAmplitude: amplitude,\r\n                spiralFrequency: frequency,\r\n                isDroneLike: true  // New flag for drone-like movement\r\n            };\r\n            enemyAI = new EnemyAIComponent(config);\r\n            entity.addComponent(enemyAI);\r\n        } else {\r\n            enemyAI.faction = 'spectrals';\r\n            enemyAI.type = 'drone';\r\n            enemyAI.damage = this.enemyConfig.damage;\r\n            enemyAI.speed = speed;\r\n            enemyAI.spiralAmplitude = amplitude;\r\n            enemyAI.spiralFrequency = frequency;\r\n            enemyAI.isDroneLike = true;  // New flag for drone-like movement\r\n            enemyAI.enabled = true;\r\n        }\r\n        \r\n        // Get the mesh from the GLB model\r\n        // Store reference to current entity being processed\r\n        this.currentEntity = entity;\r\n        const spectralMesh = this.createSpectralDroneMesh();\r\n        // Clear the reference after mesh creation\r\n        this.currentEntity = null;\r\n        \r\n        // Get existing mesh component if any\r\n        let meshComponent = entity.getComponent('MeshComponent');\r\n        \r\n        // Clean up old mesh component if exists\r\n        if (meshComponent) {\r\n            // Remove old mesh from scene if exists\r\n            if (meshComponent.mesh && meshComponent.mesh.parent) {\r\n                meshComponent.mesh.parent.remove(meshComponent.mesh);\r\n            }\r\n            \r\n            // Dispose of old mesh resources\r\n            if (meshComponent.mesh) {\r\n                if (meshComponent.mesh.geometry) {\r\n                    meshComponent.mesh.geometry.dispose();\r\n                }\r\n                \r\n                if (meshComponent.mesh.material) {\r\n                    if (Array.isArray(meshComponent.mesh.material)) {\r\n                        meshComponent.mesh.material.forEach(mat => mat.dispose());\r\n                    } else {\r\n                        meshComponent.mesh.material.dispose();\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Remove the old component\r\n            entity.removeComponent('MeshComponent');\r\n        }\r\n        \r\n        // Create new mesh component with the actual mesh\r\n        if (spectralMesh.isGLTF) {\r\n            // For GLTF models, pass the model directly\r\n            meshComponent = new MeshComponent(spectralMesh.model);\r\n        } else {\r\n            // For placeholder geometry\r\n            meshComponent = new MeshComponent(spectralMesh.geometry, spectralMesh.material);\r\n        }\r\n        \r\n        // Add the new component to the entity\r\n        entity.addComponent(meshComponent);\r\n        \r\n        // Ensure the mesh is visible\r\n        meshComponent.setVisible(true);\r\n        \r\n        // Try to add to the scene immediately if it's available\r\n        if (this.world && this.world.scene && meshComponent.mesh) {\r\n            // Add to scene if not already added\r\n            if (!meshComponent.mesh.parent) {\r\n                // Set renderer guard to prevent warning\r\n                const prevGuard = window.__rendererGuard;\r\n                window.__rendererGuard = true;\r\n                try {\r\n                    this.world.scene.add(meshComponent.mesh);\r\n                } finally {\r\n                    window.__rendererGuard = prevGuard;\r\n                }\r\n            }\r\n            \r\n            // Get transform component to sync position - this should always exist now\r\n            const transformComp = entity.getComponent('TransformComponent');\r\n            if (transformComp) {\r\n                // Ensure mesh position, rotation, and scale match entity transform\r\n                meshComponent.mesh.position.copy(transformComp.position);\r\n                meshComponent.mesh.rotation.x = transformComp.rotation.x;\r\n                meshComponent.mesh.rotation.y = transformComp.rotation.y;\r\n                meshComponent.mesh.rotation.z = transformComp.rotation.z;\r\n                meshComponent.mesh.scale.copy(transformComp.scale);\r\n                \r\n                console.log(`Synced mesh position to (${transformComp.position.x.toFixed(0)}, ${transformComp.position.y.toFixed(0)}, ${transformComp.position.z.toFixed(0)})`);\r\n            } else {\r\n                console.error(`Entity ${entity.id} has no TransformComponent after it was just added!`);\r\n            }\r\n            \r\n            console.log(\"Added enemy drone mesh to scene with visibility:\", meshComponent.mesh.visible);\r\n        }\r\n        \r\n        // Add physics if needed\r\n        let rigidbody = entity.getComponent('RigidbodyComponent');\r\n        if (!rigidbody) {\r\n            rigidbody = new RigidbodyComponent(1);\r\n            rigidbody.useGravity = false;\r\n            rigidbody.drag = 0.1;\r\n            rigidbody.shape = 'sphere';\r\n            rigidbody.collisionRadius = 50;\r\n            entity.addComponent(rigidbody);\r\n        } else {\r\n            rigidbody.isFrozen = false;\r\n            rigidbody.velocity.set(0, 0, 0);\r\n            // Make sure collision radius is set correctly\r\n            rigidbody.collisionRadius = 50;\r\n        }\r\n        \r\n        // Sync rigidbody position with transform\r\n        const currentTransform = entity.getComponent('TransformComponent');\r\n        if (currentTransform && rigidbody) {\r\n            rigidbody.position = currentTransform.position.clone();\r\n        }\r\n        \r\n        // Add trail effect if not already present - thrusting effect\r\n        if (!entity.getComponent('TrailComponent')) {\r\n            // Temporarily disabled trail effect\r\n            // this.addSpectralTrail(entity, transform);\r\n        }\r\n        \r\n        // SYNCHRONIZATION FIX: Remove any existing references to this entity ID before adding\r\n        // This prevents duplicate tracking if an entity with the same ID is already tracked\r\n        enemies.delete(entity.id);\r\n        \r\n        // Track this enemy\r\n        enemies.add(entity.id);\r\n        this.lastSpawnTime = Date.now();\r\n        \r\n        // VERIFICATION: Double-check that enemy has required tag after setup\r\n        if (!entity.hasTag('enemy')) {\r\n            console.warn(`CRITICAL ERROR: Entity ${entity.id} missing 'enemy' tag after setup!`);\r\n            entity.addTag('enemy'); // Force re-add the tag\r\n        }\r\n        \r\n        // GLOBAL SYNCHRONIZATION: Register this entity with combat module if available\r\n        if (window.game && window.game.combat) {\r\n            // Inform other systems about this enemy\r\n            window.game.combat.registerEnemy && window.game.combat.registerEnemy(entity.id);\r\n        }\r\n        \r\n        console.log(`Spawned enemy drone at position: x=${position.x.toFixed(0)}, y=${position.y.toFixed(0)}, z=${position.z.toFixed(0)}`);\r\n        console.log(`Properties: Speed=${enemyAI.speed}, Amplitude=${enemyAI.spiralAmplitude}, Frequency=${enemyAI.spiralFrequency}`);\r\n        \r\n        // ADDITIONAL LOGGING: Log the current state after spawn\r\n        console.log(`Current enemy count after spawn: ${enemies.size}/${maxEnemies}`);\r\n        \r\n        return entity;\r\n    }\r\n    \r\n    /**\r\n     * Adds a spectral trail effect to an enemy entity\r\n     * @param {Entity} entity The enemy entity\r\n     * @param {TransformComponent} transform The entity's transform component\r\n     */\r\n    addSpectralTrail(entity, transform) {\r\n        // Create a special trail component for the enemy drone with a thruster-like effect\r\n        const trailComponent = new TrailComponent({\r\n            maxPoints: 50,             // Trail length in points\r\n            pointDistance: 5,          // Min distance to record a new point\r\n            width: 15,                 // Trail width slightly narrower for thruster effect\r\n            color: 0x00ccff,           // Cyan-blue color\r\n            fadeTime: 1.5,             // Seconds to fade out\r\n            transparent: true,\r\n            alphaTest: 0.01,\r\n            blending: THREE.AdditiveBlending, // Additive blending for glow effect\r\n            pulse: true,               // Make the trail pulse\r\n            pulseSpeed: 2.5,           // Faster pulsing for thruster effect\r\n            tapering: true,            // Taper the end of the trail\r\n            glow: true,                // Add glow effect\r\n            thrusterMode: true         // New flag for thruster-like behavior\r\n        });\r\n        \r\n        // IMPORTANT: Initialize the trail with the current entity position\r\n        // This ensures the trail starts from the entity's current position \r\n        // and not from the origin (0,0,0)\r\n        if (transform && transform.position) {\r\n            // Initialize points array with current position to prevent \"line to center\" visual bug\r\n            trailComponent.lastPosition = transform.position.clone();\r\n            \r\n            // If the trailComponent has a points array, initialize it with the current position\r\n            if (trailComponent.points) {\r\n                trailComponent.points = [transform.position.clone()];\r\n            }\r\n            \r\n            // If the component has an initializeTrail method, call it\r\n            if (typeof trailComponent.initializeTrail === 'function') {\r\n                trailComponent.initializeTrail(transform.position);\r\n            }\r\n        }\r\n        \r\n        // Attach the trail component to the entity\r\n        entity.addComponent(trailComponent);\r\n        \r\n        // Check if the world has a registered trail system\r\n        let trailSystemRegistered = false;\r\n        \r\n        // Method 1: Check for a global trail system\r\n        if (window.game && window.game.trailSystem) {\r\n            window.game.trailSystem.registerTrail(entity.id, trailComponent);\r\n            trailSystemRegistered = true;\r\n        }\r\n        \r\n        // Method 2: Check if the world has a trail system in its system manager\r\n        if (!trailSystemRegistered && this.world && this.world.systemManager) {\r\n            const trailSystem = this.world.systemManager.getSystem('TrailSystem');\r\n            if (trailSystem) {\r\n                trailSystem.registerTrail(entity.id, trailComponent);\r\n                trailSystemRegistered = true;\r\n            }\r\n        }\r\n        \r\n        // If no trail system is registered, we'll need to manually initialize the trail\r\n        if (!trailSystemRegistered) {\r\n            console.log(\"No trail system found - initializing trail component directly\");\r\n            // The trail component will self-initialize when attached to the entity\r\n        }\r\n        \r\n        console.log(`Added thruster trail component to entity ${entity.id} at position (${transform.position.x.toFixed(0)}, ${transform.position.y.toFixed(0)}, ${transform.position.z.toFixed(0)})`);\r\n        \r\n        return trailComponent;\r\n    }\r\n    \r\n    /**\r\n     * Creates a spectral drone mesh from loaded GLB\r\n     * @returns {Object} Object containing model\r\n     */\r\n    createSpectralDroneMesh() {\r\n        console.log(\"Creating spectral drone from GLB model...\");\r\n        \r\n        // If model isn't loaded yet, create a stylized fallback mesh\r\n        if (!this.modelCache.enemyDrone) {\r\n            console.warn(\"Enemy model not loaded - creating stylized fallback enemy\");\r\n            \r\n            // Create a more interesting fallback enemy shape\r\n            const group = new THREE.Group();\r\n            \r\n            // Main body - octahedron for alien look\r\n            const bodyGeometry = new THREE.OctahedronGeometry(2, 0);\r\n            const bodyMaterial = new THREE.MeshPhongMaterial({ \r\n                color: 0x00ffff,\r\n                emissive: 0x0088ff,\r\n                emissiveIntensity: 1.5,\r\n                transparent: true,\r\n                opacity: 0.9\r\n            });\r\n            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);\r\n            group.add(body);\r\n            \r\n            // Add some wings/fins for visual interest\r\n            const wingGeometry = new THREE.BoxGeometry(4, 0.2, 1);\r\n            const wingMaterial = new THREE.MeshPhongMaterial({\r\n                color: 0x8888ff,\r\n                emissive: 0x4444ff,\r\n                emissiveIntensity: 1.0\r\n            });\r\n            const wing1 = new THREE.Mesh(wingGeometry, wingMaterial);\r\n            wing1.position.set(0, 0, 0);\r\n            wing1.rotation.z = Math.PI / 6;\r\n            group.add(wing1);\r\n            \r\n            const wing2 = new THREE.Mesh(wingGeometry, wingMaterial);\r\n            wing2.position.set(0, 0, 0);\r\n            wing2.rotation.z = -Math.PI / 6;\r\n            group.add(wing2);\r\n            \r\n            // Scale the group to appropriate size\r\n            group.scale.set(1.5, 1.5, 1.5);\r\n            \r\n            return group;\r\n        }\r\n        \r\n        // Clone the model to avoid shared instance issues\r\n        const model = this.modelCache.enemyDrone.clone();\r\n        \r\n        // Get the visual variant if it exists on the entity being processed\r\n        let visualVariant = 0;\r\n        if (this.currentEntity && this.currentEntity.visualVariant !== undefined) {\r\n            visualVariant = this.currentEntity.visualVariant;\r\n        }\r\n        \r\n        // Extended color palette with 10 options instead of just 3\r\n        const colorPalette = [\r\n            { main: 0x00ccff, emissive: new THREE.Color(0x0088ff) }, // Blue/cyan\r\n            { main: 0x8866ff, emissive: new THREE.Color(0x6633ff) }, // Purple/blue\r\n            { main: 0x00ffcc, emissive: new THREE.Color(0x00bb99) }, // Teal/green\r\n            { main: 0xff3366, emissive: new THREE.Color(0xcc1144) }, // Red/pink\r\n            { main: 0xffaa00, emissive: new THREE.Color(0xcc8800) }, // Orange/gold\r\n            { main: 0x66ff33, emissive: new THREE.Color(0x44cc11) }, // Lime/green\r\n            { main: 0xff99ff, emissive: new THREE.Color(0xcc66cc) }, // Pink/magenta\r\n            { main: 0xffff33, emissive: new THREE.Color(0xcccc11) }, // Yellow\r\n            { main: 0x3366ff, emissive: new THREE.Color(0x1144cc) }, // Deep blue\r\n            { main: 0xff3333, emissive: new THREE.Color(0xcc1111) }  // Deep red\r\n        ];\r\n        \r\n        // Randomly choose from the extended color palette\r\n        const colorIndex = Math.floor(Math.random() * colorPalette.length);\r\n        const selectedColor = colorPalette[colorIndex];\r\n        \r\n        // Apply visual effects based on variant type\r\n        let emissiveIntensity = 1.0;\r\n        let opacity = 1.0;\r\n        let additionalEffects = false;\r\n        \r\n        switch (visualVariant) {\r\n            case 0: // Normal\r\n                emissiveIntensity = 1.0 + (Math.random() * 0.5); // 1.0-1.5\r\n                break;\r\n                \r\n            case 1: // Damaged - flickering effect, darker colors\r\n                emissiveIntensity = 0.5 + (Math.sin(Date.now() * 0.01) * 0.3); // 0.2-0.8, flickering\r\n                // Darken color\r\n                selectedColor.emissive.multiplyScalar(0.7);\r\n                // Add damage texturing (simulated with partial transparency)\r\n                opacity = 0.85;\r\n                break;\r\n                \r\n            case 2: // Elite - brighter, pulsing glow\r\n                emissiveIntensity = 2.0 + (Math.sin(Date.now() * 0.003) * 0.5); // 1.5-2.5, slow pulse\r\n                // Make more vibrant\r\n                selectedColor.emissive.multiplyScalar(1.2);\r\n                additionalEffects = true;\r\n                break;\r\n                \r\n            case 3: // Shielded - shimmer effect with interference patterns\r\n                emissiveIntensity = 1.5;\r\n                // Shield shimmer effect (simulated with color modulation)\r\n                const shieldPhase = Date.now() * 0.001;\r\n                const shimmerValue = 0.8 + (Math.sin(shieldPhase) * 0.2);\r\n                selectedColor.emissive.r *= shimmerValue;\r\n                selectedColor.emissive.g *= 1 + (1 - shimmerValue);\r\n                selectedColor.emissive.b *= 1 + (Math.cos(shieldPhase) * 0.2);\r\n                break;\r\n        }\r\n        \r\n        // Apply colors and effects to the model\r\n        model.traverse((child) => {\r\n            if (child.isMesh && child.material) {\r\n                // Clone material to avoid shared materials affecting other drones\r\n                child.material = child.material.clone(); \r\n                \r\n                // Apply main color and emissive effect\r\n                child.material.color = new THREE.Color(selectedColor.main);\r\n                child.material.emissive = selectedColor.emissive;\r\n                child.material.emissiveIntensity = emissiveIntensity;\r\n                \r\n                // Apply opacity if needed\r\n                if (opacity < 1.0) {\r\n                    child.material.transparent = true;\r\n                    child.material.opacity = opacity;\r\n                }\r\n                \r\n                // Apply additional effects for elite enemies\r\n                if (additionalEffects) {\r\n                    // Add higher shininess for elite enemies\r\n                    if (child.material.shininess !== undefined) {\r\n                        child.material.shininess = 100;\r\n                    }\r\n                    \r\n                    // Add env map if supported by the material type\r\n                    if (child.material.envMap !== undefined) {\r\n                        // Not creating real env maps here since that would require additional resources\r\n                        // In a full implementation, we'd add a cube texture\r\n                        child.material.envMapIntensity = 0.8;\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Add any variant-specific visual enhancements to the model\r\n        if (visualVariant === 2) { // Elite\r\n            // For elites, we could add extra mesh elements to show their status\r\n            // Here we'll add a simple halo effect using a ring geometry\r\n            try {\r\n                const haloGeometry = new THREE.RingGeometry(1.2, 1.5, 16);\r\n                const haloMaterial = new THREE.MeshBasicMaterial({\r\n                    color: selectedColor.main,\r\n                    transparent: true,\r\n                    opacity: 0.6,\r\n                    side: THREE.DoubleSide,\r\n                    blending: THREE.AdditiveBlending\r\n                });\r\n                \r\n                const halo = new THREE.Mesh(haloGeometry, haloMaterial);\r\n                halo.rotation.x = Math.PI / 2; // Make it horizontal\r\n                model.add(halo);\r\n                \r\n                // Add animation update handler\r\n                halo.userData.update = function(delta) {\r\n                    halo.rotation.z += delta * 0.5; // Slow rotation\r\n                    \r\n                    // Pulse size\r\n                    const pulseScale = 1 + 0.2 * Math.sin(Date.now() * 0.002);\r\n                    halo.scale.set(pulseScale, pulseScale, pulseScale);\r\n                };\r\n            } catch (error) {\r\n                console.error(\"Failed to create elite halo effect:\", error);\r\n            }\r\n        } else if (visualVariant === 3) { // Shielded\r\n            // For shielded enemies, add a translucent shield sphere\r\n            try {\r\n                const shieldGeometry = new THREE.SphereGeometry(1.1, 16, 12);\r\n                const shieldMaterial = new THREE.MeshBasicMaterial({\r\n                    color: 0xaaddff,\r\n                    transparent: true,\r\n                    opacity: 0.3,\r\n                    side: THREE.DoubleSide,\r\n                    blending: THREE.AdditiveBlending,\r\n                    wireframe: false\r\n                });\r\n                \r\n                const shield = new THREE.Mesh(shieldGeometry, shieldMaterial);\r\n                model.add(shield);\r\n                \r\n                // Add animation update handler\r\n                shield.userData.update = function(delta) {\r\n                    // Subtle pulsing effect\r\n                    const pulseScale = 1 + 0.05 * Math.sin(Date.now() * 0.003);\r\n                    shield.scale.set(pulseScale, pulseScale, pulseScale);\r\n                    \r\n                    // Shimmer effect on opacity\r\n                    shield.material.opacity = 0.2 + 0.1 * Math.sin(Date.now() * 0.002);\r\n                };\r\n            } catch (error) {\r\n                console.error(\"Failed to create shield effect:\", error);\r\n            }\r\n        }\r\n        \r\n        console.log(`Enemy drone model created with color #${selectedColor.main.toString(16)} and variant ${visualVariant}`);\r\n        \r\n        return { model, isGLTF: true };\r\n    }\r\n} ","/**\r\n * Enemy Lifecycle Manager - Handles the lifecycle of enemy entities\r\n */\r\n\r\nexport class EnemyLifecycle {\r\n    constructor(world) {\r\n        this.world = world;\r\n    }\r\n    \r\n    /**\r\n     * Validate enemy references to ensure all tracked enemies exist\r\n     * This helps prevent \"ghost\" references that block new spawns\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    validateEnemyReferences(enemies) {\r\n        // Store original size for logging\r\n        const originalSize = enemies.size;\r\n        \r\n        // Create a new Set to hold valid enemy IDs\r\n        const validEnemies = new Set();\r\n        \r\n        // Check each enemy ID in our tracking Set\r\n        for (const enemyId of enemies) {\r\n            // Get the entity from the world\r\n            const entity = this.world.getEntity(enemyId);\r\n            \r\n            // If entity exists, is an enemy, and is NOT pooled, keep tracking it\r\n            if (entity && entity.hasTag && entity.hasTag('enemy') && !entity.hasTag('pooled')) {\r\n                validEnemies.add(enemyId);\r\n            } else {\r\n                if (!entity) {\r\n                    console.warn(`Removing invalid enemy reference: ${enemyId} - Entity does not exist`);\r\n                } else if (!entity.hasTag) {\r\n                    console.warn(`Removing invalid enemy reference: ${enemyId} - Entity missing hasTag method`);\r\n                } else if (!entity.hasTag('enemy')) {\r\n                    // Check for tag inconsistency - entity might have the tag in its Set but the cache is wrong\r\n                    if (entity.tags && entity.tags.has && entity.tags.has('enemy')) {\r\n                        console.warn(`Entity ${enemyId} has inconsistent tag state: hasTag('enemy')=false but tag exists in Set`);\r\n                        \r\n                        // Force sync the entity's tag cache if possible\r\n                        if (entity._syncTagCache && typeof entity._syncTagCache === 'function') {\r\n                            entity._syncTagCache();\r\n                            console.log(`Fixed tag cache for entity ${enemyId}`);\r\n                            \r\n                            // Check again if the tag is now recognized\r\n                            if (entity.hasTag('enemy')) {\r\n                                console.log(`Entity ${enemyId} now properly recognizes 'enemy' tag, keeping in tracking`);\r\n                                validEnemies.add(enemyId);\r\n                                continue;\r\n                            }\r\n                        }\r\n                    }\r\n                    \r\n                    // If entity truly doesn't have the enemy tag, log and remove\r\n                    console.warn(`Removing invalid enemy reference: ${enemyId} - Entity missing 'enemy' tag. Tags: [${Array.from(entity.tags)}]`);\r\n                } else if (entity.hasTag('pooled')) {\r\n                    console.warn(`Removing invalid enemy reference: ${enemyId} - Entity is pooled but still has 'enemy' tag`);\r\n                    // Critical fix: Ensure pooled entities don't retain 'enemy' tag\r\n                    if (entity.hasTag('enemy')) {\r\n                        console.log(`Fixing inconsistent tag state: entity ${enemyId} is pooled but still has 'enemy' tag`);\r\n                        entity.removeTag('enemy');\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Replace our tracking Set with the validated Set\r\n        enemies.clear();\r\n        for (const id of validEnemies) {\r\n            enemies.add(id);\r\n        }\r\n        \r\n        // Double-check: also scan for any enemies that might not be in our tracking\r\n        let entitiesScanned = 0;\r\n        try {\r\n            if (this.world && this.world.entityManager) {\r\n                // Try to get entities with the 'enemy' tag first\r\n                let enemyEntities = [];\r\n                \r\n                if (this.world.entityManager.entitiesByTag && \r\n                    this.world.entityManager.entitiesByTag.get) {\r\n                    enemyEntities = this.world.entityManager.entitiesByTag.get('enemy') || [];\r\n                    entitiesScanned = enemyEntities.length;\r\n                    \r\n                    // Add any enemy entities that aren't in our tracking Set\r\n                    // BUT make sure they're not pooled (inactive) entities\r\n                    for (const enemy of enemyEntities) {\r\n                        // Skip undefined/null entities\r\n                        if (!enemy) continue;\r\n                        \r\n                        // Fix any cache inconsistencies before checking pooled status\r\n                        if (enemy._syncTagCache && typeof enemy._syncTagCache === 'function') {\r\n                            enemy._syncTagCache();\r\n                        }\r\n                        \r\n                        // CRITICAL FIX: First check if enemy is pooled BEFORE adding to tracking\r\n                        if (!enemy.hasTag('pooled')) {\r\n                            if (!enemies.has(enemy.id)) {\r\n                                console.log(`Found untracked enemy: ${enemy.id}, adding to tracking. Tags: [${[...enemy.tags]}]`);\r\n                                enemies.add(enemy.id);\r\n                            }\r\n                        } else {\r\n                            // Make sure pooled enemies are not in our tracking\r\n                            if (enemies.has(enemy.id)) {\r\n                                console.log(`Removing pooled enemy from tracking: ${enemy.id}`);\r\n                                enemies.delete(enemy.id);\r\n                            }\r\n                            \r\n                            // CRITICAL FIX: If an entity is pooled but still has the enemy tag, \r\n                            // remove the enemy tag to fix the inconsistency\r\n                            if (enemy.hasTag('enemy')) {\r\n                                console.log(`Fixing inconsistent tag state: pooled entity ${enemy.id} still has 'enemy' tag`);\r\n                                // Directly call removeTag to ensure proper cleanup\r\n                                enemy.removeTag('enemy');\r\n                            }\r\n                        }\r\n                    }\r\n                    \r\n                    // Another check: verify if the EntityManager tag maps are consistent with entity tags\r\n                    this.validateEntityManagerTagMaps(enemies);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error during entity scan:\", error);\r\n        }\r\n        \r\n        // Log if we fixed any tracking issues\r\n        if (originalSize !== enemies.size) {\r\n            console.log(`Enemy tracking corrected: ${originalSize} -> ${enemies.size} enemies tracked. Scanned ${entitiesScanned} entities.`);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Additional method to validate and fix EntityManager tag maps\r\n     * This helps ensure entity tags are consistent with the EntityManager's tracking\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    validateEntityManagerTagMaps(enemies) {\r\n        if (!this.world || !this.world.entityManager || !this.world.entityManager.entitiesByTag) {\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            const entitiesByTag = this.world.entityManager.entitiesByTag;\r\n            \r\n            // Check the enemy tag map specifically\r\n            if (entitiesByTag.has('enemy')) {\r\n                const enemyMap = entitiesByTag.get('enemy');\r\n                const invalidEntities = [];\r\n                \r\n                // Check each entity in the enemy map\r\n                for (let i = 0; i < enemyMap.length; i++) {\r\n                    const entity = enemyMap[i];\r\n                    \r\n                    // Skip invalid entities\r\n                    if (!entity) {\r\n                        invalidEntities.push(i);\r\n                        continue;\r\n                    }\r\n                    \r\n                    // If entity doesn't actually have the enemy tag in its tag Set, fix it\r\n                    if (!entity.tags || !entity.tags.has('enemy')) {\r\n                        console.warn(`Entity ${entity.id} is in 'enemy' tag map but doesn't have the tag in its Set`);\r\n                        \r\n                        // Add the tag properly through the entity's method\r\n                        if (entity.addTag) {\r\n                            entity.addTag('enemy');\r\n                            console.log(`Added missing 'enemy' tag to entity ${entity.id}`);\r\n                        } else {\r\n                            // If can't fix, mark for removal\r\n                            invalidEntities.push(i);\r\n                        }\r\n                    }\r\n                    \r\n                    // If entity has both enemy and pooled tags, that's an inconsistency\r\n                    if (entity.hasTag && entity.hasTag('pooled') && entity.hasTag('enemy')) {\r\n                        console.warn(`Entity ${entity.id} has both 'pooled' and 'enemy' tags - removing 'enemy' tag`);\r\n                        entity.removeTag('enemy');\r\n                        invalidEntities.push(i);\r\n                    }\r\n                }\r\n                \r\n                // Remove invalid entities from the map (in reverse order to avoid index issues)\r\n                for (let i = invalidEntities.length - 1; i >= 0; i--) {\r\n                    const index = invalidEntities[i];\r\n                    enemyMap.splice(index, 1);\r\n                }\r\n                \r\n                // Log changes if any were made\r\n                if (invalidEntities.length > 0) {\r\n                    console.log(`Fixed ${invalidEntities.length} inconsistencies in EntityManager 'enemy' tag map`);\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Error validating EntityManager tag maps:\", error);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Freeze all enemy entities in place\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    freezeAllEnemies(enemies) {\r\n        // Filter out pooled (inactive) enemies\r\n        const activeEnemies = Array.from(enemies).filter(enemyId => {\r\n            const enemy = this.world.getEntity(enemyId);\r\n            return enemy && !enemy.hasTag('pooled');\r\n        });\r\n        \r\n        console.log(`Freezing all ${activeEnemies.length} active enemies...`);\r\n        \r\n        // Iterate through all active enemies and stop their movement\r\n        for (const enemyId of activeEnemies) {\r\n            const enemy = this.world.getEntity(enemyId);\r\n            if (!enemy) {\r\n                // Skip if entity doesn't exist\r\n                console.warn(`Enemy ${enemyId} not found when freezing - may have been destroyed`);\r\n                continue;\r\n            }\r\n            \r\n            // Get the rigidbody component if it exists\r\n            const rigidbody = enemy.getComponent('RigidbodyComponent');\r\n            if (rigidbody) {\r\n                // Set velocity to zero\r\n                rigidbody.velocity.set(0, 0, 0);\r\n                \r\n                // Set angular velocity to zero if it exists\r\n                if (rigidbody.angularVelocity) {\r\n                    rigidbody.angularVelocity.set(0, 0, 0);\r\n                }\r\n                \r\n                // Mark as frozen\r\n                rigidbody.isFrozen = true;\r\n            }\r\n            \r\n            // Get the enemy AI component\r\n            const enemyAI = enemy.getComponent('EnemyAIComponent');\r\n            if (enemyAI) {\r\n                // Store original enabled state if not already stored\r\n                if (enemyAI.originalEnabledState === undefined) {\r\n                    enemyAI.originalEnabledState = enemyAI.enabled;\r\n                }\r\n                \r\n                // Disable the AI component\r\n                enemyAI.enabled = false;\r\n            }\r\n            \r\n            // Mark the entity as frozen for other systems to recognize\r\n            enemy.addTag('frozen');\r\n        }\r\n        \r\n        console.log(\"All enemies frozen successfully\");\r\n    }\r\n    \r\n    /**\r\n     * Unfreeze all enemy entities and re-enable their AI\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    unfreezeAllEnemies(enemies) {\r\n        // Filter out pooled (inactive) enemies\r\n        const activeEnemies = Array.from(enemies).filter(enemyId => {\r\n            const enemy = this.world.getEntity(enemyId);\r\n            return enemy && !enemy.hasTag('pooled');\r\n        });\r\n        \r\n        console.log(`Unfreezing all ${activeEnemies.length} active enemies...`);\r\n        \r\n        // Iterate through all active enemies and re-enable their AI\r\n        for (const enemyId of activeEnemies) {\r\n            const enemy = this.world.getEntity(enemyId);\r\n            if (!enemy) {\r\n                // Skip if entity doesn't exist\r\n                console.warn(`Enemy ${enemyId} not found when unfreezing - may have been destroyed`);\r\n                continue;\r\n            }\r\n            \r\n            // Get the rigidbody component if it exists\r\n            const rigidbody = enemy.getComponent('RigidbodyComponent');\r\n            if (rigidbody) {\r\n                // Un-mark as frozen\r\n                rigidbody.isFrozen = false;\r\n            }\r\n            \r\n            // Get the enemy AI component\r\n            const enemyAI = enemy.getComponent('EnemyAIComponent');\r\n            if (enemyAI) {\r\n                // Restore original enabled state or default to enabled\r\n                enemyAI.enabled = (enemyAI.originalEnabledState !== undefined) ? \r\n                    enemyAI.originalEnabledState : true;\r\n            }\r\n            \r\n            // Remove the frozen tag\r\n            if (enemy.hasTag && enemy.hasTag('frozen')) {\r\n                enemy.removeTag('frozen');\r\n            }\r\n        }\r\n        \r\n        console.log(\"All enemies unfrozen successfully\");\r\n    }\r\n    \r\n    /**\r\n     * Force destroy excess enemies to enforce the enemy limit\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     * @param {number} maxEnemies Maximum number of enemies allowed\r\n     * @param {Function} returnEnemyToPool Function to return an enemy to the pool\r\n     */\r\n    enforceEnemyLimit(enemies, maxEnemies, returnEnemyToPool) {\r\n        // Convert to array for easier manipulation\r\n        const enemyIds = [...enemies];\r\n        \r\n        // Calculate how many enemies to remove\r\n        const excessCount = enemies.size - maxEnemies;\r\n        if (excessCount <= 0) return;\r\n        \r\n        console.log(`Enforcing enemy limit by removing ${excessCount} excess enemies`);\r\n        \r\n        // Remove the oldest enemies first (at the start of the array)\r\n        for (let i = 0; i < excessCount && i < enemyIds.length; i++) {\r\n            const entityId = enemyIds[i];\r\n            const entity = this.world.getEntity(entityId);\r\n            \r\n            if (entity) {\r\n                console.log(`Force destroying excess enemy ${entityId}`);\r\n                \r\n                // Remove from tracking first\r\n                enemies.delete(entityId);\r\n                \r\n                // If entity has health component, mark as destroyed\r\n                const health = entity.getComponent('HealthComponent');\r\n                if (health) {\r\n                    health.health = 0;\r\n                    health.isDestroyed = true;\r\n                }\r\n                \r\n                // Create explosion effect\r\n                if (this.world && this.world.messageBus) {\r\n                    const transform = entity.getComponent('TransformComponent');\r\n                    if (transform) {\r\n                        this.world.messageBus.publish('vfx.explosion', {\r\n                            position: transform.position.clone(),\r\n                            scale: 1.0,\r\n                            duration: 1.0\r\n                        });\r\n                    }\r\n                }\r\n                \r\n                // Return to pool or destroy completely\r\n                returnEnemyToPool(entity);\r\n            } else {\r\n                // If entity doesn't exist, just remove from tracking\r\n                enemies.delete(entityId);\r\n            }\r\n        }\r\n        \r\n        // Validate references after cleanup\r\n        this.validateEnemyReferences(enemies);\r\n    }\r\n    \r\n    /**\r\n     * Clear all tracking Set\r\n     * @param {Set} enemies Reference to the active enemies set for tracking\r\n     */\r\n    clearAllEnemies(enemies) {\r\n        // Log the current count\r\n        console.log(`Clearing all enemies. Current count: ${enemies.size}`);\r\n        \r\n        // Clear the enemies Set\r\n        enemies.clear();\r\n        \r\n        // Verify\r\n        console.log(`After clearing, enemy count: ${enemies.size}`);\r\n    }\r\n    \r\n    /**\r\n     * Process a single enemy entity's update\r\n     * @param {Entity} entity Entity to process\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    processEntityUpdate(entity, deltaTime) {\r\n        // Get enemy AI component\r\n        const enemyAI = entity.getComponent('EnemyAIComponent');\r\n        \r\n        // Skip if entity is missing an enemy AI component\r\n        if (!enemyAI) return;\r\n        \r\n        // Get transform component\r\n        const transform = entity.getComponent('TransformComponent');\r\n        \r\n        // Skip if entity is missing a transform component\r\n        if (!transform) return;\r\n        \r\n        // Get mesh component\r\n        const meshComponent = entity.getComponent('MeshComponent');\r\n        \r\n        // Check if mesh component exists and has been added to scene\r\n        if (meshComponent && meshComponent.mesh) {\r\n            // Ensure mesh visibility\r\n            meshComponent.mesh.visible = true;\r\n            \r\n            // Check if mesh has been added to scene\r\n            if (!meshComponent.mesh.parent && this.world.scene) {\r\n                console.log(`Adding enemy mesh to scene`);\r\n                this.world.scene.add(meshComponent.mesh);\r\n                \r\n                // Call the onAddedToScene method if it exists\r\n                if (meshComponent.onAddedToScene) {\r\n                    meshComponent.onAddedToScene(this.world.scene);\r\n                }\r\n            }\r\n            \r\n            // Update mesh position to match entity transform\r\n            meshComponent.mesh.position.copy(transform.position);\r\n            meshComponent.mesh.quaternion.copy(transform.quaternion);\r\n            meshComponent.mesh.scale.copy(transform.scale);\r\n            \r\n            // Process special visual effects if this is an enhanced enemy\r\n            if (entity.visualVariant === 2 || entity.visualVariant === 3) {\r\n                // Update any special effects attached to the model\r\n                meshComponent.mesh.traverse((child) => {\r\n                    if (child.userData && typeof child.userData.update === 'function') {\r\n                        child.userData.update(deltaTime);\r\n                    }\r\n                });\r\n                \r\n                // Add additional visual effects for elite enemies (variant 2)\r\n                if (entity.visualVariant === 2 && entity.eliteParticleTime === undefined) {\r\n                    // Occasionally emit a small particle effect for elites\r\n                    entity.eliteParticleTime = 0;\r\n                } else if (entity.visualVariant === 2) {\r\n                    // Update elite particle timer\r\n                    entity.eliteParticleTime += deltaTime;\r\n                    \r\n                    // Every 1.5 seconds, emit a particle\r\n                    if (entity.eliteParticleTime > 1.5) {\r\n                        entity.eliteParticleTime = 0;\r\n                        \r\n                        // Emit a particle effect using the global VFX system if available\r\n                        if (this.world && this.world.messageBus) {\r\n                            this.world.messageBus.publish('vfx.pulse', {\r\n                                position: transform.position.clone(),\r\n                                color: 0xaaffff,\r\n                                scale: 0.7,\r\n                                duration: 0.8\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Special flickering effect for damaged enemies (variant 1)\r\n            if (entity.visualVariant === 1 && meshComponent.mesh.material) {\r\n                // Apply a flickering effect to the material\r\n                if (Array.isArray(meshComponent.mesh.material)) {\r\n                    for (const material of meshComponent.mesh.material) {\r\n                        material.emissiveIntensity = 0.5 + (Math.sin(Date.now() * 0.01) * 0.3);\r\n                    }\r\n                } else if (meshComponent.mesh.material.emissiveIntensity !== undefined) {\r\n                    meshComponent.mesh.material.emissiveIntensity = 0.5 + (Math.sin(Date.now() * 0.01) * 0.3);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Call the component's update method\r\n        enemyAI.update(deltaTime);\r\n        \r\n        // Get health component to update shield regeneration\r\n        const health = entity.getComponent('HealthComponent');\r\n        if (health) {\r\n            health.update(deltaTime);\r\n        }\r\n    }\r\n} ","/**\r\n * EnemySystem - Manages enemy entities and their AI behavior\r\n * \r\n * Handles enemy spawning, AI updates, and combat interactions.\r\n * This is a simplified version that only implements spectral drones.\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { System } from '../../core/system.js';\r\nimport { TransformComponent } from '../../components/transform.js';\r\nimport { EnemyAIComponent } from '../../components/combat/enemyAI.js';\r\nimport { HealthComponent } from '../../components/combat/healthComponent.js';\r\nimport { MeshComponent } from '../../components/rendering/mesh.js';\r\nimport { RigidbodyComponent } from '../../components/physics/rigidbody.js';\r\nimport { TrailComponent } from '../../components/rendering/trail.js';\r\n\r\n// Import the new modularized components\r\nimport { EnemyPoolManager } from './enemyPoolManager.js';\r\nimport { EnemySpawner } from './enemySpawner.js';\r\nimport { EnemyLifecycle } from './enemyLifecycle.js';\r\n\r\nexport class EnemySystem extends System {\r\n    constructor(world) {\r\n        super(world);\r\n        this.requiredComponents = ['EnemyAIComponent', 'TransformComponent'];\r\n        this.priority = 40; // Run before combat but after input and physics\r\n        \r\n        // Initialize enemies set\r\n        this.enemies = new Set();\r\n        \r\n        // Default enemy spawn parameters (will be modified by difficulty scaling)\r\n        this.maxEnemies = 10;           // Allow more enemies to spawn\r\n        this.spawnTimer = 0;           // Timer since last spawn\r\n        this.spawnInterval = 3;        // Seconds between spawns (reduced from 10)\r\n        this.lastSpawnTime = Date.now(); // Track the last successful spawn time\r\n        \r\n        // Add initial spawn delay of 5 seconds for easier testing\r\n        this.initialSpawnDelay = 5;  // Initial delay in seconds before enemies spawn\r\n        this.initialSpawnTimer = 0;   // Timer to track the initial delay\r\n        this.initialSpawnComplete = false; // Flag to track if initial spawn delay has completed\r\n        \r\n        // Initialize the managers for different aspects of enemy handling\r\n        this.poolManager = new EnemyPoolManager(world);\r\n        this.spawner = new EnemySpawner(world);\r\n        this.lifecycle = new EnemyLifecycle(world);\r\n        \r\n        // Track player docked status\r\n        this.playerIsDocked = false;\r\n        \r\n        // Destroyed enemies counter\r\n        this.enemiesDestroyed = 0;\r\n        \r\n        // Set up recovery timer for spawn system problems\r\n        this.lastSpawnCheckTime = Date.now();\r\n        this.spawnCheckInterval = 10000; // 10 seconds\r\n        \r\n        // Separation behavior parameters\r\n        this.SEPARATION_FORCE_MAGNITUDE = 150; // Tune this value for proper separation strength\r\n        this.separationThresholdMultiplier = 2.5; // Multiple of collision radius\r\n        \r\n        // Spatial grid for efficient neighbor lookups\r\n        this.spatialGrid = {\r\n            cellSize: 200, // Adjust based on typical enemy size and movement speed\r\n            cells: new Map()\r\n        };\r\n        \r\n        // Set up event listeners\r\n        this.setupEventListeners();\r\n        \r\n        // Initialize with a clean enemy count\r\n        this.lifecycle.clearAllEnemies(this.enemies);\r\n        \r\n        // Force validation to ensure we start with empty tracking\r\n        this.lifecycle.validateEnemyReferences(this.enemies);\r\n        \r\n        // Start continuous monitoring for spawn health\r\n        this.startSpawnMonitoring();\r\n        \r\n        console.log(\"Enemy system initialized with faster spawn rate and object pooling\");\r\n    }\r\n    \r\n    /**\r\n     * Set up event listeners for enemy-related events\r\n     */\r\n    setupEventListeners() {\r\n        // Listen for entity.destroyed events to track destroyed enemies\r\n        this.world.messageBus.subscribe('entity.destroyed', this.handleEntityDestroyed.bind(this));\r\n        \r\n        // Listen for player docking/undocking events\r\n        // Make sure we properly bind 'this' to the handlers to maintain context\r\n        this.world.messageBus.subscribe('player.docked', this.handlePlayerDocked.bind(this));\r\n        this.world.messageBus.subscribe('player.undocked', this.handlePlayerUndocked.bind(this));\r\n        \r\n        // Log that we've set up the event listeners\r\n        console.log(\"Enemy system: Event listeners set up for player docking/undocking\");\r\n    }\r\n    \r\n    /**\r\n     * Handle player docked event\r\n     * @param {object} message Event message\r\n     */\r\n    handlePlayerDocked(message) {\r\n        console.log(\"Enemy system detected player docked - freezing enemies\");\r\n        \r\n        // Set the docked state first\r\n        this.playerIsDocked = true;\r\n        \r\n        // Then freeze all enemies\r\n        this.lifecycle.freezeAllEnemies(this.enemies);\r\n        \r\n        // Additional logging for debug purposes\r\n        console.log(`Froze ${this.enemies.size} enemies due to player docking`);\r\n    }\r\n    \r\n    /**\r\n     * Handle player undocked event\r\n     * @param {object} message Event message\r\n     */\r\n    handlePlayerUndocked(message) {\r\n        console.log(\"Enemy system detected player undocked - resuming enemy activities\");\r\n        \r\n        // Set the docked state first\r\n        this.playerIsDocked = false;\r\n        \r\n        // Then unfreeze all enemies\r\n        this.lifecycle.unfreezeAllEnemies(this.enemies);\r\n        \r\n        // Additional logging for debug purposes\r\n        console.log(`Unfroze ${this.enemies.size} enemies due to player undocking`);\r\n    }\r\n    \r\n    /**\r\n     * Update all enemy entities\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // First check if there's a global docked state from the game object\r\n        // This ensures we capture docking state from other sources\r\n        if (window.game && window.game.spaceship && window.game.spaceship.isDocked !== undefined) {\r\n            // If global docking state has changed, update our internal state\r\n            if (this.playerIsDocked !== window.game.spaceship.isDocked) {\r\n                console.log(`Enemy system syncing docked state from global: ${window.game.spaceship.isDocked}`);\r\n                this.playerIsDocked = window.game.spaceship.isDocked;\r\n                \r\n                // Apply the appropriate freeze/unfreeze based on the new state\r\n                if (this.playerIsDocked) {\r\n                    this.lifecycle.freezeAllEnemies(this.enemies);\r\n                } else {\r\n                    this.lifecycle.unfreezeAllEnemies(this.enemies);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Skip normal processing if player is docked\r\n        if (this.playerIsDocked) {\r\n            // Don't call super.update() which would run processEntity on all entities\r\n            // We just want to maintain the frozen state\r\n            return;\r\n        }\r\n        \r\n        // Process all enemy entities\r\n        super.update(deltaTime);\r\n        \r\n        // Run diagnostics more frequently (every 3 seconds instead of 10)\r\n        if (!this._lastDiagnosticTime) {\r\n            this._lastDiagnosticTime = 0;\r\n        }\r\n        this._lastDiagnosticTime += deltaTime;\r\n        \r\n        if (this._lastDiagnosticTime >= 3) {\r\n            this.poolManager.runPoolDiagnostics(this.enemies);\r\n            this._lastDiagnosticTime = 0;\r\n        }\r\n        \r\n        // Validate enemy references before spawn decision to ensure accurate count\r\n        this.lifecycle.validateEnemyReferences(this.enemies);\r\n        \r\n        // Apply difficulty scaling from game object if available\r\n        this.updateDifficultyScaling();\r\n        \r\n        // STRICT ENFORCEMENT: If we're over the limit, force destroy excess enemies\r\n        if (this.enemies.size > this.maxEnemies) {\r\n            console.warn(`ENFORCING ENEMY LIMIT: Current count ${this.enemies.size} exceeds limit of ${this.maxEnemies}`);\r\n            this.lifecycle.enforceEnemyLimit(this.enemies, this.maxEnemies, \r\n                (entity) => this.poolManager.returnEnemyToPool(entity, this.enemies));\r\n        }\r\n        \r\n        // Check if we need to handle the initial spawn delay\r\n        if (!this.initialSpawnComplete) {\r\n            this.initialSpawnTimer += deltaTime;\r\n            \r\n            // Log progress toward initial spawn every 10 seconds\r\n            if (Math.floor(this.initialSpawnTimer) % 10 === 0 && Math.floor(this.initialSpawnTimer) > 0) {\r\n                const remainingTime = Math.ceil(this.initialSpawnDelay - this.initialSpawnTimer);\r\n                console.log(`Initial spawn delay: ${remainingTime} seconds remaining`);\r\n            }\r\n            \r\n            // Check if initial spawn delay is complete\r\n            if (this.initialSpawnTimer >= this.initialSpawnDelay) {\r\n                this.initialSpawnComplete = true;\r\n                console.log(`Initial spawn delay complete. Spectral drones beginning to spawn.`);\r\n                \r\n                // Show notification that spectral drones have been spotted (single notification)\r\n                if (window.game && window.game.ui && window.game.ui.showNotification) {\r\n                    window.game.ui.showNotification('WARNING: Spectral drones have been spotted in the sector!', 5000);\r\n                } else if (window.mainMessageBus) {\r\n                    window.mainMessageBus.publish('ui.notification', {\r\n                        message: 'WARNING: Spectral drones have been spotted in the sector!',\r\n                        duration: 5000\r\n                    });\r\n                }\r\n            } else {\r\n                // Skip spawning while in initial delay\r\n                return;\r\n            }\r\n        }\r\n        \r\n        // Debug logging - show current enemy count and spawn timer\r\n        if (this.spawnTimer > this.spawnInterval * 0.9 || this.enemies.size === 0) {\r\n            console.log(`Spawn status: ${this.enemies.size}/${this.maxEnemies} enemies, timer: ${this.spawnTimer.toFixed(1)}/${this.spawnInterval} seconds`);\r\n        }\r\n        \r\n        // Update spawn timer and try to spawn new enemies\r\n        this.spawner.update(deltaTime, this.enemies, this.maxEnemies, (spawnPoint) => {\r\n            return this.spawnSpectralDrone(spawnPoint);\r\n        });\r\n        \r\n        // FAILSAFE: If we have no enemies and it's been a while since spawning,\r\n        // reset the enemy count and regenerate spawn points\r\n        if (this.enemies.size === 0 && this.spawnTimer > this.spawnInterval * 2) {\r\n            console.warn(\"FAILSAFE: No enemies detected for extended period. Resetting spawn system.\");\r\n            this.enemies.clear();\r\n            this.spawner.generateSpawnPoints();\r\n            this.spawnTimer = this.spawnInterval; // Force a spawn next frame\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update enemy parameters based on difficulty scaling from game object\r\n     */\r\n    updateDifficultyScaling() {\r\n        // Check for horde mode first - it overrides normal difficulty scaling\r\n        if (window.game && window.game.isHordeActive) {\r\n            this.applyHordeModeScaling();\r\n            return; // Skip normal difficulty scaling\r\n        }\r\n        \r\n        // Default difficulty scaling\r\n        if (window.game && window.game.difficultyManager && window.game.difficultyManager.params) {\r\n            const diffParams = window.game.difficultyManager.params;\r\n            \r\n            // Update our parameters if they exist in the difficulty manager\r\n            if (diffParams.maxEnemies !== undefined && this.maxEnemies !== diffParams.maxEnemies) {\r\n                console.log(`Updating max enemies from ${this.maxEnemies} to ${diffParams.maxEnemies}`);\r\n                this.maxEnemies = diffParams.maxEnemies;\r\n            }\r\n            \r\n            if (diffParams.spawnInterval !== undefined && this.spawnInterval !== diffParams.spawnInterval) {\r\n                console.log(`Updating spawn interval from ${this.spawnInterval} to ${diffParams.spawnInterval}`);\r\n                this.spawnInterval = diffParams.spawnInterval;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Apply horde mode scaling based on survival time\r\n     * Dramatically increases difficulty over time to infinity\r\n     */\r\n    applyHordeModeScaling() {\r\n        if (!window.game || window.game.hordeSurvivalTime === undefined) return;\r\n        \r\n        // Get survival time in seconds\r\n        const survivalTime = window.game.hordeSurvivalTime / 1000;\r\n        \r\n        // Log scaling every 10 seconds\r\n        if (Math.floor(survivalTime) % 10 === 0 && Math.floor(survivalTime) !== this.lastLoggedHordeTime) {\r\n            this.lastLoggedHordeTime = Math.floor(survivalTime);\r\n            console.log(`HORDE MODE: Scaling at ${survivalTime.toFixed(1)}s survival time`);\r\n        }\r\n        \r\n        // Calculate scaling factors based on survival time\r\n        const minutesPassed = survivalTime / 60;\r\n        \r\n        // 1. Max enemies: Start at 50, add 10 per minute, exponential scaling after 5 minutes\r\n        const baseMaxEnemies = 50;\r\n        let maxEnemiesScale;\r\n        \r\n        if (minutesPassed < 5) {\r\n            // Linear scaling for first 5 minutes\r\n            maxEnemiesScale = baseMaxEnemies + (minutesPassed * 10);\r\n        } else {\r\n            // Exponential scaling after 5 minutes: 100 * (1.2^(minutes-5))\r\n            maxEnemiesScale = (baseMaxEnemies + 50) * Math.pow(1.2, minutesPassed - 5);\r\n        }\r\n        \r\n        // Cap at a reasonable maximum to prevent performance issues\r\n        this.maxEnemies = Math.min(Math.floor(maxEnemiesScale), 300);\r\n        \r\n        // 2. Spawn interval: Start at 1s, increase over time (spawn 2x slower)\r\n        const maxSpawnInterval = 6.0;  // Maximum spawn interval\r\n        const baseSpawnInterval = 1.0;\r\n        this.spawnInterval = Math.min(\r\n            baseSpawnInterval * Math.pow(1.05, minutesPassed * 2),  // Increase interval (slower spawning)\r\n            maxSpawnInterval\r\n        );\r\n        \r\n        // 3. Update enemy config in spawner if available\r\n        if (this.spawner) {\r\n            // Base values\r\n            const baseHealth = 20;\r\n            const baseDamage = 15;\r\n            const baseSpeed = 700;\r\n            \r\n            // Calculate scaling multipliers\r\n            const healthMultiplier = 1 + (minutesPassed * 0.5); // +50% per minute\r\n            const damageMultiplier = 1 + (minutesPassed * 0.3); // +30% per minute\r\n            const speedMultiplier = 1 + (minutesPassed * 0.2); // +20% per minute\r\n            \r\n            // Apply multipliers\r\n            this.spawner.enemyConfig.health = Math.floor(baseHealth * healthMultiplier);\r\n            this.spawner.enemyConfig.damage = Math.floor(baseDamage * damageMultiplier);\r\n            this.spawner.enemyConfig.speed = baseSpeed * speedMultiplier;\r\n            \r\n            // Log scaling on 30-second intervals for debugging\r\n            if (Math.floor(survivalTime) % 30 === 0 && Math.floor(survivalTime) !== this.lastFullLoggedHordeTime) {\r\n                this.lastFullLoggedHordeTime = Math.floor(survivalTime);\r\n                console.log(`HORDE MODE SCALING at ${Math.floor(survivalTime)}s:`);\r\n                console.log(`  Max Enemies: ${this.maxEnemies}`);\r\n                console.log(`  Spawn Interval: ${this.spawnInterval.toFixed(2)}s`);\r\n                console.log(`  Enemy Health: ${this.spawner.enemyConfig.health}`);\r\n                console.log(`  Enemy Damage: ${this.spawner.enemyConfig.damage}`);\r\n                console.log(`  Enemy Speed: ${this.spawner.enemyConfig.speed.toFixed(1)}`);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Process a single enemy entity\r\n     * @param {Entity} entity Entity to process\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    processEntity(entity, deltaTime) {\r\n        // Call the existing lifecycle processing\r\n        this.lifecycle.processEntityUpdate(entity, deltaTime);\r\n        \r\n        // Apply separation behavior to avoid overlapping with other enemies\r\n        this.applySeparationBehavior(entity, deltaTime);\r\n    }\r\n    \r\n    /**\r\n     * Apply separation behavior to avoid overlapping with other enemies\r\n     * @param {Entity} entity The entity to apply separation to\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    applySeparationBehavior(entity, deltaTime) {\r\n        // Get required components\r\n        const transform = entity.getComponent('TransformComponent');\r\n        const rigidbody = entity.getComponent('RigidbodyComponent');\r\n        const enemyAI = entity.getComponent('EnemyAIComponent');\r\n        \r\n        // Skip if missing required components\r\n        if (!transform || !rigidbody || !enemyAI) {\r\n            return;\r\n        }\r\n        \r\n        // Skip if entity is frozen\r\n        if (rigidbody.isFrozen) {\r\n            return;\r\n        }\r\n        \r\n        // Calculate separation force\r\n        const separationForce = this.calculateSeparationForce(entity, transform, rigidbody);\r\n        \r\n        // Apply the separation force if significant\r\n        if (separationForce.lengthSq() > 0.01) {\r\n            // Pass separation force to the AI component for more natural behavior\r\n            enemyAI.setSeparationForce(separationForce);\r\n            \r\n            // Also apply directly to the rigidbody for immediate response\r\n            rigidbody.applyForce(separationForce);\r\n        } else {\r\n            // Clear separation force if no significant force is calculated\r\n            enemyAI.setSeparationForce(new THREE.Vector3());\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Calculate separation force to avoid nearby enemies\r\n     * @param {Entity} entity The current entity\r\n     * @param {TransformComponent} transform The entity's transform\r\n     * @param {RigidbodyComponent} rigidbody The entity's rigidbody\r\n     * @returns {THREE.Vector3} The calculated separation force\r\n     */\r\n    calculateSeparationForce(entity, transform, rigidbody) {\r\n        // Initialize separation force vector\r\n        const separationForce = new THREE.Vector3();\r\n        \r\n        // Define separation threshold based on collision radius\r\n        const separationThreshold = rigidbody.collisionRadius * this.separationThresholdMultiplier;\r\n        \r\n        // Find nearby enemy entities\r\n        const nearbyEnemies = this.findNearbyEnemies(entity, transform.position, separationThreshold);\r\n        \r\n        // Process each nearby enemy\r\n        for (const neighborId of nearbyEnemies) {\r\n            // Skip self\r\n            if (neighborId === entity.id) continue;\r\n            \r\n            // Get neighbor entity\r\n            const neighbor = this.world.getEntity(neighborId);\r\n            if (!neighbor) continue;\r\n            \r\n            // Get neighbor transform\r\n            const neighborTransform = neighbor.getComponent('TransformComponent');\r\n            if (!neighborTransform) continue;\r\n            \r\n            // Calculate vector away from neighbor\r\n            const awayVector = transform.position.clone().sub(neighborTransform.position);\r\n            \r\n            // Get distance to neighbor\r\n            const distance = awayVector.length();\r\n            \r\n            // Skip if too far or zero distance\r\n            if (distance >= separationThreshold || distance === 0) continue;\r\n            \r\n            // Calculate repulsion strength (stronger when closer)\r\n            let strength = (separationThreshold - distance) / separationThreshold;\r\n            \r\n            // Normalize away vector\r\n            awayVector.normalize();\r\n            \r\n            // Scale by strength and add to separation force\r\n            separationForce.add(awayVector.multiplyScalar(strength * this.SEPARATION_FORCE_MAGNITUDE));\r\n        }\r\n        \r\n        return separationForce;\r\n    }\r\n    \r\n    /**\r\n     * Find nearby enemy entities within a certain radius\r\n     * @param {Entity} entity The entity to find neighbors for\r\n     * @param {THREE.Vector3} position The position to check from\r\n     * @param {number} radius The radius to check within\r\n     * @returns {Set} Set of nearby enemy entity IDs\r\n     */\r\n    findNearbyEnemies(entity, position, radius) {\r\n        // Simple method: check all active enemies\r\n        // This could be optimized with a spatial grid for better performance\r\n        const nearbyEnemies = new Set();\r\n        \r\n        // Convert enemies set to array of entity objects for position checking\r\n        for (const enemyId of this.enemies) {\r\n            // Skip self\r\n            if (enemyId === entity.id) continue;\r\n            \r\n            // Skip if entity doesn't exist\r\n            const enemyEntity = this.world.getEntity(enemyId);\r\n            if (!enemyEntity) continue;\r\n            \r\n            // Skip if entity is pooled\r\n            if (enemyEntity.hasTag('pooled')) continue;\r\n            \r\n            // Get transform component\r\n            const enemyTransform = enemyEntity.getComponent('TransformComponent');\r\n            if (!enemyTransform) continue;\r\n            \r\n            // Calculate distance\r\n            const distance = position.distanceTo(enemyTransform.position);\r\n            \r\n            // Add to nearby set if within radius\r\n            if (distance < radius) {\r\n                nearbyEnemies.add(enemyId);\r\n            }\r\n        }\r\n        \r\n        return nearbyEnemies;\r\n    }\r\n    \r\n    /**\r\n     * Handle entity destroyed event\r\n     * @param {object} message Event message\r\n     */\r\n    handleEntityDestroyed(message) {\r\n        // Check if the destroyed entity is one of our enemies\r\n        const entity = message.entity;\r\n        if (!entity) {\r\n            console.warn(\"Entity destroyed event received but no entity in message!\");\r\n            return;\r\n        }\r\n        \r\n        // IMPROVED CHECK: Retrieve entity ID first to ensure consistent reference\r\n        const entityId = entity.id;\r\n        \r\n        // VERIFICATION: Check if this is an entity we're tracking\r\n        const isTrackedEnemy = this.enemies.has(entityId);\r\n        \r\n        // IMPROVED CHECK: Look for either entity.hasTag('enemy') OR entity.id in this.enemies\r\n        // This ensures we catch all cases where an enemy is destroyed\r\n        if ((entity.hasTag && entity.hasTag('enemy')) || isTrackedEnemy) {\r\n            console.log(`Enemy destroyed: ${entityId}`);\r\n            \r\n            // FIRST: Remove from tracking immediately to prevent double-processing\r\n            if (isTrackedEnemy) {\r\n                this.enemies.delete(entityId);\r\n                console.log(`Removed entity ${entityId} from enemies tracking`);\r\n            }\r\n            \r\n            // TRAIL CLEANUP: Ensure any trails are properly removed\r\n            // This prevents the \"line to center\" visual bug\r\n            const trailComponent = entity.getComponent('TrailComponent');\r\n            if (trailComponent) {\r\n                try {\r\n                    // Call onDetached to clean up resources\r\n                    if (typeof trailComponent.onDetached === 'function') {\r\n                        trailComponent.onDetached();\r\n                    }\r\n                    \r\n                    // Unregister from trail system if available\r\n                    if (window.game && window.game.trailSystem) {\r\n                        window.game.trailSystem.unregisterTrail && \r\n                        window.game.trailSystem.unregisterTrail(entityId);\r\n                    }\r\n                    \r\n                    // If the trail has a mesh, remove it from the scene\r\n                    if (trailComponent.trailMesh && trailComponent.trailMesh.parent) {\r\n                        trailComponent.trailMesh.parent.remove(trailComponent.trailMesh);\r\n                    }\r\n                    \r\n                    // Dispose of geometry and material\r\n                    if (trailComponent.trailMesh) {\r\n                        if (trailComponent.trailMesh.geometry) {\r\n                            trailComponent.trailMesh.geometry.dispose();\r\n                        }\r\n                        if (trailComponent.trailMesh.material) {\r\n                            trailComponent.trailMesh.material.dispose();\r\n                        }\r\n                    }\r\n                    \r\n                    // Remove the component from the entity\r\n                    entity.removeComponent('TrailComponent');\r\n                    console.log(`Cleaned up trail component for destroyed enemy ${entityId}`);\r\n                } catch (error) {\r\n                    console.error(`Error cleaning up trail for entity ${entityId}:`, error);\r\n                }\r\n            }\r\n            \r\n            // Clean up mesh resources before returning to pool\r\n            const meshComponent = entity.getComponent('MeshComponent');\r\n            if (meshComponent && meshComponent.mesh) {\r\n                try {\r\n                    // Remove from scene if it has a parent\r\n                    if (meshComponent.mesh.parent) {\r\n                        meshComponent.mesh.parent.remove(meshComponent.mesh);\r\n                    }\r\n                } catch (error) {\r\n                    console.error(`Error cleaning up mesh for entity ${entityId}:`, error);\r\n                }\r\n            }\r\n            \r\n            // Increment destroyed counter\r\n            this.enemiesDestroyed++;\r\n            \r\n            // Log remaining enemies\r\n            console.log(`Enemy ${entityId} destroyed. Enemies remaining: ${this.enemies.size}/${this.maxEnemies}`);\r\n            \r\n            // ENSURE PROPER CLEANUP: Make sure entity doesn't have enemy tag\r\n            if (entity.hasTag && entity.hasTag('enemy')) {\r\n                console.log(`Explicitly removing 'enemy' tag from destroyed entity ${entityId}`);\r\n                entity.removeTag('enemy');\r\n            }\r\n            \r\n            // Check if this entity is incorrectly in the pool already\r\n            let isInPool = false;\r\n            for (let i = 0; i < this.poolManager.enemyPool.length; i++) {\r\n                if (this.poolManager.enemyPool[i] && this.poolManager.enemyPool[i].id === entityId) {\r\n                    console.warn(`CRITICAL ERROR: Destroyed entity ${entityId} is already in the pool!`);\r\n                    this.poolManager.enemyPool.splice(i, 1);\r\n                    console.log(`Removed entity ${entityId} from pool to prevent double-pooling`);\r\n                    isInPool = true;\r\n                    break;\r\n                }\r\n            }\r\n            \r\n            // Only return to pool if not already there\r\n            if (!isInPool) {\r\n                // Return the entity to the pool\r\n                this.poolManager.returnEnemyToPool(entity, this.enemies);\r\n                console.log(`Returned enemy ${entityId} to pool`);\r\n            }\r\n            \r\n            // Force spawn point regeneration after several enemies have been destroyed\r\n            if (this.enemiesDestroyed % 5 === 0) {\r\n                console.log(\"Regenerating spawn points after multiple enemy destructions\");\r\n                this.spawner.generateSpawnPoints();\r\n            }\r\n            \r\n            // CRITICAL: If this was the last enemy, make sure to reset the spawn timer\r\n            // to avoid long waits for the next enemy\r\n            if (this.enemies.size === 0) {\r\n                console.log(\"All enemies destroyed - accelerating next spawn\");\r\n                // Set the timer to be almost at the spawn interval\r\n                this.spawnTimer = Math.max(this.spawnTimer, this.spawnInterval * 0.8);\r\n            }\r\n            \r\n            // Force validation to catch any remaining inconsistencies\r\n            this.lifecycle.validateEnemyReferences(this.enemies);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Called when the system is disabled\r\n     */\r\n    onDisabled() {\r\n        // Clear monitoring interval\r\n        if (this.spawnMonitorInterval) {\r\n            clearInterval(this.spawnMonitorInterval);\r\n            this.spawnMonitorInterval = null;\r\n            console.log(\"Spawn monitoring stopped\");\r\n        }\r\n        \r\n        // Clean up any tracked enemies\r\n        this.enemies.clear();\r\n        \r\n        console.log(\"Enemy system disabled\");\r\n    }\r\n    \r\n    /**\r\n     * Start monitoring the spawn system health\r\n     */\r\n    startSpawnMonitoring() {\r\n        // Set up an interval to check spawn system health\r\n        this.spawnMonitorInterval = setInterval(() => {\r\n            this.checkSpawnSystemHealth();\r\n        }, 10000); // Check every 10 seconds\r\n        \r\n        console.log(\"Spawn system monitoring started\");\r\n    }\r\n     \r\n    /**\r\n     * Check the health of the spawn system\r\n     */\r\n    checkSpawnSystemHealth() {\r\n        const now = Date.now();\r\n        const timeSinceLastSpawn = (now - this.lastSpawnTime) / 1000; // in seconds\r\n        \r\n        console.log(`Spawn system health check: ${this.enemies.size}/${this.maxEnemies} enemies, ${timeSinceLastSpawn.toFixed(1)}s since last spawn`);\r\n        \r\n        // If no spawns have happened in a while and we're below max enemies, something might be wrong\r\n        if (timeSinceLastSpawn > this.spawnInterval * 3 && this.enemies.size < this.maxEnemies) {\r\n            console.warn(\"Spawn system appears stuck! Performing recovery...\");\r\n            \r\n            // Recover the spawn system\r\n            this.enemies.clear(); // Reset tracked enemies\r\n            this.spawner.generateSpawnPoints(); // Regenerate spawn points\r\n            this.spawnTimer = this.spawnInterval; // Force spawn soon\r\n            \r\n            // Validate enemy references\r\n            this.lifecycle.validateEnemyReferences(this.enemies);\r\n            \r\n            console.log(\"Spawn system recovery completed\");\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Spawns a spectral drone at the given position - convenience method\r\n     * @param {THREE.Vector3} position The position to spawn at\r\n     * @returns {Entity} The created entity\r\n     */\r\n    spawnSpectralDrone(position) {\r\n        return this.spawner.spawnSpectralDrone(position, this.poolManager, this.enemies, this.maxEnemies);\r\n    }\r\n    \r\n    /**\r\n     * Freeze all enemy entities in place - wrapper for lifecycle method\r\n     */\r\n    freezeAllEnemies() {\r\n        this.lifecycle.freezeAllEnemies(this.enemies);\r\n    }\r\n    \r\n    /**\r\n     * Unfreeze all enemy entities and re-enable their AI - wrapper for lifecycle method\r\n     */\r\n    unfreezeAllEnemies() {\r\n        this.lifecycle.unfreezeAllEnemies(this.enemies);\r\n    }\r\n}","/**\r\n * RenderSystem - Manages visual representation of entities\r\n * \r\n * Syncs entity transforms with Three.js meshes and handles rendering.\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { System } from '../../core/system.js';\r\n\r\nexport class RenderSystem extends System {\r\n    constructor(world, scene, camera, renderer) {\r\n        super(world);\r\n        this.requiredComponents = ['TransformComponent', 'MeshComponent'];\r\n        this.priority = 100; // Run at the end of the update cycle\r\n        \r\n        // Three.js references\r\n        this.scene = scene;\r\n        this.camera = camera;\r\n        // Don't store renderer reference to avoid issues\r\n        this.renderer = null;\r\n        \r\n        // Track meshes for frustum culling\r\n        this.meshEntities = new Map();\r\n        \r\n        // Frustum for view culling\r\n        this.frustum = new THREE.Frustum();\r\n        this.projScreenMatrix = new THREE.Matrix4();\r\n        \r\n        // Listen for entity events\r\n        this.world.messageBus.subscribe('entity.created', this.onEntityCreated.bind(this));\r\n        this.world.messageBus.subscribe('entity.destroyed', this.onEntityDestroyed.bind(this));\r\n        \r\n        // Also listen for component.added events directly to catch component additions\r\n        this.world.messageBus.subscribe('component.added', this.onComponentAdded.bind(this));\r\n        \r\n        console.log(\"RenderSystem initialized - handling mesh updates only, no rendering\");\r\n    }\r\n    \r\n    /**\r\n     * Handle component added event\r\n     * @param {object} message Event message\r\n     */\r\n    onComponentAdded(message) {\r\n        const entity = message.data.entity;\r\n        const componentType = message.data.componentType;\r\n        \r\n        // Only interested if one of our required components was added\r\n        if (componentType !== 'MeshComponent' && componentType !== 'TransformComponent') {\r\n            return;\r\n        }\r\n        \r\n        // Check if we're already tracking this entity\r\n        if (this.meshEntities.has(entity.id)) {\r\n            return;\r\n        }\r\n        \r\n        console.log(`RenderSystem: Component ${componentType} added to entity ${entity.id}`);\r\n        \r\n        // Check if entity now has all required components\r\n        if (entity.getComponent('TransformComponent') && entity.getComponent('MeshComponent')) {\r\n            console.log(`Entity ${entity.id} now has all required components, adding to scene`);\r\n            this.addEntityToScene(entity);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Initialize the rendering system\r\n     */\r\n    initialize() {\r\n        // Verify the system has scene and camera references\r\n        if (!this.scene || !this.camera) {\r\n            console.error('RenderSystem missing required Three.js scene or camera references');\r\n            return;\r\n        }\r\n        \r\n        // Process any entities that already exist\r\n        const entities = this.world.getEntitiesWithComponents(['TransformComponent', 'MeshComponent']);\r\n        entities.forEach(entity => {\r\n            this.addEntityToScene(entity);\r\n        });\r\n    }\r\n    \r\n    /**\r\n     * Handle entity created event\r\n     * @param {object} message Event message\r\n     */\r\n    onEntityCreated(message) {\r\n        const entity = message.data.entity;\r\n        \r\n        // Log entity creation for debugging\r\n        console.log(`RenderSystem received entity.created event for entity ${entity.id}`);\r\n        \r\n        // List all components for debugging\r\n        console.log(`Entity ${entity.id} components:`, Array.from(entity.components.keys()).join(', '));\r\n        \r\n        // Check if entity has required components using getComponent for better debugging\r\n        const transform = entity.getComponent('TransformComponent');\r\n        const mesh = entity.getComponent('MeshComponent');\r\n        \r\n        if (transform && mesh) {\r\n            console.log(`Entity ${entity.id} has required components, adding to scene`);\r\n            this.addEntityToScene(entity);\r\n        } else {\r\n            // Check if the entity might get components later\r\n            console.log(`Entity ${entity.id} missing required components (has transform: ${!!transform}, has mesh: ${!!mesh}), will check later`);\r\n            \r\n            // Set up a one-time component added listener\r\n            const checkComponentsAdded = (msg) => {\r\n                // Only process if it's about our entity\r\n                if (msg.data.entity?.id !== entity.id) return;\r\n                \r\n                // Log the added component\r\n                console.log(`Entity ${entity.id} got component ${msg.data.componentType}`);\r\n                \r\n                // Check if now it has the required components\r\n                const transform = entity.getComponent('TransformComponent');\r\n                const mesh = entity.getComponent('MeshComponent');\r\n                \r\n                if (transform && mesh) {\r\n                    console.log(`Entity ${entity.id} now has required components, adding to scene`);\r\n                    this.addEntityToScene(entity);\r\n                    \r\n                    // Remove this listener after processing\r\n                    this.world.messageBus.unsubscribe('component.added', checkComponentsAdded);\r\n                }\r\n            };\r\n            \r\n            // Subscribe to component added events\r\n            this.world.messageBus.subscribe('component.added', checkComponentsAdded);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle entity destroyed event\r\n     * @param {object} message Event message\r\n     */\r\n    onEntityDestroyed(message) {\r\n        const entity = message.data.entity;\r\n        \r\n        // Check if we're tracking this entity\r\n        if (this.meshEntities.has(entity.id)) {\r\n            this.removeEntityFromScene(entity);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Add entity mesh to scene\r\n     * @param {Entity} entity Entity to add\r\n     */\r\n    addEntityToScene(entity) {\r\n        const meshComponent = entity.getComponent('MeshComponent');\r\n        \r\n        // Debug output all component keys\r\n        console.log(`Entity ${entity.id} components for scene addition:`, Array.from(entity.components.keys()).join(', '));\r\n        \r\n        // Skip if mesh component is missing\r\n        if (!meshComponent || !meshComponent.mesh) {\r\n            console.warn(`Entity ${entity.id} has no valid mesh to add to scene`);\r\n            \r\n            // Debug output if we have a meshComponent but no mesh\r\n            if (meshComponent && !meshComponent.mesh) {\r\n                console.warn(`Entity ${entity.id} has MeshComponent but mesh property is ${meshComponent.mesh}`);\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Handle bounding sphere carefully - THREE.Group objects don't have geometry\r\n        if (meshComponent.mesh.geometry) {\r\n            // Only compute if it's a mesh with geometry and not a Group\r\n            if (!meshComponent.mesh.geometry.boundingSphere && typeof meshComponent.mesh.geometry.computeBoundingSphere === 'function') {\r\n                meshComponent.mesh.geometry.computeBoundingSphere();\r\n            }\r\n        } else if (meshComponent.mesh.isGroup) {\r\n            // It's a Group object (no direct geometry property)\r\n            console.log(`Entity ${entity.id} uses a THREE.Group - skipping bounding sphere computation`);\r\n        }\r\n        \r\n        // Ensure we have access to the scene\r\n        if (!this.scene) {\r\n            console.error(`Cannot add entity ${entity.id} mesh to scene - scene reference is missing`);\r\n            return;\r\n        }\r\n        \r\n        // Add mesh to scene directly (don't check for parent)\r\n        this.scene.add(meshComponent.mesh);\r\n        \r\n        // Make sure mesh is visible\r\n        meshComponent.mesh.visible = true;\r\n        \r\n        // Apply entity transform to mesh\r\n        const transform = entity.getComponent('TransformComponent');\r\n        if (transform) {\r\n            meshComponent.mesh.position.copy(transform.position);\r\n            meshComponent.mesh.quaternion.copy(transform.quaternion);\r\n            meshComponent.mesh.scale.copy(transform.scale);\r\n        }\r\n        \r\n        // Log debug info about entity being added\r\n        console.log(`Added entity ${entity.id} mesh to scene - position: ${meshComponent.mesh.position.x.toFixed(0)},${meshComponent.mesh.position.y.toFixed(0)},${meshComponent.mesh.position.z.toFixed(0)}`);\r\n        \r\n        // Track this entity for updates\r\n        this.meshEntities.set(entity.id, entity);\r\n    }\r\n    \r\n    /**\r\n     * Remove entity mesh from scene\r\n     * @param {Entity} entity Entity to remove\r\n     */\r\n    removeEntityFromScene(entity) {\r\n        const meshComponent = entity.getComponent('MeshComponent');\r\n        \r\n        // Remove mesh from scene\r\n        if (meshComponent.mesh && meshComponent.mesh.parent) {\r\n            this.scene.remove(meshComponent.mesh);\r\n        }\r\n        \r\n        // Stop tracking this entity\r\n        this.meshEntities.delete(entity.id);\r\n    }\r\n    \r\n    /**\r\n     * Update camera frustum for culling\r\n     */\r\n    updateFrustum() {\r\n        if (!this.camera) return;\r\n        \r\n        try {\r\n            // Check if camera matrices are valid\r\n            if (!this.camera.projectionMatrix || !this.camera.matrixWorldInverse) {\r\n                console.warn('Camera matrices not initialized');\r\n                return;\r\n            }\r\n            \r\n            // Create fresh matrices to avoid reference issues\r\n            this.projScreenMatrix = new THREE.Matrix4();\r\n            \r\n            // Multiply matrices to create projection\r\n            this.projScreenMatrix.multiplyMatrices(\r\n                this.camera.projectionMatrix,\r\n                this.camera.matrixWorldInverse\r\n            );\r\n            \r\n            // Set frustum from projection matrix\r\n            this.frustum = new THREE.Frustum();\r\n            this.frustum.setFromProjectionMatrix(this.projScreenMatrix);\r\n        } catch (error) {\r\n            console.error('Error updating frustum:', error);\r\n            // If we can't update the frustum, we'll disable culling by setting DEBUG_MODE\r\n            window.DEBUG_MODE = true;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check if a position is visible in the camera frustum\r\n     * @param {THREE.Vector3} position Position to check\r\n     * @param {number} radius Bounding sphere radius\r\n     * @returns {boolean} True if visible\r\n     */\r\n    isVisible(position, radius) {\r\n        // Use a much larger radius for distant objects\r\n        const visibilityRadius = Math.max(radius, 1000); // Ensure large distant objects remain visible\r\n        \r\n        // During development, or for this fix, ALWAYS assume everything is visible to aid debugging\r\n        // Force to true to bypass the culling system entirely\r\n        window.DEBUG_MODE = true;\r\n        return true;\r\n        \r\n        // Safely check if position is valid before creating a sphere\r\n        if (!position || typeof position.x !== 'number') {\r\n            console.warn('Invalid position for visibility check:', position);\r\n            return true; // Default to visible if position is invalid\r\n        }\r\n        \r\n        // First try just using containsPoint which is simpler\r\n        if (this.frustum.containsPoint(position)) {\r\n            return true;\r\n        }\r\n        \r\n        // Create sphere for intersection test - with error handling\r\n        try {\r\n            const sphere = new THREE.Sphere(position.clone(), visibilityRadius);\r\n            return this.frustum.intersectsSphere(sphere);\r\n        } catch (error) {\r\n            console.warn('Error in frustum intersection test:', error);\r\n            return true; // Default to visible on error\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update all mesh transforms from entity transforms\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Update camera frustum for culling\r\n        this.updateFrustum();\r\n        \r\n        // Try to scan for entities that should be tracked but aren't\r\n        if (window.DEBUG_MODE && this.world.time % 5 < deltaTime) {\r\n            this.scanForMissingEntities();\r\n        }\r\n        \r\n        // Update all registered meshes\r\n        for (const entity of this.meshEntities.values()) {\r\n            const transform = entity.getComponent('TransformComponent');\r\n            const meshComponent = entity.getComponent('MeshComponent');\r\n            \r\n            // Skip if either component is missing\r\n            if (!transform || !meshComponent || !meshComponent.mesh) continue;\r\n            \r\n            // Check if mesh is in the scene, if not add it\r\n            if (!meshComponent.mesh.parent && this.scene) {\r\n                console.log(`RenderSystem: Adding missing mesh for entity ${entity.id} to scene`);\r\n                this.scene.add(meshComponent.mesh);\r\n            }\r\n            \r\n            // Update mesh from transform\r\n            meshComponent.mesh.position.copy(transform.position);\r\n            meshComponent.mesh.quaternion.copy(transform.quaternion);\r\n            meshComponent.mesh.scale.copy(transform.scale);\r\n            \r\n            // Mark transform as updated\r\n            transform.needsUpdate = false;\r\n            \r\n            // Force visibility in debug mode\r\n            if (window.DEBUG_MODE) {\r\n                meshComponent.mesh.visible = true;\r\n                continue;\r\n            }\r\n            \r\n            // Update visibility based on frustum culling\r\n            if (meshComponent.visible) {\r\n                // Use a large default radius for better visibility\r\n                // Handle both mesh geometry and group objects\r\n                let radius = 500; // Default large radius\r\n                \r\n                // Safely check for boundingSphere - handle all cases\r\n                if (meshComponent.mesh.isGroup) {\r\n                    // For groups, we don't have a direct boundingSphere, so use default\r\n                    radius = 500;\r\n                } else if (meshComponent.mesh.geometry) {\r\n                    // Only try to access boundingSphere if geometry exists\r\n                    if (meshComponent.mesh.geometry.boundingSphere) {\r\n                        radius = meshComponent.mesh.geometry.boundingSphere.radius;\r\n                    } else if (typeof meshComponent.mesh.geometry.computeBoundingSphere === 'function') {\r\n                        // Try to compute if not already done\r\n                        meshComponent.mesh.geometry.computeBoundingSphere();\r\n                        // Now check if it was created successfully\r\n                        if (meshComponent.mesh.geometry.boundingSphere) {\r\n                            radius = meshComponent.mesh.geometry.boundingSphere.radius;\r\n                        }\r\n                    }\r\n                }\r\n                const isInView = this.isVisible(transform.position, radius);\r\n                meshComponent.mesh.visible = isInView;\r\n            } else {\r\n                meshComponent.mesh.visible = false;\r\n            }\r\n        }\r\n        \r\n        // Diagnostics - log mesh counts periodically\r\n        if (window.DEBUG_MODE && this.world.time % 5 < deltaTime) {\r\n            console.log(`RenderSystem: ${this.meshEntities.size} entities being managed`);\r\n        }\r\n        \r\n        // This system only handles mesh transform updates\r\n        // The main game renderer handles the actual rendering\r\n    }\r\n    \r\n    /**\r\n     * Scan for entities that should be tracked but aren't\r\n     */\r\n    scanForMissingEntities() {\r\n        // Get all entities with transform and mesh components\r\n        const entities = this.world.getEntitiesWithComponents(['TransformComponent', 'MeshComponent']);\r\n        \r\n        // Count how many we're not tracking\r\n        let missingCount = 0;\r\n        \r\n        // Add any entities that aren't already being tracked\r\n        entities.forEach(entity => {\r\n            if (!this.meshEntities.has(entity.id)) {\r\n                console.log(`RenderSystem: Found untracked entity ${entity.id} with mesh, adding to scene`);\r\n                this.addEntityToScene(entity);\r\n                missingCount++;\r\n            }\r\n        });\r\n        \r\n        if (missingCount > 0) {\r\n            console.log(`RenderSystem: Added ${missingCount} missing entities to tracking`);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clean up resources when system is destroyed\r\n     */\r\n    onDestroyed() {\r\n        // Dispose of THREE.js matrices\r\n        this.projScreenMatrix = null;\r\n        this.frustum = null;\r\n        \r\n        // Clean up all entities\r\n        for (const entity of this.meshEntities.values()) {\r\n            this.removeEntityFromScene(entity);\r\n        }\r\n        \r\n        // Clear entity map\r\n        this.meshEntities.clear();\r\n        \r\n        // Clear scene reference\r\n        this.scene = null;\r\n        this.camera = null;\r\n        this.renderer = null;\r\n        \r\n        // Unsubscribe from all message bus events\r\n        if (this.world && this.world.messageBus) {\r\n            // Unsubscribe from entity events\r\n            this.world.messageBus.unsubscribe('entity.created', this.onEntityCreated.bind(this));\r\n            this.world.messageBus.unsubscribe('entity.destroyed', this.onEntityDestroyed.bind(this));\r\n            this.world.messageBus.unsubscribe('component.added', this.onComponentAdded.bind(this));\r\n        }\r\n    }\r\n}","/**\r\n * CollisionSystem - Handles collision detection and resolution\r\n * \r\n * Manages spatial partitioning and collision responses.\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { System } from '../../core/system.js';\r\nimport { FixedArray } from '../../utils/memoryManager.js';\r\n\r\nexport class CollisionSystem extends System {\r\n    constructor(world) {\r\n        super(world);\r\n        this.requiredComponents = ['TransformComponent', 'RigidbodyComponent'];\r\n        this.priority = 20; // Run after movement system\r\n        \r\n        // Spatial partitioning grid\r\n        this.cells = new Map();\r\n        this.cellSize = 2000; // Size of each spatial cell (4x the original 500)\r\n        \r\n        // Collision tracking to prevent duplicates\r\n        this.processedCollisions = new Set();\r\n        \r\n        // Keep track of entities per cell for quick lookup\r\n        this.entityCells = new Map();\r\n        \r\n        // Pre-allocated arrays to avoid garbage collection\r\n        this.potentialColliders = new FixedArray(200); // Pre-allocate for 200 potential colliders\r\n        this.cellsToCheck = new FixedArray(27); // 3^3 neighboring cells\r\n        \r\n        // Reusable vectors for collision calculations\r\n        this.tempVec1 = new THREE.Vector3();\r\n        this.tempVec2 = new THREE.Vector3();\r\n        this.collisionNormal = new THREE.Vector3();\r\n        this.relativeVelocity = new THREE.Vector3();\r\n    }\r\n    \r\n    /**\r\n     * Process all entities for collisions\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Clear spatial grid and tracking sets\r\n        this.cells.clear();\r\n        this.processedCollisions.clear();\r\n        this.entityCells.clear();\r\n        \r\n        // Get all entities with required components\r\n        const entities = this.getEntities();\r\n        \r\n        // First pass: populate spatial partitioning grid\r\n        for (let i = 0; i < entities.length; i++) {\r\n            this._insertIntoGrid(entities[i]);\r\n        }\r\n        \r\n        // Second pass: check for collisions using spatial partitioning\r\n        for (let i = 0; i < entities.length; i++) {\r\n            this._checkCollisionsOptimized(entities[i], deltaTime);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Insert entity into spatial partitioning grid\r\n     * @param {Entity} entity Entity to insert\r\n     * @private\r\n     */\r\n    _insertIntoGrid(entity) {\r\n        const transform = entity.getComponent('TransformComponent');\r\n        const rigidbody = entity.getComponent('RigidbodyComponent');\r\n        \r\n        if (!transform || !rigidbody) return;\r\n        \r\n        // Calculate cell coordinates\r\n        const cellX = Math.floor(transform.position.x / this.cellSize);\r\n        const cellY = Math.floor(transform.position.y / this.cellSize);\r\n        const cellZ = Math.floor(transform.position.z / this.cellSize);\r\n        \r\n        // Create cell key\r\n        const cellKey = `${cellX},${cellY},${cellZ}`;\r\n        \r\n        // Add entity to cell\r\n        if (!this.cells.has(cellKey)) {\r\n            this.cells.set(cellKey, []);\r\n        }\r\n        this.cells.get(cellKey).push(entity);\r\n        \r\n        // Track which cells this entity is in\r\n        if (!this.entityCells.has(entity.id)) {\r\n            this.entityCells.set(entity.id, new Set());\r\n        }\r\n        this.entityCells.get(entity.id).add(cellKey);\r\n        \r\n        // For special entities like projectiles, add to neighboring cells too\r\n        const radius = rigidbody.collisionRadius;\r\n        const isProjectile = entity.hasTag('playerProjectile') || entity.hasTag('particleProjectile');\r\n        \r\n        // Fast-moving objects need to be in more cells\r\n        const overlapFactor = isProjectile ? 5 : 1;\r\n        \r\n        // Calculate neighboring cells based on entity size and velocity\r\n        const cellRadius = Math.ceil((radius * overlapFactor) / this.cellSize);\r\n        \r\n        if (isProjectile || cellRadius > 0) {\r\n            // Get velocity for high-speed projectiles\r\n            const velocity = rigidbody.velocity || { length: () => 0 };\r\n            const speedFactor = velocity.length ? Math.min(3, Math.ceil(velocity.length() / 1000)) : 1;\r\n            \r\n            // Add to more cells in the direction of movement for fast projectiles\r\n            for (let dx = -cellRadius; dx <= cellRadius; dx++) {\r\n                for (let dy = -cellRadius; dy <= cellRadius; dy++) {\r\n                    for (let dz = -cellRadius; dz <= cellRadius; dz++) {\r\n                        // Skip the center cell (already added)\r\n                        if (dx === 0 && dy === 0 && dz === 0) continue;\r\n                        \r\n                        // For projectiles, extend further in the direction of movement\r\n                        if (isProjectile && speedFactor > 1) {\r\n                            // Skip cells that are not in the direction of movement\r\n                            const dotProduct = dx * Math.sign(velocity.x || 0) + \r\n                                               dy * Math.sign(velocity.y || 0) + \r\n                                               dz * Math.sign(velocity.z || 0);\r\n                            if (dotProduct < 0) continue;\r\n                        }\r\n                        \r\n                        const neighborKey = `${cellX + dx},${cellY + dy},${cellZ + dz}`;\r\n                        if (!this.cells.has(neighborKey)) {\r\n                            this.cells.set(neighborKey, []);\r\n                        }\r\n                        this.cells.get(neighborKey).push(entity);\r\n                        this.entityCells.get(entity.id).add(neighborKey);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check for collisions with optimized spatial partitioning\r\n     * @param {Entity} entity Entity to check\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     * @private\r\n     */\r\n    _checkCollisionsOptimized(entity, deltaTime) {\r\n        const transform = entity.getComponent('TransformComponent');\r\n        const rigidbody = entity.getComponent('RigidbodyComponent');\r\n        \r\n        if (!transform || !rigidbody || !this.entityCells.has(entity.id)) {\r\n            return;\r\n        }\r\n        \r\n        // Get all cells this entity is in\r\n        const entityCellKeys = this.entityCells.get(entity.id);\r\n        \r\n        // Reset potential colliders array (reuse to avoid GC)\r\n        this.potentialColliders.clear();\r\n        \r\n        // Collect all potential colliders from all cells this entity is in\r\n        entityCellKeys.forEach(cellKey => {\r\n            const cellEntities = this.cells.get(cellKey);\r\n            if (!cellEntities) return;\r\n            \r\n            // Add all entities from this cell to potential colliders\r\n            for (let i = 0; i < cellEntities.length; i++) {\r\n                const otherEntity = cellEntities[i];\r\n                \r\n                // Skip self\r\n                if (otherEntity === entity) continue;\r\n                \r\n                // Skip if already processed this pair\r\n                const pairId = entity.id < otherEntity.id ? \r\n                    `${entity.id}:${otherEntity.id}` : \r\n                    `${otherEntity.id}:${entity.id}`;\r\n                \r\n                if (this.processedCollisions.has(pairId)) continue;\r\n                \r\n                // Add to potential colliders\r\n                this.potentialColliders.push(otherEntity);\r\n                \r\n                // Mark this pair as processed\r\n                this.processedCollisions.add(pairId);\r\n            }\r\n        });\r\n        \r\n        // Now check collisions with all potential colliders\r\n        for (let i = 0; i < this.potentialColliders.length; i++) {\r\n            const otherEntity = this.potentialColliders.get(i);\r\n            const otherTransform = otherEntity.getComponent('TransformComponent');\r\n            const otherRigidbody = otherEntity.getComponent('RigidbodyComponent');\r\n            \r\n            if (!otherTransform || !otherRigidbody) continue;\r\n            \r\n            // Check for collision\r\n            if (this._checkSphereCollision(\r\n                transform.position, rigidbody.collisionRadius,\r\n                otherTransform.position, otherRigidbody.collisionRadius\r\n            )) {\r\n                // Process the collision\r\n                if (rigidbody.isTrigger || otherRigidbody.isTrigger) {\r\n                    this._handleTrigger(entity, otherEntity);\r\n                } else {\r\n                    this._resolveCollision(\r\n                        entity, otherEntity,\r\n                        transform, rigidbody,\r\n                        otherTransform, otherRigidbody\r\n                    );\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Check for sphere-sphere collision\r\n     * @param {THREE.Vector3} posA Position A\r\n     * @param {number} radiusA Radius A\r\n     * @param {THREE.Vector3} posB Position B\r\n     * @param {number} radiusB Radius B\r\n     * @returns {boolean} True if collision detected\r\n     * @private\r\n     */\r\n    _checkSphereCollision(posA, radiusA, posB, radiusB) {\r\n        // Optimized: Use squared distance for better performance\r\n        const dx = posA.x - posB.x;\r\n        const dy = posA.y - posB.y;\r\n        const dz = posA.z - posB.z;\r\n        const distanceSquared = dx * dx + dy * dy + dz * dz;\r\n        \r\n        // Compare with squared sum of radii (more efficient than using square root)\r\n        const radiusSum = radiusA + radiusB;\r\n        return distanceSquared <= (radiusSum * radiusSum);\r\n    }\r\n    \r\n    /**\r\n     * Handle a trigger collision (no physics response)\r\n     * @param {Entity} entity Entity A\r\n     * @param {Entity} otherEntity Entity B\r\n     * @private\r\n     */\r\n    _handleTrigger(entity, otherEntity) {\r\n        // Identify player projectile and enemy - use direct tag access for better performance\r\n        let playerProjectile = null;\r\n        let enemyEntity = null;\r\n        \r\n        // Use _isPlayerProjectile, _isEnemy flags for faster checks if available\r\n        const entityIsProjectile = entity._isPlayerProjectile || \r\n                                   entity.hasTag('playerProjectile') || \r\n                                   entity.hasTag('particleProjectile');\r\n                                   \r\n        const otherIsEnemy = otherEntity._isEnemy || \r\n                            otherEntity.hasTag('enemy') || \r\n                            otherEntity.hasComponent('EnemyComponent') || \r\n                            otherEntity.hasComponent('EnemyAIComponent');\r\n        \r\n        if (entityIsProjectile && otherIsEnemy) {\r\n            playerProjectile = entity;\r\n            enemyEntity = otherEntity;\r\n        } else {\r\n            const otherIsProjectile = otherEntity._isPlayerProjectile || \r\n                                     otherEntity.hasTag('playerProjectile') || \r\n                                     otherEntity.hasTag('particleProjectile');\r\n                                     \r\n            const entityIsEnemy = entity._isEnemy || \r\n                                 entity.hasTag('enemy') || \r\n                                 entity.hasComponent('EnemyComponent') || \r\n                                 entity.hasComponent('EnemyAIComponent');\r\n            \r\n            if (otherIsProjectile && entityIsEnemy) {\r\n                playerProjectile = otherEntity;\r\n                enemyEntity = entity;\r\n            }\r\n        }\r\n        \r\n        // If this is a player projectile hitting an enemy, handle the hit\r\n        if (playerProjectile && enemyEntity) {\r\n            console.log(`DIRECT HIT: Player projectile ${playerProjectile.id} hit enemy ${enemyEntity.id}`);\r\n            \r\n            // Ignore pooled entities\r\n            if (enemyEntity.hasTag('pooled')) {\r\n                console.warn(`Skipping hit on pooled enemy ${enemyEntity.id}`);\r\n                return;\r\n            }\r\n            \r\n            // Log detailed collision info\r\n            const projectileTransform = playerProjectile.getComponent('TransformComponent');\r\n            const enemyTransform = enemyEntity.getComponent('TransformComponent');\r\n            \r\n            if (projectileTransform && enemyTransform) {\r\n                const distance = projectileTransform.position.distanceTo(enemyTransform.position);\r\n                console.log(`Hit details: Distance=${distance.toFixed(1)}, ProjectilePos=${projectileTransform.position.x.toFixed(0)},${projectileTransform.position.y.toFixed(0)},${projectileTransform.position.z.toFixed(0)}, EnemyPos=${enemyTransform.position.x.toFixed(0)},${enemyTransform.position.y.toFixed(0)},${enemyTransform.position.z.toFixed(0)}`);\r\n            }\r\n            \r\n            // Apply damage to enemy\r\n            const health = enemyEntity.getComponent('HealthComponent');\r\n            if (health) {\r\n                // Apply significant damage - guaranteed to kill in one hit\r\n                const damage = 1000; // Massive damage to guarantee instant death\r\n                console.log(`CRITICAL HIT: Applying ${damage} damage to enemy ${enemyEntity.id}`);\r\n                health.applyDamage(damage, 'particle', playerProjectile);\r\n                \r\n                // Double-check if enemy was destroyed \r\n                if (!health.isDestroyed) {\r\n                    console.error(\"ERROR: Enemy not destroyed after particle hit! Sending entity.destroyed event...\");\r\n                    // Instead of forcing destruction, trigger the entity.destroyed event\r\n                    health.isDestroyed = true;\r\n                    health.health = 0;\r\n                    \r\n                    // Force publish destruction event - this will trigger the proper pool handling\r\n                    this.world.messageBus.publish('entity.destroyed', {\r\n                        entity: enemyEntity,\r\n                        source: playerProjectile,\r\n                        damageType: 'particle'\r\n                    });\r\n                } else {\r\n                    console.log(\"ENEMY DESTROYED CONFIRMED! Health reached zero and isDestroyed=true\");\r\n                }\r\n            }\r\n            \r\n            // Get position for effects\r\n            let position = null;\r\n            try {\r\n                position = playerProjectile.getComponent('TransformComponent').position.clone();\r\n            } catch (error) {\r\n                // Fallback to enemy position if needed\r\n                try {\r\n                    position = enemyEntity.getComponent('TransformComponent').position.clone();\r\n                } catch (innerError) {\r\n                    // Use zero as last resort\r\n                    position = new THREE.Vector3(0, 0, 0);\r\n                }\r\n            }\r\n            \r\n            // Publish events for the hit\r\n            this.world.messageBus.publish('collision.trigger', {\r\n                entityA: playerProjectile,\r\n                entityB: enemyEntity,\r\n                projectileHit: true\r\n            });\r\n            \r\n            this.world.messageBus.publish('projectile.hit', {\r\n                projectile: playerProjectile,\r\n                target: enemyEntity,\r\n                position: position\r\n            });\r\n            \r\n            // Destroy the projectile only - the enemy will be handled by its health component\r\n            this.world.destroyEntity(playerProjectile.id);\r\n        } else {\r\n            // Generic trigger event for non-projectile collisions\r\n            this.world.messageBus.publish('collision.trigger', {\r\n                entityA: entity,\r\n                entityB: otherEntity\r\n            });\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Resolve a physical collision with impulse-based physics\r\n     * @private\r\n     */\r\n    _resolveCollision(entityA, entityB, transformA, rigidbodyA, transformB, rigidbodyB) {\r\n        // Use reusable vectors instead of creating new ones\r\n        \r\n        // Calculate collision normal\r\n        this.collisionNormal.copy(transformA.position).sub(transformB.position).normalize();\r\n        \r\n        // Calculate relative velocity\r\n        this.relativeVelocity.copy(rigidbodyA.velocity).sub(rigidbodyB.velocity);\r\n        \r\n        // Calculate relative velocity along the normal\r\n        const velocityAlongNormal = this.relativeVelocity.dot(this.collisionNormal);\r\n        \r\n        // Only resolve if objects are moving toward each other\r\n        if (velocityAlongNormal > 0) return;\r\n        \r\n        // Calculate restitution (bounciness)\r\n        const restitution = 0.3;\r\n        \r\n        // Calculate inverse masses (handle infinite mass objects for immovable objects)\r\n        const invMassA = rigidbodyA.isKinematic ? 0 : 1 / rigidbodyA.mass;\r\n        const invMassB = rigidbodyB.isKinematic ? 0 : 1 / rigidbodyB.mass;\r\n        \r\n        // Calculate impulse scalar\r\n        const impulseScalar = -(1 + restitution) * velocityAlongNormal / (invMassA + invMassB);\r\n        \r\n        // Apply impulse\r\n        // Using our reusable vector and scaling it\r\n        this.tempVec1.copy(this.collisionNormal).multiplyScalar(impulseScalar * invMassA);\r\n        this.tempVec2.copy(this.collisionNormal).multiplyScalar(impulseScalar * invMassB);\r\n        \r\n        rigidbodyA.velocity.sub(this.tempVec1);\r\n        rigidbodyB.velocity.add(this.tempVec2);\r\n        \r\n        // Position correction to prevent sinking\r\n        const percent = 0.2; // penetration percentage to correct\r\n        const slop = 0.01; // penetration allowance\r\n        \r\n        // Calculate penetration depth\r\n        const distanceSquared = transformA.position.distanceToSquared(transformB.position);\r\n        const radiusSum = rigidbodyA.collisionRadius + rigidbodyB.collisionRadius;\r\n        const penetration = radiusSum - Math.sqrt(distanceSquared);\r\n        \r\n        if (penetration > slop) {\r\n            const correction = Math.max(penetration - slop, 0) / (invMassA + invMassB) * percent;\r\n            \r\n            // Apply correction\r\n            this.tempVec1.copy(this.collisionNormal).multiplyScalar(correction * invMassA);\r\n            this.tempVec2.copy(this.collisionNormal).multiplyScalar(correction * invMassB);\r\n            \r\n            transformA.position.sub(this.tempVec1);\r\n            transformB.position.add(this.tempVec2);\r\n        }\r\n    }\r\n}","/**\r\n * VisualEffectsSystem - Manages visual effects like explosions, damage flashes, etc.\r\n * \r\n * This system handles creating and managing visual effects for the game,\r\n * keeping them separate from game logic.\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport { System } from '../../core/system.js';\r\n\r\nexport class VisualEffectsSystem extends System {\r\n    constructor(world) {\r\n        super(world);\r\n        this.priority = 70; // Lower priority, run after gameplay systems\r\n        \r\n        // Keep track of active effects\r\n        this.activeEffects = new Map();\r\n        \r\n        // Effect counters for unique IDs\r\n        this.effectCounter = 0;\r\n        \r\n        // Setup listeners for effect events\r\n        this.setupEventListeners();\r\n        \r\n        console.log(\"VisualEffectsSystem initialized\");\r\n    }\r\n    \r\n    /**\r\n     * Set up event listeners for visual effect events\r\n     */\r\n    setupEventListeners() {\r\n        // Listen for explosion effect requests\r\n        this.world.messageBus.subscribe('vfx.explosion', this.handleExplosionRequest.bind(this));\r\n        \r\n        // Listen for damage flash effect requests\r\n        this.world.messageBus.subscribe('vfx.damageFlash', this.handleDamageFlashRequest.bind(this));\r\n    }\r\n    \r\n    /**\r\n     * Update all active visual effects\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Update all active effects and remove completed ones\r\n        for (const [id, effect] of this.activeEffects.entries()) {\r\n            if (!effect.update(deltaTime)) {\r\n                // Effect is complete, remove it\r\n                this.removeEffect(id);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle request to create an explosion effect\r\n     * @param {object} message The explosion request message\r\n     */\r\n    handleExplosionRequest(message) {\r\n        if (!message || !message.data || !message.data.position) {\r\n            console.error(\"Invalid explosion effect request\", message);\r\n            return;\r\n        }\r\n        \r\n        // Extract parameters from message\r\n        const position = message.data.position;\r\n        const scale = message.data.scale || 1.0;\r\n        const duration = message.data.duration || 2.0;\r\n        \r\n        // Create explosion effect\r\n        this.createExplosionEffect(position, scale, duration);\r\n        \r\n        // Play explosion sound (use boink instead of explosion)\r\n        if (window.game && window.game.audio) {\r\n            window.game.audio.playSound('boink');\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Handle request to create a damage flash effect\r\n     * @param {object} message The damage flash request message\r\n     */\r\n    handleDamageFlashRequest(message) {\r\n        // Extract intensity from message if available\r\n        const intensity = message && message.data && message.data.intensity ? \r\n            message.data.intensity : 0.3;\r\n        \r\n        // Create damage flash effect\r\n        this.createDamageFlashEffect(intensity);\r\n    }\r\n    \r\n    /**\r\n     * Create an explosion effect at the specified position\r\n     * @param {THREE.Vector3} position Position for the explosion\r\n     * @param {number} scale Size scale for the explosion (1.0 = normal)\r\n     * @param {number} duration Duration in seconds\r\n     * @returns {number} Effect ID\r\n     */\r\n    createExplosionEffect(position, scale = 1.0, duration = 2.0) {\r\n        // Get access to THREE.js scene\r\n        if (!this.world.scene) {\r\n            console.error(\"No scene available for explosion effect\");\r\n            return -1;\r\n        }\r\n        \r\n        // Create effect container\r\n        const container = new THREE.Group();\r\n        container.position.copy(position);\r\n        container.scale.set(scale, scale, scale);\r\n        \r\n        // Create particles for explosion - use object pool if available\r\n        const particleCount = Math.floor(20 * scale);\r\n        const particles = [];\r\n        \r\n        // Check if pooling system is available\r\n        const usePooling = window.objectPool && \r\n                          window.objectPool.pools && \r\n                          window.objectPool.pools['explosionParticle'];\r\n        \r\n        // Create particles with properties\r\n        for (let i = 0; i < particleCount; i++) {\r\n            let particle;\r\n            const size = Math.random() * 2 + 1;\r\n            \r\n            if (usePooling) {\r\n                // Get particle from pool\r\n                particle = window.objectPool.get('explosionParticle');\r\n                \r\n                if (particle) {\r\n                    // Position randomly within explosion radius\r\n                    const radius = Math.random() * 10;\r\n                    const theta = Math.random() * Math.PI * 2;\r\n                    const phi = Math.random() * Math.PI;\r\n                    \r\n                    const particlePos = new THREE.Vector3(\r\n                        radius * Math.sin(phi) * Math.cos(theta),\r\n                        radius * Math.sin(phi) * Math.sin(theta),\r\n                        radius * Math.cos(phi)\r\n                    );\r\n                    \r\n                    // Reset the particle with position relative to container origin\r\n                    particle.reset(particlePos, size, 0xff5500);\r\n                    \r\n                    // Set velocity for animation\r\n                    particle.velocity.copy(particlePos).normalize().multiplyScalar(\r\n                        Math.random() * 2 + 1\r\n                    );\r\n                    \r\n                    // Add to container\r\n                    container.add(particle.mesh);\r\n                    particles.push(particle);\r\n                }\r\n            } else {\r\n                // Fallback to creating new particles if pool is not available\r\n                // Use precomputed geometry if available, otherwise create new\r\n                const geometry = window.game && window.game.explosionGeometry ? \r\n                                window.game.explosionGeometry : \r\n                                new THREE.SphereGeometry(size, 8, 8);\r\n                \r\n                // Use precomputed material as template if available\r\n                const material = window.game && window.game.explosionMaterial ? \r\n                                window.game.explosionMaterial.clone() : \r\n                                new THREE.MeshBasicMaterial({\r\n                                    color: 0xff5500,\r\n                                    transparent: true,\r\n                                    opacity: 0.8\r\n                                });\r\n                \r\n                const particleMesh = new THREE.Mesh(geometry, material);\r\n                \r\n                // Random position within explosion radius\r\n                const radius = Math.random() * 10;\r\n                const theta = Math.random() * Math.PI * 2;\r\n                const phi = Math.random() * Math.PI;\r\n                \r\n                particleMesh.position.set(\r\n                    radius * Math.sin(phi) * Math.cos(theta),\r\n                    radius * Math.sin(phi) * Math.sin(theta),\r\n                    radius * Math.cos(phi)\r\n                );\r\n                \r\n                // Store velocity in userData\r\n                particleMesh.userData.velocity = particleMesh.position.clone().normalize().multiplyScalar(\r\n                    Math.random() * 2 + 1\r\n                );\r\n                \r\n                // Add to container\r\n                container.add(particleMesh);\r\n                particles.push({\r\n                    mesh: particleMesh,\r\n                    material: material,\r\n                    velocity: particleMesh.userData.velocity\r\n                });\r\n            }\r\n        }\r\n        \r\n        // Add container to scene\r\n        this.world.scene.add(container);\r\n        \r\n        // Create effect object\r\n        const effectId = this.effectCounter++;\r\n        const effect = {\r\n            id: effectId,\r\n            type: 'explosion',\r\n            container: container,\r\n            particles: particles,\r\n            duration: duration,\r\n            elapsed: 0,\r\n            usePooling: usePooling,\r\n            update: (dt) => {\r\n                // Update elapsed time\r\n                effect.elapsed += dt;\r\n                \r\n                // Check if effect is complete\r\n                if (effect.elapsed >= effect.duration) {\r\n                    // Clean up explosion particles\r\n                    if (effect.usePooling) {\r\n                        // Return particles to pool\r\n                        effect.particles.forEach(particle => {\r\n                            window.objectPool.release('explosionParticle', particle);\r\n                        });\r\n                    }\r\n                    // Remove container from scene\r\n                    this.world.scene.remove(container);\r\n                    return false;\r\n                }\r\n                \r\n                // Calculate progress (0 to 1)\r\n                const progress = effect.elapsed / effect.duration;\r\n                \r\n                // Update particle positions and opacity\r\n                effect.particles.forEach(particle => {\r\n                    if (effect.usePooling) {\r\n                        // Using pooled particles\r\n                        // Move particle outward\r\n                        particle.mesh.position.add(\r\n                            particle.velocity.clone().multiplyScalar(dt)\r\n                        );\r\n                        \r\n                        // Fade out gradually\r\n                        particle.material.opacity = 0.8 * (1 - progress);\r\n                        \r\n                        // Shrink slightly\r\n                        particle.mesh.scale.multiplyScalar(0.99);\r\n                    } else {\r\n                        // Using direct mesh\r\n                        // Move particle outward\r\n                        particle.mesh.position.add(\r\n                            particle.velocity.clone().multiplyScalar(dt)\r\n                        );\r\n                        \r\n                        // Fade out gradually\r\n                        particle.material.opacity = 0.8 * (1 - progress);\r\n                        \r\n                        // Shrink slightly\r\n                        particle.mesh.scale.multiplyScalar(0.99);\r\n                    }\r\n                });\r\n                \r\n                return true;\r\n            }\r\n        };\r\n        \r\n        // Add to active effects\r\n        this.activeEffects.set(effectId, effect);\r\n        \r\n        return effectId;\r\n    }\r\n    \r\n    /**\r\n     * Create a damage flash effect on screen\r\n     * @param {number} intensity Flash intensity (0-1)\r\n     * @returns {number} Effect ID\r\n     */\r\n    createDamageFlashEffect(intensity = 0.3) {\r\n        // Create a full-screen flash element\r\n        const flash = document.createElement('div');\r\n        flash.style.position = 'fixed';\r\n        flash.style.top = '0';\r\n        flash.style.left = '0';\r\n        flash.style.width = '100%';\r\n        flash.style.height = '100%';\r\n        flash.style.backgroundColor = `rgba(255, 0, 0, ${intensity})`;\r\n        flash.style.pointerEvents = 'none';\r\n        flash.style.zIndex = '1000';\r\n        flash.style.opacity = '1';\r\n        flash.style.transition = 'opacity 0.2s ease-out';\r\n        \r\n        // Add to DOM\r\n        document.body.appendChild(flash);\r\n        \r\n        // Create effect object\r\n        const effectId = this.effectCounter++;\r\n        const effect = {\r\n            id: effectId,\r\n            type: 'damageFlash',\r\n            element: flash,\r\n            duration: 0.3, // Fixed duration for damage flash\r\n            elapsed: 0,\r\n            update: (dt) => {\r\n                // Update elapsed time\r\n                effect.elapsed += dt;\r\n                \r\n                // Check if effect is complete\r\n                if (effect.elapsed >= effect.duration) {\r\n                    // Remove element from DOM\r\n                    if (document.body.contains(flash)) {\r\n                        document.body.removeChild(flash);\r\n                    }\r\n                    return false;\r\n                }\r\n                \r\n                // Calculate progress (0 to 1)\r\n                const progress = effect.elapsed / effect.duration;\r\n                \r\n                // Fade out\r\n                flash.style.opacity = (1 - progress).toString();\r\n                \r\n                return true;\r\n            }\r\n        };\r\n        \r\n        // Add to active effects\r\n        this.activeEffects.set(effectId, effect);\r\n        \r\n        return effectId;\r\n    }\r\n    \r\n    /**\r\n     * Remove an effect and clean up its resources\r\n     * @param {number} effectId ID of the effect to remove\r\n     */\r\n    removeEffect(effectId) {\r\n        // Get effect\r\n        const effect = this.activeEffects.get(effectId);\r\n        if (!effect) return;\r\n        \r\n        // Clean up based on effect type\r\n        if (effect.type === 'explosion') {\r\n            if (effect.container && this.world.scene) {\r\n                this.world.scene.remove(effect.container);\r\n            }\r\n        } else if (effect.type === 'damageFlash') {\r\n            if (effect.element && document.body.contains(effect.element)) {\r\n                document.body.removeChild(effect.element);\r\n            }\r\n        }\r\n        \r\n        // Remove from active effects\r\n        this.activeEffects.delete(effectId);\r\n    }\r\n    \r\n    /**\r\n     * Clean up all effects when system is disabled\r\n     */\r\n    onDisabled() {\r\n        // Remove all active effects\r\n        for (const effectId of this.activeEffects.keys()) {\r\n            this.removeEffect(effectId);\r\n        }\r\n        \r\n        // Clear effects map\r\n        this.activeEffects.clear();\r\n    }\r\n} ","/**\r\n * TrailSystem - Manages trail components for entities\r\n * \r\n * Handles updating all trail components and their rendering.\r\n */\r\n\r\nimport { System } from '../../core/system.js';\r\n\r\nexport class TrailSystem extends System {\r\n    /**\r\n     * Create a new trail system\r\n     */\r\n    constructor(world) {\r\n        super(world);\r\n        this.requiredComponents = ['TrailComponent', 'TransformComponent'];\r\n        this.priority = 60; // Run after movement but before rendering\r\n        \r\n        // Track trail components by entity ID\r\n        this.trails = new Map();\r\n        \r\n        // Debug\r\n        console.log(\"Trail system initialized\");\r\n    }\r\n    \r\n    /**\r\n     * Register a trail with the system\r\n     * @param {string} entityId ID of the entity\r\n     * @param {TrailComponent} trailComponent Trail component to register\r\n     */\r\n    registerTrail(entityId, trailComponent) {\r\n        this.trails.set(entityId, trailComponent);\r\n        console.log(`Registered trail for entity ${entityId}`);\r\n    }\r\n    \r\n    /**\r\n     * Unregister a trail from the system\r\n     * @param {string} entityId ID of the entity\r\n     */\r\n    unregisterTrail(entityId) {\r\n        this.trails.delete(entityId);\r\n    }\r\n    \r\n    /**\r\n     * Process a single entity with a trail component\r\n     * @param {Entity} entity Entity to process\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    processEntity(entity, deltaTime) {\r\n        // Get trail component\r\n        const trail = entity.getComponent('TrailComponent');\r\n        if (!trail) return;\r\n        \r\n        // Update trail\r\n        trail.update(deltaTime);\r\n    }\r\n    \r\n    /**\r\n     * Update all trails\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Process all entities with trail components through the standard system method\r\n        super.update(deltaTime);\r\n        \r\n        // Extra manual processing for any trails registered manually\r\n        // This handles trails that might not be properly set up as components\r\n        for (const [entityId, trail] of this.trails.entries()) {\r\n            if (trail && !trail.entity) {\r\n                // This is a manually registered trail without an entity\r\n                // Try to get the entity from the world\r\n                const entity = this.world.getEntity(entityId);\r\n                if (entity) {\r\n                    // Manually update the trail with the entity's transform\r\n                    const transform = entity.getComponent('TransformComponent');\r\n                    if (transform) {\r\n                        trail.update(deltaTime);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clean up when system is disabled\r\n     */\r\n    onDisabled() {\r\n        // Clean up all trails (best effort)\r\n        for (const trail of this.trails.values()) {\r\n            if (trail && trail.onDetached) {\r\n                trail.onDetached();\r\n            }\r\n        }\r\n        \r\n        // Clear trails map\r\n        this.trails.clear();\r\n    }\r\n} ","/**\r\n * Generic object pool for managing reusable objects\r\n * \r\n * This class provides a way to reuse objects instead of creating and destroying them,\r\n * which improves performance by reducing garbage collection.\r\n */\r\nexport class ObjectPool {\r\n    /**\r\n     * Create a new ObjectPool\r\n     * @param {Function} createFn - Factory function to create new instances\r\n     * @param {Function} resetFn - Function to reset an object to its initial state\r\n     * @param {number} initialSize - Initial size of the pool\r\n     * @param {number} expandSize - Number of objects to add when the pool is empty\r\n     */\r\n    constructor(createFn, resetFn, initialSize = 20, expandSize = 10) {\r\n        this.createFn = createFn;\r\n        this.resetFn = resetFn;\r\n        this.expandSize = expandSize;\r\n        this.pool = [];\r\n        this.active = new Set();\r\n        this._hits = 0;\r\n        this._misses = 0;\r\n        \r\n        // Pre-populate the pool with initial objects\r\n        this.expand(initialSize);\r\n        \r\n        console.log(`ObjectPool created with ${initialSize} objects`);\r\n    }\r\n    \r\n    /**\r\n     * Get an object from the pool or create a new one if the pool is empty\r\n     * @returns {Object} An object from the pool\r\n     */\r\n    get() {\r\n        let object;\r\n        \r\n        // If pool is empty, expand it\r\n        if (this.pool.length === 0) {\r\n            console.log(`Pool empty, expanding by ${this.expandSize} objects`);\r\n            this.expand(this.expandSize);\r\n            this._misses++;\r\n        }\r\n        \r\n        // Get an object from the pool\r\n        object = this.pool.pop();\r\n        this._hits++;\r\n        \r\n        // Add to active set\r\n        this.active.add(object);\r\n        \r\n        if (window.__perf) {\r\n            // Aggregate across pools by summing\r\n            const prev = window.__perf.pools || { hits: 0, misses: 0 };\r\n            window.__perf.pools = {\r\n                hits: (prev.hits || 0) + 1,\r\n                misses: prev.misses || 0\r\n            };\r\n        }\r\n        \r\n        return object;\r\n    }\r\n    \r\n    /**\r\n     * Return an object to the pool\r\n     * @param {Object} object - Object to return to the pool\r\n     */\r\n    release(object) {\r\n        // Skip if object is not in active set\r\n        if (!this.active.has(object)) {\r\n            return;\r\n        }\r\n        \r\n        // Reset the object\r\n        this.resetFn(object);\r\n        \r\n        // Remove from active set\r\n        this.active.delete(object);\r\n        \r\n        // Add back to pool\r\n        this.pool.push(object);\r\n    }\r\n    \r\n    /**\r\n     * Expand the pool by creating new objects\r\n     * @param {number} count - Number of objects to add to the pool\r\n     */\r\n    expand(count) {\r\n        for (let i = 0; i < count; i++) {\r\n            const object = this.createFn();\r\n            this.pool.push(object);\r\n        }\r\n        if (window.__perf) {\r\n            const prev = window.__perf.pools || { hits: 0, misses: 0 };\r\n            window.__perf.pools = {\r\n                hits: prev.hits || 0,\r\n                misses: (prev.misses || 0) + count\r\n            };\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Get the number of available objects in the pool\r\n     * @returns {number} Count of available objects\r\n     */\r\n    availableCount() {\r\n        return this.pool.length;\r\n    }\r\n    \r\n    /**\r\n     * Get the number of active objects from this pool\r\n     * @returns {number} Count of active objects\r\n     */\r\n    activeCount() {\r\n        return this.active.size;\r\n    }\r\n    \r\n    /**\r\n     * Release all active objects back to the pool\r\n     */\r\n    releaseAll() {\r\n        // Create a copy of the active set to avoid modification during iteration\r\n        const activeObjects = Array.from(this.active);\r\n        \r\n        // Release each active object\r\n        for (const object of activeObjects) {\r\n            this.release(object);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Clear the pool and dispose all objects\r\n     * @param {Function} disposeFn - Function to dispose an object\r\n     */\r\n    dispose(disposeFn) {\r\n        // Dispose all objects in the pool\r\n        if (disposeFn) {\r\n            // Dispose active objects first\r\n            for (const object of this.active) {\r\n                disposeFn(object);\r\n            }\r\n            \r\n            // Then dispose pooled objects\r\n            for (const object of this.pool) {\r\n                disposeFn(object);\r\n            }\r\n        }\r\n        \r\n        // Clear the pool and active set\r\n        this.active.clear();\r\n        this.pool = [];\r\n    }\r\n} ","/**\r\n * Projectile Pool Manager\r\n * \r\n * Manages pools of projectiles, muzzle flashes, and trails for the combat system.\r\n * This reduces garbage collection by reusing objects instead of creating new ones.\r\n */\r\n\r\nimport { ObjectPool } from './ObjectPool.js';\r\nimport * as THREE from 'three';\r\n\r\nexport class ProjectilePoolManager {\r\n    /**\r\n     * Create a new ProjectilePoolManager\r\n     * @param {THREE.Scene} scene - The scene to add projectiles to\r\n     * @param {object} sharedAssets - An object containing pre-warmed materials and pre-created geometries\r\n     */\r\n    constructor(scene, sharedAssets) {\r\n        this.scene = scene;\r\n        this.sharedAssets = sharedAssets;\r\n\r\n        // Assign geometries from sharedAssets\r\n        this.projectileGeometry = this.sharedAssets.projectileGeometry;\r\n        this.projectileGlowGeometry = this.sharedAssets.projectileGlowGeometry;\r\n        this.muzzleFlashGeometry = this.sharedAssets.muzzleFlashGeometry;\r\n        this.trailParticleGeometries = this.sharedAssets.trailParticleGeometries;\r\n        this.tracerGeometry = this.sharedAssets.tracerGeometry;\r\n\r\n        // Assign materials from sharedAssets\r\n        this.projectileMaterial = this.sharedAssets.projectileMaterial;\r\n        this.projectileGlowMaterial = this.sharedAssets.projectileGlowMaterial;\r\n        this.trailParticleMaterial = this.sharedAssets.trailParticleMaterial;\r\n        this.muzzleFlashMaterial = this.sharedAssets.muzzleFlashMaterial;\r\n        this.tracerLineMaterial = this.sharedAssets.tracerLineMaterial;\r\n        this.explosionParticleMaterial = this.sharedAssets.explosionParticleMaterial; \r\n        \r\n        // Populate window.game with these shared assets (for legacy access if needed)\r\n        this.populateWindowGameWithSharedAssets();\r\n        \r\n        // Create object pools using these assets\r\n        this.initializePools();\r\n        \r\n        console.log(\"ProjectilePoolManager initialized using pre-warmed shared assets and pools\");\r\n    }\r\n\r\n    /**\r\n     * Populate window.game with references to the shared assets for global/legacy access.\r\n     */\r\n    populateWindowGameWithSharedAssets() {\r\n        if (!window.game) window.game = {};\r\n        \r\n        // Geometries\r\n        window.game.projectileGeometry = this.projectileGeometry;\r\n        window.game.projectileGlowGeometry = this.projectileGlowGeometry;\r\n        window.game.muzzleFlashGeometry = this.muzzleFlashGeometry;\r\n        window.game.trailParticleGeometries = this.trailParticleGeometries;\r\n        window.game.tracerGeometry = this.tracerGeometry;\r\n        \r\n        // Materials\r\n        window.game.projectileMaterial = this.projectileMaterial;\r\n        window.game.projectileGlowMaterial = this.projectileGlowMaterial;\r\n        window.game.trailParticleMaterial = this.trailParticleMaterial;\r\n        window.game.muzzleFlashMaterial = this.muzzleFlashMaterial;\r\n        window.game.tracerLineMaterial = this.tracerLineMaterial;\r\n        window.game.explosionParticleMaterial = this.explosionParticleMaterial;\r\n    }\r\n    \r\n    /**\r\n     * Initialize the object pools\r\n     */\r\n    initializePools() {\r\n        // Initialize projectile pool\r\n        this.projectilePool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create projectile mesh with glow as child\r\n                const projectile = new THREE.Mesh(this.projectileGeometry, this.projectileMaterial.clone());\r\n                const glowMesh = new THREE.Mesh(this.projectileGlowGeometry, this.projectileGlowMaterial.clone());\r\n                projectile.add(glowMesh);\r\n                \r\n                // Set up userData to track state\r\n                projectile.userData = {\r\n                    isProjectile: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    glowMesh: glowMesh\r\n                };\r\n                \r\n                return projectile;\r\n            },\r\n            // Reset function\r\n            (projectile) => {\r\n                // Reset position, velocity and visibility\r\n                projectile.position.set(0, 0, 0);\r\n                projectile.rotation.set(0, 0, 0);\r\n                projectile.scale.set(1, 1, 1);\r\n                projectile.visible = false;\r\n                \r\n                // Clean up any lingering references\r\n                projectile.userData.active = false;\r\n                projectile.userData.creationTime = 0;\r\n                projectile.userData.entityId = null;\r\n                \r\n                // If there's a trail, it will be released separately\r\n                projectile.userData.trail = null;\r\n                projectile.userData.trailParticles = null;\r\n            },\r\n            30, // Initial size\r\n            10  // Expand size\r\n        );\r\n        \r\n        // Initialize explosion pool\r\n        this.explosionPool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create particle geometry for explosion\r\n                const particleCount = 200;\r\n                const geometry = new THREE.BufferGeometry();\r\n                const positions = new Float32Array(particleCount * 3);\r\n                \r\n                // Randomize particle positions in a sphere\r\n                for (let i = 0; i < particleCount; i++) {\r\n                    const i3 = i * 3;\r\n                    positions[i3] = (Math.random() - 0.5) * 100;\r\n                    positions[i3 + 1] = (Math.random() - 0.5) * 100;\r\n                    positions[i3 + 2] = (Math.random() - 0.5) * 100;\r\n                }\r\n                \r\n                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\r\n                \r\n                // Create bright material with additive blending for glow effect\r\n                const material = this.explosionParticleMaterial.clone();\r\n                \r\n                // Create particle system\r\n                const explosion = new THREE.Points(geometry, material);\r\n                \r\n                // Set up userData to track state\r\n                explosion.userData = {\r\n                    isExplosion: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    startTime: 0,\r\n                    duration: 1000, // Default duration\r\n                    particleCount: particleCount\r\n                };\r\n                \r\n                return explosion;\r\n            },\r\n            // Reset function\r\n            (explosion) => {\r\n                // Reset position and visibility\r\n                explosion.position.set(0, 0, 0);\r\n                explosion.visible = false;\r\n                \r\n                // Reset material opacity\r\n                explosion.material.opacity = 1.0;\r\n                \r\n                // Reset animation state\r\n                explosion.userData.active = false;\r\n                explosion.userData.startTime = 0;\r\n                \r\n                // Reset particle positions to initial random state\r\n                const positions = explosion.geometry.attributes.position.array;\r\n                const particleCount = explosion.userData.particleCount;\r\n                for (let i = 0; i < particleCount; i++) {\r\n                    const i3 = i * 3;\r\n                    positions[i3] = (Math.random() - 0.5) * 100;\r\n                    positions[i3 + 1] = (Math.random() - 0.5) * 100;\r\n                    positions[i3 + 2] = (Math.random() - 0.5) * 100;\r\n                }\r\n                explosion.geometry.attributes.position.needsUpdate = true;\r\n            },\r\n            10, // Initial size\r\n            5   // Expand size\r\n        );\r\n        \r\n        // Initialize muzzle flash pool\r\n        this.muzzleFlashPool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create cone mesh for muzzle flash\r\n                const muzzleFlash = new THREE.Mesh(this.muzzleFlashGeometry, this.muzzleFlashMaterial.clone());\r\n                \r\n                // Set up userData to track state\r\n                muzzleFlash.userData = {\r\n                    isMuzzleFlash: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    startTime: 0,\r\n                    flashLight: null\r\n                };\r\n                \r\n                // Create a point light that will be attached to the flash\r\n                const flashLight = new THREE.PointLight(0x00ffff, 200, 10, 2);\r\n                flashLight.visible = false;\r\n                this._addToScene(flashLight);\r\n                \r\n                // Store reference to light\r\n                muzzleFlash.userData.flashLight = flashLight;\r\n                \r\n                return muzzleFlash;\r\n            },\r\n            // Reset function\r\n            (muzzleFlash) => {\r\n                // Reset position, scale and visibility\r\n                muzzleFlash.position.set(0, 0, 0);\r\n                muzzleFlash.rotation.set(0, 0, 0);\r\n                muzzleFlash.scale.set(1, 1, 1);\r\n                muzzleFlash.visible = false;\r\n                \r\n                // Reset material opacity\r\n                muzzleFlash.material.opacity = 0.7;\r\n                \r\n                // Reset flash light\r\n                const flashLight = muzzleFlash.userData.flashLight;\r\n                if (flashLight) {\r\n                    flashLight.position.set(0, 0, 0);\r\n                    flashLight.intensity = 200;\r\n                    flashLight.visible = false;\r\n                }\r\n                \r\n                // Reset state\r\n                muzzleFlash.userData.active = false;\r\n                muzzleFlash.userData.startTime = 0;\r\n            },\r\n            20, // Initial size\r\n            5   // Expand size\r\n        );\r\n        \r\n        // Initialize trail container pool\r\n        this.trailContainerPool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create container for trail particles\r\n                const trailContainer = new THREE.Object3D();\r\n                \r\n                // Set up userData to track state\r\n                trailContainer.userData = {\r\n                    isTrail: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    particles: []\r\n                };\r\n                \r\n                return trailContainer;\r\n            },\r\n            // Reset function\r\n            (trailContainer) => {\r\n                // Reset position\r\n                trailContainer.position.set(0, 0, 0);\r\n                trailContainer.rotation.set(0, 0, 0);\r\n                trailContainer.visible = false;\r\n                \r\n                // Reset state\r\n                trailContainer.userData.active = false;\r\n                trailContainer.userData.parentProjectile = null;\r\n                \r\n                // Note: Trail particles are handled separately\r\n            },\r\n            30, // Initial size\r\n            10  // Expand size\r\n        );\r\n        \r\n        // Initialize trail particle pool\r\n        this.trailParticlePool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create a particle with default size (will be updated when used)\r\n                const particle = new THREE.Mesh(\r\n                    this.trailParticleGeometries[0],\r\n                    this.trailParticleMaterial.clone()\r\n                );\r\n                \r\n                // Set up userData to track state\r\n                particle.userData = {\r\n                    isTrailParticle: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    sizeIndex: 0,\r\n                    initialOffset: new THREE.Vector3()\r\n                };\r\n                \r\n                return particle;\r\n            },\r\n            // Reset function\r\n            (particle) => {\r\n                // Reset position and visibility\r\n                particle.position.set(0, 0, 0);\r\n                particle.visible = false;\r\n                \r\n                // Reset material\r\n                particle.material.opacity = 0.9;\r\n                \r\n                // Reset state\r\n                particle.userData.active = false;\r\n                particle.userData.sizeIndex = 0;\r\n                particle.userData.initialOffset.set(0, 0, 0);\r\n                particle.userData.initialOpacity = 0.9;\r\n            },\r\n            600, // Initial size (20 trails * 30 particles per trail)\r\n            100  // Expand size\r\n        );\r\n        \r\n        // Initialize tracer pool\r\n        this.tracerPool = new ObjectPool(\r\n            // Create function\r\n            () => {\r\n                // Create tracer line\r\n                const tracer = new THREE.Line(\r\n                    this.tracerGeometry.clone(),\r\n                    this.tracerLineMaterial.clone()\r\n                );\r\n                \r\n                // Set up userData to track state\r\n                tracer.userData = {\r\n                    isTracer: true,\r\n                    active: false,\r\n                    pooled: true,\r\n                    startTime: 0\r\n                };\r\n                \r\n                return tracer;\r\n            },\r\n            // Reset function\r\n            (tracer) => {\r\n                // Reset position and visibility\r\n                tracer.position.set(0, 0, 0);\r\n                tracer.visible = false;\r\n                \r\n                // Reset material\r\n                tracer.material.opacity = 0.6;\r\n                \r\n                // Reset state\r\n                tracer.userData.active = false;\r\n                tracer.userData.startTime = 0;\r\n            },\r\n            20, // Initial size\r\n            5   // Expand size\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * Get a projectile from the pool\r\n     * @returns {THREE.Mesh} A projectile mesh\r\n     */\r\n    getProjectile() {\r\n        const projectile = this.projectilePool.get();\r\n        projectile.visible = true;\r\n        projectile.userData.active = true;\r\n        projectile.userData.creationTime = performance.now();\r\n        \r\n        // Add to scene if not already there\r\n        if (!projectile.parent) {\r\n            this._addToScene(projectile);\r\n        }\r\n        \r\n        return projectile;\r\n    }\r\n    \r\n    /**\r\n     * Get a muzzle flash from the pool\r\n     * @returns {THREE.Mesh} A muzzle flash mesh\r\n     */\r\n    getMuzzleFlash() {\r\n        const muzzleFlash = this.muzzleFlashPool.get();\r\n        muzzleFlash.visible = true;\r\n        muzzleFlash.userData.active = true;\r\n        muzzleFlash.userData.startTime = performance.now();\r\n        \r\n        // Set up flash light\r\n        const flashLight = muzzleFlash.userData.flashLight;\r\n        if (flashLight) {\r\n            flashLight.visible = true;\r\n            flashLight.intensity = 200;\r\n        }\r\n        \r\n        // Add to scene if not already there\r\n        if (!muzzleFlash.parent) {\r\n            this._addToScene(muzzleFlash);\r\n        }\r\n        \r\n        return muzzleFlash;\r\n    }\r\n    \r\n    /**\r\n     * Get a trail container from the pool\r\n     * @returns {THREE.Object3D} A trail container\r\n     */\r\n    getTrailContainer() {\r\n        const trailContainer = this.trailContainerPool.get();\r\n        trailContainer.visible = true;\r\n        trailContainer.userData.active = true;\r\n        \r\n        return trailContainer;\r\n    }\r\n    \r\n    /**\r\n     * Get a trail particle from the pool\r\n     * @param {number} sizeIndex - Index of the size to use\r\n     * @returns {THREE.Mesh} A trail particle mesh\r\n     */\r\n    getTrailParticle(sizeIndex = 0) {\r\n        const particle = this.trailParticlePool.get();\r\n        particle.visible = true;\r\n        particle.userData.active = true;\r\n        particle.userData.sizeIndex = sizeIndex;\r\n        \r\n        // Use the appropriate geometry for this particle size\r\n        if (sizeIndex >= 0 && sizeIndex < this.trailParticleGeometries.length) {\r\n            particle.geometry = this.trailParticleGeometries[sizeIndex];\r\n        }\r\n        \r\n        return particle;\r\n    }\r\n    \r\n    /**\r\n     * Get a tracer from the pool\r\n     * @returns {THREE.Line} A tracer line\r\n     */\r\n    getTracer() {\r\n        const tracer = this.tracerPool.get();\r\n        tracer.visible = true;\r\n        tracer.userData.active = true;\r\n        tracer.userData.startTime = performance.now();\r\n        \r\n        // Add to scene if not already there\r\n        if (!tracer.parent) {\r\n            this._addToScene(tracer);\r\n        }\r\n        \r\n        return tracer;\r\n    }\r\n    \r\n    /**\r\n     * Get an explosion effect from the pool\r\n     * @param {THREE.Vector3} position Position for the explosion\r\n     * @param {number} duration Duration of the explosion in milliseconds\r\n     * @returns {THREE.Points} An explosion effect\r\n     */\r\n    getExplosion(position, duration = 1000) {\r\n        const explosion = this.explosionPool.get();\r\n        explosion.position.copy(position);\r\n        explosion.visible = true;\r\n        explosion.userData.active = true;\r\n        explosion.userData.startTime = Date.now();\r\n        explosion.userData.duration = duration;\r\n        \r\n        // Add to scene if not already there\r\n        if (!explosion.parent) {\r\n            this._addToScene(explosion);\r\n        }\r\n        \r\n        return explosion;\r\n    }\r\n    \r\n    /**\r\n     * Release a projectile back to the pool\r\n     * @param {THREE.Mesh} projectile - The projectile to release\r\n     */\r\n    releaseProjectile(projectile) {\r\n        // Skip if not a valid projectile\r\n        if (!projectile || !projectile.userData || !projectile.userData.isProjectile) {\r\n            return;\r\n        }\r\n        \r\n        // Release the trail if it exists\r\n        if (projectile.userData.trail) {\r\n            this.releaseTrail(projectile.userData.trail);\r\n            projectile.remove(projectile.userData.trail);\r\n            projectile.userData.trail = null;\r\n            projectile.userData.trailParticles = null;\r\n        }\r\n        \r\n        // Remove from scene to ensure it's not rendered\r\n        if (projectile.parent) {\r\n            this._removeFromParent(projectile);\r\n        }\r\n        \r\n        // Return to pool\r\n        this.projectilePool.release(projectile);\r\n    }\r\n    \r\n    /**\r\n     * Release a muzzle flash back to the pool\r\n     * @param {THREE.Mesh} muzzleFlash - The muzzle flash to release\r\n     */\r\n    releaseMuzzleFlash(muzzleFlash) {\r\n        // Skip if not a valid muzzle flash\r\n        if (!muzzleFlash || !muzzleFlash.userData || !muzzleFlash.userData.isMuzzleFlash) {\r\n            return;\r\n        }\r\n        \r\n        // Hide the flash light\r\n        const flashLight = muzzleFlash.userData.flashLight;\r\n        if (flashLight) {\r\n            flashLight.visible = false;\r\n        }\r\n        \r\n        // Remove from scene\r\n        if (muzzleFlash.parent) {\r\n            this._removeFromParent(muzzleFlash);\r\n        }\r\n        \r\n        // Return to pool\r\n        this.muzzleFlashPool.release(muzzleFlash);\r\n    }\r\n    \r\n    /**\r\n     * Release a trail back to the pool\r\n     * @param {THREE.Object3D} trail - The trail container to release\r\n     */\r\n    releaseTrail(trail) {\r\n        // Skip if not a valid trail\r\n        if (!trail || !trail.userData || !trail.userData.isTrail) {\r\n            return;\r\n        }\r\n        \r\n        // Release all particles\r\n        if (trail.userData.particles) {\r\n            for (const particle of trail.userData.particles) {\r\n                if (particle) {\r\n                    // Remove from trail container\r\n                    trail.remove(particle);\r\n                    // Release back to particle pool\r\n                    this.releaseTrailParticle(particle);\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Clear particles array\r\n        trail.userData.particles = [];\r\n        \r\n        // Return to pool\r\n        this.trailContainerPool.release(trail);\r\n    }\r\n    \r\n    /**\r\n     * Release a trail particle back to the pool\r\n     * @param {THREE.Mesh} particle - The trail particle to release\r\n     */\r\n    releaseTrailParticle(particle) {\r\n        // Skip if not a valid trail particle\r\n        if (!particle || !particle.userData || !particle.userData.isTrailParticle) {\r\n            return;\r\n        }\r\n        \r\n        // Return to pool\r\n        this.trailParticlePool.release(particle);\r\n    }\r\n    \r\n    /**\r\n     * Release a tracer back to the pool\r\n     * @param {THREE.Line} tracer - The tracer to release\r\n     */\r\n    releaseTracer(tracer) {\r\n        // Skip if not a valid tracer\r\n        if (!tracer || !tracer.userData || !tracer.userData.isTracer) {\r\n            return;\r\n        }\r\n        \r\n        // Remove from scene\r\n        if (tracer.parent) {\r\n            this._removeFromParent(tracer);\r\n        }\r\n        \r\n        // Return to pool\r\n        this.tracerPool.release(tracer);\r\n    }\r\n    \r\n    /**\r\n     * Release an explosion back to the pool\r\n     * @param {THREE.Points} explosion - The explosion to release\r\n     */\r\n    releaseExplosion(explosion) {\r\n        // Skip if not a valid explosion\r\n        if (!explosion || !explosion.userData || !explosion.userData.isExplosion) {\r\n            return;\r\n        }\r\n        \r\n        // Remove from scene\r\n        if (explosion.parent) {\r\n            this._removeFromParent(explosion);\r\n        }\r\n        \r\n        // Return to pool\r\n        this.explosionPool.release(explosion);\r\n    }\r\n    \r\n    /**\r\n     * Update all active objects from the pools\r\n     * @param {number} deltaTime - Time since last update\r\n     */\r\n    update(deltaTime) {\r\n        this.updateMuzzleFlashes(deltaTime);\r\n        this.updateTracers(deltaTime);\r\n        this.updateExplosions(deltaTime);\r\n    }\r\n    \r\n    /**\r\n     * Update all active muzzle flashes\r\n     * @param {number} deltaTime - Time since last update\r\n     */\r\n    updateMuzzleFlashes(deltaTime) {\r\n        // Check all active muzzle flashes\r\n        for (const muzzleFlash of this.muzzleFlashPool.active) {\r\n            const elapsed = performance.now() - muzzleFlash.userData.startTime;\r\n            const burstDuration = 70; // Same as in the original code\r\n            const progress = elapsed / burstDuration;\r\n            \r\n            if (progress >= 1) {\r\n                // Animation complete, release back to pool\r\n                this.releaseMuzzleFlash(muzzleFlash);\r\n            } else {\r\n                // Continue animation\r\n                const travelProgress = Math.min(progress * 2.5, 1);\r\n                const travelDistance = 300;\r\n                \r\n                // Update position if initialPosition is set\r\n                if (muzzleFlash.userData.initialPosition && muzzleFlash.userData.direction) {\r\n                    const newPosition = muzzleFlash.userData.initialPosition.clone().add(\r\n                        muzzleFlash.userData.direction.clone().multiplyScalar(travelDistance * travelProgress)\r\n                    );\r\n                    muzzleFlash.position.copy(newPosition);\r\n                    \r\n                    // Update the flash light position too\r\n                    if (muzzleFlash.userData.flashLight) {\r\n                        muzzleFlash.userData.flashLight.position.copy(newPosition);\r\n                    }\r\n                }\r\n                \r\n                // Fade out\r\n                muzzleFlash.material.opacity = 0.7 * (1 - progress);\r\n                \r\n                // Fade light\r\n                if (muzzleFlash.userData.flashLight) {\r\n                    muzzleFlash.userData.flashLight.intensity = 200 * (1 - progress * 3);\r\n                }\r\n                \r\n                // Stretch effect\r\n                const stretchFactor = 1 + progress * 1.5;\r\n                muzzleFlash.scale.set(1, 1, stretchFactor);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update all active tracers\r\n     * @param {number} deltaTime - Time since last update\r\n     */\r\n    updateTracers(deltaTime) {\r\n        // Check all active tracers\r\n        for (const tracer of this.tracerPool.active) {\r\n            const elapsed = performance.now() - tracer.userData.startTime;\r\n            const fadeSpeed = 1.5; // From original code\r\n            const opacity = Math.max(0, tracer.material.opacity - fadeSpeed * 0.016);\r\n            \r\n            if (opacity <= 0) {\r\n                // Fully faded, release back to pool\r\n                this.releaseTracer(tracer);\r\n            } else {\r\n                // Update opacity\r\n                tracer.material.opacity = opacity;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update all active explosions\r\n     * @param {number} deltaTime - Time since last update\r\n     */\r\n    updateExplosions(deltaTime) {\r\n        // Check all active explosions\r\n        for (const explosion of this.explosionPool.active) {\r\n            const elapsed = Date.now() - explosion.userData.startTime;\r\n            const duration = explosion.userData.duration;\r\n            const progress = elapsed / duration;\r\n            \r\n            if (progress >= 1) {\r\n                // Animation complete, release back to pool\r\n                this.releaseExplosion(explosion);\r\n            } else {\r\n                // Continue animation - expand particles\r\n                const positions = explosion.geometry.attributes.position.array;\r\n                const particleCount = explosion.userData.particleCount;\r\n                \r\n                for (let i = 0; i < particleCount; i++) {\r\n                    const i3 = i * 3;\r\n                    const x = positions[i3] * (1 + progress * 5);\r\n                    const y = positions[i3 + 1] * (1 + progress * 5);\r\n                    const z = positions[i3 + 2] * (1 + progress * 5);\r\n                    \r\n                    explosion.geometry.attributes.position.array[i3] = x;\r\n                    explosion.geometry.attributes.position.array[i3 + 1] = y;\r\n                    explosion.geometry.attributes.position.array[i3 + 2] = z;\r\n                }\r\n                \r\n                explosion.geometry.attributes.position.needsUpdate = true;\r\n                \r\n                // Fade out\r\n                explosion.material.opacity = 1 - progress;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Dispose all pools and shared assets\r\n     */\r\n    dispose() {\r\n        // Dispose shared geometries\r\n        this.projectileGeometry.dispose();\r\n        this.projectileGlowGeometry.dispose();\r\n        this.muzzleFlashGeometry.dispose();\r\n        this.tracerGeometry.dispose();\r\n        \r\n        this.trailParticleGeometries.forEach(geometry => geometry.dispose());\r\n        \r\n        // Dispose shared materials\r\n        this.projectileMaterial.dispose();\r\n        this.projectileGlowMaterial.dispose();\r\n        this.trailParticleMaterial.dispose();\r\n        this.muzzleFlashMaterial.dispose();\r\n        this.tracerLineMaterial.dispose();\r\n        \r\n        // Dispose pools with custom dispose functions\r\n        this.projectilePool.dispose(projectile => {\r\n            // Remove from scene\r\n            if (projectile.parent) this._removeFromParent(projectile);\r\n            \r\n            // Clean up materials\r\n            if (projectile.userData.glowMesh && projectile.userData.glowMesh.material) {\r\n                projectile.userData.glowMesh.material.dispose();\r\n            }\r\n            \r\n            // Materials are cloned per projectile\r\n            if (projectile.material) projectile.material.dispose();\r\n        });\r\n        \r\n        this.muzzleFlashPool.dispose(muzzleFlash => {\r\n            // Remove from scene\r\n            if (muzzleFlash.parent) this._removeFromParent(muzzleFlash);\r\n            \r\n            // Remove flash light\r\n            if (muzzleFlash.userData.flashLight) {\r\n                if (muzzleFlash.userData.flashLight.parent) {\r\n                    muzzleFlash.userData.flashLight.parent.remove(muzzleFlash.userData.flashLight);\r\n                }\r\n            }\r\n            \r\n            // Materials are cloned per muzzle flash\r\n            if (muzzleFlash.material) muzzleFlash.material.dispose();\r\n        });\r\n        \r\n        this.trailContainerPool.dispose(trail => {\r\n            // Remove from scene or parent\r\n            if (trail.parent) this._removeFromParent(trail);\r\n        });\r\n        \r\n        this.trailParticlePool.dispose(particle => {\r\n            // Remove from parent if still attached\r\n            if (particle.parent) this._removeFromParent(particle);\r\n            \r\n            // Materials are cloned per particle\r\n            if (particle.material) particle.material.dispose();\r\n        });\r\n        \r\n        this.tracerPool.dispose(tracer => {\r\n            // Remove from scene\r\n            if (tracer.parent) this._removeFromParent(tracer);\r\n            \r\n            // Materials are cloned per tracer\r\n            if (tracer.material) tracer.material.dispose();\r\n        });\r\n        \r\n        console.log(\"ProjectilePoolManager disposed all pools and shared assets\");\r\n    }\r\n\r\n    // --- Renderer facade helpers ---\r\n    _getRenderer() {\r\n        return (window.game && window.game.renderer) ? window.game.renderer : null;\r\n    }\r\n\r\n    _addToScene(object) {\r\n        const renderer = this._getRenderer();\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => renderer.add(object));\r\n        } else if (this.scene && typeof this.scene.add === 'function') {\r\n            this.scene.add(object);\r\n        }\r\n    }\r\n\r\n    _removeFromScene(object) {\r\n        const renderer = this._getRenderer();\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => this.scene.remove(object));\r\n        } else if (this.scene && typeof this.scene.remove === 'function') {\r\n            this.scene.remove(object);\r\n        }\r\n    }\r\n\r\n    _removeFromParent(object) {\r\n        if (!object || !object.parent) return;\r\n        if (object.parent === this.scene) {\r\n            this._removeFromScene(object);\r\n        } else if (typeof object.parent.remove === 'function') {\r\n            object.parent.remove(object);\r\n        }\r\n    }\r\n} ","/**\r\n * Combat module - Handles all combat-related functionality\r\n * \r\n * This module manages particle cannon firing, projectile creation, and combat logic.\r\n * \r\n * IMPORTANT: As of the latest update, this module directly handles all enemy destruction\r\n * when projectiles are fired. The collision detection and enemy destruction functionality\r\n * previously handled by CollisionSystem and ParticleCannonSystem has been moved here for\r\n * reliability, as there were issues with the event-based approach.\r\n */\r\n\r\nimport { World } from '../core/world.js';\r\nimport { CombatSystem } from '../systems/combat/combatSystem.js';\r\nimport { EnemySystem } from '../systems/combat/enemySystem.js';\r\nimport { RenderSystem } from '../systems/rendering/renderSystem.js';\r\nimport { CollisionSystem } from '../systems/physics/collisionSystem.js'; // Import CollisionSystem\r\nimport { VisualEffectsSystem } from '../systems/rendering/visualEffectsSystem.js'; // Import VisualEffectsSystem\r\nimport { TrailSystem } from '../systems/rendering/trailSystem.js';\r\nimport { ProjectilePoolManager } from './pooling/ProjectilePoolManager.js'; // Import our new pooling system\r\nimport * as THREE from 'three';\r\n\r\nexport class Combat {\r\n    constructor(scene, spaceship) {\r\n        console.log(\"Initializing combat system\");\r\n        this.scene = scene;\r\n        this.spaceship = spaceship;\r\n        this.projectiles = [];\r\n        this.projectileLifetime = 2000; // milliseconds\r\n        \r\n        // Tuned these parameters for better gameplay\r\n        this.fireRate = 3; // shots per second\r\n        this.projectileSpeed = 30000; // Base speed units per frame (will be normalized)\r\n        \r\n        // Track the last time we fired for rate limiting\r\n        this.lastFireTime = 0;\r\n        \r\n        // Reference size for spread calculation\r\n        this.aimingSpread = 0.05;\r\n        \r\n        // Weapon properties\r\n        this.isFiring = false;\r\n        this.cooldown = 1000 / this.fireRate; // milliseconds between shots\r\n        \r\n        // Combat properties\r\n        this.projectileDamage = 20; // Standard damage per projectile hit\r\n        \r\n        // 1. Initialize and pre-compile template materials\r\n        this.initializeTemplateMaterials();\r\n        \r\n        // 2. Pre-create and cache geometries (and link materials to window.game)\r\n        this.precreateGeometries();\r\n        \r\n        // 3. Initialize object pooling system with pre-warmed assets\r\n        this.poolManager = new ProjectilePoolManager(scene, {\r\n            projectileMaterial: this.projectileMaterial,\r\n            projectileGlowMaterial: this.projectileGlowMaterial,\r\n            trailParticleMaterial: this.trailParticleMaterial, // Will be red, but trail system is removed\r\n            muzzleFlashMaterial: this.muzzleFlashMaterial,\r\n            tracerLineMaterial: this.tracerLineMaterial, // For aiming line\r\n            explosionParticleMaterial: this.explosionParticleMaterial, // For impacts\r\n            \r\n            projectileGeometry: window.game.projectileGeometry,\r\n            projectileGlowGeometry: window.game.projectileGlowGeometry,\r\n            muzzleFlashGeometry: window.game.muzzleFlashGeometry,\r\n            trailParticleGeometries: window.game.trailParticleGeometries,\r\n            tracerGeometry: window.game.tracerGeometry\r\n        });\r\n        console.log(\"Initialized ProjectilePoolManager for object pooling with pre-warmed assets\");\r\n        \r\n        // Initialize ECS world for advanced combat systems\r\n        // This needs to be initialized asynchronously, but constructors can't be async\r\n        // So we'll just kick off the initialization and let it complete in the background\r\n        this.initializeECSWorld();\r\n        \r\n        console.log(\"Combat systems initialized\");\r\n    }\r\n    \r\n    /**\r\n     * Initialize template materials to prevent shader compilation stutter during first fire\r\n     */\r\n    initializeTemplateMaterials() {\r\n        console.log(\"Initializing template materials for combat effects\");\r\n        \r\n        // Template for projectile material (MeshStandardMaterial) - Red Laser Bolt\r\n        this.projectileMaterial = new THREE.MeshStandardMaterial({\r\n            color: 0xff0000,\r\n            emissive: 0xff0000,\r\n            emissiveIntensity: 10, // Vibrant laser\r\n            metalness: 0.5,\r\n            roughness: 0.5\r\n        });\r\n        \r\n        // Template for projectile glow material (MeshBasicMaterial) - Red Glow\r\n        this.projectileGlowMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.5, // Softer glow\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        \r\n        // Template for trail particle material (MeshBasicMaterial) - Red (Though complex trail is removed)\r\n        this.trailParticleMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.9,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        \r\n        // Template for muzzle flash material (MeshBasicMaterial) - Red Muzzle Flash\r\n        this.muzzleFlashMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.8, // Brighter flash\r\n            blending: THREE.AdditiveBlending,\r\n            side: THREE.DoubleSide,\r\n            depthWrite: false,\r\n            wireframe: false\r\n        });\r\n        \r\n        // Template for tracer line material (LineBasicMaterial) - Red Aiming Line\r\n        this.tracerLineMaterial = new THREE.LineBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.8, // More visible aiming line\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        \r\n        // Template material for light-halo meshes (basic unlit glow)\r\n        this.pointLightMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xff0000,\r\n            transparent: true,\r\n            opacity: 0.9,\r\n            blending: THREE.AdditiveBlending,\r\n            depthWrite: false\r\n        });\r\n        \r\n        // Template for explosion particles - Red/Orange Impact\r\n        this.explosionParticleMaterial = new THREE.PointsMaterial({\r\n            color: 0xff3300, // Red-orange for impact\r\n            size: 15, // Slightly larger impact particles\r\n            transparent: true,\r\n            opacity: 1,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        \r\n        // Force material compilation by creating a small invisible mesh\r\n        // This ensures shaders are compiled immediately rather than at first fire\r\n        const dummyGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);\r\n        const sphereGeometry = new THREE.SphereGeometry(0.1, 8, 8);\r\n        const cylinderGeometry = new THREE.CylinderGeometry(0.1, 0.2, 1, 8, 1);\r\n        const pointsPositions = new Float32Array(30); // 10 points x 3 coordinates\r\n        for (let i = 0; i < 30; i++) {\r\n            pointsPositions[i] = Math.random() - 0.5;\r\n        }\r\n        const pointsGeometry = new THREE.BufferGeometry();\r\n        pointsGeometry.setAttribute('position', new THREE.BufferAttribute(pointsPositions, 3));\r\n        \r\n        // Create dummy objects using all materials that will be used in projectiles\r\n        // IMPORTANT: Use the original material instances, not clones, for pre-compilation.\r\n        const dummyProjectile = new THREE.Mesh(sphereGeometry, this.projectileMaterial);\r\n        const dummyGlow = new THREE.Mesh(sphereGeometry, this.projectileGlowMaterial);\r\n        const dummyTrail = new THREE.Mesh(sphereGeometry, this.trailParticleMaterial);\r\n        const dummyFlash = new THREE.Mesh(cylinderGeometry, this.muzzleFlashMaterial);\r\n        const dummyTracer = new THREE.Line(\r\n            new THREE.BufferGeometry().setFromPoints([\r\n                new THREE.Vector3(0, 0, 0),\r\n                new THREE.Vector3(0, 0, 1)\r\n            ]),\r\n            this.tracerLineMaterial\r\n        );\r\n        const dummyExplosion = new THREE.Points(pointsGeometry, this.explosionParticleMaterial);\r\n        \r\n        // Create a dummy trail system with multiple particles\r\n        const dummyTrailContainer = new THREE.Object3D();\r\n        for (let i = 0; i < 5; i++) {\r\n            const trailParticle = new THREE.Mesh(sphereGeometry, this.trailParticleMaterial.clone());\r\n            trailParticle.position.z = -i * 0.2;\r\n            dummyTrailContainer.add(trailParticle);\r\n        }\r\n        \r\n        // Create a temporary scene for shader compilation\r\n        const tempScene = new THREE.Scene();\r\n        \r\n        // Add all dummy objects to the temporary scene\r\n        tempScene.add(dummyProjectile);\r\n        tempScene.add(dummyGlow);\r\n        tempScene.add(dummyTrail);\r\n        tempScene.add(dummyFlash);\r\n        tempScene.add(dummyTracer);\r\n        tempScene.add(dummyTrailContainer);\r\n        tempScene.add(dummyExplosion);\r\n        \r\n        // Add to main scene temporarily for visibility checking via renderer facade\r\n        this._addToScene(dummyProjectile);\r\n        this._addToScene(dummyGlow);\r\n        this._addToScene(dummyTrail);\r\n        this._addToScene(dummyFlash);\r\n        this._addToScene(dummyTracer);\r\n        this._addToScene(dummyTrailContainer);\r\n        this._addToScene(dummyExplosion);\r\n        \r\n        // Force shader compilation using renderer.compile if available\r\n        if (window.renderer) {\r\n            console.log(\"Forcing shader compilation with renderer.compile()\");\r\n            window.renderer.compile(tempScene, this.scene.camera || { isCamera: true, matrixWorldInverse: new THREE.Matrix4() });\r\n            window.renderer.compile(this.scene, this.scene.camera || { isCamera: true, matrixWorldInverse: new THREE.Matrix4() });\r\n        } else if (window.game && window.game.renderer && window.game.renderer.renderer) {\r\n            console.log(\"Forcing shader compilation with game.renderer.renderer.compile()\");\r\n            window.game.renderer.renderer.compile(tempScene, this.scene.camera || window.game.camera || { isCamera: true, matrixWorldInverse: new THREE.Matrix4() });\r\n            window.game.renderer.renderer.compile(this.scene, this.scene.camera || window.game.camera || { isCamera: true, matrixWorldInverse: new THREE.Matrix4() });\r\n        } else {\r\n            console.warn(\"No renderer available for shader pre-compilation\");\r\n        }\r\n        \r\n        // Keep dummy objects in scene longer to ensure compilation completes\r\n        setTimeout(() => {\r\n            // Remove from scene after shader compilation is complete via renderer facade\r\n            this._removeFromScene(dummyProjectile);\r\n            this._removeFromScene(dummyGlow);\r\n            this._removeFromScene(dummyTrail);\r\n            this._removeFromScene(dummyFlash);\r\n            this._removeFromScene(dummyTracer);\r\n            this._removeFromScene(dummyTrailContainer);\r\n            this._removeFromScene(dummyExplosion);\r\n            \r\n            // Clean up temporary objects\r\n            dummyGeometry.dispose();\r\n            sphereGeometry.dispose();\r\n            cylinderGeometry.dispose();\r\n            pointsGeometry.dispose();\r\n            \r\n            // Clean up trail particles\r\n            dummyTrailContainer.children.forEach(child => {\r\n                if (child.geometry) child.geometry.dispose();\r\n                if (child.material) child.material.dispose(); // Material here is a clone, original is on this.trailParticleMaterial\r\n            });\r\n            \r\n            // Store precomputed geometries in window.game for reuse\r\n            // This part is removed as precreateGeometries() will handle setting window.game assets\r\n            // if (window.game) {\r\n            //     window.game.projectileGeometry = new THREE.SphereGeometry(1.8, 12, 12);\r\n            //     window.game.projectileGlowGeometry = new THREE.SphereGeometry(2.4, 16, 16);\r\n                \r\n            //     // Precompute trail particle geometries\r\n            //     window.game.trailParticleGeometries = [];\r\n            //     const numPoints = 20; // Same as in addProjectileTrail\r\n            //     for (let i = 0; i < numPoints; i++) {\r\n            //         const ratio = i / numPoints;\r\n            //         const size = 0.5 * (1 - ratio);\r\n            //         window.game.trailParticleGeometries[i] = new THREE.SphereGeometry(size, 8, 8);\r\n            //     }\r\n                \r\n            //     console.log(\"Stored precomputed geometries in window.game\");\r\n            // }\r\n            \r\n            console.log(\"Template materials initialized and dummy objects removed\");\r\n        }, 500); // Increased timeout to 500ms to ensure shader compilation completes\r\n    }\r\n    \r\n    /**\r\n     * Pre-create geometries that will be reused across projectiles and effects\r\n     * This prevents geometry creation during combat which can cause stutters\r\n     */\r\n    precreateGeometries() {\r\n        console.log(\"Pre-creating geometries for combat effects\");\r\n        \r\n        // Create geometries and store them on window.game for global access\r\n        if (!window.game) window.game = {};\r\n        \r\n        // Projectile geometries - Changed to a thin cylinder for laser bolt\r\n        window.game.projectileGeometry = new THREE.CylinderGeometry(0.15, 0.15, 10, 8); // Thin, 10 units long cylinder\r\n        window.game.projectileGlowGeometry = new THREE.SphereGeometry(0.8, 12, 12); // Glow radius around the bolt\r\n        \r\n        // Pre-create standard muzzle flash geometry\r\n        window.game.muzzleFlashGeometry = new THREE.CylinderGeometry(0.5, 2, 15, 12, 1, true);\r\n        window.game.muzzleFlashGeometry.rotateX(Math.PI / 2);\r\n        window.game.muzzleFlashGeometry.translate(0, 0, 15 / 2);\r\n        \r\n        // Pre-create trail particle geometries with different sizes\r\n        window.game.trailParticleGeometries = [];\r\n        const numPoints = 20; // Same as in addProjectileTrail\r\n        for (let i = 0; i < numPoints; i++) {\r\n            const ratio = i / numPoints;\r\n            const size = 0.5 * (1 - ratio); // These might be unused or repurposed for simple impact sparks\r\n            window.game.trailParticleGeometries[i] = new THREE.SphereGeometry(size, 8, 8);\r\n        }\r\n        \r\n        // Pre-create line geometry for tracers\r\n        window.game.tracerGeometry = new THREE.BufferGeometry();\r\n        const points = [0, 0, 0, 0, 0, 1]; // Will be updated at runtime\r\n        window.game.tracerGeometry.setAttribute('position', new THREE.Float32BufferAttribute(points, 3));\r\n        \r\n        // Store references to template materials (which should now be pre-warmed)\r\n        // These materials are created and warmed in initializeTemplateMaterials()\r\n        window.game.projectileMaterial = this.projectileMaterial;\r\n        window.game.projectileGlowMaterial = this.projectileGlowMaterial;\r\n        window.game.trailParticleMaterial = this.trailParticleMaterial; // Will be red\r\n        window.game.muzzleFlashMaterial = this.muzzleFlashMaterial;\r\n        window.game.tracerLineMaterial = this.tracerLineMaterial;\r\n        window.game.explosionParticleMaterial = this.explosionParticleMaterial; // Added for consistency\r\n        \r\n        console.log(\"Combat geometries pre-created successfully\");\r\n    }\r\n    \r\n    /**\r\n     * Initialize the ECS world asynchronously\r\n     * This is called from the constructor and runs in the background\r\n     */\r\n    async initializeECSWorld() {\r\n        try {\r\n            console.log(\"[COMBAT] Starting ECS world initialization...\");\r\n            \r\n            // Create a new World instance immediately to allow references\r\n            this.world = new World(window.mainMessageBus);\r\n            console.log(\"[COMBAT] Created world with messageBus: \", \r\n                        this.world.messageBus === window.mainMessageBus ? \"Using shared messageBus\" : \"Created new messageBus\");\r\n            \r\n            // Make world globally available immediately\r\n            if (window.game) {\r\n                window.game.ecsWorld = this.world;\r\n                console.log(\"[COMBAT] Made ECS world globally available via window.game.ecsWorld\");\r\n            }\r\n            \r\n            // Create player entity immediately - don't wait for full setup\r\n            await this.createPlayerReferenceEntity();\r\n            \r\n            // Continue with full world setup\r\n            await this.setupECSWorld();\r\n\r\n            // Create optimized projectile store\r\n            if (!this.world.optimizedProjectiles) {\r\n                try {\r\n                    const { OptimizedProjectileStore } = await import('../core/optimized/OptimizedProjectileStore.js');\r\n                    this.world.optimizedProjectiles = new OptimizedProjectileStore(4096);\r\n                    console.log('[COMBAT] OptimizedProjectileStore created');\r\n                } catch (e) {\r\n                    console.warn('[COMBAT] OptimizedProjectileStore unavailable:', e);\r\n                }\r\n            }\r\n            \r\n            console.log(\"[COMBAT] ECS world initialization complete\");\r\n        } catch (error) {\r\n            console.error(\"[COMBAT] Error initializing ECS world:\", error);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Set up the ECS world and register combat systems\r\n     */\r\n    async setupECSWorld() {\r\n        // Skip if world was already set up\r\n        if (this.worldInitialized) {\r\n            console.log(\"[COMBAT] World already initialized, skipping setup\");\r\n            return;\r\n        }\r\n        \r\n        // Store scene reference in world for systems that need it\r\n        this.world.scene = this.scene;\r\n        \r\n        // Log scene reference for debugging\r\n        console.log(`[COMBAT] Set scene reference in ECS world for enemy rendering:`, \r\n                   this.scene ? \"Scene available\" : \"No scene available\");\r\n        \r\n        // Register combat systems\r\n        console.log(\"[COMBAT] Registering combat systems with ECS world...\");\r\n        \r\n        try {\r\n            // Register the combat system\r\n            this.combatSystem = new CombatSystem(this.world);\r\n            this.world.registerSystem(this.combatSystem);\r\n            \r\n            // Register the enemy system\r\n            this.enemySystem = new EnemySystem(this.world);\r\n            this.world.registerSystem(this.enemySystem);\r\n            \r\n            // GLOBAL ACCESS: Make the enemy system accessible to other modules\r\n            if (window.game) {\r\n                window.game.ecsWorld = window.game.ecsWorld || {};\r\n                window.game.ecsWorld.enemySystem = this.enemySystem;\r\n                console.log(\"[COMBAT] Made enemy system globally available via window.game.ecsWorld.enemySystem\");\r\n            }\r\n            \r\n            // Register the trail system for visual effects\r\n            // Use the already imported TrailSystem class instead of dynamic import\r\n            this.trailSystem = new TrailSystem(this.world);\r\n            this.world.registerSystem(this.trailSystem);\r\n            \r\n            // Register deployable laser systems\r\n            this.deployableLaserSystem = await this.importAndRegisterSystem('../systems/weapons/deployableLaserSystem.js', 'DeployableLaserSystem');\r\n            this.world.registerSystem(this.deployableLaserSystem);\r\n\r\n            this.deploymentSystem = await this.importAndRegisterSystem('../systems/deployables/deploymentSystem.js', 'DeploymentSystem');\r\n            this.world.registerSystem(this.deploymentSystem);\r\n            \r\n            // Add trail system to window.game for global access if game object exists\r\n            if (window.game) {\r\n                window.game.trailSystem = this.trailSystem;\r\n                console.log(\"[COMBAT] Registered trail system with window.game for global access\");\r\n            }\r\n            \r\n            // Register the instanced renderer first\r\n            try {\r\n                const { InstancedRenderer } = await import('../systems/rendering/InstancedRenderer.js');\r\n                this.instancedRenderer = new InstancedRenderer(this.world, this.scene);\r\n                this.world.registerSystem(this.instancedRenderer);\r\n                console.log('[COMBAT] InstancedRenderer registered');\r\n            } catch (e) {\r\n                console.warn('[COMBAT] InstancedRenderer not available:', e);\r\n            }\r\n\r\n            // Register the render system - this is critical for making meshes visible\r\n            // Use the scene's camera reference if available\r\n            const camera = this.scene.camera;\r\n            \r\n            if (!camera) {\r\n                console.error(\"[COMBAT] No camera found on scene, enemies may not be visible\");\r\n            }\r\n            \r\n            // Log camera reference for debugging\r\n            console.log(`[COMBAT] Camera reference for RenderSystem: ${camera ? \"Available\" : \"Missing\"}`);\r\n            \r\n            // Note: We're only passing the scene and camera, not the renderer\r\n            // This avoids the issues with trying to call render() from the RenderSystem\r\n            this.renderSystem = new RenderSystem(this.world, this.scene, camera);\r\n            this.world.registerSystem(this.renderSystem);\r\n            \r\n            // Register the CollisionSystem\r\n            console.log(\"[COMBAT] Registering CollisionSystem with the world...\");\r\n            this.collisionSystem = new CollisionSystem(this.world);\r\n            this.world.registerSystem(this.collisionSystem);\r\n            console.log(\"[COMBAT] CollisionSystem registered\");\r\n            \r\n            // Register the VisualEffectsSystem\r\n            console.log(\"[COMBAT] Registering VisualEffectsSystem with the world...\");\r\n            this.visualEffectsSystem = new VisualEffectsSystem(this.world);\r\n            this.world.registerSystem(this.visualEffectsSystem);\r\n            console.log(\"[COMBAT] VisualEffectsSystem registered\");\r\n            \r\n            // Set reference to this world in the scene for cross-component access\r\n            if (this.scene) {\r\n                this.scene.ecsWorld = this.world;\r\n                console.log(\"[COMBAT] Set ECS world reference in scene for cross-system access\");\r\n            }\r\n\r\n            // Subscribe to transform updates to refresh spatial hash\r\n            if (this.world && this.world.messageBus) {\r\n                this.world.messageBus.subscribe('transform.updated', (msg) => {\r\n                    const entity = msg.data && msg.data.entity;\r\n                    if (entity && this.world.onEntityTransformUpdated) {\r\n                        this.world.onEntityTransformUpdated(entity);\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // Initialize the world\r\n            try {\r\n                console.log(\"[COMBAT] Calling world.initialize()...\");\r\n                this.world.initialize();\r\n                console.log(\"[COMBAT] World initialization completed successfully\");\r\n            } catch (error) {\r\n                console.error(\"[COMBAT] Error during world.initialize():\", error);\r\n                console.error(\"[COMBAT] Stack trace:\", error.stack);\r\n                \r\n                // Continue execution - don't let this error stop us\r\n                console.log(\"[COMBAT] Continuing despite initialization error\");\r\n            }\r\n            \r\n            // Create player reference entity again to ensure it exists\r\n            await this.createPlayerReferenceEntity();\r\n            \r\n            // Configure enemy system \r\n            if (this.enemySystem) {\r\n                // Force enemy verification after world is set up\r\n                this.enemySystem.lifecycle.validateEnemyReferences(this.enemySystem.enemies);\r\n                \r\n                // IMPORTANT: Ensure any lingering enemies over the limit are cleaned up\r\n                if (this.enemySystem.enemies.size > this.enemySystem.maxEnemies) {\r\n                    console.warn(`[COMBAT] Found ${this.enemySystem.enemies.size} enemies exceeding limit of ${this.enemySystem.maxEnemies} during setup`);\r\n                    this.enemySystem.enforceEnemyLimit();\r\n                }\r\n                \r\n                // Force enemy system to generate spawn points based on player position\r\n                this.enemySystem.spawner.generateSpawnPoints();\r\n                \r\n                console.log(`[COMBAT] Configured enemy system: Max enemies ${this.enemySystem.maxEnemies}`);\r\n            }\r\n            \r\n            // Mark world as initialized\r\n            this.worldInitialized = true;\r\n            \r\n            console.log(\"[COMBAT] ECS combat systems registered and initialization process completed\");\r\n        } catch (error) {\r\n            console.error(\"[COMBAT] Error during world setup:\", error);\r\n            console.error(\"[COMBAT] Stack trace:\", error.stack);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Create a player reference entity in the ECS world\r\n     * This allows enemies and other systems to interact with the player\r\n     */\r\n    async createPlayerReferenceEntity() {\r\n        if (!this.world) {\r\n            console.error(\"[COMBAT] Cannot create player entity - world not available\");\r\n            return null;\r\n        }\r\n        \r\n        if (!this.spaceship) {\r\n            console.error(\"[COMBAT] Cannot create player entity - spaceship not available\");\r\n            return null;\r\n        }\r\n        \r\n        try {\r\n            console.log(\"[COMBAT] Creating player reference entity...\");\r\n            \r\n            // If player entity already exists, check if it's valid\r\n            if (this.playerEntity) {\r\n                const existingEntity = this.world.getEntity(this.playerEntity.id);\r\n                if (existingEntity) {\r\n                    console.log(`[COMBAT] Player entity already exists with ID: ${this.playerEntity.id}`);\r\n                    \r\n                    // Make sure it has the player tag (re-add if missing)\r\n                    if (!existingEntity.hasTag('player')) {\r\n                        console.log(\"[COMBAT] Re-adding 'player' tag to existing entity\");\r\n                        existingEntity.addTag('player');\r\n                    }\r\n                    \r\n                    // Update its position\r\n                    const transform = existingEntity.getComponent('TransformComponent');\r\n                    if (transform && this.spaceship.mesh) {\r\n                        transform.position.copy(this.spaceship.mesh.position);\r\n                        transform.rotation.copy(this.spaceship.mesh.rotation);\r\n                        transform.quaternion.copy(this.spaceship.mesh.quaternion);\r\n                        if (typeof transform.setUpdated === 'function') {\r\n                            transform.setUpdated();\r\n                        }\r\n                    }\r\n                    \r\n                    // Make it globally accessible\r\n                    if (window.game) {\r\n                        window.game.combat = window.game.combat || {};\r\n                        window.game.combat.playerEntity = existingEntity;\r\n                    }\r\n                    \r\n                    return existingEntity;\r\n                } else {\r\n                    console.log(\"[COMBAT] Previous player entity no longer exists, creating new one\");\r\n                }\r\n            }\r\n            \r\n            // Create player entity with a clear unique name\r\n            const playerEntity = this.world.createEntity('player_' + Date.now());\r\n            \r\n            // Add player tag and log it\r\n            playerEntity.addTag('player');\r\n            console.log(`[COMBAT] Added 'player' tag to entity ${playerEntity.id}`);\r\n            \r\n            // Import needed components\r\n            let TransformComponent, HealthComponent;\r\n            \r\n            try {\r\n                const transformModule = await import('../components/transform.js');\r\n                TransformComponent = transformModule.TransformComponent;\r\n                console.log(\"[COMBAT] Successfully imported TransformComponent\");\r\n            } catch (error) {\r\n                console.error(\"[COMBAT] Failed to import TransformComponent:\", error);\r\n                // Create a minimal fallback if import fails\r\n                TransformComponent = class FallbackTransform extends Component {\r\n                    constructor(position) { \r\n                        super();\r\n                        this.position = position || new THREE.Vector3();\r\n                        this.rotation = new THREE.Euler();\r\n                        this.quaternion = new THREE.Quaternion();\r\n                    }\r\n                };\r\n            }\r\n            \r\n            try {\r\n                const healthModule = await import('../components/combat/healthComponent.js');\r\n                HealthComponent = healthModule.HealthComponent;\r\n                console.log(\"[COMBAT] Successfully imported HealthComponent\");\r\n            } catch (error) {\r\n                console.error(\"[COMBAT] Failed to import HealthComponent:\", error);\r\n                // Create a minimal fallback if import fails\r\n                HealthComponent = class FallbackHealth extends Component {\r\n                    constructor(health, shield) {\r\n                        super();\r\n                        this.health = health || 100;\r\n                        this.shield = shield || 50;\r\n                        this.maxHealth = health || 100;\r\n                        this.maxShield = shield || 50;\r\n                    }\r\n                };\r\n            }\r\n            \r\n            // Add transform component linked to spaceship position\r\n            try {\r\n                const position = this.spaceship.mesh ? this.spaceship.mesh.position.clone() : new THREE.Vector3();\r\n                const transform = new TransformComponent(position);\r\n                playerEntity.addComponent(transform);\r\n                console.log(`[COMBAT] Added TransformComponent to player entity with position: ${position.x.toFixed(1)}, ${position.y.toFixed(1)}, ${position.z.toFixed(1)}`);\r\n            } catch (error) {\r\n                console.error(\"[COMBAT] Error adding TransformComponent to player entity:\", error);\r\n            }\r\n            \r\n            // Add health component\r\n            try {\r\n                const health = new HealthComponent(100, 50); // 100 health, 50 shield\r\n                playerEntity.addComponent(health);\r\n                console.log(\"[COMBAT] Added HealthComponent to player entity\");\r\n            } catch (error) {\r\n                console.error(\"[COMBAT] Error adding HealthComponent to player entity:\", error);\r\n            }\r\n            \r\n            // Store reference to player entity\r\n            this.playerEntity = playerEntity;\r\n            \r\n            // Make the player entity globally accessible for emergency access\r\n            if (window.game) {\r\n                window.game.combat = window.game.combat || {};\r\n                window.game.combat.playerEntity = playerEntity;\r\n                console.log(\"[COMBAT] Made player entity globally accessible via window.game.combat.playerEntity\");\r\n            }\r\n            \r\n            // Add direct player entity reference to the world\r\n            this.world.playerEntity = playerEntity;\r\n            console.log(\"[COMBAT] Made player entity available directly via world.playerEntity\");\r\n            \r\n            // Explicitly publish an event for player entity creation\r\n            if (this.world && this.world.messageBus) {\r\n                this.world.messageBus.publish('player.created', { entity: playerEntity });\r\n                console.log(\"[COMBAT] Published player.created event\");\r\n            }\r\n            \r\n            console.log(\"[COMBAT] Successfully created player reference entity with ID:\", playerEntity.id);\r\n            \r\n            // Return the entity for chaining\r\n            return playerEntity;\r\n        } catch (error) {\r\n            console.error(\"[COMBAT] Error creating player reference entity:\", error);\r\n            console.error(\"[COMBAT] Stack trace:\", error.stack);\r\n            return null;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update all projectiles and handle firing logic\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    update(deltaTime) {\r\n        // Skip if disabled\r\n        if (!this.scene || !this.spaceship) return;\r\n        \r\n        // Skip enemy updates if intro sequence is active\r\n        const introActive = window.game && window.game.introSequenceActive;\r\n        \r\n        // Update the player reference entity position\r\n        this.updatePlayerReference();\r\n        \r\n        // Update the spaceship health from ECS\r\n        this.updateSpaceshipHealth();\r\n        \r\n        // Update all active projectiles (if any from old system)\r\n        this.updateProjectiles(deltaTime);\r\n        \r\n        // Update active tracer beams\r\n        this.updateTracers(deltaTime);\r\n        \r\n        // Update pooled visual effects (muzzle flashes, tracers, etc.)\r\n        if (this.poolManager) {\r\n            this.poolManager.update(deltaTime);\r\n        }\r\n        \r\n        // Handle firing weapons\r\n        if (this.isFiring && !this.spaceship.isDocked) {\r\n            this.fireParticleCannon();\r\n        }\r\n        \r\n        // Update the ECS world with the current delta time\r\n        if (this.world && !introActive) {\r\n            this.world.update(deltaTime);\r\n        } else if (this.world && introActive) {\r\n            // During intro, only update non-enemy systems\r\n            if (this.world.systems) {\r\n                for (const system of this.world.systems) {\r\n                    // Skip enemy systems when intro is active\r\n                    if (system.constructor.name !== 'EnemySystem' && \r\n                        system.constructor.name !== 'EnemyAISystem') {\r\n                        system.update(deltaTime);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update the player reference entity with the current spaceship position\r\n     */\r\n    updatePlayerReference() {\r\n        // Skip if missing references\r\n        if (!this.world || !this.spaceship || !this.playerEntity) {\r\n            // If we don't have a player entity, try to create one now if world is ready\r\n            if (this.world && this.spaceship && !this.playerEntity) {\r\n                console.log(\"No player entity found, creating one...\");\r\n                this.createPlayerReferenceEntity();\r\n                return;\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Get the player entity\r\n        const playerEntity = this.world.getEntity(this.playerEntity.id);\r\n        \r\n        // If entity was somehow lost, recreate it\r\n        if (!playerEntity) {\r\n            console.warn(\"Player entity lost, recreating...\");\r\n            this.createPlayerReferenceEntity();\r\n            return;\r\n        }\r\n        \r\n        // Update transform component with current spaceship position\r\n        const transform = playerEntity.getComponent('TransformComponent');\r\n        if (transform && this.spaceship.mesh) {\r\n            // Update position\r\n            transform.position.copy(this.spaceship.mesh.position);\r\n            \r\n            // Update rotation\r\n            transform.rotation.copy(this.spaceship.mesh.rotation);\r\n            transform.quaternion.copy(this.spaceship.mesh.quaternion);\r\n            \r\n            // Mark transform as updated to trigger any listening systems\r\n            if (typeof transform.setUpdated === 'function') {\r\n                transform.setUpdated();\r\n            }\r\n        }\r\n        \r\n        // Update health component if spaceship has relevant health info\r\n        const health = playerEntity.getComponent('HealthComponent');\r\n        if (health && this.spaceship.health !== undefined) {\r\n            // Only update health if it would be higher - don't override damage\r\n            if (this.spaceship.health > health.health) {\r\n                health.health = this.spaceship.health;\r\n            }\r\n            \r\n            // Only update shield if it would be higher - don't override damage\r\n            if (this.spaceship.shield !== undefined && this.spaceship.shield > health.shield) {\r\n                health.shield = this.spaceship.shield;\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Sync the spaceship hull/shield with the player entity's HealthComponent\r\n     */\r\n    updateSpaceshipHealth() {\r\n        if (!this.playerEntity || !this.spaceship) return;\r\n        \r\n        // Get health component\r\n        const health = this.playerEntity.getComponent('HealthComponent');\r\n        if (health) {\r\n            // IMPORTANT: Only update spaceship health if the health component shows MORE damage\r\n            // (less health) than the spaceship currently has - this means damage was applied to the component\r\n            if (health.health < this.spaceship.hull) {\r\n                console.log(`Damage detected in health component: ${health.health} (was ${this.spaceship.hull})`);\r\n                this.spaceship.hull = health.health;\r\n            }\r\n            \r\n            // Similarly for shield\r\n            if (health.shield < this.spaceship.shield) {\r\n                console.log(`Shield damage detected in health component: ${health.shield} (was ${this.spaceship.shield})`);\r\n                this.spaceship.shield = health.shield;\r\n            }\r\n            \r\n            // Check if health indicates the ship is destroyed\r\n            if (health.isDestroyed && !this.spaceship.isDestroyed) {\r\n                console.log(\"Health component indicates player is destroyed - updating spaceship state\");\r\n                this.spaceship.isDestroyed = true;\r\n                \r\n                // Call handle destruction for visual effects\r\n                if (typeof this.spaceship.handleDestruction === 'function') {\r\n                    this.spaceship.handleDestruction();\r\n                }\r\n            }\r\n            \r\n            // Check for low health and update spaceship directly\r\n            if (health.health <= 0 && !this.spaceship.isDestroyed) {\r\n                console.log(\"Player health is zero - marking spaceship as destroyed\");\r\n                this.spaceship.isDestroyed = true;\r\n                \r\n                // Call handle destruction for visual effects\r\n                if (typeof this.spaceship.handleDestruction === 'function') {\r\n                    this.spaceship.handleDestruction();\r\n                }\r\n                \r\n                // Force game over with a \"pwned by space alien\" message\r\n                if (window.game) {\r\n                    console.log(\"FORCING GAME OVER FROM COMBAT MODULE!\");\r\n                    window.game.gameOver(\"You were pwned by a space alien!\");\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update all projectile positions\r\n     * @param {number} deltaTime Time since last update in seconds\r\n     */\r\n    updateProjectiles(deltaTime) {\r\n        // Normalize deltaTime to 60 FPS for frame rate independence\r\n        const normalizedDeltaTime = deltaTime * 60;\r\n        \r\n        // Update existing projectiles\r\n        for (let i = this.projectiles.length - 1; i >= 0; i--) {\r\n            const projectile = this.projectiles[i];\r\n            \r\n            // Move projectile forward along its direction using normalized delta time\r\n            // For projectiles, we need to scale by deltaTime alone, not normalized,\r\n            // because the projectile speed is already calibrated for the base frame rate\r\n            projectile.position.add(projectile.velocity.clone().multiplyScalar(deltaTime));\r\n            \r\n            // Update associated entity in ECS world\r\n            if (projectile.userData && projectile.userData.entityId && this.world) {\r\n                const entity = this.world.getEntity(projectile.userData.entityId);\r\n                if (entity) {\r\n                    // If entity has custom update method, call it\r\n                    if (typeof entity.update === 'function') {\r\n                        entity.update(deltaTime);\r\n                    }\r\n                    \r\n                    // Otherwise manually update transform to match projectile\r\n                    else {\r\n                        const transform = entity.getComponent('TransformComponent');\r\n                        if (transform) {\r\n                            transform.position.copy(projectile.position);\r\n                            transform.needsUpdate = true;\r\n                        }\r\n                        \r\n                        const rigidbody = entity.getComponent('RigidbodyComponent');\r\n                        if (rigidbody) {\r\n                            rigidbody.velocity.copy(projectile.velocity);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Check if projectile has expired\r\n            if (performance.now() - projectile.userData.creationTime > this.projectileLifetime) {\r\n                // Remove associated entity from ECS world\r\n                if (projectile.userData && projectile.userData.entityId && this.world) {\r\n                    try {\r\n                        this.world.destroyEntity(projectile.userData.entityId);\r\n                        console.log(`Removed expired projectile entity ${projectile.userData.entityId}`);\r\n                    } catch (error) {\r\n                        console.error(\"Error removing projectile entity:\", error);\r\n                    }\r\n                }\r\n                \r\n                // Use pool manager to release the projectile back to the pool\r\n                // This handles all the cleanup of materials, geometries, and trails\r\n                this.poolManager.releaseProjectile(projectile);\r\n                \r\n                // Remove from tracking array\r\n                this.projectiles.splice(i, 1);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Set firing state for the particle cannon\r\n     * @param {boolean} isFiring Whether the cannon should be firing\r\n     */\r\n    setFiring(isFiring) {\r\n        this.isFiring = isFiring;\r\n        console.log(`Particle cannon firing state changed: ${isFiring}`);\r\n    }\r\n    \r\n    /**\r\n     * Create an explosion effect at the given position\r\n     * @param {THREE.Vector3} position Position for the explosion\r\n     * @param {number} duration Duration of the explosion in milliseconds\r\n     * @param {boolean} isVisible Whether the explosion should be visible\r\n     */\r\n    createExplosionEffect(position, duration = 1000, isVisible = true) {\r\n        try {\r\n            // Get explosion from pool\r\n            const explosion = this.poolManager.getExplosion(position, duration);\r\n            \r\n            // Play explosion sound\r\n            if (window.game && window.game.audio) {\r\n                window.game.audio.playSound('boink');\r\n            }\r\n            \r\n            console.log(\"Created explosion effect at:\", position.x.toFixed(0), position.y.toFixed(0), position.z.toFixed(0));\r\n            \r\n            return explosion;\r\n        } catch (error) {\r\n            console.error(\"Error creating explosion effect:\", error);\r\n            return null;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Update active tracer beams - fade them out from start to end\r\n     * @param {number} deltaTime Time since last update\r\n     */\r\n    updateTracers(deltaTime) {\r\n        if (!this.activeTracers || this.activeTracers.length === 0) return;\r\n        \r\n        const currentTime = performance.now();\r\n        const tracersToRemove = [];\r\n        \r\n        for (let i = this.activeTracers.length - 1; i >= 0; i--) {\r\n            const beamGroup = this.activeTracers[i];\r\n            const userData = beamGroup.userData;\r\n            \r\n            if (!userData) continue;\r\n            \r\n            const elapsed = currentTime - userData.startTime;\r\n            const fadeProgress = Math.min(elapsed / userData.fadeTime, 1.0);\r\n            \r\n            if (fadeProgress >= 1.0) {\r\n                // Remove entire beam group\r\n                    this._removeFromScene(beamGroup);\r\n                tracersToRemove.push(i);\r\n            } else {\r\n                // Progressive dissolve from start to end\r\n                // The beam shortens from the start point toward the end point\r\n                const dissolveDistance = userData.beamLength * fadeProgress;\r\n                \r\n                // Calculate new start position (moves toward end as it dissolves)\r\n                const newStartOffset = userData.direction.clone().multiplyScalar(dissolveDistance);\r\n                const newStartPos = userData.startPos.clone().add(newStartOffset);\r\n                \r\n                // Calculate new beam length\r\n                const newLength = userData.beamLength * (1.0 - fadeProgress);\r\n                \r\n                if (newLength > 0.1) {\r\n                    // Update beam geometry to be shorter\r\n                    // We need to recreate the cylinders with new height\r\n                    userData.coreMesh.geometry.dispose();\r\n                    userData.innerGlowMesh.geometry.dispose();\r\n                    userData.outerGlowMesh.geometry.dispose();\r\n                    \r\n                    userData.coreMesh.geometry = new THREE.CylinderGeometry(1.5, 1.5, newLength, 12);\r\n                    userData.innerGlowMesh.geometry = new THREE.CylinderGeometry(3, 3, newLength, 8);\r\n                    userData.outerGlowMesh.geometry = new THREE.CylinderGeometry(5, 5, newLength, 6);\r\n                    \r\n                    // Update position to new midpoint\r\n                    const newMidpoint = new THREE.Vector3().addVectors(newStartPos, userData.endPos).multiplyScalar(0.5);\r\n                    beamGroup.position.copy(newMidpoint);\r\n                    \r\n                    // Also fade opacity slightly as it dissolves\r\n                    const opacityFactor = Math.pow(1.0 - fadeProgress, 0.3); // Slower opacity fade\r\n                    userData.coreMesh.material.opacity = userData.initialCoreOpacity * opacityFactor;\r\n                    userData.innerGlowMesh.material.opacity = userData.initialInnerOpacity * opacityFactor;\r\n                    userData.outerGlowMesh.material.opacity = userData.initialOuterOpacity * opacityFactor;\r\n                }\r\n            }\r\n        }\r\n        \r\n        // Remove completed tracers from the array\r\n        for (const index of tracersToRemove) {\r\n            this.activeTracers.splice(index, 1);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Register an enemy entity for synchronization with EnemySystem\r\n     * @param {string} enemyId ID of the enemy entity\r\n     */\r\n    registerEnemy(enemyId) {\r\n        // Add hook to track enemy entities for external systems\r\n        if (!this._registeredEnemyIds) {\r\n            this._registeredEnemyIds = new Set();\r\n        }\r\n        \r\n        // Add enemy to our tracking set\r\n        this._registeredEnemyIds.add(enemyId);\r\n        console.log(`Combat module: Registered enemy ${enemyId} for tracking (total: ${this._registeredEnemyIds.size})`);\r\n    }\r\n    \r\n    /**\r\n     * Unregister an enemy entity\r\n     * @param {string} enemyId ID of the enemy entity\r\n     */\r\n    unregisterEnemy(enemyId) {\r\n        if (this._registeredEnemyIds && this._registeredEnemyIds.has(enemyId)) {\r\n            this._registeredEnemyIds.delete(enemyId);\r\n            console.log(`Combat module: Unregistered enemy ${enemyId} (remaining: ${this._registeredEnemyIds.size})`);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Fire the particle cannon, creating two projectiles\r\n     */\r\n    fireParticleCannon() {\r\n        if (!this.spaceship || !this.spaceship.mesh) return false;\r\n        \r\n        // Check cooldown - prevent firing too rapidly\r\n        const currentTime = performance.now();\r\n        if (currentTime - this.lastFireTime < this.cooldown) {\r\n            // Still in cooldown period\r\n            return false;\r\n        }\r\n        \r\n        console.log(\"*** COMBAT MODULE: Firing pulse cannon with railgun effect ***\");\r\n        \r\n        // Update last shot time for cooldown tracking\r\n        this.lastFireTime = currentTime;\r\n        \r\n        // Get ship transform data\r\n        const shipPosition = this.spaceship.mesh.position.clone();\r\n        \r\n        // IMPROVED AIMING: Use raycasting from camera through crosshair\r\n        // Create a ray from the camera through the center of the screen (crosshair)\r\n        const camera = this.scene.camera;\r\n        if (!camera) {\r\n            console.error(\"Camera not available for aiming\");\r\n            return false;\r\n        }\r\n        \r\n        // Create a raycaster from camera center (crosshair position)\r\n        const raycaster = new THREE.Raycaster();\r\n        // Vector representing center of the screen (crosshair)\r\n        const screenCenter = new THREE.Vector2(0, 0);\r\n        \r\n        // Set the raycaster from camera through crosshair\r\n        raycaster.setFromCamera(screenCenter, camera);\r\n        \r\n        // Get the ray direction in world space\r\n        const direction = raycaster.ray.direction.clone().normalize();\r\n        \r\n        // Maximum range for weapon\r\n        const maxRange = 5000;\r\n        \r\n        // Log the new direction approach\r\n        console.log(`Projectile direction (using camera ray): ${direction.x.toFixed(2)}, ${direction.y.toFixed(2)}, ${direction.z.toFixed(2)}`);\r\n        \r\n        // Calculate right vector for offset\r\n        const right = new THREE.Vector3().crossVectors(direction, new THREE.Vector3(0, 1, 0)).normalize();\r\n        \r\n        // Position offsets for dual projectiles\r\n        const leftOffset = new THREE.Vector3().copy(right).multiplyScalar(-1.5);\r\n        const rightOffset = new THREE.Vector3().copy(right).multiplyScalar(1.5);\r\n        \r\n        // Add larger forward offset so projectiles spawn further in front of ship (increased from 7 to 15)\r\n        const forwardOffset = new THREE.Vector3().copy(direction).multiplyScalar(15);\r\n        \r\n        // Calculate weapon port positions (where the beams originate)\r\n        // Start beams 25 units in front of ship to avoid self-intersection when moving forward\r\n        const weaponForwardOffset = new THREE.Vector3().copy(direction).multiplyScalar(25);\r\n        \r\n        const leftWeaponPosition = new THREE.Vector3().copy(shipPosition)\r\n            .add(leftOffset)\r\n            .add(weaponForwardOffset);\r\n            \r\n        const rightWeaponPosition = new THREE.Vector3().copy(shipPosition)\r\n            .add(rightOffset)\r\n            .add(weaponForwardOffset);\r\n        \r\n        // REMOVED: Old projectile creation - replaced with instant tracers below\r\n        // const leftProjectile = this.createProjectile(leftPosition, direction);\r\n        // const rightProjectile = this.createProjectile(rightPosition, direction);\r\n        \r\n        // Create flash effects at the weapon port positions\r\n        // REMOVED: No longer using muzzle flashes for Star Wars laser effect\r\n        // this.createMuzzleFlash(leftWeaponPosition, direction);\r\n        // this.createMuzzleFlash(rightWeaponPosition, direction);\r\n        \r\n        // Play projectile sound\r\n        if (window.game && window.game.audio) {\r\n            console.log(\"Playing ASMR projectile sound for particle cannon\");\r\n            window.game.audio.playSound('projectile');\r\n        }\r\n        \r\n        // Variables to track hits for tracer visualization\r\n        let leftHitPoint = null;\r\n        let rightHitPoint = null;\r\n        let leftHitEnemy = false;\r\n        let rightHitEnemy = false;\r\n        \r\n        // DIRECT ENEMY CHECK - Find any enemies in the scene and check for direct hits\r\n        console.log(\"DIRECT ENEMY CHECK: Searching for enemies to destroy\");\r\n        if (this.world && this.world.entityManager) {\r\n            let enemies = [];\r\n            \r\n            // Try to get enemies from tag map\r\n            try {\r\n                if (this.world.entityManager.entitiesByTag && this.world.entityManager.entitiesByTag.get('enemy')) {\r\n                    enemies = this.world.entityManager.entitiesByTag.get('enemy');\r\n                    console.log(`Found ${enemies.length} enemies via tag map`);\r\n                } else {\r\n                    // Fallback to checking all entities\r\n                    console.log(\"No enemy tag map, checking all entities\");\r\n                    const allEntities = Array.from(this.world.entityManager.entities.values());\r\n                    for (const entity of allEntities) {\r\n                        if (entity.hasTag && entity.hasTag('enemy')) {\r\n                            enemies.push(entity);\r\n                        } else if (entity.hasComponent && entity.hasComponent('EnemyAIComponent')) {\r\n                            enemies.push(entity);\r\n                        }\r\n                    }\r\n                    console.log(`Found ${enemies.length} enemies by checking all entities`);\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error finding enemies:\", error);\r\n            }\r\n            \r\n            // Check for collision with each enemy - using raycasting for better precision\r\n            for (const enemy of enemies) {\r\n                if (!enemy) continue;\r\n                \r\n                try {\r\n                    // Get enemy position for debugging\r\n                    let enemyPosition = null;\r\n                    const enemyTransform = enemy.getComponent('TransformComponent');\r\n                    if (enemyTransform) {\r\n                        enemyPosition = enemyTransform.position;\r\n                    } else {\r\n                        console.log(\"Enemy missing transform component\");\r\n                        continue;\r\n                    }\r\n                    \r\n                    // Get enemy mesh component for collision detection\r\n                    const enemyMeshComponent = enemy.getComponent('MeshComponent');\r\n                    if (!enemyMeshComponent || !enemyMeshComponent.mesh) {\r\n                        console.log(`Enemy ${enemy.id} has no mesh component or mesh`);\r\n                        continue;\r\n                    }\r\n                    \r\n                    // Debug mesh properties\r\n                    console.log(`Testing ray intersection with enemy ${enemy.id}:`);\r\n                    console.log(`- Position: (${enemyPosition.x.toFixed(1)}, ${enemyPosition.y.toFixed(1)}, ${enemyPosition.z.toFixed(1)})`);\r\n                    console.log(`- Mesh visible: ${enemyMeshComponent.mesh.visible}`);\r\n                    console.log(`- Mesh children: ${enemyMeshComponent.mesh.children ? enemyMeshComponent.mesh.children.length : 0}`);\r\n                    \r\n                    // Calculate distance from ship to enemy (for debugging)\r\n                    const distanceToEnemy = shipPosition.distanceTo(enemyPosition);\r\n                    console.log(`- Distance to enemy: ${distanceToEnemy.toFixed(1)}`);\r\n                    \r\n                    // Skip if mesh is not visible\r\n                    if (!enemyMeshComponent.mesh.visible) {\r\n                        console.log(`Mesh for enemy ${enemy.id} is not visible, skipping`);\r\n                        continue;\r\n                    }\r\n                    \r\n                    // Perform the precise mesh intersection test\r\n                    const intersections = raycaster.intersectObject(enemyMeshComponent.mesh, true);\r\n                    \r\n                    if (intersections.length > 0) {\r\n                        // We have a mesh intersection!\r\n                        const intersection = intersections[0]; // closest intersection\r\n                        \r\n                        // Debug the hit\r\n                        console.log(`*** MESH HIT on enemy ${enemy.id}! ***`);\r\n                        console.log(`- Hit distance: ${intersection.distance.toFixed(2)}`);\r\n                        console.log(`- Hit point: (${intersection.point.x.toFixed(1)}, ${intersection.point.y.toFixed(1)}, ${intersection.point.z.toFixed(1)})`);\r\n                        \r\n                        if (intersection.object) {\r\n                            console.log(`- Hit specific object: ${intersection.object.name || 'unnamed'}`);\r\n                        }\r\n                        \r\n                        if (intersection.face) {\r\n                            console.log(`- Hit face normal: (${intersection.face.normal.x.toFixed(2)}, ${intersection.face.normal.y.toFixed(2)}, ${intersection.face.normal.z.toFixed(2)})`);\r\n                        }\r\n                        \r\n                        // Force destroy enemy via all possible methods\r\n                        // Method 1: Apply damage via health component\r\n                        const health = enemy.getComponent('HealthComponent');\r\n                        if (health) {\r\n                            console.log(\"Applying damage to enemy\");\r\n                            // Use the standardized projectile damage value\r\n                            const damageResult = health.applyDamage(this.projectileDamage, 'particle', this.playerEntity);\r\n                            \r\n                            // Check if the damage was enough to destroy the enemy\r\n                            if (health.health <= 0) {\r\n                                console.log(\"Enemy health depleted, destroying entity\");\r\n                                health.isDestroyed = true;\r\n                                \r\n                                // Create explosion effect for destroyed enemy\r\n                                if (enemyTransform) {\r\n                                    this.createExplosionEffect(enemyTransform.position.clone());\r\n                                    \r\n                                    // Play explosion sound if available\r\n                                    if (window.game && window.game.audio) {\r\n                                        window.game.audio.playSound('boink');\r\n                                    }\r\n                                }\r\n                                \r\n                                // SYNCHRONIZATION FIX: Unregister enemy from our registry\r\n                                this.unregisterEnemy(enemy.id);\r\n                                \r\n                                // SYNC WITH ENEMY SYSTEM: Force EnemySystem to handle this destruction properly\r\n                                if (window.game && window.game.ecsWorld && window.game.ecsWorld.enemySystem) {\r\n                                    console.log(`Notifying EnemySystem directly about enemy ${enemy.id} destruction`);\r\n                                    try {\r\n                                        const enemySystem = window.game.ecsWorld.enemySystem;\r\n                                        if (typeof enemySystem.handleEntityDestroyed === 'function') {\r\n                                            enemySystem.handleEntityDestroyed({\r\n                                                entity: enemy,\r\n                                                reason: 'projectile'\r\n                                            });\r\n                                        }\r\n                                    } catch (syncError) {\r\n                                        console.error(\"Error syncing with EnemySystem:\", syncError);\r\n                                    }\r\n                                }\r\n                                \r\n                                // Method 2: Direct entity destruction only if health is depleted\r\n                                try {\r\n                                    // Use system-specific methods if available\r\n                                    if (window.game && window.game.ecsWorld && window.game.ecsWorld.enemySystem) {\r\n                                        const enemySystem = window.game.ecsWorld.enemySystem;\r\n                                        // Try returnEnemyToPool first which properly handles cleanup\r\n                                        if (typeof enemySystem.returnEnemyToPool === 'function') {\r\n                                            console.log(`Using EnemySystem.returnEnemyToPool for enemy ${enemy.id}`);\r\n                                            enemySystem.returnEnemyToPool(enemy);\r\n                                        }\r\n                                        // Force validation of references in EnemySystem\r\n                                        if (typeof enemySystem.validateEnemyReferences === 'function') {\r\n                                            enemySystem.validateEnemyReferences();\r\n                                        }\r\n                                    } else {\r\n                                        // Fallback to direct destruction\r\n                                        this.world.destroyEntity(enemy.id);\r\n                                        console.log(\"Enemy destroyed via world.destroyEntity\");\r\n                                    }\r\n                                } catch (e) {\r\n                                    console.error(\"Failed to destroy enemy:\", e);\r\n                                }\r\n                                \r\n                                // ADDITIONAL SYNC: Publish explicit event about destruction\r\n                                if (this.world && this.world.messageBus) {\r\n                                    this.world.messageBus.publish('enemy.destroyed', {\r\n                                        entityId: enemy.id,\r\n                                        source: 'playerProjectile',\r\n                                        position: enemyPosition.clone()\r\n                                    });\r\n                                }\r\n                            } else {\r\n                                console.log(`Enemy hit but survived with ${health.health}/${health.maxHealth} health remaining`);\r\n                                // Non-lethal hit - no visual effect\r\n                            }\r\n                        }\r\n                    } else {\r\n                        // Debug the miss\r\n                        console.log(`Ray missed enemy ${enemy.id} - no mesh intersection`);\r\n                        \r\n                        // Check if any debug visuals are needed\r\n                        if (window.debugMode) {\r\n                            // Debug visualization - create a temporary red line showing the ray\r\n                            const rayLine = new THREE.Line(\r\n                                new THREE.BufferGeometry().setFromPoints([\r\n                                    raycaster.ray.origin.clone(),\r\n                                    raycaster.ray.origin.clone().add(raycaster.ray.direction.clone().multiplyScalar(1000))\r\n                                ]),\r\n                                new THREE.LineBasicMaterial({ color: 0xff0000 })\r\n                            );\r\n            this._addToScene(rayLine);\r\n            setTimeout(() => this._removeFromScene(rayLine), 1000); // Remove after 1 second\r\n                        }\r\n                    }\r\n                } catch (error) {\r\n                    console.error(\"Error checking enemy collision:\", error);\r\n                }\r\n            }\r\n        } else {\r\n            console.log(\"No world or entityManager available for enemy check\");\r\n        }\r\n        \r\n        // Create instant tracer beams from weapon ports\r\n        // Left cannon tracer\r\n        const leftEndPoint = leftHitPoint || leftWeaponPosition.clone().add(direction.clone().multiplyScalar(maxRange));\r\n        this.createInstantTracer(leftWeaponPosition, leftEndPoint, leftHitEnemy, 0.4);\r\n        \r\n        // Right cannon tracer\r\n        const rightEndPoint = rightHitPoint || rightWeaponPosition.clone().add(direction.clone().multiplyScalar(maxRange));\r\n        this.createInstantTracer(rightWeaponPosition, rightEndPoint, rightHitEnemy, 0.4);\r\n        \r\n        // Create impact effects if we hit something\r\n        if (leftHitPoint && leftHitEnemy) {\r\n            this.createExplosionEffect(leftHitPoint, 0.5);\r\n        }\r\n        if (rightHitPoint && rightHitEnemy && rightHitPoint.distanceTo(leftHitPoint || rightHitPoint) > 10) {\r\n            // Only create second explosion if hit points are far enough apart\r\n            this.createExplosionEffect(rightHitPoint, 0.5);\r\n        }\r\n        \r\n        // Return true to indicate successful firing\r\n        return true;\r\n    }\r\n    \r\n    /**\r\n     * Create a single projectile\r\n     * @param {THREE.Vector3} position Spawn position\r\n     * @param {THREE.Vector3} direction Direction vector\r\n     */\r\n    createProjectile(position, direction) {\r\n        // Get a projectile from the pool\r\n        const projectile = this.poolManager.getProjectile();\r\n        \r\n        // Set position and make visible\r\n        projectile.position.copy(position);\r\n        projectile.visible = true;\r\n        \r\n        // IMPORTANT: Orient the cylinder along the direction of travel\r\n        // By default cylinders are created along the Y axis, we need to rotate them\r\n        \r\n        // First, find the quaternion that rotates from the default cylinder orientation (Y-axis)\r\n        // to our desired direction\r\n        const cylinderDefaultDirection = new THREE.Vector3(0, 1, 0); // Y-axis\r\n        const quaternion = new THREE.Quaternion();\r\n        quaternion.setFromUnitVectors(cylinderDefaultDirection, direction);\r\n        \r\n        // Apply the rotation to the projectile\r\n        projectile.quaternion.copy(quaternion);\r\n        \r\n        // Set velocity based on direction and speed\r\n        projectile.velocity = direction.clone().multiplyScalar(this.projectileSpeed);\r\n        \r\n        // Mark projectile as player's to prevent self-damage\r\n        projectile.userData.isPlayerProjectile = true;\r\n        projectile.userData.sourceId = 'player';\r\n        projectile.userData.damage = this.projectileDamage;\r\n        \r\n        // Add a dynamic trail\r\n        this.addProjectileTrail(projectile, direction); // REINSTATED for laser trails\r\n        \r\n        // Add to scene if not already there via renderer facade\r\n        if (!projectile.parent) {\r\n            this._addToScene(projectile);\r\n        }\r\n        \r\n        // Store creation time for lifespan tracking\r\n        projectile.userData.creationTime = performance.now();\r\n        \r\n        // Add to projectiles array to track active projectiles\r\n        this.projectiles.push(projectile);\r\n\r\n        // Register into optimized store if available\r\n        if (this.world && this.world.optimizedProjectiles) {\r\n            try { this.world.optimizedProjectiles.register(projectile); } catch {}\r\n        }\r\n        \r\n        return projectile;\r\n    }\r\n    \r\n    /**\r\n     * Enable or disable all combat systems\r\n     * @param {boolean} enabled Whether combat systems should be enabled\r\n     */\r\n    setEnabled(enabled) {\r\n        // If disabling, clear all projectiles\r\n        if (!enabled) {\r\n            this.clearAllProjectiles();\r\n            \r\n            // Disable ECS systems\r\n            if (this.world) {\r\n                if (this.enemySystem && typeof this.enemySystem.setEnabled === 'function') { // Check if setEnabled exists\r\n                    this.enemySystem.setEnabled(false);\r\n                } else if (this.enemySystem) {\r\n                    this.enemySystem.enabled = false;\r\n                }\r\n                if (this.combatSystem && typeof this.combatSystem.setEnabled === 'function') { // Check if setEnabled exists\r\n                    this.combatSystem.setEnabled(false);\r\n                } else if (this.combatSystem) {\r\n                    this.combatSystem.enabled = false;\r\n                }\r\n            }\r\n        } else {\r\n            // Enable ECS systems\r\n            if (this.world) {\r\n                if (this.enemySystem && typeof this.enemySystem.setEnabled === 'function') { // Check if setEnabled exists\r\n                    this.enemySystem.setEnabled(true);\r\n                } else if (this.enemySystem) {\r\n                    this.enemySystem.enabled = true;\r\n                }\r\n                if (this.combatSystem && typeof this.combatSystem.setEnabled === 'function') { // Check if setEnabled exists\r\n                    this.combatSystem.setEnabled(true);\r\n                } else if (this.combatSystem) {\r\n                    this.combatSystem.enabled = true;\r\n                }\r\n            }\r\n        }\r\n        \r\n        console.log(`Combat systems ${enabled ? 'enabled' : 'disabled'}`);\r\n    }\r\n    \r\n    /**\r\n     * Create an instant plasma beam with hot glow\r\n     * @param {THREE.Vector3} startPos Starting position of the beam\r\n     * @param {THREE.Vector3} endPos End position of the beam (hit point or max range)\r\n     * @param {boolean} isHit Whether this beam hit a target\r\n     * @param {number} fadeTime Time in seconds for the beam to fade\r\n     */\r\n    createInstantTracer(startPos, endPos, isHit = false, fadeTime = 0.5) {\r\n        const distance = startPos.distanceTo(endPos);\r\n        \r\n        // Create multiple cylinders for a layered plasma effect\r\n        const beamGroup = new THREE.Group();\r\n        \r\n        // Core beam - bright white/yellow hot plasma\r\n        const coreGeometry = new THREE.CylinderGeometry(1.5, 1.5, distance, 12);\r\n        const coreMaterial = new THREE.MeshBasicMaterial({\r\n            color: 0xffffaa, // Hot yellow-white\r\n            transparent: true,\r\n            opacity: 1.0,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        const coreMesh = new THREE.Mesh(coreGeometry, coreMaterial);\r\n        \r\n        // Inner glow - orange-white plasma\r\n        const innerGlowGeometry = new THREE.CylinderGeometry(3, 3, distance, 8);\r\n        const innerGlowMaterial = new THREE.MeshBasicMaterial({\r\n            color: isHit ? 0xffaa00 : 0xff8800, // Orange for hits, red-orange for misses\r\n            transparent: true,\r\n            opacity: 0.6,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        const innerGlowMesh = new THREE.Mesh(innerGlowGeometry, innerGlowMaterial);\r\n        \r\n        // Outer glow - cooler blue-cyan edge\r\n        const outerGlowGeometry = new THREE.CylinderGeometry(5, 5, distance, 6);\r\n        const outerGlowMaterial = new THREE.MeshBasicMaterial({\r\n            color: isHit ? 0x00ffff : 0x0088ff, // Cyan for hits, blue for misses\r\n            transparent: true,\r\n            opacity: 0.3,\r\n            blending: THREE.AdditiveBlending\r\n        });\r\n        const outerGlowMesh = new THREE.Mesh(outerGlowGeometry, outerGlowMaterial);\r\n        \r\n        // Add all layers to the group\r\n        beamGroup.add(coreMesh);\r\n        beamGroup.add(innerGlowMesh);\r\n        beamGroup.add(outerGlowMesh);\r\n        \r\n        // Position and orient the entire beam group\r\n        const midpoint = new THREE.Vector3().addVectors(startPos, endPos).multiplyScalar(0.5);\r\n        beamGroup.position.copy(midpoint);\r\n        \r\n        // Orient the cylinders along the beam direction\r\n        const direction = new THREE.Vector3().subVectors(endPos, startPos).normalize();\r\n        const quaternion = new THREE.Quaternion();\r\n        quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction);\r\n        beamGroup.quaternion.copy(quaternion);\r\n        \r\n        this._addToScene(beamGroup);\r\n        \r\n        // Store beam data for progressive fade animation\r\n        beamGroup.userData = {\r\n            startTime: performance.now(),\r\n            fadeTime: fadeTime * 1000,\r\n            beamLength: distance,\r\n            startPos: startPos.clone(),\r\n            endPos: endPos.clone(),\r\n            direction: direction.clone(),\r\n            coreMesh: coreMesh,\r\n            innerGlowMesh: innerGlowMesh,\r\n            outerGlowMesh: outerGlowMesh,\r\n            initialCoreOpacity: 1.0,\r\n            initialInnerOpacity: 0.6,\r\n            initialOuterOpacity: 0.3,\r\n            isDissolving: false\r\n        };\r\n        \r\n        // Add to active tracers list for update loop\r\n        if (!this.activeTracers) {\r\n            this.activeTracers = [];\r\n        }\r\n        this.activeTracers.push(beamGroup);\r\n        \r\n        return beamGroup;\r\n    }\r\n    \r\n    /**\r\n     * Add a dynamic particle trail to a projectile (Simplified for Lasers)\r\n     * @param {THREE.Mesh} projectile The projectile mesh\r\n     * @param {THREE.Vector3} direction Direction of travel\r\n     */\r\n    addProjectileTrail(projectile, direction) {\r\n        // Parameters for a subtle, short trail\r\n        const numPoints = 4; // Number of particles in the trail\r\n        const trailLength = 4.0; // Total length of the trail (shorter than laser bolt length for subtlety)\r\n        const particleLifetime = 150; // milliseconds\r\n\r\n        if (!this.poolManager) {\r\n            console.warn(\"PoolManager not available for projectile trail.\");\r\n            return;\r\n        }\r\n\r\n        const trailContainer = this.poolManager.getTrailContainer();\r\n        if (!trailContainer) {\r\n            console.warn(\"Failed to get trail container from pool.\");\r\n            return;\r\n        }\r\n        projectile.add(trailContainer);\r\n\r\n        const trailParticles = [];\r\n        trailContainer.userData.particles = trailParticles; // Store for release by PoolManager if needed\r\n        trailContainer.userData.isTrailActive = true; // Flag for animation loop\r\n\r\n        for (let i = 0; i < numPoints; i++) {\r\n            const ratio = i / (numPoints -1); // Distribute particles along the trail length\r\n            const particle = this.poolManager.getTrailParticle(i % window.game.trailParticleGeometries.length); // Cycle through available geometries\r\n            \r\n            if (!particle) {\r\n                console.warn(`Failed to get trail particle ${i} from pool.`);\r\n                continue;\r\n            }\r\n\r\n            const offset = direction.clone().multiplyScalar(-ratio * trailLength - 2.0); // Start trail slightly behind the projectile tip\r\n            particle.position.copy(offset);\r\n            \r\n            particle.userData.creationTime = performance.now();\r\n            particle.userData.initialOpacity = particle.material.opacity; // Should be from pre-warmed red material\r\n            particle.userData.initialScale = particle.scale.x; // Assuming uniform scale\r\n            \r\n            trailContainer.add(particle);\r\n            trailParticles.push(particle);\r\n        }\r\n        \r\n        projectile.userData.trail = trailContainer; // For cleanup by PoolManager\r\n\r\n        const animateTrail = () => {\r\n            if (!projectile.parent || !trailContainer.userData.isTrailActive) {\r\n                // Projectile removed or trail explicitly deactivated, stop animation and ensure cleanup\r\n                trailContainer.userData.isTrailActive = false;\r\n                // Particles will be cleaned up by releaseProjectile -> releaseTrail if not already done\r\n                return;\r\n            }\r\n\r\n            for (let i = trailParticles.length - 1; i >= 0; i--) {\r\n                const particle = trailParticles[i];\r\n                const elapsed = performance.now() - particle.userData.creationTime;\r\n                const progress = Math.min(elapsed / particleLifetime, 1.0);\r\n\r\n                if (progress >= 1.0) {\r\n                    this.poolManager.releaseTrailParticle(particle);\r\n                    trailParticles.splice(i, 1);\r\n                    if (particle.parent) particle.parent.remove(particle); // Ensure removal from container\r\n                } else {\r\n                    particle.material.opacity = particle.userData.initialOpacity * (1 - progress);\r\n                    const currentScale = particle.userData.initialScale * (1 - progress);\r\n                    particle.scale.set(currentScale, currentScale, currentScale);\r\n                }\r\n            }\r\n\r\n            if (trailParticles.length === 0) {\r\n                trailContainer.userData.isTrailActive = false; // All particles expired\r\n                // The container itself will be released when the projectile is released.\r\n                return;\r\n            }\r\n            \r\n            requestAnimationFrame(animateTrail);\r\n        };\r\n        \r\n        animateTrail();\r\n    }\r\n    \r\n    /**\r\n     * Clear all active projectiles\r\n     */\r\n    clearAllProjectiles() {\r\n        // Release all projectiles back to the pool\r\n        for (const projectile of this.projectiles) {\r\n            if (this.world && this.world.optimizedProjectiles) {\r\n                try { this.world.optimizedProjectiles.unregister(projectile); } catch {}\r\n            }\r\n            // Remove associated entity from ECS world\r\n            if (projectile.userData && projectile.userData.entityId && this.world) {\r\n                try {\r\n                    this.world.destroyEntity(projectile.userData.entityId);\r\n                } catch (error) {\r\n                    console.error(\"Error removing projectile entity:\", error);\r\n                }\r\n            }\r\n            \r\n            // Return projectile to the pool\r\n            this.poolManager.releaseProjectile(projectile);\r\n        }\r\n        \r\n        // Clear the tracking array\r\n        this.projectiles = [];\r\n        \r\n        console.log(\"All projectiles cleared and returned to the pool\");\r\n    }\r\n    \r\n    // New method to visualize projectile trajectory\r\n    createAimingTracer(startPosition, direction, distance = 3000) {\r\n        // Get a tracer from the pool\r\n        const tracer = this.poolManager.getTracer();\r\n        \r\n        // Calculate end position\r\n        const endPosition = startPosition.clone().add(direction.clone().multiplyScalar(distance));\r\n        \r\n        // Update the positions in the geometry\r\n        const positions = tracer.geometry.attributes.position.array;\r\n        positions[0] = startPosition.x;\r\n        positions[1] = startPosition.y;\r\n        positions[2] = startPosition.z;\r\n        positions[3] = endPosition.x;\r\n        positions[4] = endPosition.y;\r\n        positions[5] = endPosition.z;\r\n        \r\n        // Mark the position attribute as needing update\r\n        tracer.geometry.attributes.position.needsUpdate = true;\r\n        \r\n        // The pool manager will automatically handle animation and cleanup\r\n        \r\n        return tracer;\r\n    }\r\n    \r\n    /**\r\n     * Create a laser burst effect that travels forward with the projectile\r\n     * @param {THREE.Vector3} position Position for the effect\r\n     * @param {THREE.Vector3} direction Direction the effect should travel\r\n     */\r\n    createMuzzleFlash(position, direction) {\r\n        // Get a muzzle flash from the pool\r\n        const muzzleFlash = this.poolManager.getMuzzleFlash();\r\n        \r\n        // Position and orient the flash\r\n        muzzleFlash.position.copy(position);\r\n        // Orient the flash to point away from the ship, along the direction of fire\r\n        const lookAtPosition = position.clone().add(direction.clone().normalize().multiplyScalar(10)); // Look 10 units along direction\r\n        muzzleFlash.lookAt(lookAtPosition);\r\n        \r\n        // Store reference to initial position and direction for animation\r\n        muzzleFlash.userData.initialPosition = position.clone();\r\n        muzzleFlash.userData.direction = direction.clone();\r\n        \r\n        // Set up the flash light\r\n        const flashLight = muzzleFlash.userData.flashLight;\r\n        if (flashLight) {\r\n            flashLight.position.copy(position);\r\n            flashLight.intensity = 200;\r\n        }\r\n        \r\n        // The pool manager will automatically handle animation and cleanup via its update method\r\n        // which checks the progress and releases back to the pool when complete\r\n        \r\n        return muzzleFlash;\r\n    }\r\n    \r\n    /**\r\n     * Dispose Combat module resources\r\n     * Clean up all pools, geometries, and other resources\r\n     */\r\n    dispose() {\r\n        console.log(\"Disposing Combat module resources...\");\r\n        \r\n        // Clear all active projectiles\r\n        this.clearAllProjectiles();\r\n        \r\n        // Dispose pool manager if it exists\r\n        if (this.poolManager) {\r\n            this.poolManager.dispose();\r\n            this.poolManager = null;\r\n        }\r\n        \r\n        // Mark as disposed\r\n        this.disposed = true;\r\n        \r\n        console.log(\"Combat module resources disposed\");\r\n    }\r\n\r\n    // --- Renderer facade helpers to centralize scene mutations ---\r\n    _addToScene(object) {\r\n        const renderer = window.game && window.game.renderer ? window.game.renderer : null;\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => renderer.add(object));\r\n        } else if (this.scene && typeof this.scene.add === 'function') {\r\n            // Fallback for safety; may warn in dev via guard wrapper\r\n            this.scene.add(object);\r\n        }\r\n    }\r\n\r\n    _removeFromScene(object) {\r\n        const renderer = window.game && window.game.renderer ? window.game.renderer : null;\r\n        if (renderer && typeof renderer._withGuard === 'function') {\r\n            renderer._withGuard(() => this.scene.remove(object));\r\n        } else if (this.scene && typeof this.scene.remove === 'function') {\r\n            // Fallback for safety\r\n            this.scene.remove(object);\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * Import and register a system\r\n     * @param {string} path The path to the system module\r\n     * @param {string} className The name of the system class\r\n     * @returns {Object} The system instance\r\n     */\r\n    async importAndRegisterSystem(path, className) {\r\n        try {\r\n            // Add vite-ignore to allow dynamic imports\r\n            // @ts-ignore\r\n            const module = await import(/* @vite-ignore */ path);\r\n            if (!module[className]) {\r\n                console.error(`[COMBAT] System class ${className} not found in module ${path}`);\r\n                return null;\r\n            }\r\n            \r\n            const SystemClass = module[className];\r\n            // Pass world and scene to systems that might need them for rendering or context\r\n            let system;\r\n            if (className === 'TrailSystem' || className === 'VisualEffectsSystem' || className === 'RenderSystem') {\r\n                 // These systems might specifically need the scene\r\n                system = new SystemClass(this.world, this.scene);\r\n            } else {\r\n                system = new SystemClass(this.world);\r\n            }\r\n            return system;\r\n        } catch (error) {\r\n            console.error(`[COMBAT] Error importing system ${className} from ${path}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n}\r\n\r\n// Helper to remove the addProjectileTrail method entirely if it exists as a standalone function in an unexpected way\r\n// This is unlikely given typical class structure but added for robustness\r\n// if (typeof Combat !== 'undefined' && Combat.prototype.addProjectileTrail) {\r\n// delete Combat.prototype.addProjectileTrail;\r\n//     console.log(\"Dynamically removed addProjectileTrail from Combat prototype if it existed.\");\r\n// }"],"file":"assets/modules-D5g6XVSd.js"}