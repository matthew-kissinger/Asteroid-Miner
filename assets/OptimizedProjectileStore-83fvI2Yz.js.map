{"version":3,"file":"OptimizedProjectileStore-83fvI2Yz.js","sources":["../../js/core/optimized/OptimizedProjectileStore.js"],"sourcesContent":["// OptimizedProjectileStore.js - TypedArray-backed projectile data\n\nexport class OptimizedProjectileStore {\n  constructor(capacity = 2048) {\n    this.capacity = capacity;\n    this.count = 0;\n    this.pos = new Float32Array(capacity * 3);\n    this.vel = new Float32Array(capacity * 3);\n    this.alive = new Uint8Array(capacity);\n    this.idToIndex = new Map();\n    this.indexToProjectile = new Array(capacity);\n  }\n\n  _allocIndex() {\n    if (this.count >= this.capacity) return -1;\n    const idx = this.count++;\n    return idx;\n  }\n\n  register(projectile) {\n    const idx = this._allocIndex();\n    if (idx === -1) return -1;\n    this.idToIndex.set(projectile.uuid || projectile.id || idx, idx);\n    this.indexToProjectile[idx] = projectile;\n    this.alive[idx] = 1;\n    // initialize from projectile\n    const p = projectile.position;\n    this.pos[idx * 3 + 0] = p.x;\n    this.pos[idx * 3 + 1] = p.y;\n    this.pos[idx * 3 + 2] = p.z;\n    const v = projectile.velocity || { x: 0, y: 0, z: 0 };\n    this.vel[idx * 3 + 0] = v.x;\n    this.vel[idx * 3 + 1] = v.y;\n    this.vel[idx * 3 + 2] = v.z;\n    return idx;\n  }\n\n  unregisterByIndex(idx) {\n    if (idx < 0 || idx >= this.count) return;\n    this.alive[idx] = 0;\n    this.indexToProjectile[idx] = null;\n  }\n\n  unregister(projectile) {\n    const id = projectile.uuid || projectile.id;\n    if (id == null) return;\n    const idx = this.idToIndex.get(id);\n    if (idx == null) return;\n    this.alive[idx] = 0;\n    this.indexToProjectile[idx] = null;\n    this.idToIndex.delete(id);\n  }\n\n  update(dt) {\n    const n = this.count;\n    for (let i = 0; i < n; i++) {\n      if (!this.alive[i]) continue;\n      const pi = i * 3;\n      this.pos[pi + 0] += this.vel[pi + 0] * dt;\n      this.pos[pi + 1] += this.vel[pi + 1] * dt;\n      this.pos[pi + 2] += this.vel[pi + 2] * dt;\n      const proj = this.indexToProjectile[i];\n      if (proj && proj.position) {\n        proj.position.set(this.pos[pi + 0], this.pos[pi + 1], this.pos[pi + 2]);\n      }\n    }\n  }\n}\n\n\n"],"names":["OptimizedProjectileStore","capacity","projectile","idx","p","v","id","dt","n","i","pi","proj"],"mappings":"AAEO,MAAMA,CAAyB,CACpC,YAAYC,EAAW,KAAM,CAC3B,KAAK,SAAWA,EAChB,KAAK,MAAQ,EACb,KAAK,IAAM,IAAI,aAAaA,EAAW,CAAC,EACxC,KAAK,IAAM,IAAI,aAAaA,EAAW,CAAC,EACxC,KAAK,MAAQ,IAAI,WAAWA,CAAQ,EACpC,KAAK,UAAY,IAAI,IACrB,KAAK,kBAAoB,IAAI,MAAMA,CAAQ,CAC/C,CAEE,aAAc,CACZ,OAAI,KAAK,OAAS,KAAK,SAAiB,GAC5B,KAAK,OAErB,CAEE,SAASC,EAAY,CACnB,MAAMC,EAAM,KAAK,YAAa,EAC9B,GAAIA,IAAQ,GAAI,MAAO,GACvB,KAAK,UAAU,IAAID,EAAW,MAAQA,EAAW,IAAMC,EAAKA,CAAG,EAC/D,KAAK,kBAAkBA,CAAG,EAAID,EAC9B,KAAK,MAAMC,CAAG,EAAI,EAElB,MAAMC,EAAIF,EAAW,SACrB,KAAK,IAAIC,EAAM,EAAI,CAAC,EAAIC,EAAE,EAC1B,KAAK,IAAID,EAAM,EAAI,CAAC,EAAIC,EAAE,EAC1B,KAAK,IAAID,EAAM,EAAI,CAAC,EAAIC,EAAE,EAC1B,MAAMC,EAAIH,EAAW,UAAY,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,CAAG,EACrD,YAAK,IAAIC,EAAM,EAAI,CAAC,EAAIE,EAAE,EAC1B,KAAK,IAAIF,EAAM,EAAI,CAAC,EAAIE,EAAE,EAC1B,KAAK,IAAIF,EAAM,EAAI,CAAC,EAAIE,EAAE,EACnBF,CACX,CAEE,kBAAkBA,EAAK,CACjBA,EAAM,GAAKA,GAAO,KAAK,QAC3B,KAAK,MAAMA,CAAG,EAAI,EAClB,KAAK,kBAAkBA,CAAG,EAAI,KAClC,CAEE,WAAWD,EAAY,CACrB,MAAMI,EAAKJ,EAAW,MAAQA,EAAW,GACzC,GAAII,GAAM,KAAM,OAChB,MAAMH,EAAM,KAAK,UAAU,IAAIG,CAAE,EAC7BH,GAAO,OACX,KAAK,MAAMA,CAAG,EAAI,EAClB,KAAK,kBAAkBA,CAAG,EAAI,KAC9B,KAAK,UAAU,OAAOG,CAAE,EAC5B,CAEE,OAAOC,EAAI,CACT,MAAMC,EAAI,KAAK,MACf,QAASC,EAAI,EAAGA,EAAID,EAAGC,IAAK,CAC1B,GAAI,CAAC,KAAK,MAAMA,CAAC,EAAG,SACpB,MAAMC,EAAKD,EAAI,EACf,KAAK,IAAIC,EAAK,CAAC,GAAK,KAAK,IAAIA,EAAK,CAAC,EAAIH,EACvC,KAAK,IAAIG,EAAK,CAAC,GAAK,KAAK,IAAIA,EAAK,CAAC,EAAIH,EACvC,KAAK,IAAIG,EAAK,CAAC,GAAK,KAAK,IAAIA,EAAK,CAAC,EAAIH,EACvC,MAAMI,EAAO,KAAK,kBAAkBF,CAAC,EACjCE,GAAQA,EAAK,UACfA,EAAK,SAAS,IAAI,KAAK,IAAID,EAAK,CAAC,EAAG,KAAK,IAAIA,EAAK,CAAC,EAAG,KAAK,IAAIA,EAAK,CAAC,CAAC,CAE9E,CACA,CACA"}