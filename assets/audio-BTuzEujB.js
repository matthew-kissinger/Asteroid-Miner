var d=Object.defineProperty;var h=(r,e,t)=>e in r?d(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>h(r,typeof e!="symbol"?e+"":e,t);import{g as c}from"./pathUtils-CUZPms8F.js";class g{constructor(){i(this,"audioContext",null);i(this,"activeNodes",new Set);i(this,"gcInterval",null);i(this,"masterEQ",null);this.initializeContext(),this.setupGarbageCollection()}initializeContext(){try{const e=window.AudioContext||window.webkitAudioContext;e?(this.audioContext=new e,console.log("Web Audio API context created successfully")):console.error("Web Audio API not supported in this browser")}catch(e){console.error("Failed to create Web Audio API context:",e)}}resumeAudioContext(){return this.audioContext&&this.audioContext.state==="suspended"?this.audioContext.resume().then(()=>{console.log("AudioContext resumed successfully")}).catch(e=>{console.error("Failed to resume AudioContext:",e)}):Promise.resolve()}getContext(){return this.audioContext}isReady(){return this.audioContext!==null&&this.audioContext.state!=="closed"}setupGarbageCollection(){this.gcInterval=setInterval(()=>this.cleanupInactiveNodes(),3e4),console.log("Audio garbage collection scheduled")}cleanupInactiveNodes(){let e=0;this.activeNodes.forEach(t=>{(t._inactive||t.disposed===!0)&&(this.activeNodes.delete(t),e++)}),e>0&&console.log(`Audio context: cleaned up ${e} inactive audio objects`)}trackNode(e){return e&&this.activeNodes.add(e),e}initializeToneCompatibility(){return this.masterEQ={connect:function(e){return e}},console.log("Audio compatibility layer initialized for intro sequence"),this.masterEQ}cleanup(){return console.log("Cleaning up AudioContext resources..."),this.gcInterval&&(clearInterval(this.gcInterval),this.gcInterval=null),this.audioContext?this.audioContext.close().then(()=>{console.log("AudioContext closed successfully"),this.audioContext=null}).catch(e=>{console.error("Error closing AudioContext:",e)}):Promise.resolve()}}class m{constructor(e){i(this,"audioContextManager");i(this,"sounds",{});this.audioContextManager=e}getPath(e){return c(e)}async loadAndDecodeSound(e,t){try{console.log(`Loading and decoding sound: ${e} from ${t}`);const o=this.audioContextManager.getContext();if(!o)throw new Error("AudioContext not available");const n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch sound ${e}: ${n.status} ${n.statusText}`);const s=await n.arrayBuffer(),a=await o.decodeAudioData(s);return this.sounds[e]=a,console.log(`Sound ${e} loaded and decoded successfully`),a}catch(o){throw console.error(`Error loading and decoding sound ${e}:`,o),this.sounds[e]=null,o}}async preDecodeEssentialSounds(){try{console.log("Pre-decoding essential UI sounds...");const t=[{name:"boink",path:"sounds/effects/boink.wav"},{name:"phaserUp",path:"sounds/effects/phaserUp.wav"},{name:"phaserDown",path:"sounds/effects/phaserDown.wav"}].map(o=>this.loadAndDecodeSound(o.name,this.getPath(o.path)));await Promise.all(t),console.log("Essential UI sounds pre-decoded successfully")}catch(e){console.error("Error pre-decoding essential sounds:",e),this.createDummySounds()}}async loadGameplaySounds(){try{console.log("Loading gameplay sounds in background...");const e=[{name:"thrust",path:"sounds/effects/thrust.wav"},{name:"laser",path:"sounds/effects/laser.wav"},{name:"mining-laser",path:"sounds/effects/mining-laser.wav"},{name:"explosion",path:"sounds/effects/explosion.wav"}];for(const t of e)try{await this.loadAndDecodeSound(t.name,this.getPath(t.path))}catch(o){console.warn(`Could not load gameplay sound ${t.name}:`,o)}this.sounds.laser&&!this.sounds.projectile&&(console.log("Setting up projectile sound using laser sound buffer"),this.sounds.projectile=this.sounds.laser),console.log("All gameplay sounds loaded successfully")}catch(e){console.error("Error loading gameplay sounds:",e)}}createDummySounds(){console.warn("Creating dummy silent AudioBuffers as fallback");const e=["laser","thrust","explosion","boink","phaserUp","phaserDown","mining-laser","projectile"],t=this.audioContextManager.getContext();for(const o of e)if(t)try{const n=t.createBuffer(2,t.sampleRate*.1,t.sampleRate);this.sounds[o]=n}catch(n){console.error(`Failed to create dummy buffer for ${o}:`,n),this.sounds[o]=null}else this.sounds[o]=null}async checkFileExists(e){console.log(`Checking if file/directory exists: ${e}`);try{const t=await fetch(e,{method:"HEAD",cache:"no-cache"});return console.log(`Fetch response for ${e}: status=${t.status}, ok=${t.ok}`),{path:e,exists:t.ok}}catch(t){return console.error(`Error checking if file exists (${e}):`,t),{path:e,exists:!1}}}async checkSoundDirectories(){return(await this.checkFileExists(this.getPath("sounds"))).exists||console.warn("Sounds directory not found, but will attempt to load files directly anyway."),(await this.checkFileExists(this.getPath("sounds/soundtrack"))).exists||console.warn("Soundtrack directory not found, but will attempt to load files directly anyway."),(await this.checkFileExists(this.getPath("sounds/effects"))).exists||console.warn("Sound effects directory not found. Some sounds may not play correctly."),!0}getSound(e){return this.sounds[e]}getAllSounds(){return this.sounds}}class f{constructor(){i(this,"music",[]);i(this,"musicVolume",.21)}getPath(e){return c(e)}shuffleArray(e){let t=e.length,o;for(;t>0;)o=Math.floor(Math.random()*t),t--,[e[t],e[o]]=[e[o],e[t]];return e}async checkFileExists(e){console.log(`Checking if file/directory exists: ${e}`);try{const t=await fetch(e,{method:"HEAD",cache:"no-cache"});return console.log(`Fetch response for ${e}: status=${t.status}, ok=${t.ok}`),{path:e,exists:t.ok}}catch(t){return console.error(`Error checking if file exists (${e}):`,t),{path:e,exists:!1}}}async loadBackgroundMusic(){try{console.log("Loading soundtrack files...");const e=[this.getPath("sounds/soundtrack/The Sound of Lightyears.wav"),this.getPath("sounds/soundtrack/Aurora Drifts.wav"),this.getPath("sounds/soundtrack/Tidal Lock.wav"),this.getPath("sounds/soundtrack/Solar Drift.wav"),this.getPath("sounds/soundtrack/Orbital Resonance.wav"),this.getPath("sounds/soundtrack/Starlight Trails.wav"),this.getPath("sounds/soundtrack/Orbit Bloom.wav")];console.log(`Loading ${e.length} soundtrack files...`),await this.loadMusicFiles(e)}catch(e){console.error("Error loading background music:",e),console.warn("Falling back to a dummy silent track"),this.createDummyTrack()}}async loadMusicFiles(e){console.log(`Found ${e.length} music files:`,e);const t=[...e];this.shuffleArray(t),console.log("Randomized playlist order:",t.map(n=>n.split("/").pop()));let o=!1;for(const n of t)if((await this.checkFileExists(n)).exists){o=!0;break}if(!o){console.warn("None of the music files could be found. Using fallback audio."),this.createDummyTrack();return}for(const n of t)try{console.log(`Attempting to load audio file: ${n}`);const s=new Audio(n);s.loop=!1,s.volume=this.musicVolume,s.addEventListener("error",a=>{console.error(`Error loading music file ${n}:`,a)}),s.addEventListener("canplaythrough",()=>{console.log(`Successfully loaded music file: ${n}`)}),this.music.push(s),console.log(`Added music track to playlist: ${n}`)}catch(s){console.error(`Failed to load music file ${n}:`,s)}console.log(`Loaded ${this.music.length} music tracks in randomized order`),this.music.length===0&&(console.warn("No music files could be loaded, creating a dummy track"),this.createDummyTrack())}createDummyTrack(){const e=new Audio;e.loop=!0,this.music.push(e)}playNextTrack(){if(this.music.length===0)return null;const e=this.music.shift();return e&&this.music.push(e),this.getCurrentTrack()}getCurrentTrack(){return this.music.length>0?this.music[0]:null}getTracks(){return this.music}setVolume(e){this.musicVolume=e;for(const t of this.music)t.volume=e}getVolume(){return this.musicVolume}hasTracks(){return this.music.length>0}}class p{constructor(e){i(this,"playlist");i(this,"currentMusic",null);i(this,"muted",!1);this.playlist=e}playBackgroundMusic(e){if(!this.playlist.hasTracks()||this.muted)return;if(!e){console.log("Deferring music playback until user interaction");return}const t=this.playlist.getCurrentTrack();if(!t)return;console.log(`Starting to play track: ${t.src.split("/").pop()}`),t.hasEndedListener||(t.addEventListener("ended",()=>this.playNextTrack(e)),t.hasEndedListener=!0),t.currentTime=0;const o=t.play();o!==void 0?o.then(()=>{console.log("Started playing background music"),this.currentMusic=t}).catch(n=>{n.name==="NotAllowedError"?console.log("Autoplay prevented by browser. Music will play after user interaction."):console.error("Error playing background music:",n)}):this.currentMusic=t}playNextTrack(e){this.playlist.playNextTrack()&&e&&this.playBackgroundMusic(e)}toggleMute(){this.muted=!this.muted;const e=this.playlist.getTracks();for(const t of e)t.volume=this.muted?0:this.playlist.getVolume();return console.log(`Music ${this.muted?"muted":"unmuted"}`),this.muted}setVolume(e){this.playlist.setVolume(this.muted?0:e)}getVolume(){return this.playlist.getVolume()}isMuted(){return this.muted}pauseAll(){const e=this.playlist.getTracks();for(const t of e)t.pause();this.currentMusic=null}getCurrentTrack(){return this.currentMusic}}class y{constructor(e,t){i(this,"audioContextManager");i(this,"audioLoader");i(this,"sfxVolume",.5);i(this,"muted",!1);i(this,"lastWeaponSoundPlayTime",0);i(this,"weaponSoundCooldown",70);i(this,"activeSounds",{laser:null,thrust:null,"mining-laser":null});this.audioContextManager=e,this.audioLoader=t}playSound(e,t){if(console.log(`Attempting to play sound: ${e}`),this.muted){console.log(`Sound ${e} not played: audio is muted`);return}if(!t){console.log(`Sound ${e} not played: waiting for user interaction`);return}const o=this.audioContextManager.getContext();if(!o){console.warn("AudioContext not available for playing sound");return}if(o.state==="suspended"&&this.audioContextManager.resumeAudioContext(),e==="weapon"||e==="fire"||e==="shoot"){console.log(`Mapping ${e} sound to projectile sound`),e="projectile";const s=this.audioLoader.getAllSounds();!s.projectile&&s.laser&&(console.log("Using laser sound for projectile"),s.projectile=s.laser)}const n=this.audioLoader.getSound(e);if(!n){console.warn(`Sound "${e}" not found in loaded sounds`);return}try{if(e==="laser"||e==="thrust"||e==="mining-laser"){if(!this.activeSounds[e]){const s=o.createBufferSource();s.buffer=n,s.loop=!0;const a=o.createGain();a.gain.value=this.sfxVolume*(e==="thrust"?1.5:1),s.connect(a),a.connect(o.destination),s.start(0),this.activeSounds[e]={source:s,gain:a},this.audioContextManager.trackNode(s),this.audioContextManager.trackNode(a)}}else{const s=o.createBufferSource();s.buffer=n;const a=o.createGain(),u=e==="projectile"?.7:.5;a.gain.value=this.sfxVolume*u,s.connect(a),a.connect(o.destination),s.start(0),s.onended=()=>{s._inactive=!0,a._inactive=!0},this.audioContextManager.trackNode(s),this.audioContextManager.trackNode(a),console.log(`Started playback of one-shot sound: ${e}`)}}catch(s){console.error(`Error playing sound ${e}:`,s)}}stopSound(e){if(this.activeSounds[e])try{if(e==="laser"||e==="thrust"||e==="mining-laser"){const t=this.activeSounds[e];if(t){if(t.source){try{t.source.stop()}catch{}t.source._inactive=!0}t.gain&&(t.gain._inactive=!0),this.activeSounds[e]=null}}}catch(t){console.error(`Error stopping sound ${e}:`,t)}}setThrustVolume(e){const t=this.activeSounds.thrust;if(!t||!t.gain)return;const o=Math.min(1,Math.max(.1,e))*this.sfxVolume*1.5;try{t.gain.gain.value=o}catch(n){console.error("Error setting thrust volume:",n)}}playWeaponSound(e){if(console.log("Playing weapon firing sound"),this.muted||!e)return;const t=this.audioContextManager.getContext();if(!t){console.warn("AudioContext not available for weapon sound");return}t.state==="suspended"&&this.audioContextManager.resumeAudioContext();const o=this.audioLoader.getAllSounds();if(!o.projectile&&o.laser&&(console.log("Using laser sound for projectile in playWeaponSound"),o.projectile=o.laser),!o.projectile){console.warn("Projectile sound not found");return}const n=performance.now();if(!(n-this.lastWeaponSoundPlayTime<this.weaponSoundCooldown)){this.lastWeaponSoundPlayTime=n;try{const s=t.createBufferSource();s.buffer=o.projectile;const a=Math.random()*100-50;s.detune.value=a;const u=t.createGain();u.gain.value=this.sfxVolume*.8,s.connect(u),u.connect(t.destination),s.start(0),s.onended=()=>{s._inactive=!0,u._inactive=!0},this.audioContextManager.trackNode(s),this.audioContextManager.trackNode(u),console.log("Weapon sound started playing")}catch(s){console.error("Error playing weapon sound:",s)}}}toggleMute(){return this.muted=!this.muted,this.muted&&(this.stopSound("laser"),this.stopSound("thrust"),this.stopSound("mining-laser")),console.log(`Sound effects ${this.muted?"muted":"unmuted"}`),this.muted}setVolume(e){this.sfxVolume=e}getVolume(){return this.sfxVolume}isMuted(){return this.muted}stopAllSounds(){this.stopSound("laser"),this.stopSound("thrust"),this.stopSound("mining-laser")}}class x{constructor(e,t){i(this,"audioContextManager");i(this,"musicPlayer");i(this,"userHasInteracted",!1);this.audioContextManager=e,this.musicPlayer=t,this.setupUserInteractionListener()}hasUserInteracted(){return this.userHasInteracted}showDirectoryMissingNotification(e){console.warn(`Directory not found: ${e}`);const t=document.createElement("div");t.style.position="fixed",t.style.top="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="#ff4400",t.style.padding="10px 15px",t.style.borderRadius="5px",t.style.zIndex="9999",t.style.fontSize="14px",t.style.maxWidth="80%",t.style.textAlign="center",t.innerHTML=`
            <div style="margin-bottom: 5px;">
                <strong>Note:</strong> ${e} directory not found.
            </div>
            <div style="font-size: 12px; color: #aaa;">
                Game will continue with limited audio. This is normal when running on GitHub Pages.
            </div>
        `;const o=document.createElement("div");o.style.position="absolute",o.style.top="5px",o.style.right="10px",o.style.cursor="pointer",o.style.color="#aaa",o.textContent="âœ•",o.addEventListener("click",()=>t.remove()),t.appendChild(o),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&(t.style.opacity="0",t.style.transition="opacity 0.5s ease",setTimeout(()=>{document.body.contains(t)&&t.remove()},500))},5e3)}setupUserInteractionListener(){const e=()=>{this.userHasInteracted||(this.userHasInteracted=!0,console.log("User interaction detected, enabling audio playback"),this.audioContextManager.resumeAudioContext(),this.musicPlayer.playBackgroundMusic(!0),document.removeEventListener("click",e),document.removeEventListener("keydown",e),document.removeEventListener("touchstart",e))};if(document.addEventListener("click",e),document.addEventListener("keydown",e),document.addEventListener("touchstart",e),"ontouchstart"in window||navigator.maxTouchPoints>0){console.log("Mobile device detected - adding additional audio handlers");const t=()=>{this.userHasInteracted=!0,this.audioContextManager.resumeAudioContext();const n=this.musicPlayer.playlist;if(n.hasTracks()&&!this.musicPlayer.isMuted()){const s=n.getCurrentTrack();s&&s.paused&&(console.log("Mobile: Forcing background music playback"),this.musicPlayer.playBackgroundMusic(!0))}};document.addEventListener("touchend",t,{passive:!0});const o=()=>{let n=0;const s=setInterval(()=>{n++;const a=document.querySelectorAll("button");a.length>0&&(console.log(`Mobile: Found ${a.length} buttons to attach audio handlers`),a.forEach(u=>{const l=u;l.hasAudioHandler||(l.addEventListener("touchend",t,{passive:!0}),l.hasAudioHandler=!0)})),n>=10&&clearInterval(s)},500)};o(),document.readyState==="complete"?o():window.addEventListener("load",o)}}cleanup(){this.userHasInteracted=!1,console.log("Mobile audio enabler cleanup complete")}}class v{constructor(){i(this,"audioContextManager");i(this,"audioLoader");i(this,"musicPlaylist");i(this,"musicPlayer");i(this,"soundPlayer");i(this,"mobileEnabler");i(this,"sounds");i(this,"soundSources",{});i(this,"backgroundMusic",[]);i(this,"currentMusicIndex",0);i(this,"currentMusic",null);i(this,"music");i(this,"activeNodes");i(this,"activeSounds");i(this,"masterEQ");this.audioContextManager=new g,this.audioLoader=new m(this.audioContextManager),this.musicPlaylist=new f,this.musicPlayer=new p(this.musicPlaylist),this.soundPlayer=new y(this.audioContextManager,this.audioLoader),this.mobileEnabler=new x(this.audioContextManager,this.musicPlayer),this.sounds=this.audioLoader.getAllSounds(),this.music=this.musicPlaylist.getTracks(),this.activeNodes=this.audioContextManager.activeNodes,this.activeSounds=this.soundPlayer.activeSounds,this.masterEQ=this.audioContextManager.initializeToneCompatibility(),console.log("Initializing audio manager with Web Audio API...")}get isMuted(){return this.soundPlayer.isMuted()||this.musicPlayer.isMuted()}set isMuted(e){e!==this.isMuted&&this.toggleMute()}get muted(){return this.isMuted}set muted(e){this.isMuted=e}get musicVolume(){return this.musicPlayer.getVolume()}set musicVolume(e){this.musicPlayer.setVolume(e)}get sfxVolume(){return this.soundPlayer.getVolume()}set sfxVolume(e){this.soundPlayer.setVolume(e)}get userHasInteracted(){return this.mobileEnabler.hasUserInteracted()}get audioContext(){return this.audioContextManager.getContext()}async initialize(){try{console.log("Loading audio files...");const e=this.audioContext;return e&&e.state==="suspended"&&this.audioContextManager.resumeAudioContext(),await this.audioLoader.checkSoundDirectories(),await this.audioLoader.preDecodeEssentialSounds(),this.musicPlaylist.loadBackgroundMusic().catch(t=>{console.error("Error loading background music:",t)}),console.log("Essential audio initialization complete"),this.userHasInteracted?this.musicPlayer.playBackgroundMusic(!0):console.log("Music playback waiting for user interaction."),setTimeout(()=>{this.audioLoader.loadGameplaySounds()},1e3),!0}catch(e){return console.error("Error initializing audio:",e),!1}}async preDecodeAllSoundEffects(){console.log("Using optimized sound loading path instead of preDecodeAllSoundEffects"),await this.audioLoader.preDecodeEssentialSounds(),await this.audioLoader.loadGameplaySounds()}resumeAudioContext(){return this.audioContextManager.resumeAudioContext()}playBackgroundMusic(){this.musicPlayer.playBackgroundMusic(this.userHasInteracted)}playNextTrack(){this.musicPlayer.playNextTrack(this.userHasInteracted)}playSound(e){this.soundPlayer.playSound(e,this.userHasInteracted)}stopSound(e){this.soundPlayer.stopSound(e)}setThrustVolume(e){this.soundPlayer.setThrustVolume(e)}playWeaponSound(){this.soundPlayer.playWeaponSound(this.userHasInteracted)}toggleMute(){const e=this.soundPlayer.toggleMute(),t=this.musicPlayer.toggleMute(),o=e||t;return console.log(`Audio ${o?"muted":"unmuted"}`),o}trackNode(e){return this.audioContextManager.trackNode(e)}cleanupInactiveNodes(){this.audioContextManager.cleanupInactiveNodes()}setupGarbageCollection(){console.log("Garbage collection already set up in context manager")}setupUserInteractionListener(){console.log("User interaction listener already set up in mobile enabler")}initializeToneCompatibility(){return this.masterEQ}cleanup(){console.log("Cleaning up AudioManager resources..."),this.soundPlayer.stopAllSounds(),this.musicPlayer.pauseAll(),this.mobileEnabler.cleanup(),this.audioContextManager.cleanup(),console.log("AudioManager cleanup complete")}}export{v as AudioManager};
//# sourceMappingURL=audio-BTuzEujB.js.map
