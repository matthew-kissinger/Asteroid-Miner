{"version":3,"mappings":"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","names":["Game","__publicField","event","initializeGlobals","mainMessageBus","data","GameInitializer","DifficultyManager","__vitePreload","HordeMode","AudioUpdater","GameLifecycle","ObjectPools","GameLoop","StartupSequence","Diagnostics","initECS","updateECS","_a","error","reason","deltaTime","position","v","system","startGameMainModule","loadingOverlay","errorMessage","reloadButton","cacheBuster"],"ignoreList":[],"sources":["../../js/main.ts"],"sourcesContent":["// main.ts - Main entry point for the game (ultra-lean refactored version)\n\n// Import refactored modules\nimport { initializeGlobals } from './main/globals.js';\nimport { StartupSequence } from './main/startupSequence.js';\nimport { GameLoop } from './main/gameLoop.js';\nimport { Diagnostics } from './main/diagnostics.js';\nimport { GameInitializer } from './main/gameInitializer.js';\nimport { mainMessageBus } from './globals/messageBus.ts';\n// Removed direct imports for ObjectPools, DifficultyManager, HordeMode, AudioUpdater, GameLifecycle\n// import { ObjectPools } from './main/objectPools.js';\n// import { DifficultyManager } from './main/difficultyManager.js';\n// import { HordeMode } from './main/hordeMode.js';\n// import { AudioUpdater } from './main/audioUpdater.js';\n// import { GameLifecycle } from './main/gameLifecycle.ts';\n\n// Import bitECS systems\n// import { initECS, updateECS } from './ecs/systems/index.js'; // Removed direct import\n\nexport class Game {\n    initializer: any;\n    lifecycle: any;\n    difficultyManager: any;\n    hordeMode: any;\n    audioUpdater: any;\n    objectPools: any;\n    gameLoop: any;\n    boundAnimate: any;\n    startupSequence: any;\n    diagnostics: any;\n    isGameOver: boolean = false;\n    introSequenceActive: boolean = false;\n    gameTime: number = 0;\n    isMobile: boolean = false;\n    ui: any;\n    physics: any;\n    spaceship: any;\n    camera: any;\n    combat: any;\n    world: any;\n    renderer: any;\n    audio: any;\n    private _environment: any;\n    private _controls: any;\n    private _updateECS: ((deltaTime: number) => void) | undefined; // New property\n\n    constructor() {\n        // Initialize globals first\n        initializeGlobals();\n        \n        // Make game instance globally accessible for emergency access\n        window.game = this;\n        \n        // Subscribe to global events\n        mainMessageBus.subscribe('game.over', (data: any) => {\n            if (this.lifecycle) {\n                this.lifecycle.gameOver(data.reason || 'Game Over');\n            }\n        });\n\n        // Initialize core game systems\n        this.initializer = new GameInitializer(this);\n    }\n\n    async initialize() {\n        try {\n            await this.initializer.initializeCore();\n\n            // Game state\n            this.isGameOver = false;\n            this.introSequenceActive = false;\n            this.gameTime = 0;\n\n            // Detect mobile device\n            this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||\n                           (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);\n\n            // Initialize managers\n            const { DifficultyManager } = await import('./main/difficultyManager.js');\n            this.difficultyManager = new DifficultyManager();\n            \n            const { HordeMode } = await import('./main/hordeMode.js');\n            this.hordeMode = new HordeMode(this);\n            \n            const { AudioUpdater } = await import('./main/audioUpdater.js');\n            this.audioUpdater = new AudioUpdater(this);\n            \n            const { GameLifecycle } = await import('./main/gameLifecycle.ts');\n            this.lifecycle = new GameLifecycle(this);\n            \n            const { ObjectPools } = await import('./main/objectPools.js');\n            this.objectPools = new ObjectPools(this);\n\n            // Register event handlers\n            this.initializer.setupEventHandlers();\n\n            // Initialize game loop\n            this.gameLoop = new GameLoop(this);\n            this.boundAnimate = this.gameLoop.boundAnimate;\n\n            // Apply frame rate settings if available\n            if (this.ui && this.ui.settings) {\n                this.gameLoop.applyFrameRateSettings();\n            }\n\n            // Initialize startup sequence\n            this.startupSequence = new StartupSequence(this);\n\n            // Initialize diagnostics\n            this.diagnostics = new Diagnostics(this);\n\n            // Initialize bitECS systems (pass scene for test entity mesh)\n            const { initECS, updateECS } = await import('./ecs/systems/index.js');\n            initECS(this.renderer?.scene);\n            this._updateECS = updateECS;\n\n            // Start the initialization sequence\n            this.startupSequence.initializeGameSequence();\n        } catch (error) {\n            throw error;\n        }\n    }\n    \n    // Delegation methods\n    async initIntroSequence() {\n        await this.startupSequence.initIntroSequence();\n    }\n    \n    async startIntroSequence() {\n        await this.startupSequence.startIntroSequence();\n    }\n    \n    completeIntroSequence() {\n        this.startupSequence.completeIntroSequence();\n    }\n    \n    preWarmBasicShaders() {\n        this.objectPools.preWarmBasicShaders();\n    }\n    \n    initializeObjectPools() {\n        this.objectPools.initializeObjectPools();\n    }\n    \n    startDocked() {\n        this.initializer.startDocked();\n    }\n    \n    setupEventHandlers() {\n        this.initializer.setupEventHandlers();\n    }\n    \n    initializeDifficultyManager() {\n        // Compatibility method - difficulty manager is now initialized in constructor\n    }\n    \n    activateHordeMode() {\n        this.hordeMode.activate();\n    }\n    \n    getFormattedHordeSurvivalTime() {\n        return this.hordeMode.getFormattedSurvivalTime();\n    }\n    \n    updateAudio() {\n        this.audioUpdater.update();\n    }\n    \n    checkGameOver() {\n        this.lifecycle.checkGameOver();\n    }\n    \n    gameOver(reason: string) {\n        this.lifecycle.gameOver(reason);\n    }\n    \n    cleanup() {\n        this.lifecycle.cleanup();\n    }\n    \n    destroy() {\n        this.lifecycle.destroy();\n    }\n    \n    // Main update loop\n    update(deltaTime: number) {\n        if (this.isGameOver) return;\n        \n        // Update horde mode\n        this.hordeMode.update();\n        \n        // Update physics\n        this.physics.update(deltaTime);\n\n        // Update bitECS systems (parallel to legacy systems)\n        if (this._updateECS) {\n            this._updateECS(deltaTime);\n        }\n\n        // Update spaceship\n        if (this.spaceship.update) {\n            this.spaceship.update(deltaTime);\n        }\n        \n        // Update difficulty manager (but not during intro sequence)\n        if (this.difficultyManager && !this.introSequenceActive && !this.spaceship.isDocked) {\n            this.difficultyManager.update(deltaTime);\n        }\n        \n        // Update coordinates in HUD after physics update\n        if (this.ui && this.ui.updateCoordinates && this.spaceship && this.spaceship.mesh) {\n            const position = this.spaceship.mesh.position;\n            this.ui.updateCoordinates(position.x, position.y, position.z);\n        }\n        \n        // Update controls\n        if (this.controls.update) {\n            this.controls.update();\n        }\n        \n        // Update combat\n        this.updateCombat(deltaTime);\n        \n        // Update environment\n        if (this.environment.update) {\n            this.environment.update(deltaTime, this.camera);\n        }\n        \n        // Update UI\n        if (this.ui.update) {\n            this.ui.update(deltaTime);\n        }\n        \n        // Update audio\n        this.updateAudio();\n        \n        // Check for game over conditions\n        this.checkGameOver();\n        \n        // Update ECS world\n        this.updateECSWorld(deltaTime);\n    }\n    \n    // Explicitly typed helper for combat\n    get environment(): any { return this._environment; }\n    set environment(v: any) { this._environment = v; }\n    get controls(): any { return this._controls; }\n    set controls(v: any) { this._controls = v; }\n\n    updateCombat(deltaTime: number) {\n        // Ensure the combat system's player entity is always up to date\n        if (this.combat && this.combat.updatePlayerReference) {\n            try {\n                this.combat.updatePlayerReference();\n            } catch (error) {\n            }\n        } else if (this.combat && !this.combat.updatePlayerReference) {\n            \n            // Try to initialize player entity directly if method is missing\n            if (this.combat.createPlayerReferenceEntity && !this.combat.playerEntity) {\n                this.combat.createPlayerReferenceEntity();\n            }\n        }\n        \n        // Update combat systems - this will update the ECS world\n        if (this.combat && this.combat.update) {\n            this.combat.update(deltaTime);\n        }\n    }\n    \n    updateECSWorld(deltaTime: number) {\n        // Update the ECS world with the current delta time - skip during intro sequence\n        if (this.world && !this.introSequenceActive) {\n            // Fixed-step for ECS using same delta to keep in lockstep\n            this.world.messageBus && this.world.messageBus.fastPublish && this.world.messageBus.fastPublish('world.preUpdate', { deltaTime });\n            this.world.systemManager.update(deltaTime);\n            this.world.messageBus && this.world.messageBus.fastPublish && this.world.messageBus.fastPublish('world.postUpdate', { deltaTime });\n        } else if (this.world && this.introSequenceActive) {\n            // If intro is active, only update essential systems but not enemy systems\n            // This is a fallback in case freezeAllEnemies() wasn't called or doesn't work\n            if (this.world.entityManager && this.world.systemManager) {\n                for (const system of this.world.systemManager.systems) {\n                    // Skip enemy-related systems during intro\n                    if (system.constructor.name !== 'EnemySystem' && \n                        system.constructor.name !== 'EnemyAISystem' && \n                        system.constructor.name !== 'CombatSystem') {\n                        system.update(deltaTime);\n                    }\n                }\n            }\n        }\n    }\n    \n    // Event handlers\n    handleResize = () => {\n        if (this.renderer) {\n            this.renderer.handleResize();\n        }\n    }\n    \n    handleVisibilityChange = () => {\n        if (document.hidden) {\n            // Pause game when tab is not visible\n            if (this.audio) {\n                this.audio.pauseAllSounds();\n            }\n        } else {\n            // Resume game when tab becomes visible\n            if (this.audio) {\n                this.audio.resumeAllSounds();\n            }\n        }\n    }\n    \n    handleKeyDown = (event: KeyboardEvent) => {\n        // Global key handlers\n        if (event.key === 'Escape') {\n            if (this.ui && this.ui.togglePauseMenu) {\n                this.ui.togglePauseMenu();\n            }\n        }\n    }\n}\n\n// Entry point - called from bootstrap.js or directly\nasync function startGameMainModule() {\n    try {\n        // Create loading overlay - hide the black loading screen after initialization\n        const loadingOverlay = document.getElementById('loading-overlay');\n        if (loadingOverlay) {\n            // Add a small delay to ensure everything is properly loaded\n            setTimeout(() => {\n                loadingOverlay.style.opacity = '0';\n                loadingOverlay.style.transition = 'opacity 1s ease-in-out';\n                setTimeout(() => {\n                    if (loadingOverlay.parentNode) {\n                        loadingOverlay.remove();\n                    }\n                }, 1000);\n            }, 100);\n        }\n\n\n        // Create game instance (globals initialized in constructor)\n        window.game = new Game();\n        await window.game.initialize();\n\n    } catch (error: any) {\n        \n        // Show error message to user\n        const errorMessage = document.createElement('div');\n        errorMessage.style.position = 'fixed';\n        errorMessage.style.top = '50%';\n        errorMessage.style.left = '50%';\n        errorMessage.style.transform = 'translate(-50%, -50%)';\n        errorMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\n        errorMessage.style.color = '#ff3030';\n        errorMessage.style.padding = '20px';\n        errorMessage.style.borderRadius = '10px';\n        errorMessage.style.border = '1px solid #ff3030';\n        errorMessage.style.zIndex = '9999';\n        errorMessage.style.textAlign = 'center';\n        errorMessage.style.fontFamily = 'Courier New, monospace';\n        errorMessage.style.maxWidth = '80%';\n        \n        errorMessage.innerHTML = `\n            <h2>Error Starting Game</h2>\n            <p>${error.message}</p>\n            <p>Check the console for more details (F12).</p>\n            <p>You can try refreshing the page or clearing your browser cache.</p>\n            <button id=\"reload-button\" style=\"background: #ff3030; color: white; border: none; padding: 10px; margin-top: 20px; cursor: pointer;\">Reload Page</button>\n        `;\n        \n        document.body.appendChild(errorMessage);\n        \n        // Add event listener to reload button\n        const reloadButton = document.getElementById('reload-button');\n        if (reloadButton) {\n          reloadButton.addEventListener('click', () => {\n              // Add cache-busting parameter to the URL\n              const cacheBuster = Date.now();\n              window.location.href = window.location.pathname + '?cache=' + cacheBuster;\n          });\n        }\n    }\n}\n\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', startGameMainModule);\n} else {\n    // DOM is already ready\n    startGameMainModule();\n}\n"],"file":"assets/main-Cb_tr4G2.js"}