{"version":3,"file":"systemTransition-C90waWqc.js","sources":["../../js/modules/environment/systemTransition.ts"],"sourcesContent":["// systemTransition.ts - Handles the visual transition between star systems\n\nimport * as THREE from 'three';\n\nexport class SystemTransition {\n    scene: THREE.Scene;\n    camera: THREE.Camera;\n    isTransitioning: boolean;\n    transitionDuration: number;\n    onTransitionComplete: (() => void) | null;\n    warpTunnel!: THREE.Points<THREE.BufferGeometry, THREE.PointsMaterial>;\n    originalPositions!: Float32Array;\n    overlay!: HTMLDivElement;\n    initialCameraPosition?: THREE.Vector3;\n    initialCameraRotation?: THREE.Euler;\n    startTime: number;\n\n    constructor(scene: THREE.Scene, camera: THREE.Camera) {\n        this.scene = scene;\n        this.camera = camera;\n        this.isTransitioning = false;\n        this.transitionDuration = 3000; // milliseconds\n        this.onTransitionComplete = null;\n        this.startTime = 0;\n\n        // Create transition elements\n        this.setupTransitionElements();\n    }\n\n    setupTransitionElements(): void {\n        // Warp tunnel effect\n        this.warpTunnel = new THREE.Points(\n            new THREE.BufferGeometry(),\n            new THREE.PointsMaterial({\n                color: 0x30cfd0,\n                size: 2,\n                blending: THREE.AdditiveBlending,\n                transparent: true,\n                sizeAttenuation: true\n            })\n        );\n\n        // Create particles for warp effect\n        this.createWarpParticles();\n\n        // Flash overlay for transition effect\n        this.createOverlay();\n    }\n\n    createWarpParticles(): void {\n        // Number of particles\n        const particleCount = 2000;\n\n        // Create position array\n        const positions = new Float32Array(particleCount * 3);\n\n        // Initialize particle positions in a tunnel shape\n        for (let i = 0; i < particleCount; i++) {\n            const i3 = i * 3;\n\n            // Polar coordinates for tunnel shape\n            const radius = 50 + Math.random() * 50;\n            const theta = Math.random() * Math.PI * 2;\n            const length = -500 - Math.random() * 3000; // Negative z is forward\n\n            // Convert to Cartesian\n            positions[i3] = radius * Math.cos(theta);     // x\n            positions[i3 + 1] = radius * Math.sin(theta); // y\n            positions[i3 + 2] = length;                   // z\n        }\n\n        // Add to buffer geometry\n        this.warpTunnel.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));\n\n        // Store original positions for resetting\n        this.originalPositions = new Float32Array(positions);\n    }\n\n    createOverlay(): void {\n        // Create a DOM overlay for the flash effect\n        this.overlay = document.createElement('div');\n        this.overlay.id = 'warp-overlay';\n        this.overlay.style.position = 'fixed';\n        this.overlay.style.top = '0';\n        this.overlay.style.left = '0';\n        this.overlay.style.width = '100%';\n        this.overlay.style.height = '100%';\n        this.overlay.style.backgroundColor = '#30cfd0';\n        this.overlay.style.opacity = '0';\n        this.overlay.style.transition = 'opacity 0.5s';\n        this.overlay.style.pointerEvents = 'none';\n        this.overlay.style.zIndex = '9999';\n\n        // Add to DOM but hide initially\n        document.body.appendChild(this.overlay);\n    }\n\n    // Start a transition between systems\n    startTransition(onComplete?: () => void): void {\n        if (this.isTransitioning) return;\n\n        console.log(\"Starting system transition...\");\n        this.isTransitioning = true;\n\n        // Store callback\n        this.onTransitionComplete = onComplete || null;\n\n        // Add warp tunnel to scene\n        this.scene.add(this.warpTunnel);\n\n        // Position the camera for the transition\n        this.initialCameraPosition = this.camera.position.clone();\n        this.initialCameraRotation = this.camera.rotation.clone();\n\n        // Start transition animation\n        this.startTime = Date.now();\n\n        // Show overlay\n        this.showOverlay();\n\n        // Start animation\n        this.animate();\n    }\n\n    // Animation loop for transition\n    animate(): void {\n        if (!this.isTransitioning) return;\n\n        const currentTime = Date.now();\n        const elapsed = currentTime - this.startTime;\n        const progress = Math.min(elapsed / this.transitionDuration, 1.0);\n\n        // Update warp effect\n        this.updateWarpEffect(progress);\n\n        // Check if transition is complete\n        if (progress >= 1.0) {\n            this.completeTransition();\n            return;\n        }\n\n        // Continue animation\n        requestAnimationFrame(this.animate.bind(this));\n    }\n\n    // Update warp tunnel effect\n    updateWarpEffect(progress: number): void {\n        // Get positions\n        const positions = (this.warpTunnel.geometry.attributes.position.array as Float32Array);\n\n        // Adjust warp speed based on progress\n        const warpSpeed = 3 + progress * 20;\n\n        // Update particle positions\n        for (let i = 0; i < positions.length; i += 3) {\n            // Move particles toward camera\n            positions[i + 2] += warpSpeed; // z value\n\n            // Reset particles that go past the camera\n            if (positions[i + 2] > 100) {\n                // Reset to original position with an offset to create continuous tunnel\n                positions[i] = this.originalPositions[i];\n                positions[i + 1] = this.originalPositions[i + 1];\n                positions[i + 2] = this.originalPositions[i + 2] - 500; // Return to end of tunnel\n            }\n        }\n\n        // Update buffer geometry\n        this.warpTunnel.geometry.attributes.position.needsUpdate = true;\n\n        // Update camera animation - slight movement to enhance effect\n        if (this.camera) {\n            this.camera.rotation.z += 0.0005 * Math.sin(progress * Math.PI);\n        }\n    }\n\n    // Show overlay with flash effect\n    showOverlay(): void {\n        if (!this.overlay) return;\n\n        // Start with low opacity\n        this.overlay.style.opacity = '0.2';\n\n        // Schedule flash toward end of transition\n        setTimeout(() => {\n            this.overlay.style.opacity = '1';\n\n            // Fade out after flash\n            setTimeout(() => {\n                this.overlay.style.opacity = '0';\n            }, 500);\n        }, this.transitionDuration - 1000);\n    }\n\n    // Complete the transition\n    completeTransition(): void {\n        console.log(\"System transition complete\");\n        this.isTransitioning = false;\n\n        // Remove warp tunnel from scene\n        this.scene.remove(this.warpTunnel);\n\n        // Reset camera position and rotation\n        if (this.camera && this.initialCameraPosition && this.initialCameraRotation) {\n            this.camera.position.copy(this.initialCameraPosition);\n            this.camera.rotation.copy(this.initialCameraRotation);\n        }\n\n        // Call completion callback if provided\n        if (this.onTransitionComplete && typeof this.onTransitionComplete === 'function') {\n            // Use setTimeout to make sure this executes after the animation frame\n            setTimeout(() => {\n                console.log(\"Executing transition completion callback\");\n                this.onTransitionComplete && this.onTransitionComplete();\n            }, 100);\n        }\n    }\n}\n"],"names":["SystemTransition","scene","camera","__publicField","THREE.Points","THREE.BufferGeometry","THREE.PointsMaterial","THREE.AdditiveBlending","positions","i","i3","radius","theta","length","THREE.BufferAttribute","onComplete","elapsed","progress","warpSpeed"],"mappings":"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"}