{"version":3,"mappings":"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","names":["isResettable","obj","PoolRegistry","__publicField","type","factory","reset","preallocate","maxSize","existing","pool","i","args","getGlobalPoolRegistry","win","DEBUG_MODE","setDebugMode","enabled","toggleDebugMode","EVENT","SCHEMA","validateEventPayload","data","shape","warn","key","t","v","msg","MessageBus","messageType","callback","context","listeners","index","listener","messageObj","queuedMessages","message","reason","source","messageBusToUse","globalWithMessageBus","mainMessageBus","globalWithObjectPool","objectPool","initialSize","initializeGlobals","THREE","initializeVectorPool","vectorPool","x","y","z","vector","THREE.Vector3","StartupSequence","game","resolve","error","Combat","__vitePreload","IntroSequence","enemySystem","introSequence","GameLoop","timestamp","targetFrameTime","now","rawDelta","instantFPS","totalWeight","weightedSum","weight","cap","frameRateSetting","rate","frames","startTime","samples","measure","delta","avgFrameTime","a","b","detectedRate","commonRates","closestRate","minDiff","diff","PerfOverlay","obs","list","entry","perf","el","p","sysHtml","k","_a","_b","initPerfOverlay","Diagnostics","limit","statsElement","_c","poolName","allStats","pools","stats","entities","systems","LIGHTING_CONFIG","LightingManager","scene","renderer","camera","THREE.PCFSoftShadowMap","THREE.ACESFilmicToneMapping","THREE.SRGBColorSpace","THREE.DirectionalLight","d","THREE.HemisphereLight","sunWorldPosition","factor","clampedFactor","THREE.MathUtils","_cameraPosition","_useClaudeRays","quality","size","light","createVolumetricLightShader","godRayShader","THREE.Vector2","THREE.Color","shaderPass","ShaderPass","createClaudeRayShader","claudeRayShader","PostProcessingManager","EffectComposer","renderPass","RenderPass","UnrealBloomPass","fxaaPass","FXAAShader","pixelRatio","ColorCorrectionShader","FilmShader","VignetteShader","strength","radius","threshold","deltaTime","pass","SceneApiManager","originalAdd","originalRemove","object","_entityId","_viewDef","_props","fn","prev","sun","alpha","world","entity","m","q","THREE.Quaternion","RenderHelpers","geometry","material","maxCount","instancedMesh","THREE.InstancedMesh","THREE.Object3D","position","quaternion","scale","instance","idx","matrix","THREE.Matrix4","inst","startCalls","endCalls","propertyName","property","VolumetricLightingManager","postProcessingManager","sceneApiManager","sunWorldPos","screenVector","camToSunDistance","normalizedDistance","camDirection","sunDirection","dotProduct","useClaudeRays","params","uniforms","intensity","exposure","density","Renderer","THREE.Scene","THREE.PerspectiveCamera","WebGPURenderer","WebGL","warning","THREE.WebGLRenderer","entityId","viewDef","props","TrailEffects","_scene","mesh","createExhaustBeam","direction","config","baseRadius","length","color","glowColor","group","THREE.Group","segments","beams","topRadius","bottomRadius","segmentLength","THREE.CylinderGeometry","THREE.MeshBasicMaterial","THREE.AdditiveBlending","THREE.DoubleSide","beam","THREE.Mesh","thrust","velocity","intent","leftPressed","rightPressed","effect","shouldShow","flicker","isMoving","mainEffect","e","child","mat","ShipModel","shipScale","bodyGroup","cylinderGeometry","bodyMaterial","THREE.MeshPhongMaterial","bodyCylinder","noseGeometry","THREE.ConeGeometry","noseCone","cockpitGeometry","THREE.SphereGeometry","cockpitMaterial","cockpit","cannonGeometry","cannonMaterial","emitterGeometry","emitterMaterial","createCurvedWing","isLeft","wingGroup","wingMaterial","wingBaseGeom","THREE.BoxGeometry","wingBase","wingCurveGeom","wingCurve","wingTipGeom","goldMaterial","wingTip","leftWing","rightWing","addGoldAccent","width","height","depth","rotX","rotY","rotZ","accentGeom","accent","thrusterGeometry","thrusterMaterial","mainThruster","reverseThruster","leftThruster","rightThruster","ShipUpgrades","shipComponents","spaceshipState","thruster","colors","part","upgrades","ShipDocking","_syncCallback","syncCallback","shieldBeforeUndock","stargate","stargatePosition","location","ShipServices","oldShield","players","health","oldHealthShield","oldHull","oldHealthHull","thrustState","consumptionRate","ShipVisualEffects","leftMaterial","rightMaterial","trailEffects","HealthSync","messageBus","destructionCallback","healthComponent","hull","shield","valuesForSync","oldHealth","Spaceship","THREE.Euler","components","_deltaTime","ps","newPosition","_Physics","THREE.Raycaster","_duration","spaceship","hasFuel","thrustVector","isThrusting","shipForward","forwardPressed","backwardPressed","boostPressed","forwardThrust","maxVelocity","friction","positionDelta","maxY","euler","targetQuaternion","velocityMagnitude","velocityNormalized","velocityScale","rotatedOffset","targetPosition","lookAheadOffset","baseLookAt","lookAtPoint","THREE.OrthographicCamera","offsetX","offsetY","offsetZ","offsetX2","offsetY2","shakeOffset","cameraRight","cameraUp","cameraForward","worldShakeOffset","recoilOffset","deltaX","deltaY","shipMesh","shipRadius","shipPosition","asteroidMeshes","asteroidBelt","asteroids","distFromCenter","asteroid","distance","asteroidRadius","planetRadius","bounceDirection","explosionColor","explosionSize","explosionMessage","collisionType","explosionGeometry","explosionMaterial","explosion","module","err","resistance","recoveryChance","recoveryRoll","survived","shieldGeometry","shieldMaterial","expandSpeed","fadeSpeed","animateShield","animate","Physics","InputHandler","physics","windowWithGame","clearBit","bit","canvas","instructionsElement","movementX","movementY","GamepadHandler","controls","gamepads","gamepad","name","button","leftX","leftY","rightStickX","rightStickY","baseSpeed","smoothing","target","_d","_f","_e","_h","_g","rtValue","ltValue","axis4","axis5","value","buttonIndex","duration","hapticsGamepad","notification","input","exponent","sign","magnitude","html","isRightX","isRightY","rightX","rightY","rt","lt","temp","createLaserMaterial","baseColor","pulseSpeed","pulseIntensity","pulse","sin","time","LaserControl","gameWindow","resourceType","targetAsteroid","sourcePosition","shipOffset","midpoint","efficiency","threeScene","oldLaserBeam","newColor","TargetValidation","miningDistance","ResourceExtraction","bonusChance","amount","UIUpdates","targetingSystem","inRange","targetDistance","rangeStatus","rangeColor","targetInfo","targetName","miningSpeed","miningStatusElement","secondsRequired","efficiencyText","miningProgressContainer","progressBar","progress","isTargetingEnabled","VisualEffects","particles","THREE.BufferGeometry","particleMaterial","THREE.PointsMaterial","positions","THREE.BufferAttribute","THREE.Points","particleSpeed","dir","velocities","particleSystem","frameCount","animateParticles","MiningSystem","canMine","destroyedAsteroid","TargetingSystem","environment","ringGeometry","THREE.RingGeometry","ringMaterial","innerRingGeometry","innerRingMaterial","innerRing","targetInfoElement","raycaster","nearby","intersects","item","targetNameElement","_direction","lookAtPos","closestAsteroid","closestDistance","opacity","targetDistanceElement","targetDirection","angle","margin","halfWidth","halfHeight","normalizedDir","edgeX","edgeY","slopeRatio","screenRatio","screenPosition","worldPosition","tempVector","ProximityDetector","ui","DockingLogic","stargateUI","stepFunction","stepName","container","element","closeAllModalsCallback","hideStargateUICallback","showGameUICallback","loadingIndicator","healthData","UIIntegration","proximityDetector","dockingLogic","refuelBtn","repairShieldBtn","repairHullBtn","undockBtn","sellIronBtn","sellGoldBtn","sellPlatinumBtn","buttonId","costGetter","upgradeFunction","cost","miningSystem","customSystemCreator","closeBtn","starMap","closeStarMapBtn","modal","modalElement","resources","DockingSystem","handleUndock","JoystickZones","leftJoystickZone","rightJoystickZone","ActionButtons","leftActionButtonsContainer","rightActionButtonsContainer","parent","text","style","startHandler","endHandler","JoystickHandler","reject","script","leftZone","rightZone","windowWithNipple","evt","force","xMove","yMove","GestureDetector","event","touch","touchDuration","uiSelectors","selector","pos1","pos2","dx","dy","startPos","endPos","gestureType","MiningHandler","closestDist","dist","WeaponHandler","weaponSystem","SystemActions","dockingSystem","TouchControls$1","systemStatus","crosshair","zones","buttons","TouchControls","RefactoredTouchControls","result","_MobileDetector","userAgentCheck","touchCheck","screenCheck","viewportCheck","viewport","mobileFeatureCheck","motionCheck","isTablet","isIpad","isAndroidTablet","handler","prevOrientation","checkOrientation","currentOrientation","MobileDetector","Controls","originalSpeed","anomaly","orbData","rarityColor","capitalizedRarity","sensitivity","wasDocked","isDocked","GameInitializer","AudioManager","sceneWithCamera","Environment","UI","DifficultyManager","minutes","newLevel","difficultyMultiplier","HordeMode","totalSeconds","seconds","AudioUpdater","thrustIntensity","GameLifecycle","survivalTime","ObjectPools","THREE.MeshStandardMaterial","dummyProjectile","particleGeometry","particleCount","particle","anyAlive"],"ignoreList":[],"sources":["../../js/modules/pooling/PoolRegistry.ts","../../js/globals/debug.ts","../../js/core/events.ts","../../js/core/messageBus.ts","../../js/globals/messageBus.ts","../../js/globals/objectPool.ts","../../js/main/globals.ts","../../js/main/startupSequence.ts","../../js/main/gameLoop.ts","../../js/modules/debug/perfOverlay.ts","../../js/main/diagnostics.ts","../../js/config/lightingConfig.ts","../../js/modules/renderer/lighting.ts","../../js/modules/renderer/shaders.ts","../../js/modules/renderer/post.ts","../../js/modules/renderer/sceneApi.ts","../../js/modules/renderer/helpers.ts","../../js/modules/renderer/volumetricLighting.ts","../../js/modules/renderer.ts","../../js/modules/trail.ts","../../js/modules/spaceship/model/shipModel.ts","../../js/modules/spaceship/systems/upgrades.ts","../../js/modules/spaceship/systems/docking.ts","../../js/modules/spaceship/systems/services.ts","../../js/modules/spaceship/effects/visualEffects.ts","../../js/modules/spaceship/sync/healthSync.ts","../../js/modules/spaceship/spaceship.ts","../../js/modules/physics.ts","../../js/modules/controls/inputHandler.ts","../../js/modules/controls/gamepadHandler.ts","../../js/modules/render/laserMaterial.ts","../../js/modules/controls/mining/laserControl.ts","../../js/modules/controls/mining/targetValidation.ts","../../js/modules/controls/mining/resourceExtraction.ts","../../js/modules/controls/mining/uiUpdates.ts","../../js/modules/controls/mining/visualEffects.ts","../../js/modules/controls/miningSystem.ts","../../js/modules/controls/targetingSystem.ts","../../js/modules/controls/docking/proximityDetector.ts","../../js/modules/controls/docking/dockingLogic.ts","../../js/modules/controls/docking/uiIntegration.ts","../../js/modules/controls/dockingSystem.ts","../../js/modules/controls/touch/ui/joystickZones.ts","../../js/modules/controls/touch/ui/actionButtons.ts","../../js/modules/controls/touch/input/joystickHandler.ts","../../js/modules/controls/touch/input/gestureDetector.ts","../../js/modules/controls/touch/actions/miningHandler.ts","../../js/modules/controls/touch/actions/weaponHandler.ts","../../js/modules/controls/touch/actions/systemActions.ts","../../js/modules/controls/touch/touchControls.ts","../../js/modules/controls/touchControls.ts","../../js/utils/mobileDetector.ts","../../js/modules/controls.ts","../../js/main/gameInitializer.ts","../../js/main/difficultyManager.ts","../../js/main/hordeMode.ts","../../js/main/audioUpdater.ts","../../js/main/gameLifecycle.ts","../../js/main/objectPools.ts"],"sourcesContent":["// PoolRegistry.ts - unified pool manager with stats and preallocation\n\ntype PoolConfig<T> = {\n    factory: () => T;\n    reset?: (obj: T, ...args: unknown[]) => void;\n    preallocate?: number;\n    maxSize?: number;\n};\n\ntype PoolEntry<T> = {\n    objects: T[];\n    factory: () => T;\n    reset?: (obj: T, ...args: unknown[]) => void;\n    maxSize: number;\n};\n\ntype Resettable = {\n    reset?: (...args: unknown[]) => void;\n    clear?: () => void;\n};\n\nfunction isResettable(obj: unknown): obj is Resettable {\n    return typeof obj === 'object' && obj !== null;\n}\n\ntype PerfPools = {\n    hits: number;\n    misses: number;\n};\n\ntype PerfState = {\n    pools?: PerfPools;\n};\n\nexport class PoolRegistry {\n    typeToPool: Map<string, PoolEntry<unknown>>;\n    statsData: { hits: number; misses: number };\n\n    constructor() {\n        this.typeToPool = new Map();\n        this.statsData = { hits: 0, misses: 0 };\n    }\n\n    register<T>(type: string, { factory, reset, preallocate = 0, maxSize = Infinity }: PoolConfig<T>): PoolEntry<T> {\n        if (!type) throw new Error('PoolRegistry.register requires a type');\n        const existing = this.typeToPool.get(type) as PoolEntry<T> | undefined;\n        if (existing) return existing;\n        const pool: PoolEntry<T> = {\n            objects: [],\n            factory: factory || (() => ({} as T)),\n            reset: reset || function noop() {},\n            maxSize\n        };\n        for (let i = 0; i < preallocate; i++) {\n            try {\n                pool.objects.push(pool.factory());\n            } catch {\n                // Ignore failed allocations\n            }\n        }\n        this.statsData.misses += preallocate;\n        this.typeToPool.set(type, pool as PoolEntry<unknown>);\n        return pool;\n    }\n\n    get<T>(type: string, ...args: unknown[]): T {\n        const pool = this.typeToPool.get(type) as PoolEntry<T> | undefined;\n        if (!pool) throw new Error(`PoolRegistry.get: unknown type '${type}'`);\n        let obj: T;\n        if (pool.objects.length > 0) {\n            obj = pool.objects.pop() as T;\n            this.statsData.hits += 1;\n        } else {\n            obj = pool.factory();\n            this.statsData.misses += 1;\n        }\n        if (isResettable(obj) && typeof obj.reset === 'function') {\n            obj.reset(...args);\n        } else if (pool.reset) {\n            try {\n                pool.reset(obj, ...args);\n            } catch {\n                // Ignore reset errors\n            }\n        }\n        this._flushPerf();\n        return obj;\n    }\n\n    release<T>(type: string, obj: T): void {\n        const pool = this.typeToPool.get(type) as PoolEntry<T> | undefined;\n        if (!pool) return;\n        if (isResettable(obj) && typeof obj.clear === 'function') {\n            try {\n                obj.clear();\n            } catch {\n                // Ignore clear errors\n            }\n        } else if (pool.reset) {\n            try {\n                pool.reset(obj);\n            } catch {\n                // Ignore reset errors\n            }\n        }\n        if (pool.objects.length < pool.maxSize) {\n            pool.objects.push(obj);\n        }\n    }\n\n    clear(type: string): void {\n        const pool = this.typeToPool.get(type);\n        if (!pool) return;\n        pool.objects.length = 0;\n    }\n\n    clearAll(): void {\n        for (const [type] of this.typeToPool) this.clear(type);\n    }\n\n    stats(): { hits: number; misses: number } {\n        return { hits: this.statsData.hits, misses: this.statsData.misses };\n    }\n\n    private _flushPerf(): void {\n        if (window.__perf) {\n            (window.__perf as PerfState).pools = { ...this.statsData };\n        }\n    }\n}\n\n// Create a global-friendly singleton when desired\nexport function getGlobalPoolRegistry(): PoolRegistry {\n    const win = window as Window & { poolRegistry?: PoolRegistry };\n    if (!win.poolRegistry) {\n        win.poolRegistry = new PoolRegistry();\n    }\n    return win.poolRegistry;\n}\n","export type DebugState = {\n    enabled: boolean;\n};\n\nexport const DEBUG_MODE: DebugState = {\n    enabled: false\n};\n\nexport function setDebugMode(enabled: boolean): void {\n    DEBUG_MODE.enabled = enabled;\n    (globalThis as { DEBUG_MODE?: boolean }).DEBUG_MODE = enabled;\n}\n\nexport function toggleDebugMode(): boolean {\n    setDebugMode(!DEBUG_MODE.enabled);\n    return DEBUG_MODE.enabled;\n}\n\nexport function isDebugMode(): boolean {\n    return DEBUG_MODE.enabled;\n}\n","// events.ts - typed events enum + optional dev validation\n\nimport { DEBUG_MODE } from '../globals/debug.ts';\n\nexport const EVENT = Object.freeze({\n    GAME_OVER: 'game.over',\n    PLAYER_CREATED: 'player.created',\n    TRANSFORM_UPDATED: 'transform.updated',\n    VFX_EXPLOSION: 'vfx.explosion',\n    MINING_START: 'player.mining.start',\n    MINING_STOP: 'player.mining.stop',\n    ENEMY_DESTROYED: 'enemy.destroyed',\n    WEAPON_FIRED: 'weapon.fired',\n    INPUT_VIBRATE: 'input.vibrate',\n});\n\nconst SCHEMA: Record<string, Record<string, string>> = {\n    [EVENT.GAME_OVER]: { reason: 'string' },\n    [EVENT.PLAYER_CREATED]: { entity: 'object' },\n    [EVENT.TRANSFORM_UPDATED]: { entity: 'object' },\n    [EVENT.VFX_EXPLOSION]: { position: 'object', color: 'number', size: 'number', duration: 'number' },\n    [EVENT.MINING_START]: { sourceEntity: 'object', targetEntity: 'object' },\n    [EVENT.MINING_STOP]: { sourceEntity: 'object' },\n    [EVENT.ENEMY_DESTROYED]: { entityId: 'string' },\n    [EVENT.WEAPON_FIRED]: { entity: 'object' },\n    [EVENT.INPUT_VIBRATE]: { intensity: 'number', duration: 'number' },\n};\n\nexport function validateEventPayload(type: string, data: any): boolean {\n    if (!DEBUG_MODE || !DEBUG_MODE.enabled) return true;\n    const shape = SCHEMA[type];\n    if (!shape) return true;\n    if (typeof data !== 'object' || data == null) return warn(type, 'payload is not object');\n    for (const [key, t] of Object.entries(shape)) {\n        const v = data[key];\n        if (t === 'object') {\n            if (typeof v !== 'object' || v == null) return warn(type, `field ${key} must be object`);\n        } else if (typeof v !== t) {\n            return warn(type, `field ${key} must be ${t}`);\n        }\n    }\n    return true;\n}\n\nfunction warn(type: string, msg: string): boolean {\n    console.warn(`[EVENT VALIDATION] ${type}: ${msg}`);\n    return false;\n}\n","/**\n * MessageBus - Event system for decoupled communication between systems\n * \n * The MessageBus enables systems to communicate without direct references\n * by publishing and subscribing to specific message types.\n */\n\nimport { validateEventPayload } from './events.js';\n\nexport interface Message {\n    type: string;\n    data: any;\n    timestamp: number;\n}\n\nexport type MessageCallback = (message: Message) => void;\n\ninterface Listener {\n    callback: MessageCallback;\n    context: any;\n}\n\nexport class MessageBus {\n    public listeners: Map<string, Listener[]>;\n    private queuedMessages: { type: string, data: any }[];\n    private dispatching: boolean;\n    private highFrequencyTypes: Set<string>;\n\n    constructor() {\n        this.listeners = new Map();\n        this.queuedMessages = [];\n        this.dispatching = false;\n        \n        // High-frequency message types to minimize logging\n        this.highFrequencyTypes = new Set([\n            'transform.updated',\n            'physics.update',\n            'render.update'\n        ]);\n        \n        // Store this instance in a global registry for emergency access\n        if (!(window as any).messageRegistry) {\n            (window as any).messageRegistry = new Set();\n        }\n        (window as any).messageRegistry.add(this);\n        \n        // Always ensure that mainMessageBus is set - critically important for game over events\n        if (!(globalThis as any).mainMessageBus) {\n            (globalThis as any).mainMessageBus = this;\n        } else if ((globalThis as any).mainMessageBus !== this) {\n            // If this is not the main message bus, make sure game.over events are \n            // forwarded to the main message bus for centralized handling\n        }\n    }\n    \n    /**\n     * Register a listener for a message type\n     * @param {string} messageType The message type to listen for\n     * @param {MessageCallback} callback Function to call when message is published\n     * @param {any} context Context to use when calling the callback\n     * @returns {Function} Unsubscribe function\n     */\n    subscribe(messageType: string, callback: MessageCallback, context: any = null): () => void {\n        if (!this.listeners.has(messageType)) {\n            this.listeners.set(messageType, []);\n        }\n        \n        this.listeners.get(messageType)!.push({\n            callback,\n            context\n        });\n        \n        // Return unsubscribe function for convenience\n        return () => this.unsubscribe(messageType, callback, context);\n    }\n    \n    /**\n     * Remove a listener\n     * @param {string} messageType The message type to unsubscribe from\n     * @param {MessageCallback} callback The callback to remove\n     * @param {any} context The context used when subscribing\n     */\n    unsubscribe(messageType: string, callback: MessageCallback, context: any = null): void {\n        if (!this.listeners.has(messageType)) return;\n        \n        const listeners = this.listeners.get(messageType)!;\n        const index = listeners.findIndex(listener => \n            listener.callback === callback && listener.context === context);\n            \n        if (index !== -1) {\n            listeners.splice(index, 1);\n        }\n        \n        if (listeners.length === 0) {\n            this.listeners.delete(messageType);\n        }\n    }\n    \n    /**\n     * Fast publish for high-frequency events with minimal overhead\n     * @param {string} messageType The message type to publish\n     * @param {any} data Data to include with the message\n     */\n    fastPublish(messageType: string, data: any = {}): void {\n        // Typed event validation in dev\n        try { validateEventPayload && validateEventPayload(messageType, data); } catch {}\n        if (!this.listeners.has(messageType)) return;\n        \n        const listeners = this.listeners.get(messageType)!;\n        const messageObj: Message = {\n            type: messageType,\n            data: data,\n            timestamp: Date.now()\n        };\n        \n        for (let i = 0; i < listeners.length; i++) {\n            const listener = listeners[i];\n            listener.callback.call(listener.context, messageObj);\n        }\n    }\n    \n    /**\n     * Send a message immediately\n     * @param {string} messageType The message type to publish\n     * @param {any} data Data to include with the message\n     */\n    publish(messageType: string, data: any = {}): void {\n        // Typed event validation in dev\n        try { validateEventPayload && validateEventPayload(messageType, data); } catch {}\n        // Use fast path for high-frequency messages\n        if (this.highFrequencyTypes.has(messageType)) {\n            return this.fastPublish(messageType, data);\n        }\n        \n        // Enhanced handling for game.over events to ensure they are properly processed\n        if (messageType === 'game.over') {\n            // Always forward game.over events to the main message bus if this isn't it\n            if ((globalThis as any).mainMessageBus && (globalThis as any).mainMessageBus !== this) {\n                (globalThis as any).mainMessageBus.publish(messageType, data);\n                return; // Let the main message bus handle it\n            }\n            \n            // Only proceed if we have listeners or we are the main message bus\n            if (!this.listeners.has(messageType)) {\n                // Verify main game instance\n                if ((window as any).game) {\n                    // Try to directly call gameOver as a last resort\n                    (window as any).game.gameOver(data.reason || \"Unknown reason\");\n                } \n                \n                return;\n            }\n        }\n        \n        if (!this.listeners.has(messageType)) return;\n        \n        // If we're already dispatching, queue this message\n        if (this.dispatching) {\n            this.queuedMessages.push({ type: messageType, data });\n            return;\n        }\n        \n        try {\n            // Set flag to prevent nested dispatch issues\n            this.dispatching = true;\n            \n            const listeners = this.listeners.get(messageType)!;\n            listeners.forEach((listener) => {\n                try {\n                    listener.callback.call(listener.context, {\n                        type: messageType,\n                        data: data,\n                        timestamp: Date.now()\n                    });\n                } catch (error) {\n                    // Silently catch listener errors to prevent one listener from crashing the bus\n                }\n            });\n        } finally {\n            // Always clear the dispatching flag, even if an error occurs\n            this.dispatching = false;\n            \n            // Process any queued messages\n            if (this.queuedMessages.length > 0) {\n                const queuedMessages = [...this.queuedMessages];\n                this.queuedMessages = [];\n                \n                queuedMessages.forEach(message => {\n                    this.publish(message.type, message.data);\n                });\n            }\n        }\n    }\n    \n    /**\n     * Queue a message for next update\n     * @param {string} messageType The message type to queue\n     * @param {any} data Data to include with the message\n     */\n    queue(messageType: string, data: any = {}): void {\n        this.queuedMessages.push({\n            type: messageType,\n            data: data\n        });\n    }\n    \n    /**\n     * Universal handler for game over events - used by multiple components\n     * @param {string} reason Reason for game over\n     * @param {string} source Source of the game over event\n     */\n    static triggerGameOver(reason: string, source: string): void {\n        // Try to find a message bus to use - prioritization order for reliability\n        let messageBusToUse: MessageBus | null = null;\n        \n        // Use main message bus if available (highest priority)\n        if ((globalThis as any).mainMessageBus) {\n            messageBusToUse = (globalThis as any).mainMessageBus;\n        }\n        // Use window.game.messageBus if available and mainMessageBus not found\n        else if ((window as any).game && (window as any).game.messageBus) {\n            messageBusToUse = (window as any).game.messageBus;\n        } \n        \n        // Check if we found a message bus to use\n        if (messageBusToUse) {\n            // Publish the event\n            messageBusToUse.publish('game.over', {\n                reason: reason,\n                source: source\n            });\n        }\n    }\n}\n","import { MessageBus } from '../core/messageBus.ts';\n\ntype GlobalWithMessageBus = { mainMessageBus?: MessageBus };\n\nconst globalWithMessageBus = globalThis as GlobalWithMessageBus;\n\nexport const mainMessageBus: MessageBus = globalWithMessageBus.mainMessageBus ?? new MessageBus();\n\nif (!globalWithMessageBus.mainMessageBus) {\n    globalWithMessageBus.mainMessageBus = mainMessageBus;\n}\n","import { getGlobalPoolRegistry } from '../modules/pooling/PoolRegistry.ts';\nimport { DEBUG_MODE } from './debug.js';\n\ntype PoolRegistry = {\n    get: (type: string, ...args: unknown[]) => unknown;\n    register: (type: string, config: { factory: () => unknown; reset?: (obj: unknown) => void; preallocate?: number; maxSize?: number }) => void;\n    release: (type: string, obj: unknown) => void;\n    clearAll?: () => void;\n    typeToPool?: Map<string, { objects: unknown[]; maxSize: number }>;\n    statsData?: { hits: number; misses: number };\n};\n\ntype ObjectPoolFacade = {\n    registry: PoolRegistry;\n    get: (type: string, ...args: unknown[]) => unknown;\n    release: (type: string, obj: unknown) => void;\n    createPool: (type: string, factory: () => unknown, initialSize?: number, maxSize?: number) => void;\n    getStats: (type: string) => { available: number; maxSize: number; hits: number; misses: number } | null;\n    clearAllPools: () => void;\n};\n\ntype GlobalWithObjectPool = { objectPool?: ObjectPoolFacade };\n\nconst globalWithObjectPool = globalThis as GlobalWithObjectPool;\n\nexport const objectPool: ObjectPoolFacade = globalWithObjectPool.objectPool ?? {\n    registry: getGlobalPoolRegistry() as PoolRegistry,\n\n    get(type, ...args) {\n        try {\n            return this.registry.get(type, ...args);\n        } catch (e) {\n            if (DEBUG_MODE.enabled) {\n                console.log(`Creating on-demand pool: ${type}`);\n            }\n            this.registry.register(type, {\n                factory: () => ({}),\n                preallocate: 10,\n                maxSize: 100\n            });\n            return this.registry.get(type, ...args);\n        }\n    },\n\n    release(type, obj) {\n        this.registry.release(type, obj);\n    },\n\n    createPool(type, factory, initialSize = 10, maxSize = 100) {\n        this.registry.register(type, {\n            factory,\n            reset: (obj) => {\n                if (obj && typeof obj === 'object' && 'reset' in obj && typeof (obj as { reset?: () => void }).reset === 'function') {\n                    (obj as { reset: () => void }).reset();\n                }\n            },\n            preallocate: initialSize,\n            maxSize\n        });\n    },\n\n    getStats(type) {\n        if (this.registry.typeToPool && this.registry.typeToPool.has(type)) {\n            const pool = this.registry.typeToPool.get(type);\n            return {\n                available: pool ? pool.objects.length : 0,\n                maxSize: pool ? pool.maxSize : 0,\n                hits: this.registry.statsData ? this.registry.statsData.hits : 0,\n                misses: this.registry.statsData ? this.registry.statsData.misses : 0\n            };\n        }\n        return null;\n    },\n\n    clearAllPools() {\n        if (this.registry.clearAll) {\n            this.registry.clearAll();\n            return;\n        }\n        if (this.registry.typeToPool) {\n            this.registry.typeToPool.forEach((pool) => {\n                pool.objects = [];\n            });\n        }\n    }\n};\n\nif (!globalWithObjectPool.objectPool) {\n    globalWithObjectPool.objectPool = objectPool;\n}\n","// globals.js - Initialize global objects and facades\n\nimport * as THREE from 'three';\nimport { mainMessageBus } from '../globals/messageBus.ts';\nimport { objectPool } from '../globals/objectPool.ts';\nimport { setDebugMode } from '../globals/debug.ts';\n\ntype VectorPool = {\n    pool: THREE.Vector3[];\n    maxSize: number;\n    get: (x?: number, y?: number, z?: number) => THREE.Vector3;\n    release: (vector: THREE.Vector3) => void;\n};\n\nexport function initializeGlobals(): void {\n    // Initialize Three.js global (already set by src/main.js, but ensure it's available)\n    if (!window.THREE) {\n        window.THREE = THREE as Window['THREE'];\n    }\n\n    setDebugMode(false);\n\n    // Ensure global message bus and object pool singletons are initialized\n    void mainMessageBus;\n    void objectPool;\n\n    // Initialize global vector pool for reusing vector objects\n    initializeVectorPool();\n}\n\nfunction initializeVectorPool(): void {\n    const vectorPool: VectorPool = {\n        pool: [],\n        maxSize: 100,\n\n        get: function(x = 0, y = 0, z = 0) {\n            if (this.pool.length > 0) {\n                const vector = this.pool.pop();\n                if (vector) {\n                    return vector.set(x, y, z);\n                }\n            }\n            return new THREE.Vector3(x, y, z);\n        },\n\n        release: function(vector) {\n            if (this.pool.length < this.maxSize) {\n                this.pool.push(vector);\n            }\n        }\n    };\n    window.vectorPool = vectorPool;\n}\n","// startupSequence.js - Asset preloads and intro flow management\n\nimport * as THREE from 'three';\nimport { mainMessageBus } from '../globals/messageBus.ts';\n// import { IntroSequence } from '../modules/introSequence.js'; // Removed direct import\n\ntype AudioContextLike = {\n    state: string;\n};\n\ntype AudioManagerLike = {\n    audioContext?: AudioContextLike;\n    resumeAudioContext: () => void;\n    initialize: () => Promise<void>;\n};\n\ntype StartScreenLike = {\n    show: () => void;\n};\n\ntype CombatDisplayLike = {\n    hide: () => void;\n    show: () => void;\n};\n\ntype StargateInterfaceLike = {\n    hide: () => void;\n};\n\ntype UiLike = {\n    startScreen?: StartScreenLike;\n    showError?: (message: string) => void;\n    combatDisplay?: CombatDisplayLike;\n    stargateInterface?: StargateInterfaceLike;\n    hideUI: () => void;\n    showUI: () => void;\n};\n\ntype EnemySystemLike = {\n    freezeAllEnemies: () => void;\n    unfreezeAllEnemies: () => void;\n};\n\ntype CombatLike = {\n    world?: unknown;\n    playerEntity?: unknown;\n    createPlayerReferenceEntity?: () => void;\n};\n\ntype SpaceshipLike = {\n    mesh?: {\n        position: { set: (x: number, y: number, z: number) => void; x: number; y: number; z: number };\n        rotation: { set: (x: number, y: number, z: number) => void };\n    };\n    isDocked: boolean;\n    undock: () => void;\n};\n\ntype StartupGameContext = {\n    audio?: AudioManagerLike;\n    ui?: UiLike;\n    boundAnimate?: () => void;\n    combat?: CombatLike;\n    scene?: unknown;\n    camera?: unknown;\n    spaceship?: SpaceshipLike;\n    initializeObjectPools?: () => void;\n    preWarmBasicShaders?: () => void;\n    startDocked?: () => void;\n    introSequenceActive?: boolean;\n};\n\ntype IntroSequenceLike = {\n    onComplete?: (() => void) | null;\n    startSequence: (onComplete?: () => void) => void;\n};\n\nexport class StartupSequence {\n    game: StartupGameContext;\n    introSequence: IntroSequenceLike | null;\n    introSequenceActive: boolean;\n\n    constructor(game: StartupGameContext) {\n        this.game = game;\n        this.introSequence = null;\n        this.introSequenceActive = false;\n    }\n    \n    // Initialize game in sequence, showing start screen first and loading non-essentials after\n    async initializeGameSequence(): Promise<void> {\n        try {\n            \n            // Add a small delay to let browser stabilize after page load\n            await new Promise<void>(resolve => setTimeout(resolve, 100));\n            \n            // Resume audio context if needed (browser autoplay policy)\n            if (this.game.audio && this.game.audio.audioContext && this.game.audio.audioContext.state === 'suspended') {\n                try {\n                    this.game.audio.resumeAudioContext();\n                } catch (e) {\n                }\n            }\n            \n            // Show the start screen immediately\n            if (this.game.ui && this.game.ui.startScreen) {\n                this.game.ui.startScreen.show();\n            } else {\n                this.fallbackToDefaultBehavior();\n            }\n            \n            // Start game loop with warm-up frames\n            if (this.game.boundAnimate) {\n                requestAnimationFrame(this.game.boundAnimate);\n            }\n            \n            // Initialize remaining systems in the background after start screen is shown\n            this.initializeRemainingSystemsAsync();\n            \n        } catch (error) {\n            \n            // Show error in UI if possible\n            if (this.game.ui && this.game.ui.showError) {\n                const message = error instanceof Error ? error.message : String(error);\n                this.game.ui.showError(\"Failed to initialize game: \" + message);\n            } else {\n                const message = error instanceof Error ? error.message : String(error);\n                alert(\"Failed to initialize game: \" + message);\n            }\n        }\n    }\n    \n    // Initialize remaining systems asynchronously after showing the start screen\n    async initializeRemainingSystemsAsync(): Promise<void> {\n        try {\n            // Start loading audio in the background\n            this.loadAudioAsync();\n            \n            // Initialize combat systems asynchronously\n            if (!this.game.combat) {\n                const { Combat } = await import('../modules/combat.js');\n                this.game.combat = new Combat(this.game.scene as THREE.Scene, this.game.spaceship);\n                \n                // Ensure the ECS world in combat is properly initialized\n                if (!this.game.combat.world) {\n                    // Add a check to ensure the player entity exists\n                    setTimeout(() => {\n                        if (this.game.combat && this.game.combat.world && this.game.combat.playerEntity) {\n                        } else if (this.game.combat) {\n                            console.warn(\"Combat ECS world or player entity not available after delay, recreating...\");\n                            if (this.game.combat.createPlayerReferenceEntity) {\n                                this.game.combat.createPlayerReferenceEntity();\n                            }\n                        }\n                    }, 1000);\n                }\n            }\n            \n            // Initialize common object pools after start screen is shown\n            setTimeout(() => {\n                if (this.game.initializeObjectPools) {\n                    this.game.initializeObjectPools();\n                }\n                \n                // Pre-warm essential shaders and projectile assets after start screen is shown\n                if (this.game.preWarmBasicShaders) {\n                    this.game.preWarmBasicShaders();\n                }\n            }, 100);\n        } catch (error) {\n        }\n    }\n    \n    // Load audio asynchronously after showing the start screen\n    async loadAudioAsync(): Promise<void> {\n        try {\n            if (this.game.audio) {\n                // Initialize audio in the background\n                this.game.audio.initialize().then(() => {\n                }).catch(() => {\n                });\n            }\n        } catch (error) {\n        }\n    }\n    \n    fallbackToDefaultBehavior(): void {\n        // Start the game immediately with default settings\n        if (this.game.startDocked) {\n            this.game.startDocked();\n        }\n    }\n    \n    async initIntroSequence(): Promise<void> {\n        // Initialize the intro sequence module\n        const { IntroSequence } = await import('../modules/introSequence.js');\n        this.introSequence = new IntroSequence(\n            this.game.scene as THREE.Scene,\n            this.game.camera as THREE.Camera,\n            this.game.spaceship ?? null,\n            this.game.audio ?? null  // Pass audio manager as 4th parameter\n        );\n        \n        // Set the completion callback\n        this.introSequence!.onComplete = () => {\n            this.completeIntroSequence();\n        };\n    }\n    \n    async startIntroSequence(): Promise<void> { // Mark as async\n        if (!this.introSequence) {\n            await this.initIntroSequence(); // Await the dynamic import\n        }\n        \n        this.introSequenceActive = true;\n        if (typeof this.game.introSequenceActive !== 'undefined') {\n            this.game.introSequenceActive = true;\n        }\n        \n        // Disable all enemies during intro sequence\n        if (this.game.combat && this.game.combat.world) {\n            const enemySystem = (this.game.combat.world as { enemySystem?: EnemySystemLike }).enemySystem;\n            if (enemySystem) {\n                enemySystem.freezeAllEnemies();\n            }\n        }\n        \n        // Hide UI elements during intro\n        if (this.game.ui && this.game.ui.combatDisplay) {\n            this.game.ui.combatDisplay.hide();\n        }\n        \n        // Player controls are automatically disabled during intro via introSequenceActive flag\n        // The InputHandler checks window.game.introSequenceActive\n        \n        // Hide the stargate UI immediately when intro starts\n        if (this.game.ui && this.game.ui.stargateInterface) {\n            this.game.ui.stargateInterface.hide();\n        }\n        \n        // Also hide the entire UI during intro\n        if (this.game.ui) {\n            this.game.ui.hideUI();\n        }\n        \n        // Position spaceship for intro\n        if (this.game.spaceship && this.game.spaceship.mesh) {\n            this.game.spaceship.mesh.position.set(0, 0, 50);\n            this.game.spaceship.mesh.rotation.set(0, 0, 0);\n        }\n        \n        // Start the intro sequence\n        const introSequence = this.introSequence;\n        if (!introSequence) return;\n        introSequence.startSequence(() => {\n            this.completeIntroSequence();\n        });\n    }\n    \n    completeIntroSequence(): void {\n        this.introSequenceActive = false;\n        if (typeof this.game.introSequenceActive !== 'undefined') {\n            this.game.introSequenceActive = false;\n        }\n        \n        // Mark intro as played so it doesn't play again\n        localStorage.setItem('introPlayed', 'true');\n        \n        // Re-enable enemies after intro\n        if (this.game.combat && this.game.combat.world) {\n            const enemySystem = (this.game.combat.world as { enemySystem?: EnemySystemLike }).enemySystem;\n            if (enemySystem) {\n                enemySystem.unfreezeAllEnemies();\n            }\n        }\n        \n        // Ensure stargate UI is hidden after intro\n        if (this.game.ui && this.game.ui.stargateInterface) {\n            this.game.ui.stargateInterface.hide();\n        }\n        \n        // Start game based on whether player wants to be docked or not\n        // Always start undocked after intro\n        if (this.game.ui) {\n            this.game.ui.showUI();\n        }\n        \n        // After intro, player should stay where they were deployed\n        // Only ensure the spaceship is undocked, don't reset position\n        if (this.game.spaceship) {\n            // Make sure spaceship is undocked\n            if (this.game.spaceship.isDocked) {\n                this.game.spaceship.undock();\n            }\n            // Log current position for debugging\n            if (this.game.spaceship.mesh) {\n                console.log(\"Player position after intro:\", \n                    this.game.spaceship.mesh.position.x,\n                    this.game.spaceship.mesh.position.y,\n                    this.game.spaceship.mesh.position.z\n                );\n            }\n        }\n        \n        // Player controls are automatically re-enabled when introSequenceActive is set to false\n        // The InputHandler checks window.game.introSequenceActive\n        \n        // Show combat display after intro\n        if (this.game.ui && this.game.ui.combatDisplay) {\n            this.game.ui.combatDisplay.show();\n        }\n        \n        // Emit event for other systems\n        if (mainMessageBus) {\n            mainMessageBus.publish('intro.completed', {});\n        }\n        \n    }\n}\n","// gameLoop.js - Ticking and requestAnimationFrame wiring\n\ntype GameLoopRenderer = {\n    render: () => void;\n};\n\ntype GameLoopSettings = {\n    getFrameRateCap?: () => string | number;\n};\n\ntype GameLoopUi = {\n    updateFPS?: (fps: number, cap?: number) => void;\n    settings?: GameLoopSettings;\n};\n\ntype GameLoopGame = {\n    update: (deltaTime: number) => void;\n    renderer?: GameLoopRenderer;\n    ui?: GameLoopUi;\n    gameTime: number;\n};\n\nexport class GameLoop {\n    game: GameLoopGame;\n    frameRateCap: number;\n    warmupFrames: number;\n    currentWarmupFrame: number;\n    performanceStable: boolean;\n    lastFrameTime: number;\n    actualFrameTime: number;\n    frameStartTime: number;\n    accumulator: number;\n    fixedDeltaTime: number;\n    fpsBuffer: number[];\n    fpsBufferSize: number;\n    boundAnimate: FrameRequestCallback | null;\n    deltaTime: number;\n    lastUpdateTime: number;\n    frameCount: number;\n    currentFPS: number;\n\n    constructor(game: GameLoopGame) {\n        this.game = game;\n        \n        // Frame rate cap (defaults to auto/monitor refresh rate)\n        this.frameRateCap = 0; // Will be updated by settings or refresh rate detection\n        this.warmupFrames = 10; // Number of frames to skip for timing stabilization\n        this.currentWarmupFrame = 0;\n        this.performanceStable = false;\n        \n        // Time tracking for frame rate cap and FPS calculation\n        this.lastFrameTime = 0;\n        this.actualFrameTime = 0;\n        this.frameStartTime = 0;\n        this.accumulator = 0;\n        this.fixedDeltaTime = 1/60; // Fixed 60 Hz update rate\n        \n        // FPS averaging for smoother display\n        this.fpsBuffer = [];\n        this.fpsBufferSize = 15; // Smaller buffer for more responsive updates\n        \n        // Pre-bind animate method to avoid creating a new function every frame\n        this.boundAnimate = this.animate.bind(this);\n        \n        // Reusable deltaTime variable to avoid creating new variables in hot path\n        this.deltaTime = 0;\n        \n        // Performance tracking\n        this.lastUpdateTime = performance.now();\n        this.frameCount = 0;\n        this.currentFPS = 0;\n    }\n    \n    start(): void {\n        if (this.boundAnimate) {\n            requestAnimationFrame(this.boundAnimate);\n        }\n    }\n    \n    animate(timestamp: number): void {\n        // Handle warm-up frames for timing stabilization\n        if (this.currentWarmupFrame < this.warmupFrames) {\n            this.currentWarmupFrame++;\n            \n            // Initialize timing on first real frame after warm-up\n            if (this.currentWarmupFrame === this.warmupFrames) {\n                this.lastFrameTime = timestamp;\n                this.frameStartTime = performance.now();\n                this.lastUpdateTime = performance.now();\n                this.performanceStable = true;\n            }\n            \n            // Continue warm-up\n            if (this.boundAnimate) {\n                requestAnimationFrame(this.boundAnimate);\n            }\n            return;\n        }\n        \n        // Initialize frame timing if needed (fallback)\n        if (!this.lastFrameTime) {\n            this.lastFrameTime = timestamp;\n            this.frameStartTime = performance.now();\n            // Request next frame and return\n            if (this.boundAnimate) {\n                requestAnimationFrame(this.boundAnimate);\n            }\n            return; // Skip first frame to establish baseline\n        }\n        \n        // Track actual frame time for FPS calculation\n        this.actualFrameTime = timestamp - this.lastFrameTime;\n        \n        // Frame rate cap handling\n        if (this.frameRateCap > 0) {\n            // Calculate target frame duration in milliseconds\n            const targetFrameTime = 1000 / this.frameRateCap;\n            \n            // Calculate elapsed time since last rendered frame\n            const elapsedSinceLastFrame = timestamp - this.lastFrameTime;\n            \n            // If we haven't reached the target frame time yet, skip this frame\n            if (elapsedSinceLastFrame < targetFrameTime - 0.5) { // Subtract small amount to account for timing imprecision\n                // Request next frame and return early\n                if (this.boundAnimate) {\n                    requestAnimationFrame(this.boundAnimate);\n                }\n                return;\n            }\n            \n            // Update timing for next frame - use the exact target time\n            // This helps maintain a more consistent frame rate\n            this.lastFrameTime += targetFrameTime;\n            \n            // If we're more than one frame behind, catch up to avoid spiraling\n            if (timestamp - this.lastFrameTime > targetFrameTime) {\n                this.lastFrameTime = timestamp - targetFrameTime;\n            }\n        } else {\n            // No frame rate cap - update normally\n            this.lastFrameTime = timestamp;\n        }\n        \n        // Calculate delta time for this frame - prevent huge deltas\n        const now = performance.now();\n        const rawDelta = Math.min((now - this.lastUpdateTime) / 1000, 0.1); // Cap at 100ms to prevent explosion on tab switch\n        this.lastUpdateTime = now;\n        \n        // Update accumulator for fixed timestep\n        this.accumulator += rawDelta;\n        \n        // Perform fixed timestep updates\n        // This keeps physics and gameplay consistent regardless of frame rate\n        while (this.accumulator >= this.fixedDeltaTime) {\n            // Use fixed delta for deterministic updates\n            this.deltaTime = this.fixedDeltaTime;\n            \n            // Store game time before update\n            this.game.gameTime += this.deltaTime;\n            \n            // Update all game systems\n            this.game.update(this.deltaTime);\n            \n            this.accumulator -= this.fixedDeltaTime;\n        }\n        \n        // Interpolation factor for rendering (unused for now, but useful for smooth rendering)\n        // const alpha = this.accumulator / this.fixedDeltaTime;\n        \n        // Render the frame\n        if (this.game.renderer && this.game.renderer.render) {\n            this.game.renderer.render();\n        }\n        \n        // Update FPS calculation\n        this.updateFPS();\n        \n        // Request next frame\n        if (this.boundAnimate) {\n            requestAnimationFrame(this.boundAnimate);\n        }\n    }\n    \n    updateFPS(): void {\n        const instantFPS = this.actualFrameTime ? 1000 / this.actualFrameTime : 60;\n        \n        // Add to FPS buffer with weighted preference to more recent readings\n        // This helps the FPS display stabilize faster when frame rate changes\n        this.fpsBuffer.push(instantFPS);\n        if (this.fpsBuffer.length > this.fpsBufferSize) {\n            this.fpsBuffer.shift(); // Remove oldest value\n        }\n        \n        // Use weighted average to more accurately represent current FPS\n        // Gives more importance to recent frames\n        let totalWeight = 0;\n        let weightedSum = 0;\n        \n        for (let i = 0; i < this.fpsBuffer.length; i++) {\n            // Weight increases linearly with frame index (newer frames get higher weight)\n            const weight = i + 1;\n            weightedSum += this.fpsBuffer[i] * weight;\n            totalWeight += weight;\n        }\n        \n        // Calculate weighted average for smoother display\n        this.currentFPS = Math.round(weightedSum / totalWeight);\n        \n        // Only update FPS display every few frames to reduce DOM operations\n        if (this.frameCount % 5 === 0 && this.game.ui && this.game.ui.updateFPS) {\n            // If capped, show cap information along with actual FPS\n            if (this.frameRateCap > 0) {\n                this.game.ui.updateFPS(this.currentFPS, this.frameRateCap);\n            } else {\n                this.game.ui.updateFPS(this.currentFPS);\n            }\n        }\n        \n        // Count frames for performance monitoring\n        this.frameCount++;\n    }\n    \n    setFrameRateCap(cap: number): void {\n        this.frameRateCap = cap;\n    }\n    \n    applyFrameRateSettings(): void {\n        // Apply frame rate settings from UI\n        if (this.game.ui && this.game.ui.settings) {\n            const frameRateSetting = this.game.ui.settings.getFrameRateCap ? \n                                   this.game.ui.settings.getFrameRateCap() : 0;\n            \n            if (frameRateSetting === 'auto' || frameRateSetting === 0) {\n                // Auto-detect based on refresh rate\n                this.setFrameRateCap(0); // Unlimited for now\n                \n                // Try to detect monitor refresh rate\n                this.detectRefreshRate().then(rate => {\n                    if (rate && rate > 0) {\n                        this.setFrameRateCap(rate);\n                    }\n                });\n            } else {\n                // Use manual setting\n                const cap = typeof frameRateSetting === 'string' ? parseInt(frameRateSetting) : frameRateSetting;\n                this.setFrameRateCap(cap);\n            }\n        }\n    }\n    \n    async detectRefreshRate(): Promise<number> {\n        // Try to detect the monitor's refresh rate\n        // This is a simple heuristic that measures frame timing\n        return new Promise((resolve) => {\n            let frames = 0;\n            let startTime = 0;\n            const samples: number[] = [];\n            \n            const measure = (timestamp: number) => {\n                if (frames === 0) {\n                    startTime = timestamp;\n                } else if (frames > 10 && frames <= 70) {\n                    // Collect samples after warm-up\n                    const delta = timestamp - startTime;\n                    samples.push(delta);\n                    startTime = timestamp;\n                }\n                \n                frames++;\n                \n                if (frames < 80) {\n                    requestAnimationFrame(measure);\n                } else {\n                    // Calculate average frame time\n                    if (samples.length > 0) {\n                        const avgFrameTime = samples.reduce((a, b) => a + b, 0) / samples.length;\n                        const detectedRate = Math.round(1000 / avgFrameTime);\n                        \n                        // Round to common refresh rates\n                        const commonRates = [30, 60, 75, 90, 120, 144, 165, 240, 360];\n                        let closestRate = 60;\n                        let minDiff = Math.abs(detectedRate - 60);\n                        \n                        for (const rate of commonRates) {\n                            const diff = Math.abs(detectedRate - rate);\n                            if (diff < minDiff) {\n                                minDiff = diff;\n                                closestRate = rate;\n                            }\n                        }\n                        \n                        // Only use detected rate if we're confident\n                        if (minDiff < 5) {\n                            resolve(closestRate);\n                        } else {\n                            resolve(0); // Fallback to unlimited\n                        }\n                    } else {\n                        resolve(0);\n                    }\n                }\n            };\n            \n            requestAnimationFrame(measure);\n        });\n    }\n    \n    destroy(): void {\n        // Cancel animation frame\n        if (this.boundAnimate) {\n            cancelAnimationFrame(this.boundAnimate as unknown as number);\n            this.boundAnimate = null;\n        }\n    }\n}\n","// perfOverlay.ts - Minimal scaffold for performance overlay toggle (F3)\n// Feature flag default ON per V07_TIGHTENING\n\ninterface PerfPools {\n  hits: number;\n  misses: number;\n}\n\ninterface PerfSystems {\n  [key: string]: number;\n}\n\ninterface PerfMetrics {\n  enabled: boolean;\n  fps: number;\n  simMs: number;\n  renderMs: number;\n  drawCalls: number;\n  visibleInstances: number;\n  pools: PerfPools;\n  gc: number;\n  systems: PerfSystems;\n}\n\nconst FEATURE_FLAG = true; // V07_TIGHTENING default ON\n\nexport class PerfOverlay {\n  private panel: HTMLElement | null = null;\n  private updateHzMs: number = 500; // ~2Hz\n  private _gcObserver: PerformanceObserver | null = null;\n  private interval: number | null = null;\n\n  constructor() {\n    // Global perf sink\n    this.ensurePerf();\n\n    // optional GC observer (best-effort)\n    try {\n      if ('PerformanceObserver' in window) {\n        const obs = new PerformanceObserver((list: PerformanceObserverEntryList) => {\n          for (const entry of list.getEntries()) {\n            if (entry.entryType === 'gc') {\n              const perf = this.ensurePerf();\n              if (!perf.gc) perf.gc = 0;\n              perf.gc += 1;\n            }\n          }\n        });\n        obs.observe({ entryTypes: ['gc'] });\n        this._gcObserver = obs;\n      }\n    } catch (e) {\n      console.warn('PerformanceObserver for GC not available:', e);\n    }\n\n    if (FEATURE_FLAG) {\n      // Hook F3 toggle\n      document.addEventListener('keydown', (e: KeyboardEvent) => {\n        if (e.key === 'F3') {\n          this.toggle();\n        }\n      });\n    }\n  }\n\n  toggle(): void {\n    const perf = this.ensurePerf();\n    perf.enabled = !perf.enabled;\n    if (perf.enabled) {\n      this.ensurePanel();\n      this.renderOnce();\n    } else {\n      this.destroy();\n    }\n  }\n\n  private ensurePanel(): void {\n    if (this.panel) return;\n    const el = document.createElement('div');\n    el.id = 'perf-overlay';\n    el.style.position = 'fixed';\n    el.style.top = '8px';\n    el.style.right = '8px';\n    el.style.minWidth = '220px';\n    el.style.maxWidth = '320px';\n    el.style.background = 'rgba(0,0,0,0.6)';\n    el.style.color = '#9ef7ff';\n    el.style.fontFamily = 'monospace';\n    el.style.fontSize = '12px';\n    el.style.lineHeight = '1.4';\n    el.style.padding = '8px 10px';\n    el.style.border = '1px solid rgba(158,247,255,0.3)';\n    el.style.borderRadius = '6px';\n    el.style.zIndex = '99999';\n    el.style.pointerEvents = 'none';\n    el.innerHTML = this.renderContent();\n    document.body.appendChild(el);\n    this.panel = el;\n\n    // Start a lightweight interval to update ~2Hz\n    this.interval = window.setInterval(() => this.renderOnce(), this.updateHzMs);\n  }\n\n  private renderOnce(): void {\n    if (!this.panel) return;\n    this.panel.innerHTML = this.renderContent();\n  }\n\n  private renderContent(): string {\n    const p = this.ensurePerf();\n    const systems = p.systems ? Object.entries(p.systems).slice(0, 8) : [];\n    const sysHtml = systems.map(([k,v]) => `<div>${k}: ${Number(v).toFixed(2)} ms</div>`).join('');\n    return (\n      `<div style=\\\"opacity:.85\\\">` +\n      `<div><b>Perf Overlay</b> (F3)</div>` +\n      `<div>FPS: ${Math.round(p.fps || 0)}</div>` +\n      `<div>Sim: ${Number(p.simMs || 0).toFixed(2)} ms</div>` +\n      `<div>Render: ${Number(p.renderMs || 0).toFixed(2)} ms</div>` +\n      `<div>DrawCalls: ${p.drawCalls || 0}</div>` +\n      `<div>Instances: ${p.visibleInstances || 0}</div>` +\n      `<div>Pool hits/misses: ${(p.pools?.hits||0)} / ${(p.pools?.misses||0)}</div>` +\n      `<div>GC: ${p.gc || 0}</div>` +\n      `<div style=\\\"margin-top:6px; border-top:1px solid rgba(158,247,255,.2)\\\">` +\n      `<div><b>Systems</b></div>` + sysHtml +\n      `</div>` +\n      `</div>`\n    );\n  }\n\n  destroy(): void {\n    if (this.interval !== null) {\n      clearInterval(this.interval);\n      this.interval = null;\n    }\n    if (this._gcObserver && this._gcObserver.disconnect) {\n      this._gcObserver.disconnect();\n      this._gcObserver = null;\n    }\n    if (this.panel && this.panel.parentNode) {\n      this.panel.parentNode.removeChild(this.panel);\n    }\n    this.panel = null;\n  }\n\n  private ensurePerf(): PerfMetrics {\n    if (!window.__perf) {\n      window.__perf = {\n        enabled: false,\n        fps: 0,\n        simMs: 0,\n        renderMs: 0,\n        drawCalls: 0,\n        visibleInstances: 0,\n        pools: { hits: 0, misses: 0 },\n        gc: 0,\n        systems: {},\n      };\n    }\n    return window.__perf;\n  }\n}\n\nexport function initPerfOverlay(): PerfOverlay {\n  // Create once, attach to window for future hooks\n  if (!window.__perfOverlay) {\n    window.__perfOverlay = new PerfOverlay();\n  }\n  return window.__perfOverlay as PerfOverlay;\n}\n","// diagnostics.js - Performance overlay and debug toggles\n\nimport { initPerfOverlay } from '../modules/debug/perfOverlay.js';\nimport { DEBUG_MODE, toggleDebugMode } from '../globals/debug.ts';\nimport { objectPool } from '../globals/objectPool.ts';\n\ntype GameLoopLike = {\n    setFrameRateCap: (limit: number) => void;\n    currentFPS?: number;\n};\n\ntype UiLike = {\n    initializePerformanceMonitor?: () => void;\n    statsInterval?: number | null;\n};\n\ntype StartupSequenceLike = {\n    startIntroSequence?: () => void;\n};\n\ntype CombatWorldLike = {\n    entityManager?: { entities: Set<unknown> };\n    systemManager?: { systems: unknown[] };\n};\n\ntype CombatLike = {\n    world?: CombatWorldLike;\n};\n\ntype DifficultyManagerLike = {\n    currentLevel?: number;\n};\n\ntype DiagnosticsGame = {\n    gameLoop?: GameLoopLike;\n    ui?: UiLike;\n    startupSequence?: StartupSequenceLike;\n    isGameOver?: boolean;\n    spaceship?: { isDocked?: boolean };\n    introSequenceActive?: boolean;\n    isHordeActive?: boolean;\n    gameTime?: number;\n    difficultyManager?: DifficultyManagerLike;\n    activateHordeMode?: () => void;\n    combat?: CombatLike;\n    scene?: { children: unknown[] };\n};\n\nexport class Diagnostics {\n    game: DiagnosticsGame;\n\n    constructor(game: DiagnosticsGame) {\n        this.game = game;\n        this.setupDiagnostics();\n    }\n    \n    setupDiagnostics(): void {\n        // Perf overlay & sink\n        initPerfOverlay();\n        const perf = window.__perf ?? (window.__perf = {\n            enabled: false,\n            fps: 0,\n            simMs: 0,\n            renderMs: 0,\n            drawCalls: 0,\n            visibleInstances: 0,\n            pools: { hits: 0, misses: 0 },\n            gc: 0,\n            systems: {}\n        });\n        perf.enabled = false;\n        \n        // Add debug command for FPS limit\n        window.setFPSLimit = (limit: number) => {\n            if (this.game.gameLoop) {\n                this.game.gameLoop.setFrameRateCap(limit);\n                return `FPS limit set to ${limit > 0 ? limit : 'unlimited'}`;\n            }\n            return \"Game loop not initialized\";\n        };\n        \n        // Add debug command for performance monitoring\n        window.togglePerf = (): string => {\n            perf.enabled = !perf.enabled;\n            \n            if (perf.enabled) {\n                // Initialize performance monitor if needed\n                if (this.game.ui && this.game.ui.initializePerformanceMonitor) {\n                    this.game.ui.initializePerformanceMonitor();\n                }\n                \n                // Force memory stats update\n                if (window.MemoryStats) {\n                    window.MemoryStats.update();\n                    window.MemoryStats.logReport();\n                }\n            } else {\n                // Remove performance monitor if it exists\n                const statsElement = document.getElementById('performance-stats');\n                if (statsElement) {\n                    statsElement.remove();\n                }\n                \n                // Clear interval if it exists\n                if (this.game.ui && this.game.ui.statsInterval) {\n                    clearInterval(this.game.ui.statsInterval);\n                    this.game.ui.statsInterval = null;\n                }\n            }\n            \n            return perf.enabled ? \"enabled\" : \"disabled\";\n        };\n        \n        // Add global debug command to trigger intro sequence\n        window.playIntro = (): string => {\n            if (this.game.startupSequence && this.game.startupSequence.startIntroSequence) {\n                    this.game.startupSequence.startIntroSequence();\n                return \"Playing intro sequence...\";\n            }\n            return \"Intro sequence not available\";\n        };\n        \n        // Add debug command to toggle debug mode\n        window.toggleDebug = (): string => {\n            toggleDebugMode();\n            return `Debug mode ${DEBUG_MODE.enabled ? 'enabled' : 'disabled'}`;\n        };\n        \n        // Add debug command to show game state\n        window.gameState = () => {\n            return {\n                isGameOver: this.game.isGameOver,\n                isDocked: this.game.spaceship?.isDocked,\n                introActive: this.game.introSequenceActive,\n                hordeActive: this.game.isHordeActive,\n                fps: this.game.gameLoop?.currentFPS,\n                gameTime: this.game.gameTime,\n                difficulty: this.game.difficultyManager?.currentLevel\n            };\n        };\n        \n        // Add debug command to force horde mode\n        window.startHorde = (): string => {\n            if (this.game.activateHordeMode) {\n                this.game.activateHordeMode();\n                return \"Horde mode activated!\";\n            }\n            return \"Horde mode not available\";\n        };\n        \n        // Add debug command for memory stats\n        window.memStats = () => {\n            if (window.MemoryStats) {\n                window.MemoryStats.update();\n                return window.MemoryStats.getReport();\n            }\n            return \"Memory stats not available\";\n        };\n        \n        // Add debug command to check object pool stats\n        window.poolStats = (poolName?: string) => {\n            if (objectPool && objectPool.getStats) {\n                if (poolName) {\n                    return objectPool.getStats(poolName);\n                } else {\n                    // Get stats for all pools\n                    const allStats: Record<string, unknown> = {};\n                    const pools = ['projectile', 'enemy', 'particle', 'hitEffect', 'explosion'];\n                    for (const pool of pools) {\n                        const stats = objectPool.getStats(pool);\n                        if (stats) {\n                            allStats[pool] = stats;\n                        }\n                    }\n                    return allStats;\n                }\n            }\n            return \"Object pool not available\";\n        };\n        \n        // Add command to check entity count\n        window.entityCount = () => {\n            if (this.game.combat && this.game.combat.world && this.game.combat.world.entityManager) {\n                const entities = this.game.combat.world.entityManager.entities.size;\n                const systems = this.game.combat.world.systemManager?.systems.length ?? 0;\n                return {\n                    entities,\n                    systems,\n                    sceneChildren: this.game.scene?.children.length\n                };\n            }\n            return \"ECS world not available\";\n        };\n        \n    }\n}\n","import * as THREE from 'three';\n\n// lightingConfig.ts - Centralized lighting configuration for fine-tuning\n// This file contains all the key lighting parameters that define the visual aesthetic\n\ninterface Vector3Config {\n    x: number;\n    y: number;\n    z: number;\n}\n\ninterface SunConfig {\n    color: number;\n    intensity: number;\n    position: Vector3Config;\n}\n\ninterface AmbientConfig {\n    skyColor: number;\n    groundColor: number;\n    intensity: number;\n}\n\ninterface ShadowsConfig {\n    enabled: boolean;\n    mapSize: number;\n    type: 'Basic' | 'PCF' | 'PCFSoft' | 'VSM'; // Assuming these are the possible types\n    radius: number;\n    blurSamples: number;\n    bias: number;\n    normalBias: number;\n    frustumSize: number;\n    near: number;\n    far: number;\n}\n\ninterface BloomConfig {\n    enabled: boolean;\n    strength: number;\n    radius: number;\n    threshold: number;\n}\n\ninterface ToneMappingConfig {\n    type: 'No' | 'Linear' | 'Reinhard' | 'Cineon' | 'ACESFilmic'; // Common Three.js tone mapping types\n    exposure: number;\n}\n\ninterface GodRaysConfig {\n    enabled: boolean;\n    density: number;\n    weight: number;\n    decay: number;\n    exposure: number;\n    samples: number;\n}\n\ninterface VolumetricConfig {\n    godRays: GodRaysConfig;\n}\n\ninterface MaterialPresetProps {\n    metalness?: number;\n    roughness?: number;\n    emissiveIntensity?: number;\n    clearcoat?: number;\n    sheen?: number;\n}\n\ninterface AsteroidMaterials {\n    iron: MaterialPresetProps;\n    gold: MaterialPresetProps;\n    platinum: MaterialPresetProps;\n}\n\ninterface PlanetMaterials {\n    rocky: MaterialPresetProps;\n    gasGiant: MaterialPresetProps;\n    terrestrial: MaterialPresetProps;\n}\n\ninterface MaterialsConfig {\n    asteroids: AsteroidMaterials;\n    planets: PlanetMaterials;\n}\n\ninterface PerformanceConfig {\n    shadowAutoUpdate: boolean;\n    shadowMapAutoUpdate: boolean;\n    logarithmicDepthBuffer: boolean;\n}\n\ninterface SunFlickerConfig {\n    enabled: boolean;\n    minIntensity: number;\n    maxIntensity: number;\n    speed: number;\n}\n\ninterface DistanceAttenuationConfig {\n    enabled: boolean;\n    maxDistance: number;\n    minExposure: number;\n    maxExposure: number;\n}\n\ninterface FineTuningConfig {\n    sunFlicker: SunFlickerConfig;\n    distanceAttenuation: DistanceAttenuationConfig;\n}\n\nexport interface LightingConfiguration {\n    sun: SunConfig;\n    ambient: AmbientConfig;\n    shadows: ShadowsConfig;\n    bloom: BloomConfig;\n    toneMapping: ToneMappingConfig;\n    volumetric: VolumetricConfig;\n    materials: MaterialsConfig;\n    performance: PerformanceConfig;\n    fineTuning: FineTuningConfig;\n}\n\nexport const LIGHTING_CONFIG: LightingConfiguration = {\n    // Main sun light configuration\n    sun: {\n        color: 0xFFFFFF,           // Pure white sun\n        intensity: 3.0,            // Moderate intensity for space scenes\n        position: {\n            x: 50000,\n            y: 10000,\n            z: 20000\n        }\n    },\n    \n    // Ambient lighting - enough to see objects in space\n    ambient: {\n        skyColor: 0x202030,        // Deep blue space\n        groundColor: 0x0a0a10,      // Nearly black\n        intensity: 0.3             // Very subtle ambient from starlight\n    },\n    \n    // Shadow configuration\n    shadows: {\n        enabled: true,\n        mapSize: 4096,              // High quality\n        type: 'PCFSoft',            // Soft shadows\n        radius: 2,                  // Softness amount\n        blurSamples: 25,            // Quality of blur\n        bias: -0.0001,              // Prevents shadow acne\n        normalBias: 0.02,           // Additional bias based on normals\n        frustumSize: 10000,         // Shadow camera size\n        near: 0.5,\n        far: 50000\n    },\n    \n    // Post-processing bloom for stars\n    bloom: {\n        enabled: true,\n        strength: 0.8,              // Bloom intensity\n        radius: 0.4,                // Bloom spread\n        threshold: 0.9              // What brightness triggers bloom\n    },\n    \n    // Tone mapping for HDR\n    toneMapping: {\n        type: 'ACESFilmic',         // Cinematic tone mapping\n        exposure: 1.0               // Overall brightness\n    },\n    \n    // Volumetric effects\n    volumetric: {\n        godRays: {\n            enabled: true,\n            density: 0.96,\n            weight: 0.4,\n            decay: 0.95,\n            exposure: 0.35,\n            samples: 100\n        }\n    },\n    \n    // Material presets for consistency\n    materials: {\n        // Asteroid materials using standard materials\n        asteroids: {\n            iron: {\n                metalness: 0.7,\n                roughness: 0.6,\n                emissiveIntensity: 0.1\n            },\n            gold: {\n                metalness: 0.9,\n                roughness: 0.2,\n                emissiveIntensity: 0.15\n            },\n            platinum: {\n                metalness: 0.85,\n                roughness: 0.15,\n                emissiveIntensity: 0.1\n            }\n        },\n        // Planet materials enhanced\n        planets: {\n            rocky: {\n                metalness: 0.05,\n                roughness: 0.85,\n                clearcoat: 0.05\n            },\n            gasGiant: {\n                metalness: 0.0,\n                roughness: 0.3,\n                clearcoat: 0.2,\n                sheen: 0.2\n            },\n            terrestrial: {\n                metalness: 0.02,\n                roughness: 0.4,\n                clearcoat: 0.3,\n                sheen: 0.1\n            }\n        }\n    },\n    \n    // Performance settings\n    performance: {\n        shadowAutoUpdate: true,\n        shadowMapAutoUpdate: true,\n        logarithmicDepthBuffer: true // Better for large scenes\n    },\n    \n    // Fine-tuning parameters\n    fineTuning: {\n        // Adjust these for different moods\n        sunFlicker: {\n            enabled: true,\n            minIntensity: 0.95,\n            maxIntensity: 1.05,\n            speed: 0.015\n        },\n        // Distance-based adjustments\n        distanceAttenuation: {\n            enabled: true,\n            maxDistance: 50000,\n            minExposure: 0.6,\n            maxExposure: 1.0\n        }\n    }\n};\n\n// Minimal interfaces to allow typing in applyLightingConfig\ninterface ILightingManager {\n    sunLight?: THREE.DirectionalLight & { shadow: THREE.DirectionalLightShadow };\n    ambientLight?: THREE.HemisphereLight;\n    renderer?: THREE.WebGLRenderer;\n    lightingManager?: ILightingManager; // For recursive access if lightingManager is nested\n    postProcessingManager?: IPostProcessingManager;\n}\n\ninterface IPostProcessingManager {\n    adjustBloom: (strength: number, radius: number, threshold: number) => void;\n}\n\n/**\n * Helper function to apply config to lighting and post-processing managers\n * @param lightingManager - The LightingManager instance or a combined renderer instance\n * @param config - The lighting configuration to apply\n * @param postProcessingManager - Optional PostProcessingManager instance\n */\nexport function applyLightingConfig(\n    lightingManager: ILightingManager,\n    config: LightingConfiguration = LIGHTING_CONFIG,\n    postProcessingManager: IPostProcessingManager | null = null\n): void {\n    if (!lightingManager) return;\n    \n    // Support passing the main Renderer instance\n    const lm: ILightingManager = lightingManager.lightingManager || lightingManager;\n    const ppm: IPostProcessingManager | undefined = postProcessingManager || lm.postProcessingManager;\n    \n    // Update sun light\n    if (lm.sunLight) {\n        lm.sunLight.color.setHex(config.sun.color);\n        lm.sunLight.intensity = config.sun.intensity;\n        \n        // Update sun position if specified\n        if (config.sun.position) {\n            lm.sunLight.position.set(\n                config.sun.position.x,\n                config.sun.position.y,\n                config.sun.position.z\n            );\n        }\n    }\n    \n    // Update ambient\n    if (lm.ambientLight) {\n        lm.ambientLight.color.setHex(config.ambient.skyColor);\n        (lm.ambientLight as THREE.HemisphereLight).groundColor.setHex(config.ambient.groundColor);\n        lm.ambientLight.intensity = config.ambient.intensity;\n    }\n    \n    // Update shadows\n    if (lm.sunLight && lm.sunLight.shadow) {\n        lm.sunLight.shadow.mapSize.width = config.shadows.mapSize;\n        lm.sunLight.shadow.mapSize.height = config.shadows.mapSize;\n        lm.sunLight.shadow.radius = config.shadows.radius;\n        \n        // Update frustum\n        const d = config.shadows.frustumSize;\n        lm.sunLight.shadow.camera.left = -d;\n        lm.sunLight.shadow.camera.right = d;\n        lm.sunLight.shadow.camera.top = d;\n        lm.sunLight.shadow.camera.bottom = -d;\n        lm.sunLight.shadow.camera.near = config.shadows.near;\n        lm.sunLight.shadow.camera.far = config.shadows.far;\n        lm.sunLight.shadow.camera.updateProjectionMatrix();\n        \n        lm.sunLight.shadow.bias = config.shadows.bias;\n        lm.sunLight.shadow.normalBias = config.shadows.normalBias;\n    }\n    \n    // Update bloom\n    if (ppm) {\n        ppm.adjustBloom(config.bloom.strength, config.bloom.radius, config.bloom.threshold);\n    }\n    \n    // Update exposure\n    if (lm.renderer) {\n        lm.renderer.toneMappingExposure = config.toneMapping.exposure;\n    }\n}\n\n// Export for use in other modules\nexport default LIGHTING_CONFIG;","// lighting.ts - Handles all lighting setup and management for the renderer\n\nimport * as THREE from 'three';\nimport type { WebGPURenderer } from 'three/webgpu';\nimport { LIGHTING_CONFIG } from '../../config/lightingConfig.js';\n\ntype RendererType = THREE.WebGLRenderer | WebGPURenderer;\n\nexport class LightingManager {\n    scene: THREE.Scene;\n    renderer: RendererType;\n    camera: THREE.Camera;\n    sunLight: THREE.DirectionalLight | null;\n    ambientLight: THREE.HemisphereLight | null;\n    config: typeof LIGHTING_CONFIG;\n\n    constructor(scene: THREE.Scene, renderer: RendererType, camera: THREE.Camera) {\n        this.scene = scene;\n        this.renderer = renderer;\n        this.camera = camera;\n        \n        // Light components\n        this.sunLight = null;\n        this.ambientLight = null;\n        \n        // Use centralized configuration\n        this.config = LIGHTING_CONFIG;\n    }\n\n    setupLighting(): void {\n        // Configure renderer for physically correct lighting\n        if ('shadowMap' in this.renderer) {\n            this.renderer.shadowMap.enabled = this.config.shadows.enabled;\n            this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n            if ('autoUpdate' in this.renderer.shadowMap) {\n                (this.renderer.shadowMap as any).autoUpdate = this.config.performance.shadowMapAutoUpdate;\n            }\n        }\n        \n        // Map string type to THREE constant\n        if ('toneMapping' in this.renderer) {\n            if (this.config.toneMapping.type === 'ACESFilmic') {\n                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;\n            }\n            \n            this.renderer.toneMappingExposure = this.config.toneMapping.exposure;\n            this.renderer.outputColorSpace = THREE.SRGBColorSpace;\n        }\n\n        // Create main sun directional light\n        this.sunLight = new THREE.DirectionalLight(\n            this.config.sun.color,\n            this.config.sun.intensity\n        );\n\n        // Position sun light to come from behind the sun toward scene\n        this.sunLight.position.set(\n            this.config.sun.position.x, \n            this.config.sun.position.y, \n            this.config.sun.position.z\n        );\n        this.sunLight.target.position.set(0, 0, 0);\n\n        // Configure shadows\n        this.sunLight.castShadow = this.config.shadows.enabled;\n        this.sunLight.shadow.mapSize.width = this.config.shadows.mapSize;\n        this.sunLight.shadow.mapSize.height = this.config.shadows.mapSize;\n\n        // Shadow camera setup\n        const d = this.config.shadows.frustumSize;\n        this.sunLight.shadow.camera.left = -d;\n        this.sunLight.shadow.camera.right = d;\n        this.sunLight.shadow.camera.top = d;\n        this.sunLight.shadow.camera.bottom = -d;\n        this.sunLight.shadow.camera.near = this.config.shadows.near;\n        this.sunLight.shadow.camera.far = this.config.shadows.far;\n\n        this.sunLight.shadow.bias = this.config.shadows.bias;\n        this.sunLight.shadow.normalBias = this.config.shadows.normalBias;\n        this.sunLight.shadow.radius = this.config.shadows.radius;\n        if ('blurSamples' in this.sunLight.shadow) {\n            (this.sunLight.shadow as any).blurSamples = this.config.shadows.blurSamples;\n        }\n\n        this.scene.add(this.sunLight);\n        this.scene.add(this.sunLight.target);\n\n        // Add subtle ambient light\n        this.ambientLight = new THREE.HemisphereLight(\n            this.config.ambient.skyColor,\n            this.config.ambient.groundColor,\n            this.config.ambient.intensity\n        );\n        this.scene.add(this.ambientLight);\n\n        console.log(\"Lighting setup complete using centralized LIGHTING_CONFIG\");\n    }\n    \n    /**\n     * Update sun light direction based on sun position\n     * Keep the directional light stable in world space\n     */\n    updateSunPosition(sunWorldPosition: THREE.Vector3): void {\n        if (!this.sunLight) return;\n\n        // The sun's directional light should maintain a fixed direction\n        // relative to the sun, simulating the sun's rays coming from a direction.\n        // We keep it at a fixed position and pointed at the sun.\n\n        // This creates proper shadows for objects around the sun\n        // The position is maintained, only the target follows the sun\n        this.sunLight.target.position.copy(sunWorldPosition);\n        this.sunLight.target.updateMatrixWorld();\n    }\n    \n    /**\n     * Adjust lighting intensity\n     */\n    adjustLightingIntensity(factor: number = 1.0): void {\n        const clampedFactor = THREE.MathUtils.clamp(factor, 0.5, 2.0);\n        \n        if (this.sunLight) {\n            this.sunLight.intensity = this.config.sun.intensity * clampedFactor;\n        }\n    }\n    \n    /**\n     * Update exposure based on camera position\n     */\n    updateExposure(_cameraPosition: THREE.Vector3): void {\n        // Keep exposure relatively constant\n        if ('toneMappingExposure' in this.renderer) {\n            this.renderer.toneMappingExposure = this.config.toneMapping.exposure;\n        }\n    }\n    \n    /**\n     * Adjust for volumetric ray type (backward compatibility)\n     */\n    adjustLightingForRayType(_useClaudeRays: boolean): void {\n        // Keep lighting consistent\n        if (this.ambientLight) {\n            this.ambientLight.intensity = this.config.ambient.intensity;\n        }\n    }\n    \n    /**\n     * Set shadow quality\n     */\n    setShadowQuality(quality: 'low' | 'medium' | 'high' | 'ultra'): void {\n        const sizes: Record<string, number> = {\n            low: 2048,\n            medium: 4096,\n            high: 8192,\n            ultra: 16384\n        };\n        \n        const size = sizes[quality] || 4096;\n        \n        if (this.sunLight && this.sunLight.shadow) {\n            this.sunLight.shadow.mapSize.width = size;\n            this.sunLight.shadow.mapSize.height = size;\n            \n            if (this.sunLight.shadow.map) {\n                this.sunLight.shadow.map.dispose();\n                this.sunLight.shadow.map = null;\n            }\n        }\n    }\n    \n    /**\n     * Handle window resize\n     */\n    handleResize(): void {\n        // Handled by post-processing manager\n    }\n    \n    dispose(): void {\n        // Dispose shadows\n        if (this.sunLight && this.sunLight.shadow && this.sunLight.shadow.map) {\n            this.sunLight.shadow.map.dispose();\n        }\n        \n        // Remove lights from scene\n        [this.sunLight, this.ambientLight].forEach(light => {\n            if (light) {\n                if ('target' in light && light.target) {\n                    this.scene.remove(light.target);\n                }\n                this.scene.remove(light);\n            }\n        });\n    }\n}\n","// shaders.ts - Custom shaders for volumetric lighting effects\n//\n// NOTE: These shaders use GLSL via ShaderPass (not TSL) because:\n// - ShaderPass expects raw GLSL/WGSL strings, not TSL nodes\n// - TSL post-processing (Three.js 2026+) requires a different architecture:\n//   * TSL material nodes work on mesh materials, not screen-space effects\n//   * Custom TSL post-processing requires NodePostProcessing (experimental)\n//   * Converting would require rewriting PostProcessingManager to use TSL functions\n// - For now, GLSL ShaderPass is the standard approach in r180\n//\n// TODO (Phase 4): Migrate to TSL post-processing when:\n// 1. NodePostProcessing stabilizes in Three.js\n// 2. Custom TSL post-processing passes are documented\n// 3. We refactor PostProcessingManager to use pass() and TSL nodes\n\nimport * as THREE from 'three';\nimport { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';\n\ninterface GodRayShaderUniforms {\n    tDiffuse: { value: THREE.Texture | null };\n    lightPosition: { value: THREE.Vector2 };\n    intensity: { value: number };\n    decay: { value: number };\n    density: { value: number };\n    weight: { value: number };\n    samples: { value: number };\n    sunColor: { value: THREE.Color };\n    sunDistance: { value: number };\n    sunVisibility: { value: number };\n    scattering: { value: number };\n    attenuationMultiplier: { value: number };\n}\n\ninterface ClaudeRayShaderUniforms {\n    tDiffuse: { value: THREE.Texture | null };\n    lightPosition: { value: THREE.Vector2 };\n    exposure: { value: number };\n    decay: { value: number };\n    density: { value: number };\n    weight: { value: number };\n    lightColor: { value: THREE.Color };\n}\n\n/**\n * Create a volumetric light shader for realistic god ray effects\n * @returns Shader pass for new volumetric lighting\n */\nexport function createVolumetricLightShader(): ShaderPass {\n    // New improved volumetric light ray shader\n    const godRayShader: {\n        uniforms: GodRayShaderUniforms;\n        vertexShader: string;\n        fragmentShader: string;\n    } = {\n        uniforms: {\n            tDiffuse: { value: null },\n            lightPosition: { value: new THREE.Vector2(0.5, 0.5) },\n            intensity: { value: 0.45 },         // Increased from 0.3\n            decay: { value: 0.94 },             // Adjusted from 0.95 for better distance\n            density: { value: 0.6 },            // Increased from 0.5\n            weight: { value: 0.5 },             // Increased from 0.4\n            samples: { value: 100 },            // Sample count - higher = better quality but slower\n            sunColor: { value: new THREE.Color(0xFFFAF0) },   // Sun color\n            sunDistance: { value: 0.5 },        // Distance to sun (0-1 normalized)\n            sunVisibility: { value: 1.0 },      // Whether sun is in front of camera (0-1)\n            scattering: { value: 0.4 },         // Increased from 0.3\n            attenuationMultiplier: { value: 3.5 } // Reduced from 5.0 to allow rays to travel further\n        },\n        \n        vertexShader: `\n            varying vec2 vUv;\n            \n            void main() {\n                vUv = uv;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n        `,\n        \n        fragmentShader: `\n            precision highp float;\n            \n            varying vec2 vUv;\n            uniform sampler2D tDiffuse;\n            uniform vec2 lightPosition;\n            uniform float intensity;\n            uniform float decay;\n            uniform float density;\n            uniform float weight;\n            uniform int samples;\n            uniform vec3 sunColor;\n            uniform float sunDistance;\n            uniform float sunVisibility;\n            uniform float scattering;\n            uniform float attenuationMultiplier;\n            \n            const int MAX_SAMPLES = 150;\n            \n            float illuminationDecay(float rayProgress, float dist) {\n                // rayProgress: 0.0 to a1.0 (how far along the ray)\n                // dist: normalized distance to sun (0 = close, 1 = far)\n                \n                // Base decay from exponential falloff\n                float baseFalloff = pow(decay, rayProgress * 100.0);\n                \n                // More decay the further the sun is \n                float distanceAttenuation = 1.0 - (dist * dist * attenuationMultiplier);\n                distanceAttenuation = max(0.0, distanceAttenuation);\n                \n                // Apply visibility factor\n                float visibilityFactor = sunVisibility;\n                \n                return baseFalloff * distanceAttenuation * visibilityFactor;\n            }\n            \n            void main() {\n                // Get the texture color (original scene)\n                vec4 sceneColor = texture2D(tDiffuse, vUv);\n                \n                // Calculate ray direction from pixel to light source\n                vec2 rayVector = (vUv - lightPosition);\n                float rayLength = length(rayVector);\n                vec2 rayDirection = normalize(rayVector);\n                \n                // Skip calculation if ray is too long (reduces artifacts far from sun)\n                if (rayLength > 1.0) {\n                    gl_FragColor = sceneColor;\n                    return;\n                }\n                \n                // Angle factor (rays stronger when looking near sun)\n                float angleFactor = 1.0 - rayLength;\n                angleFactor = pow(angleFactor, 0.8); // Adjust the power for ray spread\n                \n                // Calculate ray sampling parameters\n                vec2 sampleStep = -rayDirection * min(density, 1.0) / float(samples);\n                \n                // Use a tighter sampling box around the light source\n                // This creates more defined rays and reduces artifacts\n                float rayProgress = max(0.0, (1.0 - rayLength * 2.0)); // Start closer to light source\n                vec2 samplePosition = vUv - sampleStep * rayProgress * 10.0; // Start closer to current position\n                \n                // Clamp sample count for performance\n                int sampleCount = min(samples, MAX_SAMPLES);\n                \n                // Start with current scene color\n                vec4 finalColor = sceneColor;\n                \n                // Calculate scattering factor based on distance and angle\n                float scatterFactor = scattering * angleFactor * (1.0 - sunDistance * 0.5);\n                \n                // Sample the light path\n                // Use a fixed loop to avoid gradient instruction warnings\n                for (int i = 0; i < MAX_SAMPLES; i++) {\n                    // Early exit condition without break (to avoid varying iteration)\n                    float shouldSample = step(float(i), float(sampleCount) - 0.5);\n                    \n                    // Move along the ray\n                    samplePosition += sampleStep;\n                    \n                    // Sample at the current position\n                    // Note: texture2D in a loop with uniform iteration is fine\n                    vec4 sampledColor = texture2D(tDiffuse, samplePosition);\n                    \n                    // Calculate illumination decay factor\n                    float decayFactor = illuminationDecay(float(i) / float(sampleCount), sunDistance);\n                    \n                    // Create the ray sample with attenuation\n                    vec4 raySample = sampledColor * decayFactor * weight * shouldSample;\n                    \n                    // Apply sun color to the ray (tinted by scene color)\n                    raySample.rgb *= mix(sunColor, sampledColor.rgb, 0.3);\n                    \n                    // Apply scattering effect - brightens areas around sun\n                    float scatterAmount = step(float(i), float(sampleCount) / 3.0 - 0.5);\n                    raySample.rgb += sunColor * scatterFactor * decayFactor * 0.2 * \n                                     (1.0 - float(i) / max(float(sampleCount) / 3.0, 1.0)) * scatterAmount * shouldSample;\n                    \n                    // Add to accumulated color\n                    finalColor += raySample;\n                }\n                \n                // Apply master intensity factor\n                finalColor *= mix(1.0, intensity, sunVisibility);\n                \n                // Preserve original scene color with a blend factor\n                finalColor = mix(sceneColor, finalColor, min(0.95, intensity * sunVisibility));\n                \n                gl_FragColor = finalColor;\n            }\n        `\n    };\n    \n    // Create and return a shader pass\n    const shaderPass = new ShaderPass(godRayShader);\n    shaderPass.renderToScreen = false;\n    \n    return shaderPass;\n}\n\n/**\n * Create the original \"Claude Ray\" shader (the original implementation renamed)\n * @returns Shader pass for the original effect\n */\nexport function createClaudeRayShader(): ShaderPass {\n    // Original volumetric light ray shader (renamed to Claude Rays)\n    const claudeRayShader: {\n        uniforms: ClaudeRayShaderUniforms;\n        vertexShader: string;\n        fragmentShader: string;\n    } = {\n        uniforms: {\n            tDiffuse: { value: null },\n            lightPosition: { value: new THREE.Vector2(0.5, 0.5) },\n            exposure: { value: 0.4 },    // Reduced from 0.6\n            decay: { value: 0.93 },\n            density: { value: 0.8 },     // Reduced from 0.96\n            weight: { value: 0.25 },     // Reduced from 0.4\n            lightColor: { value: new THREE.Color(0xFFFAF0) }  // Matches sun directional light\n        },\n        vertexShader: `\n            varying vec2 vUv;\n            void main() {\n                vUv = uv;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n        `,\n        fragmentShader: `\n            precision highp float;\n            \n            varying vec2 vUv;\n            uniform sampler2D tDiffuse;\n            uniform vec2 lightPosition;\n            uniform float exposure;\n            uniform float decay;\n            uniform float density;\n            uniform float weight;\n            uniform vec3 lightColor;\n            \n            const int NUM_SAMPLES = 24; // Reduced from 30 for better balance of quality and performance\n            \n            void main() {\n                // Get the texture color\n                vec4 color = texture2D(tDiffuse, vUv);\n                \n                // Ray direction\n                vec2 texCoord = vUv;\n                vec2 deltaTextCoord = (texCoord - lightPosition) * density / float(NUM_SAMPLES);\n                \n                // Start illumination decay at 1.0\n                float illuminationDecay = 1.0;\n                \n                // Sample the light path with a fixed number of steps\n                for(int i = 0; i < NUM_SAMPLES; i++) {\n                    // Move along the ray\n                    texCoord -= deltaTextCoord;\n                    \n                    // Sample at the current position\n                    vec4 sampleColor = texture2D(tDiffuse, texCoord);\n                    \n                    // Apply decay and weight\n                    sampleColor *= illuminationDecay * weight;\n                    \n                    // Apply light color\n                    sampleColor.rgb *= lightColor;\n                    \n                    // Add to the final color\n                    color += sampleColor;\n                    \n                    // Reduce illumination for the next sample\n                    illuminationDecay *= decay;\n                }\n                \n                // Apply exposure\n                color *= exposure;\n                \n                // Output the final color\n                gl_FragColor = color;\n            }\n        `\n    };\n    \n    // Create and return a shader pass\n    const shaderPass = new ShaderPass(claudeRayShader);\n    shaderPass.renderToScreen = false;\n    \n    return shaderPass;\n}\n","// post.ts - Post-processing effects management\n\nimport * as THREE from 'three';\nimport type { WebGPURenderer } from 'three/webgpu';\nimport { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';\nimport { RenderPass } from 'three/addons/postprocessing/RenderPass.js';\nimport { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';\nimport { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';\nimport { FXAAShader } from 'three/addons/shaders/FXAAShader.js';\nimport { ColorCorrectionShader } from 'three/addons/shaders/ColorCorrectionShader.js';\nimport { FilmShader } from 'three/addons/shaders/FilmShader.js';\nimport { VignetteShader } from 'three/addons/shaders/VignetteShader.js';\nimport { createVolumetricLightShader, createClaudeRayShader } from './shaders';\n\ntype RendererType = THREE.WebGLRenderer | WebGPURenderer;\n\nexport class PostProcessingManager {\n    renderer: RendererType;\n    scene: THREE.Scene;\n    camera: THREE.Camera;\n    composer: EffectComposer | null;\n    bloomPass: UnrealBloomPass | null;\n    filmPass: ShaderPass | null;\n    colorCorrectionPass: ShaderPass | null;\n    vignettePass: ShaderPass | null;\n    claudeRayPass: ShaderPass | null;\n    godRayPass: ShaderPass | null;\n    useBasicRendering: boolean;\n    volumetricLightEnabled: boolean;\n    useClaudeRays: boolean;\n\n    constructor(renderer: RendererType, scene: THREE.Scene, camera: THREE.Camera) {\n        this.renderer = renderer;\n        this.scene = scene;\n        this.camera = camera;\n        this.composer = null;\n        this.bloomPass = null;\n        this.filmPass = null;\n        this.colorCorrectionPass = null;\n        this.vignettePass = null;\n        this.claudeRayPass = null;\n        this.godRayPass = null;\n        this.useBasicRendering = false;\n        \n        // Volumetric lighting settings\n        this.volumetricLightEnabled = true;\n        this.useClaudeRays = false;\n    }\n\n    setupPostProcessing(): void {\n        try {\n            // Create a composer for post-processing effects\n            this.composer = new EffectComposer(this.renderer);\n            \n            // Add the render pass\n            const renderPass = new RenderPass(this.scene, this.camera);\n            this.composer.addPass(renderPass);\n            \n            // Add godray effect based on settings\n            this.setupGodRayEffects();\n            \n            this.setupBloomPass();\n            this.setupFXAAPass();\n            this.setupColorCorrectionPass();\n            this.setupFilmPass();\n            this.setupVignettePass();\n            \n            console.log(\"Post-processing setup complete\");\n        } catch (error) {\n            console.error(\"Error setting up post-processing:\", error);\n            console.log(\"Continuing with basic rendering without post-processing\");\n            // Set a flag to use basic rendering instead\n            this.useBasicRendering = true;\n        }\n    }\n\n    setupBloomPass(): void {\n        try {\n            // Add bloom effect for sun, engines, etc.\n            this.bloomPass = new UnrealBloomPass(\n                new THREE.Vector2(window.innerWidth, window.innerHeight),\n                0.2,    // strength (further reduced from 0.3)\n                0.2,    // radius (further reduced from 0.3)\n                0.95    // threshold (further increased from 0.9 to only affect the very brightest parts)\n            );\n            this.composer!.addPass(this.bloomPass);\n        } catch (error) {\n            console.warn(\"Error setting up UnrealBloomPass:\", error);\n        }\n    }\n\n    setupFXAAPass(): void {\n        try {\n            // Add FXAA for edge aliasing\n            const fxaaPass = new ShaderPass(FXAAShader);\n            if (fxaaPass.material && fxaaPass.material.uniforms && fxaaPass.material.uniforms.resolution) {\n                const pixelRatio = 'getPixelRatio' in this.renderer ? this.renderer.getPixelRatio() : 1;\n                fxaaPass.material.uniforms.resolution.value.x = 1 / (window.innerWidth * pixelRatio);\n                fxaaPass.material.uniforms.resolution.value.y = 1 / (window.innerHeight * pixelRatio);\n                this.composer!.addPass(fxaaPass);\n            } else {\n                console.warn(\"FXAAShader uniforms not as expected, skipping pass\");\n            }\n        } catch (error) {\n            console.warn(\"Error setting up FXAAShader:\", error);\n        }\n    }\n\n    setupColorCorrectionPass(): void {\n        try {\n            // Add color correction effects\n            this.colorCorrectionPass = new ShaderPass(ColorCorrectionShader);\n            if (this.colorCorrectionPass.uniforms && this.colorCorrectionPass.uniforms.powRGB && this.colorCorrectionPass.uniforms.mulRGB) {\n                this.colorCorrectionPass.uniforms.powRGB.value = new THREE.Vector3(1.1, 1.1, 1.2); // Slightly blue tint\n                this.colorCorrectionPass.uniforms.mulRGB.value = new THREE.Vector3(1.2, 1.1, 1.0); // Warmer highlights\n                this.composer!.addPass(this.colorCorrectionPass);\n            } else {\n                console.warn(\"ColorCorrectionShader uniforms not as expected, skipping pass\");\n            }\n        } catch (error) {\n            console.warn(\"Error setting up ColorCorrectionShader:\", error);\n        }\n    }\n\n    setupFilmPass(): void {\n        try {\n            // Add CRT/film effect with static scanlines\n            this.filmPass = new ShaderPass(FilmShader);\n            if (this.filmPass.uniforms && this.filmPass.uniforms.nIntensity && \n                this.filmPass.uniforms.sIntensity && this.filmPass.uniforms.grayscale) {\n                this.filmPass.uniforms.nIntensity.value = 0.08; // Reduced noise for subtle grain\n                this.filmPass.uniforms.sIntensity.value = 0.03; // Static CRT scanlines\n                this.filmPass.uniforms.grayscale.value = 0; // Keep color\n                this.composer!.addPass(this.filmPass);\n            } else {\n                console.warn(\"FilmShader uniforms not as expected, skipping pass\");\n            }\n        } catch (error) {\n            console.warn(\"Error setting up FilmShader:\", error);\n        }\n    }\n\n    setupVignettePass(): void {\n        try {\n            // Add vignette effect\n            this.vignettePass = new ShaderPass(VignetteShader);\n            if (this.vignettePass.uniforms && this.vignettePass.uniforms.offset && this.vignettePass.uniforms.darkness) {\n                this.vignettePass.uniforms.offset.value = 0.95;\n                this.vignettePass.uniforms.darkness.value = 1.6;\n                this.composer!.addPass(this.vignettePass);\n            } else {\n                console.warn(\"VignetteShader uniforms not as expected, skipping pass\");\n            }\n        } catch (error) {\n            console.warn(\"Error setting up VignetteShader:\", error);\n        }\n    }\n\n    /**\n     * Setup for volumetric lighting (god rays) effects\n     * Handles both the new realistic godray effect and the original \"Claude Rays\"\n     */\n    setupGodRayEffects(): void {\n        try {\n            // Initialize flags for volumetric lighting effects\n            this.volumetricLightEnabled = true;     // Master toggle for any god ray effect\n            this.useClaudeRays = false;             // Toggle between new godRays (false) and Claude Rays (true)\n            \n            // Create the original \"Claude Rays\" effect (disabled by default)\n            this.claudeRayPass = createClaudeRayShader();\n            this.claudeRayPass.enabled = this.volumetricLightEnabled && this.useClaudeRays;\n            this.composer!.addPass(this.claudeRayPass);\n            console.log(\"Claude Rays effect created (disabled by default)\");\n            \n            // Create the new improved volumetric lighting effect\n            this.godRayPass = createVolumetricLightShader();\n            this.godRayPass.enabled = this.volumetricLightEnabled && !this.useClaudeRays;\n            this.composer!.addPass(this.godRayPass);\n            console.log(\"New volumetric light ray effect added to post-processing chain\");\n        } catch (error) {\n            console.warn(\"Error setting up volumetric light shaders:\", error);\n        }\n    }\n\n    // Allow dynamic adjustment of post-processing settings\n    adjustBloom(strength?: number, radius?: number, threshold?: number): void {\n        if (this.bloomPass) {\n            this.bloomPass.strength = strength !== undefined ? strength : this.bloomPass.strength;\n            this.bloomPass.radius = radius !== undefined ? radius : this.bloomPass.radius;\n            this.bloomPass.threshold = threshold !== undefined ? threshold : this.bloomPass.threshold;\n        }\n    }\n\n    // Update for dynamic visual effects\n    update(deltaTime: number): void {\n        // Update film grain with time for animation\n        if (this.filmPass && this.filmPass.uniforms && this.filmPass.uniforms.time && this.filmPass.uniforms.time.value !== undefined) {\n            try {\n                this.filmPass.uniforms.time.value += deltaTime;\n            } catch (error) {\n                console.warn(\"Error updating film pass time:\", error);\n            }\n        }\n    }\n\n    handleResize(): void {\n        // Update composer size if it exists\n        if (this.composer) {\n            this.composer.setSize(window.innerWidth, window.innerHeight);\n        \n            // Update FXAA resolution\n            try {\n                const pixelRatio = 'getPixelRatio' in this.renderer ? this.renderer.getPixelRatio() : 1;\n                const fxaaPass = this.composer.passes.find(pass =>\n                    (pass as any).material &&\n                    (pass as any).material.uniforms &&\n                    (pass as any).material.uniforms.resolution &&\n                    (pass as any).material.uniforms.resolution.value\n                );\n\n                if (fxaaPass) {\n                    (fxaaPass as any).material.uniforms.resolution.value.x = 1 / (window.innerWidth * pixelRatio);\n                    (fxaaPass as any).material.uniforms.resolution.value.y = 1 / (window.innerHeight * pixelRatio);\n                }\n            } catch (error) {\n                console.warn(\"Error updating FXAA resolution:\", error);\n            }\n        }\n    }\n\n    render(): void {\n        if (this.composer && !this.useBasicRendering) {\n            this.composer.render();\n        } else {\n            this.renderer.render(this.scene, this.camera);\n        }\n    }\n\n    dispose(): void {\n        // Dispose of post-processing\n        if (this.composer) {\n            this.composer.passes.forEach(pass => {\n                if ('dispose' in pass && typeof (pass as any).dispose === 'function') {\n                    (pass as any).dispose();\n                }\n                if ('material' in pass && (pass as any).material) {\n                    (pass as any).material.dispose();\n                }\n            });\n        }\n    }\n}\n","// sceneApi.ts - Scene manipulation helpers including _withGuard system\n\nimport * as THREE from 'three';\n\ninterface ViewDef {\n    [key: string]: any;\n}\n\ninterface ECSWorld {\n    entityManager?: any;\n    getEntitiesWithComponents?: (components: string[]) => any[];\n}\n\ninterface ECSMeshComponent {\n    mesh?: THREE.Object3D;\n}\n\ninterface ECSTransformComponent {\n    position: THREE.Vector3;\n    prevPosition: THREE.Vector3;\n    quaternion: THREE.Quaternion;\n    prevQuaternion: THREE.Quaternion;\n}\n\ninterface ECSEntity {\n    getComponent: (name: string) => ECSMeshComponent | ECSTransformComponent | null;\n}\n\ninterface SceneWithECS extends THREE.Scene {\n    ecsWorld?: ECSWorld;\n}\n\nexport class SceneApiManager {\n    scene: THREE.Scene;\n\n    constructor(scene: THREE.Scene) {\n        this.scene = scene;\n        this.setupSceneGuard();\n    }\n\n    setupSceneGuard(): void {\n        // Renderer facade guard\n        if (typeof window !== 'undefined') {\n            (window as any).__rendererGuard = false;\n        }\n\n        // Wrap scene add/remove to warn on direct mutations\n        const originalAdd = this.scene.add.bind(this.scene);\n        const originalRemove = this.scene.remove.bind(this.scene);\n        \n        this.scene.add = (...args: THREE.Object3D[]): THREE.Scene => {\n            if (!(window as any).__rendererGuard && window && (window as any).DEBUG_MODE) {\n                console.warn('[RendererFacade] Direct scene.add detected outside renderer facade');\n            }\n            return originalAdd(...args);\n        };\n        \n        this.scene.remove = (...args: THREE.Object3D[]): THREE.Scene => {\n            if (!(window as any).__rendererGuard && window && (window as any).DEBUG_MODE) {\n                console.warn('[RendererFacade] Direct scene.remove detected outside renderer facade');\n            }\n            return originalRemove(...args);\n        };\n    }\n\n    // Add an object to the scene through guarded path\n    add(object: THREE.Object3D): void {\n        this._withGuard(() => this.scene.add(object));\n    }\n\n    // Facade API for views\n    addView(_entityId: number, _viewDef: ViewDef): void {\n        // For future: create mesh/instanced entry based on viewDef\n        // Placeholder; current rendering handled by systems\n    }\n\n    removeView(_entityId: number): void {\n        // Placeholder for centralized removal\n    }\n\n    updateView(_entityId: number, _props: any): void {\n        // Placeholder for centralized updates\n    }\n\n    _withGuard<T>(fn: () => T): T {\n        const prev = (window as any).__rendererGuard;\n        (window as any).__rendererGuard = true;\n        try { \n            return fn(); \n        } finally { \n            (window as any).__rendererGuard = prev; \n        }\n    }\n\n    /**\n     * Helper method to find the sun object in the scene\n     * @returns The sun object or null if not found\n     */\n    findSunObject(): THREE.Object3D | null {\n        let sun: THREE.Object3D | null = null;\n\n        // First try by name\n        sun = this.scene.getObjectByName('sun') ?? null;\n\n        // If not found by name, try to find by traversing scene\n        if (!sun) {\n            this.scene.traverse(object => {\n                if (object.name === 'sun') {\n                    sun = object;\n                }\n            });\n        }\n\n        return sun;\n    }\n\n    // Interpolate ECS meshes before compositing\n    interpolateMeshes(alpha: number): void {\n        // If ECS world present on scene, interpolate known meshes\n        const sceneWithECS = this.scene as SceneWithECS;\n        const world = sceneWithECS.ecsWorld;\n        if (!world || !world.entityManager) return;\n        \n        try {\n            if (!world.getEntitiesWithComponents) return;\n            const entities = world.getEntitiesWithComponents(['TransformComponent', 'MeshComponent']) as ECSEntity[];\n            for (const entity of entities) {\n                const t = entity.getComponent('TransformComponent') as ECSTransformComponent | null;\n                const m = entity.getComponent('MeshComponent') as ECSMeshComponent | null;\n                if (!t || !m || !m.mesh) continue;\n                \n                // slerp rotation\n                const q = new THREE.Quaternion().copy(t.prevQuaternion).slerp(t.quaternion, alpha);\n                // lerp position\n                const p = new THREE.Vector3().copy(t.prevPosition).lerp(t.position, alpha);\n                m.mesh.position.copy(p);\n                m.mesh.quaternion.copy(q);\n            }\n        } catch {}\n    }\n}\n","// helpers.ts - Utility functions and instanced mesh management\n\nimport * as THREE from 'three';\nimport type { WebGPURenderer } from 'three/webgpu';\n\ninterface InstanceData {\n    mesh: THREE.InstancedMesh;\n    count: number;\n    maxCount: number;\n    dummy: THREE.Object3D;\n}\n\ntype RendererType = THREE.WebGLRenderer | WebGPURenderer;\n\nexport class RenderHelpers {\n    scene: THREE.Scene;\n    instancedMeshes: Map<string, InstanceData>;\n    _frameDrawCalls: number;\n    _frameVisibleInstances: number;\n    renderAlpha: number;\n\n    constructor(scene: THREE.Scene) {\n        this.scene = scene;\n        this.instancedMeshes = new Map();\n        \n        // Performance counters\n        this._frameDrawCalls = 0;\n        this._frameVisibleInstances = 0;\n        this.renderAlpha = 0;\n    }\n\n    /**\n     * Create an instanced mesh for efficient rendering of many similar objects\n     * @param key Unique identifier for this instanced mesh type\n     * @param geometry The geometry to instance\n     * @param material The material to use\n     * @param maxCount Maximum number of instances\n     * @returns The created instanced mesh\n     */\n    createInstancedMesh(\n        key: string,\n        geometry: THREE.BufferGeometry,\n        material: THREE.Material,\n        maxCount: number\n    ): THREE.InstancedMesh {\n        const instancedMesh = new THREE.InstancedMesh(geometry, material, maxCount);\n        instancedMesh.count = 0; // Start with 0 visible instances\n        instancedMesh.frustumCulled = true;\n        this.scene.add(instancedMesh);\n        \n        this.instancedMeshes.set(key, {\n            mesh: instancedMesh,\n            count: 0,\n            maxCount: maxCount,\n            dummy: new THREE.Object3D() // Reusable temporary Object3D for matrix calculations\n        });\n        \n        return instancedMesh;\n    }\n    \n    /**\n     * Add or update an instance in an instanced mesh\n     * @param key The instanced mesh identifier\n     * @param index Index of the instance to update (or next available)\n     * @param position Position of the instance\n     * @param quaternion Rotation of the instance\n     * @param scale Scale of the instance\n     * @returns The index of the instance\n     */\n    updateInstance(\n        key: string,\n        index: number | undefined,\n        position: THREE.Vector3,\n        quaternion: THREE.Quaternion | null,\n        scale: THREE.Vector3 | null\n    ): number {\n        const instance = this.instancedMeshes.get(key);\n        if (!instance) return -1;\n        \n        // Determine index to use\n        const idx = (index !== undefined) ? index : instance.count;\n        \n        // If we're adding a new instance, increment the count\n        if (idx >= instance.count) {\n            if (idx >= instance.maxCount) return -1; // Can't exceed max count\n            instance.count = idx + 1;\n        }\n        \n        // Update matrix using dummy object\n        instance.dummy.position.copy(position);\n        if (quaternion) instance.dummy.quaternion.copy(quaternion);\n        if (scale) instance.dummy.scale.copy(scale);\n        instance.dummy.updateMatrix();\n        \n        // Apply to instanced mesh\n        instance.mesh.setMatrixAt(idx, instance.dummy.matrix);\n        instance.mesh.instanceMatrix.needsUpdate = true;\n        \n        return idx;\n    }\n    \n    /**\n     * Update instanced meshes\n     */\n    updateInstancedMeshes(): void {\n        for (const [, instance] of this.instancedMeshes.entries()) {\n            if (instance.mesh.instanceMatrix.needsUpdate) {\n                instance.mesh.instanceMatrix.needsUpdate = false;\n            }\n        }\n    }\n    \n    /**\n     * Remove an instance from an instanced mesh\n     * @param key The instanced mesh identifier\n     * @param index Index of the instance to remove\n     */\n    removeInstance(key: string, index: number): void {\n        const instance = this.instancedMeshes.get(key);\n        if (!instance || index >= instance.count) return;\n        \n        // Move the last instance to this slot if it's not the last one\n        if (index < instance.count - 1) {\n            // Get the matrix of the last instance\n            const matrix = new THREE.Matrix4();\n            instance.mesh.getMatrixAt(instance.count - 1, matrix);\n            \n            // Set it at the removed index\n            instance.mesh.setMatrixAt(index, matrix);\n        }\n        \n        // Decrease count\n        instance.count--;\n        instance.mesh.count = instance.count;\n        instance.mesh.instanceMatrix.needsUpdate = true;\n    }\n\n    /**\n     * Update performance counters and render stats\n     */\n    updatePerformanceCounters(renderer: RendererType): number {\n        // reset counters\n        this._frameDrawCalls = 0;\n        this._frameVisibleInstances = 0;\n\n        // count visible instances from instancedMeshes map\n        try {\n            for (const [, inst] of this.instancedMeshes) {\n                if (inst && inst.mesh) {\n                    this._frameVisibleInstances += inst.mesh.count || 0;\n                }\n            }\n        } catch {}\n\n        // track render start\n        const ctx = renderer.info;\n        const startCalls = ctx.render.calls;\n        \n        return startCalls;\n    }\n\n    /**\n     * Finalize performance counters after rendering\n     */\n    finalizePerformanceCounters(renderer: RendererType, startCalls: number): void {\n        const endCalls = renderer.info.render.calls;\n        this._frameDrawCalls = Math.max(0, endCalls - startCalls);\n\n        if ((window as any).__perf) {\n            (window as any).__perf.drawCalls = endCalls; // total since reset\n            (window as any).__perf.visibleInstances = this._frameVisibleInstances;\n        }\n    }\n\n    /**\n     * Properly dispose of Three.js resources to prevent memory leaks\n     */\n    dispose(): void {\n        console.log(\"Disposing instanced meshes...\");\n        \n        // Dispose of instanced meshes\n        this.instancedMeshes.forEach(instance => {\n            if (instance.mesh) {\n                if (instance.mesh.geometry) instance.mesh.geometry.dispose();\n                if (instance.mesh.material) {\n                    if (Array.isArray(instance.mesh.material)) {\n                        instance.mesh.material.forEach(material => material.dispose());\n                    } else {\n                        instance.mesh.material.dispose();\n                    }\n                }\n                this.scene.remove(instance.mesh);\n            }\n        });\n        \n        this.instancedMeshes.clear();\n    }\n\n    /**\n     * Helper method to dispose of materials and their textures\n     * @param material The material to dispose\n     */\n    disposeMaterial(material: THREE.Material): void {\n        // Dispose textures\n        for (const propertyName in material) {\n            const property = (material as any)[propertyName];\n            if (property && property.isTexture) {\n                property.dispose();\n            }\n        }\n        \n        // Dispose the material itself\n        material.dispose();\n    }\n}\n","// volumetricLighting.ts - Handles volumetric lighting effects and light position updates\n\nimport * as THREE from 'three';\nimport { PostProcessingManager } from './post.js';\nimport { SceneApiManager } from './sceneApi.js';\n\ninterface VolumetricLightParams {\n    intensity?: number;\n    decay?: number;\n    density?: number;\n    weight?: number;\n    samples?: number;\n    sunColor?: number | string | THREE.Color;\n    scattering?: number;\n    attenuationMultiplier?: number;\n}\n\ninterface ClaudeRayParams {\n    exposure?: number;\n    decay?: number;\n    density?: number;\n    weight?: number;\n    lightColor?: number | string | THREE.Color;\n}\n\nexport class VolumetricLightingManager {\n    postProcessingManager: PostProcessingManager;\n    sceneApiManager: SceneApiManager;\n    camera: THREE.Camera;\n\n    constructor(\n        postProcessingManager: PostProcessingManager,\n        sceneApiManager: SceneApiManager,\n        camera: THREE.Camera\n    ) {\n        this.postProcessingManager = postProcessingManager;\n        this.sceneApiManager = sceneApiManager;\n        this.camera = camera;\n    }\n\n    /**\n     * Update volumetric light ray position if sun is present\n     */\n    update(): void {\n        if (this.postProcessingManager.volumetricLightEnabled) {\n            if (this.postProcessingManager.useClaudeRays) {\n                this.updateClaudeRayPosition();\n            } else {\n                this.updateVolumetricLightPosition();\n            }\n        }\n    }\n\n    /**\n     * Update the light position for Claude Rays\n     */\n    updateClaudeRayPosition(): void {\n        try {\n            // Ensure we have the required objects\n            if (!this.postProcessingManager.claudeRayPass || !this.postProcessingManager.claudeRayPass.uniforms || !this.postProcessingManager.claudeRayPass.uniforms.lightPosition) {\n                return;\n            }\n            \n            if (!this.camera) {\n                return;\n            }\n            \n            // Try to find the sun in the scene\n            const sun = this.sceneApiManager.findSunObject();\n            \n            if (sun) {\n                // Get sun world position\n                const sunWorldPos = new THREE.Vector3();\n                sun.getWorldPosition(sunWorldPos);\n                \n                // Create a vector to hold the screen position\n                const screenVector = sunWorldPos.clone();\n                \n                // Project to camera space\n                screenVector.project(this.camera);\n                \n                // Convert to normalized device coordinates (NDC)\n                const x = (screenVector.x + 1) / 2;\n                const y = (screenVector.y + 1) / 2;\n                \n                // Update the shader uniform with the new position\n                this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(x, y);\n            } else {\n                // Default to center if sun not found\n                this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\n            }\n        } catch (error) {\n            console.warn('Error updating Claude Ray position:', error);\n            \n            // Set a default position in case of error\n            if (this.postProcessingManager.claudeRayPass && this.postProcessingManager.claudeRayPass.uniforms && this.postProcessingManager.claudeRayPass.uniforms.lightPosition) {\n                this.postProcessingManager.claudeRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\n            }\n        }\n    }\n    \n    /**\n     * Update the light position for volumetric rays\n     */\n    updateVolumetricLightPosition(): void {\n        try {\n            // Ensure we have the required objects\n            if (!this.postProcessingManager.godRayPass || !this.postProcessingManager.godRayPass.uniforms || !this.postProcessingManager.godRayPass.uniforms.lightPosition) {\n                return;\n            }\n            \n            if (!this.camera) {\n                return;\n            }\n            \n            // Try to find the sun in the scene\n            const sun = this.sceneApiManager.findSunObject();\n            \n            if (sun) {\n                // Get sun world position\n                const sunWorldPos = new THREE.Vector3();\n                sun.getWorldPosition(sunWorldPos);\n                \n                // Create a vector to hold the screen position\n                const screenVector = sunWorldPos.clone();\n                \n                // Project to camera space\n                screenVector.project(this.camera);\n                \n                // Convert to normalized device coordinates (NDC)\n                const x = (screenVector.x + 1) / 2;\n                const y = (screenVector.y + 1) / 2;\n                \n                // Calculate distance from camera to sun for attenuation\n                const camToSunDistance = this.camera.position.distanceTo(sunWorldPos);\n                \n                // Update the shader uniforms\n                this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(x, y);\n                \n                // Update distance - normalized to 0-1 range for shader\n                // Base the max distance on the sun's size and visibility range\n                const maxDistance = 130000; // Increased from 100000 for longer rays\n                const normalizedDistance = Math.min(1.0, camToSunDistance / maxDistance);\n                this.postProcessingManager.godRayPass.uniforms.sunDistance.value = normalizedDistance;\n                \n                // Calculate if sun is in front of camera (dot product with camera direction)\n                const camDirection = new THREE.Vector3(0, 0, -1).applyQuaternion(this.camera.quaternion);\n                const sunDirection = new THREE.Vector3().subVectors(sunWorldPos, this.camera.position).normalize();\n                const dotProduct = camDirection.dot(sunDirection);\n                \n                // Sun is visible when dot product is positive (sun is in front of camera)\n                this.postProcessingManager.godRayPass.uniforms.sunVisibility.value = Math.max(0, dotProduct);\n            } else {\n                // Default to center if sun not found\n                this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\n                this.postProcessingManager.godRayPass.uniforms.sunDistance.value = 1.0; // Far away\n                this.postProcessingManager.godRayPass.uniforms.sunVisibility.value = 0.0; // Not visible\n            }\n        } catch (error) {\n            console.warn('Error updating volumetric light position:', error);\n            \n            // Set default values in case of error\n            if (this.postProcessingManager.godRayPass && this.postProcessingManager.godRayPass.uniforms) {\n                if (this.postProcessingManager.godRayPass.uniforms.lightPosition) {\n                    this.postProcessingManager.godRayPass.uniforms.lightPosition.value.set(0.5, 0.5);\n                }\n                if (this.postProcessingManager.godRayPass.uniforms.sunDistance) {\n                    this.postProcessingManager.godRayPass.uniforms.sunDistance.value = 1.0;\n                }\n                if (this.postProcessingManager.godRayPass.uniforms.sunVisibility) {\n                    this.postProcessingManager.godRayPass.uniforms.sunVisibility.value = 0.0;\n                }\n            }\n        }\n    }\n\n    /**\n     * Toggle the type of volumetric lighting effect\n     * @param useClaudeRays - If true, use original Claude Rays; if false, use new god rays\n     */\n    setRayType(useClaudeRays: boolean): void {\n        this.postProcessingManager.useClaudeRays = useClaudeRays;\n        \n        // Enable/disable appropriate shader passes\n        if (this.postProcessingManager.claudeRayPass) {\n            this.postProcessingManager.claudeRayPass.enabled = this.postProcessingManager.volumetricLightEnabled && this.postProcessingManager.useClaudeRays;\n        }\n        \n        if (this.postProcessingManager.godRayPass) {\n            this.postProcessingManager.godRayPass.enabled = this.postProcessingManager.volumetricLightEnabled && !this.postProcessingManager.useClaudeRays;\n        }\n        \n        console.log(`Using ${this.postProcessingManager.useClaudeRays ? 'Claude Rays' : 'Volumetric God Rays'} effect`);\n    }\n    \n    /**\n     * Toggle volumetric light rays effect (master toggle)\n     * @param enabled Whether to enable or disable all ray effects\n     */\n    setVolumetricLightEnabled(enabled: boolean): void {\n        this.postProcessingManager.volumetricLightEnabled = enabled;\n        \n        // Update enabled state of current ray effect\n        if (this.postProcessingManager.useClaudeRays && this.postProcessingManager.claudeRayPass) {\n            this.postProcessingManager.claudeRayPass.enabled = enabled;\n        } else if (this.postProcessingManager.godRayPass) {\n            this.postProcessingManager.godRayPass.enabled = enabled;\n        }\n        \n        console.log(`Volumetric lighting ${enabled ? 'enabled' : 'disabled'}`);\n    }\n    \n    /**\n     * Update volumetric light parameters for the new god ray shader\n     * @param params Parameters to update\n     */\n    updateVolumetricLightParams(params: VolumetricLightParams = {}): void {\n        if (!this.postProcessingManager.godRayPass || !this.postProcessingManager.godRayPass.uniforms) return;\n        \n        const uniforms = this.postProcessingManager.godRayPass.uniforms;\n        \n        if (params.intensity !== undefined) uniforms.intensity.value = params.intensity;\n        if (params.decay !== undefined) uniforms.decay.value = params.decay;\n        if (params.density !== undefined) uniforms.density.value = params.density;\n        if (params.weight !== undefined) uniforms.weight.value = params.weight;\n        if (params.samples !== undefined) uniforms.samples.value = params.samples;\n        if (params.sunColor !== undefined) uniforms.sunColor.value = new THREE.Color(params.sunColor);\n        if (params.scattering !== undefined) uniforms.scattering.value = params.scattering;\n        if (params.attenuationMultiplier !== undefined) uniforms.attenuationMultiplier.value = params.attenuationMultiplier;\n    }\n    \n    /**\n     * Update Claude Ray parameters\n     * @param params Parameters to update\n     */\n    updateClaudeRayParams(params: ClaudeRayParams = {}): void {\n        if (!this.postProcessingManager.claudeRayPass || !this.postProcessingManager.claudeRayPass.uniforms) return;\n        \n        const uniforms = this.postProcessingManager.claudeRayPass.uniforms;\n        \n        if (params.exposure !== undefined) uniforms.exposure.value = params.exposure;\n        if (params.decay !== undefined) uniforms.decay.value = params.decay;\n        if (params.density !== undefined) uniforms.density.value = params.density;\n        if (params.weight !== undefined) uniforms.weight.value = params.weight;\n        if (params.lightColor !== undefined) uniforms.lightColor.value = new THREE.Color(params.lightColor);\n    }\n    \n    /**\n     * Set overall volumetric light ray intensity with a single parameter\n     * @param intensity Value from 0-1 controlling overall ray intensity\n     */\n    setVolumetricLightIntensity(intensity: number): void {\n        if (this.postProcessingManager.useClaudeRays) {\n            // For Claude Rays\n            if (!this.postProcessingManager.claudeRayPass || !this.postProcessingManager.claudeRayPass.uniforms) return;\n            \n            // Clamp intensity between 0 and 1\n            intensity = Math.max(0, Math.min(1, intensity));\n            \n            // Scale the intensity to reasonable parameter ranges\n            const exposure = 0.2 + (intensity * 0.4);  // Range: 0.2-0.6\n            const weight = 0.15 + (intensity * 0.25);  // Range: 0.15-0.4\n            const density = 0.7 + (intensity * 0.3);   // Range: 0.7-1.0\n            \n            // Update the shader parameters\n            this.updateClaudeRayParams({\n                exposure: exposure,\n                weight: weight,\n                density: density\n            });\n        } else {\n            // For new god rays\n            if (!this.postProcessingManager.godRayPass || !this.postProcessingManager.godRayPass.uniforms) return;\n            \n            // Clamp intensity between 0 and 1\n            intensity = Math.max(0, Math.min(1, intensity));\n            \n            // Scale intensity for new shader parameters with higher base values\n            this.updateVolumetricLightParams({\n                intensity: 0.3 + (intensity * 0.4),  // Increased base intensity\n                weight: 0.35 + (intensity * 0.3),    // Increased from 0.3 + intensity * 0.2\n                density: 0.45 + (intensity * 0.25),  // Increased from 0.4 + intensity * 0.2\n                scattering: 0.25 + (intensity * 0.25) // Increased from 0.2 + intensity * 0.2\n            });\n        }\n        \n        console.log(`Volumetric light intensity set to ${intensity.toFixed(2)}`);\n    }\n}\n","// renderer.ts - Main renderer orchestrator delegating to specialized submodules\n\nimport * as THREE from 'three';\nimport WebGL from 'three/addons/capabilities/WebGL.js';\nimport { WebGPURenderer } from 'three/webgpu';\nimport { LightingManager } from './renderer/lighting';\nimport { PostProcessingManager } from './renderer/post';\nimport { SceneApiManager } from './renderer/sceneApi';\nimport { RenderHelpers } from './renderer/helpers';\nimport { VolumetricLightingManager } from './renderer/volumetricLighting';\nimport { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';\n\ntype RendererType = THREE.WebGLRenderer | WebGPURenderer;\n\ninterface ViewDef {\n    [key: string]: any;\n}\n\nexport class Renderer {\n    scene: THREE.Scene;\n    camera: THREE.PerspectiveCamera;\n    renderer!: RendererType;\n    renderAlpha: number = 0;\n    lightingManager?: LightingManager;\n    postProcessingManager?: PostProcessingManager;\n    sceneApiManager?: SceneApiManager;\n    renderHelpers?: RenderHelpers;\n    volumetricLightingManager?: VolumetricLightingManager;\n    composer?: EffectComposer;\n    filmPass?: any; // ShaderPass from post-processing\n    volumetricLightEnabled?: boolean;\n    useClaudeRays?: boolean;\n\n    constructor() {\n        console.log(\"Initializing enhanced renderer...\");\n\n        this.scene = new THREE.Scene();\n        this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 400000);\n\n        // Interpolation alpha provided by main\n        this.renderAlpha = 0;\n    }\n\n    static async create(): Promise<Renderer> {\n        const instance = new Renderer();\n        await instance.init();\n        return instance;\n    }\n\n    async init(): Promise<void> {\n        this.renderer = await this.createRenderer();\n\n        // Enable shadow mapping\n        if ('shadowMap' in this.renderer) {\n            this.renderer.shadowMap.enabled = true;\n            this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n        }\n\n        // Set tone mapping for HDR rendering\n        if ('toneMapping' in this.renderer) {\n            this.renderer.toneMapping = THREE.ACESFilmicToneMapping;\n            this.renderer.toneMappingExposure = 1.0;\n        }\n\n        this.setupRenderer();\n\n        // Initialize submodules\n        this.lightingManager = new LightingManager(this.scene, this.renderer, this.camera);\n        this.postProcessingManager = new PostProcessingManager(this.renderer, this.scene, this.camera);\n        this.sceneApiManager = new SceneApiManager(this.scene);\n        this.renderHelpers = new RenderHelpers(this.scene);\n        this.volumetricLightingManager = new VolumetricLightingManager(this.postProcessingManager, this.sceneApiManager, this.camera);\n\n        // Setup through submodules\n        this.lightingManager.setupLighting();\n        this.postProcessingManager.setupPostProcessing();\n        this.setupResizeHandler();\n\n        // Store reference for sun to access\n        (this.scene as any).lightingManager = this.lightingManager;\n\n        // Store composer reference\n        this.composer = this.postProcessingManager.composer || undefined;\n        this.filmPass = this.postProcessingManager.filmPass || undefined;\n        this.volumetricLightEnabled = this.postProcessingManager.volumetricLightEnabled;\n        this.useClaudeRays = this.postProcessingManager.useClaudeRays;\n\n        console.log(\"Enhanced renderer initialized successfully\");\n    }\n\n    async createRenderer(): Promise<RendererType> {\n        // Try WebGPU first, fall back to WebGL2\n        try {\n            const renderer = new WebGPURenderer({\n                antialias: true,\n                powerPreference: \"high-performance\",\n            });\n            await renderer.init();\n            console.log(\"WebGPU renderer initialized\");\n            return renderer;\n        } catch (error) {\n            console.log(\"WebGPU not available, falling back to WebGL2\");\n        }\n\n        if (!WebGL.isWebGL2Available()) {\n            const warning = WebGL.getWebGL2ErrorMessage();\n            document.body.appendChild(warning);\n            console.error(\"WebGL 2 is required but not available.\");\n            throw new Error(\"WebGL 2 not available\");\n        }\n\n        console.log(\"WebGL 2 is available.\");\n        return new THREE.WebGLRenderer({\n            antialias: true,\n            powerPreference: \"high-performance\",\n            logarithmicDepthBuffer: true, // Better for space scenes with huge distance ranges\n            stencil: true, // Explicitly enable stencil buffer (default changed to false in r163)\n        });\n    }\n    \n    setupRenderer(): void {\n        if ('setSize' in this.renderer) {\n            this.renderer.setSize(window.innerWidth, window.innerHeight);\n        }\n        if ('setClearColor' in this.renderer) {\n            this.renderer.setClearColor(0x000000);\n        }\n        if ('domElement' in this.renderer) {\n            document.body.appendChild(this.renderer.domElement);\n        }\n        \n        // Set the output color space to sRGB\n        if ('outputColorSpace' in this.renderer) {\n            this.renderer.outputColorSpace = THREE.SRGBColorSpace;\n        }\n        \n        // Position camera - brought closer for better visibility\n        this.camera.position.z = 10;\n        \n        // Make sure the camera can see far enough to show the skybox\n        this.camera.far = 400000;\n        this.camera.updateProjectionMatrix();\n\n        // Enhance shadow mapping for better quality eclipse effects\n        if ('shadowMap' in this.renderer) {\n            this.renderer.shadowMap.enabled = true;\n            this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n            if ('autoUpdate' in this.renderer.shadowMap) {\n                (this.renderer.shadowMap as any).autoUpdate = true;\n            }\n        }\n    }\n    \n    // Post-processing setup is now handled by PostProcessingManager\n    \n    // Volumetric lighting setup is now handled by PostProcessingManager and VolumetricLightingManager\n    \n    // Lighting setup is now handled by LightingManager\n    \n    setupResizeHandler(): void {\n        window.addEventListener('resize', () => {\n            this.handleResize();\n        });\n    }\n    \n    // Explicitly define getter methods for scene and camera\n    getScene(): THREE.Scene {\n        return this.scene;\n    }\n    \n    getCamera(): THREE.PerspectiveCamera {\n        return this.camera;\n    }\n    \n    // Resize handler method\n    handleResize(): void {\n        this.camera.aspect = window.innerWidth / window.innerHeight;\n        this.camera.updateProjectionMatrix();\n        if ('setSize' in this.renderer) {\n            this.renderer.setSize(window.innerWidth, window.innerHeight);\n        }\n        \n        // Update lighting manager's post-processing\n        if (this.lightingManager) {\n            this.lightingManager.handleResize();\n        }\n        \n        // Update composer size if it exists\n        if (this.composer) {\n            this.composer.setSize(window.innerWidth, window.innerHeight);\n        \n            // Update FXAA resolution\n            try {\n                const pixelRatio = 'getPixelRatio' in this.renderer ? this.renderer.getPixelRatio() : 1;\n                const fxaaPass = this.composer.passes.find((pass: any) => \n                    pass.material && \n                    pass.material.uniforms && \n                    pass.material.uniforms.resolution &&\n                    pass.material.uniforms.resolution.value\n                );\n                \n                if (fxaaPass) {\n                    (fxaaPass as any).material.uniforms.resolution.value.x = 1 / (window.innerWidth * pixelRatio);\n                    (fxaaPass as any).material.uniforms.resolution.value.y = 1 / (window.innerHeight * pixelRatio);\n                }\n            } catch (error) {\n                console.warn(\"Error updating FXAA resolution:\", error);\n            }\n        }\n    }\n    \n    // Add an object to the scene through guarded path\n    add(object: THREE.Object3D): void {\n        this._withGuard(() => this.scene.add(object));\n    }\n    \n    // Allow dynamic adjustment of post-processing settings\n    adjustBloom(strength: number, radius: number, threshold: number): void {\n        if (this.postProcessingManager) {\n            this.postProcessingManager.adjustBloom(strength, radius, threshold);\n        }\n    }\n    \n    // Update for dynamic visual effects\n    update(deltaTime: number): void {\n        // Update film grain with time for animation\n        if (this.filmPass && this.filmPass.uniforms && this.filmPass.uniforms.time && this.filmPass.uniforms.time.value !== undefined) {\n            try {\n                this.filmPass.uniforms.time.value += deltaTime;\n            } catch (error) {\n                console.warn(\"Error updating film pass time:\", error);\n            }\n        }\n        \n        // Update volumetric light ray position if sun is present\n        if (this.volumetricLightEnabled) {\n            if (this.useClaudeRays) {\n                this.updateClaudeRayPosition();\n            } else {\n                this.updateVolumetricLightPosition();\n            }\n        }\n        \n        // Update instanced meshes\n        this.updateInstancedMeshes();\n    }\n    \n    // Volumetric lighting position updates are now handled by VolumetricLightingManager\n    // Volumetric lighting position updates are now handled by VolumetricLightingManager\n    // Sun object finding is now handled by SceneApiManager\n    \n    // Override the render method to use the composer if available, otherwise fallback to basic rendering\n    render(): void {\n        // Update performance counters\n        if (this.renderHelpers) {\n            const startCalls = this.renderHelpers.updatePerformanceCounters(this.renderer);\n            \n            // Delegate to post-processing manager\n            if (this.postProcessingManager) {\n                this.postProcessingManager.render();\n            }\n            \n            // Finalize performance counters\n            this.renderHelpers.finalizePerformanceCounters(this.renderer, startCalls);\n        } else if (this.postProcessingManager) {\n            this.postProcessingManager.render();\n        }\n    }\n\n    // Interpolate ECS meshes before compositing\n    interpolateMeshes(alpha: number): void {\n        this.renderAlpha = alpha;\n        if (this.sceneApiManager) {\n            this.sceneApiManager.interpolateMeshes(alpha);\n        }\n    }\n\n    // Facade API for views - delegated to SceneApiManager\n    addView(entityId: number, viewDef: ViewDef): void {\n        if (this.sceneApiManager) {\n            this.sceneApiManager.addView(entityId, viewDef);\n        }\n    }\n\n    removeView(entityId: number): void {\n        if (this.sceneApiManager) {\n            this.sceneApiManager.removeView(entityId);\n        }\n    }\n\n    _withGuard<T>(fn: () => T): T {\n        if (this.sceneApiManager) {\n            return this.sceneApiManager._withGuard(fn);\n        }\n        return fn();\n    }\n\n    updateView(entityId: number, props: any): void {\n        if (this.sceneApiManager) {\n            this.sceneApiManager.updateView(entityId, props);\n        }\n    }\n    \n    /**\n     * Create an instanced mesh for efficient rendering of many similar objects\n     */\n    createInstancedMesh(key: string, geometry: THREE.BufferGeometry, material: THREE.Material, maxCount: number): THREE.InstancedMesh | null {\n        if (this.renderHelpers) {\n            return this.renderHelpers.createInstancedMesh(key, geometry, material, maxCount);\n        }\n        return null;\n    }\n    \n    /**\n     * Add or update an instance in an instanced mesh\n     */\n    updateInstance(key: string, index: number, position: THREE.Vector3, quaternion: THREE.Quaternion, scale: THREE.Vector3): boolean {\n        if (this.renderHelpers) {\n            return Boolean(this.renderHelpers.updateInstance(key, index, position, quaternion, scale));\n        }\n        return false;\n    }\n    \n    /**\n     * Update instanced meshes\n     */\n    updateInstancedMeshes(): void {\n        if (this.renderHelpers) {\n            this.renderHelpers.updateInstancedMeshes();\n        }\n    }\n    \n    /**\n     * Remove an instance from an instanced mesh\n     */\n    removeInstance(key: string, index: number): void {\n        if (this.renderHelpers) {\n            this.renderHelpers.removeInstance(key, index);\n        }\n    }\n    \n    /**\n     * Properly dispose of Three.js resources to prevent memory leaks\n     */\n    dispose(): void {\n        console.log(\"Disposing renderer resources...\");\n        \n        // Remove event listener\n        window.removeEventListener('resize', this.handleResize);\n        \n        // Dispose submodules\n        if (this.postProcessingManager) {\n            this.postProcessingManager.dispose();\n        }\n        if (this.lightingManager) {\n            this.lightingManager.dispose();\n        }\n        if (this.renderHelpers) {\n            this.renderHelpers.dispose();\n        }\n        \n        // Dispose of scene objects\n        this.scene.traverse((object) => {\n            if ('geometry' in object && object.geometry) {\n                (object.geometry as any).dispose();\n            }\n            \n            if ('material' in object && object.material) {\n                if (Array.isArray(object.material)) {\n                    object.material.forEach((material) => {\n                        if (this.renderHelpers) {\n                            this.renderHelpers.disposeMaterial(material as any);\n                        }\n                    });\n                } else {\n                    if (this.renderHelpers) {\n                        this.renderHelpers.disposeMaterial(object.material as any);\n                    }\n                }\n            }\n        });\n        \n        // Dispose of renderer\n        if ('dispose' in this.renderer) {\n            this.renderer.dispose();\n        }\n        \n        console.log(\"Renderer resources disposed\");\n    }\n    // Material disposal is now handled by RenderHelpers\n    // Shader creation is now handled by shaders.js module\n    // Shader creation is now handled by shaders.js module\n    \n    /**\n     * Toggle the type of volumetric lighting effect\n     */\n    setRayType(useClaudeRays: boolean): void {\n        if (this.volumetricLightingManager && this.lightingManager) {\n            this.volumetricLightingManager.setRayType(useClaudeRays);\n            this.lightingManager.adjustLightingForRayType(useClaudeRays);\n        }\n    }\n    // Lighting adjustment is now handled by LightingManager\n    \n    /**\n     * Toggle volumetric light rays effect (master toggle)\n     */\n    setVolumetricLightEnabled(enabled: boolean): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.setVolumetricLightEnabled(enabled);\n        }\n    }\n    \n    /**\n     * Update volumetric light parameters for the new god ray shader\n     */\n    updateVolumetricLightParams(params: any = {}): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.updateVolumetricLightParams(params);\n        }\n    }\n    \n    /**\n     * Update Claude Ray parameters\n     */\n    updateClaudeRayParams(params: any = {}): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.updateClaudeRayParams(params);\n        }\n    }\n    \n    /**\n     * Set overall volumetric light ray intensity with a single parameter\n     */\n    setVolumetricLightIntensity(intensity: number): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.setVolumetricLightIntensity(intensity);\n        }\n    }\n\n    // Helper methods for volumetric lighting (delegated to VolumetricLightingManager)\n    private updateClaudeRayPosition(): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.updateClaudeRayPosition();\n        }\n    }\n\n    private updateVolumetricLightPosition(): void {\n        if (this.volumetricLightingManager) {\n            this.volumetricLightingManager.updateVolumetricLightPosition();\n        }\n    }\n}\n","// trail.ts - Thruster exhaust effects for spaceship\n\nimport * as THREE from 'three';\n\n// Thrust state interface (matches physics.ts)\ninterface ThrustState {\n    forward: boolean;\n    backward: boolean;\n    left: boolean;\n    right: boolean;\n    boost: boolean;\n}\n\n// Thruster effect configuration\ninterface ThrusterConfig {\n    baseRadius: number;\n    length: number;\n    color: number;\n    glowColor: number;\n    type: 'main' | 'right_thruster' | 'left_thruster' | 'reverse';\n}\n\n// Beam segment data\ninterface BeamSegment {\n    mesh: THREE.Mesh;\n    material: THREE.MeshBasicMaterial;\n}\n\n// Thruster effect data\ninterface ThrusterEffect {\n    group: THREE.Group;\n    beams: BeamSegment[];\n    type: 'main' | 'right_thruster' | 'left_thruster' | 'reverse';\n}\n\nexport class TrailEffects {\n    private mesh: THREE.Object3D;\n    private thrusterEffects: ThrusterEffect[];\n    private time: number;\n\n    constructor(_scene: THREE.Scene, mesh: THREE.Object3D) {\n        this.mesh = mesh; // The spaceship mesh\n        this.thrusterEffects = [];\n        this.time = 0;\n        \n        // Initialize effects\n        this.createThrusterEffects();\n    }\n    \n    private createThrusterEffects(): void {\n        // Create exhaust beam effect using multiple overlapping cylinders\n        const createExhaustBeam = (\n            position: THREE.Vector3,\n            direction: THREE.Vector3,\n            config: ThrusterConfig\n        ): ThrusterEffect => {\n            const { baseRadius, length, color, glowColor, type } = config;\n            const group = new THREE.Group();\n            \n            // Create multiple cylinder segments for tapered effect\n            const segments = 8;\n            const beams: BeamSegment[] = [];\n            \n            for (let i = 0; i < segments; i++) {\n                const t = i / segments;\n                \n                // Taper the radius\n                const topRadius = baseRadius * (1 - t * 0.7);\n                const bottomRadius = baseRadius * (1 - (t + 1/segments) * 0.7);\n                const segmentLength = length / segments;\n                \n                // Create cylinder geometry\n                const geometry = new THREE.CylinderGeometry(\n                    topRadius,\n                    bottomRadius,\n                    segmentLength,\n                    12, // More segments for smoother look\n                    1,\n                    false\n                );\n                \n                // Create material with gradient\n                const material = new THREE.MeshBasicMaterial({\n                    color: new THREE.Color(color).lerp(new THREE.Color(glowColor), t),\n                    transparent: true,\n                    opacity: 1.0 - t * 0.3, // High opacity\n                    blending: THREE.AdditiveBlending,\n                    side: THREE.DoubleSide,\n                    depthTest: false // Always render on top\n                });\n                \n                const beam = new THREE.Mesh(geometry, material);\n                \n                // Position each segment along the exhaust direction\n                if (direction.z !== 0) {\n                    // Main/reverse thrusters - point along Z\n                    geometry.rotateX(Math.PI / 2);\n                    beam.position.z = direction.z * (i * segmentLength + segmentLength/2);\n                } else if (direction.x !== 0) {\n                    // Side thrusters - point along X (perpendicular to ship)\n                    geometry.rotateZ(Math.PI / 2);\n                    beam.position.x = direction.x * (i * segmentLength + segmentLength/2);\n                }\n                \n                beams.push({ mesh: beam, material });\n                group.add(beam);\n            }\n            \n            // Position the group at the thruster location\n            group.position.copy(position);\n            \n            group.visible = false;\n            \n            // Debug: log thruster creation  \n            // console.log(`Created ${type} thruster at position:`, position);\n            this.mesh.add(group);\n            \n            return { group, beams, type };\n        };\n        \n        // Main thruster - big blue/orange exhaust\n        this.thrusterEffects.push(createExhaustBeam(\n            new THREE.Vector3(0, 0, 1.2), // Back of ship (ship scale is 2.0)\n            new THREE.Vector3(0, 0, 1), // Points backward\n            {\n                baseRadius: 0.25, // Scaled for ship size\n                length: 2.5, // Good length for exhaust\n                color: 0xffaa00, // Orange core\n                glowColor: 0x0088ff, // Blue edges\n                type: 'main'\n            }\n        ));\n        \n        // RIGHT side thruster - fires when A pressed to push ship LEFT\n        this.thrusterEffects.push(createExhaustBeam(\n            new THREE.Vector3(0.7, 0, 0.2), // Right side of ship\n            new THREE.Vector3(1, 0, 0), // Shoots right (away from ship)\n            {\n                baseRadius: 0.15,\n                length: 1.0, // Shorter exhaust\n                color: 0xffaa00,\n                glowColor: 0x00aaff,\n                type: 'right_thruster' // RIGHT thruster\n            }\n        ));\n        \n        // LEFT side thruster - fires when D pressed to push ship RIGHT\n        this.thrusterEffects.push(createExhaustBeam(\n            new THREE.Vector3(-0.7, 0, 0.2), // Left side of ship\n            new THREE.Vector3(-1, 0, 0), // Shoots left (away from ship)\n            {\n                baseRadius: 0.15,\n                length: 1.0, // Shorter exhaust\n                color: 0xffaa00,\n                glowColor: 0x00aaff,\n                type: 'left_thruster' // LEFT thruster\n            }\n        ));\n        \n        // Reverse thruster\n        this.thrusterEffects.push(createExhaustBeam(\n            new THREE.Vector3(0, 0, -1.2), // Front of ship\n            new THREE.Vector3(0, 0, -1), // Points forward\n            {\n                baseRadius: 0.2,\n                length: 1.8,\n                color: 0xff8800,\n                glowColor: 0xff4400,\n                type: 'reverse'\n            }\n        ));\n    }\n    \n    updateParticles(thrust: ThrustState, velocity: THREE.Vector3): void {\n        this.time += 0.016;\n        \n        // Check window.inputIntent for keyboard controls\n        const intent = window.inputIntent || 0;\n        const leftPressed = thrust.left || ((intent & 4) !== 0);  // A key\n        const rightPressed = thrust.right || ((intent & 8) !== 0); // D key\n        \n        // Update each thruster effect\n        this.thrusterEffects.forEach(effect => {\n            const { group, beams, type } = effect;\n            \n            let shouldShow = false;\n            let intensity = 0;\n            \n            // Determine visibility based on thrust\n            switch(type) {\n                case 'main':\n                    shouldShow = thrust.forward || velocity.length() > 1.0;\n                    intensity = thrust.forward ? (thrust.boost ? 1.5 : 1.0) : 0.5;\n                    break;\n                case 'right_thruster':\n                    // RIGHT thruster fires when A pressed (to move ship LEFT)\n                    shouldShow = leftPressed; // A key\n                    intensity = thrust.boost ? 1.5 : 1.2;\n                    // if (shouldShow) console.log('RIGHT thruster firing to move LEFT');\n                    break;\n                case 'left_thruster':\n                    // LEFT thruster fires when D pressed (to move ship RIGHT)\n                    shouldShow = rightPressed; // D key\n                    intensity = thrust.boost ? 1.5 : 1.2;\n                    // if (shouldShow) console.log('LEFT thruster firing to move RIGHT');\n                    break;\n                case 'reverse':\n                    shouldShow = thrust.backward;\n                    intensity = thrust.boost ? 1.3 : 1.0;\n                    break;\n            }\n            \n            group.visible = shouldShow;\n            \n            if (shouldShow && beams) {\n                // Animate the exhaust\n                beams.forEach((beam, index) => {\n                    const t = index / beams.length;\n                    \n                    // Very subtle flicker\n                    const flicker = 0.95 + Math.sin(this.time * 10 + index) * 0.05;\n                    \n                    // Update opacity for animation - ensure visibility\n                    beam.material.opacity = Math.max(0.7, (1.0 - t * 0.2) * intensity * flicker);\n                    \n                    // Subtle scale animation\n                    beam.mesh.scale.x = beam.mesh.scale.y = 1.0 + Math.sin(this.time * 8 + index) * 0.05;\n                    beam.mesh.scale.z = 1.0 + intensity * 0.3; // Longer when boosting\n                });\n            }\n        });\n    }\n    \n    updateTrailVisibility(isMoving: boolean, thrust: ThrustState, velocity: THREE.Vector3): void {\n        // Update main thruster visibility based on movement\n        const mainEffect = this.thrusterEffects.find(e => e.type === 'main');\n        if (mainEffect) {\n            const shouldShow = thrust.forward || (isMoving && velocity.length() > 2.0);\n            mainEffect.group.visible = shouldShow;\n        }\n    }\n    \n    dispose(): void {\n        // Clean up all thruster effects\n        this.thrusterEffects.forEach(effect => {\n            if (effect.group) {\n                if (effect.group.parent) {\n                    effect.group.parent.remove(effect.group);\n                }\n                \n                // Dispose of all children\n                effect.group.traverse((child: THREE.Object3D) => {\n                    if ('geometry' in child && child.geometry) {\n                        (child.geometry as THREE.BufferGeometry).dispose();\n                    }\n                    if ('material' in child && child.material) {\n                        const material = child.material as THREE.Material;\n                        if (Array.isArray(material)) {\n                            material.forEach(mat => mat.dispose());\n                        } else {\n                            material.dispose();\n                        }\n                    }\n                });\n            }\n        });\n        \n        this.thrusterEffects = [];\n    }\n}\n","// shipModel.ts - 3D model creation for spaceship\n// Extracted from spaceship.js to improve maintainability\n\nimport * as THREE from 'three';\n\ninterface ThrusterComponent {\n  mesh: THREE.Mesh;\n  type: string;\n}\n\ninterface ShipComponents {\n  mesh: THREE.Group;\n  thrusters: ThrusterComponent[];\n  leftCannon?: THREE.Mesh | null;\n  rightCannon?: THREE.Mesh | null;\n  leftEmitter?: THREE.Mesh | null;\n  rightEmitter?: THREE.Mesh | null;\n  miningLaser?: THREE.Mesh | null;\n}\n\nexport class ShipModel {\n  scene: THREE.Scene;\n  shipScale: number;\n  mesh: THREE.Group | null;\n  thrusters: ThrusterComponent[];\n  leftCannon: THREE.Mesh | null;\n  rightCannon: THREE.Mesh | null;\n  leftEmitter: THREE.Mesh | null;\n  rightEmitter: THREE.Mesh | null;\n  miningLaser: THREE.Mesh | null;\n\n  constructor(scene: THREE.Scene, shipScale: number = 2.0) {\n    this.scene = scene;\n    this.shipScale = shipScale;\n    this.mesh = null;\n    this.thrusters = [];\n    this.leftCannon = null;\n    this.rightCannon = null;\n    this.leftEmitter = null;\n    this.rightEmitter = null;\n    this.miningLaser = null;\n  }\n\n  /**\n   * Create the complete spaceship 3D model\n   * @returns {THREE.Group} The spaceship mesh group\n   */\n  createSpaceship(): THREE.Group {\n    // Create spaceship group\n    this.mesh = new THREE.Group();\n\n    // Scale the entire ship\n    this.mesh.scale.set(this.shipScale, this.shipScale, this.shipScale);\n\n    // Set initial position to a safe location far from the sun\n    this.mesh.position.set(0, 2000, 0); // Position near stargate initially\n\n    // Create the main body of the ship - sleek aerodynamic design using basic geometries\n    // Use a cylinder with a cone at the front instead of CapsuleGeometry\n    const bodyGroup = new THREE.Group();\n\n    // Main hull cylinder\n    const cylinderGeometry = new THREE.CylinderGeometry(0.4, 0.5, 1.8, 12);\n    const bodyMaterial = new THREE.MeshPhongMaterial({\n      color: 0xffffff, // White base\n      specular: 0xffd700, // Gold specular highlights\n      shininess: 100,\n      emissive: 0x222222,\n      emissiveIntensity: 0.1\n    });\n\n    const bodyCylinder = new THREE.Mesh(cylinderGeometry, bodyMaterial);\n    bodyCylinder.rotation.x = Math.PI / 2; // Rotate to point forward\n    bodyGroup.add(bodyCylinder);\n\n    // Front nose cone\n    const noseGeometry = new THREE.ConeGeometry(0.4, 0.8, 12);\n    const noseCone = new THREE.Mesh(noseGeometry, bodyMaterial);\n    noseCone.position.set(0, 0, -1.2);\n    noseCone.rotation.x = -Math.PI / 2; // Point forward\n    bodyGroup.add(noseCone);\n\n    // Add the complete body to the ship\n    this.mesh.add(bodyGroup);\n\n    // Add cockpit - glass dome\n    this._createCockpit();\n\n    // Add dual front cannons\n    this._createCannons();\n\n    // Add cannon emitters (glowing tips)\n    this._createEmitters();\n\n    // Create mining laser emitter (use one of the cannons for mining)\n    this.miningLaser = this.leftEmitter;\n\n    // Add curved wings\n    this._createWings();\n\n    // Add gold accents to body\n    this._createGoldAccents();\n\n    // Add thrusters\n    this._createThrusters();\n\n    // Add to scene\n    this.scene.add(this.mesh);\n\n    return this.mesh;\n  }\n\n  /**\n   * Create the cockpit glass dome\n   */\n  private _createCockpit(): void {\n    const cockpitGeometry = new THREE.SphereGeometry(0.35, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2);\n    const cockpitMaterial = new THREE.MeshPhongMaterial({\n      color: 0x88ccff,\n      specular: 0xffffff,\n      shininess: 100,\n      transparent: true,\n      opacity: 0.7,\n      emissive: 0x0066ff,\n      emissiveIntensity: 0.1\n    });\n    const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);\n    cockpit.position.set(0, 0.25, -0.2);\n    cockpit.rotation.x = -Math.PI / 2;\n    if (this.mesh) {\n      this.mesh.add(cockpit);\n    }\n  }\n\n  /**\n   * Create the dual front cannons\n   */\n  private _createCannons(): void {\n    const cannonGeometry = new THREE.CylinderGeometry(0.08, 0.06, 2.0, 8);\n    const cannonMaterial = new THREE.MeshPhongMaterial({\n      color: 0xffd700, // Gold\n      specular: 0xffffff,\n      shininess: 80,\n      emissive: 0xffd700,\n      emissiveIntensity: 0.2\n    });\n\n    // Left cannon\n    this.leftCannon = new THREE.Mesh(cannonGeometry, cannonMaterial);\n    this.leftCannon.position.set(0.2, 0, -1.5); // Left side of cockpit\n    this.leftCannon.rotation.x = Math.PI / 2; // Point forward\n    if (this.mesh) {\n      this.mesh.add(this.leftCannon);\n    }\n\n    // Right cannon\n    this.rightCannon = new THREE.Mesh(cannonGeometry, cannonMaterial);\n    this.rightCannon.position.set(-0.2, 0, -1.5); // Right side of cockpit\n    this.rightCannon.rotation.x = Math.PI / 2; // Point forward\n    if (this.mesh) {\n      this.mesh.add(this.rightCannon);\n    }\n  }\n\n  /**\n   * Create the cannon emitters (glowing tips)\n   */\n  private _createEmitters(): void {\n    const emitterGeometry = new THREE.SphereGeometry(0.08, 16, 16);\n    const emitterMaterial = new THREE.MeshPhongMaterial({\n      color: 0xff6600,\n      emissive: 0xff3300,\n      emissiveIntensity: 1\n    });\n\n    // Left emitter\n    this.leftEmitter = new THREE.Mesh(emitterGeometry, emitterMaterial);\n    this.leftEmitter.position.set(0.2, 0, -2.5); // Front of left cannon\n    if (this.mesh) {\n      this.mesh.add(this.leftEmitter);\n    }\n\n    // Right emitter\n    this.rightEmitter = new THREE.Mesh(emitterGeometry, emitterMaterial);\n    this.rightEmitter.position.set(-0.2, 0, -2.5); // Front of right cannon\n    if (this.mesh) {\n      this.mesh.add(this.rightEmitter);\n    }\n  }\n\n  /**\n   * Create curved wings using custom geometry\n   */\n  private _createWings(): void {\n    const createCurvedWing = (isLeft: boolean): THREE.Group => {\n      const wingGroup = new THREE.Group();\n\n      // Create curved wing shape using multiple segments\n      const wingMaterial = new THREE.MeshPhongMaterial({\n        color: 0xffffff, // White\n        specular: 0xffd700, // Gold specular\n        shininess: 80,\n        emissive: 0xffffff,\n        emissiveIntensity: 0.1\n      });\n\n      // Wing base connecting to ship body\n      const wingBaseGeom = new THREE.BoxGeometry(0.1, 0.2, 0.6);\n      const wingBase = new THREE.Mesh(wingBaseGeom, wingMaterial);\n      wingBase.position.set(isLeft ? 0.55 : -0.55, 0, 0.2);\n      wingGroup.add(wingBase);\n\n      // Curved part of wing - using custom curved mesh\n      const wingCurveGeom = new THREE.BoxGeometry(0.8, 0.1, 0.5);\n      const wingCurve = new THREE.Mesh(wingCurveGeom, wingMaterial);\n\n      // Rotate and position to create curved wing effect\n      wingCurve.position.set(isLeft ? 1 : -1, 0, 0.2);\n      wingCurve.rotation.z = isLeft ? Math.PI / 8 : -Math.PI / 8;\n      wingGroup.add(wingCurve);\n\n      // Wing tip with gold accent\n      const wingTipGeom = new THREE.BoxGeometry(0.3, 0.08, 0.3);\n      const goldMaterial = new THREE.MeshPhongMaterial({\n        color: 0xffd700, // Gold\n        specular: 0xffffff,\n        shininess: 100,\n        emissive: 0xffd700,\n        emissiveIntensity: 0.3\n      });\n\n      const wingTip = new THREE.Mesh(wingTipGeom, goldMaterial);\n      wingTip.position.set(isLeft ? 1.4 : -1.4, 0, 0.2);\n      wingTip.rotation.z = isLeft ? Math.PI / 6 : -Math.PI / 6;\n      wingGroup.add(wingTip);\n\n      return wingGroup;\n    };\n\n    // Add wings to ship\n    const leftWing = createCurvedWing(true);\n    if (this.mesh) {\n      this.mesh.add(leftWing);\n    }\n\n    const rightWing = createCurvedWing(false);\n    if (this.mesh) {\n      this.mesh.add(rightWing);\n    }\n  }\n\n  /**\n   * Add gold accents to the ship body\n   */\n  private _createGoldAccents(): void {\n    const addGoldAccent = (\n      width: number,\n      height: number,\n      depth: number,\n      x: number,\n      y: number,\n      z: number,\n      rotX: number = 0,\n      rotY: number = 0,\n      rotZ: number = 0\n    ): THREE.Mesh => {\n      const accentGeom = new THREE.BoxGeometry(width, height, depth);\n      const goldMaterial = new THREE.MeshPhongMaterial({\n        color: 0xffd700, // Gold\n        specular: 0xffffff,\n        shininess: 100,\n        emissive: 0xffd700,\n        emissiveIntensity: 0.3\n      });\n\n      const accent = new THREE.Mesh(accentGeom, goldMaterial);\n      accent.position.set(x, y, z);\n      accent.rotation.set(rotX, rotY, rotZ);\n      if (this.mesh) {\n        this.mesh.add(accent);\n      }\n      return accent;\n    };\n\n    // Add gold accents along the body\n    addGoldAccent(0.8, 0.05, 0.1, 0, -0.25, -0.3);\n    addGoldAccent(0.8, 0.05, 0.1, 0, -0.25, 0.3);\n    addGoldAccent(0.05, 0.05, 1.0, 0.3, -0.25, 0);\n    addGoldAccent(0.05, 0.05, 1.0, -0.3, -0.25, 0);\n  }\n\n  /**\n   * Create thrusters for the spaceship\n   */\n  private _createThrusters(): void {\n    const thrusterGeometry = new THREE.CylinderGeometry(0.2, 0.15, 0.5, 8);\n    const thrusterMaterial = new THREE.MeshPhongMaterial({\n      color: 0xffd700, // Gold\n      emissive: 0xff5500,\n      emissiveIntensity: 0.5\n    });\n\n    // Main thrusters (back)\n    const mainThruster = new THREE.Mesh(thrusterGeometry, thrusterMaterial);\n    mainThruster.position.z = 1.2; // Position at the back of the ship\n    mainThruster.rotation.x = Math.PI; // Point backward\n    if (this.mesh) {\n      this.mesh.add(mainThruster);\n    }\n    this.thrusters.push({ mesh: mainThruster, type: 'main' });\n\n    // Front/Reverse thruster (new)\n    const reverseThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\n    reverseThruster.position.z = -1.0; // Position at the front of the ship\n    reverseThruster.rotation.x = 0; // Point forward\n    reverseThruster.scale.set(0.6, 0.6, 0.6); // Make it slightly smaller than main thruster\n    if (this.mesh) {\n      this.mesh.add(reverseThruster);\n    }\n    this.thrusters.push({ mesh: reverseThruster, type: 'reverse' });\n\n    // Side thrusters for lateral movement\n    const leftThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\n    leftThruster.position.set(0.5, 0, 0.5);\n    leftThruster.rotation.z = Math.PI / 2; // Point to the right (for leftward thrust)\n    leftThruster.scale.set(0.5, 0.5, 0.5); // Make side thrusters smaller\n    if (this.mesh) {\n      this.mesh.add(leftThruster);\n    }\n    this.thrusters.push({ mesh: leftThruster, type: 'left' });\n\n    const rightThruster = new THREE.Mesh(thrusterGeometry.clone(), thrusterMaterial.clone());\n    rightThruster.position.set(-0.5, 0, 0.5);\n    rightThruster.rotation.z = -Math.PI / 2; // Point to the left (for rightward thrust)\n    rightThruster.scale.set(0.5, 0.5, 0.5); // Make side thrusters smaller\n    if (this.mesh) {\n      this.mesh.add(rightThruster);\n    }\n    this.thrusters.push({ mesh: rightThruster, type: 'right' });\n  }\n\n  /**\n   * Get references to important mesh components\n   * @returns {object} Object containing mesh references\n   */\n  getComponents(): ShipComponents {\n    return {\n      mesh: this.mesh!,\n      thrusters: this.thrusters,\n      leftCannon: this.leftCannon,\n      rightCannon: this.rightCannon,\n      leftEmitter: this.leftEmitter,\n      rightEmitter: this.rightEmitter,\n      miningLaser: this.miningLaser\n    };\n  }\n}\n","// upgrades.ts - Ship upgrade systems\n// Extracted from spaceship.js to improve maintainability\n\nimport * as THREE from 'three';\n\ninterface ShipComponents {\n  mesh?: THREE.Group;\n  thrusters: Array<{ mesh: THREE.Mesh; type: string }>;\n  leftCannon?: THREE.Mesh | null;\n  rightCannon?: THREE.Mesh | null;\n  leftEmitter?: THREE.Mesh | null;\n  rightEmitter?: THREE.Mesh | null;\n}\n\ninterface SpaceshipState {\n  maxFuel: number;\n  fuel: number;\n  maxVelocity: number;\n  miningEfficiency: number;\n  collisionResistance: number;\n  scanRange: number;\n}\n\ninterface UpgradeLevels {\n  fuelTankLevel: number;\n  fuelUpgradeCost: number;\n  engineLevel: number;\n  engineUpgradeCost: number;\n  miningLevel: number;\n  miningUpgradeCost: number;\n  hullLevel: number;\n  hullUpgradeCost: number;\n  scannerLevel: number;\n  scannerUpgradeCost: number;\n}\n\nexport class ShipUpgrades {\n  components: ShipComponents;\n\n  // Upgrade levels and costs\n  fuelTankLevel: number;\n  fuelUpgradeCost: number;\n\n  engineLevel: number;\n  engineUpgradeCost: number;\n\n  miningLevel: number;\n  miningUpgradeCost: number;\n\n  hullLevel: number;\n  hullUpgradeCost: number;\n\n  scannerLevel: number;\n  scannerUpgradeCost: number;\n\n  constructor(shipComponents: ShipComponents) {\n    this.components = shipComponents; // { mesh, thrusters, leftCannon, rightCannon, leftEmitter, rightEmitter }\n\n    // Upgrade levels and costs\n    this.fuelTankLevel = 1;\n    this.fuelUpgradeCost = 1000;\n\n    this.engineLevel = 1;\n    this.engineUpgradeCost = 800;\n\n    this.miningLevel = 1;\n    this.miningUpgradeCost = 1200;\n\n    this.hullLevel = 1;\n    this.hullUpgradeCost = 1500;\n\n    this.scannerLevel = 1;\n    this.scannerUpgradeCost = 600;\n  }\n\n  /**\n   * Upgrade the fuel tank capacity\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} New fuel capacity\n   */\n  upgradeFuelTank(spaceshipState: SpaceshipState): number {\n    console.log(\"Upgrading fuel tank\");\n\n    // Double the fuel capacity\n    spaceshipState.maxFuel *= 2;\n\n    // Increase the fuel level to match the new capacity\n    spaceshipState.fuel = spaceshipState.maxFuel;\n\n    // Increase the upgrade level\n    this.fuelTankLevel++;\n\n    // Calculate the new upgrade cost (4x the previous cost)\n    this.fuelUpgradeCost *= 4;\n\n    return spaceshipState.maxFuel;\n  }\n\n  /**\n   * Upgrade the ship's engines\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} New max velocity\n   */\n  upgradeEngine(spaceshipState: SpaceshipState): number {\n    console.log(\"Upgrading engines\");\n\n    // Increase max velocity by 25%\n    spaceshipState.maxVelocity *= 1.25;\n\n    // Upgrade visual appearance of thrusters\n    this.components.thrusters.forEach(thruster => {\n      if (thruster.mesh && thruster.mesh.material) {\n        const material = thruster.mesh.material as THREE.MeshPhongMaterial;\n        // Make thrusters more intense with each upgrade\n        material.emissiveIntensity += 0.2;\n\n        // Change thruster color slightly with each upgrade to show progression\n        if (this.engineLevel % 2 === 0) { // Every even level\n          material.emissive.setHex(0xff8800); // More orange\n        } else {\n          material.emissive.setHex(0xffaa00); // More yellow\n        }\n      }\n    });\n\n    // Increase the upgrade level\n    this.engineLevel++;\n\n    // Calculate the new upgrade cost (2.5x the previous cost)\n    this.engineUpgradeCost = Math.floor(this.engineUpgradeCost * 2.5);\n\n    return spaceshipState.maxVelocity;\n  }\n\n  /**\n   * Upgrade the mining laser system\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} New mining efficiency\n   */\n  upgradeMiningLaser(spaceshipState: SpaceshipState): number {\n    console.log(\"Upgrading mining laser\");\n\n    // Increase mining efficiency by 30%\n    spaceshipState.miningEfficiency *= 1.3;\n\n    // Upgrade visual appearance of mining laser emitters\n    if (this.components.leftEmitter && this.components.leftEmitter.material) {\n      // Increase the size of the left emitter\n      this.components.leftEmitter.scale.set(1.1, 1.1, 1.1);\n\n      // Change the color based on level to show progression\n      const colors = [0xff0000, 0xff5500, 0xff9900, 0xffcc00, 0xffee00];\n      const material = this.components.leftEmitter.material as THREE.MeshPhongMaterial;\n      if (this.miningLevel < colors.length) {\n        material.color.setHex(colors[this.miningLevel]);\n        material.emissive.setHex(colors[this.miningLevel]);\n      }\n\n      // Increase the emissive intensity\n      material.emissiveIntensity += 0.2;\n    }\n\n    // Also upgrade the right emitter to match\n    if (this.components.rightEmitter && this.components.rightEmitter.material) {\n      // Increase the size of the right emitter\n      this.components.rightEmitter.scale.set(1.1, 1.1, 1.1);\n\n      // Change the color based on level to show progression\n      const colors = [0xff0000, 0xff5500, 0xff9900, 0xffcc00, 0xffee00];\n      const material = this.components.rightEmitter.material as THREE.MeshPhongMaterial;\n      if (this.miningLevel < colors.length) {\n        material.color.setHex(colors[this.miningLevel]);\n        material.emissive.setHex(colors[this.miningLevel]);\n      }\n\n      // Increase the emissive intensity\n      material.emissiveIntensity += 0.2;\n    }\n\n    // Also update the cannons\n    if (this.components.leftCannon && this.components.leftCannon.material) {\n      // Make the cannons thicker with each upgrade\n      this.components.leftCannon.scale.x *= 1.1;\n      this.components.leftCannon.scale.y *= 1.1;\n    }\n\n    if (this.components.rightCannon && this.components.rightCannon.material) {\n      // Make the cannons thicker with each upgrade\n      this.components.rightCannon.scale.x *= 1.1;\n      this.components.rightCannon.scale.y *= 1.1;\n    }\n\n    // Increase the upgrade level\n    this.miningLevel++;\n\n    // Calculate the new upgrade cost (3x the previous cost)\n    this.miningUpgradeCost = Math.floor(this.miningUpgradeCost * 3);\n\n    return spaceshipState.miningEfficiency;\n  }\n\n  /**\n   * Upgrade the ship's hull armor\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} New collision resistance\n   */\n  upgradeHull(spaceshipState: SpaceshipState): number {\n    console.log(\"Upgrading hull\");\n\n    // Increase collision resistance by 25%\n    spaceshipState.collisionResistance *= 1.25;\n\n    // Modify ship appearance to show hull upgrade\n    if (this.components.mesh) {\n      const bodyGroup = this.components.mesh.children.find(child => child instanceof THREE.Group);\n\n      if (bodyGroup && bodyGroup.children) {\n        // Update both the cylinder and cone parts of the ship body\n        bodyGroup.children.forEach(part => {\n          if (part instanceof THREE.Mesh && part.material) {\n            const material = part.material as THREE.MeshPhongMaterial;\n            // Change the hull color slightly to indicate higher grade material\n            if (this.hullLevel % 2 === 0) {\n              // Even levels: more blue tint\n              material.color.setHex(0x30c0d0);\n            } else {\n              // Odd levels: more green tint\n              material.color.setHex(0x30d0c0);\n            }\n\n            // Increase shininess with each level to suggest better armor\n            material.shininess += 10;\n          }\n        });\n      }\n    }\n\n    // Increase the upgrade level\n    this.hullLevel++;\n\n    // Calculate the new upgrade cost (2x the previous cost)\n    this.hullUpgradeCost = Math.floor(this.hullUpgradeCost * 2);\n\n    return spaceshipState.collisionResistance;\n  }\n\n  /**\n   * Upgrade the ship's scanner system\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} New scanner range\n   */\n  upgradeScanner(spaceshipState: SpaceshipState): number {\n    console.log(\"Upgrading scanner\");\n\n    // Increase scanner range by 20%\n    spaceshipState.scanRange *= 1.2;\n\n    // Add visual indicator for scanner upgrade (could add scan dish or antenna)\n    // This is a simplified version - in a real implementation, you'd want to\n    // add actual mesh components to the ship\n\n    // Increase the upgrade level\n    this.scannerLevel++;\n\n    // Calculate the new upgrade cost (1.8x the previous cost)\n    this.scannerUpgradeCost = Math.floor(this.scannerUpgradeCost * 1.8);\n\n    return spaceshipState.scanRange;\n  }\n\n  /**\n   * Get all upgrade levels for external access\n   * @returns {object} All upgrade levels and costs\n   */\n  getUpgradeLevels(): UpgradeLevels {\n    return {\n      fuelTankLevel: this.fuelTankLevel,\n      fuelUpgradeCost: this.fuelUpgradeCost,\n      engineLevel: this.engineLevel,\n      engineUpgradeCost: this.engineUpgradeCost,\n      miningLevel: this.miningLevel,\n      miningUpgradeCost: this.miningUpgradeCost,\n      hullLevel: this.hullLevel,\n      hullUpgradeCost: this.hullUpgradeCost,\n      scannerLevel: this.scannerLevel,\n      scannerUpgradeCost: this.scannerUpgradeCost\n    };\n  }\n\n  /**\n   * Set upgrade levels from existing data (for loading saves)\n   * @param {object} upgrades Upgrade data to restore\n   */\n  setUpgradeLevels(upgrades: Partial<UpgradeLevels>): void {\n    this.fuelTankLevel = upgrades.fuelTankLevel || 1;\n    this.fuelUpgradeCost = upgrades.fuelUpgradeCost || 1000;\n    this.engineLevel = upgrades.engineLevel || 1;\n    this.engineUpgradeCost = upgrades.engineUpgradeCost || 800;\n    this.miningLevel = upgrades.miningLevel || 1;\n    this.miningUpgradeCost = upgrades.miningUpgradeCost || 1200;\n    this.hullLevel = upgrades.hullLevel || 1;\n    this.hullUpgradeCost = upgrades.hullUpgradeCost || 1500;\n    this.scannerLevel = upgrades.scannerLevel || 1;\n    this.scannerUpgradeCost = upgrades.scannerUpgradeCost || 600;\n  }\n}\n","// docking.ts - Ship docking and undocking systems\n// Extracted from spaceship.js to improve maintainability\n\nimport * as THREE from 'three';\n\ninterface SpaceshipState {\n  isDocked: boolean;\n  velocity: THREE.Vector3;\n  shield: number;\n  maxShield: number;\n  hull: number;\n  maxHull: number;\n}\n\nexport class ShipDocking {\n  mesh: THREE.Group;\n  scene: THREE.Scene;\n  undockLocation: THREE.Vector3;\n\n  constructor(mesh: THREE.Group, scene: THREE.Scene) {\n    this.mesh = mesh;\n    this.scene = scene;\n    this.undockLocation = new THREE.Vector3(0, 10000, 0); // Middle of the stargate\n  }\n\n  /**\n   * Dock the spaceship at the stargate\n   * @param {object} spaceshipState Reference to spaceship state\n   * @param {function} syncCallback Callback to sync values to health component\n   */\n  dock(spaceshipState: SpaceshipState, _syncCallback: () => void): void {\n    console.log(\"Docking spaceship\");\n    console.log(\"Spaceship values before docking:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      isDocked: spaceshipState.isDocked\n    });\n\n    spaceshipState.isDocked = true;\n    spaceshipState.velocity.set(0, 0, 0);\n    this.mesh.visible = false;\n\n    console.log(\"Spaceship values after docking:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      isDocked: spaceshipState.isDocked\n    });\n  }\n\n  /**\n   * Undock the spaceship from the stargate\n   * @param {object} spaceshipState Reference to spaceship state\n   * @param {function} syncCallback Callback to sync values to health component\n   * @returns {THREE.Vector3} New position of the ship\n   */\n  undock(spaceshipState: SpaceshipState, syncCallback: () => void): THREE.Vector3 {\n    console.log(\"Undocking spaceship\");\n    console.log(\"Spaceship values before undocking:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      isDocked: spaceshipState.isDocked\n    });\n\n    // Store shield value before undocking to diagnose reset issue\n    const shieldBeforeUndock = spaceshipState.shield;\n\n    spaceshipState.isDocked = false;\n    this.mesh.visible = true;\n\n    // Check if shield was reset and restore it\n    if (spaceshipState.shield !== shieldBeforeUndock) {\n      console.log(`SHIELD RESET DETECTED during undock! Value changed from ${shieldBeforeUndock} to ${spaceshipState.shield}`);\n      console.log(\"Restoring shield value to:\", shieldBeforeUndock);\n      spaceshipState.shield = shieldBeforeUndock;\n    }\n\n    console.log(\"Spaceship values after undocking:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      isDocked: spaceshipState.isDocked\n    });\n\n    // When undocking, attempt to sync shield and hull values to the HealthComponent\n    if (syncCallback) {\n      syncCallback();\n    }\n\n    // Position the ship based on undock location\n    if (this.undockLocation) {\n      this.mesh.position.copy(this.undockLocation);\n\n      // Point away from the stargate (down toward sun)\n      this.mesh.rotation.set(Math.PI / 2, 0, 0);\n    } else {\n      // Original behavior - position just outside the docking bay\n      const stargate = this.scene.getObjectByName('stargate');\n      if (stargate) {\n        const stargatePosition = stargate.position.clone();\n        stargatePosition.z += 550; // Move in front of the docking bay\n        this.mesh.position.copy(stargatePosition);\n\n        // Reset rotation to face away from the stargate\n        this.mesh.rotation.set(0, Math.PI, 0);\n      }\n    }\n\n    spaceshipState.velocity.set(0, 0, 0); // This line resets velocity, but it's fine since we're undocking\n\n    return this.mesh.position.clone();\n  }\n\n  /**\n   * Set the undocking location\n   * @param {THREE.Vector3} location New undocking position\n   */\n  setUndockLocation(location: THREE.Vector3): void {\n    this.undockLocation = location.clone();\n  }\n\n  /**\n   * Get the current undocking location\n   * @returns {THREE.Vector3} Current undocking position\n   */\n  getUndockLocation(): THREE.Vector3 {\n    return this.undockLocation.clone();\n  }\n}\n","// services.ts - Ship service operations (refuel, repair)\n// Extracted from spaceship.js to improve maintainability\n\ninterface SpaceshipState {\n  fuel: number;\n  maxFuel: number;\n  shield: number;\n  maxShield: number;\n  hull: number;\n  maxHull: number;\n}\n\ninterface ThrustState {\n  forward: boolean;\n  backward: boolean;\n  left: boolean;\n  right: boolean;\n  boost: boolean;\n}\n\nexport class ShipServices {\n  constructor() {\n    // Service operations don't need complex initialization\n  }\n\n  /**\n   * Refuel the spaceship to maximum capacity\n   * @param {object} spaceshipState Reference to spaceship state\n   * @returns {number} Cost of refueling\n   */\n  refuel(spaceshipState: SpaceshipState): number {\n    console.log(\"Refueling spaceship\");\n    spaceshipState.fuel = spaceshipState.maxFuel;\n    return 100; // Cost of refueling\n  }\n\n  /**\n   * Repair the ship's shield system\n   * @param {object} spaceshipState Reference to spaceship state\n   * @param {function} syncCallback Callback to sync values to health component\n   * @returns {number} Cost of shield repair\n   */\n  repairShield(spaceshipState: SpaceshipState, syncCallback: () => void): number {\n    const oldShield = spaceshipState.shield;\n    console.log(`===== SHIELD REPAIR INITIATED =====`);\n    console.log(`Repairing shield: ${oldShield}  ${spaceshipState.maxShield}`);\n\n    // CRITICAL FIX: Set and verify shield repair\n    spaceshipState.shield = spaceshipState.maxShield;\n    console.log(`Shield value is now: ${spaceshipState.shield} (Expected: ${spaceshipState.maxShield})`);\n\n    // Log full spaceship state for debugging\n    console.log(\"Full spaceship state after shield repair:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      fuel: spaceshipState.fuel,\n      maxFuel: spaceshipState.maxFuel\n    });\n    console.log(`===== SHIELD REPAIR COMPLETED =====`);\n\n    // Sync the updated shield value to the player entity's HealthComponent\n    // Use direct entity access for more reliable syncing\n    if ((window as any).game && (window as any).game.world) {\n      try {\n        const players = (window as any).game.world.getEntitiesByTag('player');\n        if (players && players.length > 0) {\n          const health = players[0].getComponent('HealthComponent');\n          if (health) {\n            // Update shield directly on the component\n            const oldHealthShield = health.shield;\n            health.shield = spaceshipState.shield;\n            console.log(`Direct shield update on HealthComponent: ${oldHealthShield}  ${health.shield}`);\n          }\n        }\n      } catch (e) {\n        console.error(\"Error during direct HealthComponent update:\", e);\n      }\n    }\n\n    // Also use the normal sync method\n    if (syncCallback) {\n      syncCallback();\n    }\n\n    return 150; // Cost of shield repair\n  }\n\n  /**\n   * Repair the ship's hull structure\n   * @param {object} spaceshipState Reference to spaceship state\n   * @param {function} syncCallback Callback to sync values to health component\n   * @returns {number} Cost of hull repair\n   */\n  repairHull(spaceshipState: SpaceshipState, syncCallback: () => void): number {\n    const oldHull = spaceshipState.hull;\n    console.log(`===== HULL REPAIR INITIATED =====`);\n    console.log(`Repairing hull: ${oldHull}  ${spaceshipState.maxHull}`);\n\n    // CRITICAL FIX: Set and verify hull repair\n    spaceshipState.hull = spaceshipState.maxHull;\n    console.log(`Hull value is now: ${spaceshipState.hull} (Expected: ${spaceshipState.maxHull})`);\n\n    // Log full spaceship state for debugging\n    console.log(\"Full spaceship state after hull repair:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull,\n      fuel: spaceshipState.fuel,\n      maxFuel: spaceshipState.maxFuel\n    });\n    console.log(`===== HULL REPAIR COMPLETED =====`);\n\n    // Sync the updated hull value to the player entity's HealthComponent\n    // Use direct entity access for more reliable syncing\n    if ((window as any).game && (window as any).game.world) {\n      try {\n        const players = (window as any).game.world.getEntitiesByTag('player');\n        if (players && players.length > 0) {\n          const health = players[0].getComponent('HealthComponent');\n          if (health) {\n            // Update hull directly on the component\n            const oldHealthHull = health.health;\n            health.health = spaceshipState.hull;\n            console.log(`Direct hull update on HealthComponent: ${oldHealthHull}  ${health.health}`);\n          }\n        }\n      } catch (e) {\n        console.error(\"Error during direct HealthComponent update:\", e);\n      }\n    }\n\n    // Also use the normal sync method\n    if (syncCallback) {\n      syncCallback();\n    }\n\n    return 200; // Cost of hull repair\n  }\n\n  /**\n   * Check if fuel consumption is allowed and consume fuel\n   * @param {object} spaceshipState Reference to spaceship state\n   * @param {object} thrustState Current thrust state\n   * @returns {boolean} True if we have fuel, false if empty\n   */\n  consumeFuel(spaceshipState: SpaceshipState, thrustState: ThrustState): boolean {\n    // Consume fuel when thrusting\n    if (thrustState.forward || thrustState.backward || thrustState.left || thrustState.right) {\n      let consumptionRate = 0.01; // spaceshipState.fuelConsumptionRate\n\n      // Extra consumption when boosting\n      if (thrustState.boost) {\n        consumptionRate *= 3;\n      }\n\n      spaceshipState.fuel = Math.max(0, spaceshipState.fuel - consumptionRate);\n    }\n\n    // Return true if we have fuel, false if empty\n    return spaceshipState.fuel > 0;\n  }\n}\n","// visualEffects.ts - Ship visual effects (mining laser, trails)\n// Extracted from spaceship.js to improve maintainability\n\nimport * as THREE from 'three';\nimport { TrailEffects } from '../../trail';\n\n// Accept any object with optional leftEmitter and rightEmitter\ninterface VisualEffectsComponents {\n  leftEmitter?: THREE.Mesh | null;\n  rightEmitter?: THREE.Mesh | null;\n  [key: string]: any;\n}\n\ninterface ThrustState {\n  forward: boolean;\n  backward: boolean;\n  left: boolean;\n  right: boolean;\n  boost: boolean;\n}\n\nexport class ShipVisualEffects {\n  components: VisualEffectsComponents;\n\n  constructor(shipComponents: VisualEffectsComponents) {\n    this.components = shipComponents; // { leftEmitter, rightEmitter }\n  }\n\n  /**\n   * Activate mining laser visual effects\n   */\n  activateMiningLaser(): void {\n    // Activate both emitters for a more powerful effect\n    if (this.components.leftEmitter && this.components.rightEmitter) {\n      // Left emitter\n      const leftMaterial = this.components.leftEmitter.material as THREE.MeshPhongMaterial;\n      if (leftMaterial) {\n        leftMaterial.emissiveIntensity = 1.5;\n      }\n      this.components.leftEmitter.scale.set(1.2, 1.2, 1.2);\n\n      // Right emitter\n      const rightMaterial = this.components.rightEmitter.material as THREE.MeshPhongMaterial;\n      if (rightMaterial) {\n        rightMaterial.emissiveIntensity = 1.5;\n      }\n      this.components.rightEmitter.scale.set(1.2, 1.2, 1.2);\n    }\n  }\n\n  /**\n   * Deactivate mining laser visual effects\n   */\n  deactivateMiningLaser(): void {\n    // Deactivate both emitters\n    if (this.components.leftEmitter && this.components.rightEmitter) {\n      // Left emitter\n      const leftMaterial = this.components.leftEmitter.material as THREE.MeshPhongMaterial;\n      if (leftMaterial) {\n        leftMaterial.emissiveIntensity = 1;\n      }\n      this.components.leftEmitter.scale.set(1, 1, 1);\n\n      // Right emitter\n      const rightMaterial = this.components.rightEmitter.material as THREE.MeshPhongMaterial;\n      if (rightMaterial) {\n        rightMaterial.emissiveIntensity = 1;\n      }\n      this.components.rightEmitter.scale.set(1, 1, 1);\n    }\n  }\n\n  /**\n   * Update trail visibility based on movement\n   * @param {boolean} isMoving Whether the ship is currently moving\n   * @param {object} thrustState Current thrust state\n   * @param {THREE.Vector3} velocity Current velocity\n   * @param {object} trailEffects Trail effects instance\n   */\n  updateTrailVisibility(isMoving: boolean, thrustState: ThrustState, velocity: THREE.Vector3, trailEffects: TrailEffects | null): void {\n    // Delegate to trail effects module\n    if (trailEffects) {\n      trailEffects.updateTrailVisibility(isMoving, thrustState, velocity);\n    }\n  }\n\n  /**\n   * Update particle effects\n   * @param {object} thrustState Current thrust state\n   * @param {THREE.Vector3} velocity Current velocity\n   * @param {object} trailEffects Trail effects instance\n   */\n  updateParticles(thrustState: ThrustState, velocity: THREE.Vector3, trailEffects: TrailEffects | null): void {\n    // Delegate to trail effects module\n    if (trailEffects) {\n      trailEffects.updateParticles(thrustState, velocity);\n    }\n  }\n}\n","// healthSync.ts - ECS health component synchronization\n// Extracted from spaceship.js to improve maintainability\n\ninterface SpaceshipState {\n  shield: number;\n  maxShield: number;\n  hull: number;\n  maxHull: number;\n}\n\ninterface MessageBusEvent {\n  data: {\n    entity: any;\n  };\n}\n\nexport class HealthSync {\n  constructor() {\n    // Health sync doesn't need complex initialization\n  }\n\n  /**\n   * Subscribe to player entity destruction events\n   * @param {MessageBus} messageBus The game's message bus\n   * @param {function} destructionCallback Callback when player is destroyed\n   */\n  subscribeToDestructionEvents(messageBus: any, destructionCallback: (hull: number, shield: number) => void): void {\n    if (!messageBus) return;\n\n    messageBus.subscribe('entity.destroyed', (message: MessageBusEvent) => {\n      const entity = message.data.entity;\n\n      // Check if this is the player entity\n      if (entity && entity.hasTag && entity.hasTag('player')) {\n        console.log(\"Player entity destroyed - updating spaceship state\");\n\n        // Get health component data\n        const healthComponent = entity.getComponent('HealthComponent');\n        let hull = 0;\n        let shield = 0;\n\n        if (healthComponent) {\n          hull = healthComponent.health;\n          shield = healthComponent.shield;\n        } else {\n          // If no health component, just set to 0\n          hull = 0;\n          shield = 0;\n        }\n\n        // Call destruction callback with updated values\n        destructionCallback(hull, shield);\n      }\n    });\n\n    console.log(\"Spaceship subscribed to destruction events\");\n  }\n\n  /**\n   * Method to sync hull and shield values to the player entity's HealthComponent\n   * @param {object} spaceshipState Current spaceship state\n   */\n  syncValuesToHealthComponent(spaceshipState: SpaceshipState): void {\n    console.log(\"Beginning shield and hull sync to HealthComponent\");\n\n    console.log(\"Current spaceship values:\", {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull\n    });\n\n    // Store the values that need to be synced to the HealthComponent\n    const valuesForSync = {\n      shield: spaceshipState.shield,\n      maxShield: spaceshipState.maxShield,\n      hull: spaceshipState.hull,\n      maxHull: spaceshipState.maxHull\n    };\n\n    console.log(`Preparing to sync values to player HealthComponent: Shield=${spaceshipState.shield}, Hull=${spaceshipState.hull}`);\n\n    // Try using the MessageBus to broadcast the sync event\n    try {\n      if ((window as any).game && (window as any).game.messageBus) {\n        // Use the message bus to publish a sync event for any interested components\n        (window as any).game.messageBus.publish('player.syncHealth', valuesForSync);\n        console.log(\"Published player.syncHealth event to game.messageBus with values:\", valuesForSync);\n      } else if ((window as any).mainMessageBus) {\n        // Try using the global message bus\n        (window as any).mainMessageBus.publish('player.syncHealth', valuesForSync);\n        console.log(\"Published player.syncHealth event to mainMessageBus with values:\", valuesForSync);\n      } else {\n        console.warn(\"No message bus available to sync health values\");\n      }\n    } catch (e) {\n      console.error(\"Error publishing sync event:\", e);\n    }\n\n    // Also try direct access as a fallback\n    try {\n      if ((window as any).game && (window as any).game.world) {\n        const players = (window as any).game.world.getEntitiesByTag('player');\n        console.log(`Found ${players ? players.length : 0} player entities for direct sync`);\n\n        if (players && players.length > 0) {\n          const player = players[0];\n          const health = player.getComponent('HealthComponent');\n\n          if (health) {\n            // Log pre-sync state\n            console.log(\"DIRECT SYNC - HealthComponent before sync:\", {\n              shield: health.shield,\n              maxShield: health.maxShield,\n              health: health.health,\n              maxHealth: health.maxHealth\n            });\n\n            console.log(\"DIRECT SYNC - Spaceship values to sync:\", {\n              shield: spaceshipState.shield,\n              maxShield: spaceshipState.maxShield,\n              hull: spaceshipState.hull,\n              maxHull: spaceshipState.maxHull\n            });\n\n            // Sync shield value\n            const oldShield = health.shield;\n            health.shield = spaceshipState.shield;\n            health.maxShield = spaceshipState.maxShield;\n\n            // Sync hull value\n            const oldHealth = health.health;\n            health.health = spaceshipState.hull;\n            health.maxHealth = spaceshipState.maxHull;\n\n            console.log(`Directly synced values to HealthComponent: Shield ${oldShield}  ${health.shield}, Hull ${oldHealth}  ${health.health}`);\n\n            // Verify sync was successful\n            console.log(\"DIRECT SYNC - HealthComponent after sync:\", {\n              shield: health.shield,\n              maxShield: health.maxShield,\n              health: health.health,\n              maxHealth: health.maxHealth\n            });\n          } else {\n            console.warn(\"Player entity found but has no HealthComponent\");\n          }\n        } else {\n          console.warn(\"No player entities found for direct sync\");\n        }\n      }\n    } catch (e) {\n      console.error(\"Error directly syncing values to HealthComponent:\", e);\n    }\n  }\n}\n","// spaceship.ts - Main spaceship class with delegation to specialized modules\n// Refactored to improve maintainability and reduce file size\n\nimport * as THREE from 'three';\nimport { TrailEffects } from '../trail';\nimport { ShipModel } from './model/shipModel';\nimport { ShipUpgrades } from './systems/upgrades';\nimport { ShipDocking } from './systems/docking';\nimport { ShipServices } from './systems/services';\nimport { ShipVisualEffects } from './effects/visualEffects';\nimport { HealthSync } from './sync/healthSync';\n\ninterface ThrustState {\n  forward: boolean;\n  backward: boolean;\n  left: boolean;\n  right: boolean;\n  boost: boolean;\n}\n\ninterface CargoState {\n  iron: number;\n  gold: number;\n  platinum: number;\n}\n\nexport class Spaceship {\n  scene: THREE.Scene;\n  mesh: THREE.Group | null;\n  thrusters: Array<{ mesh: THREE.Mesh; type: string }>;\n  leftCannon: THREE.Mesh | null;\n  rightCannon: THREE.Mesh | null;\n  leftEmitter: THREE.Mesh | null;\n  rightEmitter: THREE.Mesh | null;\n  miningLaser: THREE.Mesh | null;\n  velocity: THREE.Vector3;\n  rotation: THREE.Euler;\n  thrust: ThrustState;\n  thrustPower: number;\n  strafePower: number;\n  trailEffects: TrailEffects | null;\n  shipScale: number;\n\n  // Combat properties\n  hull: number;\n  maxHull: number;\n  shield: number;\n  maxShield: number;\n  isDestroyed: boolean;\n\n  // Docking and fuel properties\n  fuel: number;\n  maxFuel: number;\n  fuelConsumptionRate: number;\n  isDocked: boolean;\n  credits: number;\n\n  // Cargo\n  cargo: CargoState;\n\n  // Ship capabilities\n  maxVelocity: number;\n  miningEfficiency: number;\n  collisionResistance: number;\n  scanRange: number;\n  deployableLaserCount: number;\n\n  // Specialized modules\n  shipModel!: ShipModel;\n  shipUpgrades!: ShipUpgrades | null;\n  shipDocking!: ShipDocking | null;\n  shipServices!: ShipServices;\n  shipVisualEffects!: ShipVisualEffects | null;\n  healthSync!: HealthSync;\n\n  constructor(scene: THREE.Scene) {\n    this.scene = scene;\n    this.mesh = null;\n    this.thrusters = [];\n    this.leftCannon = null;\n    this.rightCannon = null;\n    this.leftEmitter = null;\n    this.rightEmitter = null;\n    this.miningLaser = null;\n    this.velocity = new THREE.Vector3(0, 0, 0);\n    this.rotation = new THREE.Euler(0, 0, 0);\n    this.thrust = {\n      forward: false,\n      backward: false,\n      left: false,\n      right: false,\n      boost: false\n    };\n    this.thrustPower = 0;\n    this.strafePower = 0;\n    this.trailEffects = null;\n    this.shipScale = 2.0;\n\n    // Combat properties\n    this.hull = 100;\n    this.maxHull = 100;\n    this.shield = 50;\n    this.maxShield = 50;\n    this.isDestroyed = false;\n\n    // Docking and fuel properties\n    this.fuel = 100;\n    this.maxFuel = 100;\n    this.fuelConsumptionRate = 0.01;\n    this.isDocked = true;\n    this.credits = 1000;\n\n    // Initialize cargo (empty by default)\n    this.cargo = {\n      iron: 0,\n      gold: 0,\n      platinum: 0\n    };\n\n    // Ship capabilities\n    this.maxVelocity = 25.0;\n    this.miningEfficiency = 1.0;\n    this.collisionResistance = 1.0;\n    this.scanRange = 1000;\n    this.deployableLaserCount = 0;\n\n    // Initialize specialized modules\n    this._initializeModules();\n\n    this.createSpaceship();\n\n    // Initialize trail effects after spaceship mesh is created\n    if (this.mesh) {\n      this.trailEffects = new TrailEffects(this.scene, this.mesh as THREE.Group);\n      // Start the ship invisible since it's docked\n      (this.mesh as THREE.Group).visible = false;\n    }\n  }\n\n  /**\n   * Initialize specialized modules for different aspects of the ship\n   */\n  private _initializeModules(): void {\n    // Model creation module\n    this.shipModel = new ShipModel(this.scene, this.shipScale);\n\n    // These will be initialized after mesh creation\n    this.shipUpgrades = null;\n    this.shipDocking = null;\n    this.shipServices = new ShipServices();\n    this.shipVisualEffects = null;\n    this.healthSync = new HealthSync();\n  }\n\n  /**\n   * Create the spaceship using the model module\n   */\n  createSpaceship(): void {\n    this.mesh = this.shipModel.createSpaceship();\n    const components = this.shipModel.getComponents();\n\n    // Store component references\n    this.thrusters = components.thrusters;\n    this.leftCannon = components.leftCannon ?? null;\n    this.rightCannon = components.rightCannon ?? null;\n    this.leftEmitter = components.leftEmitter ?? null;\n    this.rightEmitter = components.rightEmitter ?? null;\n    this.miningLaser = components.miningLaser ?? null;\n\n    // Initialize modules that need mesh components\n    this.shipUpgrades = new ShipUpgrades(components);\n    if (this.mesh) {\n      this.shipDocking = new ShipDocking(this.mesh, this.scene);\n    }\n    this.shipVisualEffects = new ShipVisualEffects(components);\n  }\n\n  // Methods for updating spaceship state in game loop\n  update(_deltaTime: number): void {\n    // Update any continuous effects or animations\n    if (this.updateParticles && !this.isDocked) {\n      this.updateParticles();\n    }\n  }\n\n  // VISUAL EFFECTS - Delegate to visual effects module\n  activateMiningLaser(): void {\n    this.shipVisualEffects?.activateMiningLaser();\n  }\n\n  deactivateMiningLaser(): void {\n    this.shipVisualEffects?.deactivateMiningLaser();\n  }\n\n  updateParticles(): void {\n    this.shipVisualEffects?.updateParticles(this.thrust, this.velocity, this.trailEffects);\n  }\n\n  updateTrailVisibility(isMoving: boolean): void {\n    this.shipVisualEffects?.updateTrailVisibility(isMoving, this.thrust, this.velocity, this.trailEffects);\n  }\n\n  // DOCKING OPERATIONS - Delegate to docking module\n  dock(): void {\n    this.shipDocking?.dock(this, this.syncValuesToHealthComponent.bind(this));\n  }\n\n  undock(): THREE.Vector3 | undefined {\n    return this.shipDocking?.undock(this, this.syncValuesToHealthComponent.bind(this));\n  }\n\n  // SERVICE OPERATIONS - Delegate to services module\n  refuel(): number | undefined {\n    return this.shipServices.refuel(this);\n  }\n\n  repairShield(): number | undefined {\n    return this.shipServices.repairShield(this, this.syncValuesToHealthComponent.bind(this));\n  }\n\n  repairHull(): number | undefined {\n    return this.shipServices.repairHull(this, this.syncValuesToHealthComponent.bind(this));\n  }\n\n  consumeFuel(): boolean | undefined {\n    return this.shipServices.consumeFuel(this, this.thrust);\n  }\n\n  // UPGRADE OPERATIONS - Delegate to upgrades module\n  upgradeFuelTank(): number | undefined {\n    return this.shipUpgrades?.upgradeFuelTank(this);\n  }\n\n  upgradeEngine(): number | undefined {\n    return this.shipUpgrades?.upgradeEngine(this);\n  }\n\n  upgradeMiningLaser(): number | undefined {\n    return this.shipUpgrades?.upgradeMiningLaser(this);\n  }\n\n  upgradeHull(): number | undefined {\n    return this.shipUpgrades?.upgradeHull(this);\n  }\n\n  upgradeScanner(): number | undefined {\n    return this.shipUpgrades?.upgradeScanner(this);\n  }\n\n  // Upgrade level access methods\n  get fuelTankLevel(): number {\n    return this.shipUpgrades?.fuelTankLevel || 1;\n  }\n\n  get fuelUpgradeCost(): number {\n    return this.shipUpgrades?.fuelUpgradeCost || 1000;\n  }\n\n  get engineLevel(): number {\n    return this.shipUpgrades?.engineLevel || 1;\n  }\n\n  get engineUpgradeCost(): number {\n    return this.shipUpgrades?.engineUpgradeCost || 800;\n  }\n\n  get miningLevel(): number {\n    return this.shipUpgrades?.miningLevel || 1;\n  }\n\n  get miningUpgradeCost(): number {\n    return this.shipUpgrades?.miningUpgradeCost || 1200;\n  }\n\n  get hullLevel(): number {\n    return this.shipUpgrades?.hullLevel || 1;\n  }\n\n  get hullUpgradeCost(): number {\n    return this.shipUpgrades?.hullUpgradeCost || 1500;\n  }\n\n  get scannerLevel(): number {\n    return this.shipUpgrades?.scannerLevel || 1;\n  }\n\n  get scannerUpgradeCost(): number {\n    return this.shipUpgrades?.scannerUpgradeCost || 600;\n  }\n\n  // HEALTH SYNCHRONIZATION - Delegate to health sync module\n  subscribeToDestructionEvents(messageBus: any): void {\n    this.healthSync.subscribeToDestructionEvents(messageBus, this.handleDestruction.bind(this));\n  }\n\n  syncValuesToHealthComponent(): void {\n    this.healthSync.syncValuesToHealthComponent(this);\n  }\n\n  /**\n   * Handle ship destruction effects\n   */\n  handleDestruction(hull: number, shield: number): void {\n    this.isDestroyed = true;\n    this.hull = hull;\n    this.shield = shield;\n\n    // Visual and behavioral changes for destroyed state\n    if (this.mesh) {\n      // Disable thrusters via trail effects\n      if (this.trailEffects && (this.trailEffects as any).particleSystems) {\n        (this.trailEffects as any).particleSystems.forEach((ps: any) => {\n          if (ps && ps.system) {\n            ps.system.visible = false;\n          }\n        });\n      }\n    }\n  }\n\n  // POSITION AND ROTATION ACCESS (for external systems)\n  get position(): THREE.Vector3 {\n    return this.mesh ? this.mesh.position : new THREE.Vector3(0, 0, 0);\n  }\n\n  set position(newPosition: THREE.Vector3) {\n    if (this.mesh) {\n      this.mesh.position.copy(newPosition);\n    }\n  }\n\n  // UNDOCK LOCATION ACCESS\n  get undockLocation(): THREE.Vector3 {\n    return this.shipDocking?.getUndockLocation() || new THREE.Vector3(0, 10000, 0);\n  }\n\n  set undockLocation(location: THREE.Vector3) {\n    if (this.shipDocking) {\n      this.shipDocking.setUndockLocation(location);\n    }\n  }\n}\n","// physics.ts - Handles physics calculations and movement\n\nimport * as THREE from 'three';\nimport { DEBUG_MODE } from '../globals/debug.ts';\nimport { mainMessageBus } from '../globals/messageBus.ts';\n\n// Type definitions for physics-related objects\ninterface RotationState {\n    x: number;\n    y: number;\n}\n\ninterface ThrustState {\n    forward: boolean;\n    backward: boolean;\n    left: boolean;\n    right: boolean;\n    boost: boolean;\n}\n\ninterface TrailEffects {\n    updateTrailVisibility(isMoving: boolean, thrust: ThrustState, velocity: THREE.Vector3): void;\n    updateParticles(thrust: ThrustState, velocity: THREE.Vector3): void;\n}\n\ninterface Spaceship {\n    mesh: THREE.Object3D;\n    velocity: THREE.Vector3;\n    thrust: ThrustState;\n    isDestroyed: boolean;\n    isDocked: boolean;\n    collisionResistance: number;\n    maxVelocity?: number;\n    trailEffects: TrailEffects | null;\n    consumeFuel(): boolean;\n}\n\ntype CollisionType = \"asteroid\" | \"planet\" | \"sun\";\n\ninterface AsteroidData {\n    mesh: THREE.Mesh;\n}\n\ninterface AsteroidBeltUserData {\n    asteroids: AsteroidData[];\n}\n\nexport class Physics {\n    // Physics constants - significantly increased for super-fast movement\n    static THRUST_FORCE = 0.5;      // 5x increase from previous 0.1\n    static BOOST_MULTIPLIER = 4;    // Keep the same boost multiplier\n    static MAX_VELOCITY = 25.0;     // Default maximum velocity (will use spaceship's value if available)\n    static ROTATION_SPEED = 0.3;    // Increased for more responsive controls\n    static COLLISION_DISTANCE = 15; // Reduced from 70 to match actual ship size\n    static FRICTION = 0.01;         // Small friction to help with control (new)\n\n    // Camera constants for smooth following\n    static CAMERA_LAG = 0.1;        // Smoothing factor (0.08-0.15, lower = smoother/slower)\n    static CAMERA_BASE_OFFSET = new THREE.Vector3(0, 5, 25); // Base camera offset\n    static CAMERA_VELOCITY_SCALE = 0.3; // How much velocity affects camera distance (0.3 = +30% at max speed)\n    static CAMERA_LOOKAHEAD_SCALE = 20; // Max look-ahead distance based on velocity\n\n    // Camera shake constants\n    static SHAKE_DECAY = 0.95;      // How fast shake decays per frame (0.95 = 5% per frame)\n    static SHAKE_FREQUENCY = 15.0;  // Frequency for shake oscillation\n\n    // Camera recoil constants\n    static RECOIL_DECAY = 0.85;      // How fast recoil decays per frame (0.85 = 15% per frame)\n    static RECOIL_FREQUENCY = 20.0;  // Frequency for recoil oscillation\n    static RECOIL_DURATION = 0.05;   // Duration of the initial recoil impulse in seconds\n    static RECOIL_MAX_INTENSITY_PROJECTILE = 0.1; // Max recoil for projectile weapons\n    static RECOIL_MAX_INTENSITY_LASER = 0.2;      // Max recoil for laser weapons\n    static RECOIL_MAX_INTENSITY_HEAVY = 0.5;      // Max recoil for heavy weapons\n\n    // Camera zoom constants\n    static ZOOM_BOOST_MULTIPLIER = 1.3;  // Zoom out when boosting (1.3x = 30% zoom out)\n    static ZOOM_LERP_SPEED = 0.05;       // Smooth transition speed for zoom (0.05 = moderate smoothness)\n\n    scene: THREE.Scene;\n    spaceship: Spaceship | null;\n    camera: THREE.Camera | null;\n    rotationState: RotationState;\n    collided: boolean;\n    raycaster: THREE.Raycaster;\n    direction: THREE.Vector3;\n    collisionDistance: number;\n    normalizedDeltaTime: number = 0;\n\n    // Camera shake state\n    shakeIntensity: number = 0;     // Current shake strength (0-1)\n    shakeTime: number = 0;          // Time accumulator for shake oscillation\n\n    // Camera recoil state\n    recoilIntensity: number = 0;    // Current recoil strength (0-1)\n    recoilTime: number = 0;         // Time accumulator for recoil oscillation\n    recoilDirection: THREE.Vector3 = new THREE.Vector3(); // Direction of recoil (opposite to firing)\n\n    // Camera zoom state\n    currentZoom: number = 1.0;      // Current zoom multiplier (1.0 = normal, 1.3 = zoomed out)\n    targetZoom: number = 1.0;       // Target zoom multiplier for smooth interpolation\n    \n    constructor(scene: THREE.Scene) {\n        this.scene = scene;\n        this.spaceship = null; // Will be set later\n        this.camera = null; // Will be set later\n\n        // Virtual rotation state for pointer lock\n        this.rotationState = {\n            x: 0,\n            y: 0\n        };\n\n        // Collision state\n        this.collided = false;\n\n        // For collision detection\n        this.raycaster = new THREE.Raycaster();\n        this.direction = new THREE.Vector3(0, 0, -1);\n        this.collisionDistance = Physics.COLLISION_DISTANCE; // Use the class constant for consistency\n\n        // Subscribe to combat events for camera shake\n        this.subscribeToEvents();\n    }\n\n    /**\n     * Subscribe to combat events to trigger camera shake\n     */\n    private subscribeToEvents(): void {\n        // Player damaged - medium shake\n        mainMessageBus.subscribe('player.damaged', () => {\n            this.triggerShake(0.5, 0.2);\n        });\n\n        // Entity destroyed - small shake (covers enemies and asteroids)\n        mainMessageBus.subscribe('entity.destroyed', () => {\n            this.triggerShake(0.3, 0.15);\n        });\n\n        // Explosion VFX - large shake\n        mainMessageBus.subscribe('vfx.explosion', () => {\n            this.triggerShake(0.8, 0.3);\n        });\n\n        // Weapon fire - trigger camera recoil\n        mainMessageBus.subscribe('weapon.fire', (message: any) => {\n            const { type, direction } = message.data || {};\n            let intensity = 0;\n            switch (type) {\n                case 'projectile':\n                    intensity = Physics.RECOIL_MAX_INTENSITY_PROJECTILE;\n                    break;\n                case 'laser':\n                    intensity = Physics.RECOIL_MAX_INTENSITY_LASER;\n                    break;\n                case 'heavy':\n                    intensity = Physics.RECOIL_MAX_INTENSITY_HEAVY;\n                    break;\n                default:\n                    intensity = Physics.RECOIL_MAX_INTENSITY_PROJECTILE;\n            }\n            if (direction) {\n                this.triggerRecoil(intensity, direction);\n            }\n        });\n    }\n\n    /**\n     * Trigger camera shake effect\n     * @param intensity Shake strength (0-1)\n     * @param duration Duration in seconds\n     */\n    triggerShake(intensity: number, _duration: number): void {\n        // Use maximum intensity if multiple shakes occur simultaneously\n        this.shakeIntensity = Math.max(this.shakeIntensity, intensity);\n        // Don't reset time - let it continue for organic motion\n    }\n\n    /**\n     * Trigger camera recoil effect\n     * @param intensity Recoil strength (0-1)\n     * @param direction Direction of the recoil (e.g., opposite to firing)\n     */\n    triggerRecoil(intensity: number, direction: THREE.Vector3): void {\n        this.recoilIntensity = Math.max(this.recoilIntensity, intensity);\n        this.recoilTime = 0; // Reset time to start recoil animation from beginning\n        this.recoilDirection.copy(direction).negate(); // Store opposite of firing direction\n    }\n    \n    // Set spaceship reference\n    setSpaceship(spaceship: Spaceship): void {\n        this.spaceship = spaceship;\n    }\n    \n    // Set camera reference\n    setCamera(camera: THREE.Camera): void {\n        this.camera = camera;\n    }\n    \n    update(deltaTime: number): void {\n        if (!this.spaceship || this.spaceship.isDestroyed) return;\n        \n        // Check if ship is docked - skip physics if docked\n        if (this.spaceship.isDocked) return;\n        \n        // Skip physics updates if intro sequence is active\n        if (window.game && (window.game as { introSequenceActive?: boolean }).introSequenceActive) {\n            return;\n        }\n        \n        // Use a normalized deltaTime to standardize physics at 60 FPS feel\n        // This is the key to frame rate independence\n        this.normalizedDeltaTime = deltaTime * 60;\n        \n        // Check if we have fuel\n        const hasFuel = this.spaceship.consumeFuel();\n        \n        // Apply thrust based on controls - only if we have fuel\n        let thrustVector = new THREE.Vector3(0, 0, 0);\n        let isThrusting = false;\n        \n        // Get the ship's forward direction\n        const shipForward = new THREE.Vector3(0, 0, -1);\n        shipForward.applyQuaternion(this.spaceship.mesh.quaternion);\n        \n        // Calculate dot product to determine how much we're moving forward\n        const forwardVelocity = shipForward.dot(this.spaceship.velocity);\n        void forwardVelocity; // Suppress unused variable warning\n        \n        // Visual effects are now handled entirely by the trail module\n        // Physics only handles movement calculations\n        \n        if (hasFuel) {\n            // NOTE: Player authority migrating to ECS. Respect global inputIntent when available.\n            const intent = window.inputIntent;\n\n            // Determine input source and compute thrust state without circular dependency\n            let forwardPressed: boolean;\n            let backwardPressed: boolean;\n            let leftPressed: boolean;\n            let rightPressed: boolean;\n            let boostPressed: boolean;\n\n            if (intent !== undefined) {\n                // Keyboard input system is active - use inputIntent exclusively (even if 0)\n                forwardPressed = (intent & 1) !== 0;\n                backwardPressed = (intent & 2) !== 0;\n                leftPressed = (intent & 4) !== 0;\n                rightPressed = (intent & 8) !== 0;\n                boostPressed = (intent & 16) !== 0;\n            } else {\n                // Keyboard input not initialized - use gamepad/touch thrust values\n                forwardPressed = this.spaceship.thrust.forward;\n                backwardPressed = this.spaceship.thrust.backward;\n                leftPressed = this.spaceship.thrust.left;\n                rightPressed = this.spaceship.thrust.right;\n                boostPressed = this.spaceship.thrust.boost;\n            }\n\n            // Synchronize spaceship.thrust with input state for audio system\n            this.spaceship.thrust.forward = forwardPressed;\n            this.spaceship.thrust.backward = backwardPressed;\n            this.spaceship.thrust.left = leftPressed;\n            this.spaceship.thrust.right = rightPressed;\n            this.spaceship.thrust.boost = boostPressed;\n\n            // Update zoom target based on boost state\n            this.targetZoom = boostPressed ? Physics.ZOOM_BOOST_MULTIPLIER : 1.0;\n\n            // Forward thrust handling\n            if (forwardPressed) {\n                isThrusting = true;\n                const forwardThrust = new THREE.Vector3(0, 0, -Physics.THRUST_FORCE);\n                if (boostPressed) forwardThrust.multiplyScalar(Physics.BOOST_MULTIPLIER);\n                thrustVector.add(forwardThrust);\n                \n                // Visual effects handled by trail module\n            }\n            // Visual effects handled by trail module\n            \n            // Backward thrust handling\n            if (backwardPressed) {\n                isThrusting = true;\n                thrustVector.add(new THREE.Vector3(0, 0, Physics.THRUST_FORCE));\n                \n                // Visual effects handled by trail module\n            }\n            // Visual effects handled by trail module\n            \n            // Left thrust handling - A key pressed, move LEFT (negative X)\n            if (leftPressed) {\n                isThrusting = true;\n                thrustVector.add(new THREE.Vector3(-Physics.THRUST_FORCE, 0, 0));\n                \n                // Visual effects handled by trail module\n            }\n            // Visual effects handled by trail module\n            \n            // Right thrust handling - D key pressed, move RIGHT (positive X)\n            if (rightPressed) {\n                isThrusting = true;\n                thrustVector.add(new THREE.Vector3(Physics.THRUST_FORCE, 0, 0));\n                \n                // Visual effects handled by trail module\n            }\n            // Visual effects handled by trail module\n            \n            if (isThrusting) {\n                // Apply thrust in world space (only if actively thrusting)\n                thrustVector.applyQuaternion(this.spaceship.mesh.quaternion);\n                \n                // Apply thrust scaled by normalized delta time\n                thrustVector.multiplyScalar(this.normalizedDeltaTime);\n                this.spaceship.velocity.add(thrustVector);\n                \n                // Get the current max velocity from the spaceship\n                const maxVelocity = this.getMaxVelocity();\n                \n                // Cap velocity at maximum speed\n                if (this.spaceship.velocity.length() > maxVelocity) {\n                    this.spaceship.velocity.normalize().multiplyScalar(maxVelocity);\n                }\n            }\n        } else {\n            // No fuel - reset all thrust states for audio system\n            this.spaceship.thrust.forward = false;\n            this.spaceship.thrust.backward = false;\n            this.spaceship.thrust.left = false;\n            this.spaceship.thrust.right = false;\n            this.spaceship.thrust.boost = false;\n        }\n\n        // Add a small amount of \"space friction\" to make controls more manageable\n        // This isn't realistic physics but makes the game more enjoyable to play\n        if (!isThrusting && this.spaceship.velocity.length() > 0) {\n            const friction = Physics.FRICTION * this.normalizedDeltaTime;\n            if (this.spaceship.velocity.length() > friction) {\n                this.spaceship.velocity.multiplyScalar(1 - friction);\n            } else {\n                this.spaceship.velocity.set(0, 0, 0);\n            }\n        }\n        \n        // CRITICAL: Always update position based on current velocity (Newton's first law)\n        // Objects in motion stay in motion unless acted upon by a force\n        // Scale position update by normalized delta time\n        const positionDelta = this.spaceship.velocity.clone().multiplyScalar(this.normalizedDeltaTime);\n        this.spaceship.mesh.position.add(positionDelta);\n        \n        // Apply rotation based on rotationState\n        this.updateShipRotation();\n        \n        // Update camera position\n        this.updateCamera();\n        \n        // Update trail effects based on movement and thrust\n        if (this.spaceship.trailEffects) {\n            // Show effects based on ANY thrust or movement\n            const isMoving = this.spaceship.velocity.length() > 0.1;\n            \n            // Update trail effects directly\n            this.spaceship.trailEffects.updateTrailVisibility(isMoving, this.spaceship.thrust, this.spaceship.velocity);\n            this.spaceship.trailEffects.updateParticles(this.spaceship.thrust, this.spaceship.velocity);\n        }\n        \n        // Check for collisions with asteroids and planets\n        this.checkCollisions();\n    }\n    \n    // Helper method to get the max velocity from the spaceship or use the default\n    getMaxVelocity(): number {\n        return this.spaceship && this.spaceship.maxVelocity \n            ? this.spaceship.maxVelocity \n            : Physics.MAX_VELOCITY;\n    }\n    \n    updateShipRotation(): void {\n        if (!this.spaceship) return;\n        \n        // Cap y rotation to prevent flipping over (optional, can be adjusted or removed)\n        const maxY = Math.PI * 0.45; // Limit to ~45 degrees up/down\n        this.rotationState.y = Math.max(Math.min(this.rotationState.y, maxY), -maxY);\n        \n        // Create a quaternion for rotation\n        const euler = new THREE.Euler(this.rotationState.y, this.rotationState.x, 0, 'YXZ');\n        const targetQuaternion = new THREE.Quaternion().setFromEuler(euler);\n        \n        // Smoothly interpolate current rotation to target rotation\n        // Use rotation speed scaled by normalized delta time\n        this.spaceship.mesh.quaternion.slerp(targetQuaternion, Physics.ROTATION_SPEED * this.normalizedDeltaTime);\n    }\n    \n    updateCamera(): void {\n        if (!this.spaceship || !this.camera) return;\n\n        // Skip camera updates if intro sequence is active\n        if (window.game && (window.game as { introSequenceActive?: boolean }).introSequenceActive) {\n            console.log(\"Skipping camera update - intro sequence active\");\n            return;\n        }\n\n        // Update the camera to follow the spaceship with smooth damping and velocity-based offset\n\n        // Smoothly interpolate current zoom toward target zoom\n        this.currentZoom += (this.targetZoom - this.currentZoom) * Physics.ZOOM_LERP_SPEED;\n\n        // Calculate velocity magnitude (0-1 normalized)\n        const maxVelocity = this.spaceship.maxVelocity || Physics.MAX_VELOCITY;\n        const velocityMagnitude = this.spaceship.velocity.length();\n        const velocityNormalized = Math.min(velocityMagnitude / maxVelocity, 1.0);\n\n        // Scale camera offset based on velocity (pull back when moving fast)\n        const velocityScale = 1.0 + (velocityNormalized * Physics.CAMERA_VELOCITY_SCALE);\n        const cameraOffset = Physics.CAMERA_BASE_OFFSET.clone()\n            .multiplyScalar(velocityScale)\n            .multiplyScalar(this.currentZoom);  // Apply zoom multiplier to increase distance when boosting\n\n        // Apply spaceship rotation to camera offset\n        const rotatedOffset = cameraOffset.clone();\n        rotatedOffset.applyQuaternion(this.spaceship.mesh.quaternion);\n\n        // Calculate target camera position\n        const targetPosition = new THREE.Vector3().copy(this.spaceship.mesh.position).add(rotatedOffset);\n\n        // Smoothly interpolate camera position (damping)\n        this.camera.position.lerp(targetPosition, Physics.CAMERA_LAG);\n\n        // Apply camera shake if active\n        if (this.shakeIntensity > 0.01) {\n            this.applyShake();\n        }\n\n        // Apply camera recoil if active\n        if (this.recoilIntensity > 0.01) {\n            this.applyRecoil();\n        }\n\n        // Calculate velocity-based look-ahead point\n        const velocityDirection = this.spaceship.velocity.clone().normalize();\n        const lookAheadOffset = velocityDirection.multiplyScalar(velocityNormalized * Physics.CAMERA_LOOKAHEAD_SCALE);\n\n        // Look ahead of the spaceship in movement direction\n        const baseLookAt = new THREE.Vector3(0, 0, -60); // Base forward look point\n        baseLookAt.applyQuaternion(this.spaceship.mesh.quaternion);\n\n        const lookAtPoint = new THREE.Vector3()\n            .copy(this.spaceship.mesh.position)\n            .add(baseLookAt)\n            .add(lookAheadOffset);\n\n        this.camera.lookAt(lookAtPoint);\n\n        // Force visible frustum (debugging purposes)\n        if (this.camera instanceof THREE.PerspectiveCamera || this.camera instanceof THREE.OrthographicCamera) {\n            this.camera.far = 400000; // Ensure far clip plane is beyond skybox\n            this.camera.updateProjectionMatrix();\n        }\n    }\n\n    /**\n     * Apply camera shake offset\n     * Uses dual-frequency sine waves for organic motion\n     */\n    private applyShake(): void {\n        if (!this.camera || !this.spaceship) return;\n\n        // Update shake time\n        this.shakeTime += this.normalizedDeltaTime * 0.016; // Convert normalized time to seconds\n\n        // Create organic shake using dual-frequency sine waves\n        // Primary frequency\n        const offsetX = Math.sin(this.shakeTime * Physics.SHAKE_FREQUENCY) * this.shakeIntensity * 0.5;\n        const offsetY = Math.sin(this.shakeTime * Physics.SHAKE_FREQUENCY * 1.3) * this.shakeIntensity * 0.5;\n        const offsetZ = Math.sin(this.shakeTime * Physics.SHAKE_FREQUENCY * 0.8) * this.shakeIntensity * 0.3;\n\n        // Secondary frequency for more organic feel\n        const offsetX2 = Math.sin(this.shakeTime * Physics.SHAKE_FREQUENCY * 2.5) * this.shakeIntensity * 0.25;\n        const offsetY2 = Math.sin(this.shakeTime * Physics.SHAKE_FREQUENCY * 3.1) * this.shakeIntensity * 0.25;\n\n        // Combine frequencies\n        const shakeOffset = new THREE.Vector3(\n            offsetX + offsetX2,\n            offsetY + offsetY2,\n            offsetZ\n        );\n\n        // Apply shake in camera's local space (relative to camera orientation)\n        // This makes the shake feel more natural as it moves with the camera\n        const cameraRight = new THREE.Vector3(1, 0, 0).applyQuaternion(this.camera.quaternion);\n        const cameraUp = new THREE.Vector3(0, 1, 0).applyQuaternion(this.camera.quaternion);\n        const cameraForward = new THREE.Vector3(0, 0, -1).applyQuaternion(this.camera.quaternion);\n\n        const worldShakeOffset = new THREE.Vector3()\n            .addScaledVector(cameraRight, shakeOffset.x)\n            .addScaledVector(cameraUp, shakeOffset.y)\n            .addScaledVector(cameraForward, shakeOffset.z);\n\n        this.camera.position.add(worldShakeOffset);\n\n        // Decay shake intensity\n        this.shakeIntensity *= Physics.SHAKE_DECAY;\n\n        // Stop shake when intensity is negligible\n        if (this.shakeIntensity < 0.01) {\n            this.shakeIntensity = 0;\n        }\n    }\n\n    /**\n     * Apply camera recoil offset\n     * Applies a brief, decaying camera offset in the recoil direction.\n     */\n    private applyRecoil(): void {\n        if (!this.camera || !this.spaceship || this.recoilIntensity <= 0) return;\n\n        // Update recoil time\n        this.recoilTime += this.normalizedDeltaTime * 0.016; // Convert normalized time to seconds\n\n        // Calculate recoil offset using a decaying sine wave\n        const recoilOffset = new THREE.Vector3()\n            .copy(this.recoilDirection)\n            .multiplyScalar(\n                this.recoilIntensity *\n                Math.sin(this.recoilTime * Physics.RECOIL_FREQUENCY) *\n                Math.exp(-this.recoilTime / Physics.RECOIL_DURATION)\n            );\n\n        // Apply recoil in world space\n        this.camera.position.add(recoilOffset);\n\n        // Decay recoil intensity over time for a quick return\n        this.recoilIntensity *= Physics.RECOIL_DECAY;\n\n        // Stop recoil when intensity is negligible\n        if (this.recoilIntensity < 0.01) {\n            this.recoilIntensity = 0;\n            this.recoilTime = 0; // Reset time for next recoil\n        }\n    }\n    \n    // Update rotation based on mouse movement deltas\n    updateRotation(deltaX: number, deltaY: number): void {\n        // Update the rotation directly\n        this.rotationState.x -= deltaX;\n        this.rotationState.y -= deltaY;\n    }\n    \n    // Check for collisions with asteroids and planets\n    checkCollisions(): void {\n        if (!this.scene || !this.spaceship || !this.spaceship.mesh) return;\n        const shipMesh = this.spaceship.mesh;\n        \n        // Set a smaller collision radius based on actual ship size\n        // This was previously Physics.COLLISION_DISTANCE (70) which was too large\n        const shipRadius = 15; // Reduced from 70 to match actual ship size\n        const shipPosition = shipMesh.position.clone();\n        \n        // First check if we're colliding with our own projectiles and skip those\n        this.scene.traverse((object: THREE.Object3D) => {\n            if (object.type === 'Mesh' && \n                'geometry' in object && \n                object.geometry && \n                typeof object.geometry === 'object' &&\n                'type' in object.geometry &&\n                typeof object.geometry.type === 'string' &&\n                object.geometry.type.includes('SphereGeometry') && \n                'userData' in object &&\n                typeof object.userData === 'object' &&\n                object.userData !== null &&\n                'isPlayerProjectile' in object.userData &&\n                object.userData.isPlayerProjectile &&\n                'sourceId' in object.userData &&\n                object.userData.sourceId === 'player') {\n                \n                // Skip our own projectiles - don't even process them\n                return;\n            }\n        });\n        \n        // 1. Check collisions with asteroids\n        const asteroidMeshes: THREE.Mesh[] = [];\n        \n        // Direct access to the asteroid belt if possible\n        const asteroidBelt = this.scene.children.find((child: THREE.Object3D) => child.name === 'asteroidBelt');\n        let asteroids: AsteroidData[] = [];\n        \n        // If we can get direct access to asteroid belt object, use that for better performance\n        if (asteroidBelt && \n            'userData' in asteroidBelt && \n            typeof asteroidBelt.userData === 'object' &&\n            asteroidBelt.userData !== null &&\n            'asteroids' in asteroidBelt.userData) {\n            const userData = asteroidBelt.userData as AsteroidBeltUserData;\n            asteroids = userData.asteroids;\n            asteroidMeshes.push(...asteroids.map(a => a.mesh));\n        } else {\n            // Otherwise do the more expensive scene traversal\n            this.scene.traverse((object: THREE.Object3D) => {\n                // Check for asteroids using geometry type\n                if (object.type === 'Mesh' && \n                    'geometry' in object && \n                    object.geometry && \n                    typeof object.geometry === 'object' &&\n                    'type' in object.geometry &&\n                    typeof object.geometry.type === 'string' &&\n                    (object.geometry.type.includes('IcosahedronGeometry') || \n                     object.geometry.type.includes('TetrahedronGeometry') || \n                     object.geometry.type.includes('OctahedronGeometry'))) {\n                    \n                    // Only consider objects within the asteroid belt range to avoid false positives\n                    const distFromCenter = Math.sqrt(\n                        object.position.x * object.position.x + \n                        object.position.z * object.position.z\n                    );\n                    \n                    // Only include objects in the appropriate distance range from the center\n                    // This helps avoid mistaking other geometric objects for asteroids\n                    if (distFromCenter > 16000 && distFromCenter < 32000) {\n                        asteroidMeshes.push(object as THREE.Mesh);\n                    }\n                }\n            });\n        }\n        \n        // Check distance to each asteroid - precise collision detection\n        for (const asteroid of asteroidMeshes) {\n            // Skip null items or invisible asteroids\n            if (!asteroid || !asteroid.visible) continue;\n            \n            const distance = shipPosition.distanceTo(asteroid.position);\n            \n            // Use actual size from geometry if available - no artificial inflation\n            let asteroidRadius = 0;\n            \n            if (asteroid.geometry && \n                'parameters' in asteroid.geometry &&\n                typeof asteroid.geometry.parameters === 'object' &&\n                asteroid.geometry.parameters !== null &&\n                'radius' in asteroid.geometry.parameters &&\n                typeof asteroid.geometry.parameters.radius === 'number') {\n                // Use the exact geometry radius without multiplication\n                asteroidRadius = asteroid.geometry.parameters.radius;\n            } else {\n                // Fallback size - more accurate estimation\n                asteroidRadius = 60; // 4x original value to match larger asteroids\n            }\n            \n            // If collision detected - uses the sum of actual ship and asteroid radii\n            if (distance < (shipRadius + asteroidRadius)) {\n                // Only log collision in debug mode\n                if (DEBUG_MODE.enabled) {\n                    console.log(\"Asteroid collision detected!\", \n                        \"Ship position:\", shipPosition,\n                        \"Asteroid position:\", asteroid.position,\n                        \"Distance:\", distance, \n                        \"Detection threshold:\", (shipRadius + asteroidRadius));\n                }\n                \n                this.handleCollision(asteroid, \"asteroid\");\n                return; // Exit after first collision\n            }\n        }\n        \n        // 2. Check collisions with planets\n        this.scene.traverse((object: THREE.Object3D) => {\n            // Check if this is a planet - they typically have larger scale\n            if (object.type === 'Mesh' && \n                'geometry' in object &&\n                object.geometry &&\n                typeof object.geometry === 'object' &&\n                'type' in object.geometry &&\n                typeof object.geometry.type === 'string' &&\n                object.geometry.type.includes('SphereGeometry') && \n                object.scale.x >= 1 && // To filter out particles and small objects\n                'userData' in object &&\n                typeof object.userData === 'object' &&\n                object.userData !== null &&\n                (!('id' in object.userData) || \n                 typeof object.userData.id !== 'string' || \n                 !object.userData.id.startsWith('asteroid-')) && // Not an asteroid\n                (!('isPlayerProjectile' in object.userData) || !object.userData.isPlayerProjectile) && // Not a player projectile\n                object !== shipMesh) { // Not the spaceship itself\n                \n                const distance = shipPosition.distanceTo(object.position);\n                \n                // For planets, we use the actual geometry radius without artificial inflation\n                if ('parameters' in object.geometry &&\n                    typeof object.geometry.parameters === 'object' &&\n                    object.geometry.parameters !== null &&\n                    'radius' in object.geometry.parameters &&\n                    typeof object.geometry.parameters.radius === 'number') {\n                    const planetRadius = object.geometry.parameters.radius * object.scale.x;\n                    \n                    // If the object is the sun\n                    if ('material' in object &&\n                        object.material &&\n                        typeof object.material === 'object' &&\n                        'emissive' in object.material &&\n                        object.material.emissive &&\n                        typeof object.material.emissive === 'object' &&\n                        'r' in object.material.emissive &&\n                        'g' in object.material.emissive &&\n                        typeof object.material.emissive.r === 'number' &&\n                        typeof object.material.emissive.g === 'number' &&\n                        object.material.emissive.r > 0.5 && \n                        object.material.emissive.g > 0.5) {\n                        // Sun collision: if we're within the exact combined radius\n                        if (distance < planetRadius + shipRadius) {\n                            this.handleCollision(object as THREE.Mesh, \"sun\");\n                            return;\n                        }\n                    } \n                    // Regular planet collision\n                    else if (distance < planetRadius + shipRadius) {\n                        this.handleCollision(object as THREE.Mesh, \"planet\");\n                        return;\n                    }\n                }\n            }\n        });\n    }\n    \n    handleCollision(object: THREE.Mesh, type: CollisionType): void {\n        if (this.collided || !this.scene || !this.spaceship) return; // Only handle the first collision\n        \n        this.collided = true;\n        \n        // Enhanced logging for collision diagnostics (only in debug mode)\n        if (DEBUG_MODE.enabled) {\n            console.log(\"=== COLLISION DETECTED ===\");\n            console.log(`Collision type: ${type}`);\n            console.log(`Ship velocity at impact: ${this.spaceship.velocity.length().toFixed(2)} units/frame`);\n            console.log(`Ship position: x=${this.spaceship.mesh.position.x.toFixed(0)}, y=${this.spaceship.mesh.position.y.toFixed(0)}, z=${this.spaceship.mesh.position.z.toFixed(0)}`);\n            console.log(`${type} position: x=${object.position.x.toFixed(0)}, y=${object.position.y.toFixed(0)}, z=${object.position.z.toFixed(0)}`);\n            console.log(`Hull resistance: ${this.spaceship.collisionResistance}`);\n        }\n        \n        // Apply hull resistance to see if we survive the collision\n        if (this.attemptCollisionRecovery(type)) {\n            if (DEBUG_MODE.enabled) console.log(\"Hull absorbed collision damage!\");\n            this.createRecoveryEffect();\n            \n            // Bounce away from the collision point\n            if (object && object.position) {\n                const bounceDirection = new THREE.Vector3()\n                    .subVectors(this.spaceship.mesh.position, object.position)\n                    .normalize();\n                \n                // Apply a bounce force\n                this.spaceship.velocity.copy(bounceDirection.multiplyScalar(5));\n            }\n            \n            // Play the \"boink\" sound for minor collisions\n            if (window.game && \n                typeof window.game === 'object' &&\n                'audio' in window.game &&\n                window.game.audio &&\n                typeof window.game.audio === 'object' &&\n                'playSound' in window.game.audio &&\n                typeof window.game.audio.playSound === 'function') {\n                (window.game.audio as { playSound: (sound: string) => void }).playSound('boink');\n            }\n            \n            // Reset collision state after a short delay\n            setTimeout(() => {\n                this.collided = false;\n                if (DEBUG_MODE.enabled) console.log(\"Collision state reset - ship ready for new collisions\");\n            }, 1000);\n            \n            return;\n        }\n        \n        // If we didn't recover, publish game over event instead of handling directly\n        // Stop the ship\n        this.spaceship.velocity.set(0, 0, 0);\n        \n        // Different explosion effects based on collision type\n        let explosionColor: number;\n        let explosionSize: number;\n        let explosionMessage: string;\n        let collisionType: string;\n        \n        if (type === \"sun\") {\n            // Solar collision - big, bright yellow explosion\n            explosionColor = 0xffff00;\n            explosionSize = 60; // 4x original size (was 15)\n            explosionMessage = \"Your ship was incinerated by the sun!\";\n            collisionType = \"SUN_DEATH\";\n        } else if (type === \"planet\") {\n            // Planet collision - large blue-tinted explosion\n            explosionColor = 0x33ccff;\n            explosionSize = 40; // 4x original size (was 10)\n            explosionMessage = \"Your ship crashed into a planet!\";\n            collisionType = \"COLLISION_PLANET\";\n        } else {\n            // Default asteroid collision - smaller orange explosion\n            explosionColor = 0xff6600;\n            explosionSize = 20; // 4x original size (was 5)\n            explosionMessage = \"Your ship was destroyed by an asteroid!\";\n            collisionType = \"COLLISION_ASTEROID\";\n        }\n        \n        // Create visual effect for the collision\n        const explosionGeometry = new THREE.SphereGeometry(explosionSize, 32, 32);\n        const explosionMaterial = new THREE.MeshBasicMaterial({\n            color: explosionColor,\n            transparent: true,\n            opacity: 0.8\n        });\n        const explosion = new THREE.Mesh(explosionGeometry, explosionMaterial);\n        explosion.position.copy(this.spaceship.mesh.position);\n        this.scene.add(explosion);\n        \n        // Animate the explosion\n        this.animateExplosion(explosion);\n        \n        // Mark the ship as destroyed internally\n        if (this.spaceship) {\n            this.spaceship.isDestroyed = true;\n        }\n        \n        \n        console.log(\"Physics: Initiating game over sequence for collision with\", type);\n        \n        // Use main message bus if available\n        if (mainMessageBus && typeof mainMessageBus.publish === 'function') {\n            console.log(\"Physics: Using main message bus\");\n            mainMessageBus.publish('game.over', {\n                reason: explosionMessage,\n                source: \"physics\",\n                collisionType: type,\n                type: collisionType\n            });\n        } else if (window.game && \n                   typeof window.game === 'object' &&\n                   'messageBus' in window.game &&\n                   window.game.messageBus &&\n                   typeof window.game.messageBus === 'object' &&\n                   'publish' in window.game.messageBus &&\n                   typeof window.game.messageBus.publish === 'function') {\n            // Use game message bus if main message bus not available\n            console.log(\"Physics: Using window.game.messageBus\");\n            (window.game.messageBus as { publish: (event: string, data: unknown) => void }).publish('game.over', {\n                reason: explosionMessage,\n                source: \"physics\",\n                collisionType: type,\n                type: collisionType\n            });\n        } else {\n            // Only use MessageBus.triggerGameOver if no direct access\n            import('../core/messageBus.ts').then(module => {\n                const MessageBus = (module as { MessageBus: { triggerGameOver: (message: string, source: string) => void } }).MessageBus;\n                console.log(\"Physics: Using MessageBus.triggerGameOver\");\n                \n                MessageBus.triggerGameOver(explosionMessage, \"physics\");\n            }).catch((err: unknown) => {\n                console.error(\"Physics: Error importing MessageBus:\", err);\n            });\n        }\n    }\n    \n    // Method to attempt to recover from a collision based on hull resistance\n    attemptCollisionRecovery(collisionType: CollisionType): boolean {\n        if (!this.spaceship || !this.spaceship.collisionResistance) \n            return false;\n        \n        // Get the hull resistance value\n        const resistance = this.spaceship.collisionResistance;\n        \n        // Different collision types have different chances of recovery\n        // Higher resistance increases chances\n        let recoveryChance = 0;\n        \n        switch (collisionType) {\n            case \"asteroid\":\n                // 50% base chance + 8% per hull level as requested\n                recoveryChance = 0.50 + (resistance - 1) * 0.08;\n                if (DEBUG_MODE.enabled) console.log(`Asteroid collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\n                break;\n            case \"planet\":\n                // Start with 10% chance, increased by hull resistance\n                recoveryChance = 0.1 + (resistance - 1) * 0.2;\n                if (DEBUG_MODE.enabled) console.log(`Planet collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\n                break;\n            case \"sun\":\n                // Almost no chance to survive sun collision\n                recoveryChance = (resistance - 1) * 0.05;\n                if (DEBUG_MODE.enabled) console.log(`Sun collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\n                break;\n            default:\n                recoveryChance = 0.2 + (resistance - 1) * 0.3;\n                if (DEBUG_MODE.enabled) console.log(`Generic collision recovery chance: ${(recoveryChance * 100).toFixed(1)}%`);\n        }\n        \n        // Random chance based on recovery probability\n        const recoveryRoll = Math.random();\n        const survived = recoveryRoll < recoveryChance;\n        \n        if (DEBUG_MODE.enabled) console.log(`Recovery roll: ${recoveryRoll.toFixed(3)}, needed ${recoveryChance.toFixed(3)} or lower to survive`);\n        \n        return survived;\n    }\n    \n    // Create a visual effect when the ship survives a collision\n    createRecoveryEffect(): void {\n        if (!this.spaceship || !this.scene) return;\n        \n        // Create a shield-like effect around the ship\n        const shieldGeometry = new THREE.SphereGeometry(60, 32, 32); // 4x original size (was 15)\n        const shieldMaterial = new THREE.MeshBasicMaterial({\n            color: 0x30cfd0,\n            transparent: true,\n            opacity: 0.6,\n            side: THREE.DoubleSide\n        });\n        \n        const shield = new THREE.Mesh(shieldGeometry, shieldMaterial);\n        shield.position.copy(this.spaceship.mesh.position);\n        this.scene.add(shield);\n        \n        // Animate the shield (expand and fade out)\n        let scale = 1;\n        const expandSpeed = 0.05;\n        const fadeSpeed = 0.02;\n        \n        const animateShield = (): void => {\n            if (scale > 2 || shield.material.opacity <= 0) {\n                this.scene.remove(shield);\n                return;\n            }\n            \n            scale += expandSpeed;\n            shield.scale.set(scale, scale, scale);\n            if (shield.material instanceof THREE.MeshBasicMaterial) {\n                shield.material.opacity -= fadeSpeed;\n            }\n            \n            // Update shield position to follow ship\n            if (this.spaceship && this.spaceship.mesh) {\n                shield.position.copy(this.spaceship.mesh.position);\n            }\n            \n            requestAnimationFrame(animateShield);\n        };\n        \n        animateShield();\n    }\n    \n    animateExplosion(explosion: THREE.Mesh): void {\n        let scale = 1;\n        const expandSpeed = 0.5;\n        const fadeSpeed = 0.02;\n        \n        const animate = (): void => {\n            if (scale > 20 || (explosion.material instanceof THREE.MeshBasicMaterial && explosion.material.opacity <= 0)) {\n                this.scene.remove(explosion);\n                return;\n            }\n            \n            scale += expandSpeed;\n            explosion.scale.set(scale, scale, scale);\n            if (explosion.material instanceof THREE.MeshBasicMaterial) {\n                explosion.material.opacity -= fadeSpeed;\n            }\n            \n            requestAnimationFrame(animate);\n        };\n        \n        animate();\n    }\n}\n","// inputHandler.js - Handles keyboard and mouse input\n\ntype SpaceshipInput = {\n    isDocked: boolean;\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        right: boolean;\n        left: boolean;\n        boost: boolean;\n    };\n};\n\ntype PhysicsInput = {\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        introSequenceActive?: boolean;\n    };\n    inputIntent?: number;\n};\n\nexport class InputHandler {\n    spaceship: SpaceshipInput;\n    physics: PhysicsInput;\n    isPointerLocked: boolean;\n    mouseSensitivity: number;\n\n    constructor(spaceship: SpaceshipInput, physics: PhysicsInput) {\n        this.spaceship = spaceship;\n        this.physics = physics;\n        this.isPointerLocked = false;\n        this.mouseSensitivity = 0.001; // Lower sensitivity for more precise control\n        \n        this.setupKeyboardControls();\n        this.setupPointerLock();\n    }\n    \n    setupKeyboardControls(): void {\n        // Keyboard controls\n        document.addEventListener('keydown', (e: KeyboardEvent) => {\n            const windowWithGame = window as GameWindow;\n            // Ignore inputs when docked or intro sequence is active\n            if (this.spaceship.isDocked || (windowWithGame.game && windowWithGame.game.introSequenceActive)) return;\n            \n            switch (e.key.toLowerCase()) {\n                case 'w': windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) | 1; break;\n                case 's': windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) | 2; break;\n                case 'a': windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) | 4; break;\n                case 'd': windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) | 8; break;\n                case 'shift': windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) | 16; break;\n            }\n        });\n        \n        document.addEventListener('keyup', (e: KeyboardEvent) => {\n            const windowWithGame = window as GameWindow;\n            // Still process key up events when intro is active to prevent stuck keys\n            if (windowWithGame.game && windowWithGame.game.introSequenceActive) {\n                // Force reset all thrusters during intro sequence\n                this.spaceship.thrust.forward = false;\n                this.spaceship.thrust.backward = false;\n                this.spaceship.thrust.right = false;\n                this.spaceship.thrust.left = false;\n                this.spaceship.thrust.boost = false;\n                return;\n            }\n            \n            const clearBit = (bit: number) => { windowWithGame.inputIntent = (windowWithGame.inputIntent || 0) & ~bit; };\n            switch (e.key.toLowerCase()) {\n                case 'w': clearBit(1); break;\n                case 's': clearBit(2); break;\n                case 'a': clearBit(4); break;\n                case 'd': clearBit(8); break;\n                case 'shift': clearBit(16); break;\n            }\n        });\n    }\n    \n    setupPointerLock(): void {\n        // Get the canvas element (it's the first canvas in the document)\n        const canvas = document.querySelector('canvas') as HTMLCanvasElement;\n        \n        // Request pointer lock when clicking on the canvas\n        canvas.addEventListener('pointerdown', (e: PointerEvent) => {\n            e.preventDefault(); // Prevent default to avoid unwanted behavior\n            if (!this.isPointerLocked && !this.spaceship.isDocked) {\n                canvas.requestPointerLock();\n            }\n        });\n        \n        // Set up pointer lock change event\n        document.addEventListener('pointerlockchange', () => {\n            if (document.pointerLockElement === canvas) {\n                // Pointer is locked\n                this.isPointerLocked = true;\n                document.addEventListener('pointermove', this.handlePointerMove.bind(this));\n            } else {\n                // Pointer is unlocked\n                this.isPointerLocked = false;\n                document.removeEventListener('pointermove', this.handlePointerMove.bind(this));\n            }\n        });\n        \n        // Add instructions for pointer lock\n        const instructionsElement = document.createElement('div');\n        instructionsElement.id = 'pointer-lock-instructions';\n        instructionsElement.innerHTML = `\n            Click on the game to enable mouse rotation\n        `;\n        instructionsElement.style.position = 'absolute';\n        instructionsElement.style.top = '60px';\n        instructionsElement.style.left = '50%';\n        instructionsElement.style.transform = 'translateX(-50%)';\n        instructionsElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\n        instructionsElement.style.padding = '10px 20px';\n        instructionsElement.style.borderRadius = '20px';\n        instructionsElement.style.border = '1px solid #30cfd0';\n        instructionsElement.style.boxShadow = '0 0 10px #30cfd0';\n        instructionsElement.style.color = '#fff';\n        instructionsElement.style.fontFamily = 'Courier New, monospace';\n        instructionsElement.style.zIndex = '999';\n        instructionsElement.style.textAlign = 'center';\n        document.body.appendChild(instructionsElement);\n        \n        // Hide instructions when pointer is locked\n        document.addEventListener('pointerlockchange', () => {\n            instructionsElement.style.display = document.pointerLockElement ? 'none' : 'block';\n        });\n    }\n    \n    handlePointerMove(e: PointerEvent): void {\n        const windowWithGame = window as GameWindow;\n        // Skip mouse movement handling during intro sequence\n        if (windowWithGame.game && windowWithGame.game.introSequenceActive) return;\n        \n        if (!this.isPointerLocked) return;\n        \n        // Use movementX and movementY for rotation\n        // These values represent the mouse movement since the last event\n        const movementX = e.movementX || 0;\n        const movementY = e.movementY || 0;\n        \n        // Update the physics rotation based on these movements\n        this.physics.updateRotation(\n            movementX * this.mouseSensitivity, \n            movementY * this.mouseSensitivity\n        );\n    }\n    \n    isLocked(): boolean {\n        return this.isPointerLocked;\n    }\n    \n    exitPointerLock(): void {\n        if (document.exitPointerLock) {\n            document.exitPointerLock();\n        }\n    }\n}\n","// gamepadHandler.js - Handles gamepad/controller input\n// Supports Xbox, PlayStation, and generic controllers\n\ntype SpaceshipInput = {\n    isDocked: boolean;\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        left: boolean;\n        right: boolean;\n        boost: boolean;\n    };\n    thrustPower: number;\n    strafePower: number;\n};\n\ntype PhysicsInput = {\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype TargetingSystem = {\n    toggleLockOn: () => void;\n    cycleLockOnTarget?: (direction?: number) => unknown;\n    getCurrentTarget?: () => unknown;\n};\n\ntype MiningSystem = {\n    isMining: boolean;\n    stopMining: () => void;\n    startMining: () => void;\n    setTargetAsteroid: (target: unknown) => void;\n};\n\ntype DockingSystem = {\n    canDock?: () => boolean;\n    initiateDocking?: () => void;\n};\n\ntype ControlsInput = {\n    targetingSystem?: TargetingSystem;\n    miningSystem?: MiningSystem;\n    dockingSystem?: DockingSystem;\n    weaponSystem?: unknown;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        introSequenceActive?: boolean;\n        deployTurret?: () => void;\n        deployShieldDrone?: () => void;\n        togglePause?: () => void;\n        combat?: {\n            setFiring: (isFiring: boolean) => void;\n        };\n    };\n    gameInstance?: {\n        combat?: {\n            setFiring: (isFiring: boolean) => void;\n        };\n    };\n};\n\nexport class GamepadHandler {\n    spaceship: SpaceshipInput;\n    physics: PhysicsInput;\n    controls: ControlsInput;\n    gamepads: Record<number, Gamepad>;\n    activeGamepadIndex: number | null;\n    enabled: boolean;\n    vibrationEnabled: boolean;\n    deadZone: number;\n    triggerDeadZone: number;\n    lookSensitivity: number;\n    movementSensitivity: number;\n    rotationSmoothing: {\n        targetX: number;\n        targetY: number;\n        currentX: number;\n        currentY: number;\n        smoothingFactor: number;\n    };\n    buttonMap: Record<string, number>;\n    axisMap: Record<string, number>;\n    buttonStates: Record<number, boolean>;\n    previousButtonStates: Record<number, boolean>;\n    wasFiring: boolean;\n    debugMode: boolean;\n    debugDisplay: HTMLDivElement | null;\n    rightStickXAxis: number;\n    rightStickYAxis: number;\n    axisDetectionMode: boolean;\n\n    constructor(spaceship: SpaceshipInput, physics: PhysicsInput, controls: ControlsInput) {\n        this.spaceship = spaceship;\n        this.physics = physics;\n        this.controls = controls; // Reference to main controls for mining/targeting/etc\n        \n        // Gamepad state\n        this.gamepads = {};\n        this.activeGamepadIndex = null;\n        this.enabled = true;\n        this.vibrationEnabled = true;\n        \n        // Dead zones for analog sticks (prevents drift)\n        this.deadZone = 0.15;\n        this.triggerDeadZone = 0.15; // Increased to prevent accidental activation\n        \n        // Sensitivity settings\n        this.lookSensitivity = 1.0;  // Right stick look sensitivity (reduced from 2.0)\n        this.movementSensitivity = 1.0;  // Left stick movement sensitivity\n        \n        // Smoothing for accurate aiming\n        this.rotationSmoothing = {\n            targetX: 0,\n            targetY: 0,\n            currentX: 0,\n            currentY: 0,\n            smoothingFactor: 0.15  // Lower = smoother, higher = more responsive\n        }\n        \n        // Button mapping (Xbox layout as default)\n        this.buttonMap = {\n            // Face buttons\n            A: 0,          // Jump/Accept\n            B: 1,          // Cancel/Back\n            X: 2,          // Reload/Interact\n            Y: 3,          // Switch weapon\n            \n            // Bumpers and triggers\n            LB: 4,         // Previous target\n            RB: 5,         // Next target\n            LT: 6,         // Mining laser\n            RT: 7,         // Fire weapon\n            \n            // Special buttons\n            BACK: 8,       // Menu/Settings\n            START: 9,      // Pause\n            L3: 10,        // Left stick click - boost\n            R3: 11,        // Right stick click - toggle targeting\n            \n            // D-Pad\n            DPAD_UP: 12,   // Deploy turret\n            DPAD_DOWN: 13, // Deploy shield\n            DPAD_LEFT: 14, // Previous weapon\n            DPAD_RIGHT: 15 // Next weapon\n        };\n        \n        // Axis mapping\n        this.axisMap = {\n            LEFT_STICK_X: 0,   // Strafe left/right\n            LEFT_STICK_Y: 1,   // Move forward/backward\n            RIGHT_STICK_X: 2,  // Look left/right (yaw)\n            RIGHT_STICK_Y: 3,  // Look up/down (pitch)\n            LT: 4,             // Left trigger (some controllers)\n            RT: 5              // Right trigger (some controllers)\n        };\n        \n        // Button state tracking (for press/release detection)\n        this.buttonStates = {};\n        this.previousButtonStates = {};\n        \n        // Trigger states for firing\n        this.wasFiring = false;\n        \n        // Initialize controller support\n        this.init();\n        \n        // Debug mode for testing\n        this.debugMode = false; // Disabled now that we found the correct mapping\n        this.debugDisplay = null;\n\n        // Right stick axes (default mapping)\n        this.rightStickXAxis = 3;\n        this.rightStickYAxis = 4;\n        this.axisDetectionMode = false;\n\n        // Subscribe to vibration events\n        if ((globalThis as any).mainMessageBus) {\n            (globalThis as any).mainMessageBus.subscribe('input.vibrate', (message: any) => {\n                if (message.data) {\n                    this.vibrate(message.data.intensity, message.data.duration);\n                }\n            });\n        }\n    }\n    \n    init(): void {\n        // Check for gamepad support\n        if (!('getGamepads' in navigator)) {\n            console.warn('Gamepad API not supported in this browser');\n            return;\n        }\n        \n        // Listen for gamepad connections\n        window.addEventListener('gamepadconnected', (e: GamepadEvent) => {\n            console.log(`Gamepad connected: ${e.gamepad.id} (index: ${e.gamepad.index})`);\n            this.onGamepadConnected(e.gamepad);\n        });\n        \n        // Listen for gamepad disconnections\n        window.addEventListener('gamepaddisconnected', (e: GamepadEvent) => {\n            console.log(`Gamepad disconnected: ${e.gamepad.id} (index: ${e.gamepad.index})`);\n            this.onGamepadDisconnected(e.gamepad);\n        });\n        \n        // Check for already connected gamepads\n        this.scanForGamepads();\n        \n        console.log('Gamepad handler initialized - ready for controller input');\n    }\n    \n    scanForGamepads(): void {\n        const gamepads = navigator.getGamepads();\n        for (let i = 0; i < gamepads.length; i++) {\n            const gamepad = gamepads[i];\n            if (gamepad) {\n                this.onGamepadConnected(gamepad);\n            }\n        }\n    }\n    \n    onGamepadConnected(gamepad: Gamepad): void {\n        this.gamepads[gamepad.index] = gamepad;\n        \n        // Set as active if no active gamepad\n        if (this.activeGamepadIndex === null) {\n            this.activeGamepadIndex = gamepad.index;\n            this.showNotification(`Controller connected: ${this.getGamepadName(gamepad)}`);\n            \n            // Vibrate to confirm connection\n            this.vibrate(0.3, 200);\n        }\n    }\n    \n    onGamepadDisconnected(gamepad: Gamepad): void {\n        delete this.gamepads[gamepad.index];\n        \n        // If this was the active gamepad, find another\n        if (this.activeGamepadIndex === gamepad.index) {\n            this.activeGamepadIndex = null;\n            this.showNotification('Controller disconnected');\n            \n            // Try to find another connected gamepad\n            for (let index in this.gamepads) {\n                this.activeGamepadIndex = parseInt(index);\n                this.showNotification(`Switched to controller: ${this.getGamepadName(this.gamepads[parseInt(index, 10)])}`);\n                break;\n            }\n        }\n    }\n    \n    getGamepadName(gamepad: Gamepad): string {\n        // Simplify gamepad names for display\n        const name = gamepad.id.toLowerCase();\n        if (name.includes('xbox')) return 'Xbox Controller';\n        if (name.includes('playstation') || name.includes('dualshock')) return 'PlayStation Controller';\n        if (name.includes('switch') || name.includes('pro controller')) return 'Switch Pro Controller';\n        return 'Generic Controller';\n    }\n    \n    update(deltaTime: number): void {\n        if (!this.enabled || this.activeGamepadIndex === null) return;\n        \n        // Get fresh gamepad state (must call this each frame)\n        const gamepads = navigator.getGamepads();\n        const gamepad = gamepads[this.activeGamepadIndex];\n        \n        if (!gamepad) return;\n        \n        // Update debug display if enabled\n        if (this.debugMode) {\n            this.updateDebugDisplay(gamepad);\n        }\n        \n        // Skip input during intro sequence or when docked\n        const windowWithGame = window as GameWindow;\n        if ((windowWithGame.game && windowWithGame.game.introSequenceActive) || this.spaceship.isDocked) {\n            // Reset all controls\n            this.resetControls();\n            return;\n        }\n        \n        // Store previous button states for edge detection\n        this.previousButtonStates = {...this.buttonStates};\n        \n        // Update current button states\n        gamepad.buttons.forEach((button, index) => {\n            this.buttonStates[index] = button.pressed;\n        });\n        \n        // Handle movement (left stick)\n        this.handleMovement(gamepad);\n        \n        // Handle camera look (right stick)\n        this.handleCameraLook(gamepad, deltaTime);\n        \n        // Handle buttons\n        this.handleButtons(gamepad);\n        \n        // Handle triggers\n        this.handleTriggers(gamepad);\n\n        // Continuous rumble while mining\n        if (this.vibrationEnabled && this.controls.miningSystem?.isMining) {\n            // Use a duration slightly longer than a frame (at 60fps, ~16.6ms)\n            // 100ms provides a consistent rumble even with slight frame drops\n            this.vibrate(0.2, 100);\n        }\n    }\n    \n    handleMovement(gamepad: Gamepad): void {\n        // Left stick - movement\n        let leftX = this.applyDeadZone(gamepad.axes[this.axisMap.LEFT_STICK_X]);\n        let leftY = this.applyDeadZone(gamepad.axes[this.axisMap.LEFT_STICK_Y]);\n\n        // Apply response curve for better precision at low deflections\n        leftX = this.applyResponseCurve(leftX, 2.5);\n        leftY = this.applyResponseCurve(leftY, 2.5);\n\n        // Reset movement\n        this.spaceship.thrust.forward = false;\n        this.spaceship.thrust.backward = false;\n        this.spaceship.thrust.left = false;\n        this.spaceship.thrust.right = false;\n\n        // Apply movement based on stick position\n        // Y-axis is inverted (up is negative)\n        if (leftY < -0.1) {\n            this.spaceship.thrust.forward = true;\n            this.spaceship.thrustPower = Math.abs(leftY); // Variable thrust\n        } else if (leftY > 0.1) {\n            this.spaceship.thrust.backward = true;\n            this.spaceship.thrustPower = Math.abs(leftY);\n        }\n\n        // X-axis strafing\n        // FIXED: thrust.left actually moves RIGHT, thrust.right moves LEFT in physics\n        // So we need to reverse the mapping\n        if (leftX < -0.1) {\n            this.spaceship.thrust.right = true; // Left stick left = move left (uses right thrust)\n            this.spaceship.strafePower = Math.abs(leftX);\n        } else if (leftX > 0.1) {\n            this.spaceship.thrust.left = true; // Right stick right = move right (uses left thrust)\n            this.spaceship.strafePower = Math.abs(leftX);\n        }\n\n        // Left stick click - boost\n        if (gamepad.buttons[this.buttonMap.L3].pressed) {\n            this.spaceship.thrust.boost = true;\n        } else {\n            this.spaceship.thrust.boost = false;\n        }\n    }\n    \n    handleCameraLook(gamepad: Gamepad, deltaTime: number): void {\n        // YOUR CONTROLLER: Right stick is on axes 3 (horizontal) and 4 (vertical)\n        void deltaTime;\n        let rightStickX = this.applyDeadZone(gamepad.axes[3] || 0); // Horizontal movement\n        let rightStickY = this.applyDeadZone(gamepad.axes[4] || 0); // Vertical movement\n\n        // Apply response curve for finer control at low deflections\n        rightStickX = this.applyResponseCurve(rightStickX, 2.5);\n        rightStickY = this.applyResponseCurve(rightStickY, 2.5);\n\n        // Update target rotation speeds\n        const baseSpeed = 0.0015; // Reduced base speed for better control\n        this.rotationSmoothing.targetX = rightStickX * baseSpeed * this.lookSensitivity * 60;\n        this.rotationSmoothing.targetY = rightStickY * baseSpeed * this.lookSensitivity * 60;\n\n        // Apply exponential smoothing for smoother rotation\n        const smoothing = this.rotationSmoothing.smoothingFactor;\n        this.rotationSmoothing.currentX += (this.rotationSmoothing.targetX - this.rotationSmoothing.currentX) * smoothing;\n        this.rotationSmoothing.currentY += (this.rotationSmoothing.targetY - this.rotationSmoothing.currentY) * smoothing;\n\n        // Only update rotation if there's meaningful input\n        if (Math.abs(this.rotationSmoothing.currentX) > 0.0001 || Math.abs(this.rotationSmoothing.currentY) > 0.0001) {\n            this.physics.updateRotation(this.rotationSmoothing.currentX, this.rotationSmoothing.currentY);\n        } else {\n            // Reset smoothing when stick is centered\n            this.rotationSmoothing.currentX = 0;\n            this.rotationSmoothing.currentY = 0;\n        }\n    }\n    \n    handleButtons(gamepad: Gamepad): void {\n        void gamepad;\n        // A button - Toggle targeting system\n        if (this.wasButtonPressed(this.buttonMap.A)) {\n            if (this.controls && this.controls.targetingSystem) {\n                this.controls.targetingSystem.toggleLockOn();\n            }\n        }\n        \n        // B button - Toggle mining (tap to start/stop)\n        if (this.wasButtonPressed(this.buttonMap.B)) {\n            if (this.controls && this.controls.miningSystem && this.controls.targetingSystem) {\n                if (this.controls.miningSystem.isMining) {\n                    // Currently mining - stop it\n                    this.controls.miningSystem.stopMining();\n                } else {\n                    // Not mining - try to start\n                    const target = this.controls.targetingSystem.getCurrentTarget?.();\n                    if (target) {\n                        this.controls.miningSystem.setTargetAsteroid(target);\n                        this.controls.miningSystem.startMining();\n                    }\n                }\n            }\n        }\n        \n        // X button - Dock when near stargate\n        if (this.wasButtonPressed(this.buttonMap.X)) {\n            if (this.controls && this.controls.dockingSystem && this.controls.dockingSystem.canDock && this.controls.dockingSystem.canDock()) {\n                this.controls.dockingSystem.initiateDocking?.();\n            }\n        }\n        \n        // Y button - Deploy turret\n        if (this.wasButtonPressed(this.buttonMap.Y)) {\n            const windowWithGame = window as GameWindow;\n            if (windowWithGame.game && windowWithGame.game.deployTurret) {\n                windowWithGame.game.deployTurret();\n            }\n        }\n        \n        // Bumpers - Cycle targets\n        if (this.wasButtonPressed(this.buttonMap.LB)) {\n            // Previous target\n            if (this.controls && this.controls.targetingSystem) {\n                this.controls.targetingSystem.cycleLockOnTarget?.(-1);\n            }\n        }\n        \n        if (this.wasButtonPressed(this.buttonMap.RB)) {\n            // Next target\n            if (this.controls && this.controls.targetingSystem) {\n                const target = this.controls.targetingSystem.cycleLockOnTarget?.(1);\n                if (target && this.controls.miningSystem) {\n                    this.controls.miningSystem.setTargetAsteroid(target);\n                }\n            }\n        }\n        \n        // Right stick click - Could be used for something else later\n        \n        // D-Pad for quick actions\n        if (this.wasButtonPressed(this.buttonMap.DPAD_UP)) {\n            // Deploy turret\n            const windowWithGame = window as GameWindow;\n            if (windowWithGame.game && windowWithGame.game.deployTurret) {\n                windowWithGame.game.deployTurret();\n            }\n        }\n        \n        if (this.wasButtonPressed(this.buttonMap.DPAD_DOWN)) {\n            // Deploy shield drone\n            const windowWithGame = window as GameWindow;\n            if (windowWithGame.game && windowWithGame.game.deployShieldDrone) {\n                windowWithGame.game.deployShieldDrone();\n            }\n        }\n        \n        // Start button - Pause/Menu\n        if (this.wasButtonPressed(this.buttonMap.START)) {\n            const windowWithGame = window as GameWindow;\n            if (windowWithGame.game && windowWithGame.game.togglePause) {\n                windowWithGame.game.togglePause();\n            }\n        }\n    }\n    \n    handleTriggers(gamepad: Gamepad): void {\n        // Check triggers - most controllers use buttons 6 and 7\n        let rtValue = 0;\n        let ltValue = 0;\n\n        // Standard button mapping for triggers\n        if (gamepad.buttons[7]) {\n            rtValue = gamepad.buttons[7].value;\n        }\n        if (gamepad.buttons[6]) {\n            ltValue = gamepad.buttons[6].value;\n        }\n\n        // Some controllers report triggers as axes 4 and 5\n        const axis4 = gamepad.axes[4] || 0;\n        const axis5 = gamepad.axes[5] || 0;\n        if (rtValue < 0.01 && Math.abs(axis5) > 0.01) {\n            rtValue = (axis5 + 1) / 2; // Convert from -1,1 to 0,1\n        }\n        if (ltValue < 0.01 && Math.abs(axis4) > 0.01) {\n            ltValue = (axis4 + 1) / 2; // Convert from -1,1 to 0,1\n        }\n\n        // Apply response curve to triggers for more gradual pressure engagement\n        rtValue = this.applyResponseCurve(rtValue * 2 - 1, 2.5) * 0.5 + 0.5; // Scale to 0-1\n        ltValue = this.applyResponseCurve(ltValue * 2 - 1, 2.5) * 0.5 + 0.5; // Scale to 0-1\n\n        // RIGHT TRIGGER - Fire weapons\n        if (rtValue > this.triggerDeadZone) {\n            if (!this.wasFiring) {\n                // Start firing\n                const windowWithGame = window as GameWindow;\n                if (windowWithGame.game && windowWithGame.game.combat) {\n                    windowWithGame.game.combat.setFiring(true);\n                    this.wasFiring = true;\n                }\n            }\n        } else {\n            if (this.wasFiring) {\n                // Stop firing\n                const windowWithGame = window as GameWindow;\n                if (windowWithGame.game && windowWithGame.game.combat) {\n                    windowWithGame.game.combat.setFiring(false);\n                    this.wasFiring = false;\n                }\n            }\n        }\n\n        // LEFT TRIGGER - Alternative mining button (optional)\n        // Disabled for now to avoid conflicts - use B button instead\n    }\n    \n    applyDeadZone(value: number): number {\n        if (Math.abs(value) < this.deadZone) {\n            return 0;\n        }\n        // Scale the value to use full range after dead zone\n        const sign = value > 0 ? 1 : -1;\n        return sign * ((Math.abs(value) - this.deadZone) / (1 - this.deadZone));\n    }\n    \n    wasButtonPressed(buttonIndex: number): boolean {\n        // Returns true only on the frame the button was pressed (not held)\n        return this.buttonStates[buttonIndex] && !this.previousButtonStates[buttonIndex];\n    }\n    \n    wasButtonReleased(buttonIndex: number): boolean {\n        // Returns true only on the frame the button was released\n        return !this.buttonStates[buttonIndex] && this.previousButtonStates[buttonIndex];\n    }\n    \n    vibrate(intensity = 0.5, duration = 100): void {\n        if (!this.vibrationEnabled || this.activeGamepadIndex === null) return;\n        \n        const gamepads = navigator.getGamepads();\n        const gamepad = gamepads[this.activeGamepadIndex];\n        const hapticsGamepad = gamepad as Gamepad & { vibrationActuator?: GamepadHapticActuator };\n        \n        if (hapticsGamepad && hapticsGamepad.vibrationActuator) {\n            hapticsGamepad.vibrationActuator.playEffect('dual-rumble', {\n                startDelay: 0,\n                duration: duration,\n                weakMagnitude: intensity * 0.5,\n                strongMagnitude: intensity\n            });\n        }\n    }\n    \n    resetControls(): void {\n        // Reset all spaceship controls\n        this.spaceship.thrust.forward = false;\n        this.spaceship.thrust.backward = false;\n        this.spaceship.thrust.left = false;\n        this.spaceship.thrust.right = false;\n        this.spaceship.thrust.boost = false;\n        this.spaceship.thrustPower = 1.0;\n        this.spaceship.strafePower = 1.0;\n    }\n    \n    showNotification(message: string): void {\n        // Show a temporary notification for gamepad events\n        const notification = document.createElement('div');\n        notification.style.position = 'fixed';\n        notification.style.bottom = '100px';\n        notification.style.left = '50%';\n        notification.style.transform = 'translateX(-50%)';\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\n        notification.style.color = '#30cfd0';\n        notification.style.padding = '10px 20px';\n        notification.style.borderRadius = '5px';\n        notification.style.border = '1px solid #30cfd0';\n        notification.style.fontFamily = 'monospace';\n        notification.style.fontSize = '14px';\n        notification.style.zIndex = '10000';\n        notification.textContent = ' ' + message;\n        \n        document.body.appendChild(notification);\n        \n        // Fade out and remove after 3 seconds\n        setTimeout(() => {\n            notification.style.transition = 'opacity 0.5s';\n            notification.style.opacity = '0';\n            setTimeout(() => notification.remove(), 500);\n        }, 3000);\n    }\n    \n    // Settings methods\n    setLookSensitivity(value: number): void {\n        this.lookSensitivity = Math.max(0.1, Math.min(5.0, value));\n    }\n    \n    setMovementSensitivity(value: number): void {\n        this.movementSensitivity = Math.max(0.1, Math.min(2.0, value));\n    }\n    \n    setDeadZone(value: number): void {\n        this.deadZone = Math.max(0.05, Math.min(0.3, value));\n    }\n    \n    setVibration(enabled: boolean): void {\n        this.vibrationEnabled = enabled;\n    }\n    \n    isConnected(): boolean {\n        return this.activeGamepadIndex !== null;\n    }\n\n    /**\n     * Apply non-linear response curve to analog input\n     * Provides better precision at low deflections and responsive full deflections\n     * @param input - Raw input value (-1 to 1)\n     * @param exponent - Curve exponent (higher = more precision at center)\n     * @returns Curved value (-1 to 1)\n     */\n    applyResponseCurve(input: number, exponent: number = 2.5): number {\n        const sign = Math.sign(input);\n        const magnitude = Math.abs(input);\n        return sign * Math.pow(magnitude, exponent);\n    }\n    \n    // Debug methods for testing\n    toggleDebug(): void {\n        this.debugMode = !this.debugMode;\n        \n        if (this.debugMode) {\n            this.createDebugDisplay();\n        } else {\n            this.removeDebugDisplay();\n        }\n    }\n    \n    createDebugDisplay(): void {\n        if (this.debugDisplay) return;\n        \n        this.debugDisplay = document.createElement('div');\n        this.debugDisplay.id = 'gamepad-debug';\n        this.debugDisplay.style.position = 'fixed';\n        this.debugDisplay.style.top = '10px';\n        this.debugDisplay.style.right = '10px';\n        this.debugDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\n        this.debugDisplay.style.color = '#0f0';\n        this.debugDisplay.style.padding = '10px';\n        this.debugDisplay.style.fontFamily = 'monospace';\n        this.debugDisplay.style.fontSize = '12px';\n        this.debugDisplay.style.borderRadius = '5px';\n        this.debugDisplay.style.border = '1px solid #0f0';\n        this.debugDisplay.style.zIndex = '10001';\n        this.debugDisplay.style.maxWidth = '300px';\n        this.debugDisplay.style.pointerEvents = 'none';\n        \n        document.body.appendChild(this.debugDisplay);\n    }\n    \n    removeDebugDisplay(): void {\n        if (this.debugDisplay) {\n            this.debugDisplay.remove();\n            this.debugDisplay = null;\n        }\n    }\n    \n    updateDebugDisplay(gamepad: Gamepad): void {\n        if (!this.debugDisplay) {\n            this.createDebugDisplay();\n        }\n        \n        // Show ALL axes to debug mapping issues\n        let html = `<strong> Gamepad Debug</strong><br>`;\n        html += `Controller: ${gamepad.id}<br>`;\n        html += `Mapping: ${gamepad.mapping || 'non-standard'}<br>`;\n        html += `<br><strong>All Axes (${gamepad.axes.length}):</strong><br>`;\n        \n        for (let i = 0; i < gamepad.axes.length; i++) {\n            const value = gamepad.axes[i].toFixed(2);\n            const isRightX = i === this.rightStickXAxis;\n            const isRightY = i === this.rightStickYAxis;\n            const label = isRightX ? ' (R-X)' : isRightY ? ' (R-Y)' : '';\n            html += `[${i}]: ${value}${label} `;\n            if (i % 2 === 1) html += '<br>';\n        }\n        \n        html += `<br><strong>Detected Mapping:</strong><br>`;\n        html += `Left Stick: axes[0,1]<br>`;\n        html += `Right Stick: axes[${this.rightStickXAxis},${this.rightStickYAxis}]<br>`;\n        \n        const rightX = gamepad.axes[this.rightStickXAxis]?.toFixed(2) || '0';\n        const rightY = gamepad.axes[this.rightStickYAxis]?.toFixed(2) || '0';\n        html += `Right Values: X=${rightX} Y=${rightY}<br>`;\n        \n        const rt = gamepad.buttons[7]?.value.toFixed(2) || '0';\n        const lt = gamepad.buttons[6]?.value.toFixed(2) || '0';\n        html += `<br><strong>Triggers:</strong><br>`;\n        html += `LT: ${lt} | RT: ${rt}<br>`;\n        \n        html += `<br><strong>Active:</strong><br>`;\n        // Show active controls\n        if (this.spaceship.thrust.forward) html += ' Forward ';\n        if (this.spaceship.thrust.backward) html += ' Backward ';\n        if (this.spaceship.thrust.left) html += ' Right ';\n        if (this.spaceship.thrust.right) html += ' Left ';\n        if (this.spaceship.thrust.boost) html += ' Boost ';\n        \n        html += `<br><small>Press F8 to swap X/Y axes</small>`;\n        \n        if (this.debugDisplay) {\n            this.debugDisplay.innerHTML = html;\n        }\n    }\n    \n    // Method to swap right stick axes if they're incorrect\n    swapRightStickAxes(): void {\n        const temp = this.rightStickXAxis;\n        this.rightStickXAxis = this.rightStickYAxis;\n        this.rightStickYAxis = temp;\n        console.log(`Swapped right stick axes: X is now axis ${this.rightStickXAxis}, Y is now axis ${this.rightStickYAxis}`);\n        this.axisDetectionMode = false; // Disable auto-detection after manual swap\n    }\n}\n","// laserMaterial.ts - TSL-based pulsing glow material for mining laser\n\nimport { color, time, sin } from 'three/tsl'; // TSL helpers\nimport * as THREE from 'three';\n\n/**\n * Create a TSL-based laser material with pulsing glow effect\n * @param baseColor - Base color as hex (e.g., 0x00ffff)\n * @param pulseSpeed - Speed of pulse animation (default: 8)\n * @param pulseIntensity - Intensity of pulse variation (0-1, default: 0.3)\n * @returns Material with TSL colorNode and pulsing glow\n */\nexport function createLaserMaterial(\n    baseColor: number = 0x00ffff,\n    pulseSpeed: number = 8,\n    pulseIntensity: number = 0.3\n): THREE.MeshBasicMaterial {\n    const material = new THREE.MeshBasicMaterial() as THREE.MeshBasicMaterial & { colorNode?: unknown };\n\n    // Create pulsing glow effect using TSL\n    // sin(time * pulseSpeed) gives oscillation between -1 and 1\n    // Multiply by pulseIntensity, then add 1 to get [1-pulseIntensity, 1+pulseIntensity]\n    // This creates a pulsing effect that varies the color intensity\n    // Pattern matches CLAUDE.md example: sin(time.mul(10)).mul(0.3).add(1)\n    const pulse = sin(time.mul(pulseSpeed)).mul(pulseIntensity).add(1);\n\n    // Apply pulse to color - color nodes support method chaining\n    // color() can take hex values directly (e.g., 0xff3030)\n    // Note: TSL colorNode is experimental, fall back to standard color + emissiveMap if issues\n    try {\n        material.colorNode = color(baseColor).mul(pulse);\n    } catch (e) {\n        // Fallback: use standard material color without TSL\n        material.color.setHex(baseColor);\n        console.warn('TSL colorNode not supported or failed, falling back to standard material color.', e);\n    }\n    \n    // Transparency and additive blending for glow effect\n    material.transparent = true;\n    material.opacity = 0.8;\n    material.blending = THREE.AdditiveBlending;\n    material.depthWrite = false;\n    material.side = THREE.DoubleSide;\n    \n    return material;\n}\n","// laserControl.js - Handles laser beam visuals and control\n\nimport * as THREE from 'three';\nimport { createLaserMaterial } from '../../render/laserMaterial.js';\n\ninterface SceneLike {\n    isScene?: boolean;\n}\n\ninterface WindowWithGame {\n    game?: {\n        renderer?: {\n            scene?: THREE.Scene;\n        };\n    };\n}\n\ninterface HasMesh {\n    mesh: THREE.Object3D;\n}\n\ninterface Spaceship extends HasMesh {\n    miningEfficiency?: number;\n    activateMiningLaser?: () => void;\n    deactivateMiningLaser?: () => void;\n}\n\ninterface AsteroidTarget extends HasMesh {\n    resourceType?: string;\n}\n\nexport class LaserControl {\n    scene: SceneLike;\n    spaceship: Spaceship;\n    laserMesh: THREE.Mesh<THREE.CylinderGeometry, THREE.Material> | null;\n    currentMaterial: THREE.Material | null;\n\n    constructor(scene: SceneLike, spaceship: Spaceship) {\n        this.scene = scene;\n        this.spaceship = spaceship;\n        this.laserMesh = null;\n        this.currentMaterial = null;\n    }\n\n    /**\n     * Get the Three.js scene from the renderer\n     */\n    getThreeScene(): THREE.Scene | null {\n        // Access scene via window.game.renderer.scene as specified\n        const gameWindow = window as WindowWithGame;\n        if (gameWindow.game && gameWindow.game.renderer && gameWindow.game.renderer.scene) {\n            return gameWindow.game.renderer.scene;\n        }\n        // Fallback: if scene passed to constructor is the Three.js scene\n        if (this.scene && this.scene.isScene) {\n            return this.scene as THREE.Scene;\n        }\n        return null;\n    }\n\n    /**\n     * Get laser color based on resource type\n     */\n    getLaserColor(resourceType?: string): number {\n        if (!resourceType) return 0xff3030; // Default red for iron\n        \n        const type = resourceType.toLowerCase();\n        if (type === 'gold') {\n            return 0xffcc00; // Gold color\n        } else if (type === 'platinum') {\n            return 0x66ffff; // Cyan color for platinum\n        }\n        return 0xff3030; // Default red for iron\n    }\n\n    /**\n     * Update laser beam position and appearance\n     */\n    updateLaserBeam(targetAsteroid: AsteroidTarget | null): void {\n        if (!this.laserMesh || !targetAsteroid || !this.spaceship.mesh) return;\n        \n        // Get source position (spaceship with offset)\n        const sourcePosition = this.spaceship.mesh.position.clone();\n        const shipOffset = new THREE.Vector3(0, 0, -60);\n        shipOffset.applyQuaternion(this.spaceship.mesh.quaternion);\n        sourcePosition.add(shipOffset);\n        \n        // Get target position (asteroid)\n        const targetPosition = targetAsteroid.mesh.position.clone();\n        \n        // Calculate direction and distance\n        const direction = new THREE.Vector3().subVectors(targetPosition, sourcePosition);\n        const distance = direction.length();\n        \n        if (distance < 0.01) {\n            // Too close, hide laser\n            this.laserMesh.visible = false;\n            return;\n        }\n        \n        // Calculate midpoint\n        const midpoint = new THREE.Vector3().addVectors(sourcePosition, targetPosition).multiplyScalar(0.5);\n        \n        // Position cylinder at midpoint\n        this.laserMesh.position.copy(midpoint);\n        \n        // Reset rotation before applying new orientation\n        this.laserMesh.rotation.set(0, 0, 0);\n        \n        // Orient cylinder toward target (makes local -Z point toward target)\n        this.laserMesh.lookAt(targetPosition);\n        \n        // CylinderGeometry is Y-up by default, so rotate 90 degrees around X axis\n        // to align Y-axis (cylinder length) with the direction toward target\n        this.laserMesh.rotateX(Math.PI / 2);\n        \n        // Scale cylinder to match distance (scale along Y axis which is now the length)\n        const baseRadius = 0.15;\n        const efficiency = this.spaceship.miningEfficiency || 1.0;\n        const radius = baseRadius * Math.sqrt(efficiency);\n        this.laserMesh.scale.set(radius / baseRadius, distance, radius / baseRadius);\n        \n        // Update material color based on resource type\n        if (targetAsteroid.resourceType && this.currentMaterial) {\n            // TSL materials update automatically, but we may need to recreate if color changed\n            // For now, the pulsing effect from TSL handles the animation\n        }\n        \n        // Make sure laser is visible\n        this.laserMesh.visible = true;\n    }\n\n    /**\n     * Create or get laser beam mesh\n     */\n    setupLaserBeam(targetAsteroid: AsteroidTarget): void {\n        const threeScene = this.getThreeScene();\n        if (!threeScene) {\n            console.error(\"LaserControl: Could not access Three.js scene\");\n            return;\n        }\n        \n        // Clean up old DOM element if it exists (from previous CSS implementation)\n        const oldLaserBeam = document.getElementById('laser-beam');\n        if (oldLaserBeam) {\n            oldLaserBeam.remove();\n        }\n        \n        // Create mesh if it doesn't exist\n        if (!this.laserMesh) {\n            console.log(\"LaserControl: Creating 3D laser beam mesh\");\n            \n            // Create cylinder geometry (radiusTop, radiusBottom, height, radialSegments)\n            const geometry = new THREE.CylinderGeometry(0.15, 0.15, 1, 8);\n            \n            // Get color based on resource type\n            const baseColor = targetAsteroid && targetAsteroid.resourceType \n                ? this.getLaserColor(targetAsteroid.resourceType)\n                : 0xff3030; // Default red\n            \n            // Create TSL material\n            this.currentMaterial = createLaserMaterial(baseColor, 8, 0.3) as THREE.Material;\n            \n            // Create mesh\n            this.laserMesh = new THREE.Mesh(geometry, this.currentMaterial);\n            \n            // Initially hidden\n            this.laserMesh.visible = false;\n            \n            // Add to scene\n            threeScene.add(this.laserMesh);\n        } else {\n            // Update material color if resource type changed\n            if (targetAsteroid && targetAsteroid.resourceType) {\n                const newColor = this.getLaserColor(targetAsteroid.resourceType);\n                // Dispose old material\n                if (this.currentMaterial) {\n                    this.currentMaterial.dispose();\n                }\n                // Create new material with correct color\n                this.currentMaterial = createLaserMaterial(newColor, 8, 0.3) as THREE.Material;\n                this.laserMesh.material = this.currentMaterial;\n            }\n            \n            // Show laser beam\n            this.laserMesh.visible = true;\n        }\n    }\n    \n    /**\n     * Cleanup method to dispose of resources\n     */\n    dispose(): void {\n        const threeScene = this.getThreeScene();\n        \n        if (this.laserMesh) {\n            if (threeScene) {\n                threeScene.remove(this.laserMesh);\n            }\n            if (this.laserMesh.geometry) {\n                this.laserMesh.geometry.dispose();\n            }\n            if (this.currentMaterial) {\n                this.currentMaterial.dispose();\n            }\n            this.laserMesh = null;\n            this.currentMaterial = null;\n        }\n        \n        // Clean up old DOM element if it exists\n        const oldLaserBeam = document.getElementById('laser-beam');\n        if (oldLaserBeam) {\n            oldLaserBeam.remove();\n        }\n    }\n\n    /**\n     * Hide laser beam\n     */\n    hideLaserBeam(): void {\n        if (this.laserMesh) {\n            this.laserMesh.visible = false;\n        }\n    }\n\n    /**\n     * Activate spaceship's mining laser\n     */\n    activateSpaceshipLaser(): void {\n        if (this.spaceship && typeof this.spaceship.activateMiningLaser === 'function') {\n            this.spaceship.activateMiningLaser();\n        }\n    }\n\n    /**\n     * Deactivate spaceship's mining laser\n     */\n    deactivateSpaceshipLaser(): void {\n        if (this.spaceship && typeof this.spaceship.deactivateMiningLaser === 'function') {\n            this.spaceship.deactivateMiningLaser();\n        }\n    }\n}\n","// targetValidation.js - Handles target validation and range checking\n\nimport type { Object3D } from 'three';\n\ninterface HasMesh {\n    mesh: Object3D;\n}\n\ninterface MiningStartResult {\n    valid: boolean;\n    reason?: string;\n    distance?: number;\n    maxRange?: number;\n}\n\nexport class TargetValidation {\n    spaceship: HasMesh | null;\n    miningDistance: number;\n\n    constructor(spaceship: HasMesh | null, miningDistance = 6000) {\n        this.spaceship = spaceship;\n        this.miningDistance = miningDistance;\n    }\n\n    /**\n     * Validate asteroid target\n     */\n    validateAsteroid(asteroid: HasMesh | null): boolean {\n        try {\n            console.log(\"TargetValidation: validating asteroid\", asteroid);\n            \n            // Validate asteroid before setting it as the target\n            if (!asteroid || !asteroid.mesh || !asteroid.mesh.position) {\n                console.error(\"TargetValidation: Invalid asteroid provided\");\n                return false;\n            }\n\n            return true;\n        } catch (error) {\n            console.error(\"TargetValidation: Error validating asteroid:\", error);\n            return false;\n        }\n    }\n\n    /**\n     * Check if target is in mining range\n     */\n    isInRange(asteroid: HasMesh | null): boolean {\n        if (!asteroid || !asteroid.mesh || !this.spaceship || !this.spaceship.mesh) {\n            return false;\n        }\n\n        const distance = this.spaceship.mesh.position.distanceTo(asteroid.mesh.position);\n        return distance <= this.miningDistance;\n    }\n\n    /**\n     * Get distance to target\n     */\n    getDistanceToTarget(asteroid: HasMesh | null): number {\n        if (!asteroid || !asteroid.mesh || !this.spaceship || !this.spaceship.mesh) {\n            return Infinity;\n        }\n\n        return this.spaceship.mesh.position.distanceTo(asteroid.mesh.position);\n    }\n\n    /**\n     * Validate spaceship for mining\n     */\n    validateSpaceship(): boolean {\n        if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\n            console.error(\"TargetValidation: Spaceship is missing mesh or position\");\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * Check if asteroid is valid for mining start\n     */\n    canStartMining(asteroid: HasMesh | null): MiningStartResult {\n        if (!this.validateAsteroid(asteroid)) {\n            return { valid: false, reason: \"Invalid asteroid\" };\n        }\n\n        if (!this.validateSpaceship()) {\n            return { valid: false, reason: \"Invalid spaceship\" };\n        }\n\n        const distance = this.getDistanceToTarget(asteroid);\n        if (distance > this.miningDistance) {\n            return { \n                valid: false, \n                reason: \"Out of range\",\n                distance: distance,\n                maxRange: this.miningDistance\n            };\n        }\n\n        return { valid: true };\n    }\n}\n","// resourceExtraction.js - Handles resource extraction and notification\n\ninterface OrbResources {\n    common: number;\n    uncommon: number;\n    rare: number;\n    epic: number;\n    legendary: number;\n    [rarity: string]: number;\n}\n\ninterface ResourceInventory {\n    iron: number;\n    gold: number;\n    platinum: number;\n    orbs: OrbResources;\n    [key: string]: number | OrbResources;\n}\n\ninterface AsteroidResourceInfo {\n    resourceType?: string;\n}\n\nexport class ResourceExtraction {\n    resources: ResourceInventory;\n\n    constructor() {\n        this.resources = {\n            iron: 0,\n            gold: 0,\n            platinum: 0,\n            orbs: {\n                common: 0,\n                uncommon: 0,\n                rare: 0,\n                epic: 0,\n                legendary: 0\n            }\n        };\n    }\n\n    /**\n     * Add all resources from the mined asteroid to the player's inventory at once\n     */\n    addAsteroidResources(targetAsteroid: AsteroidResourceInfo | null, efficiency = 1.0): boolean {\n        if (!targetAsteroid) return false;\n        \n        // Get the resource type from the asteroid\n        const resourceType = targetAsteroid.resourceType || 'iron'; // Default to iron if no type specified\n        \n        // Get mining efficiency for resource extraction bonus\n        const bonusChance = (efficiency - 1.0) * 0.5; // Chance for bonus resources based on efficiency\n        \n        // Calculate base amount based on asteroid type\n        let amount = 0;\n        switch (resourceType.toLowerCase()) {\n            case 'iron':\n                amount = Math.floor(Math.random() * 5) + 10; // 10-14 iron\n                break;\n            case 'gold':\n                amount = Math.floor(Math.random() * 3) + 5; // 5-7 gold\n                break;\n            case 'platinum':\n                amount = Math.floor(Math.random() * 2) + 2; // 2-3 platinum\n                break;\n            default:\n                amount = 10; // Default to 10 iron\n        }\n        \n        // Apply bonus resources based on mining efficiency\n        if (efficiency > 1.0 && Math.random() < bonusChance) {\n            amount = Math.ceil(amount * 1.2); // 20% bonus\n        }\n        \n        // Update resource counts\n        switch (resourceType.toLowerCase()) {\n            case 'iron':\n                this.resources.iron += amount;\n                break;\n            case 'gold':\n                this.resources.gold += amount;\n                break;\n            case 'platinum':\n                this.resources.platinum += amount;\n                break;\n            default:\n                this.resources.iron += amount;\n        }\n        \n        console.log(`ResourceExtraction: Added ${amount} ${resourceType} from asteroid`);\n        \n        // Show resource gain notification\n        this.showResourceGainNotification(amount, resourceType);\n        \n        return true;\n    }\n\n    /**\n     * Show a notification for resources gained\n     */\n    showResourceGainNotification(amount: number, resourceType: string): void {\n        // Get color based on resource type\n        let color = '#a0a0a0'; // Default gray for iron\n        if (resourceType === 'gold') {\n            color = '#ffcc00';\n        } else if (resourceType === 'platinum') {\n            color = '#66ffff';\n        }\n        \n        // Create notification element\n        const notification = document.createElement('div');\n        notification.textContent = `+${amount} ${resourceType.toUpperCase()}`;\n        notification.style.position = 'absolute';\n        notification.style.top = '40%';\n        notification.style.left = '50%';\n        notification.style.transform = 'translate(-50%, -50%)';\n        notification.style.color = color;\n        notification.style.fontSize = '24px';\n        notification.style.fontWeight = 'bold';\n        notification.style.textShadow = '0 0 8px black';\n        notification.style.zIndex = '1000';\n        notification.style.opacity = '1';\n        notification.style.transition = 'all 1.5s ease-out';\n        \n        document.body.appendChild(notification);\n        \n        // Animate the notification\n        setTimeout(() => {\n            notification.style.opacity = '0';\n            notification.style.top = '30%';\n            \n            // Remove after animation\n            setTimeout(() => {\n                if (document.body.contains(notification)) {\n                    document.body.removeChild(notification);\n                }\n            }, 1500);\n        }, 100);\n    }\n\n    /**\n     * Get current resource counts\n     */\n    getResources(): ResourceInventory {\n        return { ...this.resources };\n    }\n\n    /**\n     * Get resource count for specific type\n     */\n    getResource(type: string): number {\n        const key = type.toLowerCase();\n        const value = this.resources[key];\n        return typeof value === 'number' ? value : 0;\n    }\n}\n","// uiUpdates.js - Handles UI updates and progress displays\n\nimport type { Object3D } from 'three';\n\ninterface TargetingSystem {\n    isLockOnEnabled: () => boolean;\n}\n\ntype WindowWithGame = {\n    gameInstance?: {\n        controls?: {\n            targetingSystem?: TargetingSystem;\n        };\n    };\n    game?: {\n        controls?: {\n            targetingSystem?: TargetingSystem;\n        };\n    };\n};\n\ninterface HasMesh {\n    mesh: Object3D;\n}\n\ninterface AsteroidInfo extends HasMesh {\n    resourceType?: string;\n}\n\nexport class UIUpdates {\n    constructor() {}\n\n    /**\n     * Update target info UI elements\n     */\n    updateTargetInfo(asteroid: AsteroidInfo | null, spaceship: HasMesh | null, miningDistance: number): void {\n        if (!asteroid || !asteroid.mesh || !spaceship || !spaceship.mesh) return;\n        \n        try {\n            // Check if targeting system is active\n            const gameWindow = window as WindowWithGame;\n            const targetingSystem = gameWindow.gameInstance?.controls?.targetingSystem || gameWindow.game?.controls?.targetingSystem;\n            const isTargetingEnabled = targetingSystem && targetingSystem.isLockOnEnabled();\n            \n            if (!isTargetingEnabled) return;\n\n            // Update distance calculation\n            const distance = spaceship.mesh.position.distanceTo(asteroid.mesh.position);\n            const inRange = distance <= miningDistance;\n            \n            // Update UI elements if they exist\n            const targetDistance = document.getElementById('target-distance');\n            if (targetDistance) {\n                const rangeStatus = inRange ? ' [IN RANGE]' : ' [OUT OF RANGE]';\n                const rangeColor = inRange ? '#00ff00' : '#ff4400';\n                targetDistance.innerHTML = `Distance: ${Math.round(distance)} units<span style=\"color: ${rangeColor}\">${rangeStatus}</span>`;\n            }\n            \n            // Update target info color\n            const targetInfo = document.getElementById('target-info');\n            if (targetInfo) {\n                targetInfo.style.color = inRange ? '#30cfd0' : '#ff4400';\n                targetInfo.style.display = 'block';\n            }\n            \n            // Update target name to show range status\n            const targetName = document.getElementById('target-name');\n            if (targetName && asteroid.resourceType) {\n                const resourceType = asteroid.resourceType.toUpperCase();\n                if (!inRange) {\n                    targetName.textContent = `${resourceType} Asteroid - OUT OF RANGE`;\n                    targetName.style.color = '#ff4400';\n                } else {\n                    targetName.textContent = `${resourceType} Asteroid`;\n                    targetName.style.color = '#30cfd0';\n                }\n            }\n        } catch (error) {\n            console.error(\"UIUpdates: Error updating target info:\", error);\n        }\n    }\n\n    /**\n     * Update mining status with time estimate\n     */\n    updateMiningStatusWithTime(asteroid: AsteroidInfo | null, miningSpeed: number, efficiency = 1.0): void {\n        const miningStatusElement = document.getElementById('mining-status');\n        if (!miningStatusElement || !asteroid || !asteroid.resourceType) return;\n        \n        // Calculate approximate time to mine based on resource type\n        const resourceType = asteroid.resourceType.toLowerCase();\n        const secondsRequired = Math.round(1 / miningSpeed);\n        \n        let efficiencyText = \"\";\n        if (efficiency > 1.0) {\n            efficiencyText = ` [${Math.round(efficiency * 100)}% efficiency]`;\n        }\n        \n        miningStatusElement.textContent = `MINING ${resourceType.toUpperCase()} (${secondsRequired}s)${efficiencyText}`;\n        miningStatusElement.style.color = '#ff4400';\n    }\n\n    /**\n     * Reset mining status display\n     */\n    resetMiningStatus(): void {\n        const miningStatusElement = document.getElementById('mining-status');\n        if (miningStatusElement) {\n            miningStatusElement.textContent = 'INACTIVE';\n            miningStatusElement.style.color = '#30cfd0';\n        }\n    }\n\n    /**\n     * Create or update mining progress bar\n     */\n    setupMiningProgressBar(): void {\n        let miningProgressContainer = document.getElementById('mining-progress-container');\n        if (!miningProgressContainer) {\n            console.log(\"UIUpdates: Creating mining progress container\");\n            miningProgressContainer = document.createElement('div');\n            miningProgressContainer.id = 'mining-progress-container';\n            miningProgressContainer.style.position = 'absolute';\n            miningProgressContainer.style.bottom = '20px';\n            miningProgressContainer.style.left = '50%';\n            miningProgressContainer.style.transform = 'translateX(-50%)';\n            miningProgressContainer.style.width = '200px';\n            miningProgressContainer.style.height = '10px';\n            miningProgressContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\n            miningProgressContainer.style.border = '1px solid #30cfd0';\n            miningProgressContainer.style.zIndex = '1000';\n            document.body.appendChild(miningProgressContainer);\n            \n            const progressBar = document.createElement('div');\n            progressBar.id = 'mining-progress-bar';\n            progressBar.style.width = '0%';\n            progressBar.style.height = '100%';\n            progressBar.style.backgroundColor = '#30cfd0';\n            miningProgressContainer.appendChild(progressBar);\n        } else {\n            miningProgressContainer.style.display = 'block';\n            const progressBar = document.getElementById('mining-progress-bar');\n            if (progressBar) {\n                progressBar.style.width = '0%';\n            }\n        }\n    }\n\n    /**\n     * Update mining progress bar\n     */\n    updateMiningProgress(progress: number): void {\n        const progressBar = document.getElementById('mining-progress-bar');\n        if (progressBar) {\n            progressBar.style.width = `${progress * 100}%`;\n        }\n    }\n\n    /**\n     * Hide mining progress bar\n     */\n    hideMiningProgressBar(): void {\n        const miningProgressContainer = document.getElementById('mining-progress-container');\n        if (miningProgressContainer) {\n            miningProgressContainer.style.display = 'none';\n        }\n    }\n\n    /**\n     * Show out of range message\n     */\n    showOutOfRangeMessage(): void {\n        const gameWindow = window as WindowWithGame;\n        const targetingSystem = gameWindow.gameInstance?.controls?.targetingSystem || gameWindow.game?.controls?.targetingSystem;\n        const isTargetingEnabled = targetingSystem && targetingSystem.isLockOnEnabled();\n        \n        const targetInfo = document.getElementById('target-info');\n        if (targetInfo && isTargetingEnabled) {\n            targetInfo.textContent = 'TARGET OUT OF RANGE';\n            targetInfo.style.color = '#ff4400';\n            targetInfo.style.display = 'block';\n            \n            // Hide after 2 seconds\n            setTimeout(() => {\n                if (!targetingSystem || !targetingSystem.isLockOnEnabled()) {\n                    targetInfo.style.display = 'none';\n                }\n            }, 2000);\n        }\n    }\n}\n","// visualEffects.js - Handles visual effects for mining operations\n\nimport * as THREE from 'three';\n\ninterface AsteroidResourceInfo {\n    resourceType?: string;\n}\n\ninterface Velocity {\n    x: number;\n    y: number;\n    z: number;\n}\n\nexport class VisualEffects {\n    scene: THREE.Scene;\n    miningParticles: THREE.Points<THREE.BufferGeometry, THREE.PointsMaterial> | null;\n\n    constructor(scene: THREE.Scene) {\n        this.scene = scene;\n        this.miningParticles = null;\n        this.setupMiningParticles();\n    }\n\n    /**\n     * Setup mining particles effect\n     */\n    setupMiningParticles(): void {\n        // Create particle effect for mining impact\n        const particleCount = 100;\n        const particles = new THREE.BufferGeometry();\n        const particleMaterial = new THREE.PointsMaterial({\n            color: 0xff5500,\n            size: 1.5,\n            blending: THREE.AdditiveBlending,\n            transparent: true,\n            opacity: 0.8\n        });\n        \n        const positions = new Float32Array(particleCount * 3);\n        for (let i = 0; i < particleCount; i++) {\n            positions[i * 3] = 0;\n            positions[i * 3 + 1] = 0;\n            positions[i * 3 + 2] = 0;\n        }\n        \n        particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));\n        this.miningParticles = new THREE.Points(particles, particleMaterial);\n        this.miningParticles.visible = false;\n        this.scene.add(this.miningParticles);\n    }\n\n    /**\n     * Show mining particles with appropriate color\n     */\n    showMiningParticles(asteroid: AsteroidResourceInfo, efficiency = 1.0): void {\n        if (!this.miningParticles) return;\n        \n        this.miningParticles.visible = true;\n        \n        // Adjust particle color based on resource type\n        if (asteroid.resourceType && this.miningParticles.material) {\n            const resourceType = asteroid.resourceType.toLowerCase();\n            \n            if (resourceType === 'iron') {\n                this.miningParticles.material.color.set(0xff5500); // Orange\n            } else if (resourceType === 'gold') {\n                this.miningParticles.material.color.set(0xffcc00); // Yellow\n            } else if (resourceType === 'platinum') {\n                this.miningParticles.material.color.set(0x66ffff); // Light blue\n            }\n            \n            // Adjust particle size based on mining efficiency\n            if (efficiency > 1.0) {\n                this.miningParticles.material.size = 1.5 * Math.sqrt(efficiency);\n            }\n        }\n    }\n\n    /**\n     * Hide mining particles\n     */\n    hideMiningParticles(): void {\n        if (this.miningParticles) {\n            this.miningParticles.visible = false;\n        }\n    }\n\n    /**\n     * Update mining particles animation\n     */\n    updateMiningParticles(efficiency = 1.0): void {\n        if (!this.miningParticles || !this.miningParticles.visible) return;\n        \n        const positions = this.miningParticles.geometry.attributes.position.array as Float32Array;\n        \n        // Particles move faster with higher efficiency\n        const particleSpeed = 0.3 * efficiency;\n        \n        for (let i = 0; i < positions.length; i += 3) {\n            // Move particles outward slightly\n            const dir = new THREE.Vector3(positions[i], positions[i+1], positions[i+2]);\n            dir.normalize().multiplyScalar(particleSpeed);\n            \n            positions[i] += dir.x;\n            positions[i+1] += dir.y;\n            positions[i+2] += dir.z;\n            \n            // Reset particles that move too far\n            const dist = Math.sqrt(\n                positions[i] * positions[i] + \n                positions[i+1] * positions[i+1] + \n                positions[i+2] * positions[i+2]\n            );\n            \n            if (dist > 36) {\n                positions[i] = (Math.random() - 0.5) * 24;\n                positions[i+1] = (Math.random() - 0.5) * 24;\n                positions[i+2] = (Math.random() - 0.5) * 24;\n            }\n        }\n        this.miningParticles.geometry.attributes.position.needsUpdate = true;\n    }\n\n    /**\n     * Update particles position to asteroid location\n     */\n    setParticlesPosition(position: THREE.Vector3): void {\n        if (this.miningParticles && this.miningParticles.visible) {\n            this.miningParticles.position.copy(position);\n        }\n    }\n\n    /**\n     * Create asteroid break effect\n     */\n    createAsteroidBreakEffect(position: THREE.Vector3): void {\n        // Create particle effect for asteroid breaking\n        const particleCount = 50;\n        const particles = new THREE.BufferGeometry();\n        const particleMaterial = new THREE.PointsMaterial({\n            color: 0xaaaaaa,\n            size: 12,\n            blending: THREE.AdditiveBlending,\n            transparent: true,\n            opacity: 0.8\n        });\n        \n        const positions = new Float32Array(particleCount * 3);\n        const velocities: Velocity[] = [];\n        \n        for (let i = 0; i < particleCount; i++) {\n            // Start at asteroid position\n            positions[i * 3] = position.x;\n            positions[i * 3 + 1] = position.y;\n            positions[i * 3 + 2] = position.z;\n            \n            // Random velocity in all directions\n            velocities.push({\n                x: (Math.random() - 0.5) * 8,\n                y: (Math.random() - 0.5) * 8,\n                z: (Math.random() - 0.5) * 8\n            });\n        }\n        \n        particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));\n        const particleSystem = new THREE.Points(particles, particleMaterial);\n        this.scene.add(particleSystem);\n        \n        // Animate particles\n        let frameCount = 0;\n        const animateParticles = () => {\n            frameCount++;\n            \n            // Update particle positions\n            const positions = particleSystem.geometry.attributes.position.array as Float32Array;\n            \n            for (let i = 0; i < particleCount; i++) {\n                positions[i * 3] += velocities[i].x;\n                positions[i * 3 + 1] += velocities[i].y;\n                positions[i * 3 + 2] += velocities[i].z;\n            }\n            \n            particleSystem.geometry.attributes.position.needsUpdate = true;\n            \n            // Fade out over time\n            particleSystem.material.opacity = Math.max(0, 0.8 - frameCount * 0.02);\n            \n            // Remove after 40 frames\n            if (frameCount < 40) {\n                requestAnimationFrame(animateParticles);\n            } else {\n                this.scene.remove(particleSystem);\n            }\n        };\n        \n        animateParticles();\n    }\n\n    /**\n     * Cleanup resources\n     */\n    cleanup(): void {\n        if (this.miningParticles) {\n            if (this.miningParticles.geometry) this.miningParticles.geometry.dispose();\n            if (this.miningParticles.material) this.miningParticles.material.dispose();\n            this.scene.remove(this.miningParticles);\n            this.miningParticles = null;\n        }\n    }\n}\n","// miningSystem.js - Handles asteroid mining functionality\n\nimport * as THREE from 'three';\nimport { LaserControl } from './mining/laserControl.ts';\nimport { TargetValidation } from './mining/targetValidation.ts';\nimport { ResourceExtraction } from './mining/resourceExtraction.ts';\nimport { UIUpdates } from './mining/uiUpdates.ts';\nimport { VisualEffects } from './mining/visualEffects.ts';\n\ntype MiningSpaceship = {\n    miningEfficiency?: number;\n    mesh: THREE.Object3D;\n    shield?: number;\n    maxShield?: number;\n    hull?: number;\n    maxHull?: number;\n    syncValuesToHealthComponent?: () => void;\n};\n\ntype MiningAsteroid = {\n    resourceType?: string;\n    mesh: THREE.Object3D;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        audio?: {\n            playSound: (id: string) => void;\n            stopSound: (id: string) => void;\n        };\n    };\n};\n\nexport class MiningSystem {\n    spaceship: MiningSpaceship;\n    scene: THREE.Scene;\n    isMining: boolean;\n    targetAsteroid: MiningAsteroid | null;\n    miningProgress: number;\n    lastDestroyedAsteroid: MiningAsteroid | null;\n    miningSpeedByType: Record<string, number>;\n    miningSpeed: number;\n    miningDistance: number;\n    miningCooldown: number;\n    laserControl: LaserControl;\n    targetValidation: TargetValidation;\n    resourceExtraction: ResourceExtraction;\n    uiUpdates: UIUpdates;\n    visualEffects: VisualEffects;\n\n    constructor(spaceship: MiningSpaceship, scene: THREE.Scene) {\n        this.spaceship = spaceship;\n        this.scene = scene;\n        this.isMining = false;\n        this.targetAsteroid = null;\n        this.miningProgress = 0;\n        this.lastDestroyedAsteroid = null;\n        \n        // Mining speeds for single-action mining that takes 7.5, 22.5, and 45 seconds respectively\n        // Values are in progress per second (1 / seconds_required)\n        this.miningSpeedByType = {\n            iron: 0.133,     // 1/7.5 seconds to complete\n            gold: 0.044,     // 1/22.5 seconds to complete\n            platinum: 0.022  // 1/45 seconds to complete\n        };\n        this.miningSpeed = 0.133; // Default speed, will be set based on asteroid type\n        this.miningDistance = 6000; // Maximum mining distance\n        this.miningCooldown = 0;\n        \n        // Initialize component modules\n        this.laserControl = new LaserControl(scene, spaceship);\n        this.targetValidation = new TargetValidation(spaceship, this.miningDistance);\n        this.resourceExtraction = new ResourceExtraction();\n        this.uiUpdates = new UIUpdates();\n        this.visualEffects = new VisualEffects(scene);\n    }\n    \n    // Helper method to get the mining efficiency from the spaceship\n    getMiningEfficiency(): number {\n        return this.spaceship && this.spaceship.miningEfficiency \n            ? this.spaceship.miningEfficiency \n            : 1.0; // Default value if spaceship property not available\n    }\n    \n    // Expose resources from the resource extraction module\n    get resources(): ReturnType<ResourceExtraction['getResources']> {\n        return this.resourceExtraction.getResources();\n    }\n    \n    setTargetAsteroid(asteroid: MiningAsteroid): boolean {\n        try {\n            console.log(\"MiningSystem: setTargetAsteroid called\", asteroid);\n            \n            // Validate asteroid using validation module\n            if (!this.targetValidation.validateAsteroid(asteroid)) {\n                return false;\n            }\n            \n            this.targetAsteroid = asteroid;\n            \n            // Set mining speed based on asteroid resource type and apply efficiency modifier\n            if (asteroid && asteroid.resourceType) {\n                const resourceType = asteroid.resourceType.toLowerCase();\n                const baseSpeed = this.miningSpeedByType[resourceType] || this.miningSpeedByType.iron;\n                const efficiency = this.getMiningEfficiency();\n                \n                this.miningSpeed = baseSpeed * efficiency;\n                console.log(`Mining ${resourceType} asteroid with speed: ${this.miningSpeed} (efficiency: ${efficiency}x)`);\n                \n                // Update UI using UI module\n                this.uiUpdates.updateTargetInfo(asteroid, this.spaceship, this.miningDistance);\n            } else {\n                // Default to iron speed if no resource type is specified\n                this.miningSpeed = this.miningSpeedByType.iron * this.getMiningEfficiency();\n            }\n            \n            return true;\n        } catch (error) {\n            console.error(\"MiningSystem: Error in setTargetAsteroid:\", error);\n            return false;\n        }\n    }\n    \n    startMining(): void {\n        try {\n            console.log(\"MiningSystem: startMining called\");\n            \n            // Don't allow mining if no asteroid is targeted\n            if (!this.targetAsteroid) {\n                console.error(\"MiningSystem: Cannot start mining - no target asteroid set\");\n                return;\n            }\n\n            // Validate mining conditions using validation module\n            const canMine = this.targetValidation.canStartMining(this.targetAsteroid);\n            if (!canMine.valid) {\n                if (canMine.reason === \"Out of range\") {\n                    this.uiUpdates.showOutOfRangeMessage();\n                }\n                console.log(`MiningSystem: ${canMine.reason}`);\n                return;\n            }\n            \n            // Set mining state to active\n            this.isMining = true;\n            this.miningProgress = 0;\n            console.log(\"MiningSystem: Mining state activated\");\n            \n            // Setup laser beam using laser control module\n            this.laserControl.setupLaserBeam(this.targetAsteroid);\n            \n            // Show mining particles using visual effects module\n            this.visualEffects.showMiningParticles(this.targetAsteroid, this.getMiningEfficiency());\n            \n            // Setup mining progress bar using UI module\n            this.uiUpdates.setupMiningProgressBar();\n            \n            // Activate the spaceship's laser emitter\n            this.laserControl.activateSpaceshipLaser();\n            \n            // Update mining status display with timing info\n            this.updateMiningStatusWithTime();\n            \n            // Trigger laser sound\n            const windowWithGame = window as GameWindow;\n            if (windowWithGame.game && windowWithGame.game.audio) {\n                windowWithGame.game.audio.playSound('mining-laser');\n            } else if (windowWithGame.game && windowWithGame.game.audio) {\n                windowWithGame.game.audio.playSound('laser');\n            }\n            \n            console.log(\"MiningSystem: Mining successfully started\");\n        } catch (error) {\n            console.error(\"MiningSystem: Error in startMining:\", error);\n            this.isMining = false;\n        }\n    }\n    \n    // Update the mining status with time estimate\n    updateMiningStatusWithTime(): void {\n        this.uiUpdates.updateMiningStatusWithTime(\n            this.targetAsteroid, \n            this.miningSpeed, \n            this.getMiningEfficiency()\n        );\n    }\n    \n    stopMining(): void {\n        if (!this.isMining) return;\n        \n        this.isMining = false;\n        this.miningProgress = 0;\n        \n        // Hide laser beam using laser control module\n        this.laserControl.hideLaserBeam();\n        \n        // Hide mining particles using visual effects module\n        this.visualEffects.hideMiningParticles();\n        \n        // Hide mining progress bar using UI module\n        this.uiUpdates.hideMiningProgressBar();\n        \n        // Deactivate the spaceship's laser emitter\n        this.laserControl.deactivateSpaceshipLaser();\n        \n        // Reset mining status display\n        this.uiUpdates.resetMiningStatus();\n        \n        // Stop laser sound\n        const windowWithGame = window as GameWindow;\n        if (windowWithGame.game && windowWithGame.game.audio) {\n            windowWithGame.game.audio.stopSound('mining-laser');\n        }\n    }\n    \n    update(deltaTime = 1/60): void {\n        // Update mining cooldown\n        if (this.miningCooldown > 0) {\n            this.miningCooldown--;\n        }\n        \n        // Update mining if active\n        if (this.isMining) {\n            this.updateMining(deltaTime);\n        }\n        \n        // Update mining particles if visible\n        this.visualEffects.updateMiningParticles(this.getMiningEfficiency());\n        \n        // Update target info if we have a target but aren't mining\n        if (this.targetAsteroid && !this.isMining) {\n            this.uiUpdates.updateTargetInfo(this.targetAsteroid, this.spaceship, this.miningDistance);\n        }\n    }\n    \n    updateMining(deltaTime = 1/60): void {\n        // Make sure we have a target asteroid\n        if (!this.targetAsteroid || !this.isMining) {\n            this.stopMining();\n            return;\n        }\n        \n        // Check if asteroid is in range - if not, stop mining and require new click\n        const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\n        if (distance > this.miningDistance) {\n            this.stopMining();\n            return;\n        }\n        \n        // Update mining progress using deltaTime for frame-rate independence\n        this.miningProgress += this.miningSpeed * deltaTime;\n        \n        // Update laser beam position\n        this.laserControl.updateLaserBeam(this.targetAsteroid);\n        \n        // Update mining particles position\n        this.visualEffects.setParticlesPosition(this.targetAsteroid.mesh.position);\n        \n        // Complete mining when progress reaches 1.0\n        if (this.miningProgress >= 1.0) {\n            // Add resources from asteroid in one batch\n            this.resourceExtraction.addAsteroidResources(this.targetAsteroid, this.getMiningEfficiency());\n            \n            // Create asteroid break effect\n            this.visualEffects.createAsteroidBreakEffect(this.targetAsteroid.mesh.position);\n            \n            // Store reference to the destroyed asteroid\n            this.lastDestroyedAsteroid = this.targetAsteroid;\n            \n            // Remove asteroid from scene\n            this.scene.remove(this.targetAsteroid.mesh);\n            \n            // Stop mining\n            this.stopMining();\n            this.targetAsteroid = null;\n        }\n        \n        // Update the progress bar\n        this.uiUpdates.updateMiningProgress(this.miningProgress);\n    }\n    \n    \n    \n    \n    \n    \n    // New method to retrieve the last destroyed asteroid and reset the property\n    getLastDestroyedAsteroid(): MiningAsteroid | null {\n        const destroyedAsteroid = this.lastDestroyedAsteroid;\n        this.lastDestroyedAsteroid = null; // Reset after getting it\n        return destroyedAsteroid;\n    }\n    \n} \n","// targetingSystem.js - Handles asteroid targeting and lock-on\n\nimport * as THREE from 'three';\n\ntype Asteroid = {\n    minable: boolean;\n    resourceType?: string;\n    mesh: THREE.Object3D & {\n        position: THREE.Vector3;\n        visible: boolean;\n        parent?: THREE.Object3D | null;\n    };\n};\n\ntype Environment = {\n    asteroids: Asteroid[];\n};\n\ntype NearbyAsteroid = {\n    asteroid: Asteroid;\n    distance: number;\n};\n\ntype SceneWithCamera = THREE.Scene & {\n    camera: THREE.Camera;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        environment?: Environment;\n    };\n    gameInstance?: {\n        environment?: Environment;\n    };\n};\n\nexport class TargetingSystem {\n    spaceship: {\n        mesh: {\n            position: THREE.Vector3;\n        };\n        scanRange?: number;\n    };\n    scene: SceneWithCamera;\n    environment: Environment;\n    lockOnEnabled: boolean;\n    nearbyAsteroids: Asteroid[];\n    currentLockOnIndex: number;\n    targetAsteroid: Asteroid | null;\n    scanRadius: number;\n    targetReticle!: THREE.Mesh;\n    offScreenContainer: HTMLDivElement | null = null;\n    offScreenIndicator: HTMLDivElement | null = null;\n    targetDisplay: HTMLElement | null = null;\n    targetInfoElement: HTMLElement | null = null;\n    scanRadiusCounter?: number;\n    rescanCounter?: number;\n    lookAtCounter?: number;\n    pulseTime?: number;\n    uiUpdateCounter?: number;\n\n    constructor(spaceship: TargetingSystem['spaceship'], scene: SceneWithCamera, environment: Environment) {\n        this.spaceship = spaceship;\n        this.scene = scene;\n        this.environment = environment;\n        \n        this.lockOnEnabled = false;\n        this.nearbyAsteroids = [];\n        this.currentLockOnIndex = -1;\n        this.targetAsteroid = null;\n        this.scanRadius = this.getScanRadius(); // Get initial scan radius from spaceship\n        this.targetDisplay = document.getElementById('target-display');\n        this.targetInfoElement = document.getElementById('target-info');\n        \n        this.createTargetReticle();\n        // Create off-screen indicators\n        this.createOffScreenIndicators();\n    }\n    \n    createTargetReticle(): void {\n        // Create the target indicator geometry (outer ring)\n        const ringGeometry = new THREE.RingGeometry(150, 180, 32);\n        const ringMaterial = new THREE.MeshBasicMaterial({\n            color: 0xff3030,\n            side: THREE.DoubleSide,\n            transparent: true,\n            opacity: 0.7\n        });\n        \n        this.targetReticle = new THREE.Mesh(ringGeometry, ringMaterial);\n        this.targetReticle.visible = false;\n        this.scene.add(this.targetReticle);\n        \n        // Add inner ring for additional visual interest\n        const innerRingGeometry = new THREE.RingGeometry(75, 90, 32);\n        const innerRingMaterial = new THREE.MeshBasicMaterial({\n            color: 0xff6060,\n            side: THREE.DoubleSide,\n            transparent: true,\n            opacity: 0.5\n        });\n        \n        const innerRing = new THREE.Mesh(innerRingGeometry, innerRingMaterial);\n        this.targetReticle.add(innerRing);\n    }\n    \n    // Helper method to get the current scan radius from the spaceship\n    getScanRadius(): number {\n        // Increase default scan radius by 5x (from 1000 to 5000)\n        return this.spaceship && this.spaceship.scanRange \n            ? this.spaceship.scanRange * 5 \n            : 5000; // Default value increased by 5x\n    }\n    \n    toggleLockOn(): boolean {\n        this.lockOnEnabled = !this.lockOnEnabled;\n        \n        if (this.lockOnEnabled) {\n            // Update scan radius before scanning\n            this.scanRadius = this.getScanRadius();\n            \n            // Scan for nearby asteroids\n            this.scanForAsteroids();\n            \n            // Only show targeting UI if we're actually enabling targeting\n            const targetInfoElement = document.getElementById('target-info');\n            if (targetInfoElement) {\n                targetInfoElement.style.display = 'block';\n                targetInfoElement.style.color = '#30cfd0';\n                \n                // Update the content to show we're scanning\n                const targetName = document.getElementById('target-name');\n                if (targetName) {\n                    targetName.textContent = 'Scanning for targets...';\n                }\n            }\n            \n            // Automatically select the closest target\n            if (this.nearbyAsteroids.length > 0) {\n                this.findNearestTarget();\n            }\n        } else {\n            // Clear target and hide UI\n            this.nearbyAsteroids = [];\n            this.currentLockOnIndex = -1;\n            this.targetAsteroid = null;\n            this.targetReticle.visible = false;\n            \n            // Hide off-screen indicators\n            this.hideOffScreenIndicators();\n            \n            // Hide targeting UI\n            const targetInfoElement = document.getElementById('target-info');\n            if (targetInfoElement) {\n                targetInfoElement.style.display = 'none';\n            }\n        }\n        \n        return this.lockOnEnabled;\n    }\n    \n    scanForAsteroids(): boolean {\n        this.nearbyAsteroids = [];\n        const shipPosition = this.spaceship.mesh.position;\n        \n        // Create raycaster for line-of-sight validation\n        const raycaster = new THREE.Raycaster();\n        const nearby: NearbyAsteroid[] = [];\n        \n        // Find all asteroids within scan radius\n        const asteroids = this.environment.asteroids;\n        asteroids.forEach(asteroid => {\n            // Skip asteroids that aren't minable or visible\n            if (!asteroid.minable || !asteroid.mesh.visible) return;\n            \n            const distance = shipPosition.distanceTo(asteroid.mesh.position);\n            if (distance <= this.scanRadius) {\n                // Perform raycasting to verify line of sight\n                const direction = new THREE.Vector3()\n                    .subVectors(asteroid.mesh.position, shipPosition)\n                    .normalize();\n                \n                raycaster.set(shipPosition, direction);\n                raycaster.far = distance;\n                \n                // Check for intersections with all asteroids\n                const intersects = raycaster.intersectObjects(\n                    asteroids.filter(a => a.mesh && a.mesh.visible).map(a => a.mesh)\n                );\n                \n                // If the first intersection is our target asteroid, it's visible\n                if (intersects.length > 0 && intersects[0].object === asteroid.mesh) {\n                    nearby.push({\n                        asteroid: asteroid,\n                        distance: distance\n                    });\n                }\n            }\n        });\n        \n        // Sort by distance\n        nearby.sort((a, b) => a.distance - b.distance);\n        \n        // Extract just the asteroid objects after sorting\n        this.nearbyAsteroids = nearby.map(item => item.asteroid);\n        \n        // Set current target if we found asteroids\n        if (this.nearbyAsteroids.length > 0) {\n            this.currentLockOnIndex = 0;\n            this.updateLockedOnTarget();\n            \n            // Update UI to show number of detected asteroids\n            const targetNameElement = document.getElementById('target-name');\n            if (targetNameElement) {\n                targetNameElement.textContent = \n                    `Target 1/${this.nearbyAsteroids.length} (${Math.round(this.nearbyAsteroids[0].mesh.position.distanceTo(shipPosition))} units)`;\n            }\n            \n            return true;\n        } else {\n            // No targets found\n            const targetNameElement = document.getElementById('target-name');\n            if (targetNameElement) {\n                targetNameElement.textContent = 'No targets in range';\n            }\n            this.targetReticle.visible = false;\n            this.targetAsteroid = null;\n            \n            return false;\n        }\n    }\n    \n    cycleLockOnTarget(_direction?: number): Asteroid | null {\n        if (!this.lockOnEnabled || this.nearbyAsteroids.length === 0) return null;\n        \n        // Move to next target\n        this.currentLockOnIndex = (this.currentLockOnIndex + 1) % this.nearbyAsteroids.length;\n        return this.updateLockedOnTarget();\n    }\n    \n    updateLockedOnTarget(): Asteroid | null {\n        this.targetAsteroid = this.nearbyAsteroids[this.currentLockOnIndex];\n        \n        if (this.targetAsteroid) {\n            // Don't update UI here - let the mining system handle it\n            // This prevents overwriting the mining system's detailed info\n            console.log(`Target locked: ${this.targetAsteroid.resourceType} asteroid`);\n            \n            // Position the targeting indicator\n            this.targetReticle.position.copy(this.targetAsteroid.mesh.position);\n            this.targetReticle.visible = true;\n            \n            // Make the indicator look at the camera\n            const lookAtPos = new THREE.Vector3().copy(this.scene.camera.position);\n            this.targetReticle.lookAt(lookAtPos);\n            \n            // Ensure proper scale and visibility\n            this.targetReticle.scale.set(1, 1, 1);\n            (this.targetReticle.material as THREE.MeshBasicMaterial).opacity = 0.8;\n            if (this.targetReticle.children.length > 0) {\n                const child = this.targetReticle.children[0] as THREE.Mesh;\n                if (child.material && 'opacity' in child.material) {\n                    (child.material as THREE.MeshBasicMaterial).opacity = 0.8;\n                }\n            }\n        }\n        \n        return this.targetAsteroid;\n    }\n    \n    getCurrentTarget(): Asteroid | null {\n        try {\n            console.log(\"TargetingSystem: getCurrentTarget called\");\n            \n            // Check if we have a valid target\n            if (!this.targetAsteroid) {\n                console.log(\"TargetingSystem: No current target\");\n                return null;\n            }\n            \n            // Validate the target is still valid\n            if (!this.targetAsteroid.mesh || !this.targetAsteroid.mesh.position) {\n                console.error(\"TargetingSystem: Current target is invalid, clearing target\");\n                this.targetAsteroid = null;\n                return null;\n            }\n            \n            console.log(\"TargetingSystem: Returning current target:\", this.targetAsteroid);\n            return this.targetAsteroid;\n        } catch (error) {\n            console.error(\"TargetingSystem: Error in getCurrentTarget:\", error);\n            return null;\n        }\n    }\n    \n    isLockOnEnabled(): boolean {\n        return this.lockOnEnabled === true;\n    }\n    \n    findNearestTarget(): Asteroid | null {\n        try {\n            if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\n                return null;\n            }\n            \n            // Get all asteroids\n            let asteroids = [];\n            \n            // Try to get asteroids from the game environment\n            const windowWithGame = window as GameWindow;\n            const game = windowWithGame.gameInstance || windowWithGame.game;\n            if (game && game.environment && Array.isArray(game.environment.asteroids)) {\n                asteroids = game.environment.asteroids;\n            } else {\n                return null;\n            }\n            \n            if (asteroids.length === 0) {\n                return null;\n            }\n            \n            // Find the closest asteroid with proper validation\n            let closestAsteroid = null;\n            let closestDistance = Infinity;\n            \n            for (const asteroid of asteroids) {\n                // Validate asteroid has required properties and is visible and minable\n                if (!asteroid || !asteroid.mesh || !asteroid.mesh.position || !asteroid.mesh.visible || !asteroid.minable) {\n                    continue;\n                }\n                \n                const distance = this.spaceship.mesh.position.distanceTo(asteroid.mesh.position);\n                \n                if (distance < closestDistance) {\n                    closestDistance = distance;\n                    closestAsteroid = asteroid;\n                }\n            }\n            \n            if (closestAsteroid) {\n                console.log(\"TargetingSystem: Found nearest target:\", closestAsteroid);\n                \n                // Select this target\n                this.setTarget(closestAsteroid);\n                \n                return closestAsteroid;\n            } else {\n                console.log(\"TargetingSystem: No valid asteroid found after checking all asteroids\");\n                return null;\n            }\n        } catch (error) {\n            console.error(\"TargetingSystem: Error in findNearestTarget:\", error);\n            return null;\n        }\n    }\n    \n    update(): void {\n        // Only update scan radius every 30 frames for performance\n        if (!this.scanRadiusCounter) this.scanRadiusCounter = 0;\n        this.scanRadiusCounter++;\n        if (this.scanRadiusCounter >= 30) {\n            this.scanRadiusCounter = 0;\n            this.scanRadius = this.getScanRadius();\n        }\n        \n        // If targeting is enabled, periodically rescan for new asteroids\n        if (this.lockOnEnabled) {\n            // Rescan every 120 frames (about every 2 seconds at 60fps) for better performance\n            if (!this.rescanCounter) this.rescanCounter = 0;\n            this.rescanCounter++;\n            \n            if (this.rescanCounter >= 120) {\n                this.rescanCounter = 0;\n                this.scanForAsteroids();\n                \n                // If we found new asteroids and don't have a target, auto-select one\n                if (this.nearbyAsteroids.length > 0 && !this.targetAsteroid) {\n                    this.findNearestTarget();\n                }\n            }\n        }\n        \n        // Update lock-on targeting visuals (optimized)\n        if (this.lockOnEnabled && this.targetAsteroid) {\n            // Update target indicator position\n            this.targetReticle.position.copy(this.targetAsteroid.mesh.position);\n            \n            // Make indicator face the camera (less frequently)\n            if (!this.lookAtCounter) this.lookAtCounter = 0;\n            this.lookAtCounter++;\n            if (this.lookAtCounter >= 10) {  // Every 10 frames instead of every frame\n                this.lookAtCounter = 0;\n                this.targetReticle.lookAt(this.scene.camera.position);\n            }\n            \n            // Simple rotation animation (more efficient)\n            this.targetReticle.rotation.z += 0.005;  // Reduced rotation speed\n            if (this.targetReticle.children.length > 0) {\n                this.targetReticle.children[0].rotation.z -= 0.01;\n            }\n            \n            // Simplified pulsing (no Date.now() calls)\n            if (!this.pulseTime) this.pulseTime = 0;\n            this.pulseTime += 0.02;  // Fixed time step\n            const pulseValue = Math.sin(this.pulseTime);\n            const opacity = 0.7 + 0.2 * pulseValue;  // Less dramatic pulsing\n            (this.targetReticle.material as THREE.MeshBasicMaterial).opacity = opacity;\n            \n            // Update UI less frequently for performance\n            if (!this.uiUpdateCounter) this.uiUpdateCounter = 0;\n            this.uiUpdateCounter++;\n            if (this.uiUpdateCounter >= 30) {  // Update UI every 30 frames (~0.5 seconds)\n                this.uiUpdateCounter = 0;\n                \n                // Update distance in UI\n                const targetDistanceElement = document.getElementById('target-distance');\n                if (targetDistanceElement) {\n                    const distance = Math.round(this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position));\n                    targetDistanceElement.textContent = `Distance: ${distance} units`;\n                }\n                \n                // Check if target is destroyed or too far away\n                if (!this.targetAsteroid.mesh.parent || \n                    this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position) > this.scanRadius) {\n                    this.scanForAsteroids();\n                }\n            }\n            \n            // Always show the reticle when targeting\n            this.targetReticle.visible = true;\n            \n            // Simplified off-screen indicator (check less frequently)\n            if (this.uiUpdateCounter === 15) {  // Check half-way through UI update cycle\n                const isOnScreen = this.isTargetOnScreen();\n                if (!isOnScreen) {\n                    const targetDirection = this.getTargetDirection();\n                    this.showOffScreenIndicator(targetDirection);\n                } else {\n                    this.hideOffScreenIndicators();\n                }\n            }\n        }\n    }\n    \n    setTarget(target: Asteroid): boolean | void {\n        try {\n            console.log(\"TargetingSystem: setTarget called\", target);\n            \n            // Validate the target\n            if (!target) {\n                console.error(\"TargetingSystem: Cannot set null target\");\n                return;\n            }\n            \n            if (!target.mesh || !target.mesh.position) {\n                console.error(\"TargetingSystem: Target is missing mesh or position properties\", target);\n                return;\n            }\n            \n            // Set the target\n            this.targetAsteroid = target;\n            \n            // Update UI elements\n            if (this.targetDisplay) {\n                this.targetDisplay.style.display = 'block';\n            }\n            \n            if (this.targetInfoElement) {\n                // Format target info\n                const distance = this.calculateDistanceToTarget();\n                let resourceType = target.resourceType || 'Unknown';\n                \n                // Capitalize first letter\n                resourceType = resourceType.charAt(0).toUpperCase() + resourceType.slice(1);\n                \n                // Update target info text\n                this.targetInfoElement.textContent = `${resourceType} Asteroid - ${distance.toFixed(0)}m`;\n                this.targetInfoElement.style.color = '#30cfd0';\n                this.targetInfoElement.style.display = 'block';\n            }\n            \n            console.log(\"TargetingSystem: Target successfully set\", this.targetAsteroid);\n            \n            // Enable lock-on\n            this.lockOnEnabled = true;\n            \n            return true;\n        } catch (error) {\n            console.error(\"TargetingSystem: Error in setTarget:\", error);\n            return false;\n        }\n    }\n    \n    calculateDistanceToTarget(): number {\n        try {\n            if (!this.targetAsteroid || !this.targetAsteroid.mesh || !this.targetAsteroid.mesh.position) {\n                console.error(\"TargetingSystem: Cannot calculate distance - invalid target asteroid\");\n                return Infinity;\n            }\n            \n            if (!this.spaceship || !this.spaceship.mesh || !this.spaceship.mesh.position) {\n                console.error(\"TargetingSystem: Cannot calculate distance - invalid spaceship\");\n                return Infinity;\n            }\n            \n            const distance = this.spaceship.mesh.position.distanceTo(this.targetAsteroid.mesh.position);\n            return distance;\n        } catch (error) {\n            console.error(\"TargetingSystem: Error calculating distance to target:\", error);\n            return Infinity;\n        }\n    }\n    \n    // Add methods for off-screen indicators\n    createOffScreenIndicators(): void {\n        // Create container for off-screen indicators\n        this.offScreenContainer = document.createElement('div');\n        this.offScreenContainer.id = 'off-screen-indicators';\n        this.offScreenContainer.style.position = 'absolute';\n        this.offScreenContainer.style.top = '0';\n        this.offScreenContainer.style.left = '0';\n        this.offScreenContainer.style.width = '100%';\n        this.offScreenContainer.style.height = '100%';\n        this.offScreenContainer.style.pointerEvents = 'none';\n        this.offScreenContainer.style.display = 'none';\n        document.body.appendChild(this.offScreenContainer);\n        \n        // Create the arrow indicator\n        this.offScreenIndicator = document.createElement('div');\n        this.offScreenIndicator.style.position = 'absolute';\n        this.offScreenIndicator.style.width = '30px';\n        this.offScreenIndicator.style.height = '30px';\n        this.offScreenIndicator.innerHTML = `\n            <svg width=\"30\" height=\"30\" viewBox=\"0 0 30 30\">\n                <polygon points=\"15,0 30,30 15,22 0,30\" fill=\"#ff3030\" />\n            </svg>\n        `;\n        this.offScreenIndicator.style.transformOrigin = 'center center';\n        this.offScreenIndicator.style.display = 'none';\n        this.offScreenContainer.appendChild(this.offScreenIndicator);\n    }\n    \n    hideOffScreenIndicators(): void {\n        if (this.offScreenContainer) {\n            this.offScreenContainer.style.display = 'none';\n        }\n        if (this.offScreenIndicator) {\n            this.offScreenIndicator.style.display = 'none';\n        }\n    }\n    \n    showOffScreenIndicator(targetDirection: THREE.Vector2): void {\n        if (!this.offScreenContainer || !this.offScreenIndicator) return;\n        \n        // Show container\n        this.offScreenContainer.style.display = 'block';\n        this.offScreenIndicator.style.display = 'block';\n        \n        // Calculate angle for the arrow to point at target\n        const angle = Math.atan2(targetDirection.y, targetDirection.x) * (180 / Math.PI);\n        \n        // Position at the edge of screen\n        const margin = 50; // Margin from the screen edge\n        const halfWidth = window.innerWidth / 2;\n        const halfHeight = window.innerHeight / 2;\n        \n        // Normalize direction vector\n        const normalizedDir = new THREE.Vector2(targetDirection.x, targetDirection.y).normalize();\n        \n        // Calculate intersection with screen edge\n        let edgeX, edgeY;\n        \n        // Check if we're intersecting with the vertical or horizontal edge\n        const slopeRatio = Math.abs(normalizedDir.y / normalizedDir.x);\n        const screenRatio = halfHeight / halfWidth;\n        \n        if (slopeRatio > screenRatio) {\n            // Intersect with top/bottom edge\n            edgeY = normalizedDir.y > 0 ? halfHeight - margin : -halfHeight + margin;\n            edgeX = edgeY / normalizedDir.y * normalizedDir.x;\n        } else {\n            // Intersect with left/right edge\n            edgeX = normalizedDir.x > 0 ? halfWidth - margin : -halfWidth + margin;\n            edgeY = edgeX / normalizedDir.x * normalizedDir.y;\n        }\n        \n        // Position the indicator at the edge of the screen\n        this.offScreenIndicator.style.left = (halfWidth + edgeX) + 'px';\n        this.offScreenIndicator.style.top = (halfHeight + edgeY) + 'px';\n        this.offScreenIndicator.style.transform = `rotate(${angle}deg)`;\n    }\n    \n    // Helper methods for screen position calculations\n    isTargetOnScreen(): boolean {\n        if (!this.targetAsteroid || !this.targetAsteroid.mesh) return false;\n        \n        const screenPosition = this.getScreenPosition(this.targetAsteroid.mesh.position);\n        \n        // Check if position is within screen bounds with some margin\n        const margin = 0.1; // 10% margin\n        return screenPosition.x >= -1 + margin && \n               screenPosition.x <= 1 - margin && \n               screenPosition.y >= -1 + margin && \n               screenPosition.y <= 1 - margin;\n    }\n    \n    getScreenPosition(worldPosition: THREE.Vector3): THREE.Vector2 {\n        // Create a copy of the position\n        const tempVector = new THREE.Vector3().copy(worldPosition);\n        \n        // Project to screen space\n        tempVector.project(this.scene.camera);\n        \n        return new THREE.Vector2(tempVector.x, tempVector.y);\n    }\n    \n    getTargetDirection(): THREE.Vector2 {\n        // Get normalized direction vector from screen center to target\n        if (!this.targetAsteroid) {\n            return new THREE.Vector2(0, 0);\n        }\n        const screenPosition = this.getScreenPosition(this.targetAsteroid.mesh.position);\n        \n        // Create a direction vector from screen center to target position\n        return new THREE.Vector2(screenPosition.x, screenPosition.y);\n    }\n} \n","// proximityDetector.js - Handles stargate proximity detection\n\nimport type { ProximitySpaceship, ProximityStargate, ProximityUI } from './types.ts';\n\nexport class ProximityDetector {\n    nearStargate: boolean;\n\n    constructor() {\n        this.nearStargate = false;\n    }\n\n    // Check if spaceship is within docking range of stargate\n    checkStargateProximity(spaceship: ProximitySpaceship, stargate: ProximityStargate, ui: ProximityUI): void {\n        if (spaceship.isDocked) return;\n        \n        if (!stargate || !spaceship || !spaceship.mesh) return;\n        \n        const stargatePosition = stargate.getPosition();\n        if (!stargatePosition) return;\n        \n        const distance = spaceship.mesh.position.distanceTo(stargatePosition);\n        \n        if (distance < 2000) { // Within docking range (4x the original 500)\n            this.nearStargate = true;\n            if (ui && ui.stargateInterface) {\n                ui.stargateInterface.showDockingPrompt?.();\n            }\n            // Also show the dock button in touch controls for mobile\n            if (ui && ui.controls && ui.controls.isMobile && \n                ui.controls.touchControls) {\n                ui.controls.touchControls.showDockButton?.();\n            }\n        } else {\n            this.nearStargate = false;\n            if (ui && ui.stargateInterface) {\n                ui.stargateInterface.hideDockingPrompt?.();\n            }\n            // Also hide the dock button in touch controls for mobile\n            if (ui && ui.controls && ui.controls.isMobile && \n                ui.controls.touchControls) {\n                ui.controls.touchControls.hideDockButton?.();\n            }\n        }\n    }\n\n    isNearStargate() {\n        return this.nearStargate;\n    }\n}\n","// dockingLogic.js - Core docking and undocking logic\n\nimport type { DockingSpaceship, DockingUI, MessageBus } from './types.ts';\n\ntype GameWindow = Window & {\n    game?: {\n        messageBus?: MessageBus;\n        ui?: {\n            starMap?: {\n                hide?: () => void;\n            };\n            customSystemCreator?: {\n                hide?: () => void;\n            };\n        };\n    };\n    mainMessageBus?: MessageBus;\n};\n\nexport class DockingLogic {\n    isDocked: boolean;\n    dockingAvailable: boolean;\n    autoPointerLockOnUndock: boolean;\n    preUndockShieldValue: number;\n\n    constructor() {\n        this.isDocked = false;\n        this.dockingAvailable = false;\n        this.autoPointerLockOnUndock = true;\n        this.preUndockShieldValue = 0;\n    }\n\n    // Method to detect mobile devices\n    isMobileDevice(): boolean {\n        return ('ontouchstart' in window) || \n               (navigator.maxTouchPoints > 0) || \n               (window.innerWidth < 900);\n    }\n\n    dockWithStargate(spaceship: DockingSpaceship, stargate: unknown, ui: DockingUI): void {\n        console.log(\"Docking with stargate\");\n        \n        // Only update ship state if it's not already docked\n        if (!spaceship.isDocked) {\n            // Dock the ship\n            spaceship.dock();\n            this.isDocked = true;\n            \n            // Publish the player.docked event for enemy system and other systems to respond\n            if (spaceship.world && spaceship.world.messageBus) {\n                spaceship.world.messageBus.publish('player.docked', {\n                    playerPosition: spaceship.mesh.position.clone(),\n                    stargate: stargate\n                });\n                console.log(\"Published player.docked event\");\n            }\n        } else {\n            console.log(\"Ship is already docked, just showing UI\");\n        }\n        \n        // Mobile-specific preparation - ensure all classes that might block UI visibility are removed\n        if (this.isMobileDevice()) {\n            console.log(\"Mobile device detected - preparing for stargate UI\");\n            document.body.classList.remove('undocking', 'modal-open');\n            \n            // Reset any problematic styles that might prevent UI from showing\n            document.body.style.position = 'static';\n            document.body.style.touchAction = 'auto';\n            document.body.style.pointerEvents = 'auto';\n            document.body.style.overflow = 'auto';\n        }\n        \n        // Show the stargate UI\n        if (ui && ui.stargateInterface) {\n            console.log(\"Showing stargate UI...\");\n            ui.stargateInterface.showStargateUI?.();\n            \n            // Double-check visibility on mobile with a small delay\n            if (this.isMobileDevice()) {\n                setTimeout(() => {\n                    const stargateUI = document.getElementById('stargate-ui');\n                    if (stargateUI && stargateUI.style.display !== 'block') {\n                        console.log(\"Forcing stargate UI display\");\n                        stargateUI.style.display = 'block';\n                    }\n                }, 100);\n            }\n        }\n        \n        // Hide game UI elements\n        if (ui) {\n            ui.hideUI?.();\n        }\n        \n        // Exit pointer lock so cursor is visible for UI interactions\n        if (document.pointerLockElement) {\n            document.exitPointerLock();\n            console.log(\"Exited pointer lock for UI interaction\");\n        }\n    }\n\n    // Helper to wrap steps in requestAnimationFrame for smoother UI updates\n    async performStep(stepFunction: () => void, stepName: string): Promise<void> {\n        return new Promise(resolve => {\n            requestAnimationFrame(() => {\n                try {\n                    stepFunction();\n                    console.log(`Completed step: ${stepName}`);\n                } catch (err) {\n                    console.error(`Error during step ${stepName}:`, err);\n                }\n                resolve();\n            });\n        });\n    }\n\n    // Helper to yield control to the browser\n    async yieldToBrowser(): Promise<void> {\n        return new Promise(resolve => requestAnimationFrame(() => resolve()));\n    }\n\n    // Optimized method to reset mobile styles\n    resetMobileStyles(): void {\n        // Immediately remove problematic classes for Android\n        if (this.isMobileDevice()) {\n            document.body.classList.remove('undocking', 'modal-open');\n        }\n        \n        // Batch style changes to minimize reflows\n        requestAnimationFrame(() => {\n            // FIX: More aggressive style clearing for Android\n            document.body.style.cssText = '';\n            document.body.style.overflow = 'auto';\n            document.body.style.position = 'static';\n            document.body.style.height = 'auto';\n            document.body.style.width = 'auto';\n            document.body.style.touchAction = 'auto';\n            document.body.style.pointerEvents = 'auto';\n            document.body.style.setProperty('-webkit-overflow-scrolling', 'touch');\n            \n            // FIX: Ensure all restrictive classes are removed to prevent touch event issues\n            document.body.classList.remove('modal-open', 'undocking');\n            \n            // Reset scrollable containers in a single pass\n            document.querySelectorAll('.modal-content, #stargate-ui, #star-map').forEach(container => {\n                const element = container as HTMLElement;\n                if (element && element.style) {\n                    element.style.cssText = 'overflow: auto; -webkit-overflow-scrolling: touch;';\n                    element.scrollTop = 0;\n                }\n            });\n        });\n    }\n\n    // Helper method to request pointer lock\n    requestPointerLock(): void {\n        // Find the canvas element (it should be the first one in the document)\n        const canvas = document.querySelector('canvas');\n        if (canvas && !document.pointerLockElement) {\n            // Request pointer lock with a slight delay to ensure UI transitions are complete\n            setTimeout(() => {\n                canvas.requestPointerLock();\n                console.log(\"Requested pointer lock for ship control\");\n            }, 200);\n        }\n    }\n\n    async undockFromStargate(\n        spaceship: DockingSpaceship,\n        ui: DockingUI,\n        closeAllModalsCallback: () => void,\n        hideStargateUICallback: () => void,\n        showGameUICallback: () => void\n    ): Promise<void> {\n        void ui;\n        if (!spaceship.isDocked) {\n            console.log(\"Not docked, can't undock\");\n            return;\n        }\n\n        // FIX: For Android, immediately remove any classes that might block touch events\n        if (this.isMobileDevice()) {\n            document.body.classList.remove('undocking');\n            this.resetMobileStyles();\n        }\n\n        // Show loading indicator\n        const loadingIndicator = document.createElement('div');\n        loadingIndicator.className = 'undocking-indicator';\n        loadingIndicator.textContent = 'Undocking...';\n        document.body.appendChild(loadingIndicator);\n\n        try {\n            console.log(\"Starting undock sequence...\");\n            \n            // Store shield value before any changes\n            this.preUndockShieldValue = spaceship.shield;\n            console.log(`Storing pre-undock shield value: ${this.preUndockShieldValue}`);\n\n            // Step 1: Close all modals\n            await this.performStep(() => closeAllModalsCallback(), \"Closing modals\");\n            await this.yieldToBrowser();\n\n            // Step 2: Handle mobile-specific cleanup\n            if (this.isMobileDevice()) {\n                await this.performStep(() => this.resetMobileStyles(), \"Resetting mobile styles\");\n                await this.yieldToBrowser();\n            }\n\n            // Step 3: Hide stargate UI and show game UI\n            await this.performStep(() => hideStargateUICallback(), \"Hiding stargate UI\");\n            await this.yieldToBrowser();\n            \n            await this.performStep(() => showGameUICallback(), \"Showing game UI\");\n            await this.yieldToBrowser();\n\n            // Step 4: Perform core undock logic\n            console.log(\"Performing core undock...\");\n            spaceship.undock();\n            \n            // Step 5: Sync health values immediately\n            console.log(\"Syncing health values...\");\n            \n            // Check for shield reset issue\n            if (spaceship.shield === 0 && this.preUndockShieldValue > 0) {\n                console.log(`Fixing shield reset: Restoring to ${this.preUndockShieldValue}`);\n                spaceship.shield = this.preUndockShieldValue;\n            }\n\n            // Sync values immediately without setTimeout\n            spaceship.syncValuesToHealthComponent();\n\n            // Publish undocked event with correct state\n            const healthData = {\n                shield: spaceship.shield,\n                maxShield: spaceship.maxShield,\n                hull: spaceship.hull,\n                maxHull: spaceship.maxHull\n            };\n\n            // Publish to appropriate message bus\n            const windowWithGame = window as GameWindow;\n            const messageBus = windowWithGame.game?.messageBus || windowWithGame.mainMessageBus;\n            if (messageBus) {\n                messageBus.publish('player.undocked', healthData);\n                console.log(\"Published player.undocked event with health values:\", healthData);\n            }\n\n            // Reset docking status\n            this.dockingAvailable = false;\n\n            // Request pointer lock if needed (non-mobile only)\n            if (this.autoPointerLockOnUndock && !this.isMobileDevice()) {\n                await this.performStep(() => this.requestPointerLock(), \"Requesting pointer lock\");\n            }\n\n            console.log(\"Undock sequence complete\");\n            \n        } catch (error) {\n            console.error(\"Error during undocking:\", error);\n        } finally {\n            // Clean up loading indicator\n            if (document.body.contains(loadingIndicator)) {\n                document.body.removeChild(loadingIndicator);\n            }\n            \n            // FIX: More aggressive cleanup for Android devices\n            if (this.isMobileDevice()) {\n                // Clear all restrictive classes\n                document.body.classList.remove('undocking', 'modal-open');\n                \n                // Force resetMobileStyles again to ensure all touch restrictions are removed\n                this.resetMobileStyles();\n                \n                // Ensure specific problematic styles are cleared\n                document.body.style.pointerEvents = '';\n                document.body.style.touchAction = '';\n                document.body.style.overflowY = '';\n                document.body.style.position = '';\n            } else {\n                document.body.classList.remove('undocking');\n            }\n        }\n    }\n}\n","// uiIntegration.js - Handles UI integration for docking system\n\nimport type { DockingSpaceship, DockingUI, ResourceInventory } from './types.ts';\n\ntype GameWindow = Window & {\n    game?: {\n        ui?: {\n            starMap?: {\n                hide?: () => void;\n            };\n            customSystemCreator?: {\n                hide?: () => void;\n            };\n        };\n    };\n};\n\nexport class UIIntegration {\n    resources: ResourceInventory | null;\n\n    constructor() {\n        this.resources = null;\n    }\n\n    setupDockingControls(proximityDetector: { isNearStargate: () => boolean }, dockingLogic: { dockWithStargate: (spaceship: DockingSpaceship, stargate: unknown, ui: DockingUI) => void }, spaceship: DockingSpaceship, ui: DockingUI): void {\n        // Add docking key handler (Q key)\n        document.addEventListener('keydown', (e: KeyboardEvent) => {\n            if (e.key.toLowerCase() === 'q') {\n                if (proximityDetector.isNearStargate() && !spaceship.isDocked) {\n                    console.log(\"Q key pressed: Docking with stargate\");\n                    dockingLogic.dockWithStargate(spaceship, ui.stargate, ui);\n                } else if (spaceship.isDocked) {\n                    console.log(\"Q key pressed while docked: No action (use Undock button)\");\n                } else if (!proximityDetector.isNearStargate()) {\n                    console.log(\"Q key pressed but not near stargate\");\n                }\n            }\n        });\n        \n        // Set up stargate UI button handlers\n        this.setupStargateUIControls(spaceship, ui);\n    }\n\n    setupStargateUIControls(spaceship: DockingSpaceship, ui: DockingUI): void {\n        // Set up refuel button\n        const refuelBtn = document.getElementById('refuel-btn');\n        if (refuelBtn) {\n            refuelBtn.addEventListener('click', () => {\n                if (spaceship.credits >= 100) {\n                    spaceship.credits -= spaceship.refuel();\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n        \n        // Set up shield repair button\n        const repairShieldBtn = document.getElementById('repair-shield-btn');\n        if (repairShieldBtn) {\n            repairShieldBtn.addEventListener('click', () => {\n                if (spaceship.credits >= 150) {\n                    spaceship.credits -= spaceship.repairShield();\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n        \n        // Set up hull repair button\n        const repairHullBtn = document.getElementById('repair-hull-btn');\n        if (repairHullBtn) {\n            repairHullBtn.addEventListener('click', () => {\n                if (spaceship.credits >= 200) {\n                    spaceship.credits -= spaceship.repairHull();\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n        \n        // Set up undock button - this will be handled by the main docking system\n        this.setupUndockButton();\n        \n        // Set up resource selling buttons\n        this.setupSellingButtons(spaceship, ui);\n        \n        // Set up upgrade buttons\n        this.setupUpgradeButtons(spaceship, ui);\n    }\n\n    setupUndockButton(): void {\n        const undockBtn = document.getElementById('undock-btn');\n        if (undockBtn) {\n            // The undock handler will be set up by the main docking system\n            // This is just for mobile-specific touch handling\n            undockBtn.addEventListener('touchstart', (e: TouchEvent) => {\n                console.log(\"Touch started on undock button\");\n                e.stopPropagation();\n            }, { passive: false });\n        }\n    }\n\n    setupSellingButtons(spaceship: DockingSpaceship, ui: DockingUI): void {\n        const sellIronBtn = document.getElementById('sell-iron');\n        if (sellIronBtn) {\n            sellIronBtn.addEventListener('click', () => {\n                if (this.resources && this.resources.iron > 0) {\n                    spaceship.credits += this.resources.iron * 10;\n                    this.resources.iron = 0;\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n        \n        const sellGoldBtn = document.getElementById('sell-gold');\n        if (sellGoldBtn) {\n            sellGoldBtn.addEventListener('click', () => {\n                if (this.resources && this.resources.gold > 0) {\n                    spaceship.credits += this.resources.gold * 50;\n                    this.resources.gold = 0;\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n        \n        const sellPlatinumBtn = document.getElementById('sell-platinum');\n        if (sellPlatinumBtn) {\n            sellPlatinumBtn.addEventListener('click', () => {\n                if (this.resources && this.resources.platinum > 0) {\n                    spaceship.credits += this.resources.platinum * 200;\n                    this.resources.platinum = 0;\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n    }\n\n    setupUpgradeButtons(spaceship: DockingSpaceship, ui: DockingUI): void {\n        // Fuel tank upgrade button handler\n        this.setupUpgradeButton('upgrade-fuel-tank', \n            () => spaceship.fuelUpgradeCost,\n            () => spaceship.upgradeFuelTank(),\n            spaceship, ui);\n        \n        // Engine upgrade button handler\n        this.setupUpgradeButton('upgrade-engine', \n            () => spaceship.engineUpgradeCost,\n            () => spaceship.upgradeEngine(),\n            spaceship, ui);\n        \n        // Mining laser upgrade button handler\n        this.setupUpgradeButton('upgrade-mining', \n            () => spaceship.miningUpgradeCost,\n            () => spaceship.upgradeMiningLaser(),\n            spaceship, ui);\n        \n        // Hull upgrade button handler\n        this.setupUpgradeButton('upgrade-hull', \n            () => spaceship.hullUpgradeCost,\n            () => spaceship.upgradeHull(),\n            spaceship, ui);\n        \n        // Scanner upgrade button handler\n        this.setupUpgradeButton('upgrade-scanner', \n            () => spaceship.scannerUpgradeCost,\n            () => spaceship.upgradeScanner(),\n            spaceship, ui);\n    }\n\n    // Helper method to set up an upgrade button with a given cost getter and upgrade function\n    setupUpgradeButton(\n        buttonId: string,\n        costGetter: () => number,\n        upgradeFunction: () => void,\n        spaceship: DockingSpaceship,\n        ui: DockingUI\n    ): void {\n        const button = document.getElementById(buttonId);\n        if (button) {\n            button.addEventListener('click', () => {\n                const cost = costGetter();\n                if (spaceship.credits >= cost) {\n                    spaceship.credits -= cost;\n                    upgradeFunction();\n                    \n                    // Update the mining system's efficiency if we upgraded the mining laser\n                    if (buttonId === 'upgrade-mining' && this.updateMiningSystem) {\n                        this.updateMiningSystem(spaceship, ui);\n                    }\n                    \n                    // Update UI\n                    this.updateStargateUI(spaceship, ui);\n                }\n            });\n        }\n    }\n\n    // Method to update the mining system when mining efficiency is upgraded\n    updateMiningSystem(spaceship: DockingSpaceship, ui: DockingUI): void {\n        // Find the mining system through the Controls object to pass the new efficiency\n        if (ui && ui.controls && ui.controls.miningSystem) {\n            // Apply the mining efficiency to the mining speed\n            const miningSystem = ui.controls.miningSystem;\n            \n            // Update mining speeds for each resource type based on the new efficiency\n            Object.keys(miningSystem.miningSpeedByType).forEach(resourceType => {\n                const baseSpeed = miningSystem.miningSpeedByType[resourceType];\n                miningSystem.miningSpeedByType[resourceType] = \n                    baseSpeed * spaceship.miningEfficiency;\n            });\n            \n            console.log(\"Mining system updated with new efficiency:\", spaceship.miningEfficiency);\n        }\n    }\n\n    updateStargateUI(spaceship: DockingSpaceship, ui: DockingUI): void {\n        if (ui && ui.stargateInterface) {\n            ui.stargateInterface.updateStargateUI?.(spaceship, this.resources);\n        }\n    }\n\n    // Optimized method to hide UI elements using a single reflow\n    hideStargateUI(ui: DockingUI): void {\n        if (ui && ui.stargateInterface) {\n            // Use CSS class for better performance\n            document.body.classList.add('undocking');\n            ui.stargateInterface.hideStargateUI?.();\n            console.log(\"Hiding stargate interface\");\n        }\n    }\n\n    // Optimized method to show game UI elements using a single reflow\n    showGameUI(ui: DockingUI): void {\n        if (ui) {\n            // Use CSS class for better performance\n            document.body.classList.remove('undocking');\n            ui.showUI?.();\n            console.log(\"Showing game UI\");\n        }\n    }\n\n    // Method to close any open modal UI that might conflict with undocking\n    closeAllModals(): void {\n        try {\n            // Close custom system creator if it's open\n            const customSystemCreator = document.getElementById('custom-system-creator');\n            if (customSystemCreator && window.getComputedStyle(customSystemCreator).display !== 'none') {\n                console.log(\"Closing custom system creator before undocking\");\n                // See if we can find the close button and simulate a click\n                const closeBtn = customSystemCreator.querySelector('#close-system-creator') as HTMLElement | null;\n                if (closeBtn) {\n                    closeBtn.click();\n                } else {\n                    // Otherwise just hide it directly\n                    customSystemCreator.style.display = 'none';\n                }\n                \n                // Force game objects to clean up their modal state\n                const windowWithGame = window as GameWindow;\n                if (windowWithGame.game && windowWithGame.game.ui) {\n                    // Check for star map\n                    if (windowWithGame.game.ui.starMap && typeof windowWithGame.game.ui.starMap.hide === 'function') {\n                        windowWithGame.game.ui.starMap.hide();\n                    }\n                    \n                    // Check for custom system creator\n                    if (windowWithGame.game.ui.customSystemCreator && typeof windowWithGame.game.ui.customSystemCreator.hide === 'function') {\n                        windowWithGame.game.ui.customSystemCreator.hide();\n                    }\n                    \n                    // Cleanup any modal state on the body\n                    document.body.classList.remove('modal-open');\n                }\n            }\n            \n            // Close star map if open\n            const starMap = document.getElementById('star-map');\n            if (starMap && window.getComputedStyle(starMap).display !== 'none') {\n                console.log(\"Closing star map before undocking\");\n                const closeStarMapBtn = starMap.querySelector('#close-star-map') as HTMLElement | null;\n                if (closeStarMapBtn) {\n                    closeStarMapBtn.click();\n                } else {\n                    starMap.style.display = 'none';\n                }\n            }\n            \n            // Close any other modals\n            const allModals = document.querySelectorAll('.modal-container');\n            allModals.forEach(modal => {\n                const modalElement = modal as HTMLElement;\n                if (window.getComputedStyle(modalElement).display !== 'none') {\n                    console.log(\"Closing modal before undocking:\", modalElement.id || 'unnamed modal');\n                    modalElement.style.display = 'none';\n                }\n            });\n        } catch (err) {\n            console.warn(\"Error while closing modals:\", err);\n        }\n    }\n\n    // Setter for resources to allow dependency injection\n    setResources(resources: ResourceInventory): void {\n        this.resources = resources;\n    }\n}\n","// dockingSystem.js - Handles stargate docking and trading\n\nimport { ProximityDetector } from './docking/proximityDetector.ts';\nimport { DockingLogic } from './docking/dockingLogic.ts';\nimport { UIIntegration } from './docking/uiIntegration.ts';\nimport type { DockingSpaceship, DockingUI, ResourceInventory, ProximityStargate } from './docking/types.ts';\n\nexport class DockingSystem {\n    spaceship: DockingSpaceship;\n    stargate: ProximityStargate;\n    ui: DockingUI;\n    proximityDetector: ProximityDetector;\n    dockingLogic: DockingLogic;\n    uiIntegration: UIIntegration;\n    isDocked: boolean;\n    nearStargate?: boolean;\n    resources?: ResourceInventory;\n\n    constructor(spaceship: DockingSpaceship, stargate: ProximityStargate, ui: DockingUI) {\n        this.spaceship = spaceship;\n        this.stargate = stargate;\n        this.ui = ui;\n        \n        // Initialize component modules\n        this.proximityDetector = new ProximityDetector();\n        this.dockingLogic = new DockingLogic();\n        this.uiIntegration = new UIIntegration();\n        \n        this.isDocked = this.spaceship.isDocked; // Initialize with spaceship's docked state\n        \n        // Preemptively set a safe undocking position\n        if (this.spaceship && this.spaceship.undockLocation && this.stargate) {\n            // Position in the middle of the stargate\n            this.spaceship.undockLocation.set(0, 10000, 0);\n        }\n        \n        console.log(\"Initializing docking system, ship is \" + (this.isDocked ? \"docked\" : \"undocked\"));\n        this.setupDockingControls();\n        \n        // If we're starting docked, publish the player.docked event immediately\n        if (this.isDocked && this.spaceship.world && this.spaceship.world.messageBus) {\n            this.spaceship.world.messageBus.publish('player.docked', {\n                playerPosition: this.spaceship.mesh ? this.spaceship.mesh.position.clone() : null,\n                stargate: this.stargate\n            });\n            console.log(\"Published initial player.docked event\");\n        }\n    }\n    \n    setupDockingControls(): void {\n        // Delegate to UI integration module\n        this.uiIntegration.setupDockingControls(\n            this.proximityDetector, \n            this.dockingLogic, \n            this.spaceship, \n            this.ui\n        );\n        \n        // Set up undock button handler specifically\n        this.setupUndockButton();\n    }\n    \n    setupStargateUIControls(): void {\n        // Delegate to UI integration module\n        this.uiIntegration.setupStargateUIControls(this.spaceship, this.ui);\n    }\n    \n    setupUndockButton(): void {\n        const undockBtn = document.getElementById('undock-btn');\n        if (undockBtn) {\n            // Use both click and touchend events for better Android compatibility\n            const handleUndock = (e: Event) => {\n                // Prevent any default action that might interfere\n                e.preventDefault();\n                e.stopPropagation();\n                \n                // Log which event triggered the undock\n                console.log(`Undock button ${e.type} event triggered`);\n\n                // Add a small delay to ensure the event completes on Android\n                if (this.dockingLogic.isMobileDevice()) {\n                    // For Android, remove the overlay classes immediately\n                    document.body.classList.remove('undocking', 'modal-open');\n                    // Set a brief timeout to allow touch event to complete\n                    setTimeout(() => {\n                        this.undockFromStargate();\n                    }, 50);\n                } else {\n                    this.undockFromStargate();\n                }\n            };\n            \n            // Add both event listeners for better compatibility\n            undockBtn.addEventListener('click', handleUndock);\n            undockBtn.addEventListener('touchend', handleUndock);\n        }\n    }\n    \n    dockWithStargate(): void {\n        this.dockingLogic.dockWithStargate(this.spaceship, this.stargate, this.ui);\n        this.isDocked = true;\n        \n        // Update the stargate UI with current values\n        this.updateStargateUI();\n    }\n    \n    async undockFromStargate(): Promise<void> {\n        await this.dockingLogic.undockFromStargate(\n            this.spaceship, \n            this.ui,\n            () => this.uiIntegration.closeAllModals(),\n            () => this.uiIntegration.hideStargateUI(this.ui),\n            () => this.uiIntegration.showGameUI(this.ui)\n        );\n        this.isDocked = false;\n    }\n    \n    updateStargateUI(): void {\n        this.uiIntegration.updateStargateUI(this.spaceship, this.ui);\n    }\n    \n    checkStargateProximity(): void {\n        this.proximityDetector.checkStargateProximity(this.spaceship, this.stargate, this.ui);\n        this.nearStargate = this.proximityDetector.isNearStargate();\n    }\n    \n    update(): void {\n        // Check if near stargate for docking\n        this.checkStargateProximity();\n    }\n    \n    // Setter for resources to allow dependency injection\n    setResources(resources: ResourceInventory): void {\n        this.resources = resources;\n        this.uiIntegration.setResources(resources);\n    }\n}\n","// joystickZones.js - Joystick UI zone creation and management\n\nexport class JoystickZones {\n    leftJoystickZone: HTMLDivElement | null;\n    rightJoystickZone: HTMLDivElement | null;\n\n    constructor() {\n        this.leftJoystickZone = null;\n        this.rightJoystickZone = null;\n    }\n\n    createJoystickZones(): { leftZone: HTMLDivElement | null; rightZone: HTMLDivElement | null } {\n        this.createLeftJoystickZone();\n        this.createRightJoystickZone();\n        return {\n            leftZone: this.leftJoystickZone,\n            rightZone: this.rightJoystickZone\n        };\n    }\n\n    createLeftJoystickZone(): HTMLDivElement {\n        // Create left joystick zone (thrust control)\n        const leftJoystickZone = document.createElement('div');\n        leftJoystickZone.id = 'leftJoystickZone';\n        leftJoystickZone.style.position = 'absolute';\n        leftJoystickZone.style.bottom = '50px';\n        leftJoystickZone.style.left = '50px';\n        leftJoystickZone.style.width = '100px';\n        leftJoystickZone.style.height = '100px';\n        leftJoystickZone.style.zIndex = '1000';\n        \n        // Prevent default browser behavior to avoid scrolling when using joysticks\n        leftJoystickZone.addEventListener('touchstart', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        leftJoystickZone.addEventListener('touchmove', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        leftJoystickZone.addEventListener('touchend', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        \n        document.body.appendChild(leftJoystickZone);\n        this.leftJoystickZone = leftJoystickZone;\n        \n        return leftJoystickZone;\n    }\n\n    createRightJoystickZone(): HTMLDivElement {\n        // Create right joystick zone (rotation control)\n        const rightJoystickZone = document.createElement('div');\n        rightJoystickZone.id = 'rightJoystickZone';\n        rightJoystickZone.style.position = 'absolute';\n        rightJoystickZone.style.bottom = '50px';\n        rightJoystickZone.style.right = '50px';\n        rightJoystickZone.style.width = '100px';\n        rightJoystickZone.style.height = '100px';\n        rightJoystickZone.style.zIndex = '1000';\n        \n        // Prevent default browser behavior to avoid scrolling when using joysticks\n        rightJoystickZone.addEventListener('touchstart', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        rightJoystickZone.addEventListener('touchmove', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        rightJoystickZone.addEventListener('touchend', (e: TouchEvent) => e.preventDefault(), { passive: false });\n        \n        document.body.appendChild(rightJoystickZone);\n        this.rightJoystickZone = rightJoystickZone;\n        \n        return rightJoystickZone;\n    }\n\n    hideZones(): void {\n        if (this.leftJoystickZone) this.leftJoystickZone.style.display = 'none';\n        if (this.rightJoystickZone) this.rightJoystickZone.style.display = 'none';\n    }\n\n    showZones(): void {\n        if (this.leftJoystickZone) this.leftJoystickZone.style.display = 'block';\n        if (this.rightJoystickZone) this.rightJoystickZone.style.display = 'block';\n    }\n\n    getLeftZone(): HTMLDivElement | null {\n        return this.leftJoystickZone;\n    }\n\n    getRightZone(): HTMLDivElement | null {\n        return this.rightJoystickZone;\n    }\n}\n","// actionButtons.js - Action button creation and styling\n\nexport class ActionButtons {\n    buttons: {\n        fire: HTMLDivElement | null;\n        mine: HTMLDivElement | null;\n        target: HTMLDivElement | null;\n        dock: HTMLDivElement | null;\n        deployLaser: HTMLDivElement | null;\n    };\n    containers: {\n        left: HTMLDivElement | null;\n        right: HTMLDivElement | null;\n    };\n\n    constructor() {\n        this.buttons = {\n            fire: null,\n            mine: null,\n            target: null,\n            dock: null,\n            deployLaser: null\n        };\n        this.containers = {\n            left: null,\n            right: null\n        };\n    }\n\n    createActionButtons(): {\n        fire: HTMLDivElement | null;\n        mine: HTMLDivElement | null;\n        target: HTMLDivElement | null;\n        dock: HTMLDivElement | null;\n        deployLaser: HTMLDivElement | null;\n    } {\n        this.createButtonContainers();\n        this.createFireButton();\n        this.createMineButton();\n        this.createTargetButton();\n        this.createDockButton();\n        this.createDeployLaserButton();\n        \n        return this.buttons;\n    }\n\n    createButtonContainers(): void {\n        // Create a container for left side action buttons\n        const leftActionButtonsContainer = document.createElement('div');\n        leftActionButtonsContainer.id = 'mobile-action-buttons-left';\n        leftActionButtonsContainer.style.position = 'absolute';\n        leftActionButtonsContainer.style.bottom = '170px';\n        leftActionButtonsContainer.style.left = '20px';\n        leftActionButtonsContainer.style.display = 'flex';\n        leftActionButtonsContainer.style.flexDirection = 'column';\n        leftActionButtonsContainer.style.gap = '15px';\n        leftActionButtonsContainer.style.zIndex = '1000';\n        document.body.appendChild(leftActionButtonsContainer);\n        this.containers.left = leftActionButtonsContainer;\n        \n        // Create a container for right side action buttons\n        const rightActionButtonsContainer = document.createElement('div');\n        rightActionButtonsContainer.id = 'mobile-action-buttons-right';\n        rightActionButtonsContainer.style.position = 'absolute';\n        rightActionButtonsContainer.style.bottom = '170px';\n        rightActionButtonsContainer.style.right = '20px';\n        rightActionButtonsContainer.style.display = 'flex';\n        rightActionButtonsContainer.style.flexDirection = 'column';\n        rightActionButtonsContainer.style.gap = '15px';\n        rightActionButtonsContainer.style.zIndex = '1000';\n        document.body.appendChild(rightActionButtonsContainer);\n        this.containers.right = rightActionButtonsContainer;\n    }\n\n    createFireButton(): HTMLDivElement | null {\n        this.buttons.fire = this.createActionButton(this.containers.left, 'FIRE', 'rgba(255, 80, 80, 0.8)');\n        return this.buttons.fire;\n    }\n\n    createMineButton(): HTMLDivElement | null {\n        this.buttons.mine = this.createActionButton(this.containers.left, 'MINE', 'rgba(120, 220, 232, 0.8)');\n        return this.buttons.mine;\n    }\n\n    createTargetButton(): HTMLDivElement | null {\n        this.buttons.target = this.createActionButton(this.containers.right, 'TARGET', 'rgba(255, 215, 0, 0.8)');\n        return this.buttons.target;\n    }\n\n    createDockButton(): HTMLDivElement | null {\n        // Create dock button (only shown when near stargate)\n        this.buttons.dock = this.createActionButton(null, 'DOCK', 'rgba(51, 153, 255, 0.8)');\n        this.buttons.dock.style.position = 'absolute';\n        this.buttons.dock.style.top = '50%';\n        this.buttons.dock.style.left = '50%';\n        this.buttons.dock.style.transform = 'translate(-50%, -50%)';\n        this.buttons.dock.style.width = '100px';  // Make dock button larger\n        this.buttons.dock.style.height = '100px'; // Make dock button larger\n        this.buttons.dock.style.fontSize = '20px'; // Larger text\n        this.buttons.dock.style.boxShadow = '0 0 25px rgba(51, 153, 255, 0.8)'; // Stronger glow\n        this.buttons.dock.style.zIndex = '10000'; \n        this.buttons.dock.style.display = 'none';\n        document.body.appendChild(this.buttons.dock);\n        return this.buttons.dock;\n    }\n\n    createDeployLaserButton(): HTMLDivElement | null {\n        this.buttons.deployLaser = this.createActionButton(this.containers.right, 'DEPLOY', 'rgba(255, 100, 100, 0.8)');\n        return this.buttons.deployLaser;\n    }\n\n    createActionButton(parent: HTMLDivElement | null, text: string, color: string): HTMLDivElement {\n        const button = document.createElement('div');\n        button.className = 'mobile-action-button';\n        button.textContent = text;\n        button.style.width = '60px';\n        button.style.height = '60px'; \n        button.style.borderRadius = '50%';\n        button.style.backgroundColor = 'rgba(10, 20, 30, 0.7)';\n        button.style.border = `2px solid ${color}`;\n        button.style.color = color;\n        button.style.display = 'flex';\n        button.style.justifyContent = 'center';\n        button.style.alignItems = 'center';\n        button.style.fontFamily = '\"Rajdhani\", sans-serif';\n        button.style.fontSize = '16px';\n        button.style.fontWeight = 'bold';\n        button.style.boxShadow = `0 0 10px ${color}`;\n        button.style.userSelect = 'none';\n        button.style.touchAction = 'manipulation';\n        button.style.cursor = 'pointer';\n        \n        // Add hardware acceleration for better performance on mobile\n        button.style.transform = 'translateZ(0)';\n        button.style.setProperty('-webkit-tap-highlight-color', 'transparent');\n        button.style.backfaceVisibility = 'hidden';\n        \n        if (parent) {\n            parent.appendChild(button);\n        }\n        \n        return button;\n    }\n\n    showDockButton(): void {\n        if (this.buttons.dock) {\n            // FIX: Make sure display is set before other properties\n            this.buttons.dock.style.display = 'flex';\n            \n            // FIX: Ensure critical styles are explicitly set\n            this.buttons.dock.style.zIndex = '10000'; // Very high z-index\n            this.buttons.dock.style.position = 'absolute';\n            this.buttons.dock.style.top = '50%';\n            this.buttons.dock.style.left = '50%';\n            \n            console.log(\"Showing dock button - near stargate\");\n            \n            // Add pulsing animation to make it more noticeable\n            if (!this.buttons.dock.style.animation) {\n                this.buttons.dock.style.animation = 'pulse 1.5s infinite';\n                \n                // Add the pulse keyframes if they don't exist\n                if (!document.getElementById('mobile-pulse-animation')) {\n                    const style = document.createElement('style');\n                    style.id = 'mobile-pulse-animation';\n                    style.textContent = `\n                        @keyframes pulse {\n                            0% { transform: translate(-50%, -50%) scale(1); }\n                            50% { transform: translate(-50%, -50%) scale(1.1); }\n                            100% { transform: translate(-50%, -50%) scale(1); }\n                        }\n                    `;\n                    document.head.appendChild(style);\n                }\n            }\n            \n            // FIX: Log dock button visibility for debugging\n            console.log(\"Dock button shown with styles:\", {\n                display: this.buttons.dock.style.display,\n                zIndex: this.buttons.dock.style.zIndex,\n                position: this.buttons.dock.style.position,\n                width: this.buttons.dock.style.width,\n                height: this.buttons.dock.style.height\n            });\n        }\n    }\n\n    hideDockButton(): void {\n        if (this.buttons.dock) {\n            this.buttons.dock.style.display = 'none';\n        }\n    }\n\n    hideButtons(): void {\n        if (this.containers.left) this.containers.left.style.display = 'none';\n        if (this.containers.right) this.containers.right.style.display = 'none';\n        this.hideDockButton();\n    }\n\n    showButtons(): void {\n        if (this.containers.left) this.containers.left.style.display = 'flex';\n        if (this.containers.right) this.containers.right.style.display = 'flex';\n    }\n\n    // Helper method to add events to buttons\n    addButtonEvents(button: HTMLElement | null, startHandler: () => void, endHandler: (() => void) | null = null): void {\n        if (!button) {\n            console.error(\"ActionButtons: Cannot add events to null button\");\n            return;\n        }\n        \n        // For continuous actions (like firing and mining)\n        if (endHandler) {\n            // Touch events with passive: false to allow preventDefault\n            button.addEventListener('touchstart', (e: TouchEvent) => {\n                e.preventDefault();\n                button.style.transform = 'scale(0.95) translateZ(0)';\n                startHandler();\n            }, { passive: false });\n            \n            button.addEventListener('touchend', (e: TouchEvent) => {\n                e.preventDefault();\n                button.style.transform = 'scale(1) translateZ(0)';\n                endHandler();\n            }, { passive: false });\n            \n            // Add pointer events\n            button.addEventListener('pointerdown', (e: PointerEvent) => {\n                e.preventDefault();\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\n                button.style.transform = 'scale(0.95) translateZ(0)';\n                startHandler();\n            });\n            \n            button.addEventListener('pointerup', (e: PointerEvent) => {\n                e.preventDefault();\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\n                button.style.transform = 'scale(1) translateZ(0)';\n                endHandler();\n            });\n            \n            // Keep mouse events for backward compatibility\n            button.addEventListener('mousedown', () => {\n                button.style.transform = 'scale(0.95) translateZ(0)';\n                startHandler();\n            });\n            \n            button.addEventListener('mouseup', () => {\n                button.style.transform = 'scale(1) translateZ(0)';\n                endHandler();\n            });\n        }\n        // For single actions (like targeting and docking)\n        else {\n            // Touch events\n            button.addEventListener('touchstart', (e: TouchEvent) => {\n                e.preventDefault();\n                button.style.transform = 'scale(0.95) translateZ(0)';\n                \n                // For dock button specifically, add debug logging\n                if (button === this.buttons.dock) {\n                    console.log(\"Dock button touchstart event fired\");\n                }\n            }, { passive: false });\n            \n            button.addEventListener('touchend', (e: TouchEvent) => {\n                e.preventDefault();\n                button.style.transform = 'scale(1) translateZ(0)';\n                \n                // For dock button specifically, add debug logging\n                if (button === this.buttons.dock) {\n                    console.log(\"Dock button touchend event fired, calling handler\");\n                }\n                \n                startHandler();\n            }, { passive: false });\n            \n            // Add pointer events\n            button.addEventListener('pointerdown', (e: PointerEvent) => {\n                e.preventDefault();\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\n                button.style.transform = 'scale(0.95) translateZ(0)';\n                \n                // For dock button specifically, add debug logging\n                if (button === this.buttons.dock) {\n                    console.log(\"Dock button pointerdown event fired\");\n                }\n            });\n            \n            button.addEventListener('pointerup', (e: PointerEvent) => {\n                e.preventDefault();\n                if (e.pointerType === 'touch') return; // Skip if touch (handled by touch events)\n                button.style.transform = 'scale(1) translateZ(0)';\n                \n                // For dock button specifically, add debug logging\n                if (button === this.buttons.dock) {\n                    console.log(\"Dock button pointerup event fired, calling handler\");\n                }\n                \n                startHandler();\n            });\n            \n            // Keep mouse events for backward compatibility\n            button.addEventListener('mousedown', () => {\n                button.style.transform = 'scale(0.95) translateZ(0)';\n            });\n            \n            button.addEventListener('mouseup', () => {\n                button.style.transform = 'scale(1) translateZ(0)';\n                startHandler();\n            });\n        }\n    }\n}\n","// joystickHandler.js - Nipple.js integration and joystick input handling\n\ntype TouchSpaceship = {\n    isDocked: boolean;\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        left: boolean;\n        right: boolean;\n        boost: boolean;\n    };\n};\n\ntype TouchPhysics = {\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype NippleOptions = {\n    zone: HTMLElement | null;\n    mode: string;\n    position: { left: string; top: string };\n    color: string;\n    size: number;\n    threshold: number;\n    dynamicPage: boolean;\n    fadeTime: number;\n    lockX: boolean;\n    lockY: boolean;\n};\n\ntype NippleData = {\n    force: number;\n    angle: { radian: number };\n    vector: { x: number; y: number };\n};\n\ntype NippleManager = {\n    on: (event: string, handler: (evt: unknown, data: NippleData) => void) => NippleManager;\n    destroy: () => void;\n};\n\ntype NippleWindow = Window & {\n    nipplejs?: {\n        create: (options: NippleOptions) => NippleManager;\n    };\n};\n\nexport class JoystickHandler {\n    spaceship: TouchSpaceship;\n    physics: TouchPhysics;\n    leftJoystick: NippleManager | null;\n    rightJoystick: NippleManager | null;\n    threshold: number;\n    isNippleLoaded: boolean;\n\n    constructor(spaceship: TouchSpaceship, physics: TouchPhysics) {\n        this.spaceship = spaceship;\n        this.physics = physics;\n        this.leftJoystick = null;\n        this.rightJoystick = null;\n        this.threshold = 0.1;\n        this.isNippleLoaded = false;\n    }\n\n    async loadNippleJS(): Promise<void> {\n        return new Promise((resolve, reject) => {\n            // Check if nipple.js is already loaded\n            const windowWithNipple = window as NippleWindow;\n            if (windowWithNipple.nipplejs) {\n                this.isNippleLoaded = true;\n                resolve();\n                return;\n            }\n            \n            // Create script element\n            const script = document.createElement('script');\n            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js';\n            script.async = true;\n            \n            // Set up event handlers\n            script.onload = () => {\n                this.isNippleLoaded = true;\n                resolve();\n            };\n            script.onerror = () => reject(new Error('Failed to load nipple.js'));\n            \n            // Add script to document\n            document.head.appendChild(script);\n        });\n    }\n\n    initializeJoysticks(leftZone: HTMLElement | null, rightZone: HTMLElement | null): boolean {\n        const windowWithNipple = window as NippleWindow;\n        if (!windowWithNipple.nipplejs || !this.isNippleLoaded) {\n            console.error('nipplejs is not loaded');\n            return false;\n        }\n        \n        // Initialize left joystick (thrust control)\n        this.leftJoystick = windowWithNipple.nipplejs.create({\n            zone: leftZone,\n            mode: 'static',\n            position: { left: '50%', top: '50%' },\n            color: 'rgba(120, 220, 232, 0.8)',\n            size: 100,\n            threshold: this.threshold,\n            dynamicPage: true, // Better performance for scrolling\n            fadeTime: 100, // Faster fade for better performance\n            lockX: false, // Allow X-axis movement\n            lockY: false  // Allow Y-axis movement\n        });\n        \n        // Initialize right joystick (rotation control)\n        this.rightJoystick = windowWithNipple.nipplejs.create({\n            zone: rightZone,\n            mode: 'static',\n            position: { left: '50%', top: '50%' },\n            color: 'rgba(120, 220, 232, 0.8)',\n            size: 100,\n            threshold: this.threshold,\n            dynamicPage: true, // Better performance for scrolling\n            fadeTime: 100, // Faster fade for better performance\n            lockX: false, // Allow X-axis movement\n            lockY: false  // Allow Y-axis movement\n        });\n        \n        // Set up event handlers for joysticks\n        this.setupJoystickEvents();\n        return true;\n    }\n\n    setupJoystickEvents(): void {\n        if (!this.leftJoystick || !this.rightJoystick) {\n            console.error('Joysticks not initialized');\n            return;\n        }\n\n        // Left joystick events (thrust)\n        this.leftJoystick.on('move', (evt, data) => {\n            void evt;\n            this.handleThrustJoystick(data);\n        }).on('end', () => {\n            this.resetThrust();\n        });\n        \n        // Right joystick events (rotation)\n        this.rightJoystick.on('move', (evt, data) => {\n            void evt;\n            this.handleRotationJoystick(data);\n        }).on('end', () => {\n            // Do nothing on end - rotation is not continuous\n        });\n    }\n\n    handleThrustJoystick(data: NippleData): void {\n        if (this.spaceship.isDocked) return;\n        \n        // Reset thrust directions\n        this.resetThrust();\n        \n        const force = data.force > 2 ? 2 : data.force; // Normalize force between 0-2\n        const angle = data.angle.radian;\n        \n        // Correct direction mapping based on standard joystick angles:\n        // In nipple.js, 0 radians = right, /2 = up,  = left, 3/2 = down\n        \n        // Up/North - Forward (around /2 or 1.57 radians)\n        if (angle > 1.0 && angle < 2.0) {\n            this.spaceship.thrust.forward = true;\n        }\n        // Down/South - Backward (around 3/2 or 4.71 radians)\n        else if (angle > 4.0 && angle < 5.5) {\n            this.spaceship.thrust.backward = true;\n        }\n        \n        // Left/West - Left (around  or 3.14 radians)\n        if (angle > 2.5 && angle < 4.0) {\n            this.spaceship.thrust.left = true;  // Fixed: left joystick should trigger left thrust\n        }\n        // Right/East - Right (around 0 or 2 radians)\n        else if ((angle >= 0 && angle < 1.0) || angle > 5.5) {\n            this.spaceship.thrust.right = true;  // Fixed: right joystick should trigger right thrust\n        }\n        \n        // Enable boost if force is high\n        this.spaceship.thrust.boost = force > 1.5;\n    }\n\n    handleRotationJoystick(data: NippleData): void {\n        if (this.spaceship.isDocked) return;\n        \n        // Extract the X and Y components of the joystick vector\n        // Reduce sensitivity by lowering the multiplier from 0.05 to 0.015\n        const xMove = data.vector.x * data.force * 0.015;\n        // Invert the Y value to fix up/down control direction\n        const yMove = -data.vector.y * data.force * 0.015;\n        \n        // Update rotation via physics\n        this.physics.updateRotation(xMove, yMove);\n    }\n\n    resetThrust(): void {\n        if (!this.spaceship) return;\n        \n        this.spaceship.thrust.forward = false;\n        this.spaceship.thrust.backward = false;\n        this.spaceship.thrust.left = false;\n        this.spaceship.thrust.right = false;\n        this.spaceship.thrust.boost = false;\n    }\n\n    destroy(): void {\n        if (this.leftJoystick) {\n            this.leftJoystick.destroy();\n            this.leftJoystick = null;\n        }\n        if (this.rightJoystick) {\n            this.rightJoystick.destroy();\n            this.rightJoystick = null;\n        }\n    }\n}\n","// gestureDetector.js - Touch gesture recognition for mobile controls\n\ntype GesturePosition = {\n    x: number;\n    y: number;\n};\n\ntype GestureCallback = (data: unknown) => void;\n\nexport class GestureDetector {\n    isEnabled: boolean;\n    gestureCallbacks: Map<string, GestureCallback>;\n    touchStartTime: number;\n    touchStartPos: GesturePosition;\n    touchEndPos: GesturePosition;\n    swipeThreshold: number;\n    tapTimeout: number;\n\n    constructor() {\n        this.isEnabled = false;\n        this.gestureCallbacks = new Map();\n        this.touchStartTime = 0;\n        this.touchStartPos = { x: 0, y: 0 };\n        this.touchEndPos = { x: 0, y: 0 };\n        this.swipeThreshold = 50; // minimum distance for swipe\n        this.tapTimeout = 300; // maximum time for tap\n    }\n\n    enable(): void {\n        if (this.isEnabled) return;\n        \n        this.isEnabled = true;\n        \n        // Add global touch event listeners for gesture detection\n        document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });\n        document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });\n        document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });\n    }\n\n    disable(): void {\n        if (!this.isEnabled) return;\n        \n        this.isEnabled = false;\n        \n        // Remove global touch event listeners\n        document.removeEventListener('touchstart', this.handleTouchStart.bind(this));\n        document.removeEventListener('touchmove', this.handleTouchMove.bind(this));\n        document.removeEventListener('touchend', this.handleTouchEnd.bind(this));\n    }\n\n    handleTouchStart(event: TouchEvent): void {\n        if (!this.isEnabled) return;\n        \n        // Ignore if touch is on a UI element (joystick or button)\n        if (this.isTouchOnUIElement(event.target)) return;\n        \n        const touch = event.touches[0];\n        this.touchStartTime = Date.now();\n        this.touchStartPos = {\n            x: touch.clientX,\n            y: touch.clientY\n        };\n    }\n\n    handleTouchMove(event: TouchEvent): void {\n        if (!this.isEnabled) return;\n        \n        // Ignore if touch is on a UI element\n        if (this.isTouchOnUIElement(event.target)) return;\n        \n        // Prevent default to avoid scrolling during gesture detection\n        event.preventDefault();\n    }\n\n    handleTouchEnd(event: TouchEvent): void {\n        if (!this.isEnabled) return;\n        \n        // Ignore if touch is on a UI element\n        if (this.isTouchOnUIElement(event.target)) return;\n        \n        const touch = event.changedTouches[0];\n        this.touchEndPos = {\n            x: touch.clientX,\n            y: touch.clientY\n        };\n        \n        const touchDuration = Date.now() - this.touchStartTime;\n        const distance = this.calculateDistance(this.touchStartPos, this.touchEndPos);\n        \n        // Detect gesture type\n        if (touchDuration <= this.tapTimeout && distance < this.swipeThreshold) {\n            this.triggerGesture('tap', {\n                position: this.touchEndPos,\n                duration: touchDuration\n            });\n        } else if (distance >= this.swipeThreshold) {\n            const direction = this.getSwipeDirection(this.touchStartPos, this.touchEndPos);\n            this.triggerGesture('swipe', {\n                direction: direction,\n                distance: distance,\n                duration: touchDuration,\n                startPos: this.touchStartPos,\n                endPos: this.touchEndPos\n            });\n        }\n    }\n\n    isTouchOnUIElement(target: EventTarget | null): boolean {\n        // Check if touch is on joystick zones or action buttons\n        const uiSelectors = [\n            '#leftJoystickZone',\n            '#rightJoystickZone',\n            '#mobile-action-buttons-left',\n            '#mobile-action-buttons-right',\n            '.mobile-action-button'\n        ];\n        \n        for (const selector of uiSelectors) {\n            if (target && 'closest' in target && typeof (target as Element).closest === 'function' && (target as Element).closest(selector)) {\n                return true;\n            }\n        }\n        \n        return false;\n    }\n\n    calculateDistance(pos1: GesturePosition, pos2: GesturePosition): number {\n        const dx = pos2.x - pos1.x;\n        const dy = pos2.y - pos1.y;\n        return Math.sqrt(dx * dx + dy * dy);\n    }\n\n    getSwipeDirection(startPos: GesturePosition, endPos: GesturePosition): string {\n        const dx = endPos.x - startPos.x;\n        const dy = endPos.y - startPos.y;\n        \n        if (Math.abs(dx) > Math.abs(dy)) {\n            return dx > 0 ? 'right' : 'left';\n        } else {\n            return dy > 0 ? 'down' : 'up';\n        }\n    }\n\n    triggerGesture(gestureType: string, data: unknown): void {\n        const callback = this.gestureCallbacks.get(gestureType);\n        if (callback && typeof callback === 'function') {\n            callback(data);\n        }\n    }\n\n    // Register callbacks for specific gestures\n    onGesture(gestureType: string, callback: GestureCallback): void {\n        this.gestureCallbacks.set(gestureType, callback);\n    }\n\n    // Remove gesture callback\n    offGesture(gestureType: string): void {\n        this.gestureCallbacks.delete(gestureType);\n    }\n\n    // Clear all gesture callbacks\n    clearGestures(): void {\n        this.gestureCallbacks.clear();\n    }\n}\n","// miningHandler.js - Mining action handlers for touch controls\n\ntype MiningAsteroid = {\n    resourceType?: string;\n    mesh?: {\n        position?: {\n            toArray?: () => number[];\n            distanceTo?: (pos: unknown) => number;\n        };\n    };\n};\n\ntype MiningSystem = {\n    isMining?: boolean;\n    setTargetAsteroid: (asteroid: MiningAsteroid) => void;\n    startMining: () => void;\n    stopMining: () => void;\n};\n\ntype TargetingSystem = {\n    getCurrentTarget: () => MiningAsteroid | null;\n    isLockOnEnabled: () => boolean;\n    toggleLockOn: () => void;\n    findNearestTarget: () => MiningAsteroid | null;\n};\n\ntype MiningSpaceship = {\n    mesh?: {\n        position?: {\n            distanceTo?: (pos: unknown) => number;\n        };\n    };\n};\n\ntype GameWindow = Window & {\n    game?: {\n        environment?: {\n            asteroids?: MiningAsteroid[];\n        };\n    };\n    gameInstance?: {\n        environment?: {\n            asteroids?: MiningAsteroid[];\n        };\n    };\n};\n\nexport class MiningHandler {\n    spaceship: MiningSpaceship | null;\n    miningSystem: MiningSystem | null;\n    targetingSystem: TargetingSystem | null;\n\n    constructor(spaceship: MiningSpaceship | null) {\n        this.spaceship = spaceship;\n        this.miningSystem = null;\n        this.targetingSystem = null;\n    }\n\n    setMiningSystem(miningSystem: MiningSystem | null): void {\n        this.miningSystem = miningSystem;\n    }\n\n    setTargetingSystem(targetingSystem: TargetingSystem | null): void {\n        this.targetingSystem = targetingSystem;\n    }\n\n    handleMiningStart(): void {\n        try {\n            console.log(\"MiningHandler: handleMiningStart called\");\n            \n            // First ensure we have targeting and mining systems\n            if (!this.targetingSystem) {\n                console.error(\"MiningHandler: Targeting system not available\");\n                return;\n            }\n            \n            if (!this.miningSystem) {\n                console.error(\"MiningHandler: Mining system not available\");\n                return;\n            }\n            \n            // First, get the current target\n            let targetAsteroid = this.targetingSystem.getCurrentTarget();\n            console.log(\"MiningHandler: Initial target:\", targetAsteroid);\n            \n            // If no target is selected, enable targeting and find nearest\n            if (!targetAsteroid) {\n                console.log(\"MiningHandler: No target selected, enabling targeting and finding nearest target\");\n                \n                // Enable targeting if not already enabled\n                if (!this.targetingSystem.isLockOnEnabled()) {\n                    this.targetingSystem.toggleLockOn();\n                }\n                \n                // Find nearest target\n                targetAsteroid = this.targetingSystem.findNearestTarget();\n                console.log(\"MiningHandler: Found nearest target:\", targetAsteroid);\n                \n                if (!targetAsteroid) {\n                    console.log(\"MiningHandler: No targets in range after scan\");\n                    return;\n                }\n            }\n            \n            // Essential validation: make sure we have a valid target asteroid with required properties\n            if (!targetAsteroid || !targetAsteroid.mesh || !targetAsteroid.mesh.position) {\n                console.error(\"MiningHandler: Target asteroid is missing required properties\", targetAsteroid);\n                \n                // Try a different approach - get all asteroids from environment\n                const windowWithGame = window as GameWindow;\n                const game = windowWithGame.gameInstance || windowWithGame.game;\n                if (game && game.environment && game.environment.asteroids && game.environment.asteroids.length > 0) {\n                    console.log(\"MiningHandler: Attempting to get asteroid directly from environment\");\n                    // Find closest asteroid\n                    let closestDist = Infinity;\n                    let closestAsteroid = null;\n                    \n                    for (const asteroid of game.environment.asteroids) {\n                        if (asteroid && asteroid.mesh && asteroid.mesh.position && this.spaceship && this.spaceship.mesh) {\n                            const dist = asteroid.mesh.position.distanceTo(this.spaceship.mesh.position);\n                            if (dist < closestDist) {\n                                closestDist = dist;\n                                closestAsteroid = asteroid;\n                            }\n                        }\n                    }\n                    \n                    if (closestAsteroid) {\n                        console.log(\"MiningHandler: Found closest asteroid from environment:\", closestAsteroid);\n                        targetAsteroid = closestAsteroid;\n                    } else {\n                        console.error(\"MiningHandler: Could not find any valid asteroids in environment\");\n                        return;\n                    }\n                } else {\n                    console.error(\"MiningHandler: Could not access environment to find asteroids\");\n                    return;\n                }\n            }\n            \n            console.log(\"MiningHandler: Target asteroid found:\", targetAsteroid);\n            \n            // Extra validation to make absolutely sure we have a valid targetAsteroid\n            if (!targetAsteroid || !targetAsteroid.mesh || !targetAsteroid.mesh.position) {\n                console.error(\"MiningHandler: Target asteroid is still invalid after fallback attempts\");\n                return;\n            }\n            \n            // Explicitly set the target asteroid for mining\n            this.miningSystem.setTargetAsteroid(targetAsteroid);\n            \n            // Log asteroid details\n            console.log(\"MiningHandler: Target set for mining:\", {\n                resourceType: targetAsteroid.resourceType || \"unknown\",\n                position: targetAsteroid.mesh?.position?.toArray?.() ?? \"no mesh\",\n                distance: targetAsteroid.mesh?.position?.distanceTo && this.spaceship?.mesh?.position\n                    ? targetAsteroid.mesh.position.distanceTo(this.spaceship.mesh.position)\n                    : \"unknown\"\n            });\n            \n            // Start mining\n            console.log(\"MiningHandler: Starting mining operation\");\n            this.miningSystem.startMining();\n            \n            // Check if mining actually started\n            console.log(\"MiningHandler: Mining started:\", this.miningSystem.isMining);\n            \n        } catch (error) {\n            console.error(\"MiningHandler: Error in handleMiningStart:\", error);\n        }\n    }\n\n    handleMiningEnd(): void {\n        try {\n            console.log(\"MiningHandler: handleMiningEnd called\");\n            \n            // Make sure we have the mining system\n            if (!this.miningSystem) {\n                console.error(\"MiningHandler: Mining system not available for stopping\");\n                return;\n            }\n            \n            // Stop mining\n            this.miningSystem.stopMining();\n            console.log(\"MiningHandler: Mining stopped\");\n            \n        } catch (e) {\n            console.error(\"MiningHandler: Error stopping mining:\", e);\n        }\n    }\n}\n","// weaponHandler.js - Weapon firing handlers for touch controls\n\ntype WeaponSystem = {\n    setFiring?: (active: boolean) => void;\n    isWeaponActive?: boolean;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        combat?: WeaponSystem;\n        weaponSystem?: WeaponSystem;\n        controls?: {\n            weaponSystem?: WeaponSystem;\n        };\n        audio?: {\n            playSound: (id: string) => void;\n            stopSound: (id: string) => void;\n        };\n    };\n    gameInstance?: {\n        combat?: WeaponSystem;\n        audio?: {\n            playSound: (id: string) => void;\n            stopSound: (id: string) => void;\n        };\n    };\n};\n\nexport class WeaponHandler {\n    weaponSystem: WeaponSystem | null;\n\n    constructor() {\n        this.weaponSystem = null;\n    }\n\n    setWeaponSystem(weaponSystem: WeaponSystem | null) {\n        this.weaponSystem = weaponSystem;\n    }\n\n    handleFiringStart(): void {\n        try {\n            // First try local reference to weapon system (which is actually the Combat class)\n            if (this.weaponSystem) {\n                // Attempt to use the setFiring method from the Combat class\n                if (typeof this.weaponSystem.setFiring === 'function') {\n                    this.weaponSystem.setFiring(true);\n                } else {\n                    // Fallback to the older isWeaponActive property\n                    this.weaponSystem.isWeaponActive = true;\n                }\n                \n                // Try to play sound if available\n                const windowWithGame = window as GameWindow;\n                const game = windowWithGame.gameInstance || windowWithGame.game;\n                if (game && game.audio) {\n                    game.audio.playSound('laser');\n                }\n                return;\n            }\n            \n            // Fallback to global game reference\n            const windowWithGame = window as GameWindow;\n            const game = windowWithGame.gameInstance || windowWithGame.game;\n            if (!game) {\n                console.error(\"WeaponHandler: No game reference found\");\n                return;\n            }\n            \n            // Try direct combat object on game first (preferred)\n            if (game.combat) {\n                game.combat.setFiring(true);\n                \n                // Play laser sound if available\n                if (game.audio) {\n                    game.audio.playSound('laser');\n                }\n                return;\n            }\n            \n            // Legacy fallbacks\n            if (game.weaponSystem) {\n                if (typeof game.weaponSystem.setFiring === 'function') {\n                    game.weaponSystem.setFiring(true);\n                } else {\n                    game.weaponSystem.isWeaponActive = true;\n                }\n                \n                // Play laser sound if available\n                if (game.audio) {\n                    game.audio.playSound('laser');\n                }\n                return;\n            }\n            \n            // Try through controls\n            if (game.controls && game.controls.weaponSystem) {\n                if (typeof game.controls.weaponSystem.setFiring === 'function') {\n                    game.controls.weaponSystem.setFiring(true);\n                } else {\n                    game.controls.weaponSystem.isWeaponActive = true;\n                }\n                \n                // Play laser sound if available\n                if (game.audio) {\n                    game.audio.playSound('laser');\n                }\n                return;\n            }\n            \n            console.error(\"WeaponHandler: No weapon system or combat system found\");\n        } catch (e) {\n            console.error(\"WeaponHandler: Error in handleFiringStart:\", e);\n        }\n    }\n\n    handleFiringEnd(): void {\n        try {\n            // First try local reference to weapon system (which is actually the Combat class)\n            if (this.weaponSystem) {\n                // Attempt to use the setFiring method from the Combat class\n                if (typeof this.weaponSystem.setFiring === 'function') {\n                    this.weaponSystem.setFiring(false);\n                } else {\n                    // Fallback to the older isWeaponActive property\n                    this.weaponSystem.isWeaponActive = false;\n                }\n                \n                // Try to stop sound if available\n                const windowWithGame = window as GameWindow;\n                const game = windowWithGame.gameInstance || windowWithGame.game;\n                if (game && game.audio) {\n                    game.audio.stopSound('laser');\n                }\n                return;\n            }\n            \n            // Fallback to global game reference\n            const windowWithGame = window as GameWindow;\n            const game = windowWithGame.gameInstance || windowWithGame.game;\n            if (!game) {\n                console.error(\"WeaponHandler: No game reference found\");\n                return;\n            }\n            \n            // Try direct combat object on game first (preferred)\n            if (game.combat) {\n                game.combat.setFiring(false);\n                \n                // Stop laser sound if available\n                if (game.audio) {\n                    game.audio.stopSound('laser');\n                }\n                return;\n            }\n            \n            // Legacy fallbacks\n            if (game.weaponSystem) {\n                if (typeof game.weaponSystem.setFiring === 'function') {\n                    game.weaponSystem.setFiring(false);\n                } else {\n                    game.weaponSystem.isWeaponActive = false;\n                }\n                \n                // Stop laser sound if available\n                if (game.audio) {\n                    game.audio.stopSound('laser');\n                }\n                return;\n            }\n            \n            // Try through controls\n            if (game.controls && game.controls.weaponSystem) {\n                if (typeof game.controls.weaponSystem.setFiring === 'function') {\n                    game.controls.weaponSystem.setFiring(false);\n                } else {\n                    game.controls.weaponSystem.isWeaponActive = false;\n                }\n                \n                // Stop laser sound if available\n                if (game.audio) {\n                    game.audio.stopSound('laser');\n                }\n                return;\n            }\n            \n            console.error(\"WeaponHandler: No weapon system or combat system found\");\n        } catch (e) {\n            console.error(\"WeaponHandler: Error in handleFiringEnd:\", e);\n        }\n    }\n}\n","// systemActions.js - System action handlers (docking, targeting, deployment) for touch controls\n\ntype DockingSystem = {\n    dockWithStargate: () => void;\n    nearStargate?: boolean;\n};\n\ntype TargetingSystem = {\n    toggleLockOn: () => void;\n};\n\ntype GameWindow = Window & {\n    mainMessageBus?: {\n        publish: (event: string, data?: unknown) => void;\n    };\n    game?: {\n        controls?: {\n            dockingSystem?: DockingSystem;\n        };\n    };\n    gameInstance?: {\n        controls?: {\n            dockingSystem?: DockingSystem;\n        };\n    };\n};\n\nexport class SystemActions {\n    dockingSystem: DockingSystem | null;\n    targetingSystem: TargetingSystem | null;\n\n    constructor() {\n        this.dockingSystem = null;\n        this.targetingSystem = null;\n    }\n\n    setDockingSystem(dockingSystem: DockingSystem | null): void {\n        this.dockingSystem = dockingSystem;\n    }\n\n    setTargetingSystem(targetingSystem: TargetingSystem | null): void {\n        this.targetingSystem = targetingSystem;\n    }\n\n    handleDocking(): void {\n        if (!this.dockingSystem) {\n            console.error(\"SystemActions: Docking system not available\");\n            return;\n        }\n        \n        console.log(\"SystemActions: Dock button pressed, attempting to dock with stargate\");\n        \n        // Call docking method\n        this.dockingSystem.dockWithStargate();\n    }\n\n    handleTargeting(): void {\n        if (!this.targetingSystem) {\n            console.error(\"SystemActions: Targeting system not available\");\n            return;\n        }\n        \n        // Toggle targeting system\n        this.targetingSystem.toggleLockOn();\n    }\n\n    /**\n     * Handle deploying a laser turret\n     */\n    handleDeployLaser(): void {\n        console.log(\"SystemActions: Deploying laser turret\");\n        \n        // Publish deploy laser event\n        const windowWithGame = window as GameWindow;\n        if (windowWithGame.mainMessageBus) {\n            windowWithGame.mainMessageBus.publish('input.deployLaser', {});\n        }\n    }\n\n    // Helper method to check if dock should be visible\n    shouldShowDock(spaceship: { isDocked?: boolean } | null): boolean {\n        if (!this.dockingSystem || !spaceship) {\n            // Fallback to window.game if the direct reference isn't set yet\n            const windowWithGame = window as GameWindow;\n            const game = windowWithGame.gameInstance || windowWithGame.game;\n            if (game && game.controls && game.controls.dockingSystem && spaceship) {\n                const dockingSystem = game.controls.dockingSystem;\n                return !!dockingSystem.nearStargate && !spaceship.isDocked;\n            }\n            return false;\n        }\n        \n        return !!this.dockingSystem.nearStargate && !spaceship.isDocked;\n    }\n}\n","// touchControls.js - Main coordinator for touch controls on mobile devices\n\nimport { JoystickZones } from './ui/joystickZones.ts';\nimport { ActionButtons } from './ui/actionButtons.ts';\nimport { JoystickHandler } from './input/joystickHandler.ts';\nimport { GestureDetector } from './input/gestureDetector.ts';\nimport { MiningHandler } from './actions/miningHandler.ts';\nimport { WeaponHandler } from './actions/weaponHandler.ts';\nimport { SystemActions } from './actions/systemActions.ts';\n\ntype TouchSpaceship = {\n    isDocked: boolean;\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        left: boolean;\n        right: boolean;\n        boost: boolean;\n    };\n    mesh?: {\n        position?: {\n            distanceTo?: (pos: unknown) => number;\n        };\n    };\n};\n\ntype TouchPhysics = {\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype MiningSystem = {\n    isMining?: boolean;\n    setTargetAsteroid: (asteroid: unknown) => void;\n    startMining: () => void;\n    stopMining: () => void;\n};\n\ntype MiningAsteroid = {\n    resourceType?: string;\n    mesh?: {\n        position?: {\n            toArray?: () => number[];\n            distanceTo?: (pos: unknown) => number;\n        };\n    };\n};\n\ntype TargetingSystem = {\n    getCurrentTarget: () => MiningAsteroid | null;\n    isLockOnEnabled: () => boolean;\n    toggleLockOn: () => void;\n    findNearestTarget: () => MiningAsteroid | null;\n};\n\ntype DockingSystem = {\n    dockWithStargate: () => void;\n    nearStargate?: boolean;\n};\n\ntype WeaponSystem = {\n    setFiring?: (active: boolean) => void;\n    isWeaponActive?: boolean;\n};\n\ntype TouchControlsSystems = {\n    miningSystem?: MiningSystem | null;\n    targetingSystem?: TargetingSystem | null;\n    dockingSystem?: DockingSystem | null;\n    weaponSystem?: WeaponSystem | null;\n    spaceship?: TouchSpaceship;\n};\n\ntype GameWindow = Window & {\n    game?: {\n        introSequenceActive?: boolean;\n    };\n};\n\nexport class TouchControls {\n    spaceship: TouchSpaceship;\n    physics: TouchPhysics;\n    isInitialized: boolean;\n    joystickZones: JoystickZones;\n    actionButtons: ActionButtons;\n    joystickHandler: JoystickHandler;\n    gestureDetector: GestureDetector;\n    miningHandler: MiningHandler;\n    weaponHandler: WeaponHandler;\n    systemActions: SystemActions;\n\n    constructor(spaceship: TouchSpaceship, physics: TouchPhysics) {\n        this.spaceship = spaceship;\n        this.physics = physics;\n        this.isInitialized = false;\n        \n        // Initialize UI modules\n        this.joystickZones = new JoystickZones();\n        this.actionButtons = new ActionButtons();\n        \n        // Initialize input modules\n        this.joystickHandler = new JoystickHandler(spaceship, physics);\n        this.gestureDetector = new GestureDetector();\n        \n        // Initialize action modules\n        this.miningHandler = new MiningHandler(spaceship);\n        this.weaponHandler = new WeaponHandler();\n        this.systemActions = new SystemActions();\n        \n        // Create crosshair and setup controls\n        this.createCrosshair();\n        this.initializeAsync();\n    }\n    \n    async initializeAsync(): Promise<void> {\n        try {\n            await this.joystickHandler.loadNippleJS();\n            this.setupTouchControls();\n        } catch (err) {\n            console.error('Failed to load nipple.js:', err);\n        }\n    }\n    \n    // Method to set the systems we need to interact with\n    setControlSystems(controls: TouchControlsSystems) {\n        console.log(\"TouchControls: Setting control systems\");\n        \n        if (!controls) {\n            console.error(\"TouchControls: Controls object is null or undefined\");\n            return;\n        }\n        \n        // Set systems for action handlers\n        this.miningHandler.setMiningSystem(controls.miningSystem ?? null);\n        this.miningHandler.setTargetingSystem(controls.targetingSystem ?? null);\n        this.weaponHandler.setWeaponSystem(controls.weaponSystem ?? null);\n        this.systemActions.setDockingSystem(controls.dockingSystem ?? null);\n        this.systemActions.setTargetingSystem(controls.targetingSystem ?? null);\n        \n        // Log system connections\n        const systemStatus = {\n            hasMiningSystem: !!controls.miningSystem,\n            hasTargetingSystem: !!controls.targetingSystem,\n            hasDockingSystem: !!controls.dockingSystem,\n            hasWeaponSystem: !!controls.weaponSystem\n        };\n        \n        console.log(\"TouchControls: Systems connected\", systemStatus);\n        \n        // Store reference to spaceship from controls if not already set\n        if (!this.spaceship && controls.spaceship) {\n            this.spaceship = controls.spaceship;\n            console.log(\"TouchControls: Spaceship reference set from controls\");\n        }\n        \n        return this; // For method chaining\n    }\n    \n    createCrosshair(): void {\n        // Create a small crosshair in the center of the screen\n        const crosshair = document.createElement('div');\n        crosshair.id = 'mobile-crosshair';\n        crosshair.style.position = 'absolute';\n        crosshair.style.top = '50%';\n        crosshair.style.left = '50%';\n        crosshair.style.transform = 'translate(-50%, -50%)';\n        crosshair.style.width = '10px';\n        crosshair.style.height = '10px';\n        crosshair.style.pointerEvents = 'none';\n        crosshair.style.zIndex = '999';\n        \n        // Create crosshair shape with a plus sign\n        crosshair.innerHTML = `\n            <div style=\"position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background-color: rgba(120, 220, 232, 0.8);\"></div>\n            <div style=\"position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background-color: rgba(120, 220, 232, 0.8);\"></div>\n            <div style=\"position: absolute; top: 50%; left: 50%; width: 3px; height: 3px; background-color: rgba(120, 220, 232, 0.8); border-radius: 50%; transform: translate(-50%, -50%);\"></div>\n        `;\n        \n        document.body.appendChild(crosshair);\n    }\n    \n    setupTouchControls(): void {\n        // Create UI zones and buttons\n        const zones = this.joystickZones.createJoystickZones();\n        const buttons = this.actionButtons.createActionButtons();\n        \n        // Initialize joysticks after a short delay to ensure DOM is ready\n        setTimeout(() => {\n            const success = this.joystickHandler.initializeJoysticks(zones.leftZone, zones.rightZone);\n            if (success) {\n                this.setupButtonEvents(buttons);\n                this.isInitialized = true;\n            }\n        }, 100);\n    }\n    \n    setupButtonEvents(buttons: { fire: HTMLElement | null; mine: HTMLElement | null; target: HTMLElement | null; dock: HTMLElement | null; deployLaser: HTMLElement | null }): void {\n        // Setup fire button events\n        this.actionButtons.addButtonEvents(\n            buttons.fire,\n            () => this.weaponHandler.handleFiringStart(),\n            () => this.weaponHandler.handleFiringEnd()\n        );\n        \n        // Setup mine button events\n        this.actionButtons.addButtonEvents(\n            buttons.mine,\n            () => this.miningHandler.handleMiningStart(),\n            () => this.miningHandler.handleMiningEnd()\n        );\n        \n        // Setup target button events\n        this.actionButtons.addButtonEvents(\n            buttons.target,\n            () => this.systemActions.handleTargeting()\n        );\n        \n        // Setup dock button events\n        this.actionButtons.addButtonEvents(\n            buttons.dock,\n            () => {\n                this.systemActions.handleDocking();\n                this.actionButtons.hideDockButton();\n            }\n        );\n        \n        // Setup deploy laser button events\n        this.actionButtons.addButtonEvents(\n            buttons.deployLaser,\n            () => this.systemActions.handleDeployLaser()\n        );\n    }\n    \n    hide(): void {\n        this.joystickZones.hideZones();\n        this.actionButtons.hideButtons();\n        this.gestureDetector.disable();\n    }\n    \n    show(): void {\n        // Only show controls when not docked and not in intro sequence\n        const windowWithGame = window as GameWindow;\n        if ((this.spaceship && this.spaceship.isDocked) || \n            (windowWithGame.game && windowWithGame.game.introSequenceActive)) {\n            console.log(\"TouchControls: Not showing controls during docked state or intro sequence\");\n            return;\n        }\n        \n        this.joystickZones.showZones();\n        this.actionButtons.showButtons();\n        this.gestureDetector.enable();\n    }\n    \n    update(): void {\n        // Update dock button visibility based on proximity to stargate\n        if (this.systemActions.shouldShowDock(this.spaceship)) {\n            this.actionButtons.showDockButton();\n        } else {\n            this.actionButtons.hideDockButton();\n        }\n    }\n    \n    // Compatibility methods for existing API\n    showDockButton(): void {\n        this.actionButtons.showDockButton();\n    }\n    \n    hideDockButton(): void {\n        this.actionButtons.hideDockButton();\n    }\n}\n","// touchControls.js - Touch controls for mobile devices using nipple.js\n// This is a compatibility wrapper for the refactored touch controls\n\nimport { TouchControls as RefactoredTouchControls } from './touch/touchControls.ts';\n\ntype TouchSpaceship = {\n    isDocked: boolean;\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        left: boolean;\n        right: boolean;\n        boost: boolean;\n    };\n};\n\ntype TouchPhysics = {\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype ControlsInput = Parameters<RefactoredTouchControls['setControlSystems']>[0];\n\nexport class TouchControls extends RefactoredTouchControls {\n    leftJoystick: unknown;\n    rightJoystick: unknown;\n    dockButton: HTMLElement | null;\n    mineButton: HTMLElement | null;\n    fireButton: HTMLElement | null;\n    targetButton: HTMLElement | null;\n    threshold: number;\n    miningSystem: unknown;\n    targetingSystem: unknown;\n    dockingSystem: unknown;\n    weaponSystem: unknown;\n\n    constructor(spaceship: TouchSpaceship, physics: TouchPhysics) {\n        super(spaceship, physics);\n        \n        // Maintain compatibility properties for legacy code\n        this.leftJoystick = null;\n        this.rightJoystick = null;\n        this.dockButton = null;\n        this.mineButton = null;\n        this.fireButton = null;\n        this.targetButton = null;\n        this.threshold = 0.1;\n        \n        // Store references to systems we need to interact with\n        this.miningSystem = null;\n        this.targetingSystem = null;\n        this.dockingSystem = null;\n        this.weaponSystem = null;\n    }\n    \n    // Override setControlSystems to maintain compatibility and store legacy references\n    setControlSystems(controls: ControlsInput) {\n        // Call parent implementation\n        const result = super.setControlSystems(controls);\n        \n        // Store legacy references for backward compatibility\n        this.miningSystem = controls.miningSystem;\n        this.targetingSystem = controls.targetingSystem;\n        this.dockingSystem = controls.dockingSystem;\n        this.weaponSystem = controls.weaponSystem;\n        \n        return result;\n    }\n} \n","/**\n * mobileDetector.ts - Utility for detecting mobile devices and touch capabilities\n */\n\n// Extend the Navigator interface to include properties used for mobile detection\ndeclare global {\n    interface Navigator {\n      msMaxTouchPoints?: number; // For older IE/Edge\n    }\n}\n\nexport class MobileDetector {\n    // Cache for isMobile() result\n    private static _isMobileCache: boolean | undefined = undefined;\n\n    /**\n     * Check if the current device is a mobile device\n     * @returns True if the device is mobile\n     */\n    static isMobile(): boolean {\n        // Store result in cache to avoid recalculation\n        if (MobileDetector._isMobileCache !== undefined) {\n            return MobileDetector._isMobileCache;\n        }\n        \n        // Check for mobile user agent\n        const userAgentCheck = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Android|iP(ad|hone|od)/i.test(navigator.userAgent);\n        \n        // Check for touch capabilities - more comprehensive check\n        const touchCheck = (\n            'ontouchstart' in window || \n            (navigator.maxTouchPoints !== undefined && navigator.maxTouchPoints > 0) || \n            (navigator.msMaxTouchPoints !== undefined && navigator.msMaxTouchPoints > 0) ||\n            ((window as any).DocumentTouch && document instanceof (window as any).DocumentTouch)\n        );\n        \n        // Check screen width and orientation\n        const screenCheck = window.innerWidth < 900; // More generous width threshold\n        \n        // Check if viewport meta tag has mobile-optimized settings\n        const viewportCheck = (() => {\n            const viewport = document.querySelector('meta[name=viewport]');\n            if (viewport instanceof HTMLMetaElement) { // Cast to HTMLMetaElement\n                return viewport.content.includes('width=device-width');\n            }\n            return false;\n        })();\n        \n        // Check for specific mobile browser features\n        const mobileFeatureCheck = 'orientation' in window || 'onorientationchange' in window;\n        \n        // Check if device motion/orientation events are supported (typically mobile)\n        const motionCheck = 'DeviceMotionEvent' in window || 'DeviceOrientationEvent' in window;\n        \n        // Improve detection of tablets - they are also considered mobile for our purposes\n        const isTablet = (() => {\n            // iPads now report as desktop in newer iOS, so we need specific checks\n            const isIpad = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;\n            // Android tablets often have larger screens\n            const isAndroidTablet = /android/i.test(navigator.userAgent) && !/mobile/i.test(navigator.userAgent);\n            \n            return isIpad || isAndroidTablet;\n        })();\n        \n        // More comprehensive detection logic - a device is mobile if:\n        // 1. It matches mobile user agent patterns, OR\n        // 2. It has touch capabilities AND either:\n        //    a. Has a small-to-medium screen size, OR\n        //    b. Has mobile browser features, OR\n        //    c. Supports device motion/orientation, OR\n        //    d. Is detected as a tablet\n        MobileDetector._isMobileCache = userAgentCheck || \n            (touchCheck && (screenCheck || mobileFeatureCheck || motionCheck || viewportCheck || isTablet));\n        \n        console.log(`MobileDetector: Device detected as ${MobileDetector._isMobileCache ? 'mobile' : 'desktop'}`);\n        console.log(`- UA: ${userAgentCheck}, touch: ${touchCheck}, screen: ${screenCheck}`);\n        console.log(`- features: ${mobileFeatureCheck}, motion: ${motionCheck}, tablet: ${isTablet}`);\n        \n        return MobileDetector._isMobileCache!;\n    }\n    \n    /**\n     * Reset the mobile detection cache (useful after device orientation changes)\n     */\n    static resetCache(): void {\n        MobileDetector._isMobileCache = undefined;\n    }\n    \n    /**\n     * Check if the device supports touch events\n     * @returns True if touch is supported\n     */\n    static hasTouch(): boolean {\n        return ('ontouchstart' in window) || \n               (navigator.maxTouchPoints !== undefined && navigator.maxTouchPoints > 0) || \n               (navigator.msMaxTouchPoints !== undefined && navigator.msMaxTouchPoints > 0) ||\n               ((window as any).DocumentTouch && document instanceof (window as any).DocumentTouch);\n    }\n    \n    /**\n     * Get device orientation\n     * @returns 'portrait' or 'landscape'\n     */\n    static getOrientation(): 'portrait' | 'landscape' {\n        return window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';\n    }\n    \n    /**\n     * Add handler for orientation changes\n     * @param handler Function to call when orientation changes\n     */\n    static addOrientationChangeHandler(handler: (orientation: 'portrait' | 'landscape') => void): void {\n        // Track previous orientation\n        let prevOrientation: 'portrait' | 'landscape' = MobileDetector.getOrientation();\n        \n        // Use both resize and orientationchange for better compatibility\n        const checkOrientation = () => {\n            const currentOrientation = MobileDetector.getOrientation();\n            if (currentOrientation !== prevOrientation) {\n                prevOrientation = currentOrientation;\n                // Reset mobile detection cache\n                MobileDetector.resetCache();\n                // Call handler with new orientation\n                handler(currentOrientation);\n            }\n        };\n        \n        window.addEventListener('resize', checkOrientation);\n        \n        // Add orientationchange listener if available\n        if ('onorientationchange' in window) {\n            window.addEventListener('orientationchange', checkOrientation);\n        }\n    }\n} ","// controls.ts - Main controls module that integrates all control components\n\nimport { InputHandler } from './controls/inputHandler.ts';\nimport { GamepadHandler } from './controls/gamepadHandler.ts';\nimport { MiningSystem } from './controls/miningSystem.ts';\nimport { TargetingSystem } from './controls/targetingSystem.ts';\nimport { DockingSystem } from './controls/dockingSystem.ts';\nimport { TouchControls } from './controls/touchControls.ts';\nimport { MobileDetector } from '../utils/mobileDetector.js';\nimport * as THREE from 'three';\nimport type { DockingSpaceship, DockingUI, ResourceInventory } from './controls/docking/types.ts';\n\n// Type definitions for dependencies\ntype SceneWithCamera = THREE.Scene & {\n    camera: THREE.Camera;\n};\n\ntype SpaceshipType = DockingSpaceship & {\n    thrust: {\n        forward: boolean;\n        backward: boolean;\n        right: boolean;\n        left: boolean;\n        boost: boolean;\n    };\n    thrustPower: number;\n    strafePower: number;\n    mesh: THREE.Object3D;\n    scanRange?: number;\n};\n\ntype PhysicsType = {\n    scene: SceneWithCamera;\n    updateRotation: (deltaX: number, deltaY: number) => void;\n};\n\ntype EnvironmentType = {\n    stargate: any;\n    asteroidBelt?: {\n        removeAsteroid: (asteroid: any) => void;\n    };\n    asteroids: any[];\n    checkAnomalyCollision: (position: THREE.Vector3) => any;\n    collectAnomalyOrb: (anomaly: any) => any;\n};\n\ntype UIType = DockingUI & {\n    setControls: (controls: Controls) => void;\n};\n\ntype ResourcesType = ResourceInventory;\n\ntype AnomalyType = {\n    position: THREE.Vector3;\n    orb?: {\n        color: any;\n        size: number;\n    };\n    orbCollected?: boolean;\n};\n\ntype OrbData = {\n    rarity: string;\n    value: number;\n};\n\ntype GamepadControlsInput = {\n    targetingSystem?: {\n        toggleLockOn: () => void;\n        cycleLockOnTarget?: (direction?: number) => unknown;\n        getCurrentTarget?: () => unknown;\n    };\n    miningSystem?: {\n        isMining: boolean;\n        stopMining: () => void;\n        startMining: () => void;\n        setTargetAsteroid: (target: unknown) => void;\n    };\n    dockingSystem?: {\n        canDock?: () => boolean;\n        initiateDocking?: () => void;\n    };\n    weaponSystem?: unknown;\n};\n\ninterface MinimalInputHandler {\n    isLocked: () => boolean;\n    exitPointerLock: () => void;\n}\n\nexport class Controls {\n    spaceship: SpaceshipType;\n    physics: PhysicsType;\n    environment: EnvironmentType;\n    ui: UIType;\n    isMobile: boolean;\n    _wasDocked: boolean;\n    weaponSystem: any;\n    scene: SceneWithCamera;\n    inputHandler: InputHandler | MinimalInputHandler;\n    gamepadHandler?: GamepadHandler;\n    touchControls?: TouchControls;\n    miningSystem: MiningSystem;\n    targetingSystem: TargetingSystem;\n    dockingSystem: DockingSystem;\n    resources: ResourcesType;\n    lastAnomalyCheck: number;\n    currentAnomaly: AnomalyType | null;\n    showingAnomalyNotification: boolean;\n    deploymentSystem?: any;\n\n    constructor(spaceship: SpaceshipType, physics: PhysicsType, environment: EnvironmentType, ui: UIType) {\n        console.log(\"Initializing controls systems...\");\n        \n        this.spaceship = spaceship;\n        this.physics = physics;\n        this.environment = environment;\n        this.ui = ui;\n        this.isMobile = MobileDetector.isMobile();\n        this._wasDocked = spaceship ? spaceship.isDocked : false;\n        this.weaponSystem = null; // Initialize weaponSystem reference\n        \n        // Set scene reference for components that need it\n        this.scene = physics.scene;\n        \n        // Initialize controls components\n        if (!this.isMobile) {\n            console.log(\"Initializing keyboard/mouse controls\");\n            this.inputHandler = new InputHandler(spaceship, physics);\n            \n            // Initialize gamepad support for desktop\n            console.log(\"Initializing gamepad support\");\n            this.gamepadHandler = new GamepadHandler(spaceship, physics, this as GamepadControlsInput);\n        } else {\n            console.log(\"Initializing touch controls for mobile\");\n            this.touchControls = new TouchControls(spaceship, physics);\n            // Create a placeholder input handler with minimal functionality\n            // This prevents errors where other systems expect inputHandler to exist\n            this.inputHandler = {\n                isLocked: () => false,\n                exitPointerLock: () => {}\n            };\n        }\n        \n        this.miningSystem = new MiningSystem(spaceship, this.scene);\n        this.targetingSystem = new TargetingSystem(spaceship, this.scene, environment);\n\n        // Initialize docking system with all needed references\n        this.dockingSystem = new DockingSystem(spaceship, environment.stargate, ui);\n\n        // Share the resources reference between components - use live reference, not a copy\n        this.resources = this.miningSystem.resourceExtraction.resources;\n        this.dockingSystem.setResources(this.resources);\n        \n        // Pass control systems to touch controls if on mobile\n        if (this.isMobile && this.touchControls) {\n            type TouchControlsSystemsInput = Parameters<TouchControls['setControlSystems']>[0];\n            this.touchControls.setControlSystems(this as TouchControlsSystemsInput);\n        }\n        \n        // Connect upgrade systems - share references for easier updates\n        this.connectUpgradeEffects();\n        \n        // Set up event handlers - different for mobile vs desktop\n        this.setupEventHandlers();\n        \n        // Initialize anomaly orb collection state\n        this.lastAnomalyCheck = 0;\n        this.currentAnomaly = null;\n        this.showingAnomalyNotification = false;\n        \n        console.log(\"Control systems initialized\");\n    }\n    \n    // New method to connect upgrade effects between systems\n    connectUpgradeEffects(): void {\n        // Give the docking system a way to update the mining system\n        (this.dockingSystem as any).updateMiningSystem = () => {\n            // Update mining speeds based on spaceship's mining efficiency\n            if (this.miningSystem && this.spaceship) {\n                const efficiency = this.spaceship.miningEfficiency || 1.0;\n                \n                // Update base mining speeds for each resource type\n                Object.keys(this.miningSystem.miningSpeedByType).forEach((resourceType: string) => {\n                    // Store original base speeds if not already stored\n                    if (!(this.miningSystem as any)._originalMiningSpeedByType) {\n                        (this.miningSystem as any)._originalMiningSpeedByType = { ...this.miningSystem.miningSpeedByType };\n                    }\n                    \n                    // Apply efficiency to the original base speed\n                    const originalSpeed = (this.miningSystem as any)._originalMiningSpeedByType[resourceType];\n                    (this.miningSystem.miningSpeedByType as any)[resourceType] = originalSpeed * efficiency;\n                });\n                \n                console.log(\"Mining speeds updated with efficiency:\", efficiency);\n                \n                // Update current mining speed if mining is in progress\n                if (this.miningSystem.targetAsteroid) {\n                    this.miningSystem.setTargetAsteroid(this.miningSystem.targetAsteroid);\n                }\n            }\n        };\n    }\n    \n    setupEventHandlers(): void {\n        // Skip adding keyboard controls if on mobile\n        if (this.isMobile) {\n            console.log(\"Mobile device detected, touch handlers are set in TouchControls class\");\n            return;\n        }\n        \n        // Add key event handlers for targeting and mining\n        document.addEventListener('keydown', (e: KeyboardEvent) => {\n            switch (e.key.toLowerCase()) {\n                case 'e': \n                    // Toggle targeting system (changed from 't' to 'e')\n                    this.targetingSystem.toggleLockOn();\n                    break;\n                case 'f7':\n                    // Decrease gamepad sensitivity\n                    if (this.gamepadHandler) {\n                        this.gamepadHandler.lookSensitivity = Math.max(0.2, this.gamepadHandler.lookSensitivity - 0.2);\n                        console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`);\n                        this.showSensitivityNotification(this.gamepadHandler.lookSensitivity);\n                    }\n                    e.preventDefault();\n                    break;\n                case 'f8':\n                    // Increase gamepad sensitivity\n                    if (this.gamepadHandler) {\n                        this.gamepadHandler.lookSensitivity = Math.min(3.0, this.gamepadHandler.lookSensitivity + 0.2);\n                        console.log(`Gamepad sensitivity: ${this.gamepadHandler.lookSensitivity.toFixed(1)}`);\n                        this.showSensitivityNotification(this.gamepadHandler.lookSensitivity);\n                    }\n                    e.preventDefault();\n                    break;\n                case 'f9':\n                    // Toggle gamepad debug display\n                    if (this.gamepadHandler) {\n                        this.gamepadHandler.toggleDebug();\n                        console.log('Gamepad debug display toggled');\n                    }\n                    e.preventDefault();\n                    break;\n                case 'tab': \n                    // Cycle through targets if targeting is enabled\n                    if (this.targetingSystem.isLockOnEnabled()) {\n                        const target = this.targetingSystem.cycleLockOnTarget();\n                        if (target) {\n                            this.miningSystem.setTargetAsteroid(target);\n                        }\n                    }\n                    e.preventDefault(); // Prevent tab from changing focus\n                    break;\n                case 'r': // Changed from 'e' to 'r' (an unused key)\n                    // Toggle mining if targeting is enabled and we have a target\n                    if (this.targetingSystem.isLockOnEnabled()) {\n                        const target = this.targetingSystem.getCurrentTarget();\n                        if (target) {\n                            this.miningSystem.setTargetAsteroid(target);\n                            if (this.miningSystem.isMining) {\n                                this.miningSystem.stopMining();\n                            } else {\n                                this.miningSystem.startMining();\n                            }\n                        }\n                    }\n                    break;\n                case 't': \n                    // Deploy a laser turret\n                    console.log(\"Deploying laser turret\");\n                    if ((window as any).mainMessageBus) {\n                        (window as any).mainMessageBus.publish('input.deployLaser', {});\n                    }\n                    break;\n                case 'g': \n                    // Pick up an item\n                    console.log(\"Attempting to pick up an item\");\n                    if ((window as any).mainMessageBus) {\n                        (window as any).mainMessageBus.publish('input.pickupInteract', {});\n                    }\n                    break;\n            }\n        });\n        \n        // Add mouse click for mining\n        document.addEventListener('mousedown', (e: MouseEvent) => {\n            if (e.button === 0 && this.inputHandler.isLocked()) { // Left mouse button\n                // Fire particle cannon\n                if ((window as any).game && (window as any).game.combat) {\n                    (window as any).game.combat.setFiring(true);\n                }\n            }\n        });\n        \n        // Add mouseup to stop mining when button is released\n        document.addEventListener('mouseup', (e: MouseEvent) => {\n            if (e.button === 0) { // Left mouse button\n                // Stop firing\n                if ((window as any).game && (window as any).game.combat) {\n                    (window as any).game.combat.setFiring(false);\n                }\n            }\n        });\n    }\n    \n    setupStargateUIControls(): void {\n        if (this.dockingSystem) {\n            this.dockingSystem.setupStargateUIControls();\n        }\n    }\n    \n    // Method to dock with stargate (called from main.js on game start)\n    dockWithStargate(): void {\n        if (this.dockingSystem) {\n            this.dockingSystem.dockWithStargate();\n            \n            // Hide touch controls when docked\n            if (this.isMobile && this.touchControls) {\n                this.touchControls.hide();\n            }\n        } else {\n            console.error(\"Docking system not initialized\");\n        }\n    }\n    \n    // Collect energy orb from space anomaly\n    collectEnergyOrb(): void {\n        if (!this.environment || !this.spaceship) return;\n        \n        // Check if player is near an anomaly with an active orb\n        const anomaly = this.environment.checkAnomalyCollision(this.spaceship.mesh.position);\n        if (!anomaly) {\n            return; // No anomaly in range, silently return\n        }\n        \n        // Try to collect the orb\n        const orbData = this.environment.collectAnomalyOrb(anomaly) as OrbData | null;\n        if (!orbData) {\n            // Orb already collected, notification handled in checkForAnomalyOrbs\n            return;\n        }\n\n        // Add orb to inventory\n        if (!this.resources.orbs) {\n            this.resources.orbs = {\n                common: 0,\n                uncommon: 0,\n                rare: 0,\n                epic: 0,\n                legendary: 0\n            };\n        }\n        this.resources.orbs[orbData.rarity] = (this.resources.orbs[orbData.rarity] || 0) + 1;\n        \n        // Show notification with value and rarity\n        let rarityColor: string;\n        switch(orbData.rarity) {\n            case 'legendary':\n                rarityColor = \"#ff0000\"; // Red\n                break;\n            case 'epic':\n                rarityColor = \"#ff6600\"; // Orange\n                break;\n            case 'rare':\n                rarityColor = \"#9900ff\"; // Purple\n                break;\n            case 'uncommon':\n                rarityColor = \"#0066ff\"; // Blue\n                break;\n            default: // common\n                rarityColor = \"#00ff66\"; // Green\n                break;\n        }\n        \n        const capitalizedRarity = orbData.rarity.charAt(0).toUpperCase() + orbData.rarity.slice(1);\n        \n        // Show message with appropriate styling\n        this.showAnomalyMessage(\n            `Collected ${capitalizedRarity} Energy Orb (${orbData.value} CR)`,\n            rarityColor\n        );\n        \n        // Trigger collection effect\n        this.triggerOrbCollectionEffect(anomaly);\n        \n        // Play sound if audio manager is available\n        if ((window as any).game && (window as any).game.audio) {\n            // Play different sounds based on rarity\n            switch(orbData.rarity) {\n                case 'legendary':\n                    (window as any).game.audio.playSoundEffect('powerup_legendary', 0.8);\n                    break;\n                case 'epic':\n                    (window as any).game.audio.playSoundEffect('powerup_epic', 0.7);\n                    break;\n                case 'rare':\n                    (window as any).game.audio.playSoundEffect('powerup_rare', 0.6);\n                    break;\n                case 'uncommon':\n                    (window as any).game.audio.playSoundEffect('powerup_uncommon', 0.5);\n                    break;\n                default: // common\n                    (window as any).game.audio.playSoundEffect('powerup_common', 0.4);\n                    break;\n            }\n        }\n    }\n    \n    // Create a visual effect when collecting an orb\n    triggerOrbCollectionEffect(anomaly: AnomalyType): void {\n        // Check if we have access to the scene and visual effects\n        if (!this.scene || !anomaly) return;\n        \n        // Create an explosion effect at the anomaly orb position\n        if ((window as any).game && (window as any).game.combat) {\n            const position = anomaly.position.clone();\n            \n            // Use explosion effect from combat system\n            (window as any).game.combat.createExplosionEffect(position, 2000, true);\n            \n            // Also publish an event for additional effects\n            if ((window as any).mainMessageBus) {\n                (window as any).mainMessageBus.publish('vfx.explosion', {\n                    position: position,\n                    color: anomaly.orb?.color,\n                    size: anomaly.orb ? anomaly.orb.size * 2 : 1,\n                    duration: 2000\n                });\n            }\n        }\n    }\n    \n    // Show a notification when anomaly is found or orb is collected\n    showAnomalyMessage(message: string, color: string): void {\n        if (this.showingAnomalyNotification) return; // Don't stack notifications\n        \n        this.showingAnomalyNotification = true;\n        \n        // Create notification element\n        const notification = document.createElement('div');\n        notification.style.position = 'fixed';\n        notification.style.top = '30%';\n        notification.style.left = '50%';\n        notification.style.transform = 'translate(-50%, -50%)';\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\n        notification.style.color = color || '#ffffff';\n        notification.style.padding = '15px 30px';\n        notification.style.borderRadius = '10px';\n        notification.style.border = `2px solid ${color || '#ffffff'}`;\n        notification.style.boxShadow = `0 0 15px ${color || '#ffffff'}`;\n        notification.style.fontFamily = 'Courier New, monospace';\n        notification.style.fontSize = '18px';\n        notification.style.zIndex = '1000';\n        notification.style.textAlign = 'center';\n        notification.style.pointerEvents = 'none'; // Don't block mouse events\n        \n        // Set notification text\n        notification.textContent = message;\n        \n        // Add to DOM\n        document.body.appendChild(notification);\n        \n        // Remove after a few seconds\n        setTimeout(() => {\n            notification.style.opacity = '0';\n            notification.style.transition = 'opacity 0.8s';\n            \n            setTimeout(() => {\n                notification.remove();\n                this.showingAnomalyNotification = false;\n            }, 800);\n        }, 3000);\n    }\n    \n    showSensitivityNotification(sensitivity: number): void {\n        // Create notification element\n        const notification = document.createElement('div');\n        notification.textContent = `Gamepad Sensitivity: ${sensitivity.toFixed(1)}`;\n        notification.style.position = 'fixed';\n        notification.style.top = '100px';\n        notification.style.left = '50%';\n        notification.style.transform = 'translateX(-50%)';\n        notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';\n        notification.style.color = '#30cfd0';\n        notification.style.padding = '10px 20px';\n        notification.style.borderRadius = '5px';\n        notification.style.border = '1px solid #30cfd0';\n        notification.style.fontFamily = 'monospace';\n        notification.style.fontSize = '16px';\n        notification.style.zIndex = '10000';\n        notification.style.pointerEvents = 'none';\n        \n        document.body.appendChild(notification);\n        \n        // Fade out and remove after 2 seconds\n        setTimeout(() => {\n            notification.style.transition = 'opacity 0.5s';\n            notification.style.opacity = '0';\n            setTimeout(() => notification.remove(), 500);\n        }, 2000);\n    }\n    \n    /**\n     * Update control systems\n     * @param deltaTime Time since last update in seconds\n     */\n    update(deltaTime: number = 1/60): void {\n        // Skip ALL updates if intro sequence is active\n        if ((window as any).game && (window as any).game.introSequenceActive) {\n            return;\n        }\n        \n        // Check if docking status changed\n        if (this.spaceship) {\n            const wasDocked = this._wasDocked;\n            const isDocked = this.spaceship.isDocked;\n            \n            // If docking status changed, update touch controls visibility\n            if (this.isMobile && this.touchControls && wasDocked !== isDocked) {\n                if (isDocked) {\n                    this.touchControls.hide();\n                } else {\n                    this.touchControls.show();\n                }\n                this._wasDocked = isDocked;\n            }\n        }\n        \n        // Skip updates if docked\n        if (this.spaceship && this.spaceship.isDocked) {\n            // Only update the docking system when docked\n            if (this.dockingSystem) {\n                this.dockingSystem.update();\n            }\n            return;\n        }\n        \n        // Update gamepad input if available\n        if (this.gamepadHandler) {\n            this.gamepadHandler.update(deltaTime);\n        }\n        \n        // Update all control systems\n        if (this.targetingSystem) {\n            this.targetingSystem.update();\n        }\n        \n        if (this.miningSystem) {\n            // Pass deltaTime to ensure frame-rate independent mining\n            this.miningSystem.update(deltaTime);\n            \n            // Check if mining has destroyed an asteroid\n            const destroyedAsteroid = this.miningSystem.getLastDestroyedAsteroid();\n            if (destroyedAsteroid && this.environment && this.environment.asteroidBelt) {\n                // Remove the asteroid from the environment\n                this.environment.asteroidBelt.removeAsteroid(destroyedAsteroid);\n            }\n        }\n        \n        if (this.dockingSystem) {\n            this.dockingSystem.update();\n        }\n        \n        // Update touch controls if on mobile\n        if (this.isMobile && this.touchControls) {\n            this.touchControls.update();\n        }\n        \n        if (this.deploymentSystem) {\n            this.deploymentSystem.update();\n        }\n        \n        // Check for and automatically collect anomaly orbs\n        this.checkForAnomalyOrbs();\n    }\n    \n    // Check if the player is near an anomaly orb and collect it if close enough\n    checkForAnomalyOrbs(): void {\n        if (!this.environment || !this.spaceship) return;\n        \n        // Limit check frequency to avoid performance impact\n        const now = performance.now();\n        if (now - this.lastAnomalyCheck < 500) return; // Check every 500ms\n        this.lastAnomalyCheck = now;\n        \n        // Check if player is within an anomaly's orb collection radius\n        const anomaly = this.environment.checkAnomalyCollision(this.spaceship.mesh.position);\n        \n        // If player is within collection radius of an anomaly with an uncollected orb\n        if (anomaly && !anomaly.orbCollected) {\n            // Automatically collect the orb\n            this.collectEnergyOrb();\n            \n            // Reset current anomaly when orb is collected\n            this.currentAnomaly = null;\n        } else if (anomaly && anomaly !== this.currentAnomaly && anomaly.orbCollected) {\n            // If player enters a depleted anomaly, show notification\n            this.currentAnomaly = anomaly;\n            this.showAnomalyMessage(\"Energy orb already collected\", \"#ff3333\");\n        } else if (!anomaly) {\n            // Reset current anomaly when player leaves the collection radius\n            this.currentAnomaly = null;\n        }\n    }\n    \n    // Getter for isMining status (used by UI)\n    get isMining(): boolean {\n        return this.miningSystem ? this.miningSystem.isMining : false;\n    }\n    \n    // Getter for mining progress (used by UI)\n    get miningProgress(): number {\n        return this.miningSystem ? this.miningSystem.miningProgress : 0;\n    }\n}\n","// gameInitializer.js - Game initialization logic\n\nimport * as THREE from 'three';\nimport { Renderer } from '../modules/renderer.js';\nimport { Spaceship } from '../modules/spaceship';\nimport { Physics } from '../modules/physics';\nimport { Controls } from '../modules/controls.js';\nimport { DEBUG_MODE } from '../globals/debug.ts';\nimport type { DockingSpaceship } from '../modules/controls/docking/types.ts';\n// import { Environment } from '../modules/environment';\n// import { UI } from '../modules/ui';\n// import { AudioManager } from '../modules/audio/audio.js';\n\ntype GameRenderer = {\n    scene: THREE.Scene;\n    camera: THREE.Camera;\n};\n\ntype PhysicsSpaceship = Parameters<Physics['setSpaceship']>[0];\n\ntype GameEnvironment = {\n    setSpaceship: (ship: PhysicsSpaceship) => void;\n};\n\ntype GameSpaceship = PhysicsSpaceship & DockingSpaceship & {\n    thrustPower: number;\n    strafePower: number;\n};\n\ntype GameUi = {\n    setAudio: (audio: any) => Promise<void>;\n    setControls: (controls: GameControls) => void;\n    setCameraAndRenderer: (camera: any, renderer: any) => void;\n    initializeSettings: (game: GameInitializerContext) => Promise<void>;\n    stargateInterface?: { showStargateUI?: (() => void) | undefined };\n    initializeUIComponents: () => Promise<void>; // Add this method\n};\n\ntype GameControls = {\n    dockingSystem?: { isDocked: boolean };\n};\n\ntype GameInitializerContext = {\n    audio?: any;\n    renderer?: GameRenderer;\n    scene?: THREE.Scene;\n    camera?: THREE.Camera;\n    physics?: Physics;\n    environment?: GameEnvironment;\n    spaceship?: GameSpaceship;\n    ui?: GameUi;\n    controls?: GameControls;\n    handleResize: () => void;\n    handleVisibilityChange: () => void;\n    handleKeyDown: (event: KeyboardEvent) => void;\n};\n\nexport class GameInitializer {\n    game: GameInitializerContext;\n\n    constructor(game: GameInitializerContext) {\n        this.game = game;\n    }\n    \n    async initializeCore(): Promise<void> {\n        // Create audio manager first but don't initialize yet\n        if (DEBUG_MODE.enabled) console.log(\"Creating audio manager...\");\n        const { AudioManager } = await import('../modules/audio/audio.js');\n        this.game.audio = new AudioManager();\n        \n        // Initialize renderer first\n        if (DEBUG_MODE.enabled) console.log(\"Creating renderer...\");\n        this.game.renderer = await Renderer.create();\n        if (DEBUG_MODE.enabled) console.log(\"Renderer created, getting scene...\");\n\n        const renderer = this.game.renderer;\n        \n        // Access scene and camera directly rather than through getters\n        this.game.scene = renderer.scene;\n        this.game.camera = renderer.camera;\n        \n        if (DEBUG_MODE.enabled) console.log(\"Scene and camera references obtained\");\n        \n        // Share camera reference with scene for easy access by other components\n        const sceneWithCamera = this.game.scene as THREE.Scene & { camera?: THREE.Camera };\n        sceneWithCamera.camera = this.game.camera;\n        \n        // Initialize essential components needed for the start screen\n        if (DEBUG_MODE.enabled) console.log(\"Initializing essential components...\");\n        \n        // Initialize physics\n        const physics = new Physics(this.game.scene);\n        this.game.physics = physics;\n        \n        // Set camera reference in physics\n        physics.setCamera(this.game.camera);\n        \n        // Initialize environment (essential components only)\n        const { Environment } = await import('../modules/environment.js');\n        const environment = new Environment(this.game.scene);\n        this.game.environment = environment;\n        \n        // Initialize spaceship\n        if (DEBUG_MODE.enabled) console.log(\"Creating spaceship...\");\n        const spaceship = new Spaceship(this.game.scene) as GameSpaceship;\n        this.game.spaceship = spaceship;\n        \n        // Set spaceship reference in physics\n        physics.setSpaceship(spaceship);\n        \n        // Set spaceship reference in environment (for VibeVerse portals)\n        environment.setSpaceship(spaceship);\n        \n        // Initialize UI\n        const { UI } = await import('../modules/ui.js');\n        this.game.ui = new UI(spaceship, environment);\n        // Pass camera and renderer to UI for damage numbers and other visual effects\n        this.game.ui.setCameraAndRenderer(this.game.camera, this.game.renderer);\n        await this.game.ui.initializeUIComponents();\n        \n        // Share audio reference with UI for sound-based components\n        await this.game.ui.setAudio(this.game.audio);\n        \n        // Initialize controls last, as it depends on other components\n        this.game.controls = new Controls(spaceship, physics as any, environment as any, this.game.ui);\n        \n        // Share controls reference with UI for bidirectional communication\n        this.game.ui.setControls(this.game.controls);\n        \n        // Initialize settings\n        if (DEBUG_MODE.enabled) console.log(\"Initializing settings...\");\n        await this.game.ui.initializeSettings(this.game);\n    }\n    \n    setupEventHandlers(): void {\n        // Handle window resize\n        window.addEventListener('resize', this.game.handleResize.bind(this.game));\n        \n        // Handle visibility change to pause/resume game\n        document.addEventListener('visibilitychange', this.game.handleVisibilityChange.bind(this.game));\n        \n        // Handle keyboard events\n        document.addEventListener('keydown', this.game.handleKeyDown.bind(this.game));\n    }\n    \n    startDocked(): void {\n        // Start the game with the spaceship docked at the stargate\n        console.log(\"Starting game in docked state\");\n        \n        if (this.game.spaceship) {\n            // Start docked at the stargate - position is handled by spaceship.dock()\n            if (!this.game.spaceship.isDocked) {\n                console.log(\"Docking spaceship...\");\n                this.game.spaceship.dock();\n            } else {\n                console.log(\"Spaceship already docked\");\n            }\n        } else {\n            console.error(\"No spaceship found!\");\n        }\n        \n        // Set initial camera position for docked state\n        if (this.game.camera) {\n            this.game.camera.position.set(0, 1500, 0);\n            console.log(\"Camera position set for docked state\");\n        }\n        \n        // Update docking system to reflect docked state\n        if (this.game.controls && this.game.controls.dockingSystem) {\n            // The docking system tracks the spaceship's docked state automatically\n            this.game.controls.dockingSystem.isDocked = true;\n            console.log(\"Docking system updated\");\n        }\n        \n        // Start the game UI\n        if (this.game.ui && this.game.ui.stargateInterface) {\n            console.log(\"Showing stargate UI...\");\n            this.game.ui.stargateInterface.showStargateUI?.();\n        } else {\n            console.error(\"No stargate interface found!\", this.game.ui);\n        }\n    }\n}\n","// difficultyManager.js - Dynamic difficulty scaling\n\nimport { DEBUG_MODE } from '../globals/debug.ts';\n\ntype DifficultyParams = {\n    maxEnemies: number;\n    spawnInterval: number;\n    enemyHealth: number;\n    enemyDamage: number;\n    enemySpeed: number;\n};\n\nexport class DifficultyManager {\n    params: DifficultyParams;\n    gameTime: number;\n    currentLevel: number;\n\n    constructor() {\n        this.params = {\n            maxEnemies: 10,\n            spawnInterval: 3,\n            enemyHealth: 20,\n            enemyDamage: 15,\n            enemySpeed: 700\n        };\n        this.gameTime = 0;\n        this.currentLevel = 1;\n    }\n    \n    update(deltaTime: number): void {\n        // Update game time in minutes\n        this.gameTime += deltaTime;\n        const minutes = this.gameTime / 60;\n        \n        // Calculate level based on minutes played\n        // Level increases every 3 minutes\n        const newLevel = Math.floor(minutes / 3) + 1;\n        \n        // Only update if level changed\n        if (newLevel !== this.currentLevel) {\n            this.currentLevel = newLevel;\n            \n            // Get difficulty multiplier: 1x at level 1, 1.5x at level 2, 2x at level 3, etc.\n            // Cap at level 5 (3x difficulty) for fairness\n            const difficultyMultiplier = 1 + (Math.min(this.currentLevel - 1, 4) * 0.5);\n            \n            // Update parameters\n            this.params.maxEnemies = Math.min(10 * difficultyMultiplier, 30);\n            this.params.spawnInterval = Math.max(3 / difficultyMultiplier, 1);\n            this.params.enemyHealth = Math.floor(20 * difficultyMultiplier);\n            this.params.enemyDamage = Math.floor(15 * difficultyMultiplier);\n            this.params.enemySpeed = Math.min(700 * (1 + (0.2 * (this.currentLevel - 1))), 1400);\n            \n            if (DEBUG_MODE.enabled) {\n                console.log(`Difficulty increased to level ${this.currentLevel} (${difficultyMultiplier}x)`);\n                console.log(`Parameters: maxEnemies=${this.params.maxEnemies}, spawnInterval=${this.params.spawnInterval}`);\n                console.log(`Health=${this.params.enemyHealth}, Damage=${this.params.enemyDamage}, Speed=${this.params.enemySpeed}`);\n            }\n        }\n    }\n}\n","// hordeMode.js - Horde mode management\n\nimport { DEBUG_MODE } from '../globals/debug.ts';\nimport { mainMessageBus } from '../globals/messageBus.ts';\n\ntype HordeAudio = {\n    playSound: (soundId: string) => void;\n};\n\ntype HordeUi = {\n    showNotification?: (message: string, durationMs: number) => void;\n    showUI?: () => void;\n};\n\ntype HordeSpaceship = {\n    isDocked: boolean;\n    undock: () => void;\n};\n\ntype HordeGameContext = {\n    isHordeActive?: boolean;\n    hordeStartTime?: number;\n    hordeSurvivalTime?: number;\n    audio?: HordeAudio;\n    ui?: HordeUi;\n    spaceship?: HordeSpaceship;\n};\n\nexport class HordeMode {\n    game: HordeGameContext;\n    isActive: boolean;\n    startTime: number;\n    survivalTime: number;\n\n    constructor(game: HordeGameContext) {\n        this.game = game;\n        this.isActive = false;\n        this.startTime = 0;\n        this.survivalTime = 0;\n    }\n    \n    /**\n     * Activate horde mode (extreme survival challenge)\n     */\n    activate(): void {\n        if (this.isActive) return; // Already active\n        \n        if (DEBUG_MODE.enabled) console.log(\"ACTIVATING HORDE MODE - EXTREME SURVIVAL CHALLENGE\");\n        this.isActive = true;\n        this.startTime = performance.now();\n        this.survivalTime = 0;\n        \n        // Store horde state in game\n        this.game.isHordeActive = true;\n        this.game.hordeStartTime = this.startTime;\n        this.game.hordeSurvivalTime = this.survivalTime;\n        \n        // Play an intense sound to signal the start of horde mode\n        if (this.game.audio) {\n            this.game.audio.playSound('boink');\n        }\n        \n        // Notify UI to update\n        mainMessageBus.publish('horde.activated', {\n            startTime: this.startTime\n        });\n        \n        // Notify the player\n        if (this.game.ui && this.game.ui.showNotification) {\n            this.game.ui.showNotification(\"HORDE MODE ACTIVATED - SURVIVE!\", 5000);\n        }\n        \n        // Force player to undock if currently docked\n        if (this.game.spaceship && this.game.spaceship.isDocked) {\n            if (DEBUG_MODE.enabled) console.log(\"Horde mode forcing undock from stargate\");\n            \n            // Undock the ship\n            this.game.spaceship.undock();\n            \n            // Notify the docking system\n            mainMessageBus.publish('player.requestUndock', {\n                forced: true,\n                reason: \"horde_mode_activation\"\n            });\n            \n            // CRITICAL FIX: Explicitly show the HUD after forcing undock\n            // Use a short delay to ensure undocking process is complete\n            setTimeout(() => {\n                if (DEBUG_MODE.enabled) console.log(\"Horde mode ensuring HUD is visible\");\n                if (this.game.ui && this.game.ui.showUI) {\n                    this.game.ui.showUI();\n                }\n            }, 200);\n        }\n    }\n    \n    /**\n     * Update horde mode survival time\n     */\n    update(): void {\n        if (this.isActive) {\n            this.survivalTime = performance.now() - this.startTime;\n            this.game.hordeSurvivalTime = this.survivalTime;\n        }\n    }\n    \n    /**\n     * Format horde survival time as MM:SS\n     * @returns {string} Formatted time string\n     */\n    getFormattedSurvivalTime(): string {\n        const totalSeconds = Math.floor(this.survivalTime / 1000);\n        const minutes = Math.floor(totalSeconds / 60);\n        const seconds = totalSeconds % 60;\n        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\n    }\n}\n","// audioUpdater.js - Game audio state management\n\ntype AudioSystem = {\n    playSound: (soundId: string) => void;\n    stopSound: (soundId: string) => void;\n    setThrustVolume: (volume: number) => void;\n};\n\ntype ThrustState = {\n    forward: boolean;\n    backward: boolean;\n    left: boolean;\n    right: boolean;\n    boost: boolean;\n};\n\ntype SpaceshipState = {\n    isDocked: boolean;\n    thrust: ThrustState;\n};\n\ntype GameAudioContext = {\n    audio?: AudioSystem;\n    spaceship?: SpaceshipState;\n};\n\nexport class AudioUpdater {\n    game: GameAudioContext;\n\n    constructor(game: GameAudioContext) {\n        this.game = game;\n    }\n    \n    // Update game sounds based on current game state\n    update(): void {\n        if (!this.game.audio || !this.game.spaceship) return;\n        \n        // Handle thruster sounds based on current thrust state\n        if (this.game.spaceship.isDocked) {\n            // No thruster sounds when docked\n            this.game.audio.stopSound('thrust');\n        } else {\n            const isThrusting = this.game.spaceship.thrust.forward || \n                              this.game.spaceship.thrust.backward || \n                              this.game.spaceship.thrust.left || \n                              this.game.spaceship.thrust.right;\n                              \n            if (isThrusting) {\n                // Play thrust sound if not already playing\n                this.game.audio.playSound('thrust');\n                \n                // Calculate thrust intensity for volume\n                let thrustIntensity = 0.5; // Base level\n                \n                if (this.game.spaceship.thrust.forward) thrustIntensity += 0.2;\n                if (this.game.spaceship.thrust.backward) thrustIntensity += 0.1;\n                if (this.game.spaceship.thrust.left) thrustIntensity += 0.1;\n                if (this.game.spaceship.thrust.right) thrustIntensity += 0.1;\n                \n                // Boost increases volume\n                if (this.game.spaceship.thrust.boost) thrustIntensity *= 1.5;\n                \n                // Set thrust volume\n                this.game.audio.setThrustVolume(thrustIntensity);\n            } else {\n                // Stop thrust sound if no thrusters active\n                this.game.audio.stopSound('thrust');\n            }\n        }\n        \n        // Mining sound is handled by the mining system integration\n    }\n}\n","// gameLifecycle.ts - Game lifecycle management (game over, cleanup, destruction)\n\nimport { objectPool } from '../globals/objectPool.ts';\n\ninterface GameInstance {\n    spaceship: any;\n    isGameOver: boolean;\n    boundAnimate: any;\n    ui: any;\n    hordeMode: any;\n    audio: any;\n    environment: any;\n    gameLoop: any;\n    gameOverCleanupTimeout?: ReturnType<typeof setTimeout>;\n    renderer: any;\n    physics: any;\n    controls: any;\n    combat: any;\n}\n\nexport class GameLifecycle {\n    private game: GameInstance;\n\n    constructor(game: GameInstance) {\n        this.game = game;\n    }\n\n    checkGameOver(): void {\n        // Make sure spaceship exists\n        if (!this.game.spaceship) return;\n\n        // Don't check for game over conditions if the ship is docked\n        if (this.game.spaceship.isDocked) return;\n\n        // Check if out of fuel and not near stargate\n        if (this.game.spaceship.fuel <= 0 && !this.game.environment.stargate.isNearby(this.game.spaceship.mesh.position)) {\n            this.gameOver('Out of fuel! You drift endlessly through space...');\n        }\n    }\n\n    gameOver(reason: string): void {\n        if (this.game.isGameOver) return; // Prevent multiple game over triggers\n\n        this.game.isGameOver = true;\n\n\n        // Stop the game loop\n        if (this.game.boundAnimate) {\n            cancelAnimationFrame(this.game.boundAnimate);\n        }\n\n        // Show game over UI\n        if (this.game.ui) {\n            // Check if it's a horde mode game over\n            if (this.game.hordeMode && this.game.hordeMode.isActive) {\n                const survivalTime = this.game.hordeMode.getFormattedSurvivalTime();\n                this.game.ui.showGameOver(`HORDE MODE - Survived: ${survivalTime}\\n${reason}`);\n            } else {\n                this.game.ui.showGameOver(reason);\n            }\n        }\n\n        // Play game over sound\n        if (this.game.audio) {\n            this.game.audio.playSound('gameOver');\n        }\n\n        // Cleanup after a delay\n        this.game.gameOverCleanupTimeout = setTimeout(() => {\n            this.cleanup();\n        }, 5000);\n    }\n\n    cleanup(): void {\n        // Basic cleanup when game ends\n\n        // Clear pools\n        if (objectPool && objectPool.clearAllPools) {\n            objectPool.clearAllPools();\n        }\n\n        // Stop all audio\n        if (this.game.audio && this.game.audio.cleanup) {\n            this.game.audio.cleanup();\n        }\n    }\n\n    /**\n     * Clean up all game resources, event listeners, and references\n     * Call this when the game is no longer needed to prevent memory leaks\n     */\n    destroy(): void {\n\n        // Destroy game loop\n        if (this.game.gameLoop) {\n            this.game.gameLoop.destroy();\n            this.game.gameLoop = null;\n        }\n\n        // Clear any pending timeouts\n        if (this.game.gameOverCleanupTimeout) {\n            clearTimeout(this.game.gameOverCleanupTimeout);\n            this.game.gameOverCleanupTimeout = undefined;\n        }\n\n        // Remove event listeners\n        window.removeEventListener('resize', (this.game as any).handleResize);\n        document.removeEventListener('visibilitychange', (this.game as any).handleVisibilityChange);\n        document.removeEventListener('keydown', (this.game as any).handleKeyDown);\n\n        // Clean up modules\n        if (this.game.renderer) {\n            this.game.renderer.dispose();\n            this.game.renderer = null;\n        }\n\n        if (this.game.audio) {\n            this.game.audio.dispose();\n            this.game.audio = null;\n        }\n\n        if (this.game.physics) {\n            this.game.physics.dispose();\n            this.game.physics = null;\n        }\n\n        if (this.game.spaceship) {\n            this.game.spaceship.dispose();\n            this.game.spaceship = null;\n        }\n\n        if (this.game.environment) {\n            this.game.environment.dispose();\n            this.game.environment = null;\n        }\n\n        if (this.game.controls) {\n            this.game.controls.dispose();\n            this.game.controls = null;\n        }\n\n        if (this.game.ui) {\n            this.game.ui.dispose();\n            this.game.ui = null;\n        }\n\n        if (this.game.combat) {\n            this.game.combat.dispose();\n            this.game.combat = null;\n        }\n\n        // Clear global references\n        window.game = null;\n\n    }\n}\n","// objectPools.js - Object pool initialization and management\n\nimport * as THREE from 'three';\nimport { objectPool } from '../globals/objectPool.ts';\n\ntype GameRenderer = {\n    renderer: {\n        compile: (scene: THREE.Scene, camera: THREE.Camera) => void;\n    };\n    _withGuard: (fn: () => void) => void;\n};\n\ntype GameContext = {\n    scene?: THREE.Scene;\n    camera?: THREE.Camera;\n    renderer?: GameRenderer;\n};\n\ntype HitEffectItem = {\n    mesh: THREE.Mesh<THREE.BufferGeometry, THREE.MeshBasicMaterial>;\n    material: THREE.MeshBasicMaterial;\n    reset: (this: HitEffectItem, color?: number, size?: number) => void;\n    clear: (this: HitEffectItem) => void;\n};\n\ntype ParticlePoolItem = {\n    mesh: THREE.Mesh<THREE.BufferGeometry, THREE.MeshBasicMaterial>;\n    velocity: THREE.Vector3;\n    life: number;\n    reset: (this: ParticlePoolItem, position: THREE.Vector3, velocity: THREE.Vector3, color?: number) => void;\n    update: (this: ParticlePoolItem, delta: number) => boolean;\n    clear: (this: ParticlePoolItem) => void;\n};\n\ntype ExplosionPoolItem = {\n    container: THREE.Group;\n    particles: ParticlePoolItem[];\n    active: boolean;\n    reset: (this: ExplosionPoolItem, position: THREE.Vector3, color?: number, force?: number) => void;\n    update: (this: ExplosionPoolItem, delta: number) => boolean;\n    clear: (this: ExplosionPoolItem) => void;\n};\n\nexport class ObjectPools {\n    game: GameContext;\n    projectileGeometry?: THREE.SphereGeometry;\n    projectileMaterial?: THREE.MeshStandardMaterial;\n    hitEffectGeometry?: THREE.SphereGeometry;\n\n    constructor(game: GameContext) {\n        this.game = game;\n    }\n    \n    // Pre-warm only the most essential shaders needed for immediate gameplay\n    preWarmBasicShaders(): void {\n        const scene = this.game.scene;\n        const camera = this.game.camera;\n        const renderer = this.game.renderer;\n        if (!scene || !camera || !renderer) return;\n        \n        // Create template projectile geometry and materials\n        this.projectileGeometry = new THREE.SphereGeometry(1.8, 12, 12);\n        this.projectileMaterial = new THREE.MeshStandardMaterial({\n            color: 0x00ffff,\n            emissive: 0x00ffff,\n            emissiveIntensity: 5,\n            metalness: 0.7,\n            roughness: 0.3\n        });\n        \n        // Create simple dummy objects to warm up the renderer\n        const dummyProjectile = new THREE.Mesh(this.projectileGeometry, this.projectileMaterial);\n        \n        // Add to scene temporarily\n        scene.add(dummyProjectile);\n        \n        // Force shader compilation for better performance\n        renderer.renderer.compile(scene, camera);\n        \n        // Remove dummy object after compilation\n        renderer._withGuard(() => scene.remove(dummyProjectile));\n        \n    }\n    \n    initializeObjectPools(): void {\n        \n        try {\n            // Initialize hit effect pool\n            if (!this.hitEffectGeometry) {\n                this.hitEffectGeometry = new THREE.SphereGeometry(2, 8, 8);\n            }\n            \n            objectPool.createPool('hitEffect', (): HitEffectItem => {\n                const material = new THREE.MeshBasicMaterial({\n                    color: 0xff5500,\n                    transparent: true,\n                    opacity: 0.8\n                });\n                \n                const mesh = new THREE.Mesh(this.hitEffectGeometry, material) as THREE.Mesh<THREE.BufferGeometry, THREE.MeshBasicMaterial>;\n                mesh.visible = false;\n                \n                return {\n                    mesh: mesh,\n                    material: material,\n                    reset: function(this: HitEffectItem, color = 0xff5500, size = 1) {\n                        this.material.color.set(color);\n                        this.material.opacity = 0.8;\n                        this.mesh.scale.set(size, size, size);\n                        this.mesh.visible = true;\n                    },\n                    clear: function(this: HitEffectItem) {\n                        if (this.mesh.parent) {\n                            this.mesh.parent.remove(this.mesh);\n                        }\n                        this.mesh.visible = false;\n                    }\n                };\n            }, 5, 20);\n            \n            // Initialize projectile pool (if not already initialized by ProjectilePoolManager)\n            if (!this.projectileGeometry) {\n                this.projectileGeometry = new THREE.SphereGeometry(1.8, 12, 12);\n            }\n            \n            // The projectile pool is now managed by ProjectilePoolManager\n            // We just ensure the geometry is pre-created for shader warming\n            \n            // Initialize particle pool for explosions\n            const particleGeometry = new THREE.SphereGeometry(0.5, 4, 4);\n            const particleMaterial = new THREE.MeshBasicMaterial({\n                color: 0xff5500,\n                transparent: true\n            });\n            \n            objectPool.createPool('particle', (): ParticlePoolItem => {\n                const mesh = new THREE.Mesh(particleGeometry, particleMaterial.clone()) as THREE.Mesh<THREE.BufferGeometry, THREE.MeshBasicMaterial>;\n                mesh.visible = false;\n                \n                return {\n                    mesh: mesh,\n                    velocity: new THREE.Vector3(),\n                    life: 0,\n                    reset: function(this: ParticlePoolItem, position: THREE.Vector3, velocity: THREE.Vector3, color = 0xff5500) {\n                        this.mesh.position.copy(position);\n                        this.velocity.copy(velocity);\n                        this.mesh.material.color.set(color);\n                        this.mesh.material.opacity = 1;\n                        this.mesh.visible = true;\n                        this.life = 1;\n                    },\n                    update: function(this: ParticlePoolItem, delta: number) {\n                        this.life -= delta * 2; // Fade out over 0.5 seconds\n                        if (this.life <= 0) {\n                            this.clear();\n                            return false;\n                        }\n                        \n                        this.mesh.position.add(this.velocity.clone().multiplyScalar(delta));\n                        this.mesh.material.opacity = this.life;\n                        return true;\n                    },\n                    clear: function(this: ParticlePoolItem) {\n                        if (this.mesh.parent) {\n                            this.mesh.parent.remove(this.mesh);\n                        }\n                        this.mesh.visible = false;\n                        this.life = 0;\n                    }\n                };\n            }, 20, 100);\n            \n            // Initialize explosion effect pool\n            const particleCount = 15;\n            objectPool.createPool('explosion', (): ExplosionPoolItem => {\n                const container = new THREE.Group();\n                const particles: ParticlePoolItem[] = [];\n                \n                for (let i = 0; i < particleCount; i++) {\n                    const particle = objectPool.get('particle') as ParticlePoolItem | null;\n                    if (particle) {\n                        particles.push(particle);\n                    }\n                }\n                \n                return {\n                    container: container,\n                    particles: particles,\n                    active: false,\n                    reset: function(this: ExplosionPoolItem, position: THREE.Vector3, color = 0xff5500, force = 50) {\n                        this.container.position.copy(position);\n                        this.active = true;\n                        \n                        // Reset all particles with random velocities\n                        for (let i = 0; i < particleCount; i++) {\n                            if (this.particles[i]) {\n                                const velocity = new THREE.Vector3(\n                                    (Math.random() - 0.5) * force,\n                                    (Math.random() - 0.5) * force,\n                                    (Math.random() - 0.5) * force\n                                );\n                                this.particles[i].reset(new THREE.Vector3(), velocity, color);\n                                this.container.add(this.particles[i].mesh);\n                            }\n                        }\n                        \n                        if (!this.container.parent) {\n                            window.game.scene.add(this.container);\n                        }\n                    },\n                    update: function(this: ExplosionPoolItem, delta: number) {\n                        if (!this.active) return false;\n                        \n                        let anyAlive = false;\n                        for (let i = 0; i < particleCount; i++) {\n                            if (this.particles[i] && this.particles[i].life > 0) {\n                                if (this.particles[i].update(delta)) {\n                                    anyAlive = true;\n                                }\n                            }\n                        }\n                        \n                        if (!anyAlive) {\n                            this.clear();\n                            return false;\n                        }\n                        \n                        return true;\n                    },\n                    clear: function(this: ExplosionPoolItem) {\n                        this.active = false;\n                        \n                        // Clear all particles\n                        for (let i = 0; i < particleCount; i++) {\n                            if (this.particles[i]) {\n                                this.particles[i].clear();\n                            }\n                        }\n                        \n                        if (this.container.parent) {\n                            this.container.parent.remove(this.container);\n                        }\n                    }\n                };\n            }, 5, 20);\n            \n        } catch (error) {\n            console.error(\"Error initializing object pools:\", error);\n        }\n    }\n}\n"],"file":"assets/game-core-OtPnLuF2.js"}